<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>DNS on AmiaaaZ's Site</title><link>https://amiaaaz.github.io/tags/dns/</link><description>Recent content in DNS on AmiaaaZ's Site</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Tue, 18 Jul 2023 00:10:38 +0800</lastBuildDate><atom:link href="https://amiaaaz.github.io/tags/dns/index.xml" rel="self" type="application/rss+xml"/><item><title>DNS相关的二三事·中</title><link>https://amiaaaz.github.io/2023/07/18/dns-study-notes-02/</link><pubDate>Tue, 18 Jul 2023 00:10:38 +0800</pubDate><guid>https://amiaaaz.github.io/2023/07/18/dns-study-notes-02/</guid><description>&lt;p>DNS相关的第二篇笔记，参考了很多已有文章（链接见后），如有错漏还请指正x&lt;/p>
&lt;hr>
&lt;h2 id="常见的代理形式">常见的代理形式&lt;/h2>
&lt;p>代理，即：我们的流量以某种方式（协议）转发给另一个服务端，让它代替我们发出请求 并将响应转发回来&lt;/p>
&lt;p>这里的协议有socks5和http(s)，因为socks5支持代理TCP和UDP 所以一般使用socks5的场景更多；同时，不同形式代理运行的层级也有所不同&lt;/p>
&lt;h3 id="系统代理">系统代理&lt;/h3>
&lt;p>当我们在代理软件中开启System Proxy时，设置-&amp;gt; 网络和Internet-&amp;gt; 代理 就会被自动开启并设置内容，但这里的设置只可以设置http代理 并仅对浏览器流量有效，不代理终端、其它软件的流量&lt;/p>
&lt;h3 id="软件单独设置代理">软件单独设置代理&lt;/h3>
&lt;p>例如微信，Idea等常见软件都提供了设置运行时代理的选项&lt;/p>
&lt;h4 id="proxychains">proxychains&lt;/h4>
&lt;p>它利用&lt;code>LD_PRELOAD&lt;/code>环境变量加载&lt;code>libproxychains4.so&lt;/code>，hook了和socket相关的操作（重写&lt;code>connect&lt;/code>, &lt;code>close&lt;/code>, &lt;code>sendto&lt;/code>等函数）以此来对流量进行代理&lt;/p>
&lt;h3 id="taptun代理全局代理">TAP/TUN代理（全局代理）&lt;/h3>
&lt;p>TAP/TUN都是由代理软件实现的虚拟网络设备，在功能上和物理网卡没有区别，可以接管系统的网络&lt;/p>
&lt;p>TUN模拟的是三层设备 可以处理网络层的数据包（处理IP地址），由于它只到IP层，所以无法与物理网卡连接 也没有MAC地址，但是可以通过三层交换的方式与物理网卡进行通信；TAP模拟的是二层网络设备 可以处理数据链路层的数据包（处理MAC地址），比TUN更深入 可以与物理网卡做bridge 支持MAC层广播 也可以给它设置IP地址&lt;/p>
&lt;h2 id="流量处理与分流">流量处理与分流&lt;/h2>
&lt;p>常见的两大软件v2ray和Clash有不同的路由模式&lt;/p>
&lt;ul>
&lt;li>v2ray：绕过大陆(Whitelist)，黑名单(Blacklist)，全局(Global)；可单独设置域名匹配&lt;/li>
&lt;li>Clash：较为丰富，可以设置域名匹配、IP匹配等，可以单独写配置文件 diy分流规则&lt;/li>
&lt;/ul>
&lt;h3 id="通常情况">通常情况&lt;/h3>
&lt;p>由于TCP/IP的特性，当应用发起TCP连接时会先发出一个DNS请求获取要连接域名指向的真实IP，再对这个IP发起连接；这个获取真实IP的过程中会首先先经过几轮缓存的筛查，没有命中缓存则会交给交给操作系统设置的DNS服务器&lt;/p>
&lt;h3 id="socks5非全局代理">socks5（非全局代理）&lt;/h3>
&lt;ul>
&lt;li>有socks5代理但直连：DNS解析由代理客户端进行&lt;/li>
&lt;/ul>
&lt;p>这时浏览器将不再从自己的DNS缓存中查域名，浏览器将直接将其封装在socks5流量中发往作为代理的客户端，代理客户端从中抽出域名并设法得到解析结果（DNS解析由代理客户端进行，可以指向自定义DNS server或使用操作系统的getaddrinfo）并把socks5流量还原成TCP请求、建立TCP连接&lt;/p>
&lt;ul>
&lt;li>真实的socks5代理（具有远端代理服务端）：DNS解析由远端代理服务端进行&lt;/li>
&lt;/ul>
&lt;p>前面都相同，但这次代理客户端不处理DNS解析 而是将socks5流量处理后转发给远端的代理服务端，服务端从中获取域名 并进行DNS解析&lt;/p>
&lt;h3 id="代理分流">代理分流&lt;/h3>
&lt;ul>
&lt;li>域名分流&lt;/li>
&lt;/ul>
&lt;p>代理客户端提前从socks5中抽出域名与白名单/黑名单列表进行比较，后面是否需要代理 同上一个三级标题&lt;/p>
&lt;ul>
&lt;li>IP分流&lt;/li>
&lt;/ul>
&lt;p>要用IP分流则必须有一个可以比较的IP，所以代理客户端必须先进行一次DNS解析——如何解析不重要，上面提到可以自定义指定，总之会再代理客户端拿到IP 并判断是否需要走代理，后面同上&lt;/p>
&lt;p>但注意这里的IP并不一定会被后续的TCP复用，如果是直连 则沿用IP，非直连则仍会让远端代理服务器进行DNS解析，与先前比较所用的IP毫无关系&lt;/p>
&lt;h3 id="redir全局代理">redir（全局代理）&lt;/h3>
&lt;p>全局代理情况下应用程序感受不到代理客户端的存在，所以发起TCP连接前会先发起DNS请求，代理客户端将这个请求截获 得到一个结果（最初DNS解析由代理客户端进行）并将其返回浏览器，浏览器与这个IP建立TCP连接并发出请求，这个TCP请求将被代理客户端截获 并拿掉其中IP，替换为域名 并和其它关键信息一起发送给远端代理服务器&lt;/p>
&lt;p>与非全局代理的socks5直连的区别在于这里的DNS请求不能省、但又不需要，那有没有取巧的方式跳过它呢？&lt;/p>
&lt;h3 id="fake-ip全局代理">Fake IP（全局代理）&lt;/h3>
&lt;p>RFC 3089中给出了Fake IP，它定义了一种将TCP封装为socks的方式&lt;/p>
&lt;p>在Fake IP的模式中，代理客户端会提取出域名 从Fake IP池中选一个IP与之建立映射、并把这个Fake IP返回给浏览器，浏览器对这个IP建立TCP连接，这个请求会被代理客户端拦截 将其替换为原来的域名 并和其它重要信息一起发送给远端代理服务器，最终的DNS解析仍然会发生在远端代理服务器&lt;/p>
&lt;p>由于代理客户端内存储有Fake IP和真实域名之间的映射表，因此即使操作系统或应用程序缓存了Fake IP，在之后的TCP连接中 代理客户端收到流量后依然可以抽取出Fake IP反查出域名，因此不受DNS缓存的影响&lt;/p>
&lt;p>在Fake IP模式下，如果浏览器访问一个不存在域名 代理客户端仍会假装完成DNS响应并返回IP，所以不会返回DNS解析失败的错误信息，可能会超时（或远端服务器返回空？）；如果Fake IP已缓存 但是域名与IP的映射表丢失，将会连接超时 无法打开网页&lt;/p>
&lt;hr>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
以下是本文中涉及到的 和我学习时看过的所有文章的链接 每日感谢互联网的丰富资源（
&lt;/h4>
&lt;/summary>
&lt;p>&lt;a href="https://blog.skk.moe/post/what-happend-to-dns-in-proxy/">浅谈在代理环境中的 DNS 解析行为&lt;/a> | &lt;a href="https://blog.revincx.icu/posts/proxy-summary/">关于『代理』的不完全使用指北&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://zhuanlan.zhihu.com/p/260405786">虚拟设备之TUN和TAP&lt;/a> | &lt;a href="https://zhuanlan.zhihu.com/p/388742230">Linux 虚拟网络设备之 TUN/TAP 设备&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://blog.zorro.im/posts/2015-6-25-proxychains.html">ProxyChains 及其原理&lt;/a>&lt;/p>
&lt;/details></description></item><item><title>DNS相关的二三事·上</title><link>https://amiaaaz.github.io/2023/04/11/dns-study-notes-01/</link><pubDate>Tue, 11 Apr 2023 21:00:40 +0800</pubDate><guid>https://amiaaaz.github.io/2023/04/11/dns-study-notes-01/</guid><description>&lt;p>其实已经学了一段时间了……但还有几个二级/三级标题没有学完，先放个上篇（）&lt;/p>
&lt;p>参考了很多师傅的博客，参考链接统一放在末尾w&lt;/p>
&lt;p>如有错漏还烦请各位师傅指正……在此先提前磕一个了Orz&lt;/p>
&lt;hr>
&lt;h2 id="解析">解析&lt;/h2>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230309220434277.png" alt="image-20230309220434277">&lt;/p>
&lt;p>顶级域Top-Level Domains：&lt;/p>
&lt;ul>
&lt;li>generic Top-Level Domains: com, edu, net, &amp;hellip;.&lt;/li>
&lt;li>country code Top-Level Domains: cn, us, &amp;hellip;.&lt;/li>
&lt;li>effective Top-Level Doamins: github.io, &amp;hellip;.&lt;/li>
&lt;li>arpa: 逆向解析域&lt;/li>
&lt;/ul>
&lt;p>一个完整的域名通常会具有二级及以上的域名形式，即二级域example.com或五级域a.b.c.example.com，通过DNS服务查询域名到ip时有这样两种方式：&lt;/p>
&lt;ol>
&lt;li>递归查询：A-&amp;gt; B-&amp;gt; C，A向B发起解析的请求，B再向C发起请求，得到响应再给A；在此过程中A, B各发起一次DNS请求&lt;/li>
&lt;li>迭代查询：A-&amp;gt; B, A-&amp;gt; C，A向B发起解析的请求，B告诉A去找C，A再向C发起请求；在此过程中A发起两次DNS请求&lt;/li>
&lt;/ol>
&lt;h3 id="hosts">hosts&lt;/h3>
&lt;p>在进行DNS请求的过程中，首先会在本地的hosts文件里找，windows在&lt;code>C:\Windows\System32\drivers\etc\hosts&lt;/code>，linux在&lt;code>/etc/hosts&lt;/code>，格式为&lt;/p>
&lt;pre tabindex="0">&lt;code># ip domain
127.0.0.1 localhost
&lt;/code>&lt;/pre>&lt;h3 id="localdns">LocalDNS&lt;/h3>
&lt;p>如果hosts中没有进入LocalDNS，即本地网络指定的DNS服务器&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230309223429158.png" alt="image-20230309223429158">&lt;/p>
&lt;p>linux在&lt;code>/etc/resolv.conf&lt;/code>中设置，想必虚拟机中配置过&lt;code>host-only&lt;/code>模式的师傅一定很熟悉这个文件，它的格式是&lt;/p>
&lt;pre tabindex="0">&lt;code># nameserver ip
nameserver 192.168.1.1
&lt;/code>&lt;/pre>&lt;p>LocalDNS其实并不具备真正的域名解析功能，而是缓存域名的查询记录，同时作为向外迭代查询的第一环&lt;/p>
&lt;p>当我们用nslookup查询时经常会出现&lt;code>Non-authoritative answer&lt;/code>，这就是因为此时返回的记录是从LocalDNS的缓存里拿的；windows dns默认开启dns缓存，常用命令&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>ipconfig /displaydns
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ipconfig /flushdns
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>*至于为什么仅主机网络模式要配置resolv.conf？这是因为在这种情况下虚拟机和主机会在同一子网内（有独立的DHCP服务器来分配ip），我们希望虚拟机可以访问外网 就要手动指定它的nameserver（理论上这一过程也是自动的，但实际中VirtualBox无法直接修改resolve.conf，所以总需要先route add default gw ip，再设置nameserver才可以，如果长时间开机有概率导致route失效，需要再次route add）&lt;/p>
&lt;h3 id="根服务器">根服务器&lt;/h3>
&lt;p>全球有13“台”根服务器（实际有多个服务器进行负载均衡啦），当DNS请求发来时实际会发向它的一个任播节点，再根据顶级域名向LocalDNS返回接下来要找的DNS顶级域名服务器的ip，向他发起查询&lt;/p>
&lt;p>当我们直接&lt;code>dig . ns&lt;/code>可以得到那&lt;code>.&lt;/code>的13条NS记录（即13个服务器），但显然&lt;code>.&lt;/code>没有A记录&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230410102948679.png" alt="image-20230410102948679">&lt;/p>
&lt;h3 id="顶级域名服务器">顶级域名服务器&lt;/h3>
&lt;p>顶级域名服务器手握*.com的解释权，但现在基本是授权给其它厂商来做，比如万网等DNS权威域名服务器，这类域名服务器会掌控特定域下的所有子域和主机的ip，所以它可以直接返回结果&lt;/p>
&lt;p>域名授权的DNS权威域名服务器的信息在AUTHORITY SECTION部分中返回，告诉localDNS到这里去查&lt;/p>
&lt;h3 id="解析失败的多种原因">解析失败的多种原因&lt;/h3>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230321081143638.png" alt="image-20230321081143638">&lt;/p>
&lt;p>这里要引入&lt;code>DNS-Rcode&lt;/code>这一字段，它在DNS响应报文中用于说明DNS应答状态，我们可以根据它来大致判断是什么原因导致域名无法被正确解析；常见的Rcode值和对应情况有如下这些&lt;/p>
&lt;ul>
&lt;li>&lt;strong>0, NOERROR&lt;/strong>：成功&lt;/li>
&lt;/ul>
&lt;p>特殊情况，响应成功但没有解析结果：域名权威服务器及托管的主域名均正常，权威本身也存在这条具体的域名记录，但是没有对应的记录类型（不包含CNAME，CNAME是特殊情况，可以响应任意类型的请求），这时权威返回了NOERROR；值的注意的是这个NOERROR的报文中没有ANSWER SECTION。但是会包含一个AUTHORITY SECTION，内容为改主域名的SOA记录，这个应答结果会在递归服务器中被缓存，缓存时间周期为域名的SOA记录的TTL&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230321081015579.png" alt="image-20230321081015579">&lt;/p>
&lt;ul>
&lt;li>&lt;strong>2, SERVFAIL&lt;/strong>：服务器失败，域名的权威服务器拒绝响应或REFUSE 递归返回Rcode=2给CLIENT；SERVFAIL的应答结果当然是空结果，但BIND会强制给这个结果增加一个1s的TTL，所以SERVFAIL的应答会在递归服务器中被缓存，缓存时间周期为1s&lt;/li>
&lt;/ul>
&lt;p>又分为这样几种情况：1. 权威不响应：包括递归服务器至权威服务器中间的网络异常在内，递归服务器在发出递归请求并完成重试超时后，给请求源一个SERVFAIL的应答，并缓存1s&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230321080315824.png" alt="image-20230321080315824">&lt;/p>
&lt;p>2.权威向递归服务器应答REFUSE：当权威服务器不存在主域名及对应的SOA记录时，权威会向递归服务器返回REFUSE，即不在我服务的范围内拒绝，递归服务器在收到这个REFUSE应答后，给请求源一个SERVFAIL的应答，并缓存1s&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230321080358052.png" alt="image-20230321080358052">&lt;/p>
&lt;p>3.权威向递归服务器应答SERVFAIL：当权威服务器存在主域名但是由于zonefile被破坏导致权威服务器上域名的NS记录异常时，权威会向递归服务器返回SERVFAIL，即解析失败，递归服务器在收到这个SERVFAIL应答后，给请求源一个SERVFAIL的应答，并缓存1s&lt;/p>
&lt;p>4.权威向递归服务器应答其他的错误Rcode：不常见，递归服务器在收到其他错误应答后，给请求源一个SERVFAIL的应答，并缓存1s&lt;/p>
&lt;ul>
&lt;li>&lt;strong>3, NXDOMAIN&lt;/strong>：不存在的记录，该条域名在权威服务器中并不存在&lt;/li>
&lt;/ul>
&lt;p>在NXDOMAIN的报文中会包含一个AUTHORITY SECTION，内容为改主域名的SOA记录，这个应答结果会在递归服务器中被缓存，缓存时间周期为域名的SOA记录的TTL&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230321080036531.png" alt="image-20230321080036531">&lt;/p>
&lt;ul>
&lt;li>&lt;strong>5, REFUSE&lt;/strong>：请求源IP不在服务范围内&lt;/li>
&lt;/ul>
&lt;p>除了记录不存在（NXDOMAIN）和解析失败（SERVFAIL）以外，如果请求源不在递归服务器的服务范围内，这种情况下递归服务器会直接给请求源一个REFUSE的应答，本地直接应答无缓存&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230321080728786.png" alt="image-20230321080728786">&lt;/p>
&lt;ul>
&lt;li>超时，递归服务器不响应&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230321081057727.png" alt="image-20230321081057727">&lt;/p>
&lt;h2 id="记录">记录&lt;/h2>
&lt;p>有以下一些记录&lt;/p>
&lt;ul>
&lt;li>A：域名指向IPv4地址&lt;/li>
&lt;li>AAAA：指向IPv6地址&lt;/li>
&lt;li>CNAME：作为一个域名的别名&lt;/li>
&lt;li>MX：电子邮件服务器地址&lt;/li>
&lt;li>NS：权威域名服务器记录（只有顶级域名才有NS记录）&lt;/li>
&lt;li>TXT：任意&lt;/li>
&lt;li>SOA：起始授权机构记录Start of Authority，在域名有多个NS记录时指定哪个是最权威的，由它告诉其它权威服务器什么时候更新记录&lt;/li>
&lt;li>PTR：A记录的逆向记录，可用于ip反查域名&lt;/li>
&lt;li>AXFR, IXFR：与域传送有关&lt;/li>
&lt;/ul>
&lt;h3 id="spf记录邮件伪造">SPF记录&amp;amp;邮件伪造&lt;/h3>
&lt;p>SPF记录是TXT类的一种，用来过滤垃圾邮件，机制是这样的：收件服务器收到admin@example.com发来的邮件，会校验源ip是否在example.com的SPF记录范围内&lt;/p>
&lt;p>这其实衍生了一个攻击面，即：通过域名的SPF记录划定资产的ip范围，不过现在很多都会选择163, foxmail等作为邮件服务，所以能用到这一攻击方式的场景不多&lt;/p>
&lt;p>写个py来处理这个需求&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">re&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">dns.resolver&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">resolve&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">note&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">type&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;spf&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">resolveSPF&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">elif&lt;/span> &lt;span style="color:#111">type&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;A&amp;#39;&lt;/span> &lt;span style="color:#f92672">and&lt;/span> &lt;span style="color:#111">note&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;takeover&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">resolveA&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">answers&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#111">dns&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">resolver&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">resolve&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">answers&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">rrset&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#00a8c8">None&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">resolveSPF&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">ip4_list&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">ip6_list&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">records&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#111">resolve&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;TXT&amp;#39;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">record&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">records&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">record&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">record&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">record&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">:&lt;/span>&lt;span style="color:#ae81ff">6&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;v=spf&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">spfs&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#111">re&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">findall&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">r&lt;/span>&lt;span style="color:#d88200">&amp;#39;include:(\S+)\s?&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">record&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">rules&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">re&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">findall&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">r&lt;/span>&lt;span style="color:#d88200">&amp;#34;\s(\S+)$&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">record&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;[+] spfs: &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">spfs&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;[+] rules: &amp;#39;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">rules&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#34;&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">resolveSPF&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">spfs&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">matchs&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">re&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">findall&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">r&lt;/span>&lt;span style="color:#d88200">&amp;#39;(ip[46]):([\w:./]+)&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">record&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">ip4_list&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">ip&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">ip&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">matchs&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">ip&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;ip4&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">ip6_list&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">ip&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">ip&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">matchs&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">ip&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;ip6&amp;#39;&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">break&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;[!] no spf record&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">exit&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;[!] no TXT record&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">exit&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">ip4_list&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;[+] ip4: &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">ip4_list&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">ip6_list&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;[+] ip6: &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">ip6_list&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">resolveSPF&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">input&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;domain: &amp;#39;&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230315012828126.png" alt="image-20230315012828126">&lt;/p>
&lt;p>我他妈都快写完了，突然想到可以用ChatGPT啊，于是它几秒之内给出了这样的答案&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">from&lt;/span> &lt;span style="color:#111">dns&lt;/span> &lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">resolver&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">rdatatype&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">process_spf&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">record_str&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d88200"> 处理spf记录
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d88200"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">segment_list&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">record_str&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">split&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39; &amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#75715e"># 拆分成段&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">ip_list&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">domain_list&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">segment&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">segment_list&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">segment&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">startswith&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;ip&amp;#39;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">ip_list&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">segment&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">3&lt;/span>&lt;span style="color:#111">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">elif&lt;/span> &lt;span style="color:#111">segment&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">startswith&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;include&amp;#39;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">domain&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">segment&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">8&lt;/span>&lt;span style="color:#111">:]&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">strip&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;&amp;#34;&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#75715e"># 去掉双引号&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">spf_record&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">query_txt_record&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">sub_domain_list&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">sub_ip_list&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">process_spf&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">spf_record&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">domain_list&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#111">sub_domain_list&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">ip_list&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#111">sub_ip_list&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">domain_list&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">ip_list&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">query_txt_record&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#d88200">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d88200"> 查询域名的TXT记录
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d88200"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">try&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">result&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">resolver&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">query&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">rdatatype&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">TXT&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">except&lt;/span> &lt;span style="color:#75af00">Exception&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">records&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">to_text&lt;/span>&lt;span style="color:#111">()[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">:&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">r&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">result&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">spf_records&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">r&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">r&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">records&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">r&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">startswith&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;v=spf&amp;#39;&lt;/span>&lt;span style="color:#111">)]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">spf_records&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">spf_records&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#d88200">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">__name__&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#d88200">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">domain&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;example.com&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">spf_record&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">query_txt_record&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">domain_list&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">ip_list&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">process_spf&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">spf_record&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;Domains:&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">set&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain_list&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;IPs:&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">set&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">ip_list&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230315013115184.png" alt="image-20230315013115184">&lt;/p>
&lt;p>……行，ChatGPT牛逼，我下岗了，是我冒犯了&lt;/p>
&lt;h3 id="cname子域接管">CNAME&amp;amp;子域接管&lt;/h3>
&lt;p>直接举例：&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230315013828470.png" alt="image-20230315013828470">&lt;/p>
&lt;p>当CNAME像这样是&lt;code>*&lt;/code>时会导致子域名接管，此时我们随便一个&lt;code>abcd.github.io&lt;/code>都可以设置自己的CNAME为&lt;code>abcd.sxxxxx.life&lt;/code>，并且可以正常访问&lt;/p>
&lt;p>这是相当危险的漏洞，因为可以直接绕过诸多对于跨域、跨源的限制，甚至绕过一些限制域名的waf&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230315030306021.png" alt="image-20230315030306021">&lt;/p>
&lt;p>由于这样的配置下任意子域都存在一样的A记录和CNAME记录，我们借此来快速判断域名是否存在子域接管漏洞（我这里代码是比对A记录的，CNAME也可以（写的时候脑子短路了）&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">def&lt;/span> &lt;span style="color:#75af00">resolveA&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">tmp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">tldextract&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">extract&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">qwe&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">asd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">qwe_records&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#111">resolve&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">uuid&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">uuid4&lt;/span>&lt;span style="color:#111">()&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">hex&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">:&lt;/span>&lt;span style="color:#111">random&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">randint&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">6&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">32&lt;/span>&lt;span style="color:#111">)]&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">.&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">tmp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">.&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">tmp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">suffix&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;A&amp;#39;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">record&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">qwe_records&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">qwe&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">record&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;[+] qwe.&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">tmp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">.&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">tmp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">suffix&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">: &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">qwe&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">asd_records&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#111">resolve&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">uuid&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">uuid4&lt;/span>&lt;span style="color:#111">()&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">hex&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">:&lt;/span>&lt;span style="color:#111">random&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">randint&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">6&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">32&lt;/span>&lt;span style="color:#111">)]&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">.&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">tmp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">.&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">tmp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">suffix&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;A&amp;#39;&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">record&lt;/span> &lt;span style="color:#f92672">in&lt;/span> &lt;span style="color:#111">asd_records&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">asd&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">append&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">str&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">record&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;[+] qwe.&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">tmp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">.&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">tmp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">suffix&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">: &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">asd&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">set&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">qwe&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">set&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">asd&lt;/span>&lt;span style="color:#111">):&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;[*] &lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">tmp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">domain&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200">.&lt;/span>&lt;span style="color:#d88200">{&lt;/span>&lt;span style="color:#111">tmp&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">suffix&lt;/span>&lt;span style="color:#d88200">}&lt;/span>&lt;span style="color:#d88200"> exists subdomain-takeover vuln&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">f&lt;/span>&lt;span style="color:#d88200">&amp;#39;[!] no subdomain-takeover vuln&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ptr反查域名">PTR&amp;amp;反查域名&lt;/h3>
&lt;p>如何实现ip反查域名？由于一个ip可以对应多个域名，理论上我们可以遍历整个域名树——这未免太蠢了，所以为了解决这个问题产生了逆向解析域in-addr.arpa，当我们要查12.23.34.45这个ip对应的域名时，反向被解析的ip地址就会变成域名一样的形式：45.34.23.12.in-addr.arpa&lt;/p>
&lt;p>能成功反查域名的前提是这个域名有被配置过反向解析&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>dig -x &amp;lt;ip&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>nslookup -type&lt;span style="color:#f92672">=&lt;/span>ptr &amp;lt;ip&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="axfr域传送">AXFR&amp;amp;域传送&lt;/h3>
&lt;p>*详细的漏洞成因&amp;amp;分析见&lt;a href="https://amiaaaz.github.io/2022/05/06/dns-zone-transfer-study-note/#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0">DNS 域传送漏洞学习&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>dig @&amp;lt;vuln-dns-server&amp;gt; -t axfr &amp;lt;domain&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>nslookup ls &amp;lt;domain&amp;gt; &amp;lt;vuln-dns-server&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果存在漏洞 可以通过这样的命令列出域内的所有记录&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220506160602721.png" alt="img">&lt;/p>
&lt;h2 id="常用命令">常用命令&lt;/h2>
&lt;p>nslookup和dig都不能一次查域名的所有记录，只能多次查询；以下是他们支持的type&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> Specifies a computer&amp;rsquo;s IP address.&lt;/li>
&lt;li>&lt;strong>ANY:&lt;/strong> Specifies a computer&amp;rsquo;s IP address.&lt;/li>
&lt;li>&lt;strong>CNAME:&lt;/strong> Specifies a canonical name for an alias.&lt;/li>
&lt;li>&lt;strong>GID&lt;/strong> Specifies a group identifier of a group name.&lt;/li>
&lt;li>&lt;strong>HINFO:&lt;/strong> Specifies a computer&amp;rsquo;s CPU and type of operating system.&lt;/li>
&lt;li>&lt;strong>MB:&lt;/strong> Specifies a mailbox domain name.&lt;/li>
&lt;li>&lt;strong>MG:&lt;/strong> Specifies a mail group member.&lt;/li>
&lt;li>&lt;strong>MINFO:&lt;/strong> Specifies mailbox or mail list information.&lt;/li>
&lt;li>&lt;strong>MR:&lt;/strong> Specifies the mail rename domain name.&lt;/li>
&lt;li>&lt;strong>MX:&lt;/strong> Specifies the mail exchanger.&lt;/li>
&lt;li>&lt;strong>NS:&lt;/strong> Specifies a DNS name server for the named zone.&lt;/li>
&lt;li>&lt;strong>PTR:&lt;/strong> Specifies a computer name if the query is an IP address; otherwise, specifies the pointer to other information.&lt;/li>
&lt;li>&lt;strong>SOA:&lt;/strong> Specifies the start-of-authority for a DNS zone.&lt;/li>
&lt;li>&lt;strong>TXT:&lt;/strong> Specifies the text information.&lt;/li>
&lt;li>&lt;strong>UID:&lt;/strong> Specifies the user identifier.&lt;/li>
&lt;li>&lt;strong>UINFO:&lt;/strong> Specifies the user information.&lt;/li>
&lt;li>&lt;strong>WKS:&lt;/strong> Describes a well-known service.&lt;/li>
&lt;/ul>
&lt;h3 id="nslookup">nslookup&lt;/h3>
&lt;p>&lt;a href="https://learn.microsoft.com/zh-cn/windows-server/administration/windows-commands/nslookup">ms doc&lt;/a>&lt;/p>
&lt;ul>
&lt;li>命令行模式&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 返回指定类型的记录（默认A记录） 可指定DNS server&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>nslookup -type&lt;span style="color:#f92672">=&lt;/span>&amp;lt;type&amp;gt; &amp;lt;domain&amp;gt; &amp;lt;dns-server&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 返回域名ttl&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>nslookup -d &amp;lt;domain&amp;gt; &amp;lt;dns-server&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 列出域&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>nslookup ls
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>nslookup view
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>交互模式&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>nslookup
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">set&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#f92672">=&lt;/span>txt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>server &amp;lt;dns-server&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;domain&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="dig">dig&lt;/h3>
&lt;p>&lt;a href="https://www.linux-man.cn/command/dig/">linux man-dig&lt;/a>&lt;/p>
&lt;p>比nslookup返回的信息要全&lt;/p>
&lt;ul>
&lt;li>命令行&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 通用 b指的是主机ip 指定本机哪个ip向DNS server发送请求&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dig @&amp;lt;dns-server&amp;gt; -P &amp;lt;dns-port&amp;gt; -t &amp;lt;type&amp;gt; -b &amp;lt;ip&amp;gt; &amp;lt;domain&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 反查ptr&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dig -x &amp;lt;ip&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 仅获取ip 精简输出&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dig +short &amp;lt;domain&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 获取递归过程的查询结果 处于安全考虑 很多组织严格限制了可以发起递归查询的主机&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dig +trace &amp;lt;domain&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>交互模式&lt;/li>
&lt;/ul>
&lt;p>略&lt;/p>
&lt;h3 id="host">host&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>host &amp;lt;ip&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>host -C &amp;lt;type&amp;gt; &amp;lt;domain&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>默认返回的信息很简略，good（加&lt;code>-v&lt;/code>可以得到和dig一样的效果&lt;/p>
&lt;h3 id="whois">whois&lt;/h3>
&lt;p>查询域名的注册情况&lt;/p>
&lt;pre tabindex="0">&lt;code>whois www.example.com
&lt;/code>&lt;/pre>&lt;p>会暴露使用的域名厂商、个人姓名、注册省市&lt;/p>
&lt;h2 id="协议的多种安全尝试">协议的多种安全尝试&lt;/h2>
&lt;p>说到DNS我们的第一反应一定是“它使用UDP协议”，但实际上TCP协议也有参与，在DNS的设计之初就在&lt;u>域传送&lt;/u>中引入了TCP协议，而随着时代发展日益增长，各类记录 导致动辄超过512byte而被截断的UDP渐渐不能满足我们的要求，最终在DNS出现的30多年之后，RFC 7766提出使用TCP作为主要协议来解决UDP无法解决的问题，TCP也不再只作为一种被截断再重试时使用的机制（RFC1123），随后出现的DNS over TLS, DNS over HTTPS也都是对DNS协议的补充&lt;/p>
&lt;p>可能有人要问了：为什么传输数据多了就一定要用TCP呢？从理论上来说，EDNS机制下一个UDP的数据包最多到64kb 已经远超常见DNS查询所需的开销（查询协议头42byte+响应协议头42byte 请求体和响应体预计15和70byte），但实际生产中 一旦数据包中的数据超过MTU（传送链路的最大传输单元 一般1500byte），当前数据包可能会被分片传输、丢弃，部分设备甚至会拒绝包含ENDS(0)选项的请求，这就导致使用UDP协议的DNS不稳定，而TCP作为“可靠”的传输协议 用来解决这个问题就再合适不过了，通过序列号、重传等机制可以保证消息的不重不漏，消息接收方的TCP栈会对分片的数据重新进行拼装，DNS等应用层协议可以直接处理好完整数据，同时 当数据包足够大的时候，TCP三次握手带来的额外开销比例就会越来越少&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230321074520492.png" alt="image-20230321074520492">&lt;/p>
&lt;p>实际环境中，如果DNS响应数据包太大 将会在&lt;code>tc&lt;/code>位设1，表明这个数据超长而有删节&lt;/p>
&lt;p>&lt;img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/DNS-2-attack-dns/20200930044314680.png!blog" alt="img">&lt;/p>
&lt;p>本地DNS服务看到这样的响应就会尝试建立TCP连接来重发&lt;/p>
&lt;p>下面来说几个DNS发展过程中为了安全、可靠而多次引入的几个机制&lt;/p>
&lt;h3 id="edns">EDNS&lt;/h3>
&lt;p>在2020的DNS Flag Day提出ENDS(Extension Mechanisms for DNS)，在遵循已有的DNS消息格式上增加字段来支持更多类型的DNS请求业务，提出的理由是这样的&lt;/p>
&lt;ol>
&lt;li>DNS协议头部的第二个16字节中都已经被用的差不多了，需要添加新的返回类型（RCODE）和标记（FLAGS）来支持其他需求&lt;/li>
&lt;li>只为标示domain类型的标签分配了两位，现在已经用掉了两位（00标示字符串类型，11表示压缩类型），后面如果有更多的标签类型则无法支持，建议用上 10 和 01&lt;/li>
&lt;li>当初DNS协议中设计的用UDP包传输时DNS数据大小限制为512字节，现在很多主机已经具备重组大数据包的能力，所以要有一种机制来允许DNS请求方通知DNS服务器让其返回大一些的数据包&lt;/li>
&lt;/ol>
&lt;p>为了确保向后兼容，EDNS引入了一种新的伪资源记录OPT RR(Resource Record)；之所以叫做伪资源记录 是因为它不包含任何DNS数据，OPT RR不能被cache、不能被转发、不能被存储在zone文件中中，它被放在DNS通信双方DNS数据包的ADDITIONAL SECTION中，每个DNS数据包中只能有一个OPT伪资源记录，当有多种EDNS扩展协议时，各个{attribute, value}对一个紧接一个存储在RDATA中&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230410104031347.png" alt="image-20230410104031347">&lt;/p>
&lt;p>所以也很显然：EDNS的支持与否跟域名关联的权威服务器强相关，可以直接dig看有没有OPT RR来判断是否开启，或通过&lt;code>dns.google.com&lt;/code>来查询&lt;/p>
&lt;pre tabindex="0">&lt;code>https://dns.google/resolve?name=&amp;lt;url&amp;gt;&amp;amp;type=A&amp;amp;edns_client_subnet=119.6.6.6
&lt;/code>&lt;/pre>&lt;p>这里用到的&lt;code>edns_client_subnet&lt;/code>和cdn有关，支持DNS Resolver传递用户的ip地址给权威server，CDN根据该ip地址可以更好的进行资源调度；更多内容可以参照google的&lt;a href="https://developers.google.com/speed/public-dns/docs/ecs?hl=zh-cn">文档&lt;/a>&lt;/p>
&lt;p>OPT的另一个作用是指出UDP payload size，它可以告诉DNS服务器 自己作为CLIENT能处理的最大UDP报文大小（满足扩大UDP传输大小的需求），参照&lt;a href="https://bind9.readthedocs.io/en/stable/reference.html#namedconf-statement-edns-udp-size">文档&lt;/a>，用dig时默认的bufsize是1232，允许最小bufsize为512，最大为4096，如果设置的size过小会自动调整到512~4096的范围内，如果传输的数据大于设定的bufsize会导致内容截断&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>dig &amp;lt;domain&amp;gt; +bufsize&lt;span style="color:#f92672">=&lt;/span>xxx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>*个人感觉实战用到这一点难度较高，因为本身最小的bufsize 512已经是取众数之后设出的规范，一般简单的查询很难突破这一限额，想要在这一点上做文章……我匮乏的想象力不知道该怎么做，另外EDNS是否开启、客户端是否支持等等也是一系列玄学问题Orz&lt;/p>
&lt;h3 id="dnssec">DNSSEC&lt;/h3>
&lt;p>Domain Name System Security Extensions，流程基本没变，只是在权威服务器返回响应时附带type是RRSIG(Resource Record Signature)的PR&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230322080536042.png" alt="image-20230322080536042">&lt;/p>
&lt;p>DNSSEC解决中间人攻击的方式是KSK&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230322081021565.png" alt="image-20230322081021565">&lt;/p>
&lt;p>*偷个懒直接截图了（）&lt;/p>
&lt;hr>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
以下是本文中涉及到的 和我学习时看过的所有文章的链接 每日感谢互联网的丰富资源（
&lt;/h4>
&lt;/summary>
&lt;p>&lt;a href="https://www.tr0y.wang/2020/09/14/DNS-1-basic/">DNS 安全（一）：基础知识复习&lt;/a> | &lt;a href="https://www.tr0y.wang/2020/09/30/DNS-2-attack-dns/">DNS 安全（二）：针对 DNS 协议的攻击&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://zhuanlan.zhihu.com/p/40659713">阿里DNS：域名解析失败的那些事&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://t.zsxq.com/0beCXbKSr">https://t.zsxq.com/0beCXbKSr&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://t.zsxq.com/0bGdEH0CD">https://t.zsxq.com/0bGdEH0CD&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://bind9.readthedocs.io/en/stable/reference.html#namedconf-statement-edns-udp-size">https://bind9.readthedocs.io/en/stable/reference.html#namedconf-statement-edns-udp-size&lt;/a> | &lt;a href="https://developers.google.com/speed/public-dns/docs/ecs?hl=zh-cn">https://developers.google.com/speed/public-dns/docs/ecs?hl=zh-cn&lt;/a> | &lt;a href="https://www.cnblogs.com/cobbliu/p/3188632.html">EDNS&lt;/a> | &lt;a href="https://xiazemin.github.io/MyBlog/golang/2020/05/25/edns.html">DNS support edns-client-subnet&lt;/a>&lt;/p>
&lt;/details></description></item></channel></rss>